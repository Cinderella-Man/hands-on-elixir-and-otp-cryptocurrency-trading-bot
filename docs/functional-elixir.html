<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 18 Functional Elixir | Hands-on Elixir &amp; OTP: Cryptocurrency trading bot</title>
  <meta name="description" content="Chapter 18 Functional Elixir | Hands-on Elixir &amp; OTP: Cryptocurrency trading bot" />
  <meta name="generator" content="bookdown 0.39 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 18 Functional Elixir | Hands-on Elixir &amp; OTP: Cryptocurrency trading bot" />
  <meta property="og:type" content="book" />
  
  
  <meta name="github-repo" content="Cinderella-Man/hands-on-elixir-and-otp-cryptocurrency-trading-bot" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 18 Functional Elixir | Hands-on Elixir &amp; OTP: Cryptocurrency trading bot" />
  <meta name="twitter:site" content="@kamilskowron" />
  
  

<meta name="author" content="Kamil Skowron" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="mox-rocks.html"/>
<link rel="next" href="idiomatic-otp.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-52FKGBX2B8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-52FKGBX2B8');
</script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Hands-on Elixir & OTP: Cryptocurrency trading bot</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#want-to-learn-elixir-otp-by-creating-a-real-world-project"><i class="fa fa-check"></i>Want to learn Elixir &amp; OTP by creating a real-world project?</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#limit-of-liabilitydisclaimer-of-warranty"><i class="fa fa-check"></i>Limit of Liability/Disclaimer of Warranty</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#pdf-epub"><i class="fa fa-check"></i>PDF &amp; EPUB</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#preface-1"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#who-this-book-is-for"><i class="fa fa-check"></i>Who this book is for</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#what-this-book-covers"><i class="fa fa-check"></i>What this book covers</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#contributing-errata-and-source-code"><i class="fa fa-check"></i>Contributing, Errata and Source code</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><i class="fa fa-check"></i><b>1</b> Stream live cryptocurrency prices from the Binance WSS</a>
<ul>
<li class="chapter" data-level="1.1" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html#objectives"><i class="fa fa-check"></i><b>1.1</b> Objectives</a></li>
<li class="chapter" data-level="1.2" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html#create-a-new-umbrella-app"><i class="fa fa-check"></i><b>1.2</b> Create a new umbrella app</a></li>
<li class="chapter" data-level="1.3" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html#create-a-supervised-application-inside-an-umbrella"><i class="fa fa-check"></i><b>1.3</b> Create a supervised application inside an umbrella</a></li>
<li class="chapter" data-level="1.4" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html#connect-to-binances-websocket-stream-using-the-websockex-module"><i class="fa fa-check"></i><b>1.4</b> Connect to Binance’s WebSocket Stream using the WebSockex module</a></li>
<li class="chapter" data-level="1.5" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html#decode-incoming-events-using-the-jason-module"><i class="fa fa-check"></i><b>1.5</b> Decode incoming events using the Jason module</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><i class="fa fa-check"></i><b>2</b> Create a naive trading strategy - a single trader process without supervision</a>
<ul>
<li class="chapter" data-level="2.1" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#objectives-1"><i class="fa fa-check"></i><b>2.1</b> Objectives</a></li>
<li class="chapter" data-level="2.2" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#initialisation"><i class="fa fa-check"></i><b>2.2</b> Initialisation</a></li>
<li class="chapter" data-level="2.3" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#how-trading-strategy-will-work"><i class="fa fa-check"></i><b>2.3</b> How trading strategy will work?</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#implementation-of-the-first-scenario"><i class="fa fa-check"></i><b>2.3.1</b> Implementation of the first scenario</a></li>
<li class="chapter" data-level="2.3.2" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#implementation-of-the-second-scenario"><i class="fa fa-check"></i><b>2.3.2</b> Implementation of the second scenario</a></li>
<li class="chapter" data-level="2.3.3" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#implementation-of-the-third-scenario"><i class="fa fa-check"></i><b>2.3.3</b> Implementation of the third scenario</a></li>
<li class="chapter" data-level="2.3.4" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#implementation-fallback-scenario"><i class="fa fa-check"></i><b>2.3.4</b> Implementation fallback scenario</a></li>
<li class="chapter" data-level="2.3.5" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#updating-the-naive-interface"><i class="fa fa-check"></i><b>2.3.5</b> Updating the Naive interface</a></li>
<li class="chapter" data-level="2.3.6" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#updating-streamer-app"><i class="fa fa-check"></i><b>2.3.6</b> Updating streamer app</a></li>
<li class="chapter" data-level="2.3.7" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#access-details-to-binance"><i class="fa fa-check"></i><b>2.3.7</b> Access details to Binance</a></li>
<li class="chapter" data-level="2.3.8" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#test-run"><i class="fa fa-check"></i><b>2.3.8</b> Test run</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html"><i class="fa fa-check"></i><b>3</b> Introduce PubSub as a communication method</a>
<ul>
<li class="chapter" data-level="3.1" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html#objectives-2"><i class="fa fa-check"></i><b>3.1</b> Objectives</a></li>
<li class="chapter" data-level="3.2" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html#design"><i class="fa fa-check"></i><b>3.2</b> Design</a></li>
<li class="chapter" data-level="3.3" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html#implementation"><i class="fa fa-check"></i><b>3.3</b> Implementation</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html"><i class="fa fa-check"></i><b>4</b> Mock the Binance API</a>
<ul>
<li class="chapter" data-level="4.1" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#objectives-3"><i class="fa fa-check"></i><b>4.1</b> Objectives</a></li>
<li class="chapter" data-level="4.2" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#design-1"><i class="fa fa-check"></i><b>4.2</b> Design</a></li>
<li class="chapter" data-level="4.3" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#create-binancemock-app"><i class="fa fa-check"></i><b>4.3</b> Create “BinanceMock” app</a></li>
<li class="chapter" data-level="4.4" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-getting-exchange-info"><i class="fa fa-check"></i><b>4.4</b> Implement getting exchange info</a></li>
<li class="chapter" data-level="4.5" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-placing-buy-and-sell-orders"><i class="fa fa-check"></i><b>4.5</b> Implement placing buy and sell orders</a></li>
<li class="chapter" data-level="4.6" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-order-retrival"><i class="fa fa-check"></i><b>4.6</b> Implement order retrival</a></li>
<li class="chapter" data-level="4.7" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-callback-for-incoming-trade-events"><i class="fa fa-check"></i><b>4.7</b> Implement callback for incoming trade events</a></li>
<li class="chapter" data-level="4.8" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#upgrade-trader-and-config"><i class="fa fa-check"></i><b>4.8</b> Upgrade trader and config</a></li>
<li class="chapter" data-level="4.9" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#test-the-implementation"><i class="fa fa-check"></i><b>4.9</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html"><i class="fa fa-check"></i><b>5</b> Enable parallel trading on multiple symbols</a>
<ul>
<li class="chapter" data-level="5.1" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#objectives-4"><i class="fa fa-check"></i><b>5.1</b> Objectives</a></li>
<li class="chapter" data-level="5.2" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#introduction---architectural-design"><i class="fa fa-check"></i><b>5.2</b> Introduction - architectural design</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#update-application-supervisor"><i class="fa fa-check"></i><b>5.2.1</b> Update application supervisor</a></li>
<li class="chapter" data-level="5.2.2" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#add-interface-method"><i class="fa fa-check"></i><b>5.2.2</b> Add interface method</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#implement-naive.symbolsupervisor"><i class="fa fa-check"></i><b>5.3</b> Implement <code>Naive.SymbolSupervisor</code></a></li>
<li class="chapter" data-level="5.4" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#implement-naive.leader"><i class="fa fa-check"></i><b>5.4</b> Implement <code>Naive.Leader</code></a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#updating-the-leader-module"><i class="fa fa-check"></i><b>5.4.1</b> Updating the <code>leader</code> module</a></li>
<li class="chapter" data-level="5.4.2" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#updating-the-naive.trader-module"><i class="fa fa-check"></i><b>5.4.2</b> Updating the <code>Naive.Trader</code> module</a></li>
<li class="chapter" data-level="5.4.3" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#finalizing-naive.leader-implementation"><i class="fa fa-check"></i><b>5.4.3</b> Finalizing <code>Naive.Leader</code> implementation</a></li>
<li class="chapter" data-level="5.4.4" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#iex-testing"><i class="fa fa-check"></i><b>5.4.4</b> IEx testing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html"><i class="fa fa-check"></i><b>6</b> Introduce a <code>buy_down_interval</code> to make a single trader more profitable</a>
<ul>
<li class="chapter" data-level="6.1" data-path="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html#objectives-5"><i class="fa fa-check"></i><b>6.1</b> Objectives</a></li>
<li class="chapter" data-level="6.2" data-path="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html#why-we-need-to-buy-below-the-current-price-feature-overview"><i class="fa fa-check"></i><b>6.2</b> Why we need to buy below the current price? Feature overview</a></li>
<li class="chapter" data-level="6.3" data-path="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html#naive.trader-implementation"><i class="fa fa-check"></i><b>6.3</b> <code>Naive.Trader</code> implementation</a></li>
<li class="chapter" data-level="6.4" data-path="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html#naive.leader-implementation"><i class="fa fa-check"></i><b>6.4</b> <code>Naive.Leader</code> implementation</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html#iex-testing-1"><i class="fa fa-check"></i><b>6.4.1</b> IEx testing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html"><i class="fa fa-check"></i><b>7</b> Introduce a trader budget and calculating the quantity</a>
<ul>
<li class="chapter" data-level="7.1" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#objectives-6"><i class="fa fa-check"></i><b>7.1</b> Objectives</a></li>
<li class="chapter" data-level="7.2" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#fetch-step_size"><i class="fa fa-check"></i><b>7.2</b> Fetch <code>step_size</code></a></li>
<li class="chapter" data-level="7.3" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#append-budget-and-step_size-to-the-traders-state-inside-the-leader"><i class="fa fa-check"></i><b>7.3</b> Append <code>budget</code> and <code>step_size</code> to the <code>Trader</code>’s state inside the <code>Leader</code></a></li>
<li class="chapter" data-level="7.4" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#append-budget-and-step_size-to-the-traders-state"><i class="fa fa-check"></i><b>7.4</b> Append <code>budget</code> and <code>step_size</code> to the <code>Trader</code>’s state</a></li>
<li class="chapter" data-level="7.5" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#calculate-quantity"><i class="fa fa-check"></i><b>7.5</b> Calculate quantity</a>
<ul>
<li class="chapter" data-level="7.5.1" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#iex-testing-2"><i class="fa fa-check"></i><b>7.5.1</b> IEx testing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html"><i class="fa fa-check"></i><b>8</b> Add support for multiple transactions per order</a>
<ul>
<li class="chapter" data-level="8.1" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#objectives-7"><i class="fa fa-check"></i><b>8.1</b> Objectives</a></li>
<li class="chapter" data-level="8.2" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#the-issue-with-the-current-implementation"><i class="fa fa-check"></i><b>8.2</b> The issue with the current implementation</a></li>
<li class="chapter" data-level="8.3" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#improve-buy-order-filled-callback"><i class="fa fa-check"></i><b>8.3</b> Improve buy order filled callback</a></li>
<li class="chapter" data-level="8.4" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#implement-buy-order-filled-callback"><i class="fa fa-check"></i><b>8.4</b> Implement buy order “filled” callback</a></li>
<li class="chapter" data-level="8.5" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#improve-sell-order-callback"><i class="fa fa-check"></i><b>8.5</b> Improve sell order callback</a></li>
<li class="chapter" data-level="8.6" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#test-the-implementation-1"><i class="fa fa-check"></i><b>8.6</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html"><i class="fa fa-check"></i><b>9</b> Run multiple traders in parallel</a>
<ul>
<li class="chapter" data-level="9.1" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#objectives-8"><i class="fa fa-check"></i><b>9.1</b> Objectives</a></li>
<li class="chapter" data-level="9.2" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#describe-and-design-the-required-functionality"><i class="fa fa-check"></i><b>9.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="9.3" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#implement-rebuy-inside-naive.trader"><i class="fa fa-check"></i><b>9.3</b> Implement rebuy inside <code>Naive.Trader</code></a></li>
<li class="chapter" data-level="9.4" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#implement-rebuy-in-the-naive.leader"><i class="fa fa-check"></i><b>9.4</b> Implement rebuy in the <code>Naive.Leader</code></a></li>
<li class="chapter" data-level="9.5" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#improve-logs-by-assigning-ids-to-traders"><i class="fa fa-check"></i><b>9.5</b> Improve logs by assigning ids to traders</a></li>
<li class="chapter" data-level="9.6" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#test-the-implementation-2"><i class="fa fa-check"></i><b>9.6</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html"><i class="fa fa-check"></i><b>10</b> Fine-tune trading strategy per symbol</a>
<ul>
<li class="chapter" data-level="10.1" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#objectives-9"><i class="fa fa-check"></i><b>10.1</b> Objectives</a></li>
<li class="chapter" data-level="10.2" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#describe-and-design-the-required-functionality-1"><i class="fa fa-check"></i><b>10.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="10.3" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#add-docker-to-project"><i class="fa fa-check"></i><b>10.3</b> Add docker to project</a></li>
<li class="chapter" data-level="10.4" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#set-up-ecto-inside-the-naive-app"><i class="fa fa-check"></i><b>10.4</b> Set up <code>ecto</code> inside the <code>naive</code> app</a></li>
<li class="chapter" data-level="10.5" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#create-and-migrate-the-db"><i class="fa fa-check"></i><b>10.5</b> Create and migrate the DB</a></li>
<li class="chapter" data-level="10.6" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#seed-symbols-settings"><i class="fa fa-check"></i><b>10.6</b> Seed symbols’ settings</a></li>
<li class="chapter" data-level="10.7" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#update-the-naive.leader-to-fetch-settings"><i class="fa fa-check"></i><b>10.7</b> Update the <code>Naive.Leader</code> to fetch settings</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html"><i class="fa fa-check"></i><b>11</b> Supervise and autostart streaming</a>
<ul>
<li class="chapter" data-level="11.1" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#objectives-10"><i class="fa fa-check"></i><b>11.1</b> Objectives</a></li>
<li class="chapter" data-level="11.2" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#describe-and-design-the-required-functionality-2"><i class="fa fa-check"></i><b>11.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="11.3" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#register-the-streamer.binance-processes-with-names"><i class="fa fa-check"></i><b>11.3</b> Register the <code>Streamer.Binance</code> processes with names</a></li>
<li class="chapter" data-level="11.4" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#set-up-ecto-inside-the-streamer-app"><i class="fa fa-check"></i><b>11.4</b> Set up <code>ecto</code> inside the <code>streamer</code> app</a></li>
<li class="chapter" data-level="11.5" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#create-and-migrate-the-db-1"><i class="fa fa-check"></i><b>11.5</b> Create and migrate the db</a></li>
<li class="chapter" data-level="11.6" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#seed-default-settings"><i class="fa fa-check"></i><b>11.6</b> Seed default settings</a></li>
<li class="chapter" data-level="11.7" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#implement-the-supervision-tree-and-start-streaming-functionality"><i class="fa fa-check"></i><b>11.7</b> Implement the supervision tree and start streaming functionality</a></li>
<li class="chapter" data-level="11.8" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#implement-the-stop-functionality"><i class="fa fa-check"></i><b>11.8</b> Implement the stop functionality</a></li>
<li class="chapter" data-level="11.9" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#implement-the-autostart-streaming-functionality"><i class="fa fa-check"></i><b>11.9</b> Implement the autostart streaming functionality</a></li>
<li class="chapter" data-level="11.10" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#test-the-implementation-3"><i class="fa fa-check"></i><b>11.10</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html"><i class="fa fa-check"></i><b>12</b> Start, stop, shutdown and autostart trading</a>
<ul>
<li class="chapter" data-level="12.1" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#objectives-11"><i class="fa fa-check"></i><b>12.1</b> Objectives</a></li>
<li class="chapter" data-level="12.2" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#describe-and-design-the-required-functionality-3"><i class="fa fa-check"></i><b>12.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="12.3" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#re-implement-the-start-trading-functionality"><i class="fa fa-check"></i><b>12.3</b> (Re-)Implement the start trading functionality</a></li>
<li class="chapter" data-level="12.4" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#implement-the-stop-trading-functionality"><i class="fa fa-check"></i><b>12.4</b> Implement the stop trading functionality</a></li>
<li class="chapter" data-level="12.5" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#implement-the-autostart-trading-functionality"><i class="fa fa-check"></i><b>12.5</b> Implement the autostart trading functionality</a></li>
<li class="chapter" data-level="12.6" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#implement-the-shutdown-trading-functionality"><i class="fa fa-check"></i><b>12.6</b> Implement the shutdown trading functionality</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html"><i class="fa fa-check"></i><b>13</b> Abstract duplicated supervision code</a>
<ul>
<li class="chapter" data-level="13.1" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#objectives-12"><i class="fa fa-check"></i><b>13.1</b> Objectives</a></li>
<li class="chapter" data-level="13.2" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#overview-of-requirements"><i class="fa fa-check"></i><b>13.2</b> Overview of requirements</a></li>
<li class="chapter" data-level="13.3" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#pseudo-generalize-core.servicesupervisor-module"><i class="fa fa-check"></i><b>13.3</b> Pseudo generalize Core.ServiceSupervisor module</a></li>
<li class="chapter" data-level="13.4" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#utilize-pseudo-generalized-code-inside-the-naive-dynamicsymbolsupervisor"><i class="fa fa-check"></i><b>13.4</b> Utilize pseudo generalized code inside the Naive DynamicSymbolSupervisor</a></li>
<li class="chapter" data-level="13.5" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#implement-a-truly-generic-core.servicesupervisor"><i class="fa fa-check"></i><b>13.5</b> Implement a truly generic <code>Core.ServiceSupervisor</code></a>
<ul>
<li class="chapter" data-level="13.5.1" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#first-path-starting-with-the-fetch_symbols_to_start0-function"><i class="fa fa-check"></i><b>13.5.1</b> First path starting with the <code>fetch_symbols_to_start/0</code> function</a></li>
<li class="chapter" data-level="13.5.2" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#second-path-starting-with-the-update_status2"><i class="fa fa-check"></i><b>13.5.2</b> Second path starting with the <code>update_status/2</code></a></li>
<li class="chapter" data-level="13.5.3" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#third-path-starting-with-the-get_pid1-function"><i class="fa fa-check"></i><b>13.5.3</b> Third path starting with the <code>get_pid/1</code> function</a></li>
</ul></li>
<li class="chapter" data-level="13.6" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#remove-boilerplate-using-use-macro"><i class="fa fa-check"></i><b>13.6</b> Remove boilerplate using <code>use</code> macro</a></li>
<li class="chapter" data-level="13.7" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#use-the-core.servicesupervisor-module-inside-the-streamer-application"><i class="fa fa-check"></i><b>13.7</b> Use the <code>Core.ServiceSupervisor</code> module inside the <code>streamer</code> application</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html"><i class="fa fa-check"></i><b>14</b> Store trade events and orders inside the database</a>
<ul>
<li class="chapter" data-level="14.1" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#objectives-13"><i class="fa fa-check"></i><b>14.1</b> Objectives</a></li>
<li class="chapter" data-level="14.2" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#overview-of-requirements-1"><i class="fa fa-check"></i><b>14.2</b> Overview of requirements</a></li>
<li class="chapter" data-level="14.3" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-a-new-data_warehouse-application-in-the-umbrella"><i class="fa fa-check"></i><b>14.3</b> Create a new <code>data_warehouse</code> application in the umbrella</a></li>
<li class="chapter" data-level="14.4" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#connect-to-the-database-using-ecto"><i class="fa fa-check"></i><b>14.4</b> Connect to the database using Ecto</a></li>
<li class="chapter" data-level="14.5" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#store-trade-events-data"><i class="fa fa-check"></i><b>14.5</b> Store trade events’ data</a></li>
<li class="chapter" data-level="14.6" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#store-orders-data"><i class="fa fa-check"></i><b>14.6</b> Store orders’ data</a></li>
<li class="chapter" data-level="14.7" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#implement-supervision"><i class="fa fa-check"></i><b>14.7</b> Implement supervision</a>
<ul>
<li class="chapter" data-level="14.7.1" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-subscriber_settings-table"><i class="fa fa-check"></i><b>14.7.1</b> Create <code>subscriber_settings</code> table</a></li>
<li class="chapter" data-level="14.7.2" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#redesign-supervision-using-registry"><i class="fa fa-check"></i><b>14.7.2</b> Redesign supervision using Registry</a></li>
<li class="chapter" data-level="14.7.3" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-the-datawarehouse.subscriber.dynamicsupervisor-module"><i class="fa fa-check"></i><b>14.7.3</b> Create the <code>DataWarehouse.Subscriber.DynamicSupervisor</code> module</a></li>
<li class="chapter" data-level="14.7.4" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#register-worker-processes-using-via"><i class="fa fa-check"></i><b>14.7.4</b> Register Worker processes using :via</a></li>
<li class="chapter" data-level="14.7.5" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-a-new-supervision-level-for-registry-task-and-the-dynamicsupervisor"><i class="fa fa-check"></i><b>14.7.5</b> Create a new supervision level for Registry, Task and the DynamicSupervisor</a></li>
<li class="chapter" data-level="14.7.6" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#link-the-subscribersupervisor-to-the-application"><i class="fa fa-check"></i><b>14.7.6</b> Link the <code>SubscriberSupervisor</code> to the <code>Application</code></a></li>
<li class="chapter" data-level="14.7.7" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#add-interface"><i class="fa fa-check"></i><b>14.7.7</b> Add interface</a></li>
<li class="chapter" data-level="14.7.8" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#test"><i class="fa fa-check"></i><b>14.7.8</b> Test</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="15" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html"><i class="fa fa-check"></i><b>15</b> Backtest trading strategy</a>
<ul>
<li class="chapter" data-level="15.1" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#objectives-14"><i class="fa fa-check"></i><b>15.1</b> Objectives</a></li>
<li class="chapter" data-level="15.2" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#overview-of-requirements-2"><i class="fa fa-check"></i><b>15.2</b> Overview of requirements</a></li>
<li class="chapter" data-level="15.3" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#implement-the-storing-task"><i class="fa fa-check"></i><b>15.3</b> Implement the storing task</a></li>
<li class="chapter" data-level="15.4" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#test-the-backtesting"><i class="fa fa-check"></i><b>15.4</b> Test the backtesting</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html"><i class="fa fa-check"></i><b>16</b> End-to-end testing</a>
<ul>
<li class="chapter" data-level="16.1" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#objectives-15"><i class="fa fa-check"></i><b>16.1</b> Objectives</a></li>
<li class="chapter" data-level="16.2" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#decide-on-the-tested-functionality"><i class="fa fa-check"></i><b>16.2</b> Decide on the tested functionality</a></li>
<li class="chapter" data-level="16.3" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#implement-basic-test"><i class="fa fa-check"></i><b>16.3</b> Implement basic test</a></li>
<li class="chapter" data-level="16.4" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#introduce-environment-based-config-files"><i class="fa fa-check"></i><b>16.4</b> Introduce environment based config files</a></li>
<li class="chapter" data-level="16.5" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#add-convenience-aliases"><i class="fa fa-check"></i><b>16.5</b> Add convenience aliases</a></li>
<li class="chapter" data-level="16.6" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#cache-initial-seed-data-inside-a-file"><i class="fa fa-check"></i><b>16.6</b> Cache initial seed data inside a file</a></li>
<li class="chapter" data-level="16.7" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#update-seeding-scripts-to-use-the-binancemock"><i class="fa fa-check"></i><b>16.7</b> Update seeding scripts to use the BinanceMock</a></li>
<li class="chapter" data-level="16.8" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#introduce-the-core-application"><i class="fa fa-check"></i><b>16.8</b> Introduce the Core application</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="mox-rocks.html"><a href="mox-rocks.html"><i class="fa fa-check"></i><b>17</b> Mox rocks</a>
<ul>
<li class="chapter" data-level="17.1" data-path="mox-rocks.html"><a href="mox-rocks.html#objectives-16"><i class="fa fa-check"></i><b>17.1</b> Objectives</a></li>
<li class="chapter" data-level="17.2" data-path="mox-rocks.html"><a href="mox-rocks.html#introduction-to-mock-based-tests"><i class="fa fa-check"></i><b>17.2</b> Introduction to mock based tests</a></li>
<li class="chapter" data-level="17.3" data-path="mox-rocks.html"><a href="mox-rocks.html#add-the-mox-package"><i class="fa fa-check"></i><b>17.3</b> Add the <code>mox</code> package</a></li>
<li class="chapter" data-level="17.4" data-path="mox-rocks.html"><a href="mox-rocks.html#investigate-the-naive.trader-module"><i class="fa fa-check"></i><b>17.4</b> Investigate the <code>Naive.Trader</code> module</a>
<ul>
<li class="chapter" data-level="17.4.1" data-path="mox-rocks.html"><a href="mox-rocks.html#mock-the-binance-module"><i class="fa fa-check"></i><b>17.4.1</b> Mock the <code>Binance</code> module</a></li>
<li class="chapter" data-level="17.4.2" data-path="mox-rocks.html"><a href="mox-rocks.html#mock-the-naiveleader-module"><i class="fa fa-check"></i><b>17.4.2</b> Mock the <code>NaiveLeader</code> module</a></li>
<li class="chapter" data-level="17.4.3" data-path="mox-rocks.html"><a href="mox-rocks.html#mock-the-phoenix.pubsub-module"><i class="fa fa-check"></i><b>17.4.3</b> Mock the <code>Phoenix.PubSub</code> module</a></li>
<li class="chapter" data-level="17.4.4" data-path="mox-rocks.html"><a href="mox-rocks.html#mock-the-logger-module"><i class="fa fa-check"></i><b>17.4.4</b> Mock the <code>Logger</code> module</a></li>
</ul></li>
<li class="chapter" data-level="17.5" data-path="mox-rocks.html"><a href="mox-rocks.html#implement-a-test-of-the-naive.trader-module"><i class="fa fa-check"></i><b>17.5</b> Implement a test of the <code>Naive.Trader</code> module</a></li>
<li class="chapter" data-level="17.6" data-path="mox-rocks.html"><a href="mox-rocks.html#define-an-alias-to-run-unit-tests"><i class="fa fa-check"></i><b>17.6</b> Define an alias to run unit tests</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="functional-elixir.html"><a href="functional-elixir.html"><i class="fa fa-check"></i><b>18</b> Functional Elixir</a>
<ul>
<li class="chapter" data-level="18.1" data-path="functional-elixir.html"><a href="functional-elixir.html#objectives-17"><i class="fa fa-check"></i><b>18.1</b> Objectives</a></li>
<li class="chapter" data-level="18.2" data-path="functional-elixir.html"><a href="functional-elixir.html#the-reasoning-behind-the-functional-approach"><i class="fa fa-check"></i><b>18.2</b> The reasoning behind the functional approach</a></li>
<li class="chapter" data-level="18.3" data-path="functional-elixir.html"><a href="functional-elixir.html#simplifying-by-splitting"><i class="fa fa-check"></i><b>18.3</b> Simplifying by splitting</a></li>
<li class="chapter" data-level="18.4" data-path="functional-elixir.html"><a href="functional-elixir.html#abstracting-the-pure-logic"><i class="fa fa-check"></i><b>18.4</b> Abstracting the “pure” logic</a>
<ul>
<li class="chapter" data-level="18.4.1" data-path="functional-elixir.html"><a href="functional-elixir.html#place-a-buy-order-rules"><i class="fa fa-check"></i><b>18.4.1</b> Place a buy order rules</a></li>
<li class="chapter" data-level="18.4.2" data-path="functional-elixir.html"><a href="functional-elixir.html#race-condition-rules"><i class="fa fa-check"></i><b>18.4.2</b> Race condition rules</a></li>
<li class="chapter" data-level="18.4.3" data-path="functional-elixir.html"><a href="functional-elixir.html#fetch-the-buy-order-rules"><i class="fa fa-check"></i><b>18.4.3</b> Fetch the buy order rules</a></li>
<li class="chapter" data-level="18.4.4" data-path="functional-elixir.html"><a href="functional-elixir.html#place-a-sell-order-rules"><i class="fa fa-check"></i><b>18.4.4</b> Place a sell order rules</a></li>
<li class="chapter" data-level="18.4.5" data-path="functional-elixir.html"><a href="functional-elixir.html#terminate-trader-rules"><i class="fa fa-check"></i><b>18.4.5</b> Terminate trader rules</a></li>
<li class="chapter" data-level="18.4.6" data-path="functional-elixir.html"><a href="functional-elixir.html#fetch-the-sell-order-rules"><i class="fa fa-check"></i><b>18.4.6</b> Fetch the sell order rules</a></li>
<li class="chapter" data-level="18.4.7" data-path="functional-elixir.html"><a href="functional-elixir.html#trigger-rebuy-rules"><i class="fa fa-check"></i><b>18.4.7</b> Trigger rebuy rules</a></li>
<li class="chapter" data-level="18.4.8" data-path="functional-elixir.html"><a href="functional-elixir.html#the-final-clause-rules"><i class="fa fa-check"></i><b>18.4.8</b> The final clause rules</a></li>
<li class="chapter" data-level="18.4.9" data-path="functional-elixir.html"><a href="functional-elixir.html#changes-to-the-naive.trader-module"><i class="fa fa-check"></i><b>18.4.9</b> Changes to the <code>Naive.Trader</code> module</a></li>
<li class="chapter" data-level="18.4.10" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---place-buy-order"><i class="fa fa-check"></i><b>18.4.10</b> <code>Naive.Trader</code> - place buy order</a></li>
<li class="chapter" data-level="18.4.11" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---race-condition-clause"><i class="fa fa-check"></i><b>18.4.11</b> <code>Naive.Trader</code> - Race condition clause</a></li>
<li class="chapter" data-level="18.4.12" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---place-a-sell-order"><i class="fa fa-check"></i><b>18.4.12</b> <code>Naive.Trader</code> - Place a sell order</a></li>
<li class="chapter" data-level="18.4.13" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---fetch-the-buy-order"><i class="fa fa-check"></i><b>18.4.13</b> <code>Naive.Trader</code> - Fetch the buy order</a></li>
<li class="chapter" data-level="18.4.14" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---terminate-the-trader"><i class="fa fa-check"></i><b>18.4.14</b> <code>Naive.Trader</code> - Terminate the trader</a></li>
<li class="chapter" data-level="18.4.15" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---fetch-the-sell-order"><i class="fa fa-check"></i><b>18.4.15</b> <code>Naive.Trader</code> - Fetch the sell order</a></li>
<li class="chapter" data-level="18.4.16" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---triggering-rebuy"><i class="fa fa-check"></i><b>18.4.16</b> <code>Naive.Trader</code> - Triggering rebuy</a></li>
<li class="chapter" data-level="18.4.17" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---the-final-ignore-clause"><i class="fa fa-check"></i><b>18.4.17</b> <code>Naive.Trader</code> - The final ignore clause</a></li>
</ul></li>
<li class="chapter" data-level="18.5" data-path="functional-elixir.html"><a href="functional-elixir.html#dealing-with-dirty-code"><i class="fa fa-check"></i><b>18.5</b> Dealing with dirty code</a></li>
<li class="chapter" data-level="18.6" data-path="functional-elixir.html"><a href="functional-elixir.html#making-dirty-code-testable"><i class="fa fa-check"></i><b>18.6</b> Making dirty code testable</a>
<ul>
<li class="chapter" data-level="18.6.1" data-path="functional-elixir.html"><a href="functional-elixir.html#passing-functions-arguments"><i class="fa fa-check"></i><b>18.6.1</b> Passing functions arguments</a></li>
<li class="chapter" data-level="18.6.2" data-path="functional-elixir.html"><a href="functional-elixir.html#passing-grouped-functions-as-a-context"><i class="fa fa-check"></i><b>18.6.2</b> Passing grouped functions as a context</a></li>
<li class="chapter" data-level="18.6.3" data-path="functional-elixir.html"><a href="functional-elixir.html#passing-grouped-modules-as-a-context"><i class="fa fa-check"></i><b>18.6.3</b> Passing grouped modules as a context</a></li>
<li class="chapter" data-level="18.6.4" data-path="functional-elixir.html"><a href="functional-elixir.html#injecting-modules-to-modules-attributes-based-on-the-configuration"><i class="fa fa-check"></i><b>18.6.4</b> Injecting modules to module’s attributes based on the configuration</a></li>
</ul></li>
<li class="chapter" data-level="18.7" data-path="functional-elixir.html"><a href="functional-elixir.html#the-power-with-in"><i class="fa fa-check"></i><b>18.7</b> The power <code>with</code>-in</a>
<ul>
<li class="chapter" data-level="18.7.1" data-path="functional-elixir.html"><a href="functional-elixir.html#idiomatic-error-handling"><i class="fa fa-check"></i><b>18.7.1</b> Idiomatic error handling</a></li>
</ul></li>
<li class="chapter" data-level="18.8" data-path="functional-elixir.html"><a href="functional-elixir.html#do-or-not-to-do"><i class="fa fa-check"></i><b>18.8</b> Do or not to do</a></li>
<li class="chapter" data-level="18.9" data-path="functional-elixir.html"><a href="functional-elixir.html#final-thoughts"><i class="fa fa-check"></i><b>18.9</b> Final thoughts</a></li>
</ul></li>
<li class="chapter" data-level="19" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html"><i class="fa fa-check"></i><b>19</b> Idiomatic OTP</a>
<ul>
<li class="chapter" data-level="19.1" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#objectives-18"><i class="fa fa-check"></i><b>19.1</b> Objectives</a></li>
<li class="chapter" data-level="19.2" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#the-concept"><i class="fa fa-check"></i><b>19.2</b> The concept</a></li>
<li class="chapter" data-level="19.3" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#initial-implementation"><i class="fa fa-check"></i><b>19.3</b> Initial implementation</a>
<ul>
<li class="chapter" data-level="19.3.1" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#maybe-functions"><i class="fa fa-check"></i><b>19.3.1</b> Maybe functions</a></li>
<li class="chapter" data-level="19.3.2" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#testing"><i class="fa fa-check"></i><b>19.3.2</b> Testing</a></li>
<li class="chapter" data-level="19.3.3" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#supervision"><i class="fa fa-check"></i><b>19.3.3</b> Supervision</a></li>
</ul></li>
<li class="chapter" data-level="19.4" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#idiomatic-solution"><i class="fa fa-check"></i><b>19.4</b> Idiomatic solution</a></li>
</ul></li>
<li class="chapter" data-level="20" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html"><i class="fa fa-check"></i><b>20</b> Idiomatic trading strategy</a>
<ul>
<li class="chapter" data-level="20.1" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#objectives-19"><i class="fa fa-check"></i><b>20.1</b> Objectives</a></li>
<li class="chapter" data-level="20.2" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#following-the-ohlc-footsteps"><i class="fa fa-check"></i><b>20.2</b> Following the OHLC footsteps</a></li>
<li class="chapter" data-level="20.3" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#simplifying-the-naive-supervision-tree"><i class="fa fa-check"></i><b>20.3</b> Simplifying the Naive supervision tree</a>
<ul>
<li class="chapter" data-level="20.3.1" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#the-naive.dynamictradersupervisor-module"><i class="fa fa-check"></i><b>20.3.1</b> The <code>Naive.DynamicTraderSupervisor</code> module</a></li>
<li class="chapter" data-level="20.3.2" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#the-naive-module"><i class="fa fa-check"></i><b>20.3.2</b> The <code>Naive</code> module</a></li>
<li class="chapter" data-level="20.3.3" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#the-naive.supervisor-module"><i class="fa fa-check"></i><b>20.3.3</b> The <code>Naive.Supervisor</code> module</a></li>
<li class="chapter" data-level="20.3.4" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#the-naive.trader-module"><i class="fa fa-check"></i><b>20.3.4</b> The <code>Naive.Trader</code> module</a></li>
</ul></li>
<li class="chapter" data-level="20.4" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#supporting-multiple-positions"><i class="fa fa-check"></i><b>20.4</b> Supporting multiple positions</a>
<ul>
<li class="chapter" data-level="20.4.1" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#initialization"><i class="fa fa-check"></i><b>20.4.1</b> Initialization</a></li>
<li class="chapter" data-level="20.4.2" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#parallelising-the-strategy"><i class="fa fa-check"></i><b>20.4.2</b> Parallelising the strategy</a></li>
</ul></li>
<li class="chapter" data-level="20.5" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#retrofitting-the-shutdown-functionality"><i class="fa fa-check"></i><b>20.5</b> Retrofitting the “shutdown” functionality</a>
<ul>
<li class="chapter" data-level="20.5.1" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#handling-updated-settings"><i class="fa fa-check"></i><b>20.5.1</b> Handling updated settings</a></li>
<li class="chapter" data-level="20.5.2" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#updating-the-naive.strategy-to-honour-the-shutdown-state"><i class="fa fa-check"></i><b>20.5.2</b> Updating the <code>Naive.Strategy</code> to honour the “shutdown” state</a></li>
</ul></li>
<li class="chapter" data-level="20.6" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#updating-the-strategy-to-handle-rebuys"><i class="fa fa-check"></i><b>20.6</b> Updating the Strategy to handle rebuys</a></li>
<li class="chapter" data-level="20.7" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#fetching-active-positions"><i class="fa fa-check"></i><b>20.7</b> Fetching active positions</a></li>
<li class="chapter" data-level="20.8" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#tidying-up"><i class="fa fa-check"></i><b>20.8</b> Tidying up</a></li>
<li class="chapter" data-level="20.9" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#final-thoughts-1"><i class="fa fa-check"></i><b>20.9</b> Final thoughts</a></li>
</ul></li>
<li class="chapter" data-level="21" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html"><i class="fa fa-check"></i><b>21</b> Layers of abstraction</a>
<ul>
<li class="chapter" data-level="21.1" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#objectives-20"><i class="fa fa-check"></i><b>21.1</b> Objectives</a></li>
<li class="chapter" data-level="21.2" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#admitting-the-simplification"><i class="fa fa-check"></i><b>21.2</b> Admitting the simplification</a></li>
<li class="chapter" data-level="21.3" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#abstracting-the-exchange"><i class="fa fa-check"></i><b>21.3</b> Abstracting the exchange</a>
<ul>
<li class="chapter" data-level="21.3.1" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#defining-the-core.exchange-behaviour"><i class="fa fa-check"></i><b>21.3.1</b> Defining the <code>Core.Exchange</code> behaviour</a></li>
<li class="chapter" data-level="21.3.2" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#implementation-of-the-core.exchange.binance-module"><i class="fa fa-check"></i><b>21.3.2</b> Implementation of the <code>Core.Exchange.Binance</code> module</a></li>
<li class="chapter" data-level="21.3.3" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#updating-the-binancemock-module-to-implement-the-core.exchange-behaviour"><i class="fa fa-check"></i><b>21.3.3</b> Updating the <code>BinanceMock</code> module to implement the <code>Core.Exchange</code> behaviour</a></li>
<li class="chapter" data-level="21.3.4" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#updating-the-naive.strategy"><i class="fa fa-check"></i><b>21.3.4</b> Updating the <code>Naive.Strategy</code></a></li>
<li class="chapter" data-level="21.3.5" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#updating-the-seed-scripts"><i class="fa fa-check"></i><b>21.3.5</b> Updating the seed scripts</a></li>
<li class="chapter" data-level="21.3.6" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#manual-testing-after-the-refactoring"><i class="fa fa-check"></i><b>21.3.6</b> Manual testing after the refactoring</a></li>
<li class="chapter" data-level="21.3.7" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#storing-the-data"><i class="fa fa-check"></i><b>21.3.7</b> Storing the data</a></li>
<li class="chapter" data-level="21.3.8" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#the-mox-approach-summary"><i class="fa fa-check"></i><b>21.3.8</b> The <code>Mox</code> approach summary</a></li>
</ul></li>
<li class="chapter" data-level="21.4" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#mimicking-the-reality"><i class="fa fa-check"></i><b>21.4</b> Mimicking the reality</a>
<ul>
<li class="chapter" data-level="21.4.1" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#updating-the-naive.strategy-1"><i class="fa fa-check"></i><b>21.4.1</b> Updating the <code>Naive.Strategy</code></a></li>
<li class="chapter" data-level="21.4.2" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#testing-the-naive.strategy"><i class="fa fa-check"></i><b>21.4.2</b> Testing the <code>Naive.Strategy</code></a></li>
<li class="chapter" data-level="21.4.3" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#logging-elephant-in-the-room"><i class="fa fa-check"></i><b>21.4.3</b> Logging elephant in the room</a></li>
</ul></li>
<li class="chapter" data-level="21.5" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#swapping-back-to-attributes"><i class="fa fa-check"></i><b>21.5</b> Swapping back to attributes</a>
<ul>
<li class="chapter" data-level="21.5.1" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#config-files"><i class="fa fa-check"></i><b>21.5.1</b> Config files</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="22" data-path="win-with-pure-logic.html"><a href="win-with-pure-logic.html"><i class="fa fa-check"></i><b>22</b> 80/20 win with pure logic</a>
<ul>
<li class="chapter" data-level="22.1" data-path="win-with-pure-logic.html"><a href="win-with-pure-logic.html#objectives-21"><i class="fa fa-check"></i><b>22.1</b> Objectives</a></li>
<li class="chapter" data-level="22.2" data-path="win-with-pure-logic.html"><a href="win-with-pure-logic.html#testing-the-pure-logic"><i class="fa fa-check"></i><b>22.2</b> Testing the pure logic</a></li>
</ul></li>
<li class="chapter" data-level="23" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html"><i class="fa fa-check"></i><b>23</b> Back to the Monolith</a>
<ul>
<li class="chapter" data-level="23.1" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#objectives-22"><i class="fa fa-check"></i><b>23.1</b> Objectives</a></li>
<li class="chapter" data-level="23.2" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#reverting-the-course-to-the-monolith"><i class="fa fa-check"></i><b>23.2</b> Reverting the course to the monolith</a></li>
<li class="chapter" data-level="23.3" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#creating-a-new-phoenix-app"><i class="fa fa-check"></i><b>23.3</b> Creating a new Phoenix app</a></li>
<li class="chapter" data-level="23.4" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#reintegrating-the-core-app"><i class="fa fa-check"></i><b>23.4</b> Reintegrating the <code>core</code> app</a></li>
<li class="chapter" data-level="23.5" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#reintegrating-the-binance_mock-app"><i class="fa fa-check"></i><b>23.5</b> Reintegrating the <code>binance_mock</code> app</a></li>
<li class="chapter" data-level="23.6" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#reintegrating-the-streamer-app"><i class="fa fa-check"></i><b>23.6</b> Reintegrating the <code>streamer</code> app</a>
<ul>
<li class="chapter" data-level="23.6.1" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#supervisor"><i class="fa fa-check"></i><b>23.6.1</b> Supervisor</a></li>
<li class="chapter" data-level="23.6.2" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#worker"><i class="fa fa-check"></i><b>23.6.2</b> Worker</a></li>
<li class="chapter" data-level="23.6.3" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#dynamicstreamersupervisor"><i class="fa fa-check"></i><b>23.6.3</b> DynamicStreamerSupervisor</a></li>
<li class="chapter" data-level="23.6.4" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#schemasettings.ex-and-schemastreaming_status_enum.ex"><i class="fa fa-check"></i><b>23.6.4</b> schema/settings.ex and schema/streaming_status_enum.ex</a></li>
<li class="chapter" data-level="23.6.5" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#application"><i class="fa fa-check"></i><b>23.6.5</b> application</a></li>
<li class="chapter" data-level="23.6.6" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#db-migrations-and-seeding"><i class="fa fa-check"></i><b>23.6.6</b> DB migrations and seeding</a></li>
<li class="chapter" data-level="23.6.7" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#config"><i class="fa fa-check"></i><b>23.6.7</b> Config</a></li>
<li class="chapter" data-level="23.6.8" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#deps"><i class="fa fa-check"></i><b>23.6.8</b> Deps</a></li>
</ul></li>
<li class="chapter" data-level="23.7" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#reintegrating-the-naive-app"><i class="fa fa-check"></i><b>23.7</b> Reintegrating the <code>naive</code> app</a>
<ul>
<li class="chapter" data-level="23.7.1" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#naive.ex"><i class="fa fa-check"></i><b>23.7.1</b> naive.ex</a></li>
<li class="chapter" data-level="23.7.2" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#strategy.ex---formula.ex"><i class="fa fa-check"></i><b>23.7.2</b> strategy.ex -&gt; formula.ex</a></li>
<li class="chapter" data-level="23.7.3" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#trader.ex"><i class="fa fa-check"></i><b>23.7.3</b> <code>trader.ex</code></a></li>
<li class="chapter" data-level="23.7.4" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#supervisor.ex"><i class="fa fa-check"></i><b>23.7.4</b> <code>supervisor.ex</code></a></li>
<li class="chapter" data-level="23.7.5" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#dynamic_trader_supervisor.ex"><i class="fa fa-check"></i><b>23.7.5</b> <code>dynamic_trader_supervisor.ex</code></a></li>
<li class="chapter" data-level="23.7.6" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#repo-and-schema-files"><i class="fa fa-check"></i><b>23.7.6</b> Repo and <code>schema</code> files</a></li>
<li class="chapter" data-level="23.7.7" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#application.ex"><i class="fa fa-check"></i><b>23.7.7</b> <code>application.ex</code></a></li>
<li class="chapter" data-level="23.7.8" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#migration-and-seeding"><i class="fa fa-check"></i><b>23.7.8</b> Migration and seeding</a></li>
<li class="chapter" data-level="23.7.9" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#configuration"><i class="fa fa-check"></i><b>23.7.9</b> Configuration</a></li>
<li class="chapter" data-level="23.7.10" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#tests"><i class="fa fa-check"></i><b>23.7.10</b> Tests</a></li>
<li class="chapter" data-level="23.7.11" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#dependencies"><i class="fa fa-check"></i><b>23.7.11</b> Dependencies</a></li>
</ul></li>
<li class="chapter" data-level="23.8" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#reintegrating-the-data_warehouse-app"><i class="fa fa-check"></i><b>23.8</b> Reintegrating the <code>data_warehouse</code> app</a>
<ul>
<li class="chapter" data-level="23.8.1" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#exchangeorder.ex"><i class="fa fa-check"></i><b>23.8.1</b> <code>exchange/order.ex</code></a></li>
<li class="chapter" data-level="23.8.2" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#exchangetrade_event.ex"><i class="fa fa-check"></i><b>23.8.2</b> <code>exchange/trade_event.ex</code></a></li>
<li class="chapter" data-level="23.8.3" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#datapublisher.ex"><i class="fa fa-check"></i><b>23.8.3</b> <code>data/publisher.ex</code></a></li>
<li class="chapter" data-level="23.8.4" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#datacollector.ex"><i class="fa fa-check"></i><b>23.8.4</b> <code>data/collector.ex</code></a></li>
<li class="chapter" data-level="23.8.5" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#datacollectorcollector_supervisor.ex"><i class="fa fa-check"></i><b>23.8.5</b> <code>data/collector/collector_supervisor.ex</code></a></li>
<li class="chapter" data-level="23.8.6" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#datacollectordynamic_worker_supervisor.ex"><i class="fa fa-check"></i><b>23.8.6</b> <code>/data/collector/dynamic_worker_supervisor.ex</code></a></li>
<li class="chapter" data-level="23.8.7" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#datacollectorsettings_status_enum.ex"><i class="fa fa-check"></i><b>23.8.7</b> <code>/data/collector/settings_status_enum.ex</code></a></li>
<li class="chapter" data-level="23.8.8" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#datacollectorsettings.ex"><i class="fa fa-check"></i><b>23.8.8</b> <code>/data/collector/settings.ex</code></a></li>
<li class="chapter" data-level="23.8.9" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#datacollectorworker.ex"><i class="fa fa-check"></i><b>23.8.9</b> <code>/data/collector/worker.ex</code></a></li>
<li class="chapter" data-level="23.8.10" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#supervision-tree"><i class="fa fa-check"></i><b>23.8.10</b> Supervision tree</a></li>
<li class="chapter" data-level="23.8.11" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#migrations"><i class="fa fa-check"></i><b>23.8.11</b> Migrations</a></li>
</ul></li>
<li class="chapter" data-level="23.9" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#reintegrating-the-indicator-app"><i class="fa fa-check"></i><b>23.9</b> Reintegrating the <code>indicator</code> app</a>
<ul>
<li class="chapter" data-level="23.9.1" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#dataaggregator.ex"><i class="fa fa-check"></i><b>23.9.1</b> /data/aggregator.ex</a></li>
<li class="chapter" data-level="23.9.2" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#dataaggregatorohlc.ex"><i class="fa fa-check"></i><b>23.9.2</b> /data/aggregator/ohlc.ex</a></li>
<li class="chapter" data-level="23.9.3" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#dataaggregatorohlcworker.ex"><i class="fa fa-check"></i><b>23.9.3</b> /data/aggregator/ohlc/worker.ex</a></li>
<li class="chapter" data-level="23.9.4" data-path="back-to-the-monolith.html"><a href="back-to-the-monolith.html#supervision-tree-1"><i class="fa fa-check"></i><b>23.9.4</b> Supervision tree</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://www.bookdown.org/" target="blank">Created with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Hands-on Elixir &amp; OTP: Cryptocurrency trading bot</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="functional-elixir" class="section level1 hasAnchor" number="18">
<h1><span class="header-section-number">Chapter 18</span> Functional Elixir<a href="functional-elixir.html#functional-elixir" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="objectives-17" class="section level2 hasAnchor" number="18.1">
<h2><span class="header-section-number">18.1</span> Objectives<a href="functional-elixir.html#objectives-17" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>the reasoning behind the functional approach</li>
<li>simplifying by splitting</li>
<li>abstracting the “pure” logic</li>
<li>dealing with dirty code</li>
<li>making dirty code testable</li>
<li>the power <code>with</code>-in</li>
<li>do or not to do</li>
<li>final thoughts</li>
</ul>
</div>
<div id="the-reasoning-behind-the-functional-approach" class="section level2 hasAnchor" number="18.2">
<h2><span class="header-section-number">18.2</span> The reasoning behind the functional approach<a href="functional-elixir.html#the-reasoning-behind-the-functional-approach" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Across the last 17 chapters, we focused on learning OTP by building a trading system. On the way, we omitted (for a very good reason - a clear focus on OTP) the conversation about functional programming.</p>
<p>But wait, what? We are already using concepts like higher-order functions - isn’t that enough?</p>
<p>We indeed use some functional patterns, but we never dug deeper into what Elixir developers <strong>should</strong> know(and apply) and, most importantly, <strong>why</strong>.</p>
<p>In a nutshell, the selling point of functional programming is that applying it will make your code easier to reason about and test. Tests dramatically improve software quality. The easier they are to write, there’s less excuse not to write them - as simple as that.</p>
<p>We will start from the basics and look into different ways of implementing functional concepts, considering Elixir’s strengths and weaknesses.</p>
</div>
<div id="simplifying-by-splitting" class="section level2 hasAnchor" number="18.3">
<h2><span class="header-section-number">18.3</span> Simplifying by splitting<a href="functional-elixir.html#simplifying-by-splitting" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Note: This section could appear to be a bit “random”, but I added it to aid continuity of refactoring steps(refactoring those callbacks later would cause a fair amount of complexity).</p>
<p>Let’s look at our strategy inside the <code>Naive.Trader</code> module. In this section, we will focus on its (<code>handle_info/2</code>) callback function.</p>
<p>We are looking for clauses that do more than “one thing” to split them into multiple clauses:</p>
<ul>
<li>The first callback places a buy order - it has a single responsibility and is easy to follow.</li>
<li>The second callback takes care of race conditions - the same story, easy to understand.</li>
<li>The third callback is the one we will focus on. It branches using the <code>if</code> statement, and we could describe it as “fetch and maybe place a sell order” function. The “and” in the description clearly indicates that it’s really two functions glued together. We will split it into “fetch buy order” and “place a sell order” functions(below code replaces the 3rd <code>handle_info/2</code> callback):</li>
</ul>
<div class="sourceCode" id="cb383"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb383-1"><a href="functional-elixir.html#cb383-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/trader.ex</span></span>
<span id="cb383-2"><a href="functional-elixir.html#cb383-2" tabindex="-1"></a>  <span class="kw">def</span> handle_info<span class="fu">(</span></span>
<span id="cb383-3"><a href="functional-elixir.html#cb383-3" tabindex="-1"></a>        %<span class="cn">TradeEvent</span><span class="fu">{}</span>,</span>
<span id="cb383-4"><a href="functional-elixir.html#cb383-4" tabindex="-1"></a>        %<span class="cn">State</span><span class="fu">{</span></span>
<span id="cb383-5"><a href="functional-elixir.html#cb383-5" tabindex="-1"></a>          <span class="va">id:</span> id,</span>
<span id="cb383-6"><a href="functional-elixir.html#cb383-6" tabindex="-1"></a>          <span class="va">symbol:</span> symbol,</span>
<span id="cb383-7"><a href="functional-elixir.html#cb383-7" tabindex="-1"></a>          <span class="va">buy_order:</span> %<span class="cn">Binance</span><span class="op">.</span><span class="cn">OrderResponse</span><span class="fu">{</span></span>
<span id="cb383-8"><a href="functional-elixir.html#cb383-8" tabindex="-1"></a>            <span class="va">price:</span> buy_price,</span>
<span id="cb383-9"><a href="functional-elixir.html#cb383-9" tabindex="-1"></a>            <span class="va">orig_qty:</span> quantity,</span>
<span id="cb383-10"><a href="functional-elixir.html#cb383-10" tabindex="-1"></a>            <span class="va">status:</span> <span class="st">&quot;FILLED&quot;</span></span>
<span id="cb383-11"><a href="functional-elixir.html#cb383-11" tabindex="-1"></a>          <span class="fu">}</span>,</span>
<span id="cb383-12"><a href="functional-elixir.html#cb383-12" tabindex="-1"></a>          <span class="va">sell_order:</span> <span class="cn">nil</span>,</span>
<span id="cb383-13"><a href="functional-elixir.html#cb383-13" tabindex="-1"></a>          <span class="va">profit_interval:</span> profit_interval,</span>
<span id="cb383-14"><a href="functional-elixir.html#cb383-14" tabindex="-1"></a>          <span class="va">tick_size:</span> tick_size</span>
<span id="cb383-15"><a href="functional-elixir.html#cb383-15" tabindex="-1"></a>        <span class="fu">}</span> <span class="op">=</span> state</span>
<span id="cb383-16"><a href="functional-elixir.html#cb383-16" tabindex="-1"></a>      <span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb383-17"><a href="functional-elixir.html#cb383-17" tabindex="-1"></a>    sell_price <span class="op">=</span> calculate_sell_price<span class="fu">(</span>buy_price, profit_interval, tick_size<span class="fu">)</span></span>
<span id="cb383-18"><a href="functional-elixir.html#cb383-18" tabindex="-1"></a></span>
<span id="cb383-19"><a href="functional-elixir.html#cb383-19" tabindex="-1"></a>    <span class="ot">@logger</span><span class="op">.</span>info<span class="fu">(</span></span>
<span id="cb383-20"><a href="functional-elixir.html#cb383-20" tabindex="-1"></a>      <span class="st">&quot;The trader(</span><span class="ot">#{</span>id<span class="ot">}</span><span class="st">) is placing a SELL order for &quot;</span> <span class="op">&lt;&gt;</span></span>
<span id="cb383-21"><a href="functional-elixir.html#cb383-21" tabindex="-1"></a>        <span class="st">&quot;</span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st"> @ </span><span class="ot">#{</span>sell_price<span class="ot">}</span><span class="st">, quantity: </span><span class="ot">#{</span>quantity<span class="ot">}</span><span class="st">.&quot;</span></span>
<span id="cb383-22"><a href="functional-elixir.html#cb383-22" tabindex="-1"></a>    <span class="fu">)</span></span>
<span id="cb383-23"><a href="functional-elixir.html#cb383-23" tabindex="-1"></a></span>
<span id="cb383-24"><a href="functional-elixir.html#cb383-24" tabindex="-1"></a>    <span class="fu">{</span><span class="va">:ok</span>, %<span class="cn">Binance</span><span class="op">.</span><span class="cn">OrderResponse</span><span class="fu">{}</span> <span class="op">=</span> order<span class="fu">}</span> <span class="op">=</span></span>
<span id="cb383-25"><a href="functional-elixir.html#cb383-25" tabindex="-1"></a>      <span class="ot">@binance_client</span><span class="op">.</span>order_limit_sell<span class="fu">(</span>symbol, quantity, sell_price, <span class="st">&quot;GTC&quot;</span><span class="fu">)</span></span>
<span id="cb383-26"><a href="functional-elixir.html#cb383-26" tabindex="-1"></a></span>
<span id="cb383-27"><a href="functional-elixir.html#cb383-27" tabindex="-1"></a>    <span class="va">:ok</span> <span class="op">=</span> broadcast_order<span class="fu">(</span>order<span class="fu">)</span></span>
<span id="cb383-28"><a href="functional-elixir.html#cb383-28" tabindex="-1"></a></span>
<span id="cb383-29"><a href="functional-elixir.html#cb383-29" tabindex="-1"></a>    new_state <span class="op">=</span> %<span class="fu">{</span>state <span class="op">|</span> <span class="va">sell_order:</span> order<span class="fu">}</span></span>
<span id="cb383-30"><a href="functional-elixir.html#cb383-30" tabindex="-1"></a>    <span class="ot">@leader</span><span class="op">.</span>notify<span class="fu">(</span><span class="va">:trader_state_updated</span>, new_state<span class="fu">)</span></span>
<span id="cb383-31"><a href="functional-elixir.html#cb383-31" tabindex="-1"></a>    <span class="fu">{</span><span class="va">:noreply</span>, new_state<span class="fu">}</span></span>
<span id="cb383-32"><a href="functional-elixir.html#cb383-32" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb383-33"><a href="functional-elixir.html#cb383-33" tabindex="-1"></a></span>
<span id="cb383-34"><a href="functional-elixir.html#cb383-34" tabindex="-1"></a>  <span class="kw">def</span> handle_info<span class="fu">(</span></span>
<span id="cb383-35"><a href="functional-elixir.html#cb383-35" tabindex="-1"></a>        %<span class="cn">TradeEvent</span><span class="fu">{</span></span>
<span id="cb383-36"><a href="functional-elixir.html#cb383-36" tabindex="-1"></a>          <span class="va">buyer_order_id:</span> order_id</span>
<span id="cb383-37"><a href="functional-elixir.html#cb383-37" tabindex="-1"></a>        <span class="fu">}</span>,</span>
<span id="cb383-38"><a href="functional-elixir.html#cb383-38" tabindex="-1"></a>        %<span class="cn">State</span><span class="fu">{</span></span>
<span id="cb383-39"><a href="functional-elixir.html#cb383-39" tabindex="-1"></a>          <span class="va">id:</span> id,</span>
<span id="cb383-40"><a href="functional-elixir.html#cb383-40" tabindex="-1"></a>          <span class="va">symbol:</span> symbol,</span>
<span id="cb383-41"><a href="functional-elixir.html#cb383-41" tabindex="-1"></a>          <span class="va">buy_order:</span></span>
<span id="cb383-42"><a href="functional-elixir.html#cb383-42" tabindex="-1"></a>            %<span class="cn">Binance</span><span class="op">.</span><span class="cn">OrderResponse</span><span class="fu">{</span></span>
<span id="cb383-43"><a href="functional-elixir.html#cb383-43" tabindex="-1"></a>              <span class="va">order_id:</span> order_id,</span>
<span id="cb383-44"><a href="functional-elixir.html#cb383-44" tabindex="-1"></a>              <span class="va">transact_time:</span> timestamp</span>
<span id="cb383-45"><a href="functional-elixir.html#cb383-45" tabindex="-1"></a>            <span class="fu">}</span> <span class="op">=</span> buy_order</span>
<span id="cb383-46"><a href="functional-elixir.html#cb383-46" tabindex="-1"></a>        <span class="fu">}</span> <span class="op">=</span> state</span>
<span id="cb383-47"><a href="functional-elixir.html#cb383-47" tabindex="-1"></a>      <span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb383-48"><a href="functional-elixir.html#cb383-48" tabindex="-1"></a>    <span class="ot">@logger</span><span class="op">.</span>info<span class="fu">(</span><span class="st">&quot;Trader&#39;s(</span><span class="ot">#{</span>id<span class="ot">}</span><span class="st"> </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st"> buy order got partially filled&quot;</span><span class="fu">)</span></span>
<span id="cb383-49"><a href="functional-elixir.html#cb383-49" tabindex="-1"></a></span>
<span id="cb383-50"><a href="functional-elixir.html#cb383-50" tabindex="-1"></a>    <span class="fu">{</span><span class="va">:ok</span>, %<span class="cn">Binance</span><span class="op">.</span><span class="cn">Order</span><span class="fu">{}</span> <span class="op">=</span> current_buy_order<span class="fu">}</span> <span class="op">=</span></span>
<span id="cb383-51"><a href="functional-elixir.html#cb383-51" tabindex="-1"></a>      <span class="ot">@binance_client</span><span class="op">.</span>get_order<span class="fu">(</span></span>
<span id="cb383-52"><a href="functional-elixir.html#cb383-52" tabindex="-1"></a>        symbol,</span>
<span id="cb383-53"><a href="functional-elixir.html#cb383-53" tabindex="-1"></a>        timestamp,</span>
<span id="cb383-54"><a href="functional-elixir.html#cb383-54" tabindex="-1"></a>        order_id</span>
<span id="cb383-55"><a href="functional-elixir.html#cb383-55" tabindex="-1"></a>      <span class="fu">)</span></span>
<span id="cb383-56"><a href="functional-elixir.html#cb383-56" tabindex="-1"></a></span>
<span id="cb383-57"><a href="functional-elixir.html#cb383-57" tabindex="-1"></a>    <span class="va">:ok</span> <span class="op">=</span> broadcast_order<span class="fu">(</span>current_buy_order<span class="fu">)</span></span>
<span id="cb383-58"><a href="functional-elixir.html#cb383-58" tabindex="-1"></a></span>
<span id="cb383-59"><a href="functional-elixir.html#cb383-59" tabindex="-1"></a>    buy_order <span class="op">=</span> %<span class="fu">{</span>buy_order <span class="op">|</span> <span class="va">status:</span> current_buy_order<span class="op">.</span>status<span class="fu">}</span></span>
<span id="cb383-60"><a href="functional-elixir.html#cb383-60" tabindex="-1"></a></span>
<span id="cb383-61"><a href="functional-elixir.html#cb383-61" tabindex="-1"></a>    new_state <span class="op">=</span> %<span class="fu">{</span>state <span class="op">|</span> <span class="va">buy_order:</span> buy_order<span class="fu">}</span></span>
<span id="cb383-62"><a href="functional-elixir.html#cb383-62" tabindex="-1"></a>    <span class="ot">@leader</span><span class="op">.</span>notify<span class="fu">(</span><span class="va">:trader_state_updated</span>, new_state<span class="fu">)</span></span>
<span id="cb383-63"><a href="functional-elixir.html#cb383-63" tabindex="-1"></a>    <span class="fu">{</span><span class="va">:noreply</span>, new_state<span class="fu">}</span></span>
<span id="cb383-64"><a href="functional-elixir.html#cb383-64" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>The first function takes care of placing a sell order. The second one fetches the buy order.</p>
<ul>
<li>We can now move to the next clause, similar to the last one we could describe as “fetch the sell order and maybe terminate the trader”. We will split it into two callbacks: “fetch the sell order” and “terminate trader”.</li>
</ul>
<div style="page-break-after: always;"></div>
<p>The code below replaces the 5th <code>handle_info/2</code> callback:</p>
<div class="sourceCode" id="cb384"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb384-1"><a href="functional-elixir.html#cb384-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/trader.ex</span></span>
<span id="cb384-2"><a href="functional-elixir.html#cb384-2" tabindex="-1"></a>  <span class="kw">def</span> handle_info<span class="fu">(</span></span>
<span id="cb384-3"><a href="functional-elixir.html#cb384-3" tabindex="-1"></a>        %<span class="cn">TradeEvent</span><span class="fu">{}</span>,</span>
<span id="cb384-4"><a href="functional-elixir.html#cb384-4" tabindex="-1"></a>        %<span class="cn">State</span><span class="fu">{</span></span>
<span id="cb384-5"><a href="functional-elixir.html#cb384-5" tabindex="-1"></a>          <span class="va">id:</span> id,</span>
<span id="cb384-6"><a href="functional-elixir.html#cb384-6" tabindex="-1"></a>          <span class="va">symbol:</span> symbol,</span>
<span id="cb384-7"><a href="functional-elixir.html#cb384-7" tabindex="-1"></a>          <span class="va">sell_order:</span> %<span class="cn">Binance</span><span class="op">.</span><span class="cn">OrderResponse</span><span class="fu">{</span></span>
<span id="cb384-8"><a href="functional-elixir.html#cb384-8" tabindex="-1"></a>            <span class="va">status:</span> <span class="st">&quot;FILLED&quot;</span></span>
<span id="cb384-9"><a href="functional-elixir.html#cb384-9" tabindex="-1"></a>          <span class="fu">}</span></span>
<span id="cb384-10"><a href="functional-elixir.html#cb384-10" tabindex="-1"></a>        <span class="fu">}</span> <span class="op">=</span> state</span>
<span id="cb384-11"><a href="functional-elixir.html#cb384-11" tabindex="-1"></a>      <span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb384-12"><a href="functional-elixir.html#cb384-12" tabindex="-1"></a>    <span class="ot">@logger</span><span class="op">.</span>info<span class="fu">(</span><span class="st">&quot;Trader(</span><span class="ot">#{</span>id<span class="ot">}</span><span class="st">) finished trade cycle for </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st">&quot;</span><span class="fu">)</span></span>
<span id="cb384-13"><a href="functional-elixir.html#cb384-13" tabindex="-1"></a>    <span class="fu">{</span><span class="va">:stop</span>, <span class="va">:normal</span>, state<span class="fu">}</span></span>
<span id="cb384-14"><a href="functional-elixir.html#cb384-14" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb384-15"><a href="functional-elixir.html#cb384-15" tabindex="-1"></a></span>
<span id="cb384-16"><a href="functional-elixir.html#cb384-16" tabindex="-1"></a>  <span class="kw">def</span> handle_info<span class="fu">(</span></span>
<span id="cb384-17"><a href="functional-elixir.html#cb384-17" tabindex="-1"></a>        %<span class="cn">TradeEvent</span><span class="fu">{</span></span>
<span id="cb384-18"><a href="functional-elixir.html#cb384-18" tabindex="-1"></a>          <span class="va">seller_order_id:</span> order_id</span>
<span id="cb384-19"><a href="functional-elixir.html#cb384-19" tabindex="-1"></a>        <span class="fu">}</span>,</span>
<span id="cb384-20"><a href="functional-elixir.html#cb384-20" tabindex="-1"></a>        %<span class="cn">State</span><span class="fu">{</span></span>
<span id="cb384-21"><a href="functional-elixir.html#cb384-21" tabindex="-1"></a>          <span class="va">id:</span> id,</span>
<span id="cb384-22"><a href="functional-elixir.html#cb384-22" tabindex="-1"></a>          <span class="va">symbol:</span> symbol,</span>
<span id="cb384-23"><a href="functional-elixir.html#cb384-23" tabindex="-1"></a>          <span class="va">sell_order:</span></span>
<span id="cb384-24"><a href="functional-elixir.html#cb384-24" tabindex="-1"></a>            %<span class="cn">Binance</span><span class="op">.</span><span class="cn">OrderResponse</span><span class="fu">{</span></span>
<span id="cb384-25"><a href="functional-elixir.html#cb384-25" tabindex="-1"></a>              <span class="va">order_id:</span> order_id,</span>
<span id="cb384-26"><a href="functional-elixir.html#cb384-26" tabindex="-1"></a>              <span class="va">transact_time:</span> timestamp</span>
<span id="cb384-27"><a href="functional-elixir.html#cb384-27" tabindex="-1"></a>            <span class="fu">}</span> <span class="op">=</span> sell_order</span>
<span id="cb384-28"><a href="functional-elixir.html#cb384-28" tabindex="-1"></a>        <span class="fu">}</span> <span class="op">=</span> state</span>
<span id="cb384-29"><a href="functional-elixir.html#cb384-29" tabindex="-1"></a>      <span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb384-30"><a href="functional-elixir.html#cb384-30" tabindex="-1"></a>    <span class="ot">@logger</span><span class="op">.</span>info<span class="fu">(</span><span class="st">&quot;Trader&#39;s(</span><span class="ot">#{</span>id<span class="ot">}</span><span class="st"> </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st"> SELL order got partially filled&quot;</span><span class="fu">)</span></span>
<span id="cb384-31"><a href="functional-elixir.html#cb384-31" tabindex="-1"></a></span>
<span id="cb384-32"><a href="functional-elixir.html#cb384-32" tabindex="-1"></a>    <span class="fu">{</span><span class="va">:ok</span>, %<span class="cn">Binance</span><span class="op">.</span><span class="cn">Order</span><span class="fu">{}</span> <span class="op">=</span> current_sell_order<span class="fu">}</span> <span class="op">=</span></span>
<span id="cb384-33"><a href="functional-elixir.html#cb384-33" tabindex="-1"></a>      <span class="ot">@binance_client</span><span class="op">.</span>get_order<span class="fu">(</span></span>
<span id="cb384-34"><a href="functional-elixir.html#cb384-34" tabindex="-1"></a>        symbol,</span>
<span id="cb384-35"><a href="functional-elixir.html#cb384-35" tabindex="-1"></a>        timestamp,</span>
<span id="cb384-36"><a href="functional-elixir.html#cb384-36" tabindex="-1"></a>        order_id</span>
<span id="cb384-37"><a href="functional-elixir.html#cb384-37" tabindex="-1"></a>      <span class="fu">)</span></span>
<span id="cb384-38"><a href="functional-elixir.html#cb384-38" tabindex="-1"></a></span>
<span id="cb384-39"><a href="functional-elixir.html#cb384-39" tabindex="-1"></a>    <span class="va">:ok</span> <span class="op">=</span> broadcast_order<span class="fu">(</span>current_sell_order<span class="fu">)</span></span>
<span id="cb384-40"><a href="functional-elixir.html#cb384-40" tabindex="-1"></a></span>
<span id="cb384-41"><a href="functional-elixir.html#cb384-41" tabindex="-1"></a>    sell_order <span class="op">=</span> %<span class="fu">{</span>sell_order <span class="op">|</span> <span class="va">status:</span> current_sell_order<span class="op">.</span>status<span class="fu">}</span></span>
<span id="cb384-42"><a href="functional-elixir.html#cb384-42" tabindex="-1"></a></span>
<span id="cb384-43"><a href="functional-elixir.html#cb384-43" tabindex="-1"></a>    new_state <span class="op">=</span> %<span class="fu">{</span>state <span class="op">|</span> <span class="va">sell_order:</span> sell_order<span class="fu">}</span></span>
<span id="cb384-44"><a href="functional-elixir.html#cb384-44" tabindex="-1"></a>    <span class="ot">@leader</span><span class="op">.</span>notify<span class="fu">(</span><span class="va">:trader_state_updated</span>, new_state<span class="fu">)</span></span>
<span id="cb384-45"><a href="functional-elixir.html#cb384-45" tabindex="-1"></a>    <span class="fu">{</span><span class="va">:noreply</span>, new_state<span class="fu">}</span></span>
<span id="cb384-46"><a href="functional-elixir.html#cb384-46" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>The first function takes care of terminating the trader. The second function is fetching the sell order.</p>
<p>That finishes our first refactoring round, but I need to admit that our change has impacted the behaviour of our strategy. Each time a buy or sell order gets filled, we will fetch that order from Binance, but we <strong>won’t</strong> immediately place a sell order nor terminate as it was happening before. Instead, only when another event arrives will the trader place a sell order or terminate.</p>
<p>Changes like this require approval from the business in a work situation, but it’s a good showcase of the situation where we can propose a solution that will simplify the code(the benefits will become evident in the following sections).</p>
<p>We can confirm that we have broken our tests by running our integration testsuite:</p>
<div class="sourceCode" id="cb385"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb385-1"><a href="functional-elixir.html#cb385-1" tabindex="-1"></a><span class="ex">$</span> MIX_ENV=integration mix test.integration</span>
<span id="cb385-2"><a href="functional-elixir.html#cb385-2" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb385-3"><a href="functional-elixir.html#cb385-3" tabindex="-1"></a>  <span class="ex">1</span><span class="er">)</span> <span class="bu">test</span> Naive trader full trade<span class="er">(</span><span class="ex">buy</span> + sell<span class="kw">)</span> <span class="bu">test</span> <span class="er">(</span><span class="ex">NaiveTest</span><span class="kw">)</span></span>
<span id="cb385-4"><a href="functional-elixir.html#cb385-4" tabindex="-1"></a>     <span class="ex">apps/naive/test/naive_test.exs:12</span></span>
<span id="cb385-5"><a href="functional-elixir.html#cb385-5" tabindex="-1"></a>     <span class="ex">**</span> <span class="er">(</span><span class="ex">MatchError</span><span class="kw">)</span> <span class="ex">no</span> match of right hand side value: [[<span class="st">&quot;0.43070000&quot;</span>, <span class="st">&quot;BUY&quot;</span>, <span class="st">&quot;FILLED&quot;</span>]...</span>
<span id="cb385-6"><a href="functional-elixir.html#cb385-6" tabindex="-1"></a>     <span class="ex">code:</span> [buy_1, sell_1, buy_2] = DataWarehouse.Repo.all<span class="er">(</span><span class="ex">query</span><span class="kw">)</span></span>
<span id="cb385-7"><a href="functional-elixir.html#cb385-7" tabindex="-1"></a>     <span class="ex">stacktrace:</span></span>
<span id="cb385-8"><a href="functional-elixir.html#cb385-8" tabindex="-1"></a>       <span class="ex">test/naive_test.exs:83:</span> <span class="er">(</span><span class="bu">test</span><span class="kw">)</span></span></code></pre></div>
<p>(Subject to acceptance by the business) we will fix the integration test in the following way:</p>
<div class="sourceCode" id="cb386"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb386-1"><a href="functional-elixir.html#cb386-1" tabindex="-1"></a><span class="co"># /apps/naive/test/naive_test.exs</span></span>
<span id="cb386-2"><a href="functional-elixir.html#cb386-2" tabindex="-1"></a>  test <span class="st">&quot;Naive trader full trade(buy + sell) test&quot;</span> <span class="kw">do</span></span>
<span id="cb386-3"><a href="functional-elixir.html#cb386-3" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb386-4"><a href="functional-elixir.html#cb386-4" tabindex="-1"></a>    <span class="co"># Step 4 - Broadcast 10 events # &lt;= updated comment</span></span>
<span id="cb386-5"><a href="functional-elixir.html#cb386-5" tabindex="-1"></a>    <span class="ot">[</span></span>
<span id="cb386-6"><a href="functional-elixir.html#cb386-6" tabindex="-1"></a>       <span class="op">...</span></span>
<span id="cb386-7"><a href="functional-elixir.html#cb386-7" tabindex="-1"></a>      generate_event<span class="fu">(</span><span class="dv">8</span>, <span class="st">&quot;0.43205&quot;</span>, <span class="st">&quot;345.14235000&quot;</span><span class="fu">)</span>,</span>
<span id="cb386-8"><a href="functional-elixir.html#cb386-8" tabindex="-1"></a>      <span class="co"># this one should trigger buy order for a new trader process</span></span>
<span id="cb386-9"><a href="functional-elixir.html#cb386-9" tabindex="-1"></a>      generate_event<span class="fu">(</span><span class="dv">9</span>, <span class="st">&quot;0.43205&quot;</span>, <span class="st">&quot;345.14235000&quot;</span><span class="fu">)</span>, <span class="co"># &lt;= added line</span></span>
<span id="cb386-10"><a href="functional-elixir.html#cb386-10" tabindex="-1"></a>      generate_event<span class="fu">(</span><span class="dv">10</span>, <span class="st">&quot;0.43210&quot;</span>, <span class="st">&quot;3201.86480000&quot;</span><span class="fu">)</span> <span class="co"># &lt;= updated id</span></span>
<span id="cb386-11"><a href="functional-elixir.html#cb386-11" tabindex="-1"></a>    <span class="ot">]</span></span></code></pre></div>
<p>We added an event at the same price(as the sell order’s price) that will trigger placing a buy order by the new trader and make our test green again.</p>
<div style="page-break-after: always;"></div>
</div>
<div id="abstracting-the-pure-logic" class="section level2 hasAnchor" number="18.4">
<h2><span class="header-section-number">18.4</span> Abstracting the “pure” logic<a href="functional-elixir.html#abstracting-the-pure-logic" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In our adventure to make our code more functional, we should strive to separate(as much as possible) pure business logic from side effects and boilerplate.</p>
<p>The <code>Naive.Trader</code> module is a GenServer that receives trade events via messages. Based on them and the current state, using pattern-matching, it decides what action should be performed(place a buy order, fetch a buy order, place a sell order, fetch sell order, terminate trader, trigger rebuy or ignore event).</p>
<p>Each of the pattern-matches inside the callback functions’ headers is a <strong>strategy</strong> specific business logic that got mixed with the fact that it’s executed by a GenServer that receives messages.</p>
<p>We will create a new file called <code>strategy.exs</code> inside the <code>apps/naive/lib/naive/</code> directory, where we will <strong>copy</strong> all of the <code>handle_info/2</code> callback functions from the <code>Naive.Trader</code> module:</p>
<div class="sourceCode" id="cb387"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb387-1"><a href="functional-elixir.html#cb387-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/strategy.ex</span></span>
<span id="cb387-2"><a href="functional-elixir.html#cb387-2" tabindex="-1"></a><span class="kw">defmodule</span> <span class="cn">Naive</span><span class="op">.</span><span class="cn">Strategy</span> <span class="kw">do</span></span>
<span id="cb387-3"><a href="functional-elixir.html#cb387-3" tabindex="-1"></a></span>
<span id="cb387-4"><a href="functional-elixir.html#cb387-4" tabindex="-1"></a>  <span class="kw">def</span> handle_info<span class="fu">(</span><span class="op">...</span><span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb387-5"><a href="functional-elixir.html#cb387-5" tabindex="-1"></a>    <span class="op">...</span> <span class="co"># &lt;= place a buy order logic</span></span>
<span id="cb387-6"><a href="functional-elixir.html#cb387-6" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb387-7"><a href="functional-elixir.html#cb387-7" tabindex="-1"></a></span>
<span id="cb387-8"><a href="functional-elixir.html#cb387-8" tabindex="-1"></a>  <span class="kw">def</span> handle_info<span class="fu">(</span><span class="op">...</span><span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb387-9"><a href="functional-elixir.html#cb387-9" tabindex="-1"></a>    <span class="op">...</span> <span class="co"># &lt;= race condition fix logic</span></span>
<span id="cb387-10"><a href="functional-elixir.html#cb387-10" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb387-11"><a href="functional-elixir.html#cb387-11" tabindex="-1"></a></span>
<span id="cb387-12"><a href="functional-elixir.html#cb387-12" tabindex="-1"></a>  <span class="kw">def</span> handle_info<span class="fu">(</span><span class="op">...</span><span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb387-13"><a href="functional-elixir.html#cb387-13" tabindex="-1"></a>    <span class="op">...</span> <span class="co"># &lt;= place a sell order logic</span></span>
<span id="cb387-14"><a href="functional-elixir.html#cb387-14" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb387-15"><a href="functional-elixir.html#cb387-15" tabindex="-1"></a></span>
<span id="cb387-16"><a href="functional-elixir.html#cb387-16" tabindex="-1"></a>  <span class="kw">def</span> handle_info<span class="fu">(</span><span class="op">...</span><span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb387-17"><a href="functional-elixir.html#cb387-17" tabindex="-1"></a>    <span class="op">...</span> <span class="co"># &lt;= fetch the buy order logic</span></span>
<span id="cb387-18"><a href="functional-elixir.html#cb387-18" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb387-19"><a href="functional-elixir.html#cb387-19" tabindex="-1"></a></span>
<span id="cb387-20"><a href="functional-elixir.html#cb387-20" tabindex="-1"></a>  <span class="kw">def</span> handle_info<span class="fu">(</span><span class="op">...</span><span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb387-21"><a href="functional-elixir.html#cb387-21" tabindex="-1"></a>    <span class="op">...</span> <span class="co"># &lt;= terminate trader logic</span></span>
<span id="cb387-22"><a href="functional-elixir.html#cb387-22" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb387-23"><a href="functional-elixir.html#cb387-23" tabindex="-1"></a></span>
<span id="cb387-24"><a href="functional-elixir.html#cb387-24" tabindex="-1"></a>  <span class="kw">def</span> handle_info<span class="fu">(</span><span class="op">...</span><span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb387-25"><a href="functional-elixir.html#cb387-25" tabindex="-1"></a>    <span class="op">...</span> <span class="co"># &lt;= fetch the sell order logic</span></span>
<span id="cb387-26"><a href="functional-elixir.html#cb387-26" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb387-27"><a href="functional-elixir.html#cb387-27" tabindex="-1"></a></span>
<span id="cb387-28"><a href="functional-elixir.html#cb387-28" tabindex="-1"></a>  <span class="kw">def</span> handle_info<span class="fu">(</span><span class="op">...</span><span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb387-29"><a href="functional-elixir.html#cb387-29" tabindex="-1"></a>    <span class="op">...</span> <span class="co"># &lt;= trigger rebuy order logic</span></span>
<span id="cb387-30"><a href="functional-elixir.html#cb387-30" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb387-31"><a href="functional-elixir.html#cb387-31" tabindex="-1"></a></span>
<span id="cb387-32"><a href="functional-elixir.html#cb387-32" tabindex="-1"></a>  <span class="kw">def</span> handle_info<span class="fu">(</span><span class="op">...</span><span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb387-33"><a href="functional-elixir.html#cb387-33" tabindex="-1"></a>    <span class="op">...</span> <span class="co"># &lt;= ignore trade event logic</span></span>
<span id="cb387-34"><a href="functional-elixir.html#cb387-34" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>First, we will rename all of the <code>handle_info/2</code> functions inside the <code>Naive.Strategy</code> module to <code>generate_decision/2</code>. Next, we will go through them one by one, leaving the pure parts and limiting them to returning the decision.</p>
<div id="place-a-buy-order-rules" class="section level3 hasAnchor" number="18.4.1">
<h3><span class="header-section-number">18.4.1</span> Place a buy order rules<a href="functional-elixir.html#place-a-buy-order-rules" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The first function decides should the trader place a buy order. We can see that price and quantity calculations are pure functions based on the incoming data. We will remove everything below those two as it’s causing side effects.</p>
<p>As now we are dealing with a function generating a decision, we will return a tuple with data that, together with state, will be used to place a buy order.</p>
<p>After removing some of the pattern-matching that we used to retrieve data(no longer needed), our first function should look like this:</p>
<div class="sourceCode" id="cb388"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb388-1"><a href="functional-elixir.html#cb388-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/strategy.ex</span></span>
<span id="cb388-2"><a href="functional-elixir.html#cb388-2" tabindex="-1"></a><span class="co"># the first clause</span></span>
<span id="cb388-3"><a href="functional-elixir.html#cb388-3" tabindex="-1"></a>  <span class="kw">def</span> generate_decision<span class="fu">(</span></span>
<span id="cb388-4"><a href="functional-elixir.html#cb388-4" tabindex="-1"></a>        %<span class="cn">TradeEvent</span><span class="fu">{</span><span class="va">price:</span> price<span class="fu">}</span>,</span>
<span id="cb388-5"><a href="functional-elixir.html#cb388-5" tabindex="-1"></a>        %<span class="cn">State</span><span class="fu">{</span></span>
<span id="cb388-6"><a href="functional-elixir.html#cb388-6" tabindex="-1"></a>          <span class="va">budget:</span> budget,</span>
<span id="cb388-7"><a href="functional-elixir.html#cb388-7" tabindex="-1"></a>          <span class="va">buy_order:</span> <span class="cn">nil</span>,</span>
<span id="cb388-8"><a href="functional-elixir.html#cb388-8" tabindex="-1"></a>          <span class="va">buy_down_interval:</span> buy_down_interval,</span>
<span id="cb388-9"><a href="functional-elixir.html#cb388-9" tabindex="-1"></a>          <span class="va">tick_size:</span> tick_size,</span>
<span id="cb388-10"><a href="functional-elixir.html#cb388-10" tabindex="-1"></a>          <span class="va">step_size:</span> step_size</span>
<span id="cb388-11"><a href="functional-elixir.html#cb388-11" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb388-12"><a href="functional-elixir.html#cb388-12" tabindex="-1"></a>      <span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb388-13"><a href="functional-elixir.html#cb388-13" tabindex="-1"></a>    price <span class="op">=</span> calculate_buy_price<span class="fu">(</span>price, buy_down_interval, tick_size<span class="fu">)</span></span>
<span id="cb388-14"><a href="functional-elixir.html#cb388-14" tabindex="-1"></a></span>
<span id="cb388-15"><a href="functional-elixir.html#cb388-15" tabindex="-1"></a>    quantity <span class="op">=</span> calculate_quantity<span class="fu">(</span>budget, price, step_size<span class="fu">)</span></span>
<span id="cb388-16"><a href="functional-elixir.html#cb388-16" tabindex="-1"></a></span>
<span id="cb388-17"><a href="functional-elixir.html#cb388-17" tabindex="-1"></a>    <span class="fu">{</span><span class="va">:place_buy_order</span>, price, quantity<span class="fu">}</span></span>
<span id="cb388-18"><a href="functional-elixir.html#cb388-18" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<div style="page-break-after: always;"></div>
</div>
<div id="race-condition-rules" class="section level3 hasAnchor" number="18.4.2">
<h3><span class="header-section-number">18.4.2</span> Race condition rules<a href="functional-elixir.html#race-condition-rules" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The second function deals with the race condition when multiple transactions fill the buy order. The original callback ignores those trade events, so the <code>generate_decision/2</code> function should return the same “decision”:</p>
<div class="sourceCode" id="cb389"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb389-1"><a href="functional-elixir.html#cb389-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/strategy.ex</span></span>
<span id="cb389-2"><a href="functional-elixir.html#cb389-2" tabindex="-1"></a><span class="co"># the second clause</span></span>
<span id="cb389-3"><a href="functional-elixir.html#cb389-3" tabindex="-1"></a>  <span class="kw">def</span> generate_decision<span class="fu">(</span></span>
<span id="cb389-4"><a href="functional-elixir.html#cb389-4" tabindex="-1"></a>        %<span class="cn">TradeEvent</span><span class="fu">{</span></span>
<span id="cb389-5"><a href="functional-elixir.html#cb389-5" tabindex="-1"></a>          <span class="va">buyer_order_id:</span> order_id</span>
<span id="cb389-6"><a href="functional-elixir.html#cb389-6" tabindex="-1"></a>        <span class="fu">}</span>,</span>
<span id="cb389-7"><a href="functional-elixir.html#cb389-7" tabindex="-1"></a>        %<span class="cn">State</span><span class="fu">{</span></span>
<span id="cb389-8"><a href="functional-elixir.html#cb389-8" tabindex="-1"></a>          <span class="va">buy_order:</span> %<span class="cn">Binance</span><span class="op">.</span><span class="cn">OrderResponse</span><span class="fu">{</span></span>
<span id="cb389-9"><a href="functional-elixir.html#cb389-9" tabindex="-1"></a>            <span class="va">order_id:</span> order_id,</span>
<span id="cb389-10"><a href="functional-elixir.html#cb389-10" tabindex="-1"></a>            <span class="va">status:</span> <span class="st">&quot;FILLED&quot;</span></span>
<span id="cb389-11"><a href="functional-elixir.html#cb389-11" tabindex="-1"></a>          <span class="fu">}</span>,</span>
<span id="cb389-12"><a href="functional-elixir.html#cb389-12" tabindex="-1"></a>          <span class="va">sell_order:</span> %<span class="cn">Binance</span><span class="op">.</span><span class="cn">OrderResponse</span><span class="fu">{}</span></span>
<span id="cb389-13"><a href="functional-elixir.html#cb389-13" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb389-14"><a href="functional-elixir.html#cb389-14" tabindex="-1"></a>      <span class="fu">)</span></span>
<span id="cb389-15"><a href="functional-elixir.html#cb389-15" tabindex="-1"></a>      <span class="kw">when</span> is_number<span class="fu">(</span>order_id<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb389-16"><a href="functional-elixir.html#cb389-16" tabindex="-1"></a>    <span class="va">:skip</span></span>
<span id="cb389-17"><a href="functional-elixir.html#cb389-17" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
</div>
<div id="fetch-the-buy-order-rules" class="section level3 hasAnchor" number="18.4.3">
<h3><span class="header-section-number">18.4.3</span> Fetch the buy order rules<a href="functional-elixir.html#fetch-the-buy-order-rules" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>For the 3th clause, we will return only an atom as there’s no pure logic besides the pattern-match in the header itself:</p>
<div class="sourceCode" id="cb390"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb390-1"><a href="functional-elixir.html#cb390-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/strategy.ex</span></span>
<span id="cb390-2"><a href="functional-elixir.html#cb390-2" tabindex="-1"></a><span class="co"># the third clause</span></span>
<span id="cb390-3"><a href="functional-elixir.html#cb390-3" tabindex="-1"></a>  <span class="kw">def</span> generate_decision<span class="fu">(</span></span>
<span id="cb390-4"><a href="functional-elixir.html#cb390-4" tabindex="-1"></a>        %<span class="cn">TradeEvent</span><span class="fu">{</span></span>
<span id="cb390-5"><a href="functional-elixir.html#cb390-5" tabindex="-1"></a>          <span class="va">buyer_order_id:</span> order_id</span>
<span id="cb390-6"><a href="functional-elixir.html#cb390-6" tabindex="-1"></a>        <span class="fu">}</span>,</span>
<span id="cb390-7"><a href="functional-elixir.html#cb390-7" tabindex="-1"></a>        %<span class="cn">State</span><span class="fu">{</span></span>
<span id="cb390-8"><a href="functional-elixir.html#cb390-8" tabindex="-1"></a>          <span class="va">buy_order:</span> %<span class="cn">Binance</span><span class="op">.</span><span class="cn">OrderResponse</span><span class="fu">{</span></span>
<span id="cb390-9"><a href="functional-elixir.html#cb390-9" tabindex="-1"></a>            <span class="va">order_id:</span> order_id</span>
<span id="cb390-10"><a href="functional-elixir.html#cb390-10" tabindex="-1"></a>          <span class="fu">}</span>,</span>
<span id="cb390-11"><a href="functional-elixir.html#cb390-11" tabindex="-1"></a>          <span class="va">sell_order:</span> <span class="cn">nil</span></span>
<span id="cb390-12"><a href="functional-elixir.html#cb390-12" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb390-13"><a href="functional-elixir.html#cb390-13" tabindex="-1"></a>      <span class="fu">)</span></span>
<span id="cb390-14"><a href="functional-elixir.html#cb390-14" tabindex="-1"></a>      <span class="kw">when</span> is_number<span class="fu">(</span>order_id<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb390-15"><a href="functional-elixir.html#cb390-15" tabindex="-1"></a>    <span class="va">:fetch_buy_order</span></span>
<span id="cb390-16"><a href="functional-elixir.html#cb390-16" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
</div>
<div id="place-a-sell-order-rules" class="section level3 hasAnchor" number="18.4.4">
<h3><span class="header-section-number">18.4.4</span> Place a sell order rules<a href="functional-elixir.html#place-a-sell-order-rules" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We will follow the same logic for the 4th clause of the <code>generate_decision/2</code> function. We will leave only the sell price calculation as it’s pure and return a tuple together with the decision:</p>
<div class="sourceCode" id="cb391"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb391-1"><a href="functional-elixir.html#cb391-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/strategy.ex</span></span>
<span id="cb391-2"><a href="functional-elixir.html#cb391-2" tabindex="-1"></a><span class="co"># the fourth clause</span></span>
<span id="cb391-3"><a href="functional-elixir.html#cb391-3" tabindex="-1"></a>  <span class="kw">def</span> generate_decision<span class="fu">(</span></span>
<span id="cb391-4"><a href="functional-elixir.html#cb391-4" tabindex="-1"></a>        %<span class="cn">TradeEvent</span><span class="fu">{}</span>,</span>
<span id="cb391-5"><a href="functional-elixir.html#cb391-5" tabindex="-1"></a>        %<span class="cn">State</span><span class="fu">{</span></span>
<span id="cb391-6"><a href="functional-elixir.html#cb391-6" tabindex="-1"></a>          <span class="va">buy_order:</span> %<span class="cn">Binance</span><span class="op">.</span><span class="cn">OrderResponse</span><span class="fu">{</span></span>
<span id="cb391-7"><a href="functional-elixir.html#cb391-7" tabindex="-1"></a>            <span class="va">status:</span> <span class="st">&quot;FILLED&quot;</span>,</span>
<span id="cb391-8"><a href="functional-elixir.html#cb391-8" tabindex="-1"></a>            <span class="va">price:</span> buy_price</span>
<span id="cb391-9"><a href="functional-elixir.html#cb391-9" tabindex="-1"></a>          <span class="fu">}</span>,</span>
<span id="cb391-10"><a href="functional-elixir.html#cb391-10" tabindex="-1"></a>          <span class="va">sell_order:</span> <span class="cn">nil</span>,</span>
<span id="cb391-11"><a href="functional-elixir.html#cb391-11" tabindex="-1"></a>          <span class="va">profit_interval:</span> profit_interval,</span>
<span id="cb391-12"><a href="functional-elixir.html#cb391-12" tabindex="-1"></a>          <span class="va">tick_size:</span> tick_size</span>
<span id="cb391-13"><a href="functional-elixir.html#cb391-13" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb391-14"><a href="functional-elixir.html#cb391-14" tabindex="-1"></a>      <span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb391-15"><a href="functional-elixir.html#cb391-15" tabindex="-1"></a>    sell_price <span class="op">=</span> calculate_sell_price<span class="fu">(</span>buy_price, profit_interval, tick_size<span class="fu">)</span></span>
<span id="cb391-16"><a href="functional-elixir.html#cb391-16" tabindex="-1"></a>    <span class="fu">{</span><span class="va">:place_sell_order</span>, sell_price<span class="fu">}</span></span>
<span id="cb391-17"><a href="functional-elixir.html#cb391-17" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
</div>
<div id="terminate-trader-rules" class="section level3 hasAnchor" number="18.4.5">
<h3><span class="header-section-number">18.4.5</span> Terminate trader rules<a href="functional-elixir.html#terminate-trader-rules" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>For the 5th clause, we will indicate that trader needs to terminate:</p>
<div class="sourceCode" id="cb392"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb392-1"><a href="functional-elixir.html#cb392-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/strategy.ex</span></span>
<span id="cb392-2"><a href="functional-elixir.html#cb392-2" tabindex="-1"></a><span class="co"># the fifth clause</span></span>
<span id="cb392-3"><a href="functional-elixir.html#cb392-3" tabindex="-1"></a>  <span class="kw">def</span> generate_decision<span class="fu">(</span></span>
<span id="cb392-4"><a href="functional-elixir.html#cb392-4" tabindex="-1"></a>        %<span class="cn">TradeEvent</span><span class="fu">{}</span>,</span>
<span id="cb392-5"><a href="functional-elixir.html#cb392-5" tabindex="-1"></a>        %<span class="cn">State</span><span class="fu">{</span></span>
<span id="cb392-6"><a href="functional-elixir.html#cb392-6" tabindex="-1"></a>          <span class="va">sell_order:</span> %<span class="cn">Binance</span><span class="op">.</span><span class="cn">OrderResponse</span><span class="fu">{</span></span>
<span id="cb392-7"><a href="functional-elixir.html#cb392-7" tabindex="-1"></a>            <span class="va">status:</span> <span class="st">&quot;FILLED&quot;</span></span>
<span id="cb392-8"><a href="functional-elixir.html#cb392-8" tabindex="-1"></a>          <span class="fu">}</span></span>
<span id="cb392-9"><a href="functional-elixir.html#cb392-9" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb392-10"><a href="functional-elixir.html#cb392-10" tabindex="-1"></a>      <span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb392-11"><a href="functional-elixir.html#cb392-11" tabindex="-1"></a>    <span class="va">:exit</span></span>
<span id="cb392-12"><a href="functional-elixir.html#cb392-12" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
</div>
<div id="fetch-the-sell-order-rules" class="section level3 hasAnchor" number="18.4.6">
<h3><span class="header-section-number">18.4.6</span> Fetch the sell order rules<a href="functional-elixir.html#fetch-the-sell-order-rules" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>For the 6th clause, we will indicate that trader needs to fetch the sell order:</p>
<div class="sourceCode" id="cb393"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb393-1"><a href="functional-elixir.html#cb393-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/strategy.ex</span></span>
<span id="cb393-2"><a href="functional-elixir.html#cb393-2" tabindex="-1"></a><span class="co"># the sixth clause</span></span>
<span id="cb393-3"><a href="functional-elixir.html#cb393-3" tabindex="-1"></a>  <span class="kw">def</span> generate_decision<span class="fu">(</span></span>
<span id="cb393-4"><a href="functional-elixir.html#cb393-4" tabindex="-1"></a>        %<span class="cn">TradeEvent</span><span class="fu">{</span></span>
<span id="cb393-5"><a href="functional-elixir.html#cb393-5" tabindex="-1"></a>          <span class="va">seller_order_id:</span> order_id</span>
<span id="cb393-6"><a href="functional-elixir.html#cb393-6" tabindex="-1"></a>        <span class="fu">}</span>,</span>
<span id="cb393-7"><a href="functional-elixir.html#cb393-7" tabindex="-1"></a>        %<span class="cn">State</span><span class="fu">{</span></span>
<span id="cb393-8"><a href="functional-elixir.html#cb393-8" tabindex="-1"></a>          <span class="va">sell_order:</span> %<span class="cn">Binance</span><span class="op">.</span><span class="cn">OrderResponse</span><span class="fu">{</span></span>
<span id="cb393-9"><a href="functional-elixir.html#cb393-9" tabindex="-1"></a>            <span class="va">order_id:</span> order_id</span>
<span id="cb393-10"><a href="functional-elixir.html#cb393-10" tabindex="-1"></a>          <span class="fu">}</span></span>
<span id="cb393-11"><a href="functional-elixir.html#cb393-11" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb393-12"><a href="functional-elixir.html#cb393-12" tabindex="-1"></a>      <span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb393-13"><a href="functional-elixir.html#cb393-13" tabindex="-1"></a>    <span class="va">:fetch_sell_order</span></span>
<span id="cb393-14"><a href="functional-elixir.html#cb393-14" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
</div>
<div id="trigger-rebuy-rules" class="section level3 hasAnchor" number="18.4.7">
<h3><span class="header-section-number">18.4.7</span> Trigger rebuy rules<a href="functional-elixir.html#trigger-rebuy-rules" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Inside the 7th clause, we are dealing with triggering the rebuy. Here, we can decide whether rebuy should be triggered and get rid of conditional logic inside further steps. We couldn’t refactor this function by splitting it (as we’ve done in the first section) as we need to call the <code>trigger_rebuy?/3</code> function to check should rebuy be triggered. The functions that we refactored in the first section of this chapter were splittable as they relied on pattern-matching in the function headers where calling local functions is not allowed):</p>
<div class="sourceCode" id="cb394"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb394-1"><a href="functional-elixir.html#cb394-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/strategy.ex</span></span>
<span id="cb394-2"><a href="functional-elixir.html#cb394-2" tabindex="-1"></a><span class="co"># the seventh clause</span></span>
<span id="cb394-3"><a href="functional-elixir.html#cb394-3" tabindex="-1"></a>  <span class="kw">def</span> generate_decision<span class="fu">(</span></span>
<span id="cb394-4"><a href="functional-elixir.html#cb394-4" tabindex="-1"></a>        %<span class="cn">TradeEvent</span><span class="fu">{</span></span>
<span id="cb394-5"><a href="functional-elixir.html#cb394-5" tabindex="-1"></a>          <span class="va">price:</span> current_price</span>
<span id="cb394-6"><a href="functional-elixir.html#cb394-6" tabindex="-1"></a>        <span class="fu">}</span>,</span>
<span id="cb394-7"><a href="functional-elixir.html#cb394-7" tabindex="-1"></a>        %<span class="cn">State</span><span class="fu">{</span></span>
<span id="cb394-8"><a href="functional-elixir.html#cb394-8" tabindex="-1"></a>          <span class="va">buy_order:</span> %<span class="cn">Binance</span><span class="op">.</span><span class="cn">OrderResponse</span><span class="fu">{</span></span>
<span id="cb394-9"><a href="functional-elixir.html#cb394-9" tabindex="-1"></a>            <span class="va">price:</span> buy_price</span>
<span id="cb394-10"><a href="functional-elixir.html#cb394-10" tabindex="-1"></a>          <span class="fu">}</span>,</span>
<span id="cb394-11"><a href="functional-elixir.html#cb394-11" tabindex="-1"></a>          <span class="va">rebuy_interval:</span> rebuy_interval,</span>
<span id="cb394-12"><a href="functional-elixir.html#cb394-12" tabindex="-1"></a>          <span class="va">rebuy_notified:</span> <span class="cn">false</span></span>
<span id="cb394-13"><a href="functional-elixir.html#cb394-13" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb394-14"><a href="functional-elixir.html#cb394-14" tabindex="-1"></a>      <span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb394-15"><a href="functional-elixir.html#cb394-15" tabindex="-1"></a>    <span class="cf">if</span> trigger_rebuy?<span class="fu">(</span>buy_price, current_price, rebuy_interval<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb394-16"><a href="functional-elixir.html#cb394-16" tabindex="-1"></a>      <span class="va">:rebuy</span></span>
<span id="cb394-17"><a href="functional-elixir.html#cb394-17" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb394-18"><a href="functional-elixir.html#cb394-18" tabindex="-1"></a>      <span class="va">:skip</span></span>
<span id="cb394-19"><a href="functional-elixir.html#cb394-19" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb394-20"><a href="functional-elixir.html#cb394-20" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<div style="page-break-after: always;"></div>
</div>
<div id="the-final-clause-rules" class="section level3 hasAnchor" number="18.4.8">
<h3><span class="header-section-number">18.4.8</span> The final clause rules<a href="functional-elixir.html#the-final-clause-rules" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The final (8th) clause will just ignore the trade event as it’s of no interest:</p>
<div class="sourceCode" id="cb395"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb395-1"><a href="functional-elixir.html#cb395-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/strategy.ex</span></span>
<span id="cb395-2"><a href="functional-elixir.html#cb395-2" tabindex="-1"></a><span class="co"># the final(8th) clause</span></span>
<span id="cb395-3"><a href="functional-elixir.html#cb395-3" tabindex="-1"></a>  <span class="kw">def</span> generate_decision<span class="fu">(</span>%<span class="cn">TradeEvent</span><span class="fu">{}</span>, %<span class="cn">State</span><span class="fu">{})</span> <span class="kw">do</span></span>
<span id="cb395-4"><a href="functional-elixir.html#cb395-4" tabindex="-1"></a>    <span class="va">:skip</span></span>
<span id="cb395-5"><a href="functional-elixir.html#cb395-5" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>This finishes the changes to the <code>generate_decision/2</code> clauses. We extracted a fair amount of logic into an easily testable pure function. We now need to use it inside the <code>Naive.Trader</code> module.</p>
</div>
<div id="changes-to-the-naive.trader-module" class="section level3 hasAnchor" number="18.4.9">
<h3><span class="header-section-number">18.4.9</span> Changes to the <code>Naive.Trader</code> module<a href="functional-elixir.html#changes-to-the-naive.trader-module" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We will start by moving all of the calculation functions to the <code>Naive.Strategy</code> module as we are using them from the <code>generate_decision/2</code> function. Those will be:</p>
<ul>
<li><code>calculate_sell_price/3</code></li>
<li><code>calculate_buy_price/3</code></li>
<li><code>calculate_quantity/3</code></li>
<li><code>trigger_rebuy?/3</code></li>
</ul>
<p>They can now be changed to public functions as they are pure and fit the “interface” of the <code>Naive.Strategy</code> module(it feels ok[and it’s safe as they are pure] to “expose” them to be called from other modules).</p>
<p>We need to remember about moving the <code>Decimal</code> alias into the <code>Naive.Strategy</code> module together with a copy of the <code>TradeEvent</code> struct alias and add the alias for the <code>Naive.Trader.State</code> struct:</p>
<div class="sourceCode" id="cb396"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb396-1"><a href="functional-elixir.html#cb396-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/strategy.ex</span></span>
<span id="cb396-2"><a href="functional-elixir.html#cb396-2" tabindex="-1"></a>  <span class="im">alias</span> <span class="cn">Decimal</span>, <span class="va">as:</span> D</span>
<span id="cb396-3"><a href="functional-elixir.html#cb396-3" tabindex="-1"></a>  <span class="im">alias</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">Struct</span><span class="op">.</span><span class="cn">TradeEvent</span></span>
<span id="cb396-4"><a href="functional-elixir.html#cb396-4" tabindex="-1"></a>  <span class="im">alias</span> <span class="cn">Naive</span><span class="op">.</span><span class="cn">Trader</span><span class="op">.</span><span class="cn">State</span></span></code></pre></div>
<p>The next step will be to rename all the <code>handle_info/2</code> callback functions inside the <code>Naive.Trader</code> module to <code>execute_decision/2</code>, which we will get back to in a moment.</p>
<p>First, we need to add a single <code>handle_info/2</code> callback under the <code>init/1</code> function that will pattern match only the fact that the received message contains the <code>TradeEvent</code> struct and the state is the correct <code>State</code> struct:</p>
<div class="sourceCode" id="cb397"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb397-1"><a href="functional-elixir.html#cb397-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/trader.ex</span></span>
<span id="cb397-2"><a href="functional-elixir.html#cb397-2" tabindex="-1"></a><span class="co"># add after the `init/1` function</span></span>
<span id="cb397-3"><a href="functional-elixir.html#cb397-3" tabindex="-1"></a>  <span class="kw">def</span> handle_info<span class="fu">(</span>%<span class="cn">TradeEvent</span><span class="fu">{}</span> <span class="op">=</span> trade_event, %<span class="cn">State</span><span class="fu">{}</span> <span class="op">=</span> state<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb397-4"><a href="functional-elixir.html#cb397-4" tabindex="-1"></a>    <span class="cn">Naive</span><span class="op">.</span><span class="cn">Strategy</span><span class="op">.</span>generate_decision<span class="fu">(</span>trade_event, state<span class="fu">)</span></span>
<span id="cb397-5"><a href="functional-elixir.html#cb397-5" tabindex="-1"></a>    <span class="op">|&gt;</span> execute_decision<span class="fu">(</span>state<span class="fu">)</span></span>
<span id="cb397-6"><a href="functional-elixir.html#cb397-6" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>So, the <code>Naive.Strategy</code> module will decide what the trader server should do based on its pure business logic. That decision will be passed forward with the state to the <code>execute_decision/2</code> function (at this moment, it’s just the old <code>handle_info/2</code> function renamed, but we will update it next).</p>
</div>
<div id="naive.trader---place-buy-order" class="section level3 hasAnchor" number="18.4.10">
<h3><span class="header-section-number">18.4.10</span> <code>Naive.Trader</code> - place buy order<a href="functional-elixir.html#naive.trader---place-buy-order" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We will update the <code>execute_decision/2</code> function to take a decision + state and execute the correct action based on pattern-match of the decision. Starting with the 1st clause, we need to pattern match a tuple:</p>
<div class="sourceCode" id="cb398"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb398-1"><a href="functional-elixir.html#cb398-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/trader.ex</span></span>
<span id="cb398-2"><a href="functional-elixir.html#cb398-2" tabindex="-1"></a><span class="co"># the first execute clause</span></span>
<span id="cb398-3"><a href="functional-elixir.html#cb398-3" tabindex="-1"></a>  <span class="kw">def</span> execute_decision<span class="fu">(</span></span>
<span id="cb398-4"><a href="functional-elixir.html#cb398-4" tabindex="-1"></a>         <span class="fu">{</span><span class="va">:place_buy_order</span>, price, quantity<span class="fu">}</span>,</span>
<span id="cb398-5"><a href="functional-elixir.html#cb398-5" tabindex="-1"></a>         %<span class="cn">State</span><span class="fu">{</span></span>
<span id="cb398-6"><a href="functional-elixir.html#cb398-6" tabindex="-1"></a>           <span class="va">id:</span> id,</span>
<span id="cb398-7"><a href="functional-elixir.html#cb398-7" tabindex="-1"></a>           <span class="va">symbol:</span> symbol</span>
<span id="cb398-8"><a href="functional-elixir.html#cb398-8" tabindex="-1"></a>         <span class="fu">}</span> <span class="op">=</span> state</span>
<span id="cb398-9"><a href="functional-elixir.html#cb398-9" tabindex="-1"></a>       <span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb398-10"><a href="functional-elixir.html#cb398-10" tabindex="-1"></a>    <span class="ot">@logger</span><span class="op">.</span>info<span class="fu">(</span></span>
<span id="cb398-11"><a href="functional-elixir.html#cb398-11" tabindex="-1"></a>      <span class="st">&quot;The trader(</span><span class="ot">#{</span>id<span class="ot">}</span><span class="st">) is placing a BUY order &quot;</span> <span class="op">&lt;&gt;</span></span>
<span id="cb398-12"><a href="functional-elixir.html#cb398-12" tabindex="-1"></a>        <span class="st">&quot;for </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st"> @ </span><span class="ot">#{</span>price<span class="ot">}</span><span class="st">, quantity: </span><span class="ot">#{</span>quantity<span class="ot">}</span><span class="st">&quot;</span></span>
<span id="cb398-13"><a href="functional-elixir.html#cb398-13" tabindex="-1"></a>    <span class="fu">)</span></span>
<span id="cb398-14"><a href="functional-elixir.html#cb398-14" tabindex="-1"></a></span>
<span id="cb398-15"><a href="functional-elixir.html#cb398-15" tabindex="-1"></a>    <span class="fu">{</span><span class="va">:ok</span>, %<span class="cn">Binance</span><span class="op">.</span><span class="cn">OrderResponse</span><span class="fu">{}</span> <span class="op">=</span> order<span class="fu">}</span> <span class="op">=</span></span>
<span id="cb398-16"><a href="functional-elixir.html#cb398-16" tabindex="-1"></a>      <span class="ot">@binance_client</span><span class="op">.</span>order_limit_buy<span class="fu">(</span>symbol, quantity, price, <span class="st">&quot;GTC&quot;</span><span class="fu">)</span></span>
<span id="cb398-17"><a href="functional-elixir.html#cb398-17" tabindex="-1"></a></span>
<span id="cb398-18"><a href="functional-elixir.html#cb398-18" tabindex="-1"></a>    <span class="va">:ok</span> <span class="op">=</span> broadcast_order<span class="fu">(</span>order<span class="fu">)</span></span>
<span id="cb398-19"><a href="functional-elixir.html#cb398-19" tabindex="-1"></a></span>
<span id="cb398-20"><a href="functional-elixir.html#cb398-20" tabindex="-1"></a>    new_state <span class="op">=</span> %<span class="fu">{</span>state <span class="op">|</span> <span class="va">buy_order:</span> order<span class="fu">}</span></span>
<span id="cb398-21"><a href="functional-elixir.html#cb398-21" tabindex="-1"></a>    <span class="ot">@leader</span><span class="op">.</span>notify<span class="fu">(</span><span class="va">:trader_state_updated</span>, new_state<span class="fu">)</span></span>
<span id="cb398-22"><a href="functional-elixir.html#cb398-22" tabindex="-1"></a>    <span class="fu">{</span><span class="va">:noreply</span>, new_state<span class="fu">}</span></span>
<span id="cb398-23"><a href="functional-elixir.html#cb398-23" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>The amount of pattern matching will be much smaller as part of the original callback has been moved inside the <code>Naive.Strategy</code>’s logic(to calculate the price and quantity).</p>
</div>
<div id="naive.trader---race-condition-clause" class="section level3 hasAnchor" number="18.4.11">
<h3><span class="header-section-number">18.4.11</span> <code>Naive.Trader</code> - Race condition clause<a href="functional-elixir.html#naive.trader---race-condition-clause" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As we are using the <code>:skip</code> “decision” for both the race condition events and the “non interesting” events, we can safely remove this clause as we will implement skipping as the last clause.</p>
</div>
<div id="naive.trader---place-a-sell-order" class="section level3 hasAnchor" number="18.4.12">
<h3><span class="header-section-number">18.4.12</span> <code>Naive.Trader</code> - Place a sell order<a href="functional-elixir.html#naive.trader---place-a-sell-order" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In case of placing a sell order, we will pattern match on a tuple containing the <code>:place_sell_order</code> atom and slim down on pattern matching:</p>
<div class="sourceCode" id="cb399"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb399-1"><a href="functional-elixir.html#cb399-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/trader.ex</span></span>
<span id="cb399-2"><a href="functional-elixir.html#cb399-2" tabindex="-1"></a>  <span class="kw">def</span> execute_decision<span class="fu">(</span></span>
<span id="cb399-3"><a href="functional-elixir.html#cb399-3" tabindex="-1"></a>         <span class="fu">{</span><span class="va">:place_sell_order</span>, sell_price<span class="fu">}</span>,</span>
<span id="cb399-4"><a href="functional-elixir.html#cb399-4" tabindex="-1"></a>         %<span class="cn">State</span><span class="fu">{</span></span>
<span id="cb399-5"><a href="functional-elixir.html#cb399-5" tabindex="-1"></a>           <span class="va">id:</span> id,</span>
<span id="cb399-6"><a href="functional-elixir.html#cb399-6" tabindex="-1"></a>           <span class="va">symbol:</span> symbol,</span>
<span id="cb399-7"><a href="functional-elixir.html#cb399-7" tabindex="-1"></a>           <span class="va">buy_order:</span> %<span class="cn">Binance</span><span class="op">.</span><span class="cn">OrderResponse</span><span class="fu">{</span></span>
<span id="cb399-8"><a href="functional-elixir.html#cb399-8" tabindex="-1"></a>             <span class="va">orig_qty:</span> quantity</span>
<span id="cb399-9"><a href="functional-elixir.html#cb399-9" tabindex="-1"></a>           <span class="fu">}</span></span>
<span id="cb399-10"><a href="functional-elixir.html#cb399-10" tabindex="-1"></a>         <span class="fu">}</span> <span class="op">=</span> state</span>
<span id="cb399-11"><a href="functional-elixir.html#cb399-11" tabindex="-1"></a>       <span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb399-12"><a href="functional-elixir.html#cb399-12" tabindex="-1"></a>    <span class="ot">@logger</span><span class="op">.</span>info<span class="fu">(</span></span>
<span id="cb399-13"><a href="functional-elixir.html#cb399-13" tabindex="-1"></a>      <span class="st">&quot;The trader(</span><span class="ot">#{</span>id<span class="ot">}</span><span class="st">) is placing a SELL order for &quot;</span> <span class="op">&lt;&gt;</span></span>
<span id="cb399-14"><a href="functional-elixir.html#cb399-14" tabindex="-1"></a>        <span class="st">&quot;</span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st"> @ </span><span class="ot">#{</span>sell_price<span class="ot">}</span><span class="st">, quantity: </span><span class="ot">#{</span>quantity<span class="ot">}</span><span class="st">.&quot;</span></span>
<span id="cb399-15"><a href="functional-elixir.html#cb399-15" tabindex="-1"></a>    <span class="fu">)</span></span>
<span id="cb399-16"><a href="functional-elixir.html#cb399-16" tabindex="-1"></a></span>
<span id="cb399-17"><a href="functional-elixir.html#cb399-17" tabindex="-1"></a>    <span class="fu">{</span><span class="va">:ok</span>, %<span class="cn">Binance</span><span class="op">.</span><span class="cn">OrderResponse</span><span class="fu">{}</span> <span class="op">=</span> order<span class="fu">}</span> <span class="op">=</span></span>
<span id="cb399-18"><a href="functional-elixir.html#cb399-18" tabindex="-1"></a>      <span class="ot">@binance_client</span><span class="op">.</span>order_limit_sell<span class="fu">(</span>symbol, quantity, sell_price, <span class="st">&quot;GTC&quot;</span><span class="fu">)</span></span>
<span id="cb399-19"><a href="functional-elixir.html#cb399-19" tabindex="-1"></a></span>
<span id="cb399-20"><a href="functional-elixir.html#cb399-20" tabindex="-1"></a>    <span class="va">:ok</span> <span class="op">=</span> broadcast_order<span class="fu">(</span>order<span class="fu">)</span></span>
<span id="cb399-21"><a href="functional-elixir.html#cb399-21" tabindex="-1"></a></span>
<span id="cb399-22"><a href="functional-elixir.html#cb399-22" tabindex="-1"></a>    new_state <span class="op">=</span> %<span class="fu">{</span>state <span class="op">|</span> <span class="va">sell_order:</span> order<span class="fu">}</span></span>
<span id="cb399-23"><a href="functional-elixir.html#cb399-23" tabindex="-1"></a>    <span class="ot">@leader</span><span class="op">.</span>notify<span class="fu">(</span><span class="va">:trader_state_updated</span>, new_state<span class="fu">)</span></span>
<span id="cb399-24"><a href="functional-elixir.html#cb399-24" tabindex="-1"></a>    <span class="fu">{</span><span class="va">:noreply</span>, new_state<span class="fu">}</span></span>
<span id="cb399-25"><a href="functional-elixir.html#cb399-25" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
</div>
<div id="naive.trader---fetch-the-buy-order" class="section level3 hasAnchor" number="18.4.13">
<h3><span class="header-section-number">18.4.13</span> <code>Naive.Trader</code> - Fetch the buy order<a href="functional-elixir.html#naive.trader---fetch-the-buy-order" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In case of fetching the buy order, we will pattern match on a <code>:fetch_buy_order</code> atom and slim down on pattern matching:</p>
<div class="sourceCode" id="cb400"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb400-1"><a href="functional-elixir.html#cb400-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/trader.ex</span></span>
<span id="cb400-2"><a href="functional-elixir.html#cb400-2" tabindex="-1"></a>  <span class="kw">def</span> execute_decision<span class="fu">(</span></span>
<span id="cb400-3"><a href="functional-elixir.html#cb400-3" tabindex="-1"></a>         <span class="va">:fetch_buy_order</span>,</span>
<span id="cb400-4"><a href="functional-elixir.html#cb400-4" tabindex="-1"></a>         %<span class="cn">State</span><span class="fu">{</span></span>
<span id="cb400-5"><a href="functional-elixir.html#cb400-5" tabindex="-1"></a>           <span class="va">id:</span> id,</span>
<span id="cb400-6"><a href="functional-elixir.html#cb400-6" tabindex="-1"></a>           <span class="va">symbol:</span> symbol,</span>
<span id="cb400-7"><a href="functional-elixir.html#cb400-7" tabindex="-1"></a>           <span class="va">buy_order:</span></span>
<span id="cb400-8"><a href="functional-elixir.html#cb400-8" tabindex="-1"></a>             %<span class="cn">Binance</span><span class="op">.</span><span class="cn">OrderResponse</span><span class="fu">{</span></span>
<span id="cb400-9"><a href="functional-elixir.html#cb400-9" tabindex="-1"></a>               <span class="va">order_id:</span> order_id,</span>
<span id="cb400-10"><a href="functional-elixir.html#cb400-10" tabindex="-1"></a>               <span class="va">transact_time:</span> timestamp</span>
<span id="cb400-11"><a href="functional-elixir.html#cb400-11" tabindex="-1"></a>             <span class="fu">}</span> <span class="op">=</span> buy_order</span>
<span id="cb400-12"><a href="functional-elixir.html#cb400-12" tabindex="-1"></a>         <span class="fu">}</span> <span class="op">=</span> state</span>
<span id="cb400-13"><a href="functional-elixir.html#cb400-13" tabindex="-1"></a>       <span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb400-14"><a href="functional-elixir.html#cb400-14" tabindex="-1"></a>    <span class="ot">@logger</span><span class="op">.</span>info<span class="fu">(</span><span class="st">&quot;Trader&#39;s(</span><span class="ot">#{</span>id<span class="ot">}</span><span class="st"> </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st"> buy order got partially filled&quot;</span><span class="fu">)</span></span>
<span id="cb400-15"><a href="functional-elixir.html#cb400-15" tabindex="-1"></a></span>
<span id="cb400-16"><a href="functional-elixir.html#cb400-16" tabindex="-1"></a>    <span class="fu">{</span><span class="va">:ok</span>, %<span class="cn">Binance</span><span class="op">.</span><span class="cn">Order</span><span class="fu">{}</span> <span class="op">=</span> current_buy_order<span class="fu">}</span> <span class="op">=</span></span>
<span id="cb400-17"><a href="functional-elixir.html#cb400-17" tabindex="-1"></a>      <span class="ot">@binance_client</span><span class="op">.</span>get_order<span class="fu">(</span></span>
<span id="cb400-18"><a href="functional-elixir.html#cb400-18" tabindex="-1"></a>        symbol,</span>
<span id="cb400-19"><a href="functional-elixir.html#cb400-19" tabindex="-1"></a>        timestamp,</span>
<span id="cb400-20"><a href="functional-elixir.html#cb400-20" tabindex="-1"></a>        order_id</span>
<span id="cb400-21"><a href="functional-elixir.html#cb400-21" tabindex="-1"></a>      <span class="fu">)</span></span>
<span id="cb400-22"><a href="functional-elixir.html#cb400-22" tabindex="-1"></a></span>
<span id="cb400-23"><a href="functional-elixir.html#cb400-23" tabindex="-1"></a>    <span class="va">:ok</span> <span class="op">=</span> broadcast_order<span class="fu">(</span>current_buy_order<span class="fu">)</span></span>
<span id="cb400-24"><a href="functional-elixir.html#cb400-24" tabindex="-1"></a></span>
<span id="cb400-25"><a href="functional-elixir.html#cb400-25" tabindex="-1"></a>    buy_order <span class="op">=</span> %<span class="fu">{</span>buy_order <span class="op">|</span> <span class="va">status:</span> current_buy_order<span class="op">.</span>status<span class="fu">}</span></span>
<span id="cb400-26"><a href="functional-elixir.html#cb400-26" tabindex="-1"></a></span>
<span id="cb400-27"><a href="functional-elixir.html#cb400-27" tabindex="-1"></a>    new_state <span class="op">=</span> %<span class="fu">{</span>state <span class="op">|</span> <span class="va">buy_order:</span> buy_order<span class="fu">}</span></span>
<span id="cb400-28"><a href="functional-elixir.html#cb400-28" tabindex="-1"></a>    <span class="ot">@leader</span><span class="op">.</span>notify<span class="fu">(</span><span class="va">:trader_state_updated</span>, new_state<span class="fu">)</span></span>
<span id="cb400-29"><a href="functional-elixir.html#cb400-29" tabindex="-1"></a>    <span class="fu">{</span><span class="va">:noreply</span>, new_state<span class="fu">}</span></span>
<span id="cb400-30"><a href="functional-elixir.html#cb400-30" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
</div>
<div id="naive.trader---terminate-the-trader" class="section level3 hasAnchor" number="18.4.14">
<h3><span class="header-section-number">18.4.14</span> <code>Naive.Trader</code> - Terminate the trader<a href="functional-elixir.html#naive.trader---terminate-the-trader" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In case of terminating the trader, we will pattern match on a <code>:exit</code> atom and slim down on pattern matching:</p>
<div class="sourceCode" id="cb401"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb401-1"><a href="functional-elixir.html#cb401-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/trader.ex</span></span>
<span id="cb401-2"><a href="functional-elixir.html#cb401-2" tabindex="-1"></a>  <span class="kw">def</span> execute_decision<span class="fu">(</span></span>
<span id="cb401-3"><a href="functional-elixir.html#cb401-3" tabindex="-1"></a>         <span class="va">:exit</span>,</span>
<span id="cb401-4"><a href="functional-elixir.html#cb401-4" tabindex="-1"></a>         %<span class="cn">State</span><span class="fu">{</span></span>
<span id="cb401-5"><a href="functional-elixir.html#cb401-5" tabindex="-1"></a>           <span class="va">id:</span> id,</span>
<span id="cb401-6"><a href="functional-elixir.html#cb401-6" tabindex="-1"></a>           <span class="va">symbol:</span> symbol</span>
<span id="cb401-7"><a href="functional-elixir.html#cb401-7" tabindex="-1"></a>         <span class="fu">}</span> <span class="op">=</span> state</span>
<span id="cb401-8"><a href="functional-elixir.html#cb401-8" tabindex="-1"></a>       <span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb401-9"><a href="functional-elixir.html#cb401-9" tabindex="-1"></a>    <span class="ot">@logger</span><span class="op">.</span>info<span class="fu">(</span><span class="st">&quot;Trader(</span><span class="ot">#{</span>id<span class="ot">}</span><span class="st">) finished trade cycle for </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st">&quot;</span><span class="fu">)</span></span>
<span id="cb401-10"><a href="functional-elixir.html#cb401-10" tabindex="-1"></a>    <span class="fu">{</span><span class="va">:stop</span>, <span class="va">:normal</span>, state<span class="fu">}</span></span>
<span id="cb401-11"><a href="functional-elixir.html#cb401-11" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<div style="page-break-after: always;"></div>
</div>
<div id="naive.trader---fetch-the-sell-order" class="section level3 hasAnchor" number="18.4.15">
<h3><span class="header-section-number">18.4.15</span> <code>Naive.Trader</code> - Fetch the sell order<a href="functional-elixir.html#naive.trader---fetch-the-sell-order" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In case of fetching the sell order, we will pattern match on a <code>:fetch_sell_order</code> atom and slim down on pattern matching:</p>
<div class="sourceCode" id="cb402"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb402-1"><a href="functional-elixir.html#cb402-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/trader.ex</span></span>
<span id="cb402-2"><a href="functional-elixir.html#cb402-2" tabindex="-1"></a>  <span class="kw">def</span> execute_decision<span class="fu">(</span></span>
<span id="cb402-3"><a href="functional-elixir.html#cb402-3" tabindex="-1"></a>         <span class="va">:fetch_sell_order</span>,</span>
<span id="cb402-4"><a href="functional-elixir.html#cb402-4" tabindex="-1"></a>         %<span class="cn">State</span><span class="fu">{</span></span>
<span id="cb402-5"><a href="functional-elixir.html#cb402-5" tabindex="-1"></a>           <span class="va">id:</span> id,</span>
<span id="cb402-6"><a href="functional-elixir.html#cb402-6" tabindex="-1"></a>           <span class="va">symbol:</span> symbol,</span>
<span id="cb402-7"><a href="functional-elixir.html#cb402-7" tabindex="-1"></a>           <span class="va">sell_order:</span></span>
<span id="cb402-8"><a href="functional-elixir.html#cb402-8" tabindex="-1"></a>             %<span class="cn">Binance</span><span class="op">.</span><span class="cn">OrderResponse</span><span class="fu">{</span></span>
<span id="cb402-9"><a href="functional-elixir.html#cb402-9" tabindex="-1"></a>               <span class="va">order_id:</span> order_id,</span>
<span id="cb402-10"><a href="functional-elixir.html#cb402-10" tabindex="-1"></a>               <span class="va">transact_time:</span> timestamp</span>
<span id="cb402-11"><a href="functional-elixir.html#cb402-11" tabindex="-1"></a>             <span class="fu">}</span> <span class="op">=</span> sell_order</span>
<span id="cb402-12"><a href="functional-elixir.html#cb402-12" tabindex="-1"></a>         <span class="fu">}</span> <span class="op">=</span> state</span>
<span id="cb402-13"><a href="functional-elixir.html#cb402-13" tabindex="-1"></a>       <span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb402-14"><a href="functional-elixir.html#cb402-14" tabindex="-1"></a>    <span class="ot">@logger</span><span class="op">.</span>info<span class="fu">(</span><span class="st">&quot;Trader&#39;s(</span><span class="ot">#{</span>id<span class="ot">}</span><span class="st"> </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st"> SELL order got partially filled&quot;</span><span class="fu">)</span></span>
<span id="cb402-15"><a href="functional-elixir.html#cb402-15" tabindex="-1"></a></span>
<span id="cb402-16"><a href="functional-elixir.html#cb402-16" tabindex="-1"></a>    <span class="fu">{</span><span class="va">:ok</span>, %<span class="cn">Binance</span><span class="op">.</span><span class="cn">Order</span><span class="fu">{}</span> <span class="op">=</span> current_sell_order<span class="fu">}</span> <span class="op">=</span></span>
<span id="cb402-17"><a href="functional-elixir.html#cb402-17" tabindex="-1"></a>      <span class="ot">@binance_client</span><span class="op">.</span>get_order<span class="fu">(</span></span>
<span id="cb402-18"><a href="functional-elixir.html#cb402-18" tabindex="-1"></a>        symbol,</span>
<span id="cb402-19"><a href="functional-elixir.html#cb402-19" tabindex="-1"></a>        timestamp,</span>
<span id="cb402-20"><a href="functional-elixir.html#cb402-20" tabindex="-1"></a>        order_id</span>
<span id="cb402-21"><a href="functional-elixir.html#cb402-21" tabindex="-1"></a>      <span class="fu">)</span></span>
<span id="cb402-22"><a href="functional-elixir.html#cb402-22" tabindex="-1"></a></span>
<span id="cb402-23"><a href="functional-elixir.html#cb402-23" tabindex="-1"></a>    <span class="va">:ok</span> <span class="op">=</span> broadcast_order<span class="fu">(</span>current_sell_order<span class="fu">)</span></span>
<span id="cb402-24"><a href="functional-elixir.html#cb402-24" tabindex="-1"></a></span>
<span id="cb402-25"><a href="functional-elixir.html#cb402-25" tabindex="-1"></a>    sell_order <span class="op">=</span> %<span class="fu">{</span>sell_order <span class="op">|</span> <span class="va">status:</span> current_sell_order<span class="op">.</span>status<span class="fu">}</span></span>
<span id="cb402-26"><a href="functional-elixir.html#cb402-26" tabindex="-1"></a></span>
<span id="cb402-27"><a href="functional-elixir.html#cb402-27" tabindex="-1"></a>    new_state <span class="op">=</span> %<span class="fu">{</span>state <span class="op">|</span> <span class="va">sell_order:</span> sell_order<span class="fu">}</span></span>
<span id="cb402-28"><a href="functional-elixir.html#cb402-28" tabindex="-1"></a>    <span class="ot">@leader</span><span class="op">.</span>notify<span class="fu">(</span><span class="va">:trader_state_updated</span>, new_state<span class="fu">)</span></span>
<span id="cb402-29"><a href="functional-elixir.html#cb402-29" tabindex="-1"></a>    <span class="fu">{</span><span class="va">:noreply</span>, new_state<span class="fu">}</span></span>
<span id="cb402-30"><a href="functional-elixir.html#cb402-30" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
</div>
<div id="naive.trader---triggering-rebuy" class="section level3 hasAnchor" number="18.4.16">
<h3><span class="header-section-number">18.4.16</span> <code>Naive.Trader</code> - Triggering rebuy<a href="functional-elixir.html#naive.trader---triggering-rebuy" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In case of triggering the rebuy procedure, we will pattern match on a <code>:rebuy</code> atom, slim down on pattern matching and simplify the function a fair bit(no branching required anymore - yay!):</p>
<div class="sourceCode" id="cb403"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb403-1"><a href="functional-elixir.html#cb403-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/trader.ex</span></span>
<span id="cb403-2"><a href="functional-elixir.html#cb403-2" tabindex="-1"></a>  <span class="kw">def</span> execute_decision<span class="fu">(</span></span>
<span id="cb403-3"><a href="functional-elixir.html#cb403-3" tabindex="-1"></a>         <span class="va">:rebuy</span>,</span>
<span id="cb403-4"><a href="functional-elixir.html#cb403-4" tabindex="-1"></a>         %<span class="cn">State</span><span class="fu">{</span></span>
<span id="cb403-5"><a href="functional-elixir.html#cb403-5" tabindex="-1"></a>           <span class="va">id:</span> id,</span>
<span id="cb403-6"><a href="functional-elixir.html#cb403-6" tabindex="-1"></a>           <span class="va">symbol:</span> symbol</span>
<span id="cb403-7"><a href="functional-elixir.html#cb403-7" tabindex="-1"></a>         <span class="fu">}</span> <span class="op">=</span> state</span>
<span id="cb403-8"><a href="functional-elixir.html#cb403-8" tabindex="-1"></a>       <span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb403-9"><a href="functional-elixir.html#cb403-9" tabindex="-1"></a>    <span class="ot">@logger</span><span class="op">.</span>info<span class="fu">(</span><span class="st">&quot;Rebuy triggered for </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st"> by the trader(</span><span class="ot">#{</span>id<span class="ot">}</span><span class="st">)&quot;</span><span class="fu">)</span></span>
<span id="cb403-10"><a href="functional-elixir.html#cb403-10" tabindex="-1"></a>    new_state <span class="op">=</span> %<span class="fu">{</span>state <span class="op">|</span> <span class="va">rebuy_notified:</span> <span class="cn">true</span><span class="fu">}</span></span>
<span id="cb403-11"><a href="functional-elixir.html#cb403-11" tabindex="-1"></a>    <span class="ot">@leader</span><span class="op">.</span>notify<span class="fu">(</span><span class="va">:rebuy_triggered</span>, new_state<span class="fu">)</span></span>
<span id="cb403-12"><a href="functional-elixir.html#cb403-12" tabindex="-1"></a>    <span class="fu">{</span><span class="va">:noreply</span>, new_state<span class="fu">}</span></span>
<span id="cb403-13"><a href="functional-elixir.html#cb403-13" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
</div>
<div id="naive.trader---the-final-ignore-clause" class="section level3 hasAnchor" number="18.4.17">
<h3><span class="header-section-number">18.4.17</span> <code>Naive.Trader</code> - The final ignore clause<a href="functional-elixir.html#naive.trader---the-final-ignore-clause" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The final ignore clause will <code>:skip</code> all events:</p>
<div class="sourceCode" id="cb404"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb404-1"><a href="functional-elixir.html#cb404-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/trader.ex</span></span>
<span id="cb404-2"><a href="functional-elixir.html#cb404-2" tabindex="-1"></a>  <span class="kw">def</span> execute_decision<span class="fu">(</span><span class="va">:skip</span>, state<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb404-3"><a href="functional-elixir.html#cb404-3" tabindex="-1"></a>    <span class="fu">{</span><span class="va">:noreply</span>, state<span class="fu">}</span></span>
<span id="cb404-4"><a href="functional-elixir.html#cb404-4" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>The ignore clause finishes our current refactoring round, which showcased that sometimes abstracting pattern matching into a separate function is a valid strategy to increase the amount of pure code.</p>
<p>Note: The fact that we could abstract the logic from pattern matches is quite a unique situation to our application. I would not advise abstracting GenServer pattern matching into a separate module if dealing with different structs/actions(in our case, all our pattern matches were “making a trading decision”, it’s a single “action”, that’s why we abstracted them).</p>
</div>
</div>
<div id="dealing-with-dirty-code" class="section level2 hasAnchor" number="18.5">
<h2><span class="header-section-number">18.5</span> Dealing with dirty code<a href="functional-elixir.html#dealing-with-dirty-code" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In the last section, we’ve split the <code>handle_info/2</code> clauses into the <code>generate_decision/2</code> and <code>execute_decision/2</code> functions. That’s excellent progress, but we still have the strategy logic inside the <code>Naive.Trader</code> module.</p>
<p>Let’s move the <code>execute_decision/2</code> function(together with all the code that it depends on, like the <code>broadcast_order/1</code> and <code>convert_to_order/1</code> functions as well as a copy of the <code>require Logger</code>) from the <code>Naive.Trader</code> module to the <code>Naive.Strategy</code> module.</p>
<p>As the <code>generate_decision/2</code> function is causing side effects, we don’t want it to be called directly from the outside of the module, so we will need to make it private.</p>
<p>Changing the <code>execute_decision/2</code> function(now inside the <code>Naive.Strategy</code> module) to private will cause a problem with the <code>handle_info/2</code> callback function inside the <code>Naive.Trader</code> module as it relies on the <code>execute_decision/2</code> function to be public. The fact that our strategy makes a decision and then executes code based on it is an implementation detail that we shouldn’t share with the <code>Naive.Trader</code> module. That’s why we will move the <strong>body</strong> of the <code>handle_info/2</code> callback function into a new function called <code>execute/2</code> inside the <code>Naive.Strategy</code> module:</p>
<div class="sourceCode" id="cb405"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb405-1"><a href="functional-elixir.html#cb405-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/strategy.ex</span></span>
<span id="cb405-2"><a href="functional-elixir.html#cb405-2" tabindex="-1"></a>  <span class="kw">def</span> execute<span class="fu">(</span>%<span class="cn">TradeEvent</span><span class="fu">{}</span> <span class="op">=</span> trade_event, %<span class="cn">State</span><span class="fu">{}</span> <span class="op">=</span> state<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb405-3"><a href="functional-elixir.html#cb405-3" tabindex="-1"></a>    generate_decision<span class="fu">(</span>trade_event, state<span class="fu">)</span></span>
<span id="cb405-4"><a href="functional-elixir.html#cb405-4" tabindex="-1"></a>    <span class="op">|&gt;</span> execute_decision<span class="fu">(</span>state<span class="fu">)</span></span>
<span id="cb405-5"><a href="functional-elixir.html#cb405-5" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>Before updating the <code>Naive.Trader</code> module to use the <code>execute/2</code> function, we need to address another issue that moving the <code>execute_decision/2</code> caused. At this moment, all of the clauses return GenServer specific tuples. What we really need to return to the trader is an atom indicating should it continue or terminate together with the updated state:</p>
<div class="sourceCode" id="cb406"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb406-1"><a href="functional-elixir.html#cb406-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/strategy.ex</span></span>
<span id="cb406-2"><a href="functional-elixir.html#cb406-2" tabindex="-1"></a><span class="co"># last lines inside the `execute_decision/2` clauses</span></span>
<span id="cb406-3"><a href="functional-elixir.html#cb406-3" tabindex="-1"></a><span class="fu">{</span><span class="va">:ok</span>, new_state<span class="fu">}</span> <span class="co"># &lt;= previously {:noreply, new_state} (5 times)</span></span>
<span id="cb406-4"><a href="functional-elixir.html#cb406-4" tabindex="-1"></a><span class="fu">{</span><span class="va">:ok</span>, state<span class="fu">}</span> <span class="co"># &lt;= previously {:noreply, state} (once)</span></span>
<span id="cb406-5"><a href="functional-elixir.html#cb406-5" tabindex="-1"></a><span class="va">:exit</span> <span class="co"># &lt;= previously {:stop, :normal, state} + remove `state` pattern match (once)</span></span></code></pre></div>
<p>We can now update the <code>handle_info/2</code> callback function to call the new “interface” of the <code>Naive.Strategy</code> module that we just created and act accordingly to the result:</p>
<div class="sourceCode" id="cb407"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb407-1"><a href="functional-elixir.html#cb407-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/trader.ex</span></span>
<span id="cb407-2"><a href="functional-elixir.html#cb407-2" tabindex="-1"></a>  <span class="kw">def</span> handle_info<span class="fu">(</span>%<span class="cn">TradeEvent</span><span class="fu">{}</span> <span class="op">=</span> trade_event, %<span class="cn">State</span><span class="fu">{}</span> <span class="op">=</span> state<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb407-3"><a href="functional-elixir.html#cb407-3" tabindex="-1"></a>    <span class="kw">case</span> <span class="cn">Naive</span><span class="op">.</span><span class="cn">Strategy</span><span class="op">.</span>execute<span class="fu">(</span>trade_event, state<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb407-4"><a href="functional-elixir.html#cb407-4" tabindex="-1"></a>      <span class="fu">{</span><span class="va">:ok</span>, new_state<span class="fu">}</span> <span class="op">-&gt;</span> <span class="fu">{</span><span class="va">:noreply</span>, new_state<span class="fu">}</span></span>
<span id="cb407-5"><a href="functional-elixir.html#cb407-5" tabindex="-1"></a>      <span class="va">:exit</span> <span class="op">-&gt;</span> <span class="fu">{</span><span class="va">:stop</span>, <span class="va">:normal</span>, state<span class="fu">}</span></span>
<span id="cb407-6"><a href="functional-elixir.html#cb407-6" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb407-7"><a href="functional-elixir.html#cb407-7" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>At this moment, we could just copy/move module attributes from the <code>Naive.Trader</code> module to the <code>Naive.Strategy</code> module and our code would start to work again. Still, before we will do that, we will use this opportunity to look into how to make our dirty code testable.</p>
</div>
<div id="making-dirty-code-testable" class="section level2 hasAnchor" number="18.6">
<h2><span class="header-section-number">18.6</span> Making dirty code testable<a href="functional-elixir.html#making-dirty-code-testable" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Making dirty code testable is very closely linked to injecting dependencies. In the testing environment, we would like to use dummy implementations instead of executing the side-effect-causing code to simplify the tests. We will look into the different ways that we can pass side-effect-causing “code” into impure functions.</p>
<div id="passing-functions-arguments" class="section level3 hasAnchor" number="18.6.1">
<h3><span class="header-section-number">18.6.1</span> Passing functions arguments<a href="functional-elixir.html#passing-functions-arguments" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Functions are first-class citizens in Elixir, which means that we can pass them as arguments to functions. This way, we can pass side-effect causing functions into our <code>Naive.Strategy</code> module.</p>
<p>Let’s look at how this would look in practice. We need to look into the <code>execute_decision/2</code> function, as it’s where the place side effects happen. Looking at the 1st clause(responsible for placing a buy order), we can see that it’s calling the <code>Logger.info/1</code>, <code>Binance.order_limit_buy/4</code>, <code>PubSub.broadcast/3</code>(via the <code>broadcast_order/1</code> function) and <code>Leader.notify/2</code> functions. To make our code easily testable, we would need to be able to pass dummy implementations for all of those.</p>
<p>As we aren’t calling the <code>execute_decision/2</code> directly, we need to pass all of the above functions as arguments to the <code>execute/2</code> function, which will pass them onward to the <code>execute_decision/2</code>.</p>
<p>We can see that even with default values pointing to the “real” implementation, that’s still <strong>a lot</strong> of noise to make testing easier. It will negatively impact the maintenance of the code - here’s an example of what this would look like(don’t bother typing it):</p>
<div class="sourceCode" id="cb408"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb408-1"><a href="functional-elixir.html#cb408-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/strategy.ex</span></span>
<span id="cb408-2"><a href="functional-elixir.html#cb408-2" tabindex="-1"></a><span class="co"># injecting dummy implementation, fallback to real implementation</span></span>
<span id="cb408-3"><a href="functional-elixir.html#cb408-3" tabindex="-1"></a><span class="kw">def</span> execute<span class="fu">(</span></span>
<span id="cb408-4"><a href="functional-elixir.html#cb408-4" tabindex="-1"></a>  %<span class="cn">TradeEvent</span><span class="fu">{}</span> <span class="op">=</span> trade_event,</span>
<span id="cb408-5"><a href="functional-elixir.html#cb408-5" tabindex="-1"></a>  %<span class="cn">State</span><span class="fu">{}</span> <span class="op">=</span> state,</span>
<span id="cb408-6"><a href="functional-elixir.html#cb408-6" tabindex="-1"></a>  logger_info \\ <span class="op">&amp;</span><span class="cn">Logger</span><span class="op">.</span>info<span class="op">/</span><span class="dv">1</span>, <span class="co"># &lt;= function injected</span></span>
<span id="cb408-7"><a href="functional-elixir.html#cb408-7" tabindex="-1"></a>  order_limit_buy \\ <span class="op">&amp;</span><span class="cn">Binance</span><span class="op">.</span>order_limit_buy<span class="op">/</span><span class="dv">4</span>, <span class="co"># &lt;= function injected</span></span>
<span id="cb408-8"><a href="functional-elixir.html#cb408-8" tabindex="-1"></a>  pubsub_broadcast \\ <span class="op">&amp;</span><span class="cn">PubSub</span><span class="op">.</span>broadcast<span class="op">/</span><span class="dv">3</span>, <span class="co"># &lt;= function injected</span></span>
<span id="cb408-9"><a href="functional-elixir.html#cb408-9" tabindex="-1"></a>  notify_leader \\ <span class="op">&amp;</span><span class="cn">Leader</span><span class="op">.</span>notify<span class="op">/</span><span class="dv">2</span> <span class="co"># &lt;= function injected</span></span>
<span id="cb408-10"><a href="functional-elixir.html#cb408-10" tabindex="-1"></a><span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb408-11"><a href="functional-elixir.html#cb408-11" tabindex="-1"></a>  <span class="op">...</span></span></code></pre></div>
<p>There are already four functions, and we only took care of side-effects causing functions from the first <code>execute_decision/2</code> clause. We can easily see how this very quickly becomes just unmanageable as there would be 10+ “injected” arguments going from the <code>execute/2</code> to <code>execute_decision/2</code>, and only some of them would be used in each clause.</p>
<p>Additional downsides:</p>
<ul>
<li>when passing a function as an argument, we need to specify the arity, so when we would like to use more than one arity, we need to pass the function <strong>multiple times with different arities</strong>. An example could be passing <code>Logger.info/1</code> and <code>Logger.info/2</code></li>
<li>we need to give a name to every passed function, sometimes multiple arities (again, how should variables for <code>Logger.info/1</code> and <code>Logger.info/2</code> be called? <code>logger_info_2</code>?)</li>
<li>share amount of arguments negatively impacts code readability</li>
</ul>
<p>We can see that passing functions as arguments is just a bad idea in case of making our code testable. It will have the opposite effect, decreasing readability making our code difficult to maintain and follow.</p>
<p>Important note: Passing functions as arguments is not always bad! A good example could be when different actions need to be performed based on runtime data.</p>
<div style="page-break-after: always;"></div>
</div>
<div id="passing-grouped-functions-as-a-context" class="section level3 hasAnchor" number="18.6.2">
<h3><span class="header-section-number">18.6.2</span> Passing grouped functions as a context<a href="functional-elixir.html#passing-grouped-functions-as-a-context" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The natural next step would be to put all of those functions into some structure like Map or Keyword list. Whichever we would choose, we will end up with the same problems of naming keys(this time inside the map/keyword list), multiple functions because of different arity but also default values inside each clause of the <code>execute_decision/2</code> function:</p>
<div class="sourceCode" id="cb409"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb409-1"><a href="functional-elixir.html#cb409-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/strategy.ex</span></span>
<span id="cb409-2"><a href="functional-elixir.html#cb409-2" tabindex="-1"></a>  <span class="kw">defp</span> execute_decision<span class="fu">(</span></span>
<span id="cb409-3"><a href="functional-elixir.html#cb409-3" tabindex="-1"></a>        <span class="fu">{</span><span class="va">:place_buy_order</span>, price, quantity<span class="fu">}</span>,</span>
<span id="cb409-4"><a href="functional-elixir.html#cb409-4" tabindex="-1"></a>        %<span class="cn">State</span><span class="fu">{</span></span>
<span id="cb409-5"><a href="functional-elixir.html#cb409-5" tabindex="-1"></a>          <span class="va">id:</span> id,</span>
<span id="cb409-6"><a href="functional-elixir.html#cb409-6" tabindex="-1"></a>          <span class="va">symbol:</span> symbol</span>
<span id="cb409-7"><a href="functional-elixir.html#cb409-7" tabindex="-1"></a>        <span class="fu">}</span> <span class="op">=</span> state,</span>
<span id="cb409-8"><a href="functional-elixir.html#cb409-8" tabindex="-1"></a>        %<span class="fu">{}</span> <span class="op">=</span> context <span class="co"># &lt;= context added</span></span>
<span id="cb409-9"><a href="functional-elixir.html#cb409-9" tabindex="-1"></a>      <span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb409-10"><a href="functional-elixir.html#cb409-10" tabindex="-1"></a>    <span class="co"># vvv fetch from context vvv</span></span>
<span id="cb409-11"><a href="functional-elixir.html#cb409-11" tabindex="-1"></a>    logger_info <span class="op">=</span> <span class="cn">Map</span><span class="op">.</span>get<span class="fu">(</span>context, <span class="va">:logger_info</span>, <span class="op">&amp;</span><span class="cn">Logger</span><span class="op">.</span>info<span class="op">/</span><span class="dv">1</span><span class="fu">)</span></span>
<span id="cb409-12"><a href="functional-elixir.html#cb409-12" tabindex="-1"></a>    order_limit_buy <span class="op">=</span> <span class="cn">Map</span><span class="op">.</span>get<span class="fu">(</span>context, <span class="va">:order_limit_buy</span>, <span class="op">&amp;</span><span class="cn">Binance</span><span class="op">.</span>order_limit_buy<span class="op">/</span><span class="dv">4</span><span class="fu">)</span></span>
<span id="cb409-13"><a href="functional-elixir.html#cb409-13" tabindex="-1"></a>    leader_notify <span class="op">=</span> <span class="cn">Map</span><span class="op">.</span>get<span class="fu">(</span>context, <span class="va">:leader_notify</span>, <span class="op">&amp;</span><span class="cn">Leader</span><span class="op">.</span>notify<span class="op">/</span><span class="dv">2</span><span class="fu">)</span></span></code></pre></div>
<p>Again this looks like a bad idea. It’s probably marginally better than just sending functions one by one, but not much.</p>
</div>
<div id="passing-grouped-modules-as-a-context" class="section level3 hasAnchor" number="18.6.3">
<h3><span class="header-section-number">18.6.3</span> Passing grouped modules as a context<a href="functional-elixir.html#passing-grouped-modules-as-a-context" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The significant advantage of passing modules as arguments instead of functions is that we no longer have a problem with naming keys or caring about different functions’ arities. There will also be substantially fewer modules used in comparison to functions.</p>
<p>Sadly we still need to use the <code>Map</code> function to get the modules out of <code>"context"</code>:</p>
<div class="sourceCode" id="cb410"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb410-1"><a href="functional-elixir.html#cb410-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/strategy.ex</span></span>
<span id="cb410-2"><a href="functional-elixir.html#cb410-2" tabindex="-1"></a>  <span class="kw">defp</span> execute_decision<span class="fu">(</span></span>
<span id="cb410-3"><a href="functional-elixir.html#cb410-3" tabindex="-1"></a>        <span class="fu">{</span><span class="va">:place_buy_order</span>, price, quantity<span class="fu">}</span>,</span>
<span id="cb410-4"><a href="functional-elixir.html#cb410-4" tabindex="-1"></a>        %<span class="cn">State</span><span class="fu">{</span></span>
<span id="cb410-5"><a href="functional-elixir.html#cb410-5" tabindex="-1"></a>          <span class="va">id:</span> id,</span>
<span id="cb410-6"><a href="functional-elixir.html#cb410-6" tabindex="-1"></a>          <span class="va">symbol:</span> symbol</span>
<span id="cb410-7"><a href="functional-elixir.html#cb410-7" tabindex="-1"></a>        <span class="fu">}</span> <span class="op">=</span> state,</span>
<span id="cb410-8"><a href="functional-elixir.html#cb410-8" tabindex="-1"></a>        %<span class="fu">{}</span> <span class="op">=</span> context <span class="co"># &lt;= context added</span></span>
<span id="cb410-9"><a href="functional-elixir.html#cb410-9" tabindex="-1"></a>      <span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb410-10"><a href="functional-elixir.html#cb410-10" tabindex="-1"></a>    logger <span class="op">=</span> <span class="cn">Map</span><span class="op">.</span>get<span class="fu">(</span>context, <span class="va">:logger</span>, <span class="op">&amp;</span><span class="cn">Logger</span><span class="fu">)</span> <span class="co"># &lt;= fetch from context</span></span>
<span id="cb410-11"><a href="functional-elixir.html#cb410-11" tabindex="-1"></a>    binance <span class="op">=</span> <span class="cn">Map</span><span class="op">.</span>get<span class="fu">(</span>context, <span class="va">:binance</span>, <span class="cn">Binance</span><span class="fu">)</span> <span class="co"># &lt;= fetch from context</span></span>
<span id="cb410-12"><a href="functional-elixir.html#cb410-12" tabindex="-1"></a>    leader <span class="op">=</span> <span class="cn">Map</span><span class="op">.</span>get<span class="fu">(</span>context, <span class="va">:leader</span>, <span class="op">&amp;</span><span class="cn">Leader</span><span class="fu">)</span> <span class="co"># &lt;= fetch from context</span></span></code></pre></div>
<p>This is much better, but we will still need to do a fair amount of additional work to get the modules out. Also, our code will be full of the “default” modules(as <strong>each</strong> of the clauses retrieving them from the context will need to specify defaults).</p>
</div>
<div id="injecting-modules-to-modules-attributes-based-on-the-configuration" class="section level3 hasAnchor" number="18.6.4">
<h3><span class="header-section-number">18.6.4</span> Injecting modules to module’s attributes based on the configuration<a href="functional-elixir.html#injecting-modules-to-modules-attributes-based-on-the-configuration" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>And we finally got there - we have come a full circle. This is the approach that we previously used inside the <code>Naive.Trader</code> module(you can go ahead and add them to the <code>Naive.Strategy</code> module):</p>
<div class="sourceCode" id="cb411"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb411-1"><a href="functional-elixir.html#cb411-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/strategy.ex</span></span>
<span id="cb411-2"><a href="functional-elixir.html#cb411-2" tabindex="-1"></a><span class="kw">defmodule</span> <span class="cn">Naive</span><span class="op">.</span><span class="cn">Strategy</span> <span class="kw">do</span></span>
<span id="cb411-3"><a href="functional-elixir.html#cb411-3" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb411-4"><a href="functional-elixir.html#cb411-4" tabindex="-1"></a></span>
<span id="cb411-5"><a href="functional-elixir.html#cb411-5" tabindex="-1"></a>  <span class="ot">@binance_client</span> <span class="cn">Application</span><span class="op">.</span>compile_env<span class="fu">(</span><span class="va">:naive</span>, <span class="va">:binance_client</span><span class="fu">)</span></span>
<span id="cb411-6"><a href="functional-elixir.html#cb411-6" tabindex="-1"></a>  <span class="ot">@leader</span> <span class="cn">Application</span><span class="op">.</span>compile_env<span class="fu">(</span><span class="va">:naive</span>, <span class="va">:leader</span><span class="fu">)</span></span>
<span id="cb411-7"><a href="functional-elixir.html#cb411-7" tabindex="-1"></a>  <span class="ot">@logger</span> <span class="cn">Application</span><span class="op">.</span>compile_env<span class="fu">(</span><span class="va">:core</span>, <span class="va">:logger</span><span class="fu">)</span></span>
<span id="cb411-8"><a href="functional-elixir.html#cb411-8" tabindex="-1"></a>  <span class="ot">@pubsub_client</span> <span class="cn">Application</span><span class="op">.</span>compile_env<span class="fu">(</span><span class="va">:core</span>, <span class="va">:pubsub_client</span><span class="fu">)</span></span></code></pre></div>
<p>We looked into different ways to inject dependencies to understand their downsides.</p>
<p>Sometimes, injecting values(like modules) as module attributes can feel like a “global state”, “singleton”, or similar antipattern. We need to understand that each programming language provides different ways to solve common programming problems. Dependency injection is one of those common concerns that every language needs to solve, and Elixir solves it by using compile-time modules’ attributes.</p>
<p>As long as you are using module attributes to be able to inject compile-time dependencies to test your code, there’s just <strong>no better way</strong> to do it in Elixir, and now we know why(based on the issues with the alternative approaches).</p>
<p>Together with the module attributes, our code should be now fully functional.</p>
</div>
</div>
<div id="the-power-with-in" class="section level2 hasAnchor" number="18.7">
<h2><span class="header-section-number">18.7</span> The power <code>with</code>-in<a href="functional-elixir.html#the-power-with-in" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In the last section, we looked into different ways to inject modules’ dependencies to avoid side-effects causing functions inside the tests. Besides side-effect causing functions, in functional programming, error handling is also done in a specific manner.</p>
<p>Many languages introduced concepts like <code>Either</code>, which is a struct that can be either <code>Left</code>(error result) or <code>Right</code>(success result). Those quite nicely fit to the standard Elixir results like <code>{:error, reason}</code> and <code>{:ok, result}</code>. Further, those languages provide multiple functions to work with the <code>Either</code>, like <code>map</code>.</p>
<div class="sourceCode" id="cb412"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb412-1"><a href="functional-elixir.html#cb412-1" tabindex="-1"></a>safeDivide<span class="fu">(</span><span class="dv">2</span>, <span class="dv">0</span><span class="fu">)</span> <span class="co"># &lt;= returns Left(&quot;Dividing error&quot;)</span></span>
<span id="cb412-2"><a href="functional-elixir.html#cb412-2" tabindex="-1"></a><span class="op">|&gt;</span> then<span class="fu">(</span><span class="cn">Either</span><span class="op">.</span>map<span class="fu">(</span><span class="op">&amp;</span><span class="fu">(</span><span class="op">&amp;</span><span class="dv">1</span> <span class="op">*</span> <span class="dv">2</span><span class="fu">)))</span> <span class="co"># &lt;= still Left(&quot;Dividing error&quot;)</span></span>
<span id="cb412-3"><a href="functional-elixir.html#cb412-3" tabindex="-1"></a></span>
<span id="cb412-4"><a href="functional-elixir.html#cb412-4" tabindex="-1"></a>safeDivide<span class="fu">(</span><span class="dv">2</span>, <span class="dv">1</span><span class="fu">)</span> <span class="co"># &lt;= returns Right(2)</span></span>
<span id="cb412-5"><a href="functional-elixir.html#cb412-5" tabindex="-1"></a><span class="op">|&gt;</span> then<span class="fu">(</span><span class="cn">Either</span><span class="op">.</span>map<span class="fu">(</span><span class="op">&amp;</span><span class="fu">(</span><span class="op">&amp;</span><span class="dv">1</span> <span class="op">*</span> <span class="dv">2</span><span class="fu">)))</span> <span class="co"># &lt;= returns Right(4)</span></span></code></pre></div>
<p>The above code will use hypothetical <code>Left('Dividing error')</code> or <code>Right(result)</code>. The <code>Either.map/2</code> is a special <code>map</code> function that runs the passed function if it’s <code>Right</code> or completely ignores it when it’s <code>Left</code> - it could be visualized as:</p>
<div class="sourceCode" id="cb413"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb413-1"><a href="functional-elixir.html#cb413-1" tabindex="-1"></a><span class="kw">def</span> map<span class="fu">(</span>%<span class="cn">Either</span><span class="op">.</span><span class="cn">Left</span><span class="fu">{}</span> <span class="op">=</span> left, _fun<span class="fu">)</span>, <span class="va">do:</span> left</span>
<span id="cb413-2"><a href="functional-elixir.html#cb413-2" tabindex="-1"></a><span class="kw">def</span> map<span class="fu">(</span>%<span class="cn">Either</span><span class="op">.</span><span class="cn">Right</span><span class="fu">{</span><span class="va">result:</span> v<span class="fu">}</span>, fun<span class="fu">)</span>, <span class="va">do:</span> %<span class="cn">Either</span><span class="op">.</span><span class="cn">Right</span><span class="fu">{</span><span class="va">result:</span> fun<span class="op">.</span><span class="fu">(</span>v<span class="fu">)}</span></span></code></pre></div>
<p>This is nice and great, but what if the function inside the <code>Either.map/2</code> returns another <code>Either</code>? Like:</p>
<div class="sourceCode" id="cb414"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb414-1"><a href="functional-elixir.html#cb414-1" tabindex="-1"></a>safeDivide<span class="fu">(</span><span class="dv">2</span>, <span class="dv">1</span><span class="fu">)</span> <span class="co"># &lt;= returns Right(2)</span></span>
<span id="cb414-2"><a href="functional-elixir.html#cb414-2" tabindex="-1"></a><span class="op">|&gt;</span> then<span class="fu">(</span><span class="cn">Either</span><span class="op">.</span>map<span class="fu">(</span><span class="op">&amp;</span><span class="fu">(</span>safeDivide<span class="fu">(</span><span class="op">&amp;</span><span class="dv">1</span>, <span class="dv">1</span><span class="fu">))))</span> <span class="co"># &lt;= now Right(Right(2))!?</span></span></code></pre></div>
<p>Now we need to understand those abstractions to be able to decide should we <code>map</code> or <code>flatMap</code>(that’s the function that will not wrap the function result into the <code>Right</code>):</p>
<div class="sourceCode" id="cb415"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb415-1"><a href="functional-elixir.html#cb415-1" tabindex="-1"></a>safeDivide<span class="fu">(</span><span class="dv">2</span>, <span class="dv">1</span><span class="fu">)</span> <span class="co"># &lt;= returns Right(2)</span></span>
<span id="cb415-2"><a href="functional-elixir.html#cb415-2" tabindex="-1"></a><span class="op">|&gt;</span> then<span class="fu">(</span><span class="cn">Either</span><span class="op">.</span>flatMap<span class="fu">(</span><span class="op">&amp;</span><span class="fu">(</span>safeDivide<span class="fu">(</span><span class="op">&amp;</span><span class="dv">1</span>, <span class="dv">1</span><span class="fu">))))</span> <span class="op">&lt;=</span> still <span class="cn">Right</span><span class="fu">(</span><span class="dv">2</span><span class="fu">)</span></span></code></pre></div>
<p>And that is just the beginning of the complexities that those abstractions bring.</p>
<p>Furthermore, let’s say that inside the first <code>Either.map/2</code> callback, we will have some variable(s) that we would like to use later on. We are now deep inside closures world like the following:</p>
<div class="sourceCode" id="cb416"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb416-1"><a href="functional-elixir.html#cb416-1" tabindex="-1"></a>safeDivide<span class="fu">(</span><span class="dv">2</span>, <span class="dv">1</span><span class="fu">)</span> <span class="co"># &lt;= returns Right(2)</span></span>
<span id="cb416-2"><a href="functional-elixir.html#cb416-2" tabindex="-1"></a><span class="op">|&gt;</span> then<span class="fu">(</span><span class="cn">Either</span><span class="op">.</span>flatMap<span class="fu">(</span><span class="kw">fn</span> res <span class="op">-&gt;</span></span>
<span id="cb416-3"><a href="functional-elixir.html#cb416-3" tabindex="-1"></a>    <span class="co"># x = some data generated here</span></span>
<span id="cb416-4"><a href="functional-elixir.html#cb416-4" tabindex="-1"></a>    safeDivide<span class="fu">(</span><span class="dv">2</span>, <span class="dv">1</span><span class="fu">)</span></span>
<span id="cb416-5"><a href="functional-elixir.html#cb416-5" tabindex="-1"></a>    <span class="op">|&gt;</span> then<span class="fu">(</span><span class="cn">Either</span><span class="op">.</span>map<span class="fu">(</span><span class="op">&amp;</span><span class="fu">(</span><span class="op">&amp;</span><span class="dv">1</span> <span class="op">*</span> <span class="dv">2</span><span class="fu">)))</span></span>
<span id="cb416-6"><a href="functional-elixir.html#cb416-6" tabindex="-1"></a>    <span class="op">|&gt;</span> then<span class="fu">(</span><span class="cn">Either</span><span class="op">.</span>map<span class="fu">(</span><span class="op">&amp;</span><span class="fu">(</span><span class="op">&amp;</span><span class="dv">1</span> <span class="op">*</span> x<span class="fu">)))</span> <span class="co"># &lt;= a clause to have access to x</span></span>
<span id="cb416-7"><a href="functional-elixir.html#cb416-7" tabindex="-1"></a>  <span class="kw">end</span><span class="fu">))</span></span></code></pre></div>
<p>The above example is obviously simplified and silly but should give us a gist of what sort of complexity we will very soon get involved in. And, again, we just scratched the surface - there are so many more functions that the <code>Either</code> provides. Besides, writing code in this fashion in Elixir would cause a lot of friction in the team as it’s difficult to find any advantages of using it.</p>
<div id="idiomatic-error-handling" class="section level3 hasAnchor" number="18.7.1">
<h3><span class="header-section-number">18.7.1</span> Idiomatic error handling<a href="functional-elixir.html#idiomatic-error-handling" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>To achieve the same results, Elixir provides the <code>with</code> statement:</p>
<div class="sourceCode" id="cb417"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb417-1"><a href="functional-elixir.html#cb417-1" tabindex="-1"></a>  with <span class="fu">{</span><span class="va">:ok</span>, divide_result<span class="fu">}</span> <span class="op">&lt;-</span> safeDiv<span class="fu">(</span><span class="dv">2</span>,<span class="dv">1</span><span class="fu">)</span>,</span>
<span id="cb417-2"><a href="functional-elixir.html#cb417-2" tabindex="-1"></a>       <span class="fu">{</span><span class="va">:ok</span>, divide_result_2<span class="fu">}</span> <span class="op">&lt;-</span> safeDivide<span class="fu">(</span><span class="dv">2</span>, <span class="dv">1</span><span class="fu">)</span></span>
<span id="cb417-3"><a href="functional-elixir.html#cb417-3" tabindex="-1"></a>  <span class="kw">do</span></span>
<span id="cb417-4"><a href="functional-elixir.html#cb417-4" tabindex="-1"></a>    divide_result_2 <span class="op">*</span> <span class="dv">2</span> <span class="op">*</span> divide_result</span>
<span id="cb417-5"><a href="functional-elixir.html#cb417-5" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb417-6"><a href="functional-elixir.html#cb417-6" tabindex="-1"></a>    err <span class="op">-&gt;</span> err</span>
<span id="cb417-7"><a href="functional-elixir.html#cb417-7" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>The above code provides <strong>the same</strong> functionality as the one before with <code>Either</code>. We can clearly understand it <strong>without</strong> any knowledge about how <code>Either</code> works, <code>mapping</code>, <code>flatMapping</code> etc. It’s just standard Elixir.</p>
<p>Again, as in the case of modules’ attributes. Elixir provides a pragmatic way of dealing with errors - just return a tuple with an <code>:error</code> atom. It also provides utility functions like <code>with</code> to deal with errors in an idiomatic way. There’s <strong>no reason</strong> to introduce concepts like <code>Either</code> as language has built-in concepts/patterns taking care of error situations.</p>
</div>
</div>
<div id="do-or-not-to-do" class="section level2 hasAnchor" number="18.8">
<h2><span class="header-section-number">18.8</span> Do or not to do<a href="functional-elixir.html#do-or-not-to-do" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In the last section, we discussed wrapping the results in the <code>Either</code> structs to be able to map, flatMap on them regardless of the function result. What if we could apply the same principle to avoid executing any code(side effects) at all?</p>
<p>That’s the basic idea behind all the category theory related abstractions like the infamous IO Monad.</p>
<p>I won’t go into a vast amount of details. Still, we can think about it as every time we are calling a <em>special</em> <code>map</code> or <code>flatMap</code>, instead of executing anything, it would just wrap whatever was passed to it inside another function and return it like:</p>
<div class="sourceCode" id="cb418"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb418-1"><a href="functional-elixir.html#cb418-1" tabindex="-1"></a>  <span class="kw">def</span> map<span class="fu">(</span>acc, function<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb418-2"><a href="functional-elixir.html#cb418-2" tabindex="-1"></a>    <span class="kw">fn</span> <span class="op">-&gt;</span></span>
<span id="cb418-3"><a href="functional-elixir.html#cb418-3" tabindex="-1"></a>      <span class="kw">case</span> acc<span class="op">.</span><span class="fu">()</span> <span class="kw">do</span></span>
<span id="cb418-4"><a href="functional-elixir.html#cb418-4" tabindex="-1"></a>        <span class="fu">{</span><span class="va">:ok</span>, data<span class="fu">}</span> <span class="op">-&gt;</span> <span class="fu">{</span><span class="va">:ok</span>, function<span class="op">.</span><span class="fu">(</span>data<span class="fu">)}</span></span>
<span id="cb418-5"><a href="functional-elixir.html#cb418-5" tabindex="-1"></a>        <span class="fu">{</span><span class="va">:error</span>, error<span class="fu">}</span> <span class="op">-&gt;</span> <span class="fu">{</span><span class="va">:error</span>, error<span class="fu">}</span></span>
<span id="cb418-6"><a href="functional-elixir.html#cb418-6" tabindex="-1"></a>      <span class="kw">end</span></span>
<span id="cb418-7"><a href="functional-elixir.html#cb418-7" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb418-8"><a href="functional-elixir.html#cb418-8" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>In a nutshell, what we would end up with is a function containing a function containing a function… At this moment, I find it very difficult to find any practical reason why somebody would want to do something like this in a dynamically typed language.</p>
<p>In statically typed languages, there’s an argument that instead of a function of function etc., we could have a typed object which would indicate what actions can be performed on that future result. This is very often praised as a compile-time guarantee of side effectfull code.</p>
<p>In the Elixir, without strong typing and with a massive impact on how the code is written and how easy it is to understand, there’s just <strong>no practical</strong> reason to use those concepts beyond toy programs. The resulting function would be an untestable blob without introspection support from the BEAM VM.</p>
<div style="page-break-after: always;"></div>
</div>
<div id="final-thoughts" class="section level2 hasAnchor" number="18.9">
<h2><span class="header-section-number">18.9</span> Final thoughts<a href="functional-elixir.html#final-thoughts" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Every programming language needs to provide tools to handle common concerns like error handling or dependency injection.</p>
<p>Elixir provides excellent tools to handle both of those concerns using the <code>with</code> statement and modules’ attributes.</p>
<p>Without a type system, there’s no practical reason why anybody would introduce category theory-based abstractions like Monads. The resulting code will be complicated to deal with, and as in the case of many other <strong>functional</strong> programming languages like Ocaml or Clojure, the pragmatic way is to execute side effects.</p>
<p><strong>It’s the developers’ responsibility to design code in a way that maximizes the amount of pure code and push side effects to “the edge”.</strong> The typical pattern would be to “prepare” (group all logic before side effects) or to “post process” the results of multiple side effects (group pure logic after side effects).</p>
<p>That’s all in regards to functional programming in Elixir. In the next chapter, we will look into what the idiomatic Elixir code looks like.</p>
<p>[Note] Please remember to run the <code>mix format</code> to keep things nice and tidy.</p>
<p>The source code for this chapter can be found on <a href="https://github.com/Cinderella-Man/hands-on-elixir-and-otp-cryptocurrency-trading-bot-source-code/tree/chapter_18">GitHub</a></p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="mox-rocks.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="idiomatic-otp.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/Cinderella-Man/hands-on-elixir-and-otp-cryptocurrency-trading-bot/edit/main/18-functional-elixir.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
