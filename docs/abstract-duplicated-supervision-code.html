<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 13 Abstract duplicated supervision code | Create a cryptocurrency trading bot in Elixir</title>
  <meta name="description" content="Chapter 13 Abstract duplicated supervision code | Create a cryptocurrency trading bot in Elixir" />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 13 Abstract duplicated supervision code | Create a cryptocurrency trading bot in Elixir" />
  <meta property="og:type" content="book" />
  
  <meta property="og:image" content="images/cover.png" />
  
  <meta name="github-repo" content="frathon/create-a-cryptocurrency-trading-bot-in-elixir" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 13 Abstract duplicated supervision code | Create a cryptocurrency trading bot in Elixir" />
  
  
  <meta name="twitter:image" content="images/cover.png" />

<meta name="author" content="Kamil Skowron" />


<meta name="date" content="2021-04-19" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="start-stop-shutdown-and-autostart-trading.html"/>
<link rel="next" href="store-trade-events-and-orders-inside-the-database.html"/>
<script src="libs/header-attrs-2.7/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Create a cryptocurrency trading bot in Elixir</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome 👋</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#limit-of-liabilitydisclaimer-of-warranty"><i class="fa fa-check"></i>Limit of Liability/Disclaimer of Warranty</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#contributing-errata"><i class="fa fa-check"></i>Contributing / Errata</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#preface"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#who-this-book-is-for"><i class="fa fa-check"></i>Who this book is for</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#what-this-book-covers"><i class="fa fa-check"></i>What this book covers</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#source-code"><i class="fa fa-check"></i>Source code</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="stream-live-crypto-prices-from-binance-wss.html"><a href="stream-live-crypto-prices-from-binance-wss.html"><i class="fa fa-check"></i><b>1</b> Stream live crypto prices from Binance WSS</a>
<ul>
<li class="chapter" data-level="1.1" data-path="stream-live-crypto-prices-from-binance-wss.html"><a href="stream-live-crypto-prices-from-binance-wss.html#objectives"><i class="fa fa-check"></i><b>1.1</b> Objectives</a></li>
<li class="chapter" data-level="1.2" data-path="stream-live-crypto-prices-from-binance-wss.html"><a href="stream-live-crypto-prices-from-binance-wss.html#create-an-umbrella-app"><i class="fa fa-check"></i><b>1.2</b> Create an umbrella app</a></li>
<li class="chapter" data-level="1.3" data-path="stream-live-crypto-prices-from-binance-wss.html"><a href="stream-live-crypto-prices-from-binance-wss.html#create-a-supervised-application-inside-an-umbrella"><i class="fa fa-check"></i><b>1.3</b> Create a supervised application inside an umbrella</a></li>
<li class="chapter" data-level="1.4" data-path="stream-live-crypto-prices-from-binance-wss.html"><a href="stream-live-crypto-prices-from-binance-wss.html#connect-to-binances-websocket-stream-using-the-websockex-module"><i class="fa fa-check"></i><b>1.4</b> Connect to Binance’s WebSocket Stream using the WebSockex module</a></li>
<li class="chapter" data-level="1.5" data-path="stream-live-crypto-prices-from-binance-wss.html"><a href="stream-live-crypto-prices-from-binance-wss.html#decode-incoming-events-using-the-jason-module"><i class="fa fa-check"></i><b>1.5</b> Decode incoming events using the Jason module</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><i class="fa fa-check"></i><b>2</b> Create a naive trading strategy - a single trader process without supervision</a>
<ul>
<li class="chapter" data-level="2.1" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#objectives-1"><i class="fa fa-check"></i><b>2.1</b> Objectives</a></li>
<li class="chapter" data-level="2.2" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#initializiation"><i class="fa fa-check"></i><b>2.2</b> Initializiation</a></li>
<li class="chapter" data-level="2.3" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#how-trading-strategy-will-work"><i class="fa fa-check"></i><b>2.3</b> How trading strategy will work?</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#implementation-of-the-first-scenario"><i class="fa fa-check"></i><b>2.3.1</b> Implementation of the first scenario</a></li>
<li class="chapter" data-level="2.3.2" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#implementation-of-the-second-scenario"><i class="fa fa-check"></i><b>2.3.2</b> Implementation of the second scenario</a></li>
<li class="chapter" data-level="2.3.3" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#implementation-of-the-third-scenario"><i class="fa fa-check"></i><b>2.3.3</b> Implementation of the third scenario</a></li>
<li class="chapter" data-level="2.3.4" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#implementation-fallback-scenario"><i class="fa fa-check"></i><b>2.3.4</b> Implementation fallback scenario</a></li>
<li class="chapter" data-level="2.3.5" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#updating-the-naive-interface"><i class="fa fa-check"></i><b>2.3.5</b> Updating the Naive interface</a></li>
<li class="chapter" data-level="2.3.6" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#updating-streamer-app"><i class="fa fa-check"></i><b>2.3.6</b> Updating streamer app</a></li>
<li class="chapter" data-level="2.3.7" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#access-details-to-binance"><i class="fa fa-check"></i><b>2.3.7</b> Access details to Binance</a></li>
<li class="chapter" data-level="2.3.8" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#test-run"><i class="fa fa-check"></i><b>2.3.8</b> Test run</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html"><i class="fa fa-check"></i><b>3</b> Introduce PubSub as a communication method</a>
<ul>
<li class="chapter" data-level="3.1" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html#objectives-2"><i class="fa fa-check"></i><b>3.1</b> Objectives</a></li>
<li class="chapter" data-level="3.2" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html#design"><i class="fa fa-check"></i><b>3.2</b> Design</a></li>
<li class="chapter" data-level="3.3" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html#implementation"><i class="fa fa-check"></i><b>3.3</b> Implementation</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html"><i class="fa fa-check"></i><b>4</b> Mock the Binance API</a>
<ul>
<li class="chapter" data-level="4.1" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#objectives-3"><i class="fa fa-check"></i><b>4.1</b> Objectives</a></li>
<li class="chapter" data-level="4.2" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#design-1"><i class="fa fa-check"></i><b>4.2</b> Design</a></li>
<li class="chapter" data-level="4.3" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#create-binancemock-app"><i class="fa fa-check"></i><b>4.3</b> Create “BinanceMock” app</a></li>
<li class="chapter" data-level="4.4" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-getting-exchange-info"><i class="fa fa-check"></i><b>4.4</b> Implement getting exchange info</a></li>
<li class="chapter" data-level="4.5" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-placing-buy-and-sell-orders"><i class="fa fa-check"></i><b>4.5</b> Implement placing buy and sell orders</a></li>
<li class="chapter" data-level="4.6" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-order-retrival"><i class="fa fa-check"></i><b>4.6</b> Implement order retrival</a></li>
<li class="chapter" data-level="4.7" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-callback-for-incoming-trade-events"><i class="fa fa-check"></i><b>4.7</b> Implement callback for incoming trade events</a></li>
<li class="chapter" data-level="4.8" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#upgrade-trader-and-config"><i class="fa fa-check"></i><b>4.8</b> Upgrade trader and config</a></li>
<li class="chapter" data-level="4.9" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#test-the-implementation"><i class="fa fa-check"></i><b>4.9</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html"><i class="fa fa-check"></i><b>5</b> Enable parallel trading on multiple symbols</a>
<ul>
<li class="chapter" data-level="5.1" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#objectives-4"><i class="fa fa-check"></i><b>5.1</b> Objectives</a></li>
<li class="chapter" data-level="5.2" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#introduction---architectural-design"><i class="fa fa-check"></i><b>5.2</b> Introduction - architectural design</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#update-application-supervisor"><i class="fa fa-check"></i><b>5.2.1</b> Update application supervisor</a></li>
<li class="chapter" data-level="5.2.2" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#add-interface-method"><i class="fa fa-check"></i><b>5.2.2</b> Add interface method</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#implement-naive.symbolsupervisor"><i class="fa fa-check"></i><b>5.3</b> Implement <code>Naive.SymbolSupervisor</code></a></li>
<li class="chapter" data-level="5.4" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#implement-naive.leader"><i class="fa fa-check"></i><b>5.4</b> Implement <code>Naive.Leader</code></a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#updating-the-leader-module"><i class="fa fa-check"></i><b>5.4.1</b> Updating the <code>leader</code> module</a></li>
<li class="chapter" data-level="5.4.2" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#updating-the-naive.trader-module"><i class="fa fa-check"></i><b>5.4.2</b> Updating the <code>Naive.Trader</code> module</a></li>
<li class="chapter" data-level="5.4.3" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#finalizing-naive.leader-implementation"><i class="fa fa-check"></i><b>5.4.3</b> Finalizing <code>Naive.Leader</code> implementation</a></li>
<li class="chapter" data-level="5.4.4" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#iex-testing"><i class="fa fa-check"></i><b>5.4.4</b> IEx testing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><a href="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><i class="fa fa-check"></i><b>6</b> # Chapter 6 - Introduce a <code>buy_down_interval</code> to make a single trader more profitable</a>
<ul>
<li class="chapter" data-level="6.1" data-path="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><a href="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html#objectives-5"><i class="fa fa-check"></i><b>6.1</b> Objectives</a></li>
<li class="chapter" data-level="6.2" data-path="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><a href="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html#why-we-need-to-buy-below-the-current-price-feature-overview"><i class="fa fa-check"></i><b>6.2</b> Why we need to buy below the current price? Feature overview</a></li>
<li class="chapter" data-level="6.3" data-path="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><a href="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html#naive.trader-implementation"><i class="fa fa-check"></i><b>6.3</b> <code>Naive.Trader</code> implementation</a></li>
<li class="chapter" data-level="6.4" data-path="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><a href="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html#naive.leader-implementation"><i class="fa fa-check"></i><b>6.4</b> <code>Naive.Leader</code> implementation</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><a href="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html#iex-testing-1"><i class="fa fa-check"></i><b>6.4.1</b> IEx testing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html"><i class="fa fa-check"></i><b>7</b> Introduce a trader budget and calculating the quantity</a>
<ul>
<li class="chapter" data-level="7.1" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#objectives-6"><i class="fa fa-check"></i><b>7.1</b> Objectives</a></li>
<li class="chapter" data-level="7.2" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#fetch-step_size"><i class="fa fa-check"></i><b>7.2</b> Fetch <code>step_size</code></a></li>
<li class="chapter" data-level="7.3" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#append-budget-and-step_size-to-the-traders-state-inside-the-leader"><i class="fa fa-check"></i><b>7.3</b> Append <code>budget</code> and <code>step_size</code> to the <code>Trader</code>’s state inside the <code>Leader</code></a></li>
<li class="chapter" data-level="7.4" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#append-budget-and-step_size-to-the-traders-state"><i class="fa fa-check"></i><b>7.4</b> Append <code>budget</code> and <code>step_size</code> to the <code>Trader</code>’s state</a></li>
<li class="chapter" data-level="7.5" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#calculate-quantity"><i class="fa fa-check"></i><b>7.5</b> Calculate quantity</a>
<ul>
<li class="chapter" data-level="7.5.1" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#iex-testing-2"><i class="fa fa-check"></i><b>7.5.1</b> IEx testing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html"><i class="fa fa-check"></i><b>8</b> Add support for multiple transactions per order</a>
<ul>
<li class="chapter" data-level="8.1" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#objectives-7"><i class="fa fa-check"></i><b>8.1</b> Objectives</a></li>
<li class="chapter" data-level="8.2" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#issue-with-the-current-implementation"><i class="fa fa-check"></i><b>8.2</b> Issue with the current implementation</a></li>
<li class="chapter" data-level="8.3" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#improve-buy-order-filled-callback"><i class="fa fa-check"></i><b>8.3</b> Improve buy order filled callback</a></li>
<li class="chapter" data-level="8.4" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#implement-buy-order-filled-callback"><i class="fa fa-check"></i><b>8.4</b> Implement buy order “filled” callback</a></li>
<li class="chapter" data-level="8.5" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#improve-sell-order-callback"><i class="fa fa-check"></i><b>8.5</b> Improve sell order callback</a></li>
<li class="chapter" data-level="8.6" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#test-the-implementation-1"><i class="fa fa-check"></i><b>8.6</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html"><i class="fa fa-check"></i><b>9</b> Run multiple traders in parallel</a>
<ul>
<li class="chapter" data-level="9.1" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#objectives-8"><i class="fa fa-check"></i><b>9.1</b> Objectives</a></li>
<li class="chapter" data-level="9.2" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#describe-and-design-the-required-functionality"><i class="fa fa-check"></i><b>9.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="9.3" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#implement-rebuy-inside-naive.trader"><i class="fa fa-check"></i><b>9.3</b> Implement rebuy inside <code>Naive.Trader</code></a></li>
<li class="chapter" data-level="9.4" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#implement-rebuy-in-the-naive.leader"><i class="fa fa-check"></i><b>9.4</b> Implement rebuy in the <code>Naive.Leader</code></a></li>
<li class="chapter" data-level="9.5" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#improve-logs-by-assigning-ids-to-traders"><i class="fa fa-check"></i><b>9.5</b> Improve logs by assigning ids to traders</a></li>
<li class="chapter" data-level="9.6" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#test-the-implementation-2"><i class="fa fa-check"></i><b>9.6</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html"><i class="fa fa-check"></i><b>10</b> Fine-tune trading strategy per symbol</a>
<ul>
<li class="chapter" data-level="10.1" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#objectives-9"><i class="fa fa-check"></i><b>10.1</b> Objectives</a></li>
<li class="chapter" data-level="10.2" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#describe-and-design-the-required-functionality-1"><i class="fa fa-check"></i><b>10.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="10.3" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#add-docker-to-project"><i class="fa fa-check"></i><b>10.3</b> Add docker to project</a></li>
<li class="chapter" data-level="10.4" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#set-up-ecto-inside-the-naive-app"><i class="fa fa-check"></i><b>10.4</b> Set up <code>ecto</code> inside the <code>naive</code> app</a></li>
<li class="chapter" data-level="10.5" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#create-and-migrate-the-db"><i class="fa fa-check"></i><b>10.5</b> Create and migrate the DB</a></li>
<li class="chapter" data-level="10.6" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#seed-symbols-settings"><i class="fa fa-check"></i><b>10.6</b> Seed symbols’ settings</a></li>
<li class="chapter" data-level="10.7" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#update-the-naive.leader-to-fetch-settings"><i class="fa fa-check"></i><b>10.7</b> Update the <code>Naive.Leader</code> to fetch settings</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html"><i class="fa fa-check"></i><b>11</b> Supervise and autostart streaming</a>
<ul>
<li class="chapter" data-level="11.1" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#objectives-10"><i class="fa fa-check"></i><b>11.1</b> Objectives</a></li>
<li class="chapter" data-level="11.2" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#describe-and-design-the-required-functionality-2"><i class="fa fa-check"></i><b>11.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="11.3" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#register-the-streamer.binance-processes-with-names"><i class="fa fa-check"></i><b>11.3</b> Register the <code>Streamer.Binance</code> processes with names</a></li>
<li class="chapter" data-level="11.4" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#set-up-ecto-inside-the-streamer-app"><i class="fa fa-check"></i><b>11.4</b> Set up <code>ecto</code> inside the <code>streamer</code> app</a></li>
<li class="chapter" data-level="11.5" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#create-and-migrate-the-db-1"><i class="fa fa-check"></i><b>11.5</b> Create and migrate the db</a></li>
<li class="chapter" data-level="11.6" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#seed-default-settings"><i class="fa fa-check"></i><b>11.6</b> Seed default settings</a></li>
<li class="chapter" data-level="11.7" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#implement-the-supervision-tree-and-start-streaming-functionality"><i class="fa fa-check"></i><b>11.7</b> Implement the supervision tree and start streaming functionality</a></li>
<li class="chapter" data-level="11.8" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#implement-the-stop-functionality"><i class="fa fa-check"></i><b>11.8</b> Implement the stop functionality</a></li>
<li class="chapter" data-level="11.9" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#implement-the-autostart-streaming-functionality"><i class="fa fa-check"></i><b>11.9</b> Implement the autostart streaming functionality</a></li>
<li class="chapter" data-level="11.10" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#test-the-implementation-3"><i class="fa fa-check"></i><b>11.10</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html"><i class="fa fa-check"></i><b>12</b> Start, stop, shutdown and autostart trading</a>
<ul>
<li class="chapter" data-level="12.1" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#objectives-11"><i class="fa fa-check"></i><b>12.1</b> Objectives</a></li>
<li class="chapter" data-level="12.2" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#describe-and-design-the-required-functionality-3"><i class="fa fa-check"></i><b>12.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="12.3" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#re-implement-the-start-trading-functionality"><i class="fa fa-check"></i><b>12.3</b> (Re-)Implement the start trading functionality</a></li>
<li class="chapter" data-level="12.4" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#implement-the-stop-trading-functionality"><i class="fa fa-check"></i><b>12.4</b> Implement the stop trading functionality</a></li>
<li class="chapter" data-level="12.5" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#implement-the-autostart-trading-functionality"><i class="fa fa-check"></i><b>12.5</b> Implement the autostart trading functionality</a></li>
<li class="chapter" data-level="12.6" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#implement-the-shutdown-trading-functionality"><i class="fa fa-check"></i><b>12.6</b> Implement the shutdown trading functionality</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html"><i class="fa fa-check"></i><b>13</b> Abstract duplicated supervision code</a>
<ul>
<li class="chapter" data-level="13.1" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#objectives-12"><i class="fa fa-check"></i><b>13.1</b> Objectives</a></li>
<li class="chapter" data-level="13.2" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#overview-of-requirements"><i class="fa fa-check"></i><b>13.2</b> Overview of requirements</a></li>
<li class="chapter" data-level="13.3" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#pseudo-generalize-core.servicesupervisor-module"><i class="fa fa-check"></i><b>13.3</b> Pseudo generalize Core.ServiceSupervisor module</a></li>
<li class="chapter" data-level="13.4" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#utilize-pseudo-generalized-code-inside-the-naive.dynamicsymbolsupervisor"><i class="fa fa-check"></i><b>13.4</b> Utilize pseudo generalized code inside the <code>Naive.DynamicSymbolSupervisor</code></a></li>
<li class="chapter" data-level="13.5" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#implement-a-truly-generic-core.servicesupervisor"><i class="fa fa-check"></i><b>13.5</b> Implement a truly generic <code>Core.ServiceSupervisor</code></a>
<ul>
<li class="chapter" data-level="13.5.1" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#first-path-starting-with-the-fetch_symbols_to_start0-function"><i class="fa fa-check"></i><b>13.5.1</b> First path starting with the <code>fetch_symbols_to_start/0</code> function</a></li>
<li class="chapter" data-level="13.5.2" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#second-path-starting-with-the-update_status2"><i class="fa fa-check"></i><b>13.5.2</b> Second path starting with the <code>update_status/2</code></a></li>
<li class="chapter" data-level="13.5.3" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#third-path-starting-with-the-get_pid1-function"><i class="fa fa-check"></i><b>13.5.3</b> Third path starting with the <code>get_pid/1</code> function</a></li>
</ul></li>
<li class="chapter" data-level="13.6" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#remove-boilerplate-using-use-macro"><i class="fa fa-check"></i><b>13.6</b> Remove boilerplate using <code>use</code> macro</a></li>
<li class="chapter" data-level="13.7" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#use-the-core.servicesupervisor-module-inside-the-streamer-application"><i class="fa fa-check"></i><b>13.7</b> Use the <code>Core.ServiceSupervisor</code> module inside the <code>streamer</code> application</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html"><i class="fa fa-check"></i><b>14</b> Store trade events and orders inside the database</a>
<ul>
<li class="chapter" data-level="14.1" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#objectives-13"><i class="fa fa-check"></i><b>14.1</b> Objectives</a></li>
<li class="chapter" data-level="14.2" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#overview-of-requirements-1"><i class="fa fa-check"></i><b>14.2</b> Overview of requirements</a></li>
<li class="chapter" data-level="14.3" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-a-new-data_warehouse-application-in-the-umbrella"><i class="fa fa-check"></i><b>14.3</b> Create a new <code>data_warehouse</code> application in the umbrella</a></li>
<li class="chapter" data-level="14.4" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#connect-to-the-database-using-ecto"><i class="fa fa-check"></i><b>14.4</b> Connect to the database using Ecto</a></li>
<li class="chapter" data-level="14.5" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#store-trade-events-data"><i class="fa fa-check"></i><b>14.5</b> Store trade events’ data</a></li>
<li class="chapter" data-level="14.6" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#store-orders-data"><i class="fa fa-check"></i><b>14.6</b> Store orders’ data</a></li>
<li class="chapter" data-level="14.7" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#implement-supervision"><i class="fa fa-check"></i><b>14.7</b> Implement supervision</a>
<ul>
<li class="chapter" data-level="14.7.1" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-subscriber_settings-table"><i class="fa fa-check"></i><b>14.7.1</b> Create <code>subscriber_settings</code> table</a></li>
<li class="chapter" data-level="14.7.2" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#redesign-supervision-using-registry"><i class="fa fa-check"></i><b>14.7.2</b> Redesign supervision using Registry</a></li>
<li class="chapter" data-level="14.7.3" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-the-datawarehouse.subscriber.dynamicsupervisor-module"><i class="fa fa-check"></i><b>14.7.3</b> Create the <code>DataWarehouse.Subscriber.DynamicSupervisor</code> module</a></li>
<li class="chapter" data-level="14.7.4" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#register-worker-processes-using-via"><i class="fa fa-check"></i><b>14.7.4</b> Register Worker processes using :via</a></li>
<li class="chapter" data-level="14.7.5" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-a-new-supervision-level-for-registry-task-and-the-dynamicsupervisor"><i class="fa fa-check"></i><b>14.7.5</b> Create a new supervision level for Registry, Task and the DynamicSupervisor</a></li>
<li class="chapter" data-level="14.7.6" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#link-the-subscribersupervisor-to-the-application"><i class="fa fa-check"></i><b>14.7.6</b> Link the <code>SubscriberSupervisor</code> to the <code>Application</code></a></li>
<li class="chapter" data-level="14.7.7" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#add-interface"><i class="fa fa-check"></i><b>14.7.7</b> Add interface</a></li>
<li class="chapter" data-level="14.7.8" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#test"><i class="fa fa-check"></i><b>14.7.8</b> Test</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="15" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html"><i class="fa fa-check"></i><b>15</b> Backtest trading strategy</a>
<ul>
<li class="chapter" data-level="15.1" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#objectives-14"><i class="fa fa-check"></i><b>15.1</b> Objectives</a></li>
<li class="chapter" data-level="15.2" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#overview-of-requirements-2"><i class="fa fa-check"></i><b>15.2</b> Overview of requirements</a></li>
<li class="chapter" data-level="15.3" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#implement-the-storing-task"><i class="fa fa-check"></i><b>15.3</b> Implement the storing task</a></li>
<li class="chapter" data-level="15.4" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#test-the-backtesting"><i class="fa fa-check"></i><b>15.4</b> Test the backtesting</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://www.bookdown.org/" target="blank">Created with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Create a cryptocurrency trading bot in Elixir</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="abstract-duplicated-supervision-code" class="section level1" number="13">
<h1><span class="header-section-number">Chapter 13</span> Abstract duplicated supervision code</h1>
<div id="objectives-12" class="section level2" number="13.1">
<h2><span class="header-section-number">13.1</span> Objectives</h2>
<ul>
<li>overview of requirements</li>
<li>pseudo generalize <code>Core.ServiceSupervisor</code> module</li>
<li>utilize pseudo generalized code inside the <code>Naive.DynamicSymbolSupervisor</code></li>
<li>implement a truly generic <code>Core.ServiceSupervisor</code></li>
<li>use the <code>Core.ServiceSupervisor</code> module inside the <code>streamer</code> application</li>
</ul>
</div>
<div id="overview-of-requirements" class="section level2" number="13.2">
<h2><span class="header-section-number">13.2</span> Overview of requirements</h2>
<p>In the last few chapters, we went through adding and modifying the dynamic supervision tree around the <code>naive</code> and <code>streamer</code> applications’ workers. Initially, we just copied the implementation from the <code>streamer</code> application to the <code>naive</code> application (with a few minor tweaks like log messages). That wasn’t the most sophisticated solution and we will address this copy-paste pattern in this chapter.</p>
<p>We will write an “extension” of the <code>DynamicSupervisor</code> that allows to start, stop and autostart workers. Just to keep things simple we will create a new application inside our umbrella project where we will place the logic. This will save us from creating a new repo for time being.</p>
<p>Our new <code>Core.ServiceSupervisor</code> module will hold all the logic responsible for starting, stopping, and autostarting worker processes. To limit the boilerplate inside the implementation modules (like <code>Naive.DynamicSymbolSupervisor</code> or <code>Streamer.DynamicStreamerSupervisor</code>) we will utilize the <code>use</code> macro that will dynamically generate low-level wiring for us.</p>
</div>
<div id="pseudo-generalize-core.servicesupervisor-module" class="section level2" number="13.3">
<h2><span class="header-section-number">13.3</span> Pseudo generalize Core.ServiceSupervisor module</h2>
<p>Let’s start by creating a new <em>non supervised</em> application called <code>core</code> inside our umbrella project. At this moment our “abstraction code” will sit inside it just to keep things simple as otherwise, we would need to create a new repo and jump between codebases which we will avoid for time being:</p>
<div class="sourceCode" id="cb204"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb204-1"><a href="abstract-duplicated-supervision-code.html#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cd apps</span>
<span id="cb204-2"><a href="abstract-duplicated-supervision-code.html#cb204-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> mix new core</span>
<span id="cb204-3"><a href="abstract-duplicated-supervision-code.html#cb204-3" aria-hidden="true" tabindex="-1"></a><span class="ex">*</span> creating README.md</span>
<span id="cb204-4"><a href="abstract-duplicated-supervision-code.html#cb204-4" aria-hidden="true" tabindex="-1"></a><span class="ex">*</span> creating .formatter.exs</span>
<span id="cb204-5"><a href="abstract-duplicated-supervision-code.html#cb204-5" aria-hidden="true" tabindex="-1"></a><span class="ex">*</span> creating .gitignore</span>
<span id="cb204-6"><a href="abstract-duplicated-supervision-code.html#cb204-6" aria-hidden="true" tabindex="-1"></a><span class="ex">*</span> creating mix.exs</span>
<span id="cb204-7"><a href="abstract-duplicated-supervision-code.html#cb204-7" aria-hidden="true" tabindex="-1"></a><span class="ex">*</span> creating lib</span>
<span id="cb204-8"><a href="abstract-duplicated-supervision-code.html#cb204-8" aria-hidden="true" tabindex="-1"></a><span class="ex">*</span> creating lib/core.ex</span>
<span id="cb204-9"><a href="abstract-duplicated-supervision-code.html#cb204-9" aria-hidden="true" tabindex="-1"></a><span class="ex">*</span> creating test</span>
<span id="cb204-10"><a href="abstract-duplicated-supervision-code.html#cb204-10" aria-hidden="true" tabindex="-1"></a><span class="ex">*</span> creating test/test_helper.exs</span>
<span id="cb204-11"><a href="abstract-duplicated-supervision-code.html#cb204-11" aria-hidden="true" tabindex="-1"></a><span class="ex">*</span> creating test/core_test.exs</span>
<span id="cb204-12"><a href="abstract-duplicated-supervision-code.html#cb204-12" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span></code></pre></div>
<p>We can now create a new directory called <code>core</code> inside the <code>apps/core/lib</code> directory and a new file called <code>service_supervisor.ex</code> inside it where we will put all abstracted starting/stopping/autostarting logic.</p>
<p>Let’s start with an empty module:</p>
<div class="sourceCode" id="cb205"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb205-1"><a href="abstract-duplicated-supervision-code.html#cb205-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/core/lib/core/service_supervisor.ex</span></span>
<span id="cb205-2"><a href="abstract-duplicated-supervision-code.html#cb205-2" aria-hidden="true" tabindex="-1"></a><span class="kw">defmodule</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span> <span class="kw">do</span></span>
<span id="cb205-3"><a href="abstract-duplicated-supervision-code.html#cb205-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-4"><a href="abstract-duplicated-supervision-code.html#cb205-4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<p>The first step in our refactoring process will be to move(cut) all of the functions from the <code>Naive.DynamicSymbolSupervisor</code> (excluding the <code>start_link/1</code>, <code>init/1</code> and <code>shutdown_trading/1</code>) and put them inside the <code>Core.ServiceSupervisor</code> module which should look as follows:</p>
<div class="sourceCode" id="cb206"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb206-1"><a href="abstract-duplicated-supervision-code.html#cb206-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/core/lib/core/service_supervisor.ex</span></span>
<span id="cb206-2"><a href="abstract-duplicated-supervision-code.html#cb206-2" aria-hidden="true" tabindex="-1"></a><span class="kw">defmodule</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span> <span class="kw">do</span></span>
<span id="cb206-3"><a href="abstract-duplicated-supervision-code.html#cb206-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-4"><a href="abstract-duplicated-supervision-code.html#cb206-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> autostart_trading() <span class="kw">do</span></span>
<span id="cb206-5"><a href="abstract-duplicated-supervision-code.html#cb206-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb206-6"><a href="abstract-duplicated-supervision-code.html#cb206-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb206-7"><a href="abstract-duplicated-supervision-code.html#cb206-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-8"><a href="abstract-duplicated-supervision-code.html#cb206-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> start_trading(symbol) <span class="kw">when</span> is_binary(symbol) <span class="kw">do</span></span>
<span id="cb206-9"><a href="abstract-duplicated-supervision-code.html#cb206-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb206-10"><a href="abstract-duplicated-supervision-code.html#cb206-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb206-11"><a href="abstract-duplicated-supervision-code.html#cb206-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-12"><a href="abstract-duplicated-supervision-code.html#cb206-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> stop_trading(symbol) <span class="kw">when</span> is_binary(symbol) <span class="kw">do</span></span>
<span id="cb206-13"><a href="abstract-duplicated-supervision-code.html#cb206-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb206-14"><a href="abstract-duplicated-supervision-code.html#cb206-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb206-15"><a href="abstract-duplicated-supervision-code.html#cb206-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-16"><a href="abstract-duplicated-supervision-code.html#cb206-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defp</span> get_pid(symbol) <span class="kw">do</span></span>
<span id="cb206-17"><a href="abstract-duplicated-supervision-code.html#cb206-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb206-18"><a href="abstract-duplicated-supervision-code.html#cb206-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb206-19"><a href="abstract-duplicated-supervision-code.html#cb206-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-20"><a href="abstract-duplicated-supervision-code.html#cb206-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defp</span> update_trading_status(symbol, status)</span>
<span id="cb206-21"><a href="abstract-duplicated-supervision-code.html#cb206-21" aria-hidden="true" tabindex="-1"></a>       <span class="kw">when</span> is_binary(symbol) <span class="kw">and</span> is_binary(status) <span class="kw">do</span></span>
<span id="cb206-22"><a href="abstract-duplicated-supervision-code.html#cb206-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb206-23"><a href="abstract-duplicated-supervision-code.html#cb206-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb206-24"><a href="abstract-duplicated-supervision-code.html#cb206-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-25"><a href="abstract-duplicated-supervision-code.html#cb206-25" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defp</span> start_symbol_supervisor(symbol) <span class="kw">do</span></span>
<span id="cb206-26"><a href="abstract-duplicated-supervision-code.html#cb206-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb206-27"><a href="abstract-duplicated-supervision-code.html#cb206-27" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb206-28"><a href="abstract-duplicated-supervision-code.html#cb206-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-29"><a href="abstract-duplicated-supervision-code.html#cb206-29" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defp</span> fetch_symbols_to_trade() <span class="kw">do</span></span>
<span id="cb206-30"><a href="abstract-duplicated-supervision-code.html#cb206-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb206-31"><a href="abstract-duplicated-supervision-code.html#cb206-31" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb206-32"><a href="abstract-duplicated-supervision-code.html#cb206-32" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<p>All of the above code is <code>trading</code> related - we need to rename functions/logs to be more generic.</p>
<p>Starting with <code>autostart_trading/0</code> we can rename it to <code>autostart_workers/0</code>:</p>
<div class="sourceCode" id="cb207"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb207-1"><a href="abstract-duplicated-supervision-code.html#cb207-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/core/lib/core/service_supervisor.ex</span></span>
<span id="cb207-2"><a href="abstract-duplicated-supervision-code.html#cb207-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb207-3"><a href="abstract-duplicated-supervision-code.html#cb207-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> autostart_workers() <span class="kw">do</span>     <span class="co"># &lt;= updated function name</span></span>
<span id="cb207-4"><a href="abstract-duplicated-supervision-code.html#cb207-4" aria-hidden="true" tabindex="-1"></a>    fetch_symbols_to_start()     <span class="co"># &lt;= updated function name</span></span>
<span id="cb207-5"><a href="abstract-duplicated-supervision-code.html#cb207-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">|&gt;</span> <span class="cn">Enum</span><span class="op">.</span>map(<span class="op">&amp;</span>start_worker<span class="op">/</span><span class="dv">1</span>) <span class="co"># &lt;= updated function name</span></span>
<span id="cb207-6"><a href="abstract-duplicated-supervision-code.html#cb207-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb207-7"><a href="abstract-duplicated-supervision-code.html#cb207-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span></code></pre></div>
<p>As we updated two functions inside the <code>autostart_workers/0</code> we need to update their implementations.</p>
<p>The <code>start_trading/1</code> will become <code>start_worker/1</code>, internally we will inline the <code>start_symbol_supervisor/1</code> function(move it’s contents inside the <code>start_worker/1</code> function and remove the <code>start_symbol_supervisor/1</code> function) as it’s used just once inside this module as well as <code>update_trading_status/2</code> need to be renamed to <code>update_status/2</code>.</p>
<p>The <code>fetch_symbols_to_trade/0</code> will get updated to <code>fetch_symbols_to_start/0</code>:</p>
<div class="sourceCode" id="cb208"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb208-1"><a href="abstract-duplicated-supervision-code.html#cb208-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/core/lib/core/service_supervisor.ex</span></span>
<span id="cb208-2"><a href="abstract-duplicated-supervision-code.html#cb208-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> start_worker(symbol) <span class="kw">when</span> is_binary(symbol) <span class="kw">do</span> <span class="co"># &lt;= updated name</span></span>
<span id="cb208-3"><a href="abstract-duplicated-supervision-code.html#cb208-3" aria-hidden="true" tabindex="-1"></a>    symbol <span class="op">=</span> <span class="cn">String</span><span class="op">.</span>upcase(symbol)</span>
<span id="cb208-4"><a href="abstract-duplicated-supervision-code.html#cb208-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-5"><a href="abstract-duplicated-supervision-code.html#cb208-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">case</span> get_pid(symbol) <span class="kw">do</span></span>
<span id="cb208-6"><a href="abstract-duplicated-supervision-code.html#cb208-6" aria-hidden="true" tabindex="-1"></a>      <span class="cn">nil</span> <span class="op">-&gt;</span></span>
<span id="cb208-7"><a href="abstract-duplicated-supervision-code.html#cb208-7" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Logger</span><span class="op">.</span>info(<span class="st">&quot;Starting trading of </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st">&quot;</span>)</span>
<span id="cb208-8"><a href="abstract-duplicated-supervision-code.html#cb208-8" aria-hidden="true" tabindex="-1"></a>        {<span class="va">:ok</span>, _settings} <span class="op">=</span> update_status(symbol, <span class="st">&quot;on&quot;</span>) <span class="co"># &lt;= updated name</span></span>
<span id="cb208-9"><a href="abstract-duplicated-supervision-code.html#cb208-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-10"><a href="abstract-duplicated-supervision-code.html#cb208-10" aria-hidden="true" tabindex="-1"></a>        {<span class="va">:ok</span>, _pid} <span class="op">=</span></span>
<span id="cb208-11"><a href="abstract-duplicated-supervision-code.html#cb208-11" aria-hidden="true" tabindex="-1"></a>          <span class="cn">DynamicSupervisor</span><span class="op">.</span>start_child(</span>
<span id="cb208-12"><a href="abstract-duplicated-supervision-code.html#cb208-12" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Naive</span><span class="op">.</span><span class="cn">DynamicSymbolSupervisor</span>,</span>
<span id="cb208-13"><a href="abstract-duplicated-supervision-code.html#cb208-13" aria-hidden="true" tabindex="-1"></a>            {<span class="cn">Naive</span><span class="op">.</span><span class="cn">SymbolSupervisor</span>, symbol}</span>
<span id="cb208-14"><a href="abstract-duplicated-supervision-code.html#cb208-14" aria-hidden="true" tabindex="-1"></a>          )  <span class="co"># ^^^^^^ inlined `start_symbol_supervisor/1`</span></span>
<span id="cb208-15"><a href="abstract-duplicated-supervision-code.html#cb208-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-16"><a href="abstract-duplicated-supervision-code.html#cb208-16" aria-hidden="true" tabindex="-1"></a>      pid <span class="op">-&gt;</span></span>
<span id="cb208-17"><a href="abstract-duplicated-supervision-code.html#cb208-17" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Logger</span><span class="op">.</span>warn(<span class="st">&quot;Trading on </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st"> already started&quot;</span>)</span>
<span id="cb208-18"><a href="abstract-duplicated-supervision-code.html#cb208-18" aria-hidden="true" tabindex="-1"></a>        {<span class="va">:ok</span>, _settings} <span class="op">=</span> update_status(symbol, <span class="st">&quot;on&quot;</span>) <span class="co"># &lt;= updated name</span></span>
<span id="cb208-19"><a href="abstract-duplicated-supervision-code.html#cb208-19" aria-hidden="true" tabindex="-1"></a>        {<span class="va">:ok</span>, pid}</span>
<span id="cb208-20"><a href="abstract-duplicated-supervision-code.html#cb208-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb208-21"><a href="abstract-duplicated-supervision-code.html#cb208-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb208-22"><a href="abstract-duplicated-supervision-code.html#cb208-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-23"><a href="abstract-duplicated-supervision-code.html#cb208-23" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb208-24"><a href="abstract-duplicated-supervision-code.html#cb208-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-25"><a href="abstract-duplicated-supervision-code.html#cb208-25" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defp</span> fetch_symbols_to_start() <span class="kw">do</span> <span class="co"># &lt;= updated name</span></span>
<span id="cb208-26"><a href="abstract-duplicated-supervision-code.html#cb208-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb208-27"><a href="abstract-duplicated-supervision-code.html#cb208-27" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span>  </span></code></pre></div>
<p>Inside the above code we updated the <code>update_trading_status/2</code> call to <code>update_status/2</code> so we need to update the function header to match:</p>
<div class="sourceCode" id="cb209"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb209-1"><a href="abstract-duplicated-supervision-code.html#cb209-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/core/lib/core/service_supervisor.ex</span></span>
<span id="cb209-2"><a href="abstract-duplicated-supervision-code.html#cb209-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defp</span> update_status(symbol, status) <span class="co"># &lt;= updated name</span></span>
<span id="cb209-3"><a href="abstract-duplicated-supervision-code.html#cb209-3" aria-hidden="true" tabindex="-1"></a>      <span class="kw">when</span> is_binary(symbol) <span class="kw">and</span> is_binary(status) <span class="kw">do</span></span>
<span id="cb209-4"><a href="abstract-duplicated-supervision-code.html#cb209-4" aria-hidden="true" tabindex="-1"></a>     <span class="op">...</span></span>
<span id="cb209-5"><a href="abstract-duplicated-supervision-code.html#cb209-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>Last function to rename in this module will be the <code>stop_trading/1</code> to <code>stop_worker/1</code>, we also need to update calls to <code>update_trading_status/2</code> to <code>update_status/2</code> as it was renamed:</p>
<div class="sourceCode" id="cb210"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb210-1"><a href="abstract-duplicated-supervision-code.html#cb210-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/core/lib/core/service_supervisor.ex</span></span>
<span id="cb210-2"><a href="abstract-duplicated-supervision-code.html#cb210-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> stop_worker(symbol) <span class="kw">when</span> is_binary(symbol) <span class="kw">do</span> <span class="co"># &lt;= updated name</span></span>
<span id="cb210-3"><a href="abstract-duplicated-supervision-code.html#cb210-3" aria-hidden="true" tabindex="-1"></a>    symbol <span class="op">=</span> <span class="cn">String</span><span class="op">.</span>upcase(symbol)</span>
<span id="cb210-4"><a href="abstract-duplicated-supervision-code.html#cb210-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-5"><a href="abstract-duplicated-supervision-code.html#cb210-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">case</span> get_pid(symbol) <span class="kw">do</span></span>
<span id="cb210-6"><a href="abstract-duplicated-supervision-code.html#cb210-6" aria-hidden="true" tabindex="-1"></a>      <span class="cn">nil</span> <span class="op">-&gt;</span></span>
<span id="cb210-7"><a href="abstract-duplicated-supervision-code.html#cb210-7" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Logger</span><span class="op">.</span>warn(<span class="st">&quot;Trading on </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st"> already stopped&quot;</span>)</span>
<span id="cb210-8"><a href="abstract-duplicated-supervision-code.html#cb210-8" aria-hidden="true" tabindex="-1"></a>        {<span class="va">:ok</span>, _settings} <span class="op">=</span> update_status(symbol, <span class="st">&quot;off&quot;</span>) <span class="co"># &lt;= updated name</span></span>
<span id="cb210-9"><a href="abstract-duplicated-supervision-code.html#cb210-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-10"><a href="abstract-duplicated-supervision-code.html#cb210-10" aria-hidden="true" tabindex="-1"></a>      pid <span class="op">-&gt;</span></span>
<span id="cb210-11"><a href="abstract-duplicated-supervision-code.html#cb210-11" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Logger</span><span class="op">.</span>info(<span class="st">&quot;Stopping trading of </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st">&quot;</span>)</span>
<span id="cb210-12"><a href="abstract-duplicated-supervision-code.html#cb210-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-13"><a href="abstract-duplicated-supervision-code.html#cb210-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">:ok</span> <span class="op">=</span></span>
<span id="cb210-14"><a href="abstract-duplicated-supervision-code.html#cb210-14" aria-hidden="true" tabindex="-1"></a>          <span class="cn">DynamicSupervisor</span><span class="op">.</span>terminate_child(</span>
<span id="cb210-15"><a href="abstract-duplicated-supervision-code.html#cb210-15" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Naive</span><span class="op">.</span><span class="cn">DynamicSymbolSupervisor</span>,</span>
<span id="cb210-16"><a href="abstract-duplicated-supervision-code.html#cb210-16" aria-hidden="true" tabindex="-1"></a>            pid</span>
<span id="cb210-17"><a href="abstract-duplicated-supervision-code.html#cb210-17" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb210-18"><a href="abstract-duplicated-supervision-code.html#cb210-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-19"><a href="abstract-duplicated-supervision-code.html#cb210-19" aria-hidden="true" tabindex="-1"></a>        {<span class="va">:ok</span>, _settings} <span class="op">=</span> update_status(symbol, <span class="st">&quot;off&quot;</span>) <span class="co"># &lt;= updated name</span></span>
<span id="cb210-20"><a href="abstract-duplicated-supervision-code.html#cb210-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb210-21"><a href="abstract-duplicated-supervision-code.html#cb210-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>At this moment we have a pseudo-generic implementation of <code>start_worker/1</code> and <code>stop_worker/1</code> inside the <code>Core.ServiceSupervisor</code> module. Function names are generic but they still refer to <code>Repo</code>, <code>Settings</code>, and other modules specific to the <code>naive</code> app’s implementation. We are probably in a worse situation than we have been before starting this refactoring ;) but don’t fear this was just the first step on the way to abstract away that starting, stopping and autostarting code.</p>
</div>
<div id="utilize-pseudo-generalized-code-inside-the-naive.dynamicsymbolsupervisor" class="section level2" number="13.4">
<h2><span class="header-section-number">13.4</span> Utilize pseudo generalized code inside the <code>Naive.DynamicSymbolSupervisor</code></h2>
<p>Before we will jump back to the <code>naive</code>’s application modules we need to add the <code>core</code> application the dependencies of the <code>naive</code> application:</p>
<div class="sourceCode" id="cb211"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb211-1"><a href="abstract-duplicated-supervision-code.html#cb211-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/naive/mix.exs</span></span>
<span id="cb211-2"><a href="abstract-duplicated-supervision-code.html#cb211-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defp</span> deps <span class="kw">do</span></span>
<span id="cb211-3"><a href="abstract-duplicated-supervision-code.html#cb211-3" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb211-4"><a href="abstract-duplicated-supervision-code.html#cb211-4" aria-hidden="true" tabindex="-1"></a>      {<span class="va">:binance</span>, <span class="st">&quot;~&gt; 0.7.1&quot;</span>},</span>
<span id="cb211-5"><a href="abstract-duplicated-supervision-code.html#cb211-5" aria-hidden="true" tabindex="-1"></a>      {<span class="va">:binance_mock</span>, <span class="va">in_umbrella:</span> <span class="cn">true</span>},</span>
<span id="cb211-6"><a href="abstract-duplicated-supervision-code.html#cb211-6" aria-hidden="true" tabindex="-1"></a>      {<span class="va">:core</span>, <span class="va">in_umbrella:</span> <span class="cn">true</span>}, <span class="co"># &lt;= core dep added </span></span>
<span id="cb211-7"><a href="abstract-duplicated-supervision-code.html#cb211-7" aria-hidden="true" tabindex="-1"></a>      <span class="op">....</span></span></code></pre></div>
<p>Let’s get back to the <code>Naive.DynamicSymbolSupervisor</code> where we expect functions that we just cut out to exist like <code>start_trading/1</code> or <code>stop_trading/1</code>.</p>
<p>Let’s reimplement more generic versions of those functions as just simple calls to the <code>Core.ServiceSupervisor</code> module:</p>
<div class="sourceCode" id="cb212"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb212-1"><a href="abstract-duplicated-supervision-code.html#cb212-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/naive/lib/naive/dynamic_symbol_supervisor.ex</span></span>
<span id="cb212-2"><a href="abstract-duplicated-supervision-code.html#cb212-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb212-3"><a href="abstract-duplicated-supervision-code.html#cb212-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> autostart_workers() <span class="kw">do</span></span>
<span id="cb212-4"><a href="abstract-duplicated-supervision-code.html#cb212-4" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span><span class="op">.</span>autostart_workers()</span>
<span id="cb212-5"><a href="abstract-duplicated-supervision-code.html#cb212-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb212-6"><a href="abstract-duplicated-supervision-code.html#cb212-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-7"><a href="abstract-duplicated-supervision-code.html#cb212-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> start_worker(symbol) <span class="kw">do</span></span>
<span id="cb212-8"><a href="abstract-duplicated-supervision-code.html#cb212-8" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span><span class="op">.</span>start_worker(symbol)</span>
<span id="cb212-9"><a href="abstract-duplicated-supervision-code.html#cb212-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb212-10"><a href="abstract-duplicated-supervision-code.html#cb212-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-11"><a href="abstract-duplicated-supervision-code.html#cb212-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> stop_worker(symbol) <span class="kw">do</span></span>
<span id="cb212-12"><a href="abstract-duplicated-supervision-code.html#cb212-12" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span><span class="op">.</span>stop_worker(symbol)</span>
<span id="cb212-13"><a href="abstract-duplicated-supervision-code.html#cb212-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>We also need to update the <code>shutdown_trading/1</code> function as we removed all the private functions that it relies on:</p>
<div class="sourceCode" id="cb213"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb213-1"><a href="abstract-duplicated-supervision-code.html#cb213-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/naive/lib/naive/dynamic_symbol_supervisor.ex</span></span>
<span id="cb213-2"><a href="abstract-duplicated-supervision-code.html#cb213-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> shutdown_worker(symbol) <span class="kw">when</span> is_binary(symbol) <span class="kw">do</span> <span class="co"># &lt;= updated name</span></span>
<span id="cb213-3"><a href="abstract-duplicated-supervision-code.html#cb213-3" aria-hidden="true" tabindex="-1"></a>    symbol <span class="op">=</span> <span class="cn">String</span><span class="op">.</span>upcase(symbol)</span>
<span id="cb213-4"><a href="abstract-duplicated-supervision-code.html#cb213-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-5"><a href="abstract-duplicated-supervision-code.html#cb213-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">case</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span><span class="op">.</span>get_pid(symbol) <span class="kw">do</span> <span class="co"># &lt;= module added</span></span>
<span id="cb213-6"><a href="abstract-duplicated-supervision-code.html#cb213-6" aria-hidden="true" tabindex="-1"></a>      <span class="cn">nil</span> <span class="op">-&gt;</span></span>
<span id="cb213-7"><a href="abstract-duplicated-supervision-code.html#cb213-7" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Logger</span><span class="op">.</span>warn(<span class="st">&quot;Trading on </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st"> already stopped&quot;</span>)</span>
<span id="cb213-8"><a href="abstract-duplicated-supervision-code.html#cb213-8" aria-hidden="true" tabindex="-1"></a>        {<span class="va">:ok</span>, _settings} <span class="op">=</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span><span class="op">.</span>update_status(symbol, <span class="st">&quot;off&quot;</span>) <span class="co"># &lt;= updated name + module</span></span>
<span id="cb213-9"><a href="abstract-duplicated-supervision-code.html#cb213-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-10"><a href="abstract-duplicated-supervision-code.html#cb213-10" aria-hidden="true" tabindex="-1"></a>      _pid <span class="op">-&gt;</span></span>
<span id="cb213-11"><a href="abstract-duplicated-supervision-code.html#cb213-11" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Logger</span><span class="op">.</span>info(<span class="st">&quot;Shutdown of trading on </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st"> initialized&quot;</span>)</span>
<span id="cb213-12"><a href="abstract-duplicated-supervision-code.html#cb213-12" aria-hidden="true" tabindex="-1"></a>        {<span class="va">:ok</span>, settings} <span class="op">=</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span><span class="op">.</span>update_status(symbol, <span class="st">&quot;shutdown&quot;</span>) <span class="co"># &lt;= updated name + module</span></span>
<span id="cb213-13"><a href="abstract-duplicated-supervision-code.html#cb213-13" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Naive</span><span class="op">.</span><span class="cn">Leader</span><span class="op">.</span>notify(<span class="va">:settings_updated</span>, settings)</span>
<span id="cb213-14"><a href="abstract-duplicated-supervision-code.html#cb213-14" aria-hidden="true" tabindex="-1"></a>        {<span class="va">:ok</span>, settings}</span>
<span id="cb213-15"><a href="abstract-duplicated-supervision-code.html#cb213-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb213-16"><a href="abstract-duplicated-supervision-code.html#cb213-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>As we were moving all the private helper functions we didn’t make them public so the <code>Naive.DynamicSymbolSupervisor</code> module can use them - we will fix that now together with temporary aliases/require/imports at the top of the <code>Core.ServiceSupervisor</code>:</p>
<div class="sourceCode" id="cb214"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb214-1"><a href="abstract-duplicated-supervision-code.html#cb214-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/core/lib/core/service_supervisor.ex</span></span>
<span id="cb214-2"><a href="abstract-duplicated-supervision-code.html#cb214-2" aria-hidden="true" tabindex="-1"></a><span class="kw">defmodule</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span> <span class="kw">do</span></span>
<span id="cb214-3"><a href="abstract-duplicated-supervision-code.html#cb214-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-4"><a href="abstract-duplicated-supervision-code.html#cb214-4" aria-hidden="true" tabindex="-1"></a>  <span class="im">require</span> <span class="cn">Logger</span>                     <span class="co"># &lt;= added require</span></span>
<span id="cb214-5"><a href="abstract-duplicated-supervision-code.html#cb214-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-6"><a href="abstract-duplicated-supervision-code.html#cb214-6" aria-hidden="true" tabindex="-1"></a>  <span class="im">import</span> <span class="cn">Ecto</span><span class="op">.</span><span class="cn">Query</span>, <span class="va">only:</span> [<span class="va">from:</span> <span class="dv">2</span>] <span class="co"># &lt;= added import</span></span>
<span id="cb214-7"><a href="abstract-duplicated-supervision-code.html#cb214-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-8"><a href="abstract-duplicated-supervision-code.html#cb214-8" aria-hidden="true" tabindex="-1"></a>  <span class="im">alias</span> <span class="cn">Naive</span><span class="op">.</span><span class="cn">Repo</span>                   <span class="co"># &lt;= added alias</span></span>
<span id="cb214-9"><a href="abstract-duplicated-supervision-code.html#cb214-9" aria-hidden="true" tabindex="-1"></a>  <span class="im">alias</span> <span class="cn">Naive</span><span class="op">.</span><span class="cn">Schema</span><span class="op">.</span><span class="cn">Settings</span>        <span class="co"># &lt;= added alias</span></span>
<span id="cb214-10"><a href="abstract-duplicated-supervision-code.html#cb214-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-11"><a href="abstract-duplicated-supervision-code.html#cb214-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb214-12"><a href="abstract-duplicated-supervision-code.html#cb214-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-13"><a href="abstract-duplicated-supervision-code.html#cb214-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> get_pid(symbol) <span class="kw">do</span> <span class="co"># &lt;= updated from private to public</span></span>
<span id="cb214-14"><a href="abstract-duplicated-supervision-code.html#cb214-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb214-15"><a href="abstract-duplicated-supervision-code.html#cb214-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb214-16"><a href="abstract-duplicated-supervision-code.html#cb214-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-17"><a href="abstract-duplicated-supervision-code.html#cb214-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> update_status(symbol, status) <span class="co"># &lt;= updated from private to public</span></span>
<span id="cb214-18"><a href="abstract-duplicated-supervision-code.html#cb214-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">when</span> is_binary(symbol) <span class="kw">and</span> is_binary(status) <span class="kw">do</span></span>
<span id="cb214-19"><a href="abstract-duplicated-supervision-code.html#cb214-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb214-20"><a href="abstract-duplicated-supervision-code.html#cb214-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>As <code>fetch_symbols_to_start/0</code> is only used internally by the <code>Core.ServiceSupervisor</code> module itself, we don’t need to make it public.</p>
<p>We can also remove the <code>alias</code>es and <code>import</code> from the <code>Naive.DynamicSymbolSupervisor</code> as it won’t need them anymore.</p>
<p>Next step will be to add <code>ecto</code> to the deps of the <code>core</code> application as it will make db queries now:</p>
<div class="sourceCode" id="cb215"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb215-1"><a href="abstract-duplicated-supervision-code.html#cb215-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/core/mix.exs</span></span>
<span id="cb215-2"><a href="abstract-duplicated-supervision-code.html#cb215-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defp</span> deps <span class="kw">do</span></span>
<span id="cb215-3"><a href="abstract-duplicated-supervision-code.html#cb215-3" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb215-4"><a href="abstract-duplicated-supervision-code.html#cb215-4" aria-hidden="true" tabindex="-1"></a>      {<span class="va">:ecto_sql</span>, <span class="st">&quot;~&gt; 3.0&quot;</span>}</span>
<span id="cb215-5"><a href="abstract-duplicated-supervision-code.html#cb215-5" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb215-6"><a href="abstract-duplicated-supervision-code.html#cb215-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>As we modified the interface of the <code>Naive.DynamicSymbolSupervisor</code> (for example renamed <code>start_trading/1</code> to <code>start_worker/1</code> and others) we need to modify the <code>Naive.Supervisor</code>’s children list - more specifically the Task process:</p>
<div class="sourceCode" id="cb216"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb216-1"><a href="abstract-duplicated-supervision-code.html#cb216-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/supervisor.ex</span></span>
<span id="cb216-2"><a href="abstract-duplicated-supervision-code.html#cb216-2" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span></span>
<span id="cb216-3"><a href="abstract-duplicated-supervision-code.html#cb216-3" aria-hidden="true" tabindex="-1"></a>      {<span class="cn">Task</span>,</span>
<span id="cb216-4"><a href="abstract-duplicated-supervision-code.html#cb216-4" aria-hidden="true" tabindex="-1"></a>       <span class="kw">fn</span> <span class="op">-&gt;</span></span>
<span id="cb216-5"><a href="abstract-duplicated-supervision-code.html#cb216-5" aria-hidden="true" tabindex="-1"></a>         <span class="cn">Naive</span><span class="op">.</span><span class="cn">DynamicSymbolSupervisor</span><span class="op">.</span>autostart_workers() <span class="co"># &lt;= func name updated</span></span>
<span id="cb216-6"><a href="abstract-duplicated-supervision-code.html#cb216-6" aria-hidden="true" tabindex="-1"></a>       <span class="kw">end</span>}</span>
<span id="cb216-7"><a href="abstract-duplicated-supervision-code.html#cb216-7" aria-hidden="true" tabindex="-1"></a>       <span class="op">...</span></span></code></pre></div>
<p>Last step will be to update interface of the <code>naive</code> application:</p>
<div class="sourceCode" id="cb217"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb217-1"><a href="abstract-duplicated-supervision-code.html#cb217-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive.ex</span></span>
<span id="cb217-2"><a href="abstract-duplicated-supervision-code.html#cb217-2" aria-hidden="true" tabindex="-1"></a>  <span class="im">alias</span> <span class="cn">Naive</span><span class="op">.</span><span class="cn">DynamicSymbolSupervisor</span></span>
<span id="cb217-3"><a href="abstract-duplicated-supervision-code.html#cb217-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-4"><a href="abstract-duplicated-supervision-code.html#cb217-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defdelegate</span> start_trading(symbol), <span class="va">to:</span> <span class="cn">DynamicSymbolSupervisor</span>, <span class="va">as:</span> <span class="va">:start_worker</span></span>
<span id="cb217-5"><a href="abstract-duplicated-supervision-code.html#cb217-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defdelegate</span> stop_trading(symbol), <span class="va">to:</span> <span class="cn">DynamicSymbolSupervisor</span>, <span class="va">as:</span> <span class="va">:stop_worker</span></span>
<span id="cb217-6"><a href="abstract-duplicated-supervision-code.html#cb217-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defdelegate</span> shutdown_trading(symbol), <span class="va">to:</span> <span class="cn">DynamicSymbolSupervisor</span>, <span class="va">as:</span> <span class="va">:shutdown_worker</span></span></code></pre></div>
<p>Believe it or not, but at this moment(ignoring all of the warnings because we created a circular dependency between the <code>core</code> and the <code>naive</code> applications - which we will fix in the next steps) our application <em>runs</em> just fine! We are able to start and stop trading, autostarting works as well.</p>
</div>
<div id="implement-a-truly-generic-core.servicesupervisor" class="section level2" number="13.5">
<h2><span class="header-section-number">13.5</span> Implement a truly generic <code>Core.ServiceSupervisor</code></h2>
<p>Ok. Why did we even do this? What we are aiming for is a separation between the interface of our <code>Naive.DynamicSymbolSupervisor</code> module (like <code>start_worker/1</code>, <code>autostart_workers/0</code> and <code>stop_worker/1</code>) and the implementation which is now placed inside the <code>Core.ServiceSupervisor</code> module.</p>
<p>That’s all nice and to-some-extent understandable but <code>Core.ServiceSupervisor</code> module is <em>not</em> a generic module. We can’t use it inside the <code>streaming</code> application to supervise the <code>Streamer.Binance</code> processes.</p>
<p>So, what’s the point? Well, we can make it even more generic!</p>
<div id="first-path-starting-with-the-fetch_symbols_to_start0-function" class="section level3" number="13.5.1">
<h3><span class="header-section-number">13.5.1</span> First path starting with the <code>fetch_symbols_to_start/0</code> function</h3>
<p>Moving on to full generalization of the <code>Core.ServiceSupervisor</code> module. We will start with the helper functions first as they are the ones doing the work and they need to be truly generalized first:</p>
<div class="sourceCode" id="cb218"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb218-1"><a href="abstract-duplicated-supervision-code.html#cb218-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/core/lib/core/service_supervisor.ex</span></span>
<span id="cb218-2"><a href="abstract-duplicated-supervision-code.html#cb218-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> fetch_symbols_to_start() <span class="kw">do</span></span>
<span id="cb218-3"><a href="abstract-duplicated-supervision-code.html#cb218-3" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Repo</span><span class="op">.</span>all(</span>
<span id="cb218-4"><a href="abstract-duplicated-supervision-code.html#cb218-4" aria-hidden="true" tabindex="-1"></a>      from(s <span class="kw">in</span> <span class="cn">Settings</span>,</span>
<span id="cb218-5"><a href="abstract-duplicated-supervision-code.html#cb218-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">where:</span> s<span class="op">.</span>status <span class="op">==</span> <span class="st">&quot;on&quot;</span>,</span>
<span id="cb218-6"><a href="abstract-duplicated-supervision-code.html#cb218-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">select:</span> s<span class="op">.</span>symbol</span>
<span id="cb218-7"><a href="abstract-duplicated-supervision-code.html#cb218-7" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb218-8"><a href="abstract-duplicated-supervision-code.html#cb218-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb218-9"><a href="abstract-duplicated-supervision-code.html#cb218-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>The <code>fetch_symbols_to_start/0</code> function uses <code>Repo</code> and <code>Settings</code> that are aliased at the top of the <code>Core.ServiceSupervisor</code> module. This just won’t work with any other applications as Streamer will require its own <code>Repo</code> and <code>Settings</code> modules etc.</p>
<p>To fix that we will <em>pass</em> both <code>repo</code> and <code>schema</code> as arguments to the <code>fetch_symbols_to_start/0</code> function which will become <code>fetch_symbols_to_start/2</code>:</p>
<div class="sourceCode" id="cb219"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb219-1"><a href="abstract-duplicated-supervision-code.html#cb219-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/core/lib/core/service_supervisor.ex</span></span>
<span id="cb219-2"><a href="abstract-duplicated-supervision-code.html#cb219-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> fetch_symbols_to_start(repo, schema) <span class="kw">do</span> <span class="co"># &lt;= args added</span></span>
<span id="cb219-3"><a href="abstract-duplicated-supervision-code.html#cb219-3" aria-hidden="true" tabindex="-1"></a>    repo<span class="op">.</span>all( <span class="co"># &lt;= lowercase `repo` is an argument not aliased module</span></span>
<span id="cb219-4"><a href="abstract-duplicated-supervision-code.html#cb219-4" aria-hidden="true" tabindex="-1"></a>      from(s <span class="kw">in</span> schema, <span class="co"># &lt;= settings schema module passed as arg</span></span>
<span id="cb219-5"><a href="abstract-duplicated-supervision-code.html#cb219-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">where:</span> s<span class="op">.</span>status <span class="op">==</span> <span class="st">&quot;on&quot;</span>,</span>
<span id="cb219-6"><a href="abstract-duplicated-supervision-code.html#cb219-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">select:</span> s<span class="op">.</span>symbol</span>
<span id="cb219-7"><a href="abstract-duplicated-supervision-code.html#cb219-7" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb219-8"><a href="abstract-duplicated-supervision-code.html#cb219-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb219-9"><a href="abstract-duplicated-supervision-code.html#cb219-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>This will have a knock-on effect on any functions that are using <code>fetch_symbols_to_start/0</code> - now they need to use <code>fetch_symbols_to_start/2</code> and pass appropriate <code>Repo</code> and <code>Schema</code> modules.</p>
<p>So, the <code>fetch_symbols_to_start/0</code> is referenced by the <code>autostart_workers/0</code> - we will need to modify it to pass the repo and schema to the <code>fetch_symbols_to_start/2</code> and as it’s inside the <code>Core.ServiceSupervisor</code> module it needs to get them passed as arguments:</p>
<div class="sourceCode" id="cb220"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb220-1"><a href="abstract-duplicated-supervision-code.html#cb220-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/core/lib/core/service_supervisor.ex</span></span>
<span id="cb220-2"><a href="abstract-duplicated-supervision-code.html#cb220-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> autostart_workers(repo, schema) <span class="kw">do</span> <span class="co"># &lt;= args added</span></span>
<span id="cb220-3"><a href="abstract-duplicated-supervision-code.html#cb220-3" aria-hidden="true" tabindex="-1"></a>    fetch_symbols_to_start(repo, schema) <span class="co"># &lt;= args passed</span></span>
<span id="cb220-4"><a href="abstract-duplicated-supervision-code.html#cb220-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">|&gt;</span> <span class="cn">Enum</span><span class="op">.</span>map(<span class="op">&amp;</span>start_worker<span class="op">/</span><span class="dv">1</span>)</span>
<span id="cb220-5"><a href="abstract-duplicated-supervision-code.html#cb220-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>Going even further down the line, <code>autostart_workers/0</code> is referenced by the <code>autostart_workers/0</code> inside the <code>Naive.DynamicSymbolSupervisor</code> module. As this module is (<code>naive</code>) application-specific, it is a place where <code>repo</code> and <code>schema</code> are known from the context - for the <code>naive</code> application <code>repo</code> is the <code>Naive.Repo</code> module and <code>schema</code> is the <code>Naive.Schema.Settings</code> module:</p>
<div class="sourceCode" id="cb221"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb221-1"><a href="abstract-duplicated-supervision-code.html#cb221-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/naive/lib/naive/dynamic_symbol_supervisor.ex</span></span>
<span id="cb221-2"><a href="abstract-duplicated-supervision-code.html#cb221-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb221-3"><a href="abstract-duplicated-supervision-code.html#cb221-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> autostart_workers() <span class="kw">do</span></span>
<span id="cb221-4"><a href="abstract-duplicated-supervision-code.html#cb221-4" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span><span class="op">.</span>autostart_workers(</span>
<span id="cb221-5"><a href="abstract-duplicated-supervision-code.html#cb221-5" aria-hidden="true" tabindex="-1"></a>      <span class="cn">Naive</span><span class="op">.</span><span class="cn">Repo</span>,           <span class="co"># &lt;= new value passed</span></span>
<span id="cb221-6"><a href="abstract-duplicated-supervision-code.html#cb221-6" aria-hidden="true" tabindex="-1"></a>      <span class="cn">Naive</span><span class="op">.</span><span class="cn">Schema</span><span class="op">.</span><span class="cn">Settings</span> <span class="co"># &lt;= new value passed</span></span>
<span id="cb221-7"><a href="abstract-duplicated-supervision-code.html#cb221-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb221-8"><a href="abstract-duplicated-supervision-code.html#cb221-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>This finishes the first of multiple paths that we need to follow to fully refactor the <code>Core.ServiceSupervisor</code> module.</p>
</div>
<div id="second-path-starting-with-the-update_status2" class="section level3" number="13.5.2">
<h3><span class="header-section-number">13.5.2</span> Second path starting with the <code>update_status/2</code></h3>
<p>Let’s don’t waste time and start from the other helper function inside the <code>Core.ServiceSupervisor</code> module. This time we will make the <code>update_status/2</code> function fully generic:</p>
<div class="sourceCode" id="cb222"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb222-1"><a href="abstract-duplicated-supervision-code.html#cb222-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/core/lib/core/service_supervisor.ex</span></span>
<span id="cb222-2"><a href="abstract-duplicated-supervision-code.html#cb222-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> update_status(symbol, status, repo, schema) <span class="co"># &lt;= args added</span></span>
<span id="cb222-3"><a href="abstract-duplicated-supervision-code.html#cb222-3" aria-hidden="true" tabindex="-1"></a>      <span class="kw">when</span> is_binary(symbol) <span class="kw">and</span> is_binary(status) <span class="kw">do</span></span>
<span id="cb222-4"><a href="abstract-duplicated-supervision-code.html#cb222-4" aria-hidden="true" tabindex="-1"></a>    repo<span class="op">.</span>get_by(schema, <span class="va">symbol:</span> symbol) <span class="co"># &lt;= using dynamic repo and shcema modules</span></span>
<span id="cb222-5"><a href="abstract-duplicated-supervision-code.html#cb222-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">|&gt;</span> <span class="cn">Ecto</span><span class="op">.</span><span class="cn">Changeset</span><span class="op">.</span>change(%{<span class="va">status:</span> status})</span>
<span id="cb222-6"><a href="abstract-duplicated-supervision-code.html#cb222-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">|&gt;</span> repo<span class="op">.</span>update() <span class="co"># &lt;= using dynamic repo module</span></span>
<span id="cb222-7"><a href="abstract-duplicated-supervision-code.html#cb222-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>As previously we added <code>repo</code> and <code>schema</code> as arguments and modified the body of the function to utilize them instead of hardcoded modules (aliased at the top of the <code>Core.ServiceSupervisor</code> module).</p>
<p>In the same fashion as previously, we need to check “who” is using the <code>update_status/2</code> and update those calls to <code>update_status/4</code>. The function is used inside the <code>start_worker/1</code> and the <code>stop_worker/1</code> inside the <code>Core.ServiceSupervisor</code> module so as previously we need to bubble them up(pass via arguments to both <code>start_worker/1</code> and <code>stop_worker/1</code> functions):</p>
<div class="sourceCode" id="cb223"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb223-1"><a href="abstract-duplicated-supervision-code.html#cb223-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/core/lib/core/service_supervisor.ex</span></span>
<span id="cb223-2"><a href="abstract-duplicated-supervision-code.html#cb223-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> start_worker(symbol, repo, schema) <span class="kw">when</span> is_binary(symbol) <span class="kw">do</span> <span class="co"># &lt;= new args</span></span>
<span id="cb223-3"><a href="abstract-duplicated-supervision-code.html#cb223-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb223-4"><a href="abstract-duplicated-supervision-code.html#cb223-4" aria-hidden="true" tabindex="-1"></a>        {<span class="va">:ok</span>, _settings} <span class="op">=</span> update_status(symbol, <span class="st">&quot;on&quot;</span>, repo, schema) <span class="co"># &lt;= args passed</span></span>
<span id="cb223-5"><a href="abstract-duplicated-supervision-code.html#cb223-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb223-6"><a href="abstract-duplicated-supervision-code.html#cb223-6" aria-hidden="true" tabindex="-1"></a>        {<span class="va">:ok</span>, _settings} <span class="op">=</span> update_status(symbol, <span class="st">&quot;on&quot;</span>, repo, schema) <span class="co"># &lt;= args passed</span></span>
<span id="cb223-7"><a href="abstract-duplicated-supervision-code.html#cb223-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb223-8"><a href="abstract-duplicated-supervision-code.html#cb223-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb223-9"><a href="abstract-duplicated-supervision-code.html#cb223-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb223-10"><a href="abstract-duplicated-supervision-code.html#cb223-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> stop_worker(symbol, repo, schema) <span class="kw">when</span> is_binary(symbol) <span class="kw">do</span> <span class="co"># &lt;= new args</span></span>
<span id="cb223-11"><a href="abstract-duplicated-supervision-code.html#cb223-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb223-12"><a href="abstract-duplicated-supervision-code.html#cb223-12" aria-hidden="true" tabindex="-1"></a>        {<span class="va">:ok</span>, _settings} <span class="op">=</span> update_status(symbol, <span class="st">&quot;off&quot;</span>, repo, schema) <span class="co"># &lt;= args passed</span></span>
<span id="cb223-13"><a href="abstract-duplicated-supervision-code.html#cb223-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb223-14"><a href="abstract-duplicated-supervision-code.html#cb223-14" aria-hidden="true" tabindex="-1"></a>        {<span class="va">:ok</span>, _settings} <span class="op">=</span> update_status(symbol, <span class="st">&quot;off&quot;</span>, repo, schema) <span class="co"># &lt;= args passed</span></span>
<span id="cb223-15"><a href="abstract-duplicated-supervision-code.html#cb223-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb223-16"><a href="abstract-duplicated-supervision-code.html#cb223-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>As we modified both <code>start_worker/1</code> and <code>stop_worker/1</code> by adding two additional arguments we need to update all references to them and here is where things branch out a bit.</p>
<p>We will start with <code>start_worker/1</code> function (which is now <code>start_worker/3</code>) - it’s used by the <code>autostart_workers/2</code> inside <code>Core.ServiceSupervisor</code> module. The <code>autostart_workers/2</code> function already has <code>repo</code> and <code>schema</code> so we can just pass them to the <code>start_worker/3</code>:</p>
<div class="sourceCode" id="cb224"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb224-1"><a href="abstract-duplicated-supervision-code.html#cb224-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/core/lib/core/service_supervisor.ex</span></span>
<span id="cb224-2"><a href="abstract-duplicated-supervision-code.html#cb224-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> autostart_workers(repo, schema) <span class="kw">do</span></span>
<span id="cb224-3"><a href="abstract-duplicated-supervision-code.html#cb224-3" aria-hidden="true" tabindex="-1"></a>    fetch_symbols_to_start(repo, schema)</span>
<span id="cb224-4"><a href="abstract-duplicated-supervision-code.html#cb224-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">|&gt;</span> <span class="cn">Enum</span><span class="op">.</span>map(<span class="op">&amp;</span>start_worker(<span class="op">&amp;</span><span class="dv">1</span>, repo, schema)) <span class="co"># &lt;= args passed</span></span>
<span id="cb224-5"><a href="abstract-duplicated-supervision-code.html#cb224-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>Both the <code>start_worker/3</code> and the <code>stop_worker/3</code> function are used by the functions inside the <code>Naive.DynamicSymbolSupervisor</code> module. We need to pass the <code>Repo</code> and <code>Schema</code> in the same fashion as previously with <code>autostart_workers/2</code> function:</p>
<div class="sourceCode" id="cb225"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb225-1"><a href="abstract-duplicated-supervision-code.html#cb225-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/naive/lib/naive/dynamic_symbol_supervisor.ex</span></span>
<span id="cb225-2"><a href="abstract-duplicated-supervision-code.html#cb225-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> start_worker(symbol) <span class="kw">do</span></span>
<span id="cb225-3"><a href="abstract-duplicated-supervision-code.html#cb225-3" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span><span class="op">.</span>start_worker(</span>
<span id="cb225-4"><a href="abstract-duplicated-supervision-code.html#cb225-4" aria-hidden="true" tabindex="-1"></a>      symbol,</span>
<span id="cb225-5"><a href="abstract-duplicated-supervision-code.html#cb225-5" aria-hidden="true" tabindex="-1"></a>      <span class="cn">Naive</span><span class="op">.</span><span class="cn">Repo</span>,            <span class="co"># &lt;= new arg passed</span></span>
<span id="cb225-6"><a href="abstract-duplicated-supervision-code.html#cb225-6" aria-hidden="true" tabindex="-1"></a>      <span class="cn">Naive</span><span class="op">.</span><span class="cn">Schema</span><span class="op">.</span><span class="cn">Settings</span>  <span class="co"># &lt;= new arg passed</span></span>
<span id="cb225-7"><a href="abstract-duplicated-supervision-code.html#cb225-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb225-8"><a href="abstract-duplicated-supervision-code.html#cb225-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb225-9"><a href="abstract-duplicated-supervision-code.html#cb225-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-10"><a href="abstract-duplicated-supervision-code.html#cb225-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> stop_worker(symbol) <span class="kw">do</span></span>
<span id="cb225-11"><a href="abstract-duplicated-supervision-code.html#cb225-11" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span><span class="op">.</span>stop_worker(</span>
<span id="cb225-12"><a href="abstract-duplicated-supervision-code.html#cb225-12" aria-hidden="true" tabindex="-1"></a>      symbol,</span>
<span id="cb225-13"><a href="abstract-duplicated-supervision-code.html#cb225-13" aria-hidden="true" tabindex="-1"></a>      <span class="cn">Naive</span><span class="op">.</span><span class="cn">Repo</span>,           <span class="co"># &lt;= new arg passed</span></span>
<span id="cb225-14"><a href="abstract-duplicated-supervision-code.html#cb225-14" aria-hidden="true" tabindex="-1"></a>      <span class="cn">Naive</span><span class="op">.</span><span class="cn">Schema</span><span class="op">.</span><span class="cn">Settings</span> <span class="co"># &lt;= new arg passed</span></span>
<span id="cb225-15"><a href="abstract-duplicated-supervision-code.html#cb225-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb225-16"><a href="abstract-duplicated-supervision-code.html#cb225-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>At this moment there’s no code inside the <code>Core.ServiceSupervisor</code> module referencing the <code>alias</code>ed <code>Repo</code> nor <code>Schema</code> modules so we can safely remove both aliases - definitely, we are moving in the right direction!</p>
<p>Btw. Our project still works at this stage, we can start/stop trading and it autostarts trading.</p>
</div>
<div id="third-path-starting-with-the-get_pid1-function" class="section level3" number="13.5.3">
<h3><span class="header-section-number">13.5.3</span> Third path starting with the <code>get_pid/1</code> function</h3>
<p>Starting again from the most nested helper function - this time the <code>get_pid/1</code>:</p>
<div class="sourceCode" id="cb226"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb226-1"><a href="abstract-duplicated-supervision-code.html#cb226-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/core/lib/core/service_supervisor.ex</span></span>
<span id="cb226-2"><a href="abstract-duplicated-supervision-code.html#cb226-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> get_pid(symbol) <span class="kw">do</span></span>
<span id="cb226-3"><a href="abstract-duplicated-supervision-code.html#cb226-3" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Process</span><span class="op">.</span>whereis(:<span class="st">&quot;Elixir.Naive.SymbolSupervisor-</span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st">&quot;</span>)</span>
<span id="cb226-4"><a href="abstract-duplicated-supervision-code.html#cb226-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span>  </span></code></pre></div>
<p>We can see that it has a hardcoded <code>Naive.SymbolSupervisor</code> worker module - we need to make this part dynamic by using the <code>worker_module</code> argument:</p>
<div class="sourceCode" id="cb227"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb227-1"><a href="abstract-duplicated-supervision-code.html#cb227-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/core/lib/core/service_supervisor.ex</span></span>
<span id="cb227-2"><a href="abstract-duplicated-supervision-code.html#cb227-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> get_pid(worker_module, symbol) <span class="kw">do</span>  <span class="co"># &lt;= arg added</span></span>
<span id="cb227-3"><a href="abstract-duplicated-supervision-code.html#cb227-3" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Process</span><span class="op">.</span>whereis(:<span class="st">&quot;</span><span class="ot">#{</span>worker_module<span class="ot">}</span><span class="st">-</span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st">&quot;</span>) <span class="co"># &lt;= arg used</span></span>
<span id="cb227-4"><a href="abstract-duplicated-supervision-code.html#cb227-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>Moving up to functions that are referencing the <code>get_pid/1</code> function, those will be the <code>start_worker/3</code> and the <code>stop_worker/3</code> function.</p>
<p>As those are the two last functions to be updated, we will look into them more closely to finish our refactoring in this 3rd run. At this moment both need to add <code>worker_module</code> as both are calling the <code>get_pid/2</code> function. Looking at both function we can see two other hardcoded details:
- inside log message there are words “trading” - we can replace them so we will utilize the <code>worker_module</code> and <code>symbol</code> arguments
- there are two references to the <code>Naive.DynamicSymbolSupervisor</code> which we will replace with the <code>module</code> argument
- there is one more reference to the <code>Naive.SymbolSupervisor</code> module which we will replace with the <code>worker_module</code> argument</p>
<p>Let’s look at updated functions:</p>
<div class="sourceCode" id="cb228"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb228-1"><a href="abstract-duplicated-supervision-code.html#cb228-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/core/lib/core/service_supervisor.ex</span></span>
<span id="cb228-2"><a href="abstract-duplicated-supervision-code.html#cb228-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># module and worker_module args added vvvv</span></span>
<span id="cb228-3"><a href="abstract-duplicated-supervision-code.html#cb228-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> start_worker(symbol, repo, schema, module, worker_module)</span>
<span id="cb228-4"><a href="abstract-duplicated-supervision-code.html#cb228-4" aria-hidden="true" tabindex="-1"></a>      <span class="kw">when</span> is_binary(symbol) <span class="kw">do</span></span>
<span id="cb228-5"><a href="abstract-duplicated-supervision-code.html#cb228-5" aria-hidden="true" tabindex="-1"></a>    symbol <span class="op">=</span> <span class="cn">String</span><span class="op">.</span>upcase(symbol)</span>
<span id="cb228-6"><a href="abstract-duplicated-supervision-code.html#cb228-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-7"><a href="abstract-duplicated-supervision-code.html#cb228-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">case</span> get_pid(worker_module, symbol) <span class="kw">do</span> <span class="co"># &lt;= worker_module passed</span></span>
<span id="cb228-8"><a href="abstract-duplicated-supervision-code.html#cb228-8" aria-hidden="true" tabindex="-1"></a>      <span class="cn">nil</span> <span class="op">-&gt;</span></span>
<span id="cb228-9"><a href="abstract-duplicated-supervision-code.html#cb228-9" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Logger</span><span class="op">.</span>info(<span class="st">&quot;Starting </span><span class="ot">#{</span>worker_module<span class="ot">}</span><span class="st"> worker for </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st">&quot;</span>) <span class="co"># &lt;= dynamic text</span></span>
<span id="cb228-10"><a href="abstract-duplicated-supervision-code.html#cb228-10" aria-hidden="true" tabindex="-1"></a>        {<span class="va">:ok</span>, _settings} <span class="op">=</span> update_status(symbol, <span class="st">&quot;on&quot;</span>, repo, schema)</span>
<span id="cb228-11"><a href="abstract-duplicated-supervision-code.html#cb228-11" aria-hidden="true" tabindex="-1"></a>        {<span class="va">:ok</span>, _pid} <span class="op">=</span> <span class="cn">DynamicSupervisor</span><span class="op">.</span>start_child(module, {worker_module, symbol}) <span class="co"># &lt;= args used</span></span>
<span id="cb228-12"><a href="abstract-duplicated-supervision-code.html#cb228-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-13"><a href="abstract-duplicated-supervision-code.html#cb228-13" aria-hidden="true" tabindex="-1"></a>      pid <span class="op">-&gt;</span></span>
<span id="cb228-14"><a href="abstract-duplicated-supervision-code.html#cb228-14" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Logger</span><span class="op">.</span>warn(<span class="st">&quot;</span><span class="ot">#{</span>worker_module<span class="ot">}</span><span class="st"> worker for </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st"> already started&quot;</span>) <span class="co"># &lt;= dynamic text</span></span>
<span id="cb228-15"><a href="abstract-duplicated-supervision-code.html#cb228-15" aria-hidden="true" tabindex="-1"></a>        {<span class="va">:ok</span>, _settings} <span class="op">=</span> update_status(symbol, <span class="st">&quot;on&quot;</span>, repo, schema)</span>
<span id="cb228-16"><a href="abstract-duplicated-supervision-code.html#cb228-16" aria-hidden="true" tabindex="-1"></a>        {<span class="va">:ok</span>, pid}</span>
<span id="cb228-17"><a href="abstract-duplicated-supervision-code.html#cb228-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb228-18"><a href="abstract-duplicated-supervision-code.html#cb228-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb228-19"><a href="abstract-duplicated-supervision-code.html#cb228-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-20"><a href="abstract-duplicated-supervision-code.html#cb228-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># module and worker_module added as args vvvv</span></span>
<span id="cb228-21"><a href="abstract-duplicated-supervision-code.html#cb228-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> stop_worker(symbol, repo, schema, module, worker_module)</span>
<span id="cb228-22"><a href="abstract-duplicated-supervision-code.html#cb228-22" aria-hidden="true" tabindex="-1"></a>      <span class="kw">when</span> is_binary(symbol) <span class="kw">do</span></span>
<span id="cb228-23"><a href="abstract-duplicated-supervision-code.html#cb228-23" aria-hidden="true" tabindex="-1"></a>    symbol <span class="op">=</span> <span class="cn">String</span><span class="op">.</span>upcase(symbol)</span>
<span id="cb228-24"><a href="abstract-duplicated-supervision-code.html#cb228-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-25"><a href="abstract-duplicated-supervision-code.html#cb228-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">case</span> get_pid(worker_module, symbol) <span class="kw">do</span> <span class="co"># &lt;= worker_module passed</span></span>
<span id="cb228-26"><a href="abstract-duplicated-supervision-code.html#cb228-26" aria-hidden="true" tabindex="-1"></a>      <span class="cn">nil</span> <span class="op">-&gt;</span></span>
<span id="cb228-27"><a href="abstract-duplicated-supervision-code.html#cb228-27" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Logger</span><span class="op">.</span>warn(<span class="st">&quot;</span><span class="ot">#{</span>worker_module<span class="ot">}</span><span class="st"> worker for </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st"> already stopped&quot;</span>) <span class="co"># &lt;= dynamic text</span></span>
<span id="cb228-28"><a href="abstract-duplicated-supervision-code.html#cb228-28" aria-hidden="true" tabindex="-1"></a>        {<span class="va">:ok</span>, _settings} <span class="op">=</span> update_status(symbol, <span class="st">&quot;off&quot;</span>, repo, schema)</span>
<span id="cb228-29"><a href="abstract-duplicated-supervision-code.html#cb228-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-30"><a href="abstract-duplicated-supervision-code.html#cb228-30" aria-hidden="true" tabindex="-1"></a>      pid <span class="op">-&gt;</span></span>
<span id="cb228-31"><a href="abstract-duplicated-supervision-code.html#cb228-31" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Logger</span><span class="op">.</span>info(<span class="st">&quot;Stopping </span><span class="ot">#{</span>worker_module<span class="ot">}</span><span class="st"> worker for </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st">&quot;</span>) <span class="co"># &lt;= dynamic text</span></span>
<span id="cb228-32"><a href="abstract-duplicated-supervision-code.html#cb228-32" aria-hidden="true" tabindex="-1"></a>        <span class="va">:ok</span> <span class="op">=</span> <span class="cn">DynamicSupervisor</span><span class="op">.</span>terminate_child(module, pid) <span class="co"># &lt;= arg used</span></span>
<span id="cb228-33"><a href="abstract-duplicated-supervision-code.html#cb228-33" aria-hidden="true" tabindex="-1"></a>        {<span class="va">:ok</span>, _settings} <span class="op">=</span> update_status(symbol, <span class="st">&quot;off&quot;</span>, repo, schema)</span>
<span id="cb228-34"><a href="abstract-duplicated-supervision-code.html#cb228-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb228-35"><a href="abstract-duplicated-supervision-code.html#cb228-35" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>Inside both the <code>start_worker/5</code> and the <code>stop_worker/5</code> functions we modified:
- <code>get_pid/1</code> to pass the <code>worker_module</code>
- <code>Logger</code>’s messages to use the <code>worker_module</code> and <code>symbol</code>
- <code>DynamicSupervisor</code>’s functions to use the <code>module</code> and the <code>worker_module</code></p>
<p>Again, as we modified <code>start_worker/5</code> we need to make the last change inside the <code>Core.ServiceSupervisor</code> module - <code>autostart_workers/2</code> uses the <code>start_worker/5</code> function:</p>
<div class="sourceCode" id="cb229"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb229-1"><a href="abstract-duplicated-supervision-code.html#cb229-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/core/lib/core/service_supervisor.ex</span></span>
<span id="cb229-2"><a href="abstract-duplicated-supervision-code.html#cb229-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> autostart_workers(repo, schema, module, worker_module) <span class="kw">do</span> <span class="co"># &lt;= args added</span></span>
<span id="cb229-3"><a href="abstract-duplicated-supervision-code.html#cb229-3" aria-hidden="true" tabindex="-1"></a>    fetch_symbols_to_start(repo, schema)</span>
<span id="cb229-4"><a href="abstract-duplicated-supervision-code.html#cb229-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">|&gt;</span> <span class="cn">Enum</span><span class="op">.</span>map(<span class="op">&amp;</span>start_worker(<span class="op">&amp;</span><span class="dv">1</span>, repo, schema, module, worker_module)) <span class="co"># &lt;= args added</span></span>
<span id="cb229-5"><a href="abstract-duplicated-supervision-code.html#cb229-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>Just for referrence - final function headers look as following:</p>
<div class="sourceCode" id="cb230"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb230-1"><a href="abstract-duplicated-supervision-code.html#cb230-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/core/lib/core/service_supervisor.ex</span></span>
<span id="cb230-2"><a href="abstract-duplicated-supervision-code.html#cb230-2" aria-hidden="true" tabindex="-1"></a><span class="kw">defmodule</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span> <span class="kw">do</span></span>
<span id="cb230-3"><a href="abstract-duplicated-supervision-code.html#cb230-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> autostart_workers(repo, schema, module, worker_module) <span class="kw">do</span></span>
<span id="cb230-4"><a href="abstract-duplicated-supervision-code.html#cb230-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb230-5"><a href="abstract-duplicated-supervision-code.html#cb230-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb230-6"><a href="abstract-duplicated-supervision-code.html#cb230-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb230-7"><a href="abstract-duplicated-supervision-code.html#cb230-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> start_worker(symbol, repo, schema, module, worker_module)</span>
<span id="cb230-8"><a href="abstract-duplicated-supervision-code.html#cb230-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">when</span> is_binary(symbol) <span class="kw">do</span></span>
<span id="cb230-9"><a href="abstract-duplicated-supervision-code.html#cb230-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb230-10"><a href="abstract-duplicated-supervision-code.html#cb230-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb230-11"><a href="abstract-duplicated-supervision-code.html#cb230-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb230-12"><a href="abstract-duplicated-supervision-code.html#cb230-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> stop_worker(symbol, repo, schema, module, worker_module)</span>
<span id="cb230-13"><a href="abstract-duplicated-supervision-code.html#cb230-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">when</span> is_binary(symbol) <span class="kw">do</span></span>
<span id="cb230-14"><a href="abstract-duplicated-supervision-code.html#cb230-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb230-15"><a href="abstract-duplicated-supervision-code.html#cb230-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb230-16"><a href="abstract-duplicated-supervision-code.html#cb230-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb230-17"><a href="abstract-duplicated-supervision-code.html#cb230-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> get_pid(worker_module, symbol) <span class="kw">do</span></span>
<span id="cb230-18"><a href="abstract-duplicated-supervision-code.html#cb230-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb230-19"><a href="abstract-duplicated-supervision-code.html#cb230-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb230-20"><a href="abstract-duplicated-supervision-code.html#cb230-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb230-21"><a href="abstract-duplicated-supervision-code.html#cb230-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> update_status(symbol, status, repo, schema)</span>
<span id="cb230-22"><a href="abstract-duplicated-supervision-code.html#cb230-22" aria-hidden="true" tabindex="-1"></a>      <span class="kw">when</span> is_binary(symbol) <span class="kw">and</span> is_binary(status) <span class="kw">do</span></span>
<span id="cb230-23"><a href="abstract-duplicated-supervision-code.html#cb230-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb230-24"><a href="abstract-duplicated-supervision-code.html#cb230-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb230-25"><a href="abstract-duplicated-supervision-code.html#cb230-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb230-26"><a href="abstract-duplicated-supervision-code.html#cb230-26" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> fetch_symbols_to_start(repo, schema) <span class="kw">do</span></span>
<span id="cb230-27"><a href="abstract-duplicated-supervision-code.html#cb230-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb230-28"><a href="abstract-duplicated-supervision-code.html#cb230-28" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb230-29"><a href="abstract-duplicated-supervision-code.html#cb230-29" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<p>That finishes the 3rd round of updates inside the <code>Core.ServiceSupervisor</code> module, now we need to update the <code>Naive.DynamicSymbolSupervisor</code> module to use updated functions(and pass required arguments):</p>
<div class="sourceCode" id="cb231"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb231-1"><a href="abstract-duplicated-supervision-code.html#cb231-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/naive/lib/naive/dynamic_symbol_supervisor.ex</span></span>
<span id="cb231-2"><a href="abstract-duplicated-supervision-code.html#cb231-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb231-3"><a href="abstract-duplicated-supervision-code.html#cb231-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> autostart_workers() <span class="kw">do</span></span>
<span id="cb231-4"><a href="abstract-duplicated-supervision-code.html#cb231-4" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span><span class="op">.</span>autostart_workers(</span>
<span id="cb231-5"><a href="abstract-duplicated-supervision-code.html#cb231-5" aria-hidden="true" tabindex="-1"></a>      <span class="cn">Naive</span><span class="op">.</span><span class="cn">Repo</span>,</span>
<span id="cb231-6"><a href="abstract-duplicated-supervision-code.html#cb231-6" aria-hidden="true" tabindex="-1"></a>      <span class="cn">Naive</span><span class="op">.</span><span class="cn">Schema</span><span class="op">.</span><span class="cn">Settings</span>,</span>
<span id="cb231-7"><a href="abstract-duplicated-supervision-code.html#cb231-7" aria-hidden="true" tabindex="-1"></a>      <span class="cn">__MODULE__</span>,             <span class="co"># &lt;= added arg</span></span>
<span id="cb231-8"><a href="abstract-duplicated-supervision-code.html#cb231-8" aria-hidden="true" tabindex="-1"></a>      <span class="cn">Naive</span><span class="op">.</span><span class="cn">SymbolSupervisor</span>  <span class="co"># &lt;= added arg</span></span>
<span id="cb231-9"><a href="abstract-duplicated-supervision-code.html#cb231-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb231-10"><a href="abstract-duplicated-supervision-code.html#cb231-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb231-11"><a href="abstract-duplicated-supervision-code.html#cb231-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-12"><a href="abstract-duplicated-supervision-code.html#cb231-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> start_worker(symbol) <span class="kw">do</span></span>
<span id="cb231-13"><a href="abstract-duplicated-supervision-code.html#cb231-13" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span><span class="op">.</span>start_worker(</span>
<span id="cb231-14"><a href="abstract-duplicated-supervision-code.html#cb231-14" aria-hidden="true" tabindex="-1"></a>      symbol,</span>
<span id="cb231-15"><a href="abstract-duplicated-supervision-code.html#cb231-15" aria-hidden="true" tabindex="-1"></a>      <span class="cn">Naive</span><span class="op">.</span><span class="cn">Repo</span>,</span>
<span id="cb231-16"><a href="abstract-duplicated-supervision-code.html#cb231-16" aria-hidden="true" tabindex="-1"></a>      <span class="cn">Naive</span><span class="op">.</span><span class="cn">Schema</span><span class="op">.</span><span class="cn">Settings</span>,</span>
<span id="cb231-17"><a href="abstract-duplicated-supervision-code.html#cb231-17" aria-hidden="true" tabindex="-1"></a>      <span class="cn">__MODULE__</span>,             <span class="co"># &lt;= added arg</span></span>
<span id="cb231-18"><a href="abstract-duplicated-supervision-code.html#cb231-18" aria-hidden="true" tabindex="-1"></a>      <span class="cn">Naive</span><span class="op">.</span><span class="cn">SymbolSupervisor</span>  <span class="co"># &lt;= added arg</span></span>
<span id="cb231-19"><a href="abstract-duplicated-supervision-code.html#cb231-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb231-20"><a href="abstract-duplicated-supervision-code.html#cb231-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb231-21"><a href="abstract-duplicated-supervision-code.html#cb231-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-22"><a href="abstract-duplicated-supervision-code.html#cb231-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> stop_worker(symbol) <span class="kw">do</span></span>
<span id="cb231-23"><a href="abstract-duplicated-supervision-code.html#cb231-23" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span><span class="op">.</span>stop_worker(</span>
<span id="cb231-24"><a href="abstract-duplicated-supervision-code.html#cb231-24" aria-hidden="true" tabindex="-1"></a>      symbol,</span>
<span id="cb231-25"><a href="abstract-duplicated-supervision-code.html#cb231-25" aria-hidden="true" tabindex="-1"></a>      <span class="cn">Naive</span><span class="op">.</span><span class="cn">Repo</span>,</span>
<span id="cb231-26"><a href="abstract-duplicated-supervision-code.html#cb231-26" aria-hidden="true" tabindex="-1"></a>      <span class="cn">Naive</span><span class="op">.</span><span class="cn">Schema</span><span class="op">.</span><span class="cn">Settings</span>,</span>
<span id="cb231-27"><a href="abstract-duplicated-supervision-code.html#cb231-27" aria-hidden="true" tabindex="-1"></a>      <span class="cn">__MODULE__</span>,             <span class="co"># &lt;= added arg</span></span>
<span id="cb231-28"><a href="abstract-duplicated-supervision-code.html#cb231-28" aria-hidden="true" tabindex="-1"></a>      <span class="cn">Naive</span><span class="op">.</span><span class="cn">SymbolSupervisor</span>  <span class="co"># &lt;= added arg</span></span>
<span id="cb231-29"><a href="abstract-duplicated-supervision-code.html#cb231-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb231-30"><a href="abstract-duplicated-supervision-code.html#cb231-30" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb231-31"><a href="abstract-duplicated-supervision-code.html#cb231-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-32"><a href="abstract-duplicated-supervision-code.html#cb231-32" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> shutdown_worker(symbol) <span class="kw">when</span> is_binary(symbol) <span class="kw">do</span></span>
<span id="cb231-33"><a href="abstract-duplicated-supervision-code.html#cb231-33" aria-hidden="true" tabindex="-1"></a>    symbol <span class="op">=</span> <span class="cn">String</span><span class="op">.</span>upcase(symbol)</span>
<span id="cb231-34"><a href="abstract-duplicated-supervision-code.html#cb231-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-35"><a href="abstract-duplicated-supervision-code.html#cb231-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">case</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span><span class="op">.</span>get_pid(<span class="cn">Naive</span><span class="op">.</span><span class="cn">SymbolSupervisor</span>, symbol) <span class="kw">do</span> <span class="co"># &lt;= arg added</span></span>
<span id="cb231-36"><a href="abstract-duplicated-supervision-code.html#cb231-36" aria-hidden="true" tabindex="-1"></a>      <span class="cn">nil</span> <span class="op">-&gt;</span></span>
<span id="cb231-37"><a href="abstract-duplicated-supervision-code.html#cb231-37" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Logger</span><span class="op">.</span>warn(<span class="st">&quot;</span><span class="ot">#{</span><span class="cn">Naive</span><span class="op">.</span><span class="cn">SymbolSupervisor</span><span class="ot">}</span><span class="st"> worker for </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st"> already stopped&quot;</span>) <span class="co"># &lt;= updated</span></span>
<span id="cb231-38"><a href="abstract-duplicated-supervision-code.html#cb231-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-39"><a href="abstract-duplicated-supervision-code.html#cb231-39" aria-hidden="true" tabindex="-1"></a>        {<span class="va">:ok</span>, _settings} <span class="op">=</span></span>
<span id="cb231-40"><a href="abstract-duplicated-supervision-code.html#cb231-40" aria-hidden="true" tabindex="-1"></a>          <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span><span class="op">.</span>update_status(symbol, <span class="st">&quot;off&quot;</span>, <span class="cn">Naive</span><span class="op">.</span><span class="cn">Repo</span>, <span class="cn">Naive</span><span class="op">.</span><span class="cn">Schema</span><span class="op">.</span><span class="cn">Settings</span>) <span class="co"># &lt;= args added</span></span>
<span id="cb231-41"><a href="abstract-duplicated-supervision-code.html#cb231-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-42"><a href="abstract-duplicated-supervision-code.html#cb231-42" aria-hidden="true" tabindex="-1"></a>      _pid <span class="op">-&gt;</span></span>
<span id="cb231-43"><a href="abstract-duplicated-supervision-code.html#cb231-43" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Logger</span><span class="op">.</span>info(<span class="st">&quot;Initializing shutdown of </span><span class="ot">#{</span><span class="cn">Naive</span><span class="op">.</span><span class="cn">SymbolSupervisor</span><span class="ot">}</span><span class="st"> worker for </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st">&quot;</span>) <span class="co"># &lt;= updated</span></span>
<span id="cb231-44"><a href="abstract-duplicated-supervision-code.html#cb231-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-45"><a href="abstract-duplicated-supervision-code.html#cb231-45" aria-hidden="true" tabindex="-1"></a>        {<span class="va">:ok</span>, settings} <span class="op">=</span></span>
<span id="cb231-46"><a href="abstract-duplicated-supervision-code.html#cb231-46" aria-hidden="true" tabindex="-1"></a>          <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span><span class="op">.</span>update_status(</span>
<span id="cb231-47"><a href="abstract-duplicated-supervision-code.html#cb231-47" aria-hidden="true" tabindex="-1"></a>            symbol,</span>
<span id="cb231-48"><a href="abstract-duplicated-supervision-code.html#cb231-48" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;shutdown&quot;</span>,</span>
<span id="cb231-49"><a href="abstract-duplicated-supervision-code.html#cb231-49" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Naive</span><span class="op">.</span><span class="cn">Repo</span>,</span>
<span id="cb231-50"><a href="abstract-duplicated-supervision-code.html#cb231-50" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Naive</span><span class="op">.</span><span class="cn">Schema</span><span class="op">.</span><span class="cn">Settings</span></span>
<span id="cb231-51"><a href="abstract-duplicated-supervision-code.html#cb231-51" aria-hidden="true" tabindex="-1"></a>          ) <span class="co"># ^^^ additional args passed</span></span>
<span id="cb231-52"><a href="abstract-duplicated-supervision-code.html#cb231-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-53"><a href="abstract-duplicated-supervision-code.html#cb231-53" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Naive</span><span class="op">.</span><span class="cn">Leader</span><span class="op">.</span>notify(<span class="va">:settings_updated</span>, settings)</span>
<span id="cb231-54"><a href="abstract-duplicated-supervision-code.html#cb231-54" aria-hidden="true" tabindex="-1"></a>        {<span class="va">:ok</span>, settings}</span>
<span id="cb231-55"><a href="abstract-duplicated-supervision-code.html#cb231-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb231-56"><a href="abstract-duplicated-supervision-code.html#cb231-56" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>We needed to update referrences inside the <code>shutdown_trading/1</code> function as well, as it calls <code>get_pid/2</code> and <code>update_status/4</code> functions.</p>
<p>We are now done with refactoring the <code>Core.ServiceSupervisor</code> module, it’s completely generic and can be used inside both <code>streamer</code> and the <code>naive</code> applications.</p>
<p>At this moment to use the <code>Core.ServiceSupervisor</code> module we need to write interface functions in our supervisors and pass multiple arguments in each one - again, would need to use of copies those functions inside <code>streamer</code> and <code>naive</code> application. In the next section we will look into how could we leverage Elixir <a href="https://elixir-lang.org/getting-started/meta/macros.html">macros</a> to remove that boilerplate.</p>
</div>
</div>
<div id="remove-boilerplate-using-use-macro" class="section level2" number="13.6">
<h2><span class="header-section-number">13.6</span> Remove boilerplate using <code>use</code> macro</h2>
<p>Elixir provides a way to <code>use</code> other modules. Idea is that inside the <code>Naive.DynamicSymbolSupervisor</code> module we are <code>use</code>ing the <code>DynamicSupervisor</code> module currently but we could use <code>Core.ServiceSupervisor</code>:</p>
<div class="sourceCode" id="cb232"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb232-1"><a href="abstract-duplicated-supervision-code.html#cb232-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/dynamic_symbol_supervisor.ex</span></span>
<span id="cb232-2"><a href="abstract-duplicated-supervision-code.html#cb232-2" aria-hidden="true" tabindex="-1"></a><span class="kw">defmodule</span> <span class="cn">Naive</span><span class="op">.</span><span class="cn">DynamicSymbolSupervisor</span> <span class="kw">do</span></span>
<span id="cb232-3"><a href="abstract-duplicated-supervision-code.html#cb232-3" aria-hidden="true" tabindex="-1"></a>  <span class="im">use</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span></span></code></pre></div>
<p>To be able to <code>use</code> the <code>Core.ServiceSupervisor</code> module it needs to provide the <code>__using__/1</code> macro. As the simplest content of that macro, we can use here would be just to use the <code>DynamicSupervisor</code> inside:</p>
<div class="sourceCode" id="cb233"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb233-1"><a href="abstract-duplicated-supervision-code.html#cb233-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/core/lib/core/service_supervisor.ex</span></span>
<span id="cb233-2"><a href="abstract-duplicated-supervision-code.html#cb233-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defmacro</span> __using__(opts) <span class="kw">do</span></span>
<span id="cb233-3"><a href="abstract-duplicated-supervision-code.html#cb233-3" aria-hidden="true" tabindex="-1"></a>    <span class="cn">IO</span><span class="op">.</span>inspect(opts)</span>
<span id="cb233-4"><a href="abstract-duplicated-supervision-code.html#cb233-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">quote</span> <span class="va">location:</span> <span class="va">:keep</span> <span class="kw">do</span></span>
<span id="cb233-5"><a href="abstract-duplicated-supervision-code.html#cb233-5" aria-hidden="true" tabindex="-1"></a>      <span class="im">use</span> <span class="cn">DynamicSupervisor</span></span>
<span id="cb233-6"><a href="abstract-duplicated-supervision-code.html#cb233-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb233-7"><a href="abstract-duplicated-supervision-code.html#cb233-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>How does this work? As an oversimplification, you can think about it as Elixir will look through the contents of <code>quote</code>’s body(everything between <code>quote ... do</code> and <code>end</code>) in search for the <code>unquote</code> function which can inject dynamic content. All of this will become much clearer as we will go through the first example but the important part is that after executing any potential <code>unquote</code>s inside the <code>quote</code>’s body, Elixir will grab that code as it would be just part of code and place it inside the <code>Naive.DynamicSymbolSupervisor</code> module at compile time(we will also see the result of <code>IO.inspect/1</code> at compilation).</p>
<p>At this moment(after swapping to <code>use Core.ServiceSupervisor</code>) our code still works and it’s exactly as we would simply have <code>use DynamicSupervisor</code> inside the <code>Naive.DynamicSymbolSupervisor</code> module - as at compilation, it will be swapped to it either way(as per contents of the <code>__using__/1</code> macro).</p>
<p>As the <code>autostart_workers/0</code> function is a part of the boilerplate, we will move it from the <code>Naive.DynamicSymbolSupervisor</code> module to the <code>Core.ServiceSupervisor</code> module inside the <code>__using__/1</code> macro.</p>
<p>Ok, but it has all of those other <code>naive</code> application-specific arguments - where will we get those?</p>
<p>That’s what that <code>opts</code> argument is for inside the <code>__using__/1</code> macro. When we call <code>use Core.ServiceSupervisor</code> we can pass an additional keyword list which will contain all <code>naive</code> application-specific details:</p>
<div class="sourceCode" id="cb234"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb234-1"><a href="abstract-duplicated-supervision-code.html#cb234-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/dynamic_symbol_supervisor.ex</span></span>
<span id="cb234-2"><a href="abstract-duplicated-supervision-code.html#cb234-2" aria-hidden="true" tabindex="-1"></a><span class="kw">defmodule</span> <span class="cn">Naive</span><span class="op">.</span><span class="cn">DynamicSymbolSupervisor</span> <span class="kw">do</span></span>
<span id="cb234-3"><a href="abstract-duplicated-supervision-code.html#cb234-3" aria-hidden="true" tabindex="-1"></a>  <span class="im">use</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span>,</span>
<span id="cb234-4"><a href="abstract-duplicated-supervision-code.html#cb234-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">repo:</span> <span class="cn">Naive</span><span class="op">.</span><span class="cn">Repo</span>,</span>
<span id="cb234-5"><a href="abstract-duplicated-supervision-code.html#cb234-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">schema:</span> <span class="cn">Naive</span><span class="op">.</span><span class="cn">Schema</span><span class="op">.</span><span class="cn">Settings</span>,</span>
<span id="cb234-6"><a href="abstract-duplicated-supervision-code.html#cb234-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">module:</span> <span class="cn">__MODULE__</span>,</span>
<span id="cb234-7"><a href="abstract-duplicated-supervision-code.html#cb234-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">worker_module:</span> <span class="cn">Naive</span><span class="op">.</span><span class="cn">SymbolSupervisor</span></span></code></pre></div>
<p>We can now update the <code>__using__/1</code> macro to assign all of those details to variables(instead of using <code>IO.inspect/1</code>):</p>
<div class="sourceCode" id="cb235"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb235-1"><a href="abstract-duplicated-supervision-code.html#cb235-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/core/lib/core/service_supervisor.ex</span></span>
<span id="cb235-2"><a href="abstract-duplicated-supervision-code.html#cb235-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defmacro</span> __using__(opts) <span class="kw">do</span></span>
<span id="cb235-3"><a href="abstract-duplicated-supervision-code.html#cb235-3" aria-hidden="true" tabindex="-1"></a>    {<span class="va">:ok</span>, repo} <span class="op">=</span> <span class="cn">Keyword</span><span class="op">.</span>fetch(opts, <span class="va">:repo</span>)</span>
<span id="cb235-4"><a href="abstract-duplicated-supervision-code.html#cb235-4" aria-hidden="true" tabindex="-1"></a>    {<span class="va">:ok</span>, schema} <span class="op">=</span> <span class="cn">Keyword</span><span class="op">.</span>fetch(opts, <span class="va">:schema</span>)</span>
<span id="cb235-5"><a href="abstract-duplicated-supervision-code.html#cb235-5" aria-hidden="true" tabindex="-1"></a>    {<span class="va">:ok</span>, module} <span class="op">=</span> <span class="cn">Keyword</span><span class="op">.</span>fetch(opts, <span class="va">:module</span>)</span>
<span id="cb235-6"><a href="abstract-duplicated-supervision-code.html#cb235-6" aria-hidden="true" tabindex="-1"></a>    {<span class="va">:ok</span>, worker_module} <span class="op">=</span> <span class="cn">Keyword</span><span class="op">.</span>fetch(opts, <span class="va">:worker_module</span>)</span>
<span id="cb235-7"><a href="abstract-duplicated-supervision-code.html#cb235-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span></code></pre></div>
<p>At this moment we can use those <em>dynamic</em> values to generate code that will be specific to the implementation module for example <code>autostart_workers/0</code> that we moved from the <code>Naive.DynamicSymbolSupervisor</code> module and will need to have different values passed to it(like <code>Streamer.Binance</code> as <code>worker_module</code>) for the <code>streamer</code> application. We can see that it requires inserting those dynamic values inside the <code>autstart_workers/0</code> but how to dynamically inject arguments - <code>unquote</code> to the rescue. When we will update the <code>autostart_workers/0</code> function from:</p>
<div class="sourceCode" id="cb236"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb236-1"><a href="abstract-duplicated-supervision-code.html#cb236-1" aria-hidden="true" tabindex="-1"></a>      <span class="co"># sample moved code from the `Naive.DynamicSymbolSupervisor` module</span></span>
<span id="cb236-2"><a href="abstract-duplicated-supervision-code.html#cb236-2" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> autostart_workers() <span class="kw">do</span></span>
<span id="cb236-3"><a href="abstract-duplicated-supervision-code.html#cb236-3" aria-hidden="true" tabindex="-1"></a>          <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span><span class="op">.</span>autostart_workers(</span>
<span id="cb236-4"><a href="abstract-duplicated-supervision-code.html#cb236-4" aria-hidden="true" tabindex="-1"></a>          <span class="cn">Naive</span><span class="op">.</span><span class="cn">Repo</span>,</span>
<span id="cb236-5"><a href="abstract-duplicated-supervision-code.html#cb236-5" aria-hidden="true" tabindex="-1"></a>          <span class="cn">Naive</span><span class="op">.</span><span class="cn">Schema</span><span class="op">.</span><span class="cn">Settings</span>,</span>
<span id="cb236-6"><a href="abstract-duplicated-supervision-code.html#cb236-6" aria-hidden="true" tabindex="-1"></a>          <span class="cn">__MODULE__</span>,</span>
<span id="cb236-7"><a href="abstract-duplicated-supervision-code.html#cb236-7" aria-hidden="true" tabindex="-1"></a>          <span class="cn">Naive</span><span class="op">.</span><span class="cn">SymbolSupervisor</span></span>
<span id="cb236-8"><a href="abstract-duplicated-supervision-code.html#cb236-8" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb236-9"><a href="abstract-duplicated-supervision-code.html#cb236-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">end</span></span></code></pre></div>
<p>to:</p>
<div class="sourceCode" id="cb237"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb237-1"><a href="abstract-duplicated-supervision-code.html#cb237-1" aria-hidden="true" tabindex="-1"></a>      <span class="co"># updated code that will become part of the `__using__/1` macro</span></span>
<span id="cb237-2"><a href="abstract-duplicated-supervision-code.html#cb237-2" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> autostart_workers() <span class="kw">do</span></span>
<span id="cb237-3"><a href="abstract-duplicated-supervision-code.html#cb237-3" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span><span class="op">.</span>autostart_workers(</span>
<span id="cb237-4"><a href="abstract-duplicated-supervision-code.html#cb237-4" aria-hidden="true" tabindex="-1"></a>          <span class="kw">unquote</span>(repo),</span>
<span id="cb237-5"><a href="abstract-duplicated-supervision-code.html#cb237-5" aria-hidden="true" tabindex="-1"></a>          <span class="kw">unquote</span>(schema),</span>
<span id="cb237-6"><a href="abstract-duplicated-supervision-code.html#cb237-6" aria-hidden="true" tabindex="-1"></a>          <span class="kw">unquote</span>(module),</span>
<span id="cb237-7"><a href="abstract-duplicated-supervision-code.html#cb237-7" aria-hidden="true" tabindex="-1"></a>          <span class="kw">unquote</span>(worker_module)</span>
<span id="cb237-8"><a href="abstract-duplicated-supervision-code.html#cb237-8" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb237-9"><a href="abstract-duplicated-supervision-code.html#cb237-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">end</span></span></code></pre></div>
<p>in the end generated code that will be “pasted” to the <code>Naive.DynamicSymbolSupervisor</code> module at compile time will be:</p>
<div class="sourceCode" id="cb238"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb238-1"><a href="abstract-duplicated-supervision-code.html#cb238-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># compiled code attached to the `Naive.DynamicSymbolSupervisor` module</span></span>
<span id="cb238-2"><a href="abstract-duplicated-supervision-code.html#cb238-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> autostart_workers() <span class="kw">do</span></span>
<span id="cb238-3"><a href="abstract-duplicated-supervision-code.html#cb238-3" aria-hidden="true" tabindex="-1"></a>      <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span><span class="op">.</span>autostart_workers(</span>
<span id="cb238-4"><a href="abstract-duplicated-supervision-code.html#cb238-4" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Naive</span><span class="op">.</span><span class="cn">Repo</span>,</span>
<span id="cb238-5"><a href="abstract-duplicated-supervision-code.html#cb238-5" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Naive</span><span class="op">.</span><span class="cn">Schema</span><span class="op">.</span><span class="cn">Settings</span>,</span>
<span id="cb238-6"><a href="abstract-duplicated-supervision-code.html#cb238-6" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Naive</span><span class="op">.</span><span class="cn">DynamicSymbolSupervisor</span>,</span>
<span id="cb238-7"><a href="abstract-duplicated-supervision-code.html#cb238-7" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Naive</span><span class="op">.</span><span class="cn">SymbolSupervisor</span></span>
<span id="cb238-8"><a href="abstract-duplicated-supervision-code.html#cb238-8" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb238-9"><a href="abstract-duplicated-supervision-code.html#cb238-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span></code></pre></div>
<p>This way we can dynamically create functions for any application(for the <code>streamer</code> application, it will generate function call with the <code>Streamer.Repo</code>, <code>Streamer.Schema.Settings</code> args etc).</p>
<p>We can apply that to all of the passed variables inside the <code>autostart_workers/0</code> function - just for reference full macro will look as follows:</p>
<div class="sourceCode" id="cb239"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb239-1"><a href="abstract-duplicated-supervision-code.html#cb239-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/core/lib/core/service_supervisor.ex</span></span>
<span id="cb239-2"><a href="abstract-duplicated-supervision-code.html#cb239-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defmacro</span> __using__(opts) <span class="kw">do</span></span>
<span id="cb239-3"><a href="abstract-duplicated-supervision-code.html#cb239-3" aria-hidden="true" tabindex="-1"></a>    {<span class="va">:ok</span>, repo} <span class="op">=</span> <span class="cn">Keyword</span><span class="op">.</span>fetch(opts, <span class="va">:repo</span>)</span>
<span id="cb239-4"><a href="abstract-duplicated-supervision-code.html#cb239-4" aria-hidden="true" tabindex="-1"></a>    {<span class="va">:ok</span>, schema} <span class="op">=</span> <span class="cn">Keyword</span><span class="op">.</span>fetch(opts, <span class="va">:schema</span>)</span>
<span id="cb239-5"><a href="abstract-duplicated-supervision-code.html#cb239-5" aria-hidden="true" tabindex="-1"></a>    {<span class="va">:ok</span>, module} <span class="op">=</span> <span class="cn">Keyword</span><span class="op">.</span>fetch(opts, <span class="va">:module</span>)</span>
<span id="cb239-6"><a href="abstract-duplicated-supervision-code.html#cb239-6" aria-hidden="true" tabindex="-1"></a>    {<span class="va">:ok</span>, worker_module} <span class="op">=</span> <span class="cn">Keyword</span><span class="op">.</span>fetch(opts, <span class="va">:worker_module</span>)</span>
<span id="cb239-7"><a href="abstract-duplicated-supervision-code.html#cb239-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb239-8"><a href="abstract-duplicated-supervision-code.html#cb239-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">quote</span> <span class="va">location:</span> <span class="va">:keep</span> <span class="kw">do</span></span>
<span id="cb239-9"><a href="abstract-duplicated-supervision-code.html#cb239-9" aria-hidden="true" tabindex="-1"></a>      <span class="im">use</span> <span class="cn">DynamicSupervisor</span></span>
<span id="cb239-10"><a href="abstract-duplicated-supervision-code.html#cb239-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb239-11"><a href="abstract-duplicated-supervision-code.html#cb239-11" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> autostart_workers() <span class="kw">do</span></span>
<span id="cb239-12"><a href="abstract-duplicated-supervision-code.html#cb239-12" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span><span class="op">.</span>autostart_workers(</span>
<span id="cb239-13"><a href="abstract-duplicated-supervision-code.html#cb239-13" aria-hidden="true" tabindex="-1"></a>          <span class="kw">unquote</span>(repo),</span>
<span id="cb239-14"><a href="abstract-duplicated-supervision-code.html#cb239-14" aria-hidden="true" tabindex="-1"></a>          <span class="kw">unquote</span>(schema),</span>
<span id="cb239-15"><a href="abstract-duplicated-supervision-code.html#cb239-15" aria-hidden="true" tabindex="-1"></a>          <span class="kw">unquote</span>(module),</span>
<span id="cb239-16"><a href="abstract-duplicated-supervision-code.html#cb239-16" aria-hidden="true" tabindex="-1"></a>          <span class="kw">unquote</span>(worker_module)</span>
<span id="cb239-17"><a href="abstract-duplicated-supervision-code.html#cb239-17" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb239-18"><a href="abstract-duplicated-supervision-code.html#cb239-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">end</span></span>
<span id="cb239-19"><a href="abstract-duplicated-supervision-code.html#cb239-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb239-20"><a href="abstract-duplicated-supervision-code.html#cb239-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>You can think about the above macro that it will substitute the <code>unquote(..)</code> parts with passed values and then it will grab the whole contents between <code>quote ... do</code> and <code>end</code> and it will paste it to the <code>Naive.DynamicSymbolSupervisor</code> module at compile-time - we can visualize generated/“pasted” code as:</p>
<div class="sourceCode" id="cb240"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb240-1"><a href="abstract-duplicated-supervision-code.html#cb240-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># code generated by the `__using__/1` macro that</span></span>
<span id="cb240-2"><a href="abstract-duplicated-supervision-code.html#cb240-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># will be &quot;pasted&quot; to the `Naive.DynamicSymbolSupervisor` module</span></span>
<span id="cb240-3"><a href="abstract-duplicated-supervision-code.html#cb240-3" aria-hidden="true" tabindex="-1"></a>  <span class="im">use</span> <span class="cn">DynamicSupervisor</span></span>
<span id="cb240-4"><a href="abstract-duplicated-supervision-code.html#cb240-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-5"><a href="abstract-duplicated-supervision-code.html#cb240-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> autostart_workers() <span class="kw">do</span></span>
<span id="cb240-6"><a href="abstract-duplicated-supervision-code.html#cb240-6" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span><span class="op">.</span>autostart_workers(</span>
<span id="cb240-7"><a href="abstract-duplicated-supervision-code.html#cb240-7" aria-hidden="true" tabindex="-1"></a>      <span class="cn">Naive</span><span class="op">.</span><span class="cn">Repo</span>,</span>
<span id="cb240-8"><a href="abstract-duplicated-supervision-code.html#cb240-8" aria-hidden="true" tabindex="-1"></a>      <span class="cn">Naive</span><span class="op">.</span><span class="cn">Schema</span><span class="op">.</span><span class="cn">Settings</span>,</span>
<span id="cb240-9"><a href="abstract-duplicated-supervision-code.html#cb240-9" aria-hidden="true" tabindex="-1"></a>      <span class="cn">Naive</span><span class="op">.</span><span class="cn">DynamicSymbolSupervisor</span>,</span>
<span id="cb240-10"><a href="abstract-duplicated-supervision-code.html#cb240-10" aria-hidden="true" tabindex="-1"></a>      <span class="cn">Naive</span><span class="op">.</span><span class="cn">SymbolSupervisor</span></span>
<span id="cb240-11"><a href="abstract-duplicated-supervision-code.html#cb240-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb240-12"><a href="abstract-duplicated-supervision-code.html#cb240-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>This is exactly the code that we had before inside the <code>Naive.DynamicSymbolSupervisor</code> module but now it’s stored away inside the <code>Core.ServiceSupervisor</code>’s <code>__using__/1</code> macro and it doesn’t need to be implemented/copied across twice into two apps anymore.</p>
<p>We can now follow the same principle and move <code>start_worker/1</code> and <code>stop_worker/1</code> from the <code>Naive.DynamicSymbolSupervisor</code> module into <code>__using__/1</code> macro inside the <code>Core.ServiceSupervisor</code> module:</p>
<div class="sourceCode" id="cb241"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb241-1"><a href="abstract-duplicated-supervision-code.html#cb241-1" aria-hidden="true" tabindex="-1"></a>      <span class="co"># /apps/core/lib/core/service_supervisor.ex</span></span>
<span id="cb241-2"><a href="abstract-duplicated-supervision-code.html#cb241-2" aria-hidden="true" tabindex="-1"></a>      <span class="co"># inside the __using__/1 macro</span></span>
<span id="cb241-3"><a href="abstract-duplicated-supervision-code.html#cb241-3" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span></span>
<span id="cb241-4"><a href="abstract-duplicated-supervision-code.html#cb241-4" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> start_worker(symbol) <span class="kw">do</span></span>
<span id="cb241-5"><a href="abstract-duplicated-supervision-code.html#cb241-5" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span><span class="op">.</span>start_worker(</span>
<span id="cb241-6"><a href="abstract-duplicated-supervision-code.html#cb241-6" aria-hidden="true" tabindex="-1"></a>          symbol, <span class="co"># &lt;= this needs to stay as variable</span></span>
<span id="cb241-7"><a href="abstract-duplicated-supervision-code.html#cb241-7" aria-hidden="true" tabindex="-1"></a>          <span class="kw">unquote</span>(repo),</span>
<span id="cb241-8"><a href="abstract-duplicated-supervision-code.html#cb241-8" aria-hidden="true" tabindex="-1"></a>          <span class="kw">unquote</span>(schema),</span>
<span id="cb241-9"><a href="abstract-duplicated-supervision-code.html#cb241-9" aria-hidden="true" tabindex="-1"></a>          <span class="kw">unquote</span>(module), </span>
<span id="cb241-10"><a href="abstract-duplicated-supervision-code.html#cb241-10" aria-hidden="true" tabindex="-1"></a>          <span class="kw">unquote</span>(worker_module)</span>
<span id="cb241-11"><a href="abstract-duplicated-supervision-code.html#cb241-11" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb241-12"><a href="abstract-duplicated-supervision-code.html#cb241-12" aria-hidden="true" tabindex="-1"></a>      <span class="kw">end</span></span>
<span id="cb241-13"><a href="abstract-duplicated-supervision-code.html#cb241-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-14"><a href="abstract-duplicated-supervision-code.html#cb241-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> stop_worker(symbol) <span class="kw">do</span></span>
<span id="cb241-15"><a href="abstract-duplicated-supervision-code.html#cb241-15" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span><span class="op">.</span>stop_worker(</span>
<span id="cb241-16"><a href="abstract-duplicated-supervision-code.html#cb241-16" aria-hidden="true" tabindex="-1"></a>          symbol, <span class="co"># &lt;= this needs to stay as variable</span></span>
<span id="cb241-17"><a href="abstract-duplicated-supervision-code.html#cb241-17" aria-hidden="true" tabindex="-1"></a>          <span class="kw">unquote</span>(repo),</span>
<span id="cb241-18"><a href="abstract-duplicated-supervision-code.html#cb241-18" aria-hidden="true" tabindex="-1"></a>          <span class="kw">unquote</span>(schema),</span>
<span id="cb241-19"><a href="abstract-duplicated-supervision-code.html#cb241-19" aria-hidden="true" tabindex="-1"></a>          <span class="kw">unquote</span>(module),</span>
<span id="cb241-20"><a href="abstract-duplicated-supervision-code.html#cb241-20" aria-hidden="true" tabindex="-1"></a>          <span class="kw">unquote</span>(worker_module)</span>
<span id="cb241-21"><a href="abstract-duplicated-supervision-code.html#cb241-21" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb241-22"><a href="abstract-duplicated-supervision-code.html#cb241-22" aria-hidden="true" tabindex="-1"></a>      <span class="kw">end</span></span></code></pre></div>
<p>Here we have an example of an execution time variable called <code>symbol</code> that we should <em>not</em> <code>unquote</code> as it will be different per function call (source code should have <code>symbol</code> variable there not for example <code>"NEOUSDT"</code>).</p>
<p>At this moment the <code>Naive.DynamicSymbolSupervisor</code> consists of only <code>start_link/1</code>, <code>init/1</code> and <code>shutdown_worker/1</code>, it’s under 50 lines of code and works exactly as before refactoring. All of the boilerplate was moved to the <code>Core.ServiceSupervisor</code> module.</p>
<p>We left the <code>shutdown_worker/1</code> function as it’s specific to the <code>naive</code> application, but inside it, we utilize both the <code>get_pid/2</code> and the <code>update_status/4</code> functions where we are passing the <code>naive</code> application-specific variables(like <code>Naive.Repo</code>).</p>
<p>To make things even nicer we can create convenience wrappers for those two functions inside the <code>__using__/1</code> macro:</p>
<div class="sourceCode" id="cb242"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb242-1"><a href="abstract-duplicated-supervision-code.html#cb242-1" aria-hidden="true" tabindex="-1"></a>      <span class="co"># /apps/core/lib/core/service_supervisor.ex</span></span>
<span id="cb242-2"><a href="abstract-duplicated-supervision-code.html#cb242-2" aria-hidden="true" tabindex="-1"></a>      <span class="co"># add below at the end of `quote` block inside `__using__/1`</span></span>
<span id="cb242-3"><a href="abstract-duplicated-supervision-code.html#cb242-3" aria-hidden="true" tabindex="-1"></a>      <span class="kw">defp</span> get_pid(symbol) <span class="kw">do</span></span>
<span id="cb242-4"><a href="abstract-duplicated-supervision-code.html#cb242-4" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span><span class="op">.</span>get_pid(</span>
<span id="cb242-5"><a href="abstract-duplicated-supervision-code.html#cb242-5" aria-hidden="true" tabindex="-1"></a>          <span class="kw">unquote</span>(worker_module),</span>
<span id="cb242-6"><a href="abstract-duplicated-supervision-code.html#cb242-6" aria-hidden="true" tabindex="-1"></a>          symbol</span>
<span id="cb242-7"><a href="abstract-duplicated-supervision-code.html#cb242-7" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb242-8"><a href="abstract-duplicated-supervision-code.html#cb242-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">end</span></span>
<span id="cb242-9"><a href="abstract-duplicated-supervision-code.html#cb242-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb242-10"><a href="abstract-duplicated-supervision-code.html#cb242-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">defp</span> update_status(symbol, status) <span class="kw">do</span></span>
<span id="cb242-11"><a href="abstract-duplicated-supervision-code.html#cb242-11" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span><span class="op">.</span>update_status(</span>
<span id="cb242-12"><a href="abstract-duplicated-supervision-code.html#cb242-12" aria-hidden="true" tabindex="-1"></a>          symbol,</span>
<span id="cb242-13"><a href="abstract-duplicated-supervision-code.html#cb242-13" aria-hidden="true" tabindex="-1"></a>          status,</span>
<span id="cb242-14"><a href="abstract-duplicated-supervision-code.html#cb242-14" aria-hidden="true" tabindex="-1"></a>          <span class="kw">unquote</span>(repo),</span>
<span id="cb242-15"><a href="abstract-duplicated-supervision-code.html#cb242-15" aria-hidden="true" tabindex="-1"></a>          <span class="kw">unquote</span>(schema)</span>
<span id="cb242-16"><a href="abstract-duplicated-supervision-code.html#cb242-16" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb242-17"><a href="abstract-duplicated-supervision-code.html#cb242-17" aria-hidden="true" tabindex="-1"></a>      <span class="kw">end</span></span></code></pre></div>
<p>As those will get compiled and “pasted” into the <code>Naive.DynamicSymbolSupervisor</code> module we can utilize them inside the <code>shutdown_worker/1</code> function as they would be much simpler naive application-specific local functions:</p>
<div class="sourceCode" id="cb243"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb243-1"><a href="abstract-duplicated-supervision-code.html#cb243-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/naive/lib/naive/dynamic_symbol_supervisor.ex</span></span>
<span id="cb243-2"><a href="abstract-duplicated-supervision-code.html#cb243-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> shutdown_worker(symbol) <span class="kw">when</span> is_binary(symbol) <span class="kw">do</span></span>
<span id="cb243-3"><a href="abstract-duplicated-supervision-code.html#cb243-3" aria-hidden="true" tabindex="-1"></a>    symbol <span class="op">=</span> <span class="cn">String</span><span class="op">.</span>upcase(symbol)</span>
<span id="cb243-4"><a href="abstract-duplicated-supervision-code.html#cb243-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb243-5"><a href="abstract-duplicated-supervision-code.html#cb243-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">case</span> get_pid(symbol) <span class="kw">do</span> <span class="co"># &lt;= macro provided function</span></span>
<span id="cb243-6"><a href="abstract-duplicated-supervision-code.html#cb243-6" aria-hidden="true" tabindex="-1"></a>      <span class="cn">nil</span> <span class="op">-&gt;</span></span>
<span id="cb243-7"><a href="abstract-duplicated-supervision-code.html#cb243-7" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Logger</span><span class="op">.</span>warn(<span class="st">&quot;</span><span class="ot">#{</span><span class="cn">Naive</span><span class="op">.</span><span class="cn">SymbolSupervisor</span><span class="ot">}</span><span class="st"> worker for </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st"> already stopped&quot;</span>)</span>
<span id="cb243-8"><a href="abstract-duplicated-supervision-code.html#cb243-8" aria-hidden="true" tabindex="-1"></a>        {<span class="va">:ok</span>, _settings} <span class="op">=</span> update_status(symbol, <span class="st">&quot;off&quot;</span>) <span class="co"># &lt;= macro provided function</span></span>
<span id="cb243-9"><a href="abstract-duplicated-supervision-code.html#cb243-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb243-10"><a href="abstract-duplicated-supervision-code.html#cb243-10" aria-hidden="true" tabindex="-1"></a>      _pid <span class="op">-&gt;</span></span>
<span id="cb243-11"><a href="abstract-duplicated-supervision-code.html#cb243-11" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Logger</span><span class="op">.</span>info(<span class="st">&quot;Initializing shutdown of </span><span class="ot">#{</span><span class="cn">Naive</span><span class="op">.</span><span class="cn">SymbolSupervisor</span><span class="ot">}</span><span class="st"> worker for </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st">&quot;</span>)</span>
<span id="cb243-12"><a href="abstract-duplicated-supervision-code.html#cb243-12" aria-hidden="true" tabindex="-1"></a>        {<span class="va">:ok</span>, settings} <span class="op">=</span> update_status(symbol, <span class="st">&quot;shutdown&quot;</span>) <span class="co"># &lt;= macro provided function</span></span>
<span id="cb243-13"><a href="abstract-duplicated-supervision-code.html#cb243-13" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Naive</span><span class="op">.</span><span class="cn">Leader</span><span class="op">.</span>notify(<span class="va">:settings_updated</span>, settings)</span>
<span id="cb243-14"><a href="abstract-duplicated-supervision-code.html#cb243-14" aria-hidden="true" tabindex="-1"></a>        {<span class="va">:ok</span>, settings}</span>
<span id="cb243-15"><a href="abstract-duplicated-supervision-code.html#cb243-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb243-16"><a href="abstract-duplicated-supervision-code.html#cb243-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>And now, a very last change - I promise ;) Both the <code>start_link/1</code> and the <code>init/1</code> functions are still referencing the <code>DynamicSupervisor</code> module which could be a little bit confusing - let’s swap those calls to use the <code>Core.ServiceSupervisor</code> module (both to not confuse people and be consistent with the <code>use</code> macro):</p>
<div class="sourceCode" id="cb244"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb244-1"><a href="abstract-duplicated-supervision-code.html#cb244-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/naive/lib/naive/dynamic_symbol_supervisor.ex</span></span>
<span id="cb244-2"><a href="abstract-duplicated-supervision-code.html#cb244-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> start_link(init_arg) <span class="kw">do</span></span>
<span id="cb244-3"><a href="abstract-duplicated-supervision-code.html#cb244-3" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span><span class="op">.</span>start_link(<span class="cn">__MODULE__</span>, init_arg, <span class="va">name:</span> <span class="cn">__MODULE__</span>)</span>
<span id="cb244-4"><a href="abstract-duplicated-supervision-code.html#cb244-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb244-5"><a href="abstract-duplicated-supervision-code.html#cb244-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-6"><a href="abstract-duplicated-supervision-code.html#cb244-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> init(_init_arg) <span class="kw">do</span></span>
<span id="cb244-7"><a href="abstract-duplicated-supervision-code.html#cb244-7" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span><span class="op">.</span>init(<span class="va">strategy:</span> <span class="va">:one_for_one</span>)</span>
<span id="cb244-8"><a href="abstract-duplicated-supervision-code.html#cb244-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>As we don’t want/need to do anything different inside the <code>Core.ServiceSupervisor</code> module than the <code>DynamicSupervisor</code> is doing we can just delegate both of those inside the <code>Core.ServiceSupervisor</code> module:</p>
<div class="sourceCode" id="cb245"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb245-1"><a href="abstract-duplicated-supervision-code.html#cb245-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/core/lib/core/service_supervisor.ex</span></span>
<span id="cb245-2"><a href="abstract-duplicated-supervision-code.html#cb245-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defdelegate</span> start_link(module, args, opts), <span class="va">to:</span> <span class="cn">DynamicSupervisor</span></span>
<span id="cb245-3"><a href="abstract-duplicated-supervision-code.html#cb245-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defdelegate</span> init(opts), <span class="va">to:</span> <span class="cn">DynamicSupervisor</span></span></code></pre></div>
<p>That finishes our refactoring of both the <code>Naive.DynamicSymbolSupervisor</code> and the <code>Core.ServiceSupervisor</code> modules.</p>
<p>We can test to confirm that everything works as expected:</p>
<div class="sourceCode" id="cb246"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb246-1"><a href="abstract-duplicated-supervision-code.html#cb246-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> iex <span class="at">-S</span> mix</span>
<span id="cb246-2"><a href="abstract-duplicated-supervision-code.html#cb246-2" aria-hidden="true" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">1</span><span class="kw">)</span><span class="op">&gt;</span> Naive.start_trading<span class="kw">(</span><span class="st">&quot;NEOUSDT&quot;</span><span class="kw">)</span>    </span>
<span id="cb246-3"><a href="abstract-duplicated-supervision-code.html#cb246-3" aria-hidden="true" tabindex="-1"></a><span class="ex">21:42:37.741</span> [info]  Starting Elixir.Naive.SymbolSupervisor worker for NEOUSDT</span>
<span id="cb246-4"><a href="abstract-duplicated-supervision-code.html#cb246-4" aria-hidden="true" tabindex="-1"></a><span class="ex">21:42:37.768</span> [info]  Starting new supervision tree to trade on NEOUSDT</span>
<span id="cb246-5"><a href="abstract-duplicated-supervision-code.html#cb246-5" aria-hidden="true" tabindex="-1"></a><span class="ex">{:ok,</span> <span class="co">#PID&lt;0.464.0&gt;}</span></span>
<span id="cb246-6"><a href="abstract-duplicated-supervision-code.html#cb246-6" aria-hidden="true" tabindex="-1"></a><span class="ex">21:42:39.455</span> [info]  Initializing new trader<span class="er">(</span><span class="ex">1614462159452</span><span class="kw">)</span> <span class="cf">for</span> NEOUSDT</span>
<span id="cb246-7"><a href="abstract-duplicated-supervision-code.html#cb246-7" aria-hidden="true" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">2</span><span class="kw">)</span><span class="op">&gt;</span> Naive.stop_trading<span class="kw">(</span><span class="st">&quot;NEOUSDT&quot;</span><span class="kw">)</span> </span>
<span id="cb246-8"><a href="abstract-duplicated-supervision-code.html#cb246-8" aria-hidden="true" tabindex="-1"></a><span class="ex">21:43:08.362</span> [info]  Stopping Elixir.Naive.SymbolSupervisor worker for NEOUSDT</span>
<span id="cb246-9"><a href="abstract-duplicated-supervision-code.html#cb246-9" aria-hidden="true" tabindex="-1"></a><span class="ex">{:ok,</span></span>
<span id="cb246-10"><a href="abstract-duplicated-supervision-code.html#cb246-10" aria-hidden="true" tabindex="-1"></a> <span class="ex">%Naive.Schema.Settings{</span></span>
<span id="cb246-11"><a href="abstract-duplicated-supervision-code.html#cb246-11" aria-hidden="true" tabindex="-1"></a>   <span class="ex">...</span></span>
<span id="cb246-12"><a href="abstract-duplicated-supervision-code.html#cb246-12" aria-hidden="true" tabindex="-1"></a> <span class="er">}}</span></span>
<span id="cb246-13"><a href="abstract-duplicated-supervision-code.html#cb246-13" aria-hidden="true" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">3</span><span class="kw">)</span><span class="op">&gt;</span> Naive.start_trading<span class="kw">(</span><span class="st">&quot;HNTUSDT&quot;</span><span class="kw">)</span></span>
<span id="cb246-14"><a href="abstract-duplicated-supervision-code.html#cb246-14" aria-hidden="true" tabindex="-1"></a><span class="ex">21:44:08.689</span> [info]  Starting Elixir.Naive.SymbolSupervisor worker for HNTUSDT</span>
<span id="cb246-15"><a href="abstract-duplicated-supervision-code.html#cb246-15" aria-hidden="true" tabindex="-1"></a><span class="ex">21:44:08.723</span> [info]  Starting new supervision tree to trade on HNTUSDT</span>
<span id="cb246-16"><a href="abstract-duplicated-supervision-code.html#cb246-16" aria-hidden="true" tabindex="-1"></a><span class="ex">{:ok,</span> <span class="co">#PID&lt;0.475.0&gt;}</span></span>
<span id="cb246-17"><a href="abstract-duplicated-supervision-code.html#cb246-17" aria-hidden="true" tabindex="-1"></a><span class="ex">21:44:11.182</span> [info]  Initializing new trader<span class="er">(</span><span class="ex">1614462251182</span><span class="kw">)</span> <span class="cf">for</span> HNTUSDT</span>
<span id="cb246-18"><a href="abstract-duplicated-supervision-code.html#cb246-18" aria-hidden="true" tabindex="-1"></a><span class="ex">BREAK:</span> <span class="er">(</span><span class="ex">a</span><span class="kw">)</span><span class="ex">bort</span> <span class="er">(</span><span class="ex">A</span><span class="kw">)</span><span class="ex">bort</span> with dump <span class="er">(</span><span class="ex">c</span><span class="kw">)</span><span class="ex">ontinue</span> <span class="er">(</span><span class="ex">p</span><span class="kw">)</span><span class="ex">roc</span> info <span class="er">(</span><span class="ex">i</span><span class="kw">)</span><span class="ex">nfo</span></span>
<span id="cb246-19"><a href="abstract-duplicated-supervision-code.html#cb246-19" aria-hidden="true" tabindex="-1"></a>       <span class="kw">(</span><span class="ex">l</span><span class="kw">)</span><span class="ex">oaded</span> <span class="er">(</span><span class="ex">v</span><span class="kw">)</span><span class="ex">ersion</span> <span class="er">(</span><span class="ex">k</span><span class="kw">)</span><span class="ex">ill</span> <span class="er">(</span><span class="ex">D</span><span class="kw">)</span><span class="ex">b-tables</span> <span class="er">(</span><span class="ex">d</span><span class="kw">)</span><span class="ex">istribution</span></span>
<span id="cb246-20"><a href="abstract-duplicated-supervision-code.html#cb246-20" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> iex <span class="at">-S</span> mix</span>
<span id="cb246-21"><a href="abstract-duplicated-supervision-code.html#cb246-21" aria-hidden="true" tabindex="-1"></a><span class="ex">21:47:22.119</span> [info]  Starting Elixir.Naive.SymbolSupervisor worker for HNTUSDT</span>
<span id="cb246-22"><a href="abstract-duplicated-supervision-code.html#cb246-22" aria-hidden="true" tabindex="-1"></a><span class="ex">21:47:22.161</span> [info]  Starting new supervision tree to trade on HNTUSDT</span>
<span id="cb246-23"><a href="abstract-duplicated-supervision-code.html#cb246-23" aria-hidden="true" tabindex="-1"></a><span class="ex">21:47:24.213</span> [info]  Initializing new trader<span class="er">(</span><span class="ex">1614462444212</span><span class="kw">)</span> <span class="cf">for</span> HNTUSDT</span>
<span id="cb246-24"><a href="abstract-duplicated-supervision-code.html#cb246-24" aria-hidden="true" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">1</span><span class="kw">)</span><span class="op">&gt;</span> Naive.shutdown_trading<span class="kw">(</span><span class="st">&quot;HNTUSDT&quot;</span><span class="kw">)</span></span>
<span id="cb246-25"><a href="abstract-duplicated-supervision-code.html#cb246-25" aria-hidden="true" tabindex="-1"></a><span class="ex">21:48:42.003</span> [info]  Initializing shutdown of Elixir.Naive.SymbolSupervisor worker for HNTUSDT</span>
<span id="cb246-26"><a href="abstract-duplicated-supervision-code.html#cb246-26" aria-hidden="true" tabindex="-1"></a><span class="ex">{:ok,</span></span>
<span id="cb246-27"><a href="abstract-duplicated-supervision-code.html#cb246-27" aria-hidden="true" tabindex="-1"></a> <span class="ex">%Naive.Schema.Settings{</span></span>
<span id="cb246-28"><a href="abstract-duplicated-supervision-code.html#cb246-28" aria-hidden="true" tabindex="-1"></a>   <span class="ex">...</span></span>
<span id="cb246-29"><a href="abstract-duplicated-supervision-code.html#cb246-29" aria-hidden="true" tabindex="-1"></a> <span class="er">}}</span></span></code></pre></div>
<p>The above test confirms that we can start, stop, and shut down trading on a symbol as well as autostarting of trading works.</p>
</div>
<div id="use-the-core.servicesupervisor-module-inside-the-streamer-application" class="section level2" number="13.7">
<h2><span class="header-section-number">13.7</span> Use the <code>Core.ServiceSupervisor</code> module inside the <code>streamer</code> application</h2>
<p>As we are happy with the implementation of the <code>Core.ServiceSupervisor</code> module we can upgrade the <code>streamer</code> application to use it.</p>
<p>We need to start with adding the <code>core</code> application to the list of dependencies of the <code>streamer</code> application:</p>
<div class="sourceCode" id="cb247"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb247-1"><a href="abstract-duplicated-supervision-code.html#cb247-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/streamer/mix.exs</span></span>
<span id="cb247-2"><a href="abstract-duplicated-supervision-code.html#cb247-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defp</span> deps <span class="kw">do</span></span>
<span id="cb247-3"><a href="abstract-duplicated-supervision-code.html#cb247-3" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb247-4"><a href="abstract-duplicated-supervision-code.html#cb247-4" aria-hidden="true" tabindex="-1"></a>      {<span class="va">:binance</span>, <span class="st">&quot;~&gt; 0.7.1&quot;</span>},</span>
<span id="cb247-5"><a href="abstract-duplicated-supervision-code.html#cb247-5" aria-hidden="true" tabindex="-1"></a>      {<span class="va">:core</span>, <span class="va">in_umbrella:</span> <span class="cn">true</span>}, <span class="co"># &lt;= core added to deps</span></span>
<span id="cb247-6"><a href="abstract-duplicated-supervision-code.html#cb247-6" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span></span></code></pre></div>
<p>We can now move on to the <code>Streamer.DynamicStreamerSupervisor</code> where we will remove everything (really everything including <code>import</code>s, <code>alias</code>es and even <code>require</code>) beside the <code>start_link/1</code> and the <code>init/1</code>. As with the <code>Naive.DynamicSymbolSupervisor</code> we will <code>use</code> the <code>Core.ServiceSupervisor</code> and pass all required options - <em>full</em> implementation of the <code>Streamer.DynamicStreamerSupervisor</code> module should look as follows:</p>
<div class="sourceCode" id="cb248"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb248-1"><a href="abstract-duplicated-supervision-code.html#cb248-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/streamer/lib/streamer/dynamic_streamer_supervisor.ex</span></span>
<span id="cb248-2"><a href="abstract-duplicated-supervision-code.html#cb248-2" aria-hidden="true" tabindex="-1"></a><span class="kw">defmodule</span> <span class="cn">Streamer</span><span class="op">.</span><span class="cn">DynamicStreamerSupervisor</span> <span class="kw">do</span></span>
<span id="cb248-3"><a href="abstract-duplicated-supervision-code.html#cb248-3" aria-hidden="true" tabindex="-1"></a>  <span class="im">use</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span>,</span>
<span id="cb248-4"><a href="abstract-duplicated-supervision-code.html#cb248-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">repo:</span> <span class="cn">Streamer</span><span class="op">.</span><span class="cn">Repo</span>,</span>
<span id="cb248-5"><a href="abstract-duplicated-supervision-code.html#cb248-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">schema:</span> <span class="cn">Streamer</span><span class="op">.</span><span class="cn">Schema</span><span class="op">.</span><span class="cn">Settings</span>,</span>
<span id="cb248-6"><a href="abstract-duplicated-supervision-code.html#cb248-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">module:</span> <span class="cn">__MODULE__</span>,</span>
<span id="cb248-7"><a href="abstract-duplicated-supervision-code.html#cb248-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">worker_module:</span> <span class="cn">Streamer</span><span class="op">.</span><span class="cn">Binance</span></span>
<span id="cb248-8"><a href="abstract-duplicated-supervision-code.html#cb248-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-9"><a href="abstract-duplicated-supervision-code.html#cb248-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> start_link(init_arg) <span class="kw">do</span></span>
<span id="cb248-10"><a href="abstract-duplicated-supervision-code.html#cb248-10" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span><span class="op">.</span>start_link(<span class="cn">__MODULE__</span>, init_arg, <span class="va">name:</span> <span class="cn">__MODULE__</span>)</span>
<span id="cb248-11"><a href="abstract-duplicated-supervision-code.html#cb248-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb248-12"><a href="abstract-duplicated-supervision-code.html#cb248-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-13"><a href="abstract-duplicated-supervision-code.html#cb248-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> init(_init_arg) <span class="kw">do</span></span>
<span id="cb248-14"><a href="abstract-duplicated-supervision-code.html#cb248-14" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Core</span><span class="op">.</span><span class="cn">ServiceSupervisor</span><span class="op">.</span>init(<span class="va">strategy:</span> <span class="va">:one_for_one</span>)</span>
<span id="cb248-15"><a href="abstract-duplicated-supervision-code.html#cb248-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb248-16"><a href="abstract-duplicated-supervision-code.html#cb248-16" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<p>Not much to add here - we are <code>use</code>ing the <code>Core.ServiceSupervisor</code> module and passing options to it so it can macro generates <code>streamer</code> application-specific wrappers(like <code>start_worker/1</code> or <code>stop_worker/1</code> with required repo, schema etc) around generic logic from the <code>Core.ServiceSupervisor</code> module.</p>
<p>Using the <code>Core.Servicesupervisor</code> module will have an impact on the interface of the <code>Streamer.DynamicStreamerSupervisor</code> as it will now provide functions like <code>start_worker/1</code> instead of <code>start_streaming/1</code> etc.</p>
<p>As with the <code>naive</code> application, we need to update the Task function inside the <code>Streamer.Supervisor</code> module:</p>
<div class="sourceCode" id="cb249"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb249-1"><a href="abstract-duplicated-supervision-code.html#cb249-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/streamer/lib/streamer/supervisor.ex</span></span>
<span id="cb249-2"><a href="abstract-duplicated-supervision-code.html#cb249-2" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span></span>
<span id="cb249-3"><a href="abstract-duplicated-supervision-code.html#cb249-3" aria-hidden="true" tabindex="-1"></a>      {<span class="cn">Task</span>,</span>
<span id="cb249-4"><a href="abstract-duplicated-supervision-code.html#cb249-4" aria-hidden="true" tabindex="-1"></a>       <span class="kw">fn</span> <span class="op">-&gt;</span></span>
<span id="cb249-5"><a href="abstract-duplicated-supervision-code.html#cb249-5" aria-hidden="true" tabindex="-1"></a>         <span class="cn">Streamer</span><span class="op">.</span><span class="cn">DynamicStreamerSupervisor</span><span class="op">.</span>autostart_workers()</span>
<span id="cb249-6"><a href="abstract-duplicated-supervision-code.html#cb249-6" aria-hidden="true" tabindex="-1"></a>       <span class="kw">end</span>}</span>
<span id="cb249-7"><a href="abstract-duplicated-supervision-code.html#cb249-7" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span></span></code></pre></div>
<p>As well as main <code>Streamer</code> module needs to forward calls instead of delegating:</p>
<div class="sourceCode" id="cb250"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb250-1"><a href="abstract-duplicated-supervision-code.html#cb250-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/streamer/lib/streamer.ex</span></span>
<span id="cb250-2"><a href="abstract-duplicated-supervision-code.html#cb250-2" aria-hidden="true" tabindex="-1"></a>  <span class="im">alias</span> <span class="cn">Streamer</span><span class="op">.</span><span class="cn">DynamicStreamerSupervisor</span></span>
<span id="cb250-3"><a href="abstract-duplicated-supervision-code.html#cb250-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-4"><a href="abstract-duplicated-supervision-code.html#cb250-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defdelegate</span> start_streaming(symbol), <span class="va">to:</span> <span class="cn">DynamicStreamerSupervisor</span>, <span class="va">as:</span> <span class="va">:start_worker</span></span>
<span id="cb250-5"><a href="abstract-duplicated-supervision-code.html#cb250-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defdelegate</span> stop_streaming(symbol), <span class="va">to:</span> <span class="cn">DynamicStreamerSupervisor</span>, <span class="va">as:</span> <span class="va">:stop_worker</span></span></code></pre></div>
<p>We can run a quick test to confirm that indeed everything works as expected:</p>
<div class="sourceCode" id="cb251"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb251-1"><a href="abstract-duplicated-supervision-code.html#cb251-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> iex <span class="at">-S</span> mix</span>
<span id="cb251-2"><a href="abstract-duplicated-supervision-code.html#cb251-2" aria-hidden="true" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">1</span><span class="kw">)</span><span class="op">&gt;</span> Streamer.start_streaming<span class="kw">(</span><span class="st">&quot;NEOUSDT&quot;</span><span class="kw">)</span></span>
<span id="cb251-3"><a href="abstract-duplicated-supervision-code.html#cb251-3" aria-hidden="true" tabindex="-1"></a><span class="ex">22:10:38.813</span> [info]  Starting Elixir.Streamer.Binance worker for NEOUSDT</span>
<span id="cb251-4"><a href="abstract-duplicated-supervision-code.html#cb251-4" aria-hidden="true" tabindex="-1"></a><span class="ex">{:ok,</span> <span class="co">#PID&lt;0.465.0&gt;}</span></span>
<span id="cb251-5"><a href="abstract-duplicated-supervision-code.html#cb251-5" aria-hidden="true" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">2</span><span class="kw">)</span><span class="op">&gt;</span> Streamer.stop_streaming<span class="kw">(</span><span class="st">&quot;NEOUSDT&quot;</span><span class="kw">)</span></span>
<span id="cb251-6"><a href="abstract-duplicated-supervision-code.html#cb251-6" aria-hidden="true" tabindex="-1"></a><span class="ex">22:10:48.212</span> [info]  Stopping Elixir.Streamer.Binance worker for NEOUSDT</span>
<span id="cb251-7"><a href="abstract-duplicated-supervision-code.html#cb251-7" aria-hidden="true" tabindex="-1"></a><span class="ex">{:ok,</span></span>
<span id="cb251-8"><a href="abstract-duplicated-supervision-code.html#cb251-8" aria-hidden="true" tabindex="-1"></a> <span class="ex">%Streamer.Schema.Settings{</span></span>
<span id="cb251-9"><a href="abstract-duplicated-supervision-code.html#cb251-9" aria-hidden="true" tabindex="-1"></a>   <span class="ex">__meta__:</span> <span class="co">#Ecto.Schema.Metadata&lt;:loaded, &quot;settings&quot;&gt;,</span></span>
<span id="cb251-10"><a href="abstract-duplicated-supervision-code.html#cb251-10" aria-hidden="true" tabindex="-1"></a>   <span class="ex">id:</span> <span class="st">&quot;db8c9429-2356-4243-a08f-0d0e89b74986&quot;</span>,</span>
<span id="cb251-11"><a href="abstract-duplicated-supervision-code.html#cb251-11" aria-hidden="true" tabindex="-1"></a>   <span class="ex">inserted_at:</span> ~N[2021-02-25 22:15:16],</span>
<span id="cb251-12"><a href="abstract-duplicated-supervision-code.html#cb251-12" aria-hidden="true" tabindex="-1"></a>   <span class="ex">status:</span> <span class="st">&quot;off&quot;</span>,</span>
<span id="cb251-13"><a href="abstract-duplicated-supervision-code.html#cb251-13" aria-hidden="true" tabindex="-1"></a>   <span class="ex">symbol:</span> <span class="st">&quot;NEOUSDT&quot;</span>,</span>
<span id="cb251-14"><a href="abstract-duplicated-supervision-code.html#cb251-14" aria-hidden="true" tabindex="-1"></a>   <span class="ex">updated_at:</span> ~N[2021-02-27 22:10:48]</span>
<span id="cb251-15"><a href="abstract-duplicated-supervision-code.html#cb251-15" aria-hidden="true" tabindex="-1"></a> <span class="er">}}</span></span>
<span id="cb251-16"><a href="abstract-duplicated-supervision-code.html#cb251-16" aria-hidden="true" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">3</span><span class="kw">)</span><span class="op">&gt;</span> Streamer.start_streaming<span class="kw">(</span><span class="st">&quot;LTCUSDT&quot;</span><span class="kw">)</span> </span>
<span id="cb251-17"><a href="abstract-duplicated-supervision-code.html#cb251-17" aria-hidden="true" tabindex="-1"></a><span class="ex">22:26:03.361</span> [info]  Starting Elixir.Streamer.Binance worker for LTCUSDT</span>
<span id="cb251-18"><a href="abstract-duplicated-supervision-code.html#cb251-18" aria-hidden="true" tabindex="-1"></a><span class="ex">{:ok,</span> <span class="co">#PID&lt;0.490.0&gt;}</span></span>
<span id="cb251-19"><a href="abstract-duplicated-supervision-code.html#cb251-19" aria-hidden="true" tabindex="-1"></a><span class="ex">BREAK:</span> <span class="er">(</span><span class="ex">a</span><span class="kw">)</span><span class="ex">bort</span> <span class="er">(</span><span class="ex">A</span><span class="kw">)</span><span class="ex">bort</span> with dump <span class="er">(</span><span class="ex">c</span><span class="kw">)</span><span class="ex">ontinue</span> <span class="er">(</span><span class="ex">p</span><span class="kw">)</span><span class="ex">roc</span> info <span class="er">(</span><span class="ex">i</span><span class="kw">)</span><span class="ex">nfo</span></span>
<span id="cb251-20"><a href="abstract-duplicated-supervision-code.html#cb251-20" aria-hidden="true" tabindex="-1"></a>       <span class="kw">(</span><span class="ex">l</span><span class="kw">)</span><span class="ex">oaded</span> <span class="er">(</span><span class="ex">v</span><span class="kw">)</span><span class="ex">ersion</span> <span class="er">(</span><span class="ex">k</span><span class="kw">)</span><span class="ex">ill</span> <span class="er">(</span><span class="ex">D</span><span class="kw">)</span><span class="ex">b-tables</span> <span class="er">(</span><span class="ex">d</span><span class="kw">)</span><span class="ex">istribution</span></span>
<span id="cb251-21"><a href="abstract-duplicated-supervision-code.html#cb251-21" aria-hidden="true" tabindex="-1"></a><span class="ex">^C</span></span>
<span id="cb251-22"><a href="abstract-duplicated-supervision-code.html#cb251-22" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> iex <span class="at">-S</span> mix</span>
<span id="cb251-23"><a href="abstract-duplicated-supervision-code.html#cb251-23" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb251-24"><a href="abstract-duplicated-supervision-code.html#cb251-24" aria-hidden="true" tabindex="-1"></a><span class="ex">22:26:30.775</span> [info]  Starting Elixir.Streamer.Binance worker for LTCUSDT</span></code></pre></div>
<p>This finishes the implementation for both the <code>streamer</code> and the <code>naive</code> application. We are generating dynamic functions(metaprogramming) using Elixir macros which is a cool exercise to go through and feels like superpowers ;)</p>
<p>[Note] Please remember to run <code>mix format</code> to keep things nice and tidy.</p>
<p>Source code for this chapter can be found at <a href="https://github.com/frathon/create-a-cryptocurrency-trading-bot-in-elixir-source-code/tree/chapter_13">Github</a></p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="start-stop-shutdown-and-autostart-trading.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="store-trade-events-and-orders-inside-the-database.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/frathon/create-a-cryptocurrency-trading-bot-in-elixir/edit/master/13-abstract-duplicated-code-using-macros.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["create-a-cryptocurrency-trading-bot-in-elixir.pdf", "create-a-cryptocurrency-trading-bot-in-elixir.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
