<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 21 Layers of abstraction | Hands-on Elixir &amp; OTP: Cryptocurrency trading bot</title>
  <meta name="description" content="Chapter 21 Layers of abstraction | Hands-on Elixir &amp; OTP: Cryptocurrency trading bot" />
  <meta name="generator" content="bookdown 0.32 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 21 Layers of abstraction | Hands-on Elixir &amp; OTP: Cryptocurrency trading bot" />
  <meta property="og:type" content="book" />
  
  
  <meta name="github-repo" content="Cinderella-Man/hands-on-elixir-and-otp-cryptocurrency-trading-bot" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 21 Layers of abstraction | Hands-on Elixir &amp; OTP: Cryptocurrency trading bot" />
  <meta name="twitter:site" content="@kamilskowron" />
  
  

<meta name="author" content="Kamil Skowron" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="idiomatic-trading-strategy.html"/>

<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-52FKGBX2B8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-52FKGBX2B8');
</script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Hands-on Elixir & OTP: Cryptocurrency trading bot</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#want-to-learn-elixir-otp-by-creating-a-real-world-project"><i class="fa fa-check"></i>Want to learn Elixir &amp; OTP by creating a real-world project?</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#limit-of-liabilitydisclaimer-of-warranty"><i class="fa fa-check"></i>Limit of Liability/Disclaimer of Warranty</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#pdf-epub"><i class="fa fa-check"></i>PDF &amp; EPUB</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#preface-1"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#who-this-book-is-for"><i class="fa fa-check"></i>Who this book is for</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#what-this-book-covers"><i class="fa fa-check"></i>What this book covers</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#contributing-errata-and-source-code"><i class="fa fa-check"></i>Contributing, Errata and Source code</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><i class="fa fa-check"></i><b>1</b> Stream live cryptocurrency prices from the Binance WSS</a>
<ul>
<li class="chapter" data-level="1.1" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html#objectives"><i class="fa fa-check"></i><b>1.1</b> Objectives</a></li>
<li class="chapter" data-level="1.2" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html#create-a-new-umbrella-app"><i class="fa fa-check"></i><b>1.2</b> Create a new umbrella app</a></li>
<li class="chapter" data-level="1.3" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html#create-a-supervised-application-inside-an-umbrella"><i class="fa fa-check"></i><b>1.3</b> Create a supervised application inside an umbrella</a></li>
<li class="chapter" data-level="1.4" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html#connect-to-binances-websocket-stream-using-the-websockex-module"><i class="fa fa-check"></i><b>1.4</b> Connect to Binance’s WebSocket Stream using the WebSockex module</a></li>
<li class="chapter" data-level="1.5" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html#decode-incoming-events-using-the-jason-module"><i class="fa fa-check"></i><b>1.5</b> Decode incoming events using the Jason module</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><i class="fa fa-check"></i><b>2</b> Create a naive trading strategy - a single trader process without supervision</a>
<ul>
<li class="chapter" data-level="2.1" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#objectives-1"><i class="fa fa-check"></i><b>2.1</b> Objectives</a></li>
<li class="chapter" data-level="2.2" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#initialisation"><i class="fa fa-check"></i><b>2.2</b> Initialisation</a></li>
<li class="chapter" data-level="2.3" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#how-trading-strategy-will-work"><i class="fa fa-check"></i><b>2.3</b> How trading strategy will work?</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#implementation-of-the-first-scenario"><i class="fa fa-check"></i><b>2.3.1</b> Implementation of the first scenario</a></li>
<li class="chapter" data-level="2.3.2" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#implementation-of-the-second-scenario"><i class="fa fa-check"></i><b>2.3.2</b> Implementation of the second scenario</a></li>
<li class="chapter" data-level="2.3.3" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#implementation-of-the-third-scenario"><i class="fa fa-check"></i><b>2.3.3</b> Implementation of the third scenario</a></li>
<li class="chapter" data-level="2.3.4" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#implementation-fallback-scenario"><i class="fa fa-check"></i><b>2.3.4</b> Implementation fallback scenario</a></li>
<li class="chapter" data-level="2.3.5" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#updating-the-naive-interface"><i class="fa fa-check"></i><b>2.3.5</b> Updating the Naive interface</a></li>
<li class="chapter" data-level="2.3.6" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#updating-streamer-app"><i class="fa fa-check"></i><b>2.3.6</b> Updating streamer app</a></li>
<li class="chapter" data-level="2.3.7" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#access-details-to-binance"><i class="fa fa-check"></i><b>2.3.7</b> Access details to Binance</a></li>
<li class="chapter" data-level="2.3.8" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#test-run"><i class="fa fa-check"></i><b>2.3.8</b> Test run</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html"><i class="fa fa-check"></i><b>3</b> Introduce PubSub as a communication method</a>
<ul>
<li class="chapter" data-level="3.1" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html#objectives-2"><i class="fa fa-check"></i><b>3.1</b> Objectives</a></li>
<li class="chapter" data-level="3.2" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html#design"><i class="fa fa-check"></i><b>3.2</b> Design</a></li>
<li class="chapter" data-level="3.3" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html#implementation"><i class="fa fa-check"></i><b>3.3</b> Implementation</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html"><i class="fa fa-check"></i><b>4</b> Mock the Binance API</a>
<ul>
<li class="chapter" data-level="4.1" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#objectives-3"><i class="fa fa-check"></i><b>4.1</b> Objectives</a></li>
<li class="chapter" data-level="4.2" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#design-1"><i class="fa fa-check"></i><b>4.2</b> Design</a></li>
<li class="chapter" data-level="4.3" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#create-binancemock-app"><i class="fa fa-check"></i><b>4.3</b> Create “BinanceMock” app</a></li>
<li class="chapter" data-level="4.4" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-getting-exchange-info"><i class="fa fa-check"></i><b>4.4</b> Implement getting exchange info</a></li>
<li class="chapter" data-level="4.5" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-placing-buy-and-sell-orders"><i class="fa fa-check"></i><b>4.5</b> Implement placing buy and sell orders</a></li>
<li class="chapter" data-level="4.6" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-order-retrival"><i class="fa fa-check"></i><b>4.6</b> Implement order retrival</a></li>
<li class="chapter" data-level="4.7" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-callback-for-incoming-trade-events"><i class="fa fa-check"></i><b>4.7</b> Implement callback for incoming trade events</a></li>
<li class="chapter" data-level="4.8" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#upgrade-trader-and-config"><i class="fa fa-check"></i><b>4.8</b> Upgrade trader and config</a></li>
<li class="chapter" data-level="4.9" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#test-the-implementation"><i class="fa fa-check"></i><b>4.9</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html"><i class="fa fa-check"></i><b>5</b> Enable parallel trading on multiple symbols</a>
<ul>
<li class="chapter" data-level="5.1" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#objectives-4"><i class="fa fa-check"></i><b>5.1</b> Objectives</a></li>
<li class="chapter" data-level="5.2" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#introduction---architectural-design"><i class="fa fa-check"></i><b>5.2</b> Introduction - architectural design</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#update-application-supervisor"><i class="fa fa-check"></i><b>5.2.1</b> Update application supervisor</a></li>
<li class="chapter" data-level="5.2.2" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#add-interface-method"><i class="fa fa-check"></i><b>5.2.2</b> Add interface method</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#implement-naive.symbolsupervisor"><i class="fa fa-check"></i><b>5.3</b> Implement <code>Naive.SymbolSupervisor</code></a></li>
<li class="chapter" data-level="5.4" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#implement-naive.leader"><i class="fa fa-check"></i><b>5.4</b> Implement <code>Naive.Leader</code></a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#updating-the-leader-module"><i class="fa fa-check"></i><b>5.4.1</b> Updating the <code>leader</code> module</a></li>
<li class="chapter" data-level="5.4.2" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#updating-the-naive.trader-module"><i class="fa fa-check"></i><b>5.4.2</b> Updating the <code>Naive.Trader</code> module</a></li>
<li class="chapter" data-level="5.4.3" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#finalizing-naive.leader-implementation"><i class="fa fa-check"></i><b>5.4.3</b> Finalizing <code>Naive.Leader</code> implementation</a></li>
<li class="chapter" data-level="5.4.4" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#iex-testing"><i class="fa fa-check"></i><b>5.4.4</b> IEx testing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html"><i class="fa fa-check"></i><b>6</b> Introduce a <code>buy_down_interval</code> to make a single trader more profitable</a>
<ul>
<li class="chapter" data-level="6.1" data-path="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html#objectives-5"><i class="fa fa-check"></i><b>6.1</b> Objectives</a></li>
<li class="chapter" data-level="6.2" data-path="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html#why-we-need-to-buy-below-the-current-price-feature-overview"><i class="fa fa-check"></i><b>6.2</b> Why we need to buy below the current price? Feature overview</a></li>
<li class="chapter" data-level="6.3" data-path="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html#naive.trader-implementation"><i class="fa fa-check"></i><b>6.3</b> <code>Naive.Trader</code> implementation</a></li>
<li class="chapter" data-level="6.4" data-path="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html#naive.leader-implementation"><i class="fa fa-check"></i><b>6.4</b> <code>Naive.Leader</code> implementation</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html#iex-testing-1"><i class="fa fa-check"></i><b>6.4.1</b> IEx testing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html"><i class="fa fa-check"></i><b>7</b> Introduce a trader budget and calculating the quantity</a>
<ul>
<li class="chapter" data-level="7.1" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#objectives-6"><i class="fa fa-check"></i><b>7.1</b> Objectives</a></li>
<li class="chapter" data-level="7.2" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#fetch-step_size"><i class="fa fa-check"></i><b>7.2</b> Fetch <code>step_size</code></a></li>
<li class="chapter" data-level="7.3" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#append-budget-and-step_size-to-the-traders-state-inside-the-leader"><i class="fa fa-check"></i><b>7.3</b> Append <code>budget</code> and <code>step_size</code> to the <code>Trader</code>’s state inside the <code>Leader</code></a></li>
<li class="chapter" data-level="7.4" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#append-budget-and-step_size-to-the-traders-state"><i class="fa fa-check"></i><b>7.4</b> Append <code>budget</code> and <code>step_size</code> to the <code>Trader</code>’s state</a></li>
<li class="chapter" data-level="7.5" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#calculate-quantity"><i class="fa fa-check"></i><b>7.5</b> Calculate quantity</a>
<ul>
<li class="chapter" data-level="7.5.1" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#iex-testing-2"><i class="fa fa-check"></i><b>7.5.1</b> IEx testing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html"><i class="fa fa-check"></i><b>8</b> Add support for multiple transactions per order</a>
<ul>
<li class="chapter" data-level="8.1" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#objectives-7"><i class="fa fa-check"></i><b>8.1</b> Objectives</a></li>
<li class="chapter" data-level="8.2" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#the-issue-with-the-current-implementation"><i class="fa fa-check"></i><b>8.2</b> The issue with the current implementation</a></li>
<li class="chapter" data-level="8.3" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#improve-buy-order-filled-callback"><i class="fa fa-check"></i><b>8.3</b> Improve buy order filled callback</a></li>
<li class="chapter" data-level="8.4" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#implement-buy-order-filled-callback"><i class="fa fa-check"></i><b>8.4</b> Implement buy order “filled” callback</a></li>
<li class="chapter" data-level="8.5" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#improve-sell-order-callback"><i class="fa fa-check"></i><b>8.5</b> Improve sell order callback</a></li>
<li class="chapter" data-level="8.6" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#test-the-implementation-1"><i class="fa fa-check"></i><b>8.6</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html"><i class="fa fa-check"></i><b>9</b> Run multiple traders in parallel</a>
<ul>
<li class="chapter" data-level="9.1" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#objectives-8"><i class="fa fa-check"></i><b>9.1</b> Objectives</a></li>
<li class="chapter" data-level="9.2" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#describe-and-design-the-required-functionality"><i class="fa fa-check"></i><b>9.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="9.3" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#implement-rebuy-inside-naive.trader"><i class="fa fa-check"></i><b>9.3</b> Implement rebuy inside <code>Naive.Trader</code></a></li>
<li class="chapter" data-level="9.4" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#implement-rebuy-in-the-naive.leader"><i class="fa fa-check"></i><b>9.4</b> Implement rebuy in the <code>Naive.Leader</code></a></li>
<li class="chapter" data-level="9.5" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#improve-logs-by-assigning-ids-to-traders"><i class="fa fa-check"></i><b>9.5</b> Improve logs by assigning ids to traders</a></li>
<li class="chapter" data-level="9.6" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#test-the-implementation-2"><i class="fa fa-check"></i><b>9.6</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html"><i class="fa fa-check"></i><b>10</b> Fine-tune trading strategy per symbol</a>
<ul>
<li class="chapter" data-level="10.1" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#objectives-9"><i class="fa fa-check"></i><b>10.1</b> Objectives</a></li>
<li class="chapter" data-level="10.2" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#describe-and-design-the-required-functionality-1"><i class="fa fa-check"></i><b>10.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="10.3" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#add-docker-to-project"><i class="fa fa-check"></i><b>10.3</b> Add docker to project</a></li>
<li class="chapter" data-level="10.4" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#set-up-ecto-inside-the-naive-app"><i class="fa fa-check"></i><b>10.4</b> Set up <code>ecto</code> inside the <code>naive</code> app</a></li>
<li class="chapter" data-level="10.5" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#create-and-migrate-the-db"><i class="fa fa-check"></i><b>10.5</b> Create and migrate the DB</a></li>
<li class="chapter" data-level="10.6" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#seed-symbols-settings"><i class="fa fa-check"></i><b>10.6</b> Seed symbols’ settings</a></li>
<li class="chapter" data-level="10.7" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#update-the-naive.leader-to-fetch-settings"><i class="fa fa-check"></i><b>10.7</b> Update the <code>Naive.Leader</code> to fetch settings</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html"><i class="fa fa-check"></i><b>11</b> Supervise and autostart streaming</a>
<ul>
<li class="chapter" data-level="11.1" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#objectives-10"><i class="fa fa-check"></i><b>11.1</b> Objectives</a></li>
<li class="chapter" data-level="11.2" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#describe-and-design-the-required-functionality-2"><i class="fa fa-check"></i><b>11.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="11.3" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#register-the-streamer.binance-processes-with-names"><i class="fa fa-check"></i><b>11.3</b> Register the <code>Streamer.Binance</code> processes with names</a></li>
<li class="chapter" data-level="11.4" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#set-up-ecto-inside-the-streamer-app"><i class="fa fa-check"></i><b>11.4</b> Set up <code>ecto</code> inside the <code>streamer</code> app</a></li>
<li class="chapter" data-level="11.5" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#create-and-migrate-the-db-1"><i class="fa fa-check"></i><b>11.5</b> Create and migrate the db</a></li>
<li class="chapter" data-level="11.6" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#seed-default-settings"><i class="fa fa-check"></i><b>11.6</b> Seed default settings</a></li>
<li class="chapter" data-level="11.7" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#implement-the-supervision-tree-and-start-streaming-functionality"><i class="fa fa-check"></i><b>11.7</b> Implement the supervision tree and start streaming functionality</a></li>
<li class="chapter" data-level="11.8" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#implement-the-stop-functionality"><i class="fa fa-check"></i><b>11.8</b> Implement the stop functionality</a></li>
<li class="chapter" data-level="11.9" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#implement-the-autostart-streaming-functionality"><i class="fa fa-check"></i><b>11.9</b> Implement the autostart streaming functionality</a></li>
<li class="chapter" data-level="11.10" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#test-the-implementation-3"><i class="fa fa-check"></i><b>11.10</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html"><i class="fa fa-check"></i><b>12</b> Start, stop, shutdown and autostart trading</a>
<ul>
<li class="chapter" data-level="12.1" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#objectives-11"><i class="fa fa-check"></i><b>12.1</b> Objectives</a></li>
<li class="chapter" data-level="12.2" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#describe-and-design-the-required-functionality-3"><i class="fa fa-check"></i><b>12.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="12.3" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#re-implement-the-start-trading-functionality"><i class="fa fa-check"></i><b>12.3</b> (Re-)Implement the start trading functionality</a></li>
<li class="chapter" data-level="12.4" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#implement-the-stop-trading-functionality"><i class="fa fa-check"></i><b>12.4</b> Implement the stop trading functionality</a></li>
<li class="chapter" data-level="12.5" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#implement-the-autostart-trading-functionality"><i class="fa fa-check"></i><b>12.5</b> Implement the autostart trading functionality</a></li>
<li class="chapter" data-level="12.6" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#implement-the-shutdown-trading-functionality"><i class="fa fa-check"></i><b>12.6</b> Implement the shutdown trading functionality</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html"><i class="fa fa-check"></i><b>13</b> Abstract duplicated supervision code</a>
<ul>
<li class="chapter" data-level="13.1" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#objectives-12"><i class="fa fa-check"></i><b>13.1</b> Objectives</a></li>
<li class="chapter" data-level="13.2" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#overview-of-requirements"><i class="fa fa-check"></i><b>13.2</b> Overview of requirements</a></li>
<li class="chapter" data-level="13.3" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#pseudo-generalize-core.servicesupervisor-module"><i class="fa fa-check"></i><b>13.3</b> Pseudo generalize Core.ServiceSupervisor module</a></li>
<li class="chapter" data-level="13.4" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#utilize-pseudo-generalized-code-inside-the-naive-dynamicsymbolsupervisor"><i class="fa fa-check"></i><b>13.4</b> Utilize pseudo generalized code inside the Naive DynamicSymbolSupervisor</a></li>
<li class="chapter" data-level="13.5" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#implement-a-truly-generic-core.servicesupervisor"><i class="fa fa-check"></i><b>13.5</b> Implement a truly generic <code>Core.ServiceSupervisor</code></a>
<ul>
<li class="chapter" data-level="13.5.1" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#first-path-starting-with-the-fetch_symbols_to_start0-function"><i class="fa fa-check"></i><b>13.5.1</b> First path starting with the <code>fetch_symbols_to_start/0</code> function</a></li>
<li class="chapter" data-level="13.5.2" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#second-path-starting-with-the-update_status2"><i class="fa fa-check"></i><b>13.5.2</b> Second path starting with the <code>update_status/2</code></a></li>
<li class="chapter" data-level="13.5.3" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#third-path-starting-with-the-get_pid1-function"><i class="fa fa-check"></i><b>13.5.3</b> Third path starting with the <code>get_pid/1</code> function</a></li>
</ul></li>
<li class="chapter" data-level="13.6" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#remove-boilerplate-using-use-macro"><i class="fa fa-check"></i><b>13.6</b> Remove boilerplate using <code>use</code> macro</a></li>
<li class="chapter" data-level="13.7" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#use-the-core.servicesupervisor-module-inside-the-streamer-application"><i class="fa fa-check"></i><b>13.7</b> Use the <code>Core.ServiceSupervisor</code> module inside the <code>streamer</code> application</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html"><i class="fa fa-check"></i><b>14</b> Store trade events and orders inside the database</a>
<ul>
<li class="chapter" data-level="14.1" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#objectives-13"><i class="fa fa-check"></i><b>14.1</b> Objectives</a></li>
<li class="chapter" data-level="14.2" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#overview-of-requirements-1"><i class="fa fa-check"></i><b>14.2</b> Overview of requirements</a></li>
<li class="chapter" data-level="14.3" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-a-new-data_warehouse-application-in-the-umbrella"><i class="fa fa-check"></i><b>14.3</b> Create a new <code>data_warehouse</code> application in the umbrella</a></li>
<li class="chapter" data-level="14.4" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#connect-to-the-database-using-ecto"><i class="fa fa-check"></i><b>14.4</b> Connect to the database using Ecto</a></li>
<li class="chapter" data-level="14.5" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#store-trade-events-data"><i class="fa fa-check"></i><b>14.5</b> Store trade events’ data</a></li>
<li class="chapter" data-level="14.6" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#store-orders-data"><i class="fa fa-check"></i><b>14.6</b> Store orders’ data</a></li>
<li class="chapter" data-level="14.7" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#implement-supervision"><i class="fa fa-check"></i><b>14.7</b> Implement supervision</a>
<ul>
<li class="chapter" data-level="14.7.1" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-subscriber_settings-table"><i class="fa fa-check"></i><b>14.7.1</b> Create <code>subscriber_settings</code> table</a></li>
<li class="chapter" data-level="14.7.2" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#redesign-supervision-using-registry"><i class="fa fa-check"></i><b>14.7.2</b> Redesign supervision using Registry</a></li>
<li class="chapter" data-level="14.7.3" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-the-datawarehouse.subscriber.dynamicsupervisor-module"><i class="fa fa-check"></i><b>14.7.3</b> Create the <code>DataWarehouse.Subscriber.DynamicSupervisor</code> module</a></li>
<li class="chapter" data-level="14.7.4" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#register-worker-processes-using-via"><i class="fa fa-check"></i><b>14.7.4</b> Register Worker processes using :via</a></li>
<li class="chapter" data-level="14.7.5" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-a-new-supervision-level-for-registry-task-and-the-dynamicsupervisor"><i class="fa fa-check"></i><b>14.7.5</b> Create a new supervision level for Registry, Task and the DynamicSupervisor</a></li>
<li class="chapter" data-level="14.7.6" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#link-the-subscribersupervisor-to-the-application"><i class="fa fa-check"></i><b>14.7.6</b> Link the <code>SubscriberSupervisor</code> to the <code>Application</code></a></li>
<li class="chapter" data-level="14.7.7" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#add-interface"><i class="fa fa-check"></i><b>14.7.7</b> Add interface</a></li>
<li class="chapter" data-level="14.7.8" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#test"><i class="fa fa-check"></i><b>14.7.8</b> Test</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="15" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html"><i class="fa fa-check"></i><b>15</b> Backtest trading strategy</a>
<ul>
<li class="chapter" data-level="15.1" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#objectives-14"><i class="fa fa-check"></i><b>15.1</b> Objectives</a></li>
<li class="chapter" data-level="15.2" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#overview-of-requirements-2"><i class="fa fa-check"></i><b>15.2</b> Overview of requirements</a></li>
<li class="chapter" data-level="15.3" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#implement-the-storing-task"><i class="fa fa-check"></i><b>15.3</b> Implement the storing task</a></li>
<li class="chapter" data-level="15.4" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#test-the-backtesting"><i class="fa fa-check"></i><b>15.4</b> Test the backtesting</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html"><i class="fa fa-check"></i><b>16</b> End-to-end testing</a>
<ul>
<li class="chapter" data-level="16.1" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#objectives-15"><i class="fa fa-check"></i><b>16.1</b> Objectives</a></li>
<li class="chapter" data-level="16.2" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#decide-on-the-tested-functionality"><i class="fa fa-check"></i><b>16.2</b> Decide on the tested functionality</a></li>
<li class="chapter" data-level="16.3" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#implement-basic-test"><i class="fa fa-check"></i><b>16.3</b> Implement basic test</a></li>
<li class="chapter" data-level="16.4" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#introduce-environment-based-config-files"><i class="fa fa-check"></i><b>16.4</b> Introduce environment based config files</a></li>
<li class="chapter" data-level="16.5" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#add-convenience-aliases"><i class="fa fa-check"></i><b>16.5</b> Add convenience aliases</a></li>
<li class="chapter" data-level="16.6" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#cache-initial-seed-data-inside-a-file"><i class="fa fa-check"></i><b>16.6</b> Cache initial seed data inside a file</a></li>
<li class="chapter" data-level="16.7" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#update-seeding-scripts-to-use-the-binancemock"><i class="fa fa-check"></i><b>16.7</b> Update seeding scripts to use the BinanceMock</a></li>
<li class="chapter" data-level="16.8" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#introduce-the-core-application"><i class="fa fa-check"></i><b>16.8</b> Introduce the Core application</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="mox-rocks.html"><a href="mox-rocks.html"><i class="fa fa-check"></i><b>17</b> Mox rocks</a>
<ul>
<li class="chapter" data-level="17.1" data-path="mox-rocks.html"><a href="mox-rocks.html#objectives-16"><i class="fa fa-check"></i><b>17.1</b> Objectives</a></li>
<li class="chapter" data-level="17.2" data-path="mox-rocks.html"><a href="mox-rocks.html#introduction-to-mock-based-tests"><i class="fa fa-check"></i><b>17.2</b> Introduction to mock based tests</a></li>
<li class="chapter" data-level="17.3" data-path="mox-rocks.html"><a href="mox-rocks.html#add-the-mox-package"><i class="fa fa-check"></i><b>17.3</b> Add the <code>mox</code> package</a></li>
<li class="chapter" data-level="17.4" data-path="mox-rocks.html"><a href="mox-rocks.html#investigate-the-naive.trader-module"><i class="fa fa-check"></i><b>17.4</b> Investigate the <code>Naive.Trader</code> module</a>
<ul>
<li class="chapter" data-level="17.4.1" data-path="mox-rocks.html"><a href="mox-rocks.html#mock-the-binance-module"><i class="fa fa-check"></i><b>17.4.1</b> Mock the <code>Binance</code> module</a></li>
<li class="chapter" data-level="17.4.2" data-path="mox-rocks.html"><a href="mox-rocks.html#mock-the-naiveleader-module"><i class="fa fa-check"></i><b>17.4.2</b> Mock the <code>NaiveLeader</code> module</a></li>
<li class="chapter" data-level="17.4.3" data-path="mox-rocks.html"><a href="mox-rocks.html#mock-the-phoenix.pubsub-module"><i class="fa fa-check"></i><b>17.4.3</b> Mock the <code>Phoenix.PubSub</code> module</a></li>
<li class="chapter" data-level="17.4.4" data-path="mox-rocks.html"><a href="mox-rocks.html#mock-the-logger-module"><i class="fa fa-check"></i><b>17.4.4</b> Mock the <code>Logger</code> module</a></li>
</ul></li>
<li class="chapter" data-level="17.5" data-path="mox-rocks.html"><a href="mox-rocks.html#implement-a-test-of-the-naive.trader-module"><i class="fa fa-check"></i><b>17.5</b> Implement a test of the <code>Naive.Trader</code> module</a></li>
<li class="chapter" data-level="17.6" data-path="mox-rocks.html"><a href="mox-rocks.html#define-an-alias-to-run-unit-tests"><i class="fa fa-check"></i><b>17.6</b> Define an alias to run unit tests</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="functional-elixir.html"><a href="functional-elixir.html"><i class="fa fa-check"></i><b>18</b> Functional Elixir</a>
<ul>
<li class="chapter" data-level="18.1" data-path="functional-elixir.html"><a href="functional-elixir.html#objectives-17"><i class="fa fa-check"></i><b>18.1</b> Objectives</a></li>
<li class="chapter" data-level="18.2" data-path="functional-elixir.html"><a href="functional-elixir.html#the-reasoning-behind-the-functional-approach"><i class="fa fa-check"></i><b>18.2</b> The reasoning behind the functional approach</a></li>
<li class="chapter" data-level="18.3" data-path="functional-elixir.html"><a href="functional-elixir.html#simplifying-by-splitting"><i class="fa fa-check"></i><b>18.3</b> Simplifying by splitting</a></li>
<li class="chapter" data-level="18.4" data-path="functional-elixir.html"><a href="functional-elixir.html#abstracting-the-pure-logic"><i class="fa fa-check"></i><b>18.4</b> Abstracting the “pure” logic</a>
<ul>
<li class="chapter" data-level="18.4.1" data-path="functional-elixir.html"><a href="functional-elixir.html#place-a-buy-order-rules"><i class="fa fa-check"></i><b>18.4.1</b> Place a buy order rules</a></li>
<li class="chapter" data-level="18.4.2" data-path="functional-elixir.html"><a href="functional-elixir.html#race-condition-rules"><i class="fa fa-check"></i><b>18.4.2</b> Race condition rules</a></li>
<li class="chapter" data-level="18.4.3" data-path="functional-elixir.html"><a href="functional-elixir.html#place-a-sell-order-rules"><i class="fa fa-check"></i><b>18.4.3</b> Place a sell order rules</a></li>
<li class="chapter" data-level="18.4.4" data-path="functional-elixir.html"><a href="functional-elixir.html#fetch-the-buy-order-rules"><i class="fa fa-check"></i><b>18.4.4</b> Fetch the buy order rules</a></li>
<li class="chapter" data-level="18.4.5" data-path="functional-elixir.html"><a href="functional-elixir.html#terminate-trader-rules"><i class="fa fa-check"></i><b>18.4.5</b> Terminate trader rules</a></li>
<li class="chapter" data-level="18.4.6" data-path="functional-elixir.html"><a href="functional-elixir.html#fetch-the-sell-order-rules"><i class="fa fa-check"></i><b>18.4.6</b> Fetch the sell order rules</a></li>
<li class="chapter" data-level="18.4.7" data-path="functional-elixir.html"><a href="functional-elixir.html#trigger-rebuy-rules"><i class="fa fa-check"></i><b>18.4.7</b> Trigger rebuy rules</a></li>
<li class="chapter" data-level="18.4.8" data-path="functional-elixir.html"><a href="functional-elixir.html#the-final-clause-rules"><i class="fa fa-check"></i><b>18.4.8</b> The final clause rules</a></li>
<li class="chapter" data-level="18.4.9" data-path="functional-elixir.html"><a href="functional-elixir.html#changes-to-the-naive.trader-module"><i class="fa fa-check"></i><b>18.4.9</b> Changes to the <code>Naive.Trader</code> module</a></li>
<li class="chapter" data-level="18.4.10" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---place-buy-order"><i class="fa fa-check"></i><b>18.4.10</b> <code>Naive.Trader</code> - place buy order</a></li>
<li class="chapter" data-level="18.4.11" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---race-condition-clause"><i class="fa fa-check"></i><b>18.4.11</b> <code>Naive.Trader</code> - Race condition clause</a></li>
<li class="chapter" data-level="18.4.12" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---place-a-sell-order"><i class="fa fa-check"></i><b>18.4.12</b> <code>Naive.Trader</code> - Place a sell order</a></li>
<li class="chapter" data-level="18.4.13" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---fetch-the-buy-order"><i class="fa fa-check"></i><b>18.4.13</b> <code>Naive.Trader</code> - Fetch the buy order</a></li>
<li class="chapter" data-level="18.4.14" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---terminate-the-trader"><i class="fa fa-check"></i><b>18.4.14</b> <code>Naive.Trader</code> - Terminate the trader</a></li>
<li class="chapter" data-level="18.4.15" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---fetch-the-sell-order"><i class="fa fa-check"></i><b>18.4.15</b> <code>Naive.Trader</code> - Fetch the sell order</a></li>
<li class="chapter" data-level="18.4.16" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---triggering-rebuy"><i class="fa fa-check"></i><b>18.4.16</b> <code>Naive.Trader</code> - Triggering rebuy</a></li>
<li class="chapter" data-level="18.4.17" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---the-final-ignore-clause"><i class="fa fa-check"></i><b>18.4.17</b> <code>Naive.Trader</code> - The final ignore clause</a></li>
</ul></li>
<li class="chapter" data-level="18.5" data-path="functional-elixir.html"><a href="functional-elixir.html#dealing-with-dirty-code"><i class="fa fa-check"></i><b>18.5</b> Dealing with dirty code</a></li>
<li class="chapter" data-level="18.6" data-path="functional-elixir.html"><a href="functional-elixir.html#making-dirty-code-testable"><i class="fa fa-check"></i><b>18.6</b> Making dirty code testable</a>
<ul>
<li class="chapter" data-level="18.6.1" data-path="functional-elixir.html"><a href="functional-elixir.html#passing-functions-arguments"><i class="fa fa-check"></i><b>18.6.1</b> Passing functions arguments</a></li>
<li class="chapter" data-level="18.6.2" data-path="functional-elixir.html"><a href="functional-elixir.html#passing-grouped-functions-as-a-context"><i class="fa fa-check"></i><b>18.6.2</b> Passing grouped functions as a context</a></li>
<li class="chapter" data-level="18.6.3" data-path="functional-elixir.html"><a href="functional-elixir.html#passing-grouped-modules-as-a-context"><i class="fa fa-check"></i><b>18.6.3</b> Passing grouped modules as a context</a></li>
<li class="chapter" data-level="18.6.4" data-path="functional-elixir.html"><a href="functional-elixir.html#injecting-modules-to-modules-attributes-based-on-the-configuration"><i class="fa fa-check"></i><b>18.6.4</b> Injecting modules to module’s attributes based on the configuration</a></li>
</ul></li>
<li class="chapter" data-level="18.7" data-path="functional-elixir.html"><a href="functional-elixir.html#the-power-with-in"><i class="fa fa-check"></i><b>18.7</b> The power <code>with</code>-in</a>
<ul>
<li class="chapter" data-level="18.7.1" data-path="functional-elixir.html"><a href="functional-elixir.html#idiomatic-error-handling"><i class="fa fa-check"></i><b>18.7.1</b> Idiomatic error handling</a></li>
</ul></li>
<li class="chapter" data-level="18.8" data-path="functional-elixir.html"><a href="functional-elixir.html#do-or-not-to-do"><i class="fa fa-check"></i><b>18.8</b> Do or not to do</a></li>
<li class="chapter" data-level="18.9" data-path="functional-elixir.html"><a href="functional-elixir.html#final-thoughts"><i class="fa fa-check"></i><b>18.9</b> Final thoughts</a></li>
</ul></li>
<li class="chapter" data-level="19" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html"><i class="fa fa-check"></i><b>19</b> Idiomatic OTP</a>
<ul>
<li class="chapter" data-level="19.1" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#objectives-18"><i class="fa fa-check"></i><b>19.1</b> Objectives</a></li>
<li class="chapter" data-level="19.2" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#the-concept"><i class="fa fa-check"></i><b>19.2</b> The concept</a></li>
<li class="chapter" data-level="19.3" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#initial-implementation"><i class="fa fa-check"></i><b>19.3</b> Initial implementation</a>
<ul>
<li class="chapter" data-level="19.3.1" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#maybe-functions"><i class="fa fa-check"></i><b>19.3.1</b> Maybe functions</a></li>
<li class="chapter" data-level="19.3.2" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#testing"><i class="fa fa-check"></i><b>19.3.2</b> Testing</a></li>
<li class="chapter" data-level="19.3.3" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#supervision"><i class="fa fa-check"></i><b>19.3.3</b> Supervision</a></li>
</ul></li>
<li class="chapter" data-level="19.4" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#idiomatic-solution"><i class="fa fa-check"></i><b>19.4</b> Idiomatic solution</a></li>
</ul></li>
<li class="chapter" data-level="20" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html"><i class="fa fa-check"></i><b>20</b> Idiomatic trading strategy</a>
<ul>
<li class="chapter" data-level="20.1" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#objectives-19"><i class="fa fa-check"></i><b>20.1</b> Objectives</a></li>
<li class="chapter" data-level="20.2" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#following-the-ohlc-footsteps"><i class="fa fa-check"></i><b>20.2</b> Following the OHLC footsteps</a></li>
<li class="chapter" data-level="20.3" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#simplifying-the-naive-supervision-tree"><i class="fa fa-check"></i><b>20.3</b> Simplifying the Naive supervision tree</a>
<ul>
<li class="chapter" data-level="20.3.1" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#the-naive.dynamictradersupervisor-module"><i class="fa fa-check"></i><b>20.3.1</b> The <code>Naive.DynamicTraderSupervisor</code> module</a></li>
<li class="chapter" data-level="20.3.2" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#the-naive-module"><i class="fa fa-check"></i><b>20.3.2</b> The <code>Naive</code> module</a></li>
<li class="chapter" data-level="20.3.3" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#the-naive.supervisor-module"><i class="fa fa-check"></i><b>20.3.3</b> The <code>Naive.Supervisor</code> module</a></li>
<li class="chapter" data-level="20.3.4" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#the-naive.trader-module"><i class="fa fa-check"></i><b>20.3.4</b> The <code>Naive.Trader</code> module</a></li>
</ul></li>
<li class="chapter" data-level="20.4" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#supporting-multiple-positions"><i class="fa fa-check"></i><b>20.4</b> Supporting multiple positions</a>
<ul>
<li class="chapter" data-level="20.4.1" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#initialization"><i class="fa fa-check"></i><b>20.4.1</b> Initialization</a></li>
<li class="chapter" data-level="20.4.2" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#parallelising-the-strategy"><i class="fa fa-check"></i><b>20.4.2</b> Parallelising the strategy</a></li>
</ul></li>
<li class="chapter" data-level="20.5" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#retrofitting-the-shutdown-functionality"><i class="fa fa-check"></i><b>20.5</b> Retrofitting the “shutdown” functionality</a>
<ul>
<li class="chapter" data-level="20.5.1" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#handling-updated-settings"><i class="fa fa-check"></i><b>20.5.1</b> Handling updated settings</a></li>
<li class="chapter" data-level="20.5.2" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#updating-the-naive.strategy-to-honour-the-shutdown-state"><i class="fa fa-check"></i><b>20.5.2</b> Updating the <code>Naive.Strategy</code> to honour the “shutdown” state</a></li>
</ul></li>
<li class="chapter" data-level="20.6" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#updating-the-strategy-to-handle-rebuys"><i class="fa fa-check"></i><b>20.6</b> Updating the Strategy to handle rebuys</a></li>
<li class="chapter" data-level="20.7" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#fetching-active-positions"><i class="fa fa-check"></i><b>20.7</b> Fetching active positions</a></li>
<li class="chapter" data-level="20.8" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#tidying-up"><i class="fa fa-check"></i><b>20.8</b> Tidying up</a></li>
<li class="chapter" data-level="20.9" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#final-thoughts-1"><i class="fa fa-check"></i><b>20.9</b> Final thoughts</a></li>
</ul></li>
<li class="chapter" data-level="21" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html"><i class="fa fa-check"></i><b>21</b> Layers of abstraction</a>
<ul>
<li class="chapter" data-level="21.1" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#objectives-20"><i class="fa fa-check"></i><b>21.1</b> Objectives</a></li>
<li class="chapter" data-level="21.2" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#admitting-the-simplification"><i class="fa fa-check"></i><b>21.2</b> Admitting the simplification</a></li>
<li class="chapter" data-level="21.3" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#abstracting-the-exchange"><i class="fa fa-check"></i><b>21.3</b> Abstracting the exchange</a>
<ul>
<li class="chapter" data-level="21.3.1" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#defining-the-core.exchange-behaviour"><i class="fa fa-check"></i><b>21.3.1</b> Defining the <code>Core.Exchange</code> behaviour</a></li>
<li class="chapter" data-level="21.3.2" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#implementation-of-the-core.exchange.binance-module"><i class="fa fa-check"></i><b>21.3.2</b> Implementation of the <code>Core.Exchange.Binance</code> module</a></li>
<li class="chapter" data-level="21.3.3" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#updating-the-binancemock-module-to-implement-the-core.exchange-behaviour"><i class="fa fa-check"></i><b>21.3.3</b> Updating the <code>BinanceMock</code> module to implement the <code>Core.Exchange</code> behaviour</a></li>
<li class="chapter" data-level="21.3.4" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#updating-the-naive.strategy"><i class="fa fa-check"></i><b>21.3.4</b> Updating the <code>Naive.Strategy</code></a></li>
<li class="chapter" data-level="21.3.5" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#updating-the-seed-scripts"><i class="fa fa-check"></i><b>21.3.5</b> Updating the seed scripts</a></li>
<li class="chapter" data-level="21.3.6" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#manual-testing-after-the-refactoring"><i class="fa fa-check"></i><b>21.3.6</b> Manual testing after the refactoring</a></li>
<li class="chapter" data-level="21.3.7" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#storing-the-data"><i class="fa fa-check"></i><b>21.3.7</b> Storing the data</a></li>
<li class="chapter" data-level="21.3.8" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#the-mox-approach-summary"><i class="fa fa-check"></i><b>21.3.8</b> The <code>Mox</code> approach summary</a></li>
</ul></li>
<li class="chapter" data-level="21.4" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#mimicking-the-reality"><i class="fa fa-check"></i><b>21.4</b> Mimicking the reality</a>
<ul>
<li class="chapter" data-level="21.4.1" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#updating-the-naive.strategy-1"><i class="fa fa-check"></i><b>21.4.1</b> Updating the <code>Naive.Strategy</code></a></li>
<li class="chapter" data-level="21.4.2" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#testing-the-naive.strategy"><i class="fa fa-check"></i><b>21.4.2</b> Testing the <code>Naive.Strategy</code></a></li>
<li class="chapter" data-level="21.4.3" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#logging-elephant-in-the-room"><i class="fa fa-check"></i><b>21.4.3</b> Logging elephant in the room</a></li>
</ul></li>
<li class="chapter" data-level="21.5" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#swapping-back-to-attributes"><i class="fa fa-check"></i><b>21.5</b> Swapping back to attributes</a>
<ul>
<li class="chapter" data-level="21.5.1" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#config-files"><i class="fa fa-check"></i><b>21.5.1</b> Config files</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://www.bookdown.org/" target="blank">Created with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Hands-on Elixir &amp; OTP: Cryptocurrency trading bot</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="layers-of-abstraction" class="section level1 hasAnchor" number="21">
<h1><span class="header-section-number">Chapter 21</span> Layers of abstraction<a href="layers-of-abstraction.html#layers-of-abstraction" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="objectives-20" class="section level2 hasAnchor" number="21.1">
<h2><span class="header-section-number">21.1</span> Objectives<a href="layers-of-abstraction.html#objectives-20" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>admitting the simplification</li>
<li>abstracting the exchange</li>
<li>mimicking the reality</li>
<li>swapping back to attributes</li>
</ul>
</div>
<div id="admitting-the-simplification" class="section level2 hasAnchor" number="21.2">
<h2><span class="header-section-number">21.2</span> Admitting the simplification<a href="layers-of-abstraction.html#admitting-the-simplification" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>There comes a time when I need to admit to something that I’ve learned on the way as I was writing this book and was misused throughout.</p>
<p>When we were using the <code>Mox</code> package, we were disappointed that most packages don’t provide behaviours we could use in our tests(to mock the actual implementations).</p>
<p>To fix that, we were creating behaviours for 3rd party packages we are using, like <code>Binance</code> or even <code>Ecto.Repo</code>. This approach felt weird, and it should, as I believe that was <strong>not the intended usage</strong> of the <code>Mox</code> package.</p>
<div style="page-break-after: always;"></div>
<p>Instead, we should introduce an additional layer(of abstraction) on top of the 3rd party modules we are using. A typical example could be abstracting dealing with an exchange to an behaviour and providing different implementations(for example, one could be wrapping the <code>Binance</code> module):</p>
<p><img src="images/chapter_21_01_additional_layer.jpg" width="100%" style="display: block; margin: auto;" /></p>
<p>In the example above, we will introduce a new behaviour module called <code>Core.Exchange</code> that would define the standard way to interact with any exchange. As this will be a generic <strong>exchange</strong> behaviour, it needs to accept and return generic structs(we will need to define those as well).</p>
<p>We will also create a new <code>Core.Exchange.Binance</code> module(wrapping up the <code>Binance</code> module) and update the <code>BinanceMock</code> module. Both will implement the <code>Core.Exchange</code> behaviour.</p>
<p>In this chapter, we will look into the intended way/scenario for using the <code>Mox</code> package, its advantages and disadvantages and go beyond and look into alternatives.</p>
</div>
<div id="abstracting-the-exchange" class="section level2 hasAnchor" number="21.3">
<h2><span class="header-section-number">21.3</span> Abstracting the exchange<a href="layers-of-abstraction.html#abstracting-the-exchange" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>First, we will look at an intended use case for the <code>Mox</code> module, as mentioned above.</p>
<div id="defining-the-core.exchange-behaviour" class="section level3 hasAnchor" number="21.3.1">
<h3><span class="header-section-number">21.3.1</span> Defining the <code>Core.Exchange</code> behaviour<a href="layers-of-abstraction.html#defining-the-core.exchange-behaviour" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We will start by creating a new file <code>/apps/core/lib/core/exchange.ex</code> together with a new module inside it:</p>
<div class="sourceCode" id="cb487"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb487-1"><a href="layers-of-abstraction.html#cb487-1" tabindex="-1"></a><span class="co"># /apps/core/lib/core/exchange.ex</span></span>
<span id="cb487-2"><a href="layers-of-abstraction.html#cb487-2" tabindex="-1"></a><span class="kw">defmodule</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">Exchange</span> <span class="kw">do</span></span>
<span id="cb487-3"><a href="layers-of-abstraction.html#cb487-3" tabindex="-1"></a></span>
<span id="cb487-4"><a href="layers-of-abstraction.html#cb487-4" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<div style="page-break-after: always;"></div>
<p>Now, based on how we currently interact with the <code>Binance</code> module inside the <code>Naive.Strategy</code>, we can define the following callback functions:</p>
<p><code>order_limit_buy/3</code> - almost the same as the <code>Binance.order_limit_buy/4</code>, just skipped the optional argument</p>
<div class="sourceCode" id="cb488"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb488-1"><a href="layers-of-abstraction.html#cb488-1" tabindex="-1"></a>  <span class="co"># /apps/core/lib/core/exchange.ex</span></span>
<span id="cb488-2"><a href="layers-of-abstraction.html#cb488-2" tabindex="-1"></a>  <span class="ot">@callback</span> order_limit_buy<span class="fu">(</span>symbol :: <span class="cn">String</span><span class="op">.</span>t<span class="fu">()</span>, quantity :: number<span class="fu">()</span>, price :: number<span class="fu">())</span> ::</span>
<span id="cb488-3"><a href="layers-of-abstraction.html#cb488-3" tabindex="-1"></a>              <span class="fu">{</span><span class="va">:ok</span>, <span class="cn">Core</span><span class="op">.</span><span class="cn">Exchange</span><span class="op">.</span><span class="cn">Order</span><span class="op">.</span>t<span class="fu">()}</span></span>
<span id="cb488-4"><a href="layers-of-abstraction.html#cb488-4" tabindex="-1"></a>              <span class="op">|</span> <span class="fu">{</span><span class="va">:error</span>, any<span class="fu">()}</span></span></code></pre></div>
<p><code>order_limit_sell/3</code> - almost the same as the <code>Binance.order_limit_sell/4</code>, just skipped the optional argument</p>
<div class="sourceCode" id="cb489"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb489-1"><a href="layers-of-abstraction.html#cb489-1" tabindex="-1"></a>  <span class="co"># /apps/core/lib/core/exchange.ex</span></span>
<span id="cb489-2"><a href="layers-of-abstraction.html#cb489-2" tabindex="-1"></a>  <span class="ot">@callback</span> order_limit_sell<span class="fu">(</span>symbol :: <span class="cn">String</span><span class="op">.</span>t<span class="fu">()</span>, quantity :: number<span class="fu">()</span>, price :: number<span class="fu">())</span> ::</span>
<span id="cb489-3"><a href="layers-of-abstraction.html#cb489-3" tabindex="-1"></a>              <span class="fu">{</span><span class="va">:ok</span>, <span class="cn">Core</span><span class="op">.</span><span class="cn">Exchange</span><span class="op">.</span><span class="cn">Order</span><span class="op">.</span>t<span class="fu">()}</span></span>
<span id="cb489-4"><a href="layers-of-abstraction.html#cb489-4" tabindex="-1"></a>              <span class="op">|</span> <span class="fu">{</span><span class="va">:error</span>, any<span class="fu">()}</span></span></code></pre></div>
<p><code>get_order/3</code> - the same as the <code>Binance.get_order/3</code></p>
<div class="sourceCode" id="cb490"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb490-1"><a href="layers-of-abstraction.html#cb490-1" tabindex="-1"></a>  <span class="co"># /apps/core/lib/core/exchange.ex</span></span>
<span id="cb490-2"><a href="layers-of-abstraction.html#cb490-2" tabindex="-1"></a>  <span class="ot">@callback</span> get_order<span class="fu">(</span></span>
<span id="cb490-3"><a href="layers-of-abstraction.html#cb490-3" tabindex="-1"></a>              symbol :: <span class="cn">String</span><span class="op">.</span>t<span class="fu">()</span>,</span>
<span id="cb490-4"><a href="layers-of-abstraction.html#cb490-4" tabindex="-1"></a>              timestamp :: non_neg_integer<span class="fu">()</span>,</span>
<span id="cb490-5"><a href="layers-of-abstraction.html#cb490-5" tabindex="-1"></a>              order_id :: non_neg_integer<span class="fu">()</span></span>
<span id="cb490-6"><a href="layers-of-abstraction.html#cb490-6" tabindex="-1"></a>            <span class="fu">)</span> ::</span>
<span id="cb490-7"><a href="layers-of-abstraction.html#cb490-7" tabindex="-1"></a>              <span class="fu">{</span><span class="va">:ok</span>, <span class="cn">Core</span><span class="op">.</span><span class="cn">Exchange</span><span class="op">.</span><span class="cn">Order</span><span class="op">.</span>t<span class="fu">()}</span></span>
<span id="cb490-8"><a href="layers-of-abstraction.html#cb490-8" tabindex="-1"></a>              <span class="op">|</span> <span class="fu">{</span><span class="va">:error</span>, any<span class="fu">()}</span></span></code></pre></div>
<p>All of the above callbacks rely on the <code>Core.Exchange.Order</code> struct, which we will add now inside the <code>Core.Exchange</code> module:</p>
<div class="sourceCode" id="cb491"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb491-1"><a href="layers-of-abstraction.html#cb491-1" tabindex="-1"></a>  <span class="co"># /apps/core/lib/core/exchange.ex</span></span>
<span id="cb491-2"><a href="layers-of-abstraction.html#cb491-2" tabindex="-1"></a>  <span class="kw">defmodule</span> <span class="cn">Order</span> <span class="kw">do</span></span>
<span id="cb491-3"><a href="layers-of-abstraction.html#cb491-3" tabindex="-1"></a>    <span class="ot">@type</span> t :: %<span class="cn">__MODULE__</span><span class="fu">{</span></span>
<span id="cb491-4"><a href="layers-of-abstraction.html#cb491-4" tabindex="-1"></a>            <span class="va">id:</span> non_neg_integer<span class="fu">()</span>,</span>
<span id="cb491-5"><a href="layers-of-abstraction.html#cb491-5" tabindex="-1"></a>            <span class="va">symbol:</span> <span class="cn">String</span><span class="op">.</span>t<span class="fu">()</span>,</span>
<span id="cb491-6"><a href="layers-of-abstraction.html#cb491-6" tabindex="-1"></a>            <span class="va">price:</span> number<span class="fu">()</span>,</span>
<span id="cb491-7"><a href="layers-of-abstraction.html#cb491-7" tabindex="-1"></a>            <span class="va">quantity:</span> number<span class="fu">()</span>,</span>
<span id="cb491-8"><a href="layers-of-abstraction.html#cb491-8" tabindex="-1"></a>            <span class="va">side:</span> <span class="va">:buy</span> <span class="op">|</span> <span class="va">:sell</span>,</span>
<span id="cb491-9"><a href="layers-of-abstraction.html#cb491-9" tabindex="-1"></a>            <span class="va">status:</span> <span class="va">:new</span> <span class="op">|</span> <span class="va">:filled</span>,</span>
<span id="cb491-10"><a href="layers-of-abstraction.html#cb491-10" tabindex="-1"></a>            <span class="va">timestamp:</span> non_neg_integer<span class="fu">()</span></span>
<span id="cb491-11"><a href="layers-of-abstraction.html#cb491-11" tabindex="-1"></a>          <span class="fu">}</span></span>
<span id="cb491-12"><a href="layers-of-abstraction.html#cb491-12" tabindex="-1"></a></span>
<span id="cb491-13"><a href="layers-of-abstraction.html#cb491-13" tabindex="-1"></a>    <span class="kw">defstruct</span> <span class="ot">[</span><span class="va">:id</span>, <span class="va">:symbol</span>, <span class="va">:price</span>, <span class="va">:quantity</span>, <span class="va">:side</span>, <span class="va">:status</span>, <span class="va">:timestamp</span><span class="ot">]</span></span>
<span id="cb491-14"><a href="layers-of-abstraction.html#cb491-14" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>The above struct is a simplification of the <code>Binance.Order</code> struct limited to just the fields we are using in our strategy.</p>
<p>Additionally, we use the <code>Binance</code> module to fetch symbol filters inside the <code>Naive.Strategy</code> (we actually fetch the whole exchange info and then dig inside to find our filters) - we will create a dedicated struct for those filters:</p>
<div class="sourceCode" id="cb492"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb492-1"><a href="layers-of-abstraction.html#cb492-1" tabindex="-1"></a>  <span class="co"># /apps/core/lib/core/exchange.ex</span></span>
<span id="cb492-2"><a href="layers-of-abstraction.html#cb492-2" tabindex="-1"></a>  <span class="co"># add below inside the Core.Exchange module</span></span>
<span id="cb492-3"><a href="layers-of-abstraction.html#cb492-3" tabindex="-1"></a>  <span class="kw">defmodule</span> <span class="cn">SymbolInfo</span> <span class="kw">do</span></span>
<span id="cb492-4"><a href="layers-of-abstraction.html#cb492-4" tabindex="-1"></a>    <span class="ot">@type</span> t :: %<span class="cn">__MODULE__</span><span class="fu">{</span></span>
<span id="cb492-5"><a href="layers-of-abstraction.html#cb492-5" tabindex="-1"></a>            <span class="va">symbol:</span> <span class="cn">String</span><span class="op">.</span>t<span class="fu">()</span>,</span>
<span id="cb492-6"><a href="layers-of-abstraction.html#cb492-6" tabindex="-1"></a>            <span class="va">tick_size:</span> number<span class="fu">()</span>,</span>
<span id="cb492-7"><a href="layers-of-abstraction.html#cb492-7" tabindex="-1"></a>            <span class="va">step_size:</span> number<span class="fu">()</span></span>
<span id="cb492-8"><a href="layers-of-abstraction.html#cb492-8" tabindex="-1"></a>          <span class="fu">}</span></span>
<span id="cb492-9"><a href="layers-of-abstraction.html#cb492-9" tabindex="-1"></a></span>
<span id="cb492-10"><a href="layers-of-abstraction.html#cb492-10" tabindex="-1"></a>    <span class="kw">defstruct</span> <span class="ot">[</span><span class="va">:symbol</span>, <span class="va">:tick_size</span>, <span class="va">:step_size</span><span class="ot">]</span></span>
<span id="cb492-11"><a href="layers-of-abstraction.html#cb492-11" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb492-12"><a href="layers-of-abstraction.html#cb492-12" tabindex="-1"></a></span>
<span id="cb492-13"><a href="layers-of-abstraction.html#cb492-13" tabindex="-1"></a>  <span class="ot">@callback</span> fetch_symbol_filters<span class="fu">(</span>symbol :: <span class="cn">String</span><span class="op">.</span>t<span class="fu">())</span> ::</span>
<span id="cb492-14"><a href="layers-of-abstraction.html#cb492-14" tabindex="-1"></a>              <span class="fu">{</span><span class="va">:ok</span>, <span class="cn">Core</span><span class="op">.</span><span class="cn">Exchange</span><span class="op">.</span><span class="cn">SymbolInfo</span><span class="op">.</span>t<span class="fu">()}</span></span>
<span id="cb492-15"><a href="layers-of-abstraction.html#cb492-15" tabindex="-1"></a>              <span class="op">|</span> <span class="fu">{</span><span class="va">:error</span>, any<span class="fu">()}</span></span></code></pre></div>
<p>The final usage of the <code>Binance</code> module comes from the seed scripts, where we fetch the exchange info just to get the list of the supported currencies. We will make getting a list of supported currencies part of our behaviour:</p>
<div class="sourceCode" id="cb493"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb493-1"><a href="layers-of-abstraction.html#cb493-1" tabindex="-1"></a>  <span class="co"># /apps/core/lib/core/exchange.ex</span></span>
<span id="cb493-2"><a href="layers-of-abstraction.html#cb493-2" tabindex="-1"></a>  <span class="co"># add below inside the Core.Exchange module</span></span>
<span id="cb493-3"><a href="layers-of-abstraction.html#cb493-3" tabindex="-1"></a>  <span class="ot">@callback</span> fetch_symbols<span class="fu">()</span> ::</span>
<span id="cb493-4"><a href="layers-of-abstraction.html#cb493-4" tabindex="-1"></a>              <span class="fu">{</span><span class="va">:ok</span>, <span class="ot">[</span><span class="cn">String</span><span class="op">.</span>t<span class="fu">()</span><span class="ot">]</span><span class="fu">}</span></span>
<span id="cb493-5"><a href="layers-of-abstraction.html#cb493-5" tabindex="-1"></a>              <span class="op">|</span> <span class="fu">{</span><span class="va">:error</span>, any<span class="fu">()}</span></span></code></pre></div>
<p>This finishes the definition of the <code>Core.Exchange</code> behaviour. It should consist of five callback functions(
<code>fetch_symbols/0</code>, <code>fetch_symbol_filters/1</code>, <code>get_order/3</code>, <code>order_limit_buy/3</code> and <code>order_limit_sell/3</code>) together with two structs(<code>Order</code> and <code>SymbolInfo</code>).</p>
</div>
<div id="implementation-of-the-core.exchange.binance-module" class="section level3 hasAnchor" number="21.3.2">
<h3><span class="header-section-number">21.3.2</span> Implementation of the <code>Core.Exchange.Binance</code> module<a href="layers-of-abstraction.html#implementation-of-the-core.exchange.binance-module" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As we defined the behaviour, we can now wrap the production implementation(the <code>Binance</code> module) inside a module that will implement that behaviour.</p>
<p>We will start by creating a new directory called “exchange” inside the <code>apps/core/lib/core</code> directory, together with a new file called <code>binance.ex</code>. Inside it, we will define a module that will implement the <code>Core.Exchange</code> behaviour:</p>
<div class="sourceCode" id="cb494"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb494-1"><a href="layers-of-abstraction.html#cb494-1" tabindex="-1"></a><span class="co"># /apps/core/lib/core/exchange/binance.ex</span></span>
<span id="cb494-2"><a href="layers-of-abstraction.html#cb494-2" tabindex="-1"></a><span class="kw">defmodule</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">Exchange</span><span class="op">.</span><span class="cn">Binance</span> <span class="kw">do</span></span>
<span id="cb494-3"><a href="layers-of-abstraction.html#cb494-3" tabindex="-1"></a>  <span class="ot">@behaviour</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">Exchange</span></span>
<span id="cb494-4"><a href="layers-of-abstraction.html#cb494-4" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<p>Now we are obliged to implement all functions defined in the behaviour, starting with the <code>fetch_symbols/0</code>:</p>
<div class="sourceCode" id="cb495"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb495-1"><a href="layers-of-abstraction.html#cb495-1" tabindex="-1"></a>  <span class="co"># /apps/core/lib/core/exchange/binance.ex</span></span>
<span id="cb495-2"><a href="layers-of-abstraction.html#cb495-2" tabindex="-1"></a>  <span class="im">alias</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">Exchange</span></span>
<span id="cb495-3"><a href="layers-of-abstraction.html#cb495-3" tabindex="-1"></a></span>
<span id="cb495-4"><a href="layers-of-abstraction.html#cb495-4" tabindex="-1"></a>  <span class="ot">@impl</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">Exchange</span></span>
<span id="cb495-5"><a href="layers-of-abstraction.html#cb495-5" tabindex="-1"></a>  <span class="kw">def</span> fetch_symbols<span class="fu">()</span> <span class="kw">do</span></span>
<span id="cb495-6"><a href="layers-of-abstraction.html#cb495-6" tabindex="-1"></a>    <span class="kw">case</span> <span class="cn">Binance</span><span class="op">.</span>get_exchange_info<span class="fu">()</span> <span class="kw">do</span></span>
<span id="cb495-7"><a href="layers-of-abstraction.html#cb495-7" tabindex="-1"></a>      <span class="fu">{</span><span class="va">:ok</span>, %<span class="fu">{</span><span class="va">symbols:</span> symbols<span class="fu">}}</span> <span class="op">-&gt;</span></span>
<span id="cb495-8"><a href="layers-of-abstraction.html#cb495-8" tabindex="-1"></a>        symbols</span>
<span id="cb495-9"><a href="layers-of-abstraction.html#cb495-9" tabindex="-1"></a>        <span class="op">|&gt;</span> <span class="cn">Enum</span><span class="op">.</span>map<span class="fu">(</span><span class="op">&amp;</span> <span class="op">&amp;</span><span class="dv">1</span><span class="ot">[</span><span class="st">&quot;symbol&quot;</span><span class="ot">]</span><span class="fu">)</span></span>
<span id="cb495-10"><a href="layers-of-abstraction.html#cb495-10" tabindex="-1"></a>        <span class="op">|&gt;</span> then<span class="fu">(</span><span class="op">&amp;</span><span class="fu">{</span><span class="va">:ok</span>, <span class="op">&amp;</span><span class="dv">1</span><span class="fu">})</span></span>
<span id="cb495-11"><a href="layers-of-abstraction.html#cb495-11" tabindex="-1"></a></span>
<span id="cb495-12"><a href="layers-of-abstraction.html#cb495-12" tabindex="-1"></a>      error <span class="op">-&gt;</span></span>
<span id="cb495-13"><a href="layers-of-abstraction.html#cb495-13" tabindex="-1"></a>        error</span>
<span id="cb495-14"><a href="layers-of-abstraction.html#cb495-14" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb495-15"><a href="layers-of-abstraction.html#cb495-15" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>As we can see - the <code>case</code> statement wraps the call to the <code>Binance</code> module, and either we evaluate further business logic or forward the error so the “consumer” of our library can decide what to do with the error condition. This pattern will appear in all our functions as the <code>Core.Exchange.Binance</code> module is our own “library” module.</p>
<p>Let’s continue with implementing the remaining functions defined in the behaviour:</p>
<div class="sourceCode" id="cb496"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb496-1"><a href="layers-of-abstraction.html#cb496-1" tabindex="-1"></a>  <span class="co"># /apps/core/lib/core/exchange/binance.ex</span></span>
<span id="cb496-2"><a href="layers-of-abstraction.html#cb496-2" tabindex="-1"></a>  <span class="ot">@impl</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">Exchange</span></span>
<span id="cb496-3"><a href="layers-of-abstraction.html#cb496-3" tabindex="-1"></a>  <span class="kw">def</span> fetch_symbol_filters<span class="fu">(</span>symbol<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb496-4"><a href="layers-of-abstraction.html#cb496-4" tabindex="-1"></a>    <span class="kw">case</span> <span class="cn">Binance</span><span class="op">.</span>get_exchange_info<span class="fu">()</span> <span class="kw">do</span></span>
<span id="cb496-5"><a href="layers-of-abstraction.html#cb496-5" tabindex="-1"></a>      <span class="fu">{</span><span class="va">:ok</span>, exchange_info<span class="fu">}</span> <span class="op">-&gt;</span> <span class="fu">{</span><span class="va">:ok</span>, fetch_symbol_filters<span class="fu">(</span>symbol, exchange_info<span class="fu">)}</span></span>
<span id="cb496-6"><a href="layers-of-abstraction.html#cb496-6" tabindex="-1"></a>      error <span class="op">-&gt;</span> error</span>
<span id="cb496-7"><a href="layers-of-abstraction.html#cb496-7" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb496-8"><a href="layers-of-abstraction.html#cb496-8" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb496-9"><a href="layers-of-abstraction.html#cb496-9" tabindex="-1"></a></span>
<span id="cb496-10"><a href="layers-of-abstraction.html#cb496-10" tabindex="-1"></a>  <span class="kw">defp</span> fetch_symbol_filters<span class="fu">(</span>symbol, exchange_info<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb496-11"><a href="layers-of-abstraction.html#cb496-11" tabindex="-1"></a>    symbol_filters <span class="op">=</span></span>
<span id="cb496-12"><a href="layers-of-abstraction.html#cb496-12" tabindex="-1"></a>      exchange_info</span>
<span id="cb496-13"><a href="layers-of-abstraction.html#cb496-13" tabindex="-1"></a>      <span class="op">|&gt;</span> <span class="cn">Map</span><span class="op">.</span>get<span class="fu">(</span><span class="va">:symbols</span><span class="fu">)</span></span>
<span id="cb496-14"><a href="layers-of-abstraction.html#cb496-14" tabindex="-1"></a>      <span class="op">|&gt;</span> <span class="cn">Enum</span><span class="op">.</span>find<span class="fu">(</span><span class="op">&amp;</span><span class="fu">(</span><span class="op">&amp;</span><span class="dv">1</span><span class="ot">[</span><span class="st">&quot;symbol&quot;</span><span class="ot">]</span> <span class="op">==</span> symbol<span class="fu">))</span></span>
<span id="cb496-15"><a href="layers-of-abstraction.html#cb496-15" tabindex="-1"></a>      <span class="op">|&gt;</span> <span class="cn">Map</span><span class="op">.</span>get<span class="fu">(</span><span class="st">&quot;filters&quot;</span><span class="fu">)</span></span>
<span id="cb496-16"><a href="layers-of-abstraction.html#cb496-16" tabindex="-1"></a></span>
<span id="cb496-17"><a href="layers-of-abstraction.html#cb496-17" tabindex="-1"></a>    tick_size <span class="op">=</span></span>
<span id="cb496-18"><a href="layers-of-abstraction.html#cb496-18" tabindex="-1"></a>      symbol_filters</span>
<span id="cb496-19"><a href="layers-of-abstraction.html#cb496-19" tabindex="-1"></a>      <span class="op">|&gt;</span> <span class="cn">Enum</span><span class="op">.</span>find<span class="fu">(</span><span class="op">&amp;</span><span class="fu">(</span><span class="op">&amp;</span><span class="dv">1</span><span class="ot">[</span><span class="st">&quot;filterType&quot;</span><span class="ot">]</span> <span class="op">==</span> <span class="st">&quot;PRICE_FILTER&quot;</span><span class="fu">))</span></span>
<span id="cb496-20"><a href="layers-of-abstraction.html#cb496-20" tabindex="-1"></a>      <span class="op">|&gt;</span> <span class="cn">Map</span><span class="op">.</span>get<span class="fu">(</span><span class="st">&quot;tickSize&quot;</span><span class="fu">)</span></span>
<span id="cb496-21"><a href="layers-of-abstraction.html#cb496-21" tabindex="-1"></a></span>
<span id="cb496-22"><a href="layers-of-abstraction.html#cb496-22" tabindex="-1"></a>    step_size <span class="op">=</span></span>
<span id="cb496-23"><a href="layers-of-abstraction.html#cb496-23" tabindex="-1"></a>      symbol_filters</span>
<span id="cb496-24"><a href="layers-of-abstraction.html#cb496-24" tabindex="-1"></a>      <span class="op">|&gt;</span> <span class="cn">Enum</span><span class="op">.</span>find<span class="fu">(</span><span class="op">&amp;</span><span class="fu">(</span><span class="op">&amp;</span><span class="dv">1</span><span class="ot">[</span><span class="st">&quot;filterType&quot;</span><span class="ot">]</span> <span class="op">==</span> <span class="st">&quot;LOT_SIZE&quot;</span><span class="fu">))</span></span>
<span id="cb496-25"><a href="layers-of-abstraction.html#cb496-25" tabindex="-1"></a>      <span class="op">|&gt;</span> <span class="cn">Map</span><span class="op">.</span>get<span class="fu">(</span><span class="st">&quot;stepSize&quot;</span><span class="fu">)</span></span>
<span id="cb496-26"><a href="layers-of-abstraction.html#cb496-26" tabindex="-1"></a></span>
<span id="cb496-27"><a href="layers-of-abstraction.html#cb496-27" tabindex="-1"></a>    %<span class="cn">Exchange</span><span class="op">.</span><span class="cn">SymbolInfo</span><span class="fu">{</span></span>
<span id="cb496-28"><a href="layers-of-abstraction.html#cb496-28" tabindex="-1"></a>      <span class="va">symbol:</span> symbol,</span>
<span id="cb496-29"><a href="layers-of-abstraction.html#cb496-29" tabindex="-1"></a>      <span class="va">tick_size:</span> tick_size,</span>
<span id="cb496-30"><a href="layers-of-abstraction.html#cb496-30" tabindex="-1"></a>      <span class="va">step_size:</span> step_size</span>
<span id="cb496-31"><a href="layers-of-abstraction.html#cb496-31" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb496-32"><a href="layers-of-abstraction.html#cb496-32" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>The <code>fetch_symbol_filters/1</code> function follows the previously discussed pattern. The <code>fetch_symbol_filters/2</code>, on the other hand, is a modified copy of the <code>merge_filters_into_settings/2</code> function from the <code>Naive.Strategy</code> module is now returning the <code>Exchange.SymbolInfo</code> struct.</p>
<p>Another function to be implemented to fulfil the behaviour is <code>get_order/3</code>:</p>
<div class="sourceCode" id="cb497"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb497-1"><a href="layers-of-abstraction.html#cb497-1" tabindex="-1"></a>  <span class="co"># /apps/core/lib/core/exchange/binance.ex</span></span>
<span id="cb497-2"><a href="layers-of-abstraction.html#cb497-2" tabindex="-1"></a>  <span class="ot">@impl</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">Exchange</span></span>
<span id="cb497-3"><a href="layers-of-abstraction.html#cb497-3" tabindex="-1"></a>  <span class="kw">def</span> get_order<span class="fu">(</span>symbol, timestamp, order_id<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb497-4"><a href="layers-of-abstraction.html#cb497-4" tabindex="-1"></a>    <span class="kw">case</span> <span class="cn">Binance</span><span class="op">.</span>get_order<span class="fu">(</span>symbol, timestamp, order_id<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb497-5"><a href="layers-of-abstraction.html#cb497-5" tabindex="-1"></a>      <span class="fu">{</span><span class="va">:ok</span>, %<span class="cn">Binance</span><span class="op">.</span><span class="cn">Order</span><span class="fu">{}</span> <span class="op">=</span> order<span class="fu">}</span> <span class="op">-&gt;</span></span>
<span id="cb497-6"><a href="layers-of-abstraction.html#cb497-6" tabindex="-1"></a>        <span class="fu">{</span><span class="va">:ok</span>,</span>
<span id="cb497-7"><a href="layers-of-abstraction.html#cb497-7" tabindex="-1"></a>         %<span class="cn">Exchange</span><span class="op">.</span><span class="cn">Order</span><span class="fu">{</span></span>
<span id="cb497-8"><a href="layers-of-abstraction.html#cb497-8" tabindex="-1"></a>           <span class="va">id:</span> order<span class="op">.</span>order_id,</span>
<span id="cb497-9"><a href="layers-of-abstraction.html#cb497-9" tabindex="-1"></a>           <span class="va">symbol:</span> order<span class="op">.</span>symbol,</span>
<span id="cb497-10"><a href="layers-of-abstraction.html#cb497-10" tabindex="-1"></a>           <span class="va">price:</span> order<span class="op">.</span>price,</span>
<span id="cb497-11"><a href="layers-of-abstraction.html#cb497-11" tabindex="-1"></a>           <span class="va">quantity:</span> order<span class="op">.</span>orig_qty,</span>
<span id="cb497-12"><a href="layers-of-abstraction.html#cb497-12" tabindex="-1"></a>           <span class="va">side:</span> side_to_atom<span class="fu">(</span>order<span class="op">.</span>side<span class="fu">)</span>,</span>
<span id="cb497-13"><a href="layers-of-abstraction.html#cb497-13" tabindex="-1"></a>           <span class="va">status:</span> status_to_atom<span class="fu">(</span>order<span class="op">.</span>status<span class="fu">)</span>,</span>
<span id="cb497-14"><a href="layers-of-abstraction.html#cb497-14" tabindex="-1"></a>           <span class="va">timestamp:</span> order<span class="op">.</span>time</span>
<span id="cb497-15"><a href="layers-of-abstraction.html#cb497-15" tabindex="-1"></a>         <span class="fu">}}</span></span>
<span id="cb497-16"><a href="layers-of-abstraction.html#cb497-16" tabindex="-1"></a></span>
<span id="cb497-17"><a href="layers-of-abstraction.html#cb497-17" tabindex="-1"></a>      error <span class="op">-&gt;</span></span>
<span id="cb497-18"><a href="layers-of-abstraction.html#cb497-18" tabindex="-1"></a>        error</span>
<span id="cb497-19"><a href="layers-of-abstraction.html#cb497-19" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb497-20"><a href="layers-of-abstraction.html#cb497-20" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb497-21"><a href="layers-of-abstraction.html#cb497-21" tabindex="-1"></a>  </span>
<span id="cb497-22"><a href="layers-of-abstraction.html#cb497-22" tabindex="-1"></a>  <span class="kw">defp</span> side_to_atom<span class="fu">(</span><span class="st">&quot;BUY&quot;</span><span class="fu">)</span>, <span class="va">do:</span> <span class="va">:buy</span></span>
<span id="cb497-23"><a href="layers-of-abstraction.html#cb497-23" tabindex="-1"></a>  <span class="kw">defp</span> side_to_atom<span class="fu">(</span><span class="st">&quot;SELL&quot;</span><span class="fu">)</span>, <span class="va">do:</span> <span class="va">:sell</span></span>
<span id="cb497-24"><a href="layers-of-abstraction.html#cb497-24" tabindex="-1"></a></span>
<span id="cb497-25"><a href="layers-of-abstraction.html#cb497-25" tabindex="-1"></a>  <span class="kw">defp</span> status_to_atom<span class="fu">(</span><span class="st">&quot;NEW&quot;</span><span class="fu">)</span>, <span class="va">do:</span> <span class="va">:new</span></span>
<span id="cb497-26"><a href="layers-of-abstraction.html#cb497-26" tabindex="-1"></a>  <span class="kw">defp</span> status_to_atom<span class="fu">(</span><span class="st">&quot;FILLED&quot;</span><span class="fu">)</span>, <span class="va">do:</span> <span class="va">:filled</span></span></code></pre></div>
<p>As in the case of the previously implemented functions, the <code>get_order/3</code> implementation wraps the <code>Binance</code>’s function inside the <code>case</code> statement. To satisfy the <code>Core.Exchange</code> behaviour, it needs to return the <code>Exchange.Order</code> struct - hence the conversion. It also needs to convert the string <code>side</code> and <code>status</code> fields to atoms before assigning them to the struct(that’s the role of the <code>status_to_atom</code> and <code>side_to_atom</code> helper functions).</p>
<p>The final two functions to be implemented will be the <code>order_limit_buy/3</code> and <code>order_limit_sell/3</code>:</p>
<div class="sourceCode" id="cb498"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb498-1"><a href="layers-of-abstraction.html#cb498-1" tabindex="-1"></a>  <span class="co"># /apps/core/lib/core/exchange/binance.ex</span></span>
<span id="cb498-2"><a href="layers-of-abstraction.html#cb498-2" tabindex="-1"></a>  <span class="ot">@impl</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">Exchange</span></span>
<span id="cb498-3"><a href="layers-of-abstraction.html#cb498-3" tabindex="-1"></a>  <span class="kw">def</span> order_limit_buy<span class="fu">(</span>symbol, quantity, price<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb498-4"><a href="layers-of-abstraction.html#cb498-4" tabindex="-1"></a>    <span class="kw">case</span> <span class="cn">Binance</span><span class="op">.</span>order_limit_buy<span class="fu">(</span>symbol, quantity, price, <span class="st">&quot;GTC&quot;</span><span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb498-5"><a href="layers-of-abstraction.html#cb498-5" tabindex="-1"></a>      <span class="fu">{</span><span class="va">:ok</span>, %<span class="cn">Binance</span><span class="op">.</span><span class="cn">OrderResponse</span><span class="fu">{}</span> <span class="op">=</span> order<span class="fu">}</span> <span class="op">-&gt;</span></span>
<span id="cb498-6"><a href="layers-of-abstraction.html#cb498-6" tabindex="-1"></a>        <span class="fu">{</span><span class="va">:ok</span>,</span>
<span id="cb498-7"><a href="layers-of-abstraction.html#cb498-7" tabindex="-1"></a>         %<span class="cn">Exchange</span><span class="op">.</span><span class="cn">Order</span><span class="fu">{</span></span>
<span id="cb498-8"><a href="layers-of-abstraction.html#cb498-8" tabindex="-1"></a>           <span class="va">id:</span> order<span class="op">.</span>order_id,</span>
<span id="cb498-9"><a href="layers-of-abstraction.html#cb498-9" tabindex="-1"></a>           <span class="va">price:</span> order<span class="op">.</span>price,</span>
<span id="cb498-10"><a href="layers-of-abstraction.html#cb498-10" tabindex="-1"></a>           <span class="va">quantity:</span> order<span class="op">.</span>orig_qty,</span>
<span id="cb498-11"><a href="layers-of-abstraction.html#cb498-11" tabindex="-1"></a>           <span class="va">side:</span> <span class="va">:buy</span>,</span>
<span id="cb498-12"><a href="layers-of-abstraction.html#cb498-12" tabindex="-1"></a>           <span class="va">status:</span> <span class="va">:new</span>,</span>
<span id="cb498-13"><a href="layers-of-abstraction.html#cb498-13" tabindex="-1"></a>           <span class="va">timestamp:</span> order<span class="op">.</span>transact_time</span>
<span id="cb498-14"><a href="layers-of-abstraction.html#cb498-14" tabindex="-1"></a>         <span class="fu">}}</span></span>
<span id="cb498-15"><a href="layers-of-abstraction.html#cb498-15" tabindex="-1"></a></span>
<span id="cb498-16"><a href="layers-of-abstraction.html#cb498-16" tabindex="-1"></a>      error <span class="op">-&gt;</span></span>
<span id="cb498-17"><a href="layers-of-abstraction.html#cb498-17" tabindex="-1"></a>        error</span>
<span id="cb498-18"><a href="layers-of-abstraction.html#cb498-18" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb498-19"><a href="layers-of-abstraction.html#cb498-19" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb498-20"><a href="layers-of-abstraction.html#cb498-20" tabindex="-1"></a></span>
<span id="cb498-21"><a href="layers-of-abstraction.html#cb498-21" tabindex="-1"></a>  <span class="ot">@impl</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">Exchange</span></span>
<span id="cb498-22"><a href="layers-of-abstraction.html#cb498-22" tabindex="-1"></a>  <span class="kw">def</span> order_limit_sell<span class="fu">(</span>symbol, quantity, price<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb498-23"><a href="layers-of-abstraction.html#cb498-23" tabindex="-1"></a>    <span class="kw">case</span> <span class="cn">Binance</span><span class="op">.</span>order_limit_sell<span class="fu">(</span>symbol, quantity, price, <span class="st">&quot;GTC&quot;</span><span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb498-24"><a href="layers-of-abstraction.html#cb498-24" tabindex="-1"></a>      <span class="fu">{</span><span class="va">:ok</span>, %<span class="cn">Binance</span><span class="op">.</span><span class="cn">OrderResponse</span><span class="fu">{}</span> <span class="op">=</span> order<span class="fu">}</span> <span class="op">-&gt;</span></span>
<span id="cb498-25"><a href="layers-of-abstraction.html#cb498-25" tabindex="-1"></a>        <span class="fu">{</span><span class="va">:ok</span>,</span>
<span id="cb498-26"><a href="layers-of-abstraction.html#cb498-26" tabindex="-1"></a>         %<span class="cn">Exchange</span><span class="op">.</span><span class="cn">Order</span><span class="fu">{</span></span>
<span id="cb498-27"><a href="layers-of-abstraction.html#cb498-27" tabindex="-1"></a>           <span class="va">id:</span> order<span class="op">.</span>order_id,</span>
<span id="cb498-28"><a href="layers-of-abstraction.html#cb498-28" tabindex="-1"></a>           <span class="va">price:</span> order<span class="op">.</span>price,</span>
<span id="cb498-29"><a href="layers-of-abstraction.html#cb498-29" tabindex="-1"></a>           <span class="va">quantity:</span> order<span class="op">.</span>orig_qty,</span>
<span id="cb498-30"><a href="layers-of-abstraction.html#cb498-30" tabindex="-1"></a>           <span class="va">side:</span> <span class="va">:sell</span>,</span>
<span id="cb498-31"><a href="layers-of-abstraction.html#cb498-31" tabindex="-1"></a>           <span class="va">status:</span> <span class="va">:new</span>,</span>
<span id="cb498-32"><a href="layers-of-abstraction.html#cb498-32" tabindex="-1"></a>           <span class="va">timestamp:</span> order<span class="op">.</span>transact_time</span>
<span id="cb498-33"><a href="layers-of-abstraction.html#cb498-33" tabindex="-1"></a>         <span class="fu">}}</span></span>
<span id="cb498-34"><a href="layers-of-abstraction.html#cb498-34" tabindex="-1"></a></span>
<span id="cb498-35"><a href="layers-of-abstraction.html#cb498-35" tabindex="-1"></a>      error <span class="op">-&gt;</span></span>
<span id="cb498-36"><a href="layers-of-abstraction.html#cb498-36" tabindex="-1"></a>        error</span>
<span id="cb498-37"><a href="layers-of-abstraction.html#cb498-37" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb498-38"><a href="layers-of-abstraction.html#cb498-38" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>That finishes our first implementation of the <code>Core.Exchange</code> behaviour. It will be used in the production by our <code>Naive.Strategy</code>, but before we will update it, let’s update the <code>BinanceMock</code> module to implement the same behaviour for testing/backtesting.</p>
</div>
<div id="updating-the-binancemock-module-to-implement-the-core.exchange-behaviour" class="section level3 hasAnchor" number="21.3.3">
<h3><span class="header-section-number">21.3.3</span> Updating the <code>BinanceMock</code> module to implement the <code>Core.Exchange</code> behaviour<a href="layers-of-abstraction.html#updating-the-binancemock-module-to-implement-the-core.exchange-behaviour" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>BinanceMock</code> module must implement the <code>Core.Exchange</code> behaviour. It will (at compile time) guarantee that both <code>Core.Exchange.Binance</code> and <code>BinanceMock</code> share a common interface that can be used by the <code>Naive.Strategy</code>.</p>
<p>First, we will start by declaring that the <code>BinanceMock</code> actually implements the <code>Core.Exchange</code> behaviour:</p>
<div class="sourceCode" id="cb499"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb499-1"><a href="layers-of-abstraction.html#cb499-1" tabindex="-1"></a><span class="co"># /apps/binance_mock/lib/binance_mock.ex</span></span>
<span id="cb499-2"><a href="layers-of-abstraction.html#cb499-2" tabindex="-1"></a><span class="kw">defmodule</span> <span class="cn">BinanceMock</span> <span class="kw">do</span></span>
<span id="cb499-3"><a href="layers-of-abstraction.html#cb499-3" tabindex="-1"></a>  <span class="ot">@behaviour</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">Exchange</span> <span class="co"># &lt;= added</span></span></code></pre></div>
<p>Next, we can replace all the aliases to the <code>Binance</code> structs with a single alias to the <code>Core.Exchange</code> module:</p>
<div class="sourceCode" id="cb500"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb500-1"><a href="layers-of-abstraction.html#cb500-1" tabindex="-1"></a>  <span class="co"># /apps/binance_mock/lib/binance_mock.ex</span></span>
<span id="cb500-2"><a href="layers-of-abstraction.html#cb500-2" tabindex="-1"></a>  <span class="im">alias</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">Exchange</span></span></code></pre></div>
<p>Don’t forget to update all references to the <code>Binance.Order</code> with <code>Exchange.Order</code> module.</p>
<p>As the behaviour is now defined in the <code>Core.Exchange</code> module, we can remove all <code>@type</code> and <code>@callback</code> attributes.</p>
<p>Moving on, we will replace the <code>get_exchange_info/0</code>(together with it’s <code>get_cached_exchange_info/0</code> helper function) with <code>fetch_symbols/0</code> and <code>fetch_symbol_filters/1</code>(and their helper functions):</p>
<div class="sourceCode" id="cb501"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb501-1"><a href="layers-of-abstraction.html#cb501-1" tabindex="-1"></a>  <span class="co"># /apps/binance_mock/lib/binance_mock.ex</span></span>
<span id="cb501-2"><a href="layers-of-abstraction.html#cb501-2" tabindex="-1"></a>  <span class="kw">def</span> fetch_symbols<span class="fu">()</span> <span class="kw">do</span></span>
<span id="cb501-3"><a href="layers-of-abstraction.html#cb501-3" tabindex="-1"></a>    <span class="kw">case</span> fetch_exchange_info<span class="fu">()</span> <span class="kw">do</span></span>
<span id="cb501-4"><a href="layers-of-abstraction.html#cb501-4" tabindex="-1"></a>      <span class="fu">{</span><span class="va">:ok</span>, %<span class="fu">{</span><span class="va">symbols:</span> symbols<span class="fu">}}</span> <span class="op">-&gt;</span></span>
<span id="cb501-5"><a href="layers-of-abstraction.html#cb501-5" tabindex="-1"></a>        symbols</span>
<span id="cb501-6"><a href="layers-of-abstraction.html#cb501-6" tabindex="-1"></a>        <span class="op">|&gt;</span> <span class="cn">Enum</span><span class="op">.</span>map<span class="fu">(</span><span class="op">&amp;</span> <span class="op">&amp;</span><span class="dv">1</span><span class="ot">[</span><span class="st">&quot;symbol&quot;</span><span class="ot">]</span><span class="fu">)</span></span>
<span id="cb501-7"><a href="layers-of-abstraction.html#cb501-7" tabindex="-1"></a>        <span class="op">|&gt;</span> then<span class="fu">(</span><span class="op">&amp;</span><span class="fu">{</span><span class="va">:ok</span>, <span class="op">&amp;</span><span class="dv">1</span><span class="fu">})</span></span>
<span id="cb501-8"><a href="layers-of-abstraction.html#cb501-8" tabindex="-1"></a></span>
<span id="cb501-9"><a href="layers-of-abstraction.html#cb501-9" tabindex="-1"></a>      error <span class="op">-&gt;</span></span>
<span id="cb501-10"><a href="layers-of-abstraction.html#cb501-10" tabindex="-1"></a>        error</span>
<span id="cb501-11"><a href="layers-of-abstraction.html#cb501-11" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb501-12"><a href="layers-of-abstraction.html#cb501-12" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb501-13"><a href="layers-of-abstraction.html#cb501-13" tabindex="-1"></a></span>
<span id="cb501-14"><a href="layers-of-abstraction.html#cb501-14" tabindex="-1"></a>  <span class="kw">def</span> fetch_symbol_filters<span class="fu">(</span>symbol<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb501-15"><a href="layers-of-abstraction.html#cb501-15" tabindex="-1"></a>    <span class="kw">case</span> fetch_exchange_info<span class="fu">()</span> <span class="kw">do</span></span>
<span id="cb501-16"><a href="layers-of-abstraction.html#cb501-16" tabindex="-1"></a>      <span class="fu">{</span><span class="va">:ok</span>, exchange_info<span class="fu">}</span> <span class="op">-&gt;</span></span>
<span id="cb501-17"><a href="layers-of-abstraction.html#cb501-17" tabindex="-1"></a>        <span class="fu">{</span><span class="va">:ok</span>, fetch_symbol_filters<span class="fu">(</span>symbol, exchange_info<span class="fu">)}</span></span>
<span id="cb501-18"><a href="layers-of-abstraction.html#cb501-18" tabindex="-1"></a></span>
<span id="cb501-19"><a href="layers-of-abstraction.html#cb501-19" tabindex="-1"></a>      error <span class="op">-&gt;</span></span>
<span id="cb501-20"><a href="layers-of-abstraction.html#cb501-20" tabindex="-1"></a>        error</span>
<span id="cb501-21"><a href="layers-of-abstraction.html#cb501-21" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb501-22"><a href="layers-of-abstraction.html#cb501-22" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb501-23"><a href="layers-of-abstraction.html#cb501-23" tabindex="-1"></a></span>
<span id="cb501-24"><a href="layers-of-abstraction.html#cb501-24" tabindex="-1"></a>  <span class="kw">defp</span> fetch_exchange_info<span class="fu">()</span> <span class="kw">do</span></span>
<span id="cb501-25"><a href="layers-of-abstraction.html#cb501-25" tabindex="-1"></a>    <span class="kw">case</span> <span class="cn">Application</span><span class="op">.</span>get_env<span class="fu">(</span><span class="va">:binance_mock</span>, <span class="va">:use_cached_exchange_info</span><span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb501-26"><a href="layers-of-abstraction.html#cb501-26" tabindex="-1"></a>      <span class="cn">true</span> <span class="op">-&gt;</span></span>
<span id="cb501-27"><a href="layers-of-abstraction.html#cb501-27" tabindex="-1"></a>        get_cached_exchange_info<span class="fu">()</span></span>
<span id="cb501-28"><a href="layers-of-abstraction.html#cb501-28" tabindex="-1"></a></span>
<span id="cb501-29"><a href="layers-of-abstraction.html#cb501-29" tabindex="-1"></a>      _ <span class="op">-&gt;</span></span>
<span id="cb501-30"><a href="layers-of-abstraction.html#cb501-30" tabindex="-1"></a>        <span class="cn">Binance</span><span class="op">.</span>get_exchange_info<span class="fu">()</span></span>
<span id="cb501-31"><a href="layers-of-abstraction.html#cb501-31" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb501-32"><a href="layers-of-abstraction.html#cb501-32" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb501-33"><a href="layers-of-abstraction.html#cb501-33" tabindex="-1"></a></span>
<span id="cb501-34"><a href="layers-of-abstraction.html#cb501-34" tabindex="-1"></a>  <span class="kw">defp</span> get_cached_exchange_info <span class="kw">do</span></span>
<span id="cb501-35"><a href="layers-of-abstraction.html#cb501-35" tabindex="-1"></a>    <span class="cn">File</span><span class="op">.</span>cwd!<span class="fu">()</span></span>
<span id="cb501-36"><a href="layers-of-abstraction.html#cb501-36" tabindex="-1"></a>    <span class="op">|&gt;</span> <span class="cn">Path</span><span class="op">.</span>split<span class="fu">()</span></span>
<span id="cb501-37"><a href="layers-of-abstraction.html#cb501-37" tabindex="-1"></a>    <span class="op">|&gt;</span> <span class="cn">Enum</span><span class="op">.</span>drop<span class="fu">(</span><span class="op">-</span><span class="dv">1</span><span class="fu">)</span></span>
<span id="cb501-38"><a href="layers-of-abstraction.html#cb501-38" tabindex="-1"></a>    <span class="op">|&gt;</span> <span class="cn">Kernel</span><span class="op">.++</span><span class="fu">(</span><span class="ot">[</span></span>
<span id="cb501-39"><a href="layers-of-abstraction.html#cb501-39" tabindex="-1"></a>      <span class="st">&quot;binance_mock&quot;</span>,</span>
<span id="cb501-40"><a href="layers-of-abstraction.html#cb501-40" tabindex="-1"></a>      <span class="st">&quot;test&quot;</span>,</span>
<span id="cb501-41"><a href="layers-of-abstraction.html#cb501-41" tabindex="-1"></a>      <span class="st">&quot;assets&quot;</span>,</span>
<span id="cb501-42"><a href="layers-of-abstraction.html#cb501-42" tabindex="-1"></a>      <span class="st">&quot;exchange_info.json&quot;</span></span>
<span id="cb501-43"><a href="layers-of-abstraction.html#cb501-43" tabindex="-1"></a>    <span class="ot">]</span><span class="fu">)</span></span>
<span id="cb501-44"><a href="layers-of-abstraction.html#cb501-44" tabindex="-1"></a>    <span class="op">|&gt;</span> <span class="cn">Path</span><span class="op">.</span>join<span class="fu">()</span></span>
<span id="cb501-45"><a href="layers-of-abstraction.html#cb501-45" tabindex="-1"></a>    <span class="op">|&gt;</span> <span class="cn">File</span><span class="op">.</span>read<span class="fu">()</span></span>
<span id="cb501-46"><a href="layers-of-abstraction.html#cb501-46" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb501-47"><a href="layers-of-abstraction.html#cb501-47" tabindex="-1"></a></span>
<span id="cb501-48"><a href="layers-of-abstraction.html#cb501-48" tabindex="-1"></a>  <span class="kw">defp</span> fetch_symbol_filters<span class="fu">(</span>symbol, exchange_info<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb501-49"><a href="layers-of-abstraction.html#cb501-49" tabindex="-1"></a>    <span class="co"># &lt;= this is a copy of `Core.Exchange.Binance.fetch_symbol_filters/2` function</span></span>
<span id="cb501-50"><a href="layers-of-abstraction.html#cb501-50" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>There are a few additional helpers above, and it got a bit long - let’s unpack it.</p>
<p>First, both the <code>fetch_symbols/0</code> and <code>fetch_symbol_filters/1</code> look very similar to the ones we implemented for the <code>Core.Exchange.Binance</code> module. The main difference here is that we support cached exchange info by introducing the <code>fetch_exchange_info/0</code> function, which branches out to either using the <code>Binance</code> module or the <code>get_cached_exchange_info/0</code> function. The latter was updated to return the raw data instead of the <code>Binance.ExchangeInfo</code> struct.</p>
<p>Next, there’s the <code>get_oder/3</code> function - as it’s working in the same way as per our behaviour, we will leave it as it is.</p>
<div style="page-break-after: always;"></div>
<p>The final two functions to update will be the <code>order_limit_buy/4</code> and <code>order_limit_sell/4</code>, which will now become three argument functions:</p>
<div class="sourceCode" id="cb502"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb502-1"><a href="layers-of-abstraction.html#cb502-1" tabindex="-1"></a>  <span class="co"># /apps/binance_mock/lib/binance_mock.ex</span></span>
<span id="cb502-2"><a href="layers-of-abstraction.html#cb502-2" tabindex="-1"></a>  <span class="kw">def</span> order_limit_buy<span class="fu">(</span>symbol, quantity, price<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb502-3"><a href="layers-of-abstraction.html#cb502-3" tabindex="-1"></a>    order_limit<span class="fu">(</span>symbol, quantity, price, <span class="st">&quot;BUY&quot;</span><span class="fu">)</span></span>
<span id="cb502-4"><a href="layers-of-abstraction.html#cb502-4" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb502-5"><a href="layers-of-abstraction.html#cb502-5" tabindex="-1"></a></span>
<span id="cb502-6"><a href="layers-of-abstraction.html#cb502-6" tabindex="-1"></a>  <span class="kw">def</span> order_limit_sell<span class="fu">(</span>symbol, quantity, price<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb502-7"><a href="layers-of-abstraction.html#cb502-7" tabindex="-1"></a>    order_limit<span class="fu">(</span>symbol, quantity, price, <span class="st">&quot;SELL&quot;</span><span class="fu">)</span></span>
<span id="cb502-8"><a href="layers-of-abstraction.html#cb502-8" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>In the above functions, we simply skipped the fourth arguments to fulfil the behaviour.</p>
<p>The changes to different structs will have a ripple effect in other parts of the BinanceMock module:</p>
<div class="sourceCode" id="cb503"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb503-1"><a href="layers-of-abstraction.html#cb503-1" tabindex="-1"></a>  <span class="co"># /apps/binance_mock/lib/binance_mock.ex</span></span>
<span id="cb503-2"><a href="layers-of-abstraction.html#cb503-2" tabindex="-1"></a>  <span class="kw">def</span> generate_fake_order<span class="fu">(</span><span class="op">...</span><span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb503-3"><a href="layers-of-abstraction.html#cb503-3" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb503-4"><a href="layers-of-abstraction.html#cb503-4" tabindex="-1"></a>    %<span class="cn">Exchange</span><span class="op">.</span><span class="cn">Order</span><span class="fu">{</span></span>
<span id="cb503-5"><a href="layers-of-abstraction.html#cb503-5" tabindex="-1"></a>      <span class="va">id:</span> order_id,</span>
<span id="cb503-6"><a href="layers-of-abstraction.html#cb503-6" tabindex="-1"></a>      <span class="va">symbol:</span> symbol,</span>
<span id="cb503-7"><a href="layers-of-abstraction.html#cb503-7" tabindex="-1"></a>      <span class="va">price:</span> price,</span>
<span id="cb503-8"><a href="layers-of-abstraction.html#cb503-8" tabindex="-1"></a>      <span class="va">quantity:</span> quantity,</span>
<span id="cb503-9"><a href="layers-of-abstraction.html#cb503-9" tabindex="-1"></a>      <span class="va">side:</span> side_to_atom<span class="fu">(</span>side<span class="fu">)</span>,</span>
<span id="cb503-10"><a href="layers-of-abstraction.html#cb503-10" tabindex="-1"></a>      <span class="va">status:</span> status_to_atom<span class="fu">(</span><span class="st">&quot;NEW&quot;</span><span class="fu">)</span>,</span>
<span id="cb503-11"><a href="layers-of-abstraction.html#cb503-11" tabindex="-1"></a>      <span class="va">timestamp:</span> current_timestamp</span>
<span id="cb503-12"><a href="layers-of-abstraction.html#cb503-12" tabindex="-1"></a>    <span class="fu">}</span> <span class="co"># &lt;= keys updated &amp; `.new` dropped</span></span>
<span id="cb503-13"><a href="layers-of-abstraction.html#cb503-13" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb503-14"><a href="layers-of-abstraction.html#cb503-14" tabindex="-1"></a></span>
<span id="cb503-15"><a href="layers-of-abstraction.html#cb503-15" tabindex="-1"></a>  <span class="kw">defp</span> side_to_atom<span class="fu">(</span><span class="st">&quot;BUY&quot;</span><span class="fu">)</span>, <span class="va">do:</span> <span class="va">:buy</span>   <span class="co"># &lt;= added</span></span>
<span id="cb503-16"><a href="layers-of-abstraction.html#cb503-16" tabindex="-1"></a>  <span class="kw">defp</span> side_to_atom<span class="fu">(</span><span class="st">&quot;SELL&quot;</span><span class="fu">)</span>, <span class="va">do:</span> <span class="va">:sell</span> <span class="co"># &lt;= added</span></span>
<span id="cb503-17"><a href="layers-of-abstraction.html#cb503-17" tabindex="-1"></a></span>
<span id="cb503-18"><a href="layers-of-abstraction.html#cb503-18" tabindex="-1"></a>  <span class="kw">defp</span> status_to_atom<span class="fu">(</span><span class="st">&quot;NEW&quot;</span><span class="fu">)</span>, <span class="va">do:</span> <span class="va">:new</span>       <span class="co"># &lt;= added</span></span>
<span id="cb503-19"><a href="layers-of-abstraction.html#cb503-19" tabindex="-1"></a>  <span class="kw">defp</span> status_to_atom<span class="fu">(</span><span class="st">&quot;FILLED&quot;</span><span class="fu">)</span>, <span class="va">do:</span> <span class="va">:filled</span> <span class="co"># &lt;= added</span></span>
<span id="cb503-20"><a href="layers-of-abstraction.html#cb503-20" tabindex="-1"></a></span>
<span id="cb503-21"><a href="layers-of-abstraction.html#cb503-21" tabindex="-1"></a>  <span class="kw">def</span> handle_call<span class="fu">(</span></span>
<span id="cb503-22"><a href="layers-of-abstraction.html#cb503-22" tabindex="-1"></a>        <span class="fu">{</span><span class="va">:get_order</span>, symbol, time, order_id<span class="fu">}</span>,</span>
<span id="cb503-23"><a href="layers-of-abstraction.html#cb503-23" tabindex="-1"></a>        <span class="op">...</span></span>
<span id="cb503-24"><a href="layers-of-abstraction.html#cb503-24" tabindex="-1"></a>  <span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb503-25"><a href="layers-of-abstraction.html#cb503-25" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb503-26"><a href="layers-of-abstraction.html#cb503-26" tabindex="-1"></a>      <span class="op">|&gt;</span> <span class="cn">Enum</span><span class="op">.</span>find<span class="fu">(</span></span>
<span id="cb503-27"><a href="layers-of-abstraction.html#cb503-27" tabindex="-1"></a>        <span class="op">&amp;</span><span class="fu">(</span><span class="op">&amp;</span><span class="dv">1</span><span class="op">.</span>symbol <span class="op">==</span> symbol <span class="kw">and</span></span>
<span id="cb503-28"><a href="layers-of-abstraction.html#cb503-28" tabindex="-1"></a>            <span class="op">&amp;</span><span class="dv">1</span><span class="op">.</span>timestamp <span class="op">==</span> time <span class="kw">and</span> <span class="co"># &lt;= field updated</span></span>
<span id="cb503-29"><a href="layers-of-abstraction.html#cb503-29" tabindex="-1"></a>            <span class="op">&amp;</span><span class="dv">1</span><span class="op">.</span>id <span class="op">==</span> order_id<span class="fu">)</span>       <span class="co"># &lt;= field updated</span></span>
<span id="cb503-30"><a href="layers-of-abstraction.html#cb503-30" tabindex="-1"></a>      <span class="fu">)</span></span>
<span id="cb503-31"><a href="layers-of-abstraction.html#cb503-31" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb503-32"><a href="layers-of-abstraction.html#cb503-32" tabindex="-1"></a></span>
<span id="cb503-33"><a href="layers-of-abstraction.html#cb503-33" tabindex="-1"></a>  <span class="kw">def</span> handle_info<span class="fu">(</span></span>
<span id="cb503-34"><a href="layers-of-abstraction.html#cb503-34" tabindex="-1"></a>      %<span class="cn">TradeEvent</span><span class="fu">{}</span> <span class="op">=</span> trade_event,</span>
<span id="cb503-35"><a href="layers-of-abstraction.html#cb503-35" tabindex="-1"></a>      <span class="op">...</span></span>
<span id="cb503-36"><a href="layers-of-abstraction.html#cb503-36" tabindex="-1"></a>  <span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb503-37"><a href="layers-of-abstraction.html#cb503-37" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb503-38"><a href="layers-of-abstraction.html#cb503-38" tabindex="-1"></a>    filled_buy_orders <span class="op">=</span></span>
<span id="cb503-39"><a href="layers-of-abstraction.html#cb503-39" tabindex="-1"></a>      <span class="op">...</span></span>
<span id="cb503-40"><a href="layers-of-abstraction.html#cb503-40" tabindex="-1"></a>      <span class="op">|&gt;</span> <span class="cn">Enum</span><span class="op">.</span>map<span class="fu">(</span><span class="op">&amp;</span><span class="cn">Map</span><span class="op">.</span>replace!<span class="fu">(</span><span class="op">&amp;</span><span class="dv">1</span>, <span class="va">:status</span>, <span class="va">:filled</span><span class="fu">))</span> <span class="co"># &lt;= changed to atom</span></span>
<span id="cb503-41"><a href="layers-of-abstraction.html#cb503-41" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb503-42"><a href="layers-of-abstraction.html#cb503-42" tabindex="-1"></a>    filled_sell_orders <span class="op">=</span></span>
<span id="cb503-43"><a href="layers-of-abstraction.html#cb503-43" tabindex="-1"></a>      <span class="op">...</span></span>
<span id="cb503-44"><a href="layers-of-abstraction.html#cb503-44" tabindex="-1"></a>      <span class="op">|&gt;</span> <span class="cn">Enum</span><span class="op">.</span>map<span class="fu">(</span><span class="op">&amp;</span><span class="cn">Map</span><span class="op">.</span>replace!<span class="fu">(</span><span class="op">&amp;</span><span class="dv">1</span>, <span class="va">:status</span>, <span class="va">:filled</span><span class="fu">))</span> <span class="co"># &lt;= changed to atom</span></span>
<span id="cb503-45"><a href="layers-of-abstraction.html#cb503-45" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb503-46"><a href="layers-of-abstraction.html#cb503-46" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb503-47"><a href="layers-of-abstraction.html#cb503-47" tabindex="-1"></a></span>
<span id="cb503-48"><a href="layers-of-abstraction.html#cb503-48" tabindex="-1"></a>  <span class="kw">defp</span> order_limit<span class="fu">(</span>symbol, quantity, price, side<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb503-49"><a href="layers-of-abstraction.html#cb503-49" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb503-50"><a href="layers-of-abstraction.html#cb503-50" tabindex="-1"></a>   <span class="fu">{</span><span class="va">:ok</span>, fake_order<span class="fu">}</span> <span class="co"># &lt;= no need to convert between structs any more</span></span>
<span id="cb503-51"><a href="layers-of-abstraction.html#cb503-51" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb503-52"><a href="layers-of-abstraction.html#cb503-52" tabindex="-1"></a></span>
<span id="cb503-53"><a href="layers-of-abstraction.html#cb503-53" tabindex="-1"></a>  <span class="co"># remove the `convert_order_to_order_response/1` function - not required anymore</span></span>
<span id="cb503-54"><a href="layers-of-abstraction.html#cb503-54" tabindex="-1"></a></span>
<span id="cb503-55"><a href="layers-of-abstraction.html#cb503-55" tabindex="-1"></a>  <span class="co"># and finally ;)</span></span>
<span id="cb503-56"><a href="layers-of-abstraction.html#cb503-56" tabindex="-1"></a></span>
<span id="cb503-57"><a href="layers-of-abstraction.html#cb503-57" tabindex="-1"></a>  <span class="kw">defp</span> convert_order_to_event<span class="fu">(</span>%<span class="cn">Exchange</span><span class="op">.</span><span class="cn">Order</span><span class="fu">{}</span> <span class="op">=</span> order, time<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb503-58"><a href="layers-of-abstraction.html#cb503-58" tabindex="-1"></a>    %<span class="cn">TradeEvent</span><span class="fu">{</span></span>
<span id="cb503-59"><a href="layers-of-abstraction.html#cb503-59" tabindex="-1"></a>      <span class="va">event_time:</span> time <span class="op">-</span> <span class="dv">1</span>,</span>
<span id="cb503-60"><a href="layers-of-abstraction.html#cb503-60" tabindex="-1"></a>      <span class="va">symbol:</span> order<span class="op">.</span>symbol,</span>
<span id="cb503-61"><a href="layers-of-abstraction.html#cb503-61" tabindex="-1"></a>      <span class="va">trade_id:</span> <span class="cn">Integer</span><span class="op">.</span>floor_div<span class="fu">(</span>time, <span class="dv">1000</span><span class="fu">)</span>,</span>
<span id="cb503-62"><a href="layers-of-abstraction.html#cb503-62" tabindex="-1"></a>      <span class="va">price:</span> order<span class="op">.</span>price,</span>
<span id="cb503-63"><a href="layers-of-abstraction.html#cb503-63" tabindex="-1"></a>      <span class="va">quantity:</span> order<span class="op">.</span>quantity,  </span>
<span id="cb503-64"><a href="layers-of-abstraction.html#cb503-64" tabindex="-1"></a>      <span class="va">buyer_order_id:</span> order<span class="op">.</span>id,</span>
<span id="cb503-65"><a href="layers-of-abstraction.html#cb503-65" tabindex="-1"></a>      <span class="va">seller_order_id:</span> order<span class="op">.</span>id,</span>
<span id="cb503-66"><a href="layers-of-abstraction.html#cb503-66" tabindex="-1"></a>      <span class="va">trade_time:</span> time <span class="op">-</span> <span class="dv">1</span>,</span>
<span id="cb503-67"><a href="layers-of-abstraction.html#cb503-67" tabindex="-1"></a>      <span class="va">buyer_market_maker:</span> <span class="cn">false</span></span>
<span id="cb503-68"><a href="layers-of-abstraction.html#cb503-68" tabindex="-1"></a>    <span class="fu">}</span> <span class="co"># ^^^^^^= updated mapping</span></span>
<span id="cb503-69"><a href="layers-of-abstraction.html#cb503-69" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>The above changes finish the modifications to the BiananceMock. The module now correctly implements the behaviour.</p>
</div>
<div id="updating-the-naive.strategy" class="section level3 hasAnchor" number="21.3.4">
<h3><span class="header-section-number">21.3.4</span> Updating the <code>Naive.Strategy</code><a href="layers-of-abstraction.html#updating-the-naive.strategy" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We can now move on to the code that will use our implementations of the <code>Core.Exchange</code> behaviour - the <code>Naive.Strategy</code> module.</p>
<p>We will start by adding an alias to the <code>Core.Exchange</code> at the top of the module:</p>
<div class="sourceCode" id="cb504"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb504-1"><a href="layers-of-abstraction.html#cb504-1" tabindex="-1"></a>  <span class="co"># /apps/naive/lib/naive/strategy.ex</span></span>
<span id="cb504-2"><a href="layers-of-abstraction.html#cb504-2" tabindex="-1"></a>  <span class="im">alias</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">Exchange</span></span></code></pre></div>
<p>Next, we can rename the configuration based <code>@binance_client</code> to <code>@exchange_client</code> and update references to it throughout the module:</p>
<div class="sourceCode" id="cb505"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb505-1"><a href="layers-of-abstraction.html#cb505-1" tabindex="-1"></a>  <span class="co"># /apps/naive/lib/naive/strategy.ex</span></span>
<span id="cb505-2"><a href="layers-of-abstraction.html#cb505-2" tabindex="-1"></a>  <span class="ot">@exchange_client</span> <span class="cn">Application</span><span class="op">.</span>compile_env<span class="fu">(</span><span class="va">:naive</span>, <span class="va">:exchange_client</span><span class="fu">)</span></span></code></pre></div>
<p>Besides the above, we are now relying on the generic structs, so we need to update all references to the <code>Binance.OrderResponse</code> and <code>Binance.Order</code> modules with the <code>Exchange.Order</code> (including updating all field names) - for example:</p>
<div class="sourceCode" id="cb506"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb506-1"><a href="layers-of-abstraction.html#cb506-1" tabindex="-1"></a>  <span class="co"># /apps/naive/lib/naive/strategy.ex</span></span>
<span id="cb506-2"><a href="layers-of-abstraction.html#cb506-2" tabindex="-1"></a>  <span class="co"># from:</span></span>
<span id="cb506-3"><a href="layers-of-abstraction.html#cb506-3" tabindex="-1"></a>        %<span class="cn">Position</span><span class="fu">{</span></span>
<span id="cb506-4"><a href="layers-of-abstraction.html#cb506-4" tabindex="-1"></a>          <span class="va">buy_order:</span> %<span class="cn">Binance</span><span class="op">.</span><span class="cn">Order</span><span class="fu">{</span></span>
<span id="cb506-5"><a href="layers-of-abstraction.html#cb506-5" tabindex="-1"></a>            <span class="va">order_id:</span> order_id,</span>
<span id="cb506-6"><a href="layers-of-abstraction.html#cb506-6" tabindex="-1"></a>            <span class="va">status:</span> <span class="st">&quot;FILLED&quot;</span></span>
<span id="cb506-7"><a href="layers-of-abstraction.html#cb506-7" tabindex="-1"></a>          <span class="fu">}</span>,</span>
<span id="cb506-8"><a href="layers-of-abstraction.html#cb506-8" tabindex="-1"></a>          <span class="va">sell_order:</span> <span class="cn">Binance</span><span class="op">.</span><span class="cn">Order</span><span class="fu">{}</span></span>
<span id="cb506-9"><a href="layers-of-abstraction.html#cb506-9" tabindex="-1"></a>        <span class="fu">}</span>,</span>
<span id="cb506-10"><a href="layers-of-abstraction.html#cb506-10" tabindex="-1"></a></span>
<span id="cb506-11"><a href="layers-of-abstraction.html#cb506-11" tabindex="-1"></a>  <span class="co"># to:</span></span>
<span id="cb506-12"><a href="layers-of-abstraction.html#cb506-12" tabindex="-1"></a>        %<span class="cn">Position</span><span class="fu">{</span></span>
<span id="cb506-13"><a href="layers-of-abstraction.html#cb506-13" tabindex="-1"></a>          <span class="va">buy_order:</span> %<span class="cn">Exchange</span><span class="op">.</span><span class="cn">Order</span><span class="fu">{</span> <span class="co"># &lt;= struct updated</span></span>
<span id="cb506-14"><a href="layers-of-abstraction.html#cb506-14" tabindex="-1"></a>            <span class="va">id:</span> order_id,   <span class="co"># &lt;= key updated</span></span>
<span id="cb506-15"><a href="layers-of-abstraction.html#cb506-15" tabindex="-1"></a>            <span class="va">status:</span> <span class="va">:filled</span> <span class="co"># &lt;= updated to atom</span></span>
<span id="cb506-16"><a href="layers-of-abstraction.html#cb506-16" tabindex="-1"></a>          <span class="fu">}</span>,</span>
<span id="cb506-17"><a href="layers-of-abstraction.html#cb506-17" tabindex="-1"></a>          <span class="va">sell_order:</span> %<span class="cn">Exchange</span><span class="op">.</span><span class="cn">Order</span><span class="fu">{}</span></span>
<span id="cb506-18"><a href="layers-of-abstraction.html#cb506-18" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb506-19"><a href="layers-of-abstraction.html#cb506-19" tabindex="-1"></a></span>
<span id="cb506-20"><a href="layers-of-abstraction.html#cb506-20" tabindex="-1"></a>  <span class="co"># rename cheatsheet:</span></span>
<span id="cb506-21"><a href="layers-of-abstraction.html#cb506-21" tabindex="-1"></a>  <span class="co"># order_id to id (do not use &quot;global&quot; file replace)</span></span>
<span id="cb506-22"><a href="layers-of-abstraction.html#cb506-22" tabindex="-1"></a>  <span class="co"># orig_qty to quantity (&quot;global&quot; file replace safe)</span></span>
<span id="cb506-23"><a href="layers-of-abstraction.html#cb506-23" tabindex="-1"></a>  <span class="co"># transact_time to timestamp (&quot;global&quot; file replace safe)</span></span>
<span id="cb506-24"><a href="layers-of-abstraction.html#cb506-24" tabindex="-1"></a>  <span class="co"># &quot;FILLED&quot; to :filled (&quot;global&quot; file replace safe)</span></span></code></pre></div>
<div style="page-break-after: always;"></div>
<p>As the behaviour’s interface(public functions) differs from the <code>Binance</code> module, we need to update all calls that we simplified:</p>
<div class="sourceCode" id="cb507"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb507-1"><a href="layers-of-abstraction.html#cb507-1" tabindex="-1"></a>  <span class="co"># /apps/naive/lib/naive/strategy.ex</span></span>
<span id="cb507-2"><a href="layers-of-abstraction.html#cb507-2" tabindex="-1"></a>  <span class="fu">{</span><span class="va">:ok</span>, %<span class="cn">Exchange</span><span class="op">.</span><span class="cn">Order</span><span class="fu">{}</span> <span class="op">=</span> order<span class="fu">}</span> <span class="op">=</span> <span class="ot">@exchange_client</span><span class="op">.</span>order_limit_buy<span class="fu">(</span>symbol, quantity, price<span class="fu">)</span></span>
<span id="cb507-3"><a href="layers-of-abstraction.html#cb507-3" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb507-4"><a href="layers-of-abstraction.html#cb507-4" tabindex="-1"></a>  <span class="fu">{</span><span class="va">:ok</span>, %<span class="cn">Exchange</span><span class="op">.</span><span class="cn">Order</span><span class="fu">{}</span> <span class="op">=</span> order<span class="fu">}</span> <span class="op">=</span></span>
<span id="cb507-5"><a href="layers-of-abstraction.html#cb507-5" tabindex="-1"></a>      <span class="ot">@exchange_client</span><span class="op">.</span>order_limit_sell<span class="fu">(</span>symbol, quantity, sell_price<span class="fu">)</span></span></code></pre></div>
<p>As of now, we will deal only with the <code>Exchange.Order</code> structs instead a pair of <code>Binance.OrderResponse</code> and <code>Binance.Order</code>, we can simplify the existing two clauses of <code>broadcast_order/1</code> into a single one(and remove the <code>convert_to_order/1</code> function):</p>
<div class="sourceCode" id="cb508"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb508-1"><a href="layers-of-abstraction.html#cb508-1" tabindex="-1"></a> <span class="co"># /apps/naive/lib/naive/strategy.ex</span></span>
<span id="cb508-2"><a href="layers-of-abstraction.html#cb508-2" tabindex="-1"></a> <span class="kw">defp</span> broadcast_order<span class="fu">(</span>%<span class="cn">Exchange</span><span class="op">.</span><span class="cn">Order</span><span class="fu">{}</span> <span class="op">=</span> order<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb508-3"><a href="layers-of-abstraction.html#cb508-3" tabindex="-1"></a>   <span class="ot">@pubsub_client</span><span class="op">.</span>broadcast<span class="fu">(</span></span>
<span id="cb508-4"><a href="layers-of-abstraction.html#cb508-4" tabindex="-1"></a>     <span class="cn">Core</span><span class="op">.</span><span class="cn">PubSub</span>,</span>
<span id="cb508-5"><a href="layers-of-abstraction.html#cb508-5" tabindex="-1"></a>     <span class="st">&quot;ORDERS:</span><span class="ot">#{</span>order<span class="op">.</span>symbol<span class="ot">}</span><span class="st">&quot;</span>,</span>
<span id="cb508-6"><a href="layers-of-abstraction.html#cb508-6" tabindex="-1"></a>     order</span>
<span id="cb508-7"><a href="layers-of-abstraction.html#cb508-7" tabindex="-1"></a>   <span class="fu">)</span></span>
<span id="cb508-8"><a href="layers-of-abstraction.html#cb508-8" tabindex="-1"></a> <span class="kw">end</span></span></code></pre></div>
<p>The final change to the <code>Naive.Strategy</code> module will be to update the <code>fetch_symbol_settings/1</code> function (and remove the <code>merge_filters_into_settings/3</code> function):</p>
<div class="sourceCode" id="cb509"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb509-1"><a href="layers-of-abstraction.html#cb509-1" tabindex="-1"></a>  <span class="co"># /apps/naive/lib/naive/strategy.ex</span></span>
<span id="cb509-2"><a href="layers-of-abstraction.html#cb509-2" tabindex="-1"></a>  <span class="kw">def</span> fetch_symbol_settings<span class="fu">(</span>symbol<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb509-3"><a href="layers-of-abstraction.html#cb509-3" tabindex="-1"></a>    <span class="fu">{</span><span class="va">:ok</span>, filters<span class="fu">}</span> <span class="op">=</span> <span class="ot">@exchange_client</span><span class="op">.</span>fetch_symbol_filters<span class="fu">(</span>symbol<span class="fu">)</span></span>
<span id="cb509-4"><a href="layers-of-abstraction.html#cb509-4" tabindex="-1"></a>    db_settings <span class="op">=</span> <span class="ot">@repo</span><span class="op">.</span>get_by!<span class="fu">(</span><span class="cn">Settings</span>, <span class="va">symbol:</span> symbol<span class="fu">)</span></span>
<span id="cb509-5"><a href="layers-of-abstraction.html#cb509-5" tabindex="-1"></a></span>
<span id="cb509-6"><a href="layers-of-abstraction.html#cb509-6" tabindex="-1"></a>    <span class="cn">Map</span><span class="op">.</span>merge<span class="fu">(</span></span>
<span id="cb509-7"><a href="layers-of-abstraction.html#cb509-7" tabindex="-1"></a>      filters <span class="op">|&gt;</span> <span class="cn">Map</span><span class="op">.</span>from_struct<span class="fu">()</span>,</span>
<span id="cb509-8"><a href="layers-of-abstraction.html#cb509-8" tabindex="-1"></a>      db_settings <span class="op">|&gt;</span> <span class="cn">Map</span><span class="op">.</span>from_struct<span class="fu">()</span></span>
<span id="cb509-9"><a href="layers-of-abstraction.html#cb509-9" tabindex="-1"></a>    <span class="fu">)</span></span>
<span id="cb509-10"><a href="layers-of-abstraction.html#cb509-10" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>The function is now much more straightforward as we use the <code>fetch_symbol_filters/1</code> function implemented as a part of the <code>Core.Exchange</code> behaviour.</p>
<div style="page-break-after: always;"></div>
</div>
<div id="updating-the-seed-scripts" class="section level3 hasAnchor" number="21.3.5">
<h3><span class="header-section-number">21.3.5</span> Updating the seed scripts<a href="layers-of-abstraction.html#updating-the-seed-scripts" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The other places we use the exchange are seed scripts that we need to update. First inside the <code>Naive</code> application:</p>
<div class="sourceCode" id="cb510"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb510-1"><a href="layers-of-abstraction.html#cb510-1" tabindex="-1"></a><span class="co"># /apps/naive/priv/seed_settings.exs</span></span>
<span id="cb510-2"><a href="layers-of-abstraction.html#cb510-2" tabindex="-1"></a>exchange_client <span class="op">=</span> <span class="cn">Application</span><span class="op">.</span>get_env<span class="fu">(</span><span class="va">:naive</span>, <span class="va">:exchange_client</span><span class="fu">)</span></span>
<span id="cb510-3"><a href="layers-of-abstraction.html#cb510-3" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb510-4"><a href="layers-of-abstraction.html#cb510-4" tabindex="-1"></a><span class="fu">{</span><span class="va">:ok</span>, symbols<span class="fu">}</span> <span class="op">=</span> exchange_client<span class="op">.</span>fetch_symbols<span class="fu">()</span></span>
<span id="cb510-5"><a href="layers-of-abstraction.html#cb510-5" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb510-6"><a href="layers-of-abstraction.html#cb510-6" tabindex="-1"></a>maps <span class="op">=</span> symbols</span>
<span id="cb510-7"><a href="layers-of-abstraction.html#cb510-7" tabindex="-1"></a>  <span class="op">|&gt;</span> <span class="cn">Enum</span><span class="op">.</span>map<span class="fu">(</span><span class="op">&amp;</span><span class="fu">(</span>%<span class="fu">{</span>base_settings <span class="op">|</span> <span class="va">symbol:</span> <span class="op">&amp;</span><span class="dv">1</span><span class="fu">}))</span></span></code></pre></div>
<p>We no longer use the <code>binance_client</code> but <code>exchange_client</code> instead - in the same fashion as inside the <code>Naive.Strategy</code> module. Both implementations provide the <code>fetch_symbols/0</code> function, which returns a list of symbols - hence the change inside the <code>Enum/2</code> function.</p>
<p>We will follow up with changes to the seeding script of the <code>Streamer</code> application(I will skip listing the changes here as they are <strong>the same</strong> as in the case of the <code>Naive</code> application).</p>
<p>At this moment, we can change the configuration to make the <code>Naive.Strategy</code> work:</p>
<div class="sourceCode" id="cb511"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb511-1"><a href="layers-of-abstraction.html#cb511-1" tabindex="-1"></a><span class="co"># /config/config.ex </span></span>
<span id="cb511-2"><a href="layers-of-abstraction.html#cb511-2" tabindex="-1"></a>config <span class="va">:streamer</span>,</span>
<span id="cb511-3"><a href="layers-of-abstraction.html#cb511-3" tabindex="-1"></a>  <span class="va">exchange_client:</span> <span class="cn">BinanceMock</span>, <span class="co"># &lt;= key updated</span></span>
<span id="cb511-4"><a href="layers-of-abstraction.html#cb511-4" tabindex="-1"></a></span>
<span id="cb511-5"><a href="layers-of-abstraction.html#cb511-5" tabindex="-1"></a>config <span class="va">:naive</span>,</span>
<span id="cb511-6"><a href="layers-of-abstraction.html#cb511-6" tabindex="-1"></a>  <span class="va">exchange_client:</span> <span class="cn">BinanceMock</span>, <span class="co"># &lt;= key updated</span></span>
<span id="cb511-7"><a href="layers-of-abstraction.html#cb511-7" tabindex="-1"></a></span>
<span id="cb511-8"><a href="layers-of-abstraction.html#cb511-8" tabindex="-1"></a><span class="co"># /config/prod.exs</span></span>
<span id="cb511-9"><a href="layers-of-abstraction.html#cb511-9" tabindex="-1"></a>config <span class="va">:naive</span>,</span>
<span id="cb511-10"><a href="layers-of-abstraction.html#cb511-10" tabindex="-1"></a>  <span class="va">exchange_client:</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">Exchange</span><span class="op">.</span><span class="cn">Binance</span> <span class="co"># &lt;= key and module updated</span></span>
<span id="cb511-11"><a href="layers-of-abstraction.html#cb511-11" tabindex="-1"></a></span>
<span id="cb511-12"><a href="layers-of-abstraction.html#cb511-12" tabindex="-1"></a>config <span class="va">:streamer</span>,</span>
<span id="cb511-13"><a href="layers-of-abstraction.html#cb511-13" tabindex="-1"></a>  <span class="va">exchange_client:</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">Exchange</span><span class="op">.</span><span class="cn">Binance</span> <span class="co"># &lt;= key and module updated</span></span>
<span id="cb511-14"><a href="layers-of-abstraction.html#cb511-14" tabindex="-1"></a></span>
<span id="cb511-15"><a href="layers-of-abstraction.html#cb511-15" tabindex="-1"></a><span class="co"># /config/test.exs</span></span>
<span id="cb511-16"><a href="layers-of-abstraction.html#cb511-16" tabindex="-1"></a>config <span class="va">:naive</span>,</span>
<span id="cb511-17"><a href="layers-of-abstraction.html#cb511-17" tabindex="-1"></a>  <span class="va">exchange_client:</span> <span class="cn">Test</span><span class="op">.</span><span class="cn">BinanceMock</span>, <span class="co"># &lt;= key updated</span></span></code></pre></div>
<div style="page-break-after: always;"></div>
</div>
<div id="manual-testing-after-the-refactoring" class="section level3 hasAnchor" number="21.3.6">
<h3><span class="header-section-number">21.3.6</span> Manual testing after the refactoring<a href="layers-of-abstraction.html#manual-testing-after-the-refactoring" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We can now test that <code>Naive.Strategy</code> works:</p>
<div class="sourceCode" id="cb512"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb512-1"><a href="layers-of-abstraction.html#cb512-1" tabindex="-1"></a><span class="ex">$</span> iex <span class="at">-S</span> mix</span>
<span id="cb512-2"><a href="layers-of-abstraction.html#cb512-2" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb512-3"><a href="layers-of-abstraction.html#cb512-3" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">1</span><span class="kw">)</span><span class="op">&gt;</span> Streamer.start_streaming<span class="kw">(</span><span class="st">&quot;XRPUSDT&quot;</span><span class="kw">)</span></span>
<span id="cb512-4"><a href="layers-of-abstraction.html#cb512-4" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb512-5"><a href="layers-of-abstraction.html#cb512-5" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">2</span><span class="kw">)</span><span class="op">&gt;</span> Naive.start_trading<span class="kw">(</span><span class="st">&quot;XRPUSDT&quot;</span><span class="kw">)</span></span>
<span id="cb512-6"><a href="layers-of-abstraction.html#cb512-6" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb512-7"><a href="layers-of-abstraction.html#cb512-7" tabindex="-1"></a><span class="ex">21:42:12.813</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span>  Position <span class="er">(</span><span class="ex">XRPUSDT/1662842530254</span><span class="kw">)</span><span class="bu">:</span> Placing a BUY order @ 0.35560000,</span>
<span id="cb512-8"><a href="layers-of-abstraction.html#cb512-8" tabindex="-1"></a><span class="ex">quantity:</span> 562.00000000</span>
<span id="cb512-9"><a href="layers-of-abstraction.html#cb512-9" tabindex="-1"></a><span class="ex">21:42:15.280</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span>  Position <span class="er">(</span><span class="ex">XRPUSDT/1662842530254</span><span class="kw">)</span><span class="bu">:</span> The BUY order is now partially filled</span>
<span id="cb512-10"><a href="layers-of-abstraction.html#cb512-10" tabindex="-1"></a><span class="ex">21:42:15.281</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span>  Position <span class="er">(</span><span class="ex">XRPUSDT/1662842530254</span><span class="kw">)</span><span class="bu">:</span> The BUY order is now filled. Placing</span>
<span id="cb512-11"><a href="layers-of-abstraction.html#cb512-11" tabindex="-1"></a><span class="ex">a</span> SELL order @ 0.35580000, quantity: 562.00000000</span>
<span id="cb512-12"><a href="layers-of-abstraction.html#cb512-12" tabindex="-1"></a><span class="ex">21:42:15.536</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span>  Position <span class="er">(</span><span class="ex">XRPUSDT/1662842530254</span><span class="kw">)</span><span class="bu">:</span> The SELL order is now partially</span>
<span id="cb512-13"><a href="layers-of-abstraction.html#cb512-13" tabindex="-1"></a><span class="ex">filled</span></span>
<span id="cb512-14"><a href="layers-of-abstraction.html#cb512-14" tabindex="-1"></a><span class="ex">21:42:15.593</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span>  Position <span class="er">(</span><span class="ex">XRPUSDT/1662842530254</span><span class="kw">)</span><span class="bu">:</span> Trade cycle finished</span></code></pre></div>
<p>The above output confirms that we have a full working trading flow using either <code>Core.Exchange.Binance</code> or <code>BinanceMock</code>.</p>
</div>
<div id="storing-the-data" class="section level3 hasAnchor" number="21.3.7">
<h3><span class="header-section-number">21.3.7</span> Storing the data<a href="layers-of-abstraction.html#storing-the-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As we are now using generic structs like the <code>Core.Exchange.Order</code>, all data storage-related code needs to be updated.</p>
<p>We will start by updating the migration script to store only limited passed data:</p>
<div class="sourceCode" id="cb513"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb513-1"><a href="layers-of-abstraction.html#cb513-1" tabindex="-1"></a>  <span class="co"># /apps/data_warehouse/priv/repo/migrations/20210222224522_create_orders.exs</span></span>
<span id="cb513-2"><a href="layers-of-abstraction.html#cb513-2" tabindex="-1"></a>  <span class="kw">def</span> change <span class="kw">do</span></span>
<span id="cb513-3"><a href="layers-of-abstraction.html#cb513-3" tabindex="-1"></a>    create table<span class="fu">(</span><span class="va">:orders</span>, <span class="va">primary_key:</span> <span class="cn">false</span><span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb513-4"><a href="layers-of-abstraction.html#cb513-4" tabindex="-1"></a>      add<span class="fu">(</span><span class="va">:id</span>, <span class="va">:bigint</span>, <span class="va">primary_key:</span> <span class="cn">true</span><span class="fu">)</span></span>
<span id="cb513-5"><a href="layers-of-abstraction.html#cb513-5" tabindex="-1"></a>      add<span class="fu">(</span><span class="va">:symbol</span>, <span class="va">:text</span><span class="fu">)</span></span>
<span id="cb513-6"><a href="layers-of-abstraction.html#cb513-6" tabindex="-1"></a>      add<span class="fu">(</span><span class="va">:price</span>, <span class="va">:text</span><span class="fu">)</span></span>
<span id="cb513-7"><a href="layers-of-abstraction.html#cb513-7" tabindex="-1"></a>      add<span class="fu">(</span><span class="va">:quantity</span>, <span class="va">:text</span><span class="fu">)</span></span>
<span id="cb513-8"><a href="layers-of-abstraction.html#cb513-8" tabindex="-1"></a>      add<span class="fu">(</span><span class="va">:side</span>, <span class="va">:text</span><span class="fu">)</span></span>
<span id="cb513-9"><a href="layers-of-abstraction.html#cb513-9" tabindex="-1"></a>      add<span class="fu">(</span><span class="va">:status</span>, <span class="va">:text</span><span class="fu">)</span></span>
<span id="cb513-10"><a href="layers-of-abstraction.html#cb513-10" tabindex="-1"></a>      add<span class="fu">(</span><span class="va">:timestamp</span>, <span class="va">:bigint</span><span class="fu">)</span></span>
<span id="cb513-11"><a href="layers-of-abstraction.html#cb513-11" tabindex="-1"></a></span>
<span id="cb513-12"><a href="layers-of-abstraction.html#cb513-12" tabindex="-1"></a>      timestamps<span class="fu">()</span></span>
<span id="cb513-13"><a href="layers-of-abstraction.html#cb513-13" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb513-14"><a href="layers-of-abstraction.html#cb513-14" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>A lot of fields got removed/renamed, including the primary key. We will follow up by updating the schema for that table:</p>
<div class="sourceCode" id="cb514"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb514-1"><a href="layers-of-abstraction.html#cb514-1" tabindex="-1"></a> <span class="co"># /apps/data_warehouse/lib/data_warehouse/schema/order.ex</span></span>
<span id="cb514-2"><a href="layers-of-abstraction.html#cb514-2" tabindex="-1"></a>  <span class="ot">@primary_key</span> <span class="fu">{</span><span class="va">:id</span>, <span class="va">:integer</span>, <span class="va">autogenerate:</span> <span class="cn">false</span><span class="fu">}</span> <span class="co"># &lt;= column updated</span></span>
<span id="cb514-3"><a href="layers-of-abstraction.html#cb514-3" tabindex="-1"></a></span>
<span id="cb514-4"><a href="layers-of-abstraction.html#cb514-4" tabindex="-1"></a>  schema <span class="st">&quot;orders&quot;</span> <span class="kw">do</span></span>
<span id="cb514-5"><a href="layers-of-abstraction.html#cb514-5" tabindex="-1"></a>    field<span class="fu">(</span><span class="va">:symbol</span>, <span class="va">:string</span><span class="fu">)</span></span>
<span id="cb514-6"><a href="layers-of-abstraction.html#cb514-6" tabindex="-1"></a>    field<span class="fu">(</span><span class="va">:price</span>, <span class="va">:string</span><span class="fu">)</span></span>
<span id="cb514-7"><a href="layers-of-abstraction.html#cb514-7" tabindex="-1"></a>    field<span class="fu">(</span><span class="va">:quantity</span>, <span class="va">:string</span><span class="fu">)</span></span>
<span id="cb514-8"><a href="layers-of-abstraction.html#cb514-8" tabindex="-1"></a>    field<span class="fu">(</span><span class="va">:side</span>, <span class="va">:string</span><span class="fu">)</span></span>
<span id="cb514-9"><a href="layers-of-abstraction.html#cb514-9" tabindex="-1"></a>    field<span class="fu">(</span><span class="va">:status</span>, <span class="va">:string</span><span class="fu">)</span></span>
<span id="cb514-10"><a href="layers-of-abstraction.html#cb514-10" tabindex="-1"></a>    field<span class="fu">(</span><span class="va">:timestamp</span>, <span class="va">:integer</span><span class="fu">)</span></span>
<span id="cb514-11"><a href="layers-of-abstraction.html#cb514-11" tabindex="-1"></a></span>
<span id="cb514-12"><a href="layers-of-abstraction.html#cb514-12" tabindex="-1"></a>    timestamps<span class="fu">()</span></span>
<span id="cb514-13"><a href="layers-of-abstraction.html#cb514-13" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>The schema was updated to mirror the new shape of the <code>orders</code> db table.
We can now progress to the Worker, where we will start to use the <code>Core.Exchange</code> based structs:</p>
<div class="sourceCode" id="cb515"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb515-1"><a href="layers-of-abstraction.html#cb515-1" tabindex="-1"></a>  <span class="co"># /apps/data_warehouse/lib/data_warehouse/subscriber/worker.ex</span></span>
<span id="cb515-2"><a href="layers-of-abstraction.html#cb515-2" tabindex="-1"></a>  <span class="im">alias</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">Exchange</span> <span class="co"># &lt;= alias added</span></span>
<span id="cb515-3"><a href="layers-of-abstraction.html#cb515-3" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb515-4"><a href="layers-of-abstraction.html#cb515-4" tabindex="-1"></a>  <span class="kw">def</span> handle_info<span class="fu">(</span>%<span class="cn">Exchange</span><span class="op">.</span><span class="cn">Order</span><span class="fu">{}</span> <span class="op">=</span> order, state<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb515-5"><a href="layers-of-abstraction.html#cb515-5" tabindex="-1"></a>    data <span class="op">=</span></span>
<span id="cb515-6"><a href="layers-of-abstraction.html#cb515-6" tabindex="-1"></a>      order</span>
<span id="cb515-7"><a href="layers-of-abstraction.html#cb515-7" tabindex="-1"></a>      <span class="op">|&gt;</span> <span class="cn">Map</span><span class="op">.</span>from_struct<span class="fu">()</span></span>
<span id="cb515-8"><a href="layers-of-abstraction.html#cb515-8" tabindex="-1"></a>      <span class="op">|&gt;</span> <span class="cn">Map</span><span class="op">.</span>merge<span class="fu">(</span>%<span class="fu">{</span></span>
<span id="cb515-9"><a href="layers-of-abstraction.html#cb515-9" tabindex="-1"></a>        <span class="va">side:</span> atom_to_side<span class="fu">(</span>order<span class="op">.</span>side<span class="fu">)</span>,</span>
<span id="cb515-10"><a href="layers-of-abstraction.html#cb515-10" tabindex="-1"></a>        <span class="va">status:</span> atom_to_status<span class="fu">(</span>order<span class="op">.</span>status<span class="fu">)</span></span>
<span id="cb515-11"><a href="layers-of-abstraction.html#cb515-11" tabindex="-1"></a>      <span class="fu">})</span></span>
<span id="cb515-12"><a href="layers-of-abstraction.html#cb515-12" tabindex="-1"></a></span>
<span id="cb515-13"><a href="layers-of-abstraction.html#cb515-13" tabindex="-1"></a>    struct<span class="fu">(</span><span class="cn">DataWarehouse</span><span class="op">.</span><span class="cn">Schema</span><span class="op">.</span><span class="cn">Order</span>, data<span class="fu">)</span></span>
<span id="cb515-14"><a href="layers-of-abstraction.html#cb515-14" tabindex="-1"></a>    <span class="op">|&gt;</span> <span class="cn">DataWarehouse</span><span class="op">.</span><span class="cn">Repo</span><span class="op">.</span>insert<span class="fu">(</span></span>
<span id="cb515-15"><a href="layers-of-abstraction.html#cb515-15" tabindex="-1"></a>      <span class="va">on_conflict:</span> <span class="va">:replace_all</span>,</span>
<span id="cb515-16"><a href="layers-of-abstraction.html#cb515-16" tabindex="-1"></a>      <span class="va">conflict_target:</span> <span class="va">:id</span> <span class="co"># &lt;= column updated</span></span>
<span id="cb515-17"><a href="layers-of-abstraction.html#cb515-17" tabindex="-1"></a>    <span class="fu">)</span></span>
<span id="cb515-18"><a href="layers-of-abstraction.html#cb515-18" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb515-19"><a href="layers-of-abstraction.html#cb515-19" tabindex="-1"></a></span>
<span id="cb515-20"><a href="layers-of-abstraction.html#cb515-20" tabindex="-1"></a>  <span class="kw">defp</span> atom_to_side<span class="fu">(</span><span class="va">:buy</span><span class="fu">)</span>, <span class="va">do:</span> <span class="st">&quot;BUY&quot;</span></span>
<span id="cb515-21"><a href="layers-of-abstraction.html#cb515-21" tabindex="-1"></a>  <span class="kw">defp</span> atom_to_side<span class="fu">(</span><span class="va">:sell</span><span class="fu">)</span>, <span class="va">do:</span> <span class="st">&quot;SELL&quot;</span></span>
<span id="cb515-22"><a href="layers-of-abstraction.html#cb515-22" tabindex="-1"></a></span>
<span id="cb515-23"><a href="layers-of-abstraction.html#cb515-23" tabindex="-1"></a>  <span class="kw">defp</span> atom_to_status<span class="fu">(</span><span class="va">:new</span><span class="fu">)</span>, <span class="va">do:</span> <span class="st">&quot;NEW&quot;</span></span>
<span id="cb515-24"><a href="layers-of-abstraction.html#cb515-24" tabindex="-1"></a>  <span class="kw">defp</span> atom_to_status<span class="fu">(</span><span class="va">:filled</span><span class="fu">)</span>, <span class="va">do:</span> <span class="st">&quot;FILLED&quot;</span></span></code></pre></div>
<p>The <code>Worker</code> will now pattern matches on the <code>Core.Exchange.Order</code> struct instead of <code>Binance.Order</code> as before. Inside the callback, we simplified the mapping to the schema struct and updated the conflict to the renamed <code>id</code> column. Finally, we added the helper functions to convert <code>status</code> and <code>side</code> atoms to strings.</p>
</div>
<div id="the-mox-approach-summary" class="section level3 hasAnchor" number="21.3.8">
<h3><span class="header-section-number">21.3.8</span> The <code>Mox</code> approach summary<a href="layers-of-abstraction.html#the-mox-approach-summary" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We didn’t yet look into updating our tests, but instead of focusing on that, we will chat about our implementation.</p>
<p>First, it’s worth stressing that it required multiple changes to many parts of the system spanning from the <code>Naive</code> application through <code>Streamer</code> (seeding) and ending in the <code>DataWarehouse</code> application.</p>
<p>More importantly, we needed to define a behaviour. It gives us a compile-time guarantee, but on the other hand, we were pushed to define it very early.</p>
<p>Let me explain.</p>
<p>Up to this moment, we have been using only the <code>Binance</code> module. We didn’t have an opportunity to work with other modules/exchanges. In fact, we <strong>didn’t want to</strong> create an <code>Exchange</code> level abstraction. We were happy with using the <code>Binance</code> module, and we added the behaviour just to be able to use the <code>Mox</code> package to mock it inside our tests. All of this feels like a really heavy over-engineering just to be able to test.</p>
<p>Furthermore, as we defined the behaviour, we needed to define the generic structs that we based on the ones from the <code>Binance</code> module. We have never seen examples of structs from other packages, so we took only fields that we are using in our strategy to limit the possibility of missing data from another exchange in the future. The knock-on effect will be that we are already missing valuable data in the database as well as adding any new exchanges in the future may require updates to the behaviour, behaviour’s existing implementations and most of the code that uses it (like the <code>Naive.Strategy</code>).</p>
<p>Additionally, we returned the <code>Binance</code>’s error messages straight to the user of our abstraction(<code>Naive.Strategy</code>). We should be converting those to generic errors, but we don’t have a clue about other exchanges and the errors they could raise.</p>
<p>At this moment, abstracting our code into behaviour+implementations is uneducated over-engineering and simply asking for troubles in the future.</p>
<p>What’s the alternative?</p>
<p>The first thing that comes to mind would be to look for some “standard” that could be leveraged to build our behaviour/define structs. For cryptocurrency exchanges, that will be “CCXT” - it’s an open-source “library” available for Python, JavaScript and PHP.</p>
<p>We could look further and look for an Elixir implementation of the CCXT package and find the package named <code>ccxtex</code>. It’s a wrapper around the JavaScript version of the CCXT package.</p>
<p>Using the above(either the <code>ccxtex</code> package or <code>ccxt</code> as a “blueprint”) instead of trying to figure out our own behaviour based on our limited knowledge about exchanges would most certainly let us avoid continuous updates to our code.</p>
<p>Those updates, coupled with the fact that we would add the behaviour just to be able to test the implementation, put usage of the <code>Mox</code> package in serious doubt.</p>
<p>The source code up to this moment can be found at <a href="https://github.com/Cinderella-Man/hands-on-elixir-and-otp-cryptocurrency-trading-bot-source-code/tree/chapter_21_mox">Github</a></p>
<p>We will stop here and <strong>revert</strong> to the source code from the end of the <a href="https://github.com/Cinderella-Man/hands-on-elixir-and-otp-cryptocurrency-trading-bot-source-code/tree/chapter_20">20th chapter</a>. Instead of leaving something we are not prepared to continue with, we will look into alternative ways to test our strategy.</p>
</div>
</div>
<div id="mimicking-the-reality" class="section level2 hasAnchor" number="21.4">
<h2><span class="header-section-number">21.4</span> Mimicking the reality<a href="layers-of-abstraction.html#mimicking-the-reality" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In this section, we will look into using the <code>Mimic</code> package to mock the <code>Binance</code> module to test our <code>Naive.Strategy</code>. The advantage of using the <code>Mimic</code> package is that we don’t need to define behaviours to mock our modules.</p>
<p>Let’s kick this off by swapping the <code>mox</code> package to the <code>mimic</code> package in the dependencies of the <code>Naive</code> application:</p>
<div class="sourceCode" id="cb516"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb516-1"><a href="layers-of-abstraction.html#cb516-1" tabindex="-1"></a>  <span class="co"># /apps/naive/mix.exs</span></span>
<span id="cb516-2"><a href="layers-of-abstraction.html#cb516-2" tabindex="-1"></a>  <span class="kw">defp</span> deps <span class="kw">do</span></span>
<span id="cb516-3"><a href="layers-of-abstraction.html#cb516-3" tabindex="-1"></a>    <span class="ot">[</span></span>
<span id="cb516-4"><a href="layers-of-abstraction.html#cb516-4" tabindex="-1"></a>      <span class="op">...</span></span>
<span id="cb516-5"><a href="layers-of-abstraction.html#cb516-5" tabindex="-1"></a>      <span class="fu">{</span><span class="va">:mimic</span>, <span class="st">&quot;~&gt; 1.7&quot;</span>, <span class="va">only:</span> <span class="ot">[</span><span class="va">:test</span>, <span class="va">:integration</span><span class="ot">]</span><span class="fu">}</span>,</span>
<span id="cb516-6"><a href="layers-of-abstraction.html#cb516-6" tabindex="-1"></a>      <span class="op">...</span></span>
<span id="cb516-7"><a href="layers-of-abstraction.html#cb516-7" tabindex="-1"></a>    <span class="ot">]</span></span>
<span id="cb516-8"><a href="layers-of-abstraction.html#cb516-8" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>Don’t forget to run <code>mix deps.get</code> to resolve the dependencies.</p>
<div id="updating-the-naive.strategy-1" class="section level3 hasAnchor" number="21.4.1">
<h3><span class="header-section-number">21.4.1</span> Updating the <code>Naive.Strategy</code><a href="layers-of-abstraction.html#updating-the-naive.strategy-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Before we dive into writing new tests, we can update the <code>Naive.Strategy</code> module. The <code>mimic</code> module doesn’t require us to inject dependencies into module attributes based on config, so we can remove them:</p>
<div class="sourceCode" id="cb517"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb517-1"><a href="layers-of-abstraction.html#cb517-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/strategy.ex</span></span>
<span id="cb517-2"><a href="layers-of-abstraction.html#cb517-2" tabindex="-1"></a>  <span class="co"># remove the below lines</span></span>
<span id="cb517-3"><a href="layers-of-abstraction.html#cb517-3" tabindex="-1"></a>  <span class="ot">@binance_client</span> <span class="cn">Application</span><span class="op">.</span>compile_env<span class="fu">(</span><span class="va">:naive</span>, <span class="va">:binance_client</span><span class="fu">)</span></span>
<span id="cb517-4"><a href="layers-of-abstraction.html#cb517-4" tabindex="-1"></a>  <span class="ot">@logger</span> <span class="cn">Application</span><span class="op">.</span>compile_env<span class="fu">(</span><span class="va">:core</span>, <span class="va">:logger</span><span class="fu">)</span></span>
<span id="cb517-5"><a href="layers-of-abstraction.html#cb517-5" tabindex="-1"></a>  <span class="ot">@pubsub_client</span> <span class="cn">Application</span><span class="op">.</span>compile_env<span class="fu">(</span><span class="va">:core</span>, <span class="va">:pubsub_client</span><span class="fu">)</span></span>
<span id="cb517-6"><a href="layers-of-abstraction.html#cb517-6" tabindex="-1"></a>  <span class="ot">@repo</span> <span class="cn">Application</span><span class="op">.</span>compile_env<span class="fu">(</span><span class="va">:naive</span>, <span class="va">:repo</span><span class="fu">)</span></span></code></pre></div>
<p>We will switch back to using modules’ names as before. We will update all references to attributes throughout the module with corresponding hardcoded module names:</p>
<div class="sourceCode" id="cb518"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb518-1"><a href="layers-of-abstraction.html#cb518-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/strategy.ex</span></span>
<span id="cb518-2"><a href="layers-of-abstraction.html#cb518-2" tabindex="-1"></a><span class="co"># change @logger to Logger</span></span>
<span id="cb518-3"><a href="layers-of-abstraction.html#cb518-3" tabindex="-1"></a><span class="co"># change @binance_client to Binance</span></span>
<span id="cb518-4"><a href="layers-of-abstraction.html#cb518-4" tabindex="-1"></a><span class="co"># change @pubsub_client to Phoenix.PubSub</span></span>
<span id="cb518-5"><a href="layers-of-abstraction.html#cb518-5" tabindex="-1"></a><span class="co"># change @repo to Repo</span></span></code></pre></div>
<p>As we are pointing to <code>Repo</code> instead of <code>Naive.Repo</code>, we need to add an alias at the top of the module:</p>
<div class="sourceCode" id="cb519"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb519-1"><a href="layers-of-abstraction.html#cb519-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/strategy.ex</span></span>
<span id="cb519-2"><a href="layers-of-abstraction.html#cb519-2" tabindex="-1"></a><span class="im">alias</span> <span class="cn">Naive</span><span class="op">.</span><span class="cn">Repo</span></span></code></pre></div>
<p>That finishes our conversion to hardcoded module names. As we are no longer basing our module on the configuration, we can remove all redundant configuration keys from the main <code>config.exs</code> file:</p>
<div class="sourceCode" id="cb520"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb520-1"><a href="layers-of-abstraction.html#cb520-1" tabindex="-1"></a><span class="co"># /config/config.exs</span></span>
<span id="cb520-2"><a href="layers-of-abstraction.html#cb520-2" tabindex="-1"></a>config <span class="va">:core</span>,                   <span class="co"># &lt;= remove</span></span>
<span id="cb520-3"><a href="layers-of-abstraction.html#cb520-3" tabindex="-1"></a>  <span class="va">logger:</span> <span class="cn">Logger</span>,               <span class="co"># &lt;= remove</span></span>
<span id="cb520-4"><a href="layers-of-abstraction.html#cb520-4" tabindex="-1"></a>  <span class="va">pubsub_client:</span> <span class="cn">Phoenix</span><span class="op">.</span><span class="cn">PubSub</span> <span class="co"># &lt;= remove</span></span>
<span id="cb520-5"><a href="layers-of-abstraction.html#cb520-5" tabindex="-1"></a></span>
<span id="cb520-6"><a href="layers-of-abstraction.html#cb520-6" tabindex="-1"></a>config <span class="va">:streamer</span>,</span>
<span id="cb520-7"><a href="layers-of-abstraction.html#cb520-7" tabindex="-1"></a>  <span class="va">binance_client:</span> <span class="cn">BinanceMock</span>,  <span class="co"># &lt;= remove</span></span>
<span id="cb520-8"><a href="layers-of-abstraction.html#cb520-8" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb520-9"><a href="layers-of-abstraction.html#cb520-9" tabindex="-1"></a></span>
<span id="cb520-10"><a href="layers-of-abstraction.html#cb520-10" tabindex="-1"></a>config <span class="va">:naive</span>,</span>
<span id="cb520-11"><a href="layers-of-abstraction.html#cb520-11" tabindex="-1"></a>  <span class="va">binance_client:</span> <span class="cn">BinanceMock</span>,  <span class="co"># &lt;= remove</span></span>
<span id="cb520-12"><a href="layers-of-abstraction.html#cb520-12" tabindex="-1"></a>  <span class="va">repo:</span> <span class="cn">Naive</span><span class="op">.</span><span class="cn">Repo</span>,             <span class="co"># &lt;= remove</span></span>
<span id="cb520-13"><a href="layers-of-abstraction.html#cb520-13" tabindex="-1"></a>  <span class="op">...</span></span></code></pre></div>
<p>We can now move on to figure out how we are going to test it.</p>
</div>
<div id="testing-the-naive.strategy" class="section level3 hasAnchor" number="21.4.2">
<h3><span class="header-section-number">21.4.2</span> Testing the <code>Naive.Strategy</code><a href="layers-of-abstraction.html#testing-the-naive.strategy" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>First, we can remove the existing unit tests(<code>apps/naive/test/naive/trader_test.exs</code>) as they are not applicable anymore.</p>
<p>Next, we will create a new file <code>apps/naive/test/naive/strategy_test.exs</code> with a skeleton of a test:</p>
<div class="sourceCode" id="cb521"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb521-1"><a href="layers-of-abstraction.html#cb521-1" tabindex="-1"></a><span class="co"># /apps/naive/test/naive/strategy_test.exs</span></span>
<span id="cb521-2"><a href="layers-of-abstraction.html#cb521-2" tabindex="-1"></a><span class="kw">defmodule</span> <span class="cn">Naive</span><span class="op">.</span><span class="cn">StrategyTest</span> <span class="kw">do</span></span>
<span id="cb521-3"><a href="layers-of-abstraction.html#cb521-3" tabindex="-1"></a>  <span class="im">use</span> <span class="cn">ExUnit</span><span class="op">.</span><span class="cn">Case</span>, <span class="va">async:</span> <span class="cn">true</span></span>
<span id="cb521-4"><a href="layers-of-abstraction.html#cb521-4" tabindex="-1"></a>  <span class="im">use</span> <span class="cn">Mimic</span></span>
<span id="cb521-5"><a href="layers-of-abstraction.html#cb521-5" tabindex="-1"></a></span>
<span id="cb521-6"><a href="layers-of-abstraction.html#cb521-6" tabindex="-1"></a>  <span class="im">alias</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">Struct</span><span class="op">.</span><span class="cn">TradeEvent</span></span>
<span id="cb521-7"><a href="layers-of-abstraction.html#cb521-7" tabindex="-1"></a>  <span class="im">alias</span> <span class="cn">Naive</span><span class="op">.</span><span class="cn">Strategy</span></span>
<span id="cb521-8"><a href="layers-of-abstraction.html#cb521-8" tabindex="-1"></a></span>
<span id="cb521-9"><a href="layers-of-abstraction.html#cb521-9" tabindex="-1"></a>  <span class="co"># we will add our tests here</span></span>
<span id="cb521-10"><a href="layers-of-abstraction.html#cb521-10" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<p>As we will stub dependencies using <code>mimic</code>, we need to <code>use</code> it inside the test module.</p>
<div style="page-break-after: always;"></div>
<p>We will be testing the primary entry function, the <code>Naive.Strategy.execute/3</code>, where we will first focus on placing a buy order scenario:</p>
<div class="sourceCode" id="cb522"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb522-1"><a href="layers-of-abstraction.html#cb522-1" tabindex="-1"></a><span class="co"># /apps/naive/test/naive/strategy_test.exs</span></span>
<span id="cb522-2"><a href="layers-of-abstraction.html#cb522-2" tabindex="-1"></a>  <span class="ot">@tag</span> <span class="va">:unit</span></span>
<span id="cb522-3"><a href="layers-of-abstraction.html#cb522-3" tabindex="-1"></a>  test <span class="st">&quot;Strategy places a buy order&quot;</span> <span class="kw">do</span></span>
<span id="cb522-4"><a href="layers-of-abstraction.html#cb522-4" tabindex="-1"></a>    <span class="co"># we will put our code here</span></span>
<span id="cb522-5"><a href="layers-of-abstraction.html#cb522-5" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>The simplest scenario will be to pass hardcoded settings, a fresh position(based on those settings) and a trade event(that will trigger the buy order):</p>
<div class="sourceCode" id="cb523"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb523-1"><a href="layers-of-abstraction.html#cb523-1" tabindex="-1"></a><span class="co"># /apps/naive/test/naive/strategy_test.exs</span></span>
<span id="cb523-2"><a href="layers-of-abstraction.html#cb523-2" tabindex="-1"></a>  settings <span class="op">=</span> %<span class="fu">{</span></span>
<span id="cb523-3"><a href="layers-of-abstraction.html#cb523-3" tabindex="-1"></a>    <span class="va">symbol:</span> <span class="st">&quot;ABC&quot;</span>,   </span>
<span id="cb523-4"><a href="layers-of-abstraction.html#cb523-4" tabindex="-1"></a>    <span class="va">chunks:</span> <span class="st">&quot;5&quot;</span>,     </span>
<span id="cb523-5"><a href="layers-of-abstraction.html#cb523-5" tabindex="-1"></a>    <span class="va">budget:</span> <span class="st">&quot;200&quot;</span>,   </span>
<span id="cb523-6"><a href="layers-of-abstraction.html#cb523-6" tabindex="-1"></a>    <span class="va">buy_down_interval:</span> <span class="st">&quot;0.2&quot;</span>,</span>
<span id="cb523-7"><a href="layers-of-abstraction.html#cb523-7" tabindex="-1"></a>    <span class="va">profit_interval:</span> <span class="st">&quot;0.1&quot;</span>,</span>
<span id="cb523-8"><a href="layers-of-abstraction.html#cb523-8" tabindex="-1"></a>    <span class="va">rebuy_interval:</span> <span class="st">&quot;0.5&quot;</span>,</span>
<span id="cb523-9"><a href="layers-of-abstraction.html#cb523-9" tabindex="-1"></a>    <span class="va">tick_size:</span> <span class="st">&quot;0.000001&quot;</span>,</span>
<span id="cb523-10"><a href="layers-of-abstraction.html#cb523-10" tabindex="-1"></a>    <span class="va">step_size:</span> <span class="st">&quot;0.001&quot;</span>,</span>
<span id="cb523-11"><a href="layers-of-abstraction.html#cb523-11" tabindex="-1"></a>    <span class="va">status:</span> <span class="va">:on</span></span>
<span id="cb523-12"><a href="layers-of-abstraction.html#cb523-12" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb523-13"><a href="layers-of-abstraction.html#cb523-13" tabindex="-1"></a></span>
<span id="cb523-14"><a href="layers-of-abstraction.html#cb523-14" tabindex="-1"></a>  <span class="fu">{</span><span class="va">:ok</span>, new_positions<span class="fu">}</span> <span class="op">=</span> <span class="cn">Naive</span><span class="op">.</span><span class="cn">Strategy</span><span class="op">.</span>execute<span class="fu">(</span></span>
<span id="cb523-15"><a href="layers-of-abstraction.html#cb523-15" tabindex="-1"></a>    %<span class="cn">TradeEvent</span><span class="fu">{</span></span>
<span id="cb523-16"><a href="layers-of-abstraction.html#cb523-16" tabindex="-1"></a>      <span class="va">price:</span> <span class="st">&quot;1.00000&quot;</span></span>
<span id="cb523-17"><a href="layers-of-abstraction.html#cb523-17" tabindex="-1"></a>    <span class="fu">}</span>,</span>
<span id="cb523-18"><a href="layers-of-abstraction.html#cb523-18" tabindex="-1"></a>    <span class="ot">[</span></span>
<span id="cb523-19"><a href="layers-of-abstraction.html#cb523-19" tabindex="-1"></a>      <span class="cn">Strategy</span><span class="op">.</span>generate_fresh_position<span class="fu">(</span>settings<span class="fu">)</span></span>
<span id="cb523-20"><a href="layers-of-abstraction.html#cb523-20" tabindex="-1"></a>    <span class="ot">]</span>,</span>
<span id="cb523-21"><a href="layers-of-abstraction.html#cb523-21" tabindex="-1"></a>    settings</span>
<span id="cb523-22"><a href="layers-of-abstraction.html#cb523-22" tabindex="-1"></a>  <span class="fu">)</span></span></code></pre></div>
<p>Now, the above call to the <code>Naive.Strategy.execute/3</code> will cause the <code>Binance.order_limit_buy/4</code>, <code>Phoenix.PubSub.brodcast/3</code> and <code>Logger.info/1</code>(we will skip this one and get back to it later) functions to be called. We need to mock those functions at the beginning of our test before calling the <code>Naive.Strategy.execute/3</code> function:</p>
<div class="sourceCode" id="cb524"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb524-1"><a href="layers-of-abstraction.html#cb524-1" tabindex="-1"></a><span class="co"># /apps/naive/test/naive/strategy_test.exs</span></span>
<span id="cb524-2"><a href="layers-of-abstraction.html#cb524-2" tabindex="-1"></a>  expected_order <span class="op">=</span> %<span class="cn">Binance</span><span class="op">.</span><span class="cn">OrderResponse</span><span class="fu">{</span> </span>
<span id="cb524-3"><a href="layers-of-abstraction.html#cb524-3" tabindex="-1"></a>    <span class="va">client_order_id:</span> <span class="st">&quot;1&quot;</span>, </span>
<span id="cb524-4"><a href="layers-of-abstraction.html#cb524-4" tabindex="-1"></a>    <span class="va">executed_qty:</span> <span class="st">&quot;0.000&quot;</span>, </span>
<span id="cb524-5"><a href="layers-of-abstraction.html#cb524-5" tabindex="-1"></a>    <span class="va">order_id:</span> <span class="st">&quot;x1&quot;</span>, </span>
<span id="cb524-6"><a href="layers-of-abstraction.html#cb524-6" tabindex="-1"></a>    <span class="va">orig_qty:</span> <span class="st">&quot;50.000&quot;</span>, </span>
<span id="cb524-7"><a href="layers-of-abstraction.html#cb524-7" tabindex="-1"></a>    <span class="va">price:</span> <span class="st">&quot;0.800000&quot;</span>, </span>
<span id="cb524-8"><a href="layers-of-abstraction.html#cb524-8" tabindex="-1"></a>    <span class="va">side:</span> <span class="st">&quot;BUY&quot;</span>, </span>
<span id="cb524-9"><a href="layers-of-abstraction.html#cb524-9" tabindex="-1"></a>    <span class="va">status:</span> <span class="st">&quot;NEW&quot;</span>, </span>
<span id="cb524-10"><a href="layers-of-abstraction.html#cb524-10" tabindex="-1"></a>    <span class="va">symbol:</span> <span class="st">&quot;ABC&quot;</span></span>
<span id="cb524-11"><a href="layers-of-abstraction.html#cb524-11" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb524-12"><a href="layers-of-abstraction.html#cb524-12" tabindex="-1"></a> </span>
<span id="cb524-13"><a href="layers-of-abstraction.html#cb524-13" tabindex="-1"></a>  <span class="cn">Binance</span></span>
<span id="cb524-14"><a href="layers-of-abstraction.html#cb524-14" tabindex="-1"></a>  <span class="op">|&gt;</span> stub<span class="fu">(</span></span>
<span id="cb524-15"><a href="layers-of-abstraction.html#cb524-15" tabindex="-1"></a>    <span class="va">:order_limit_buy</span>,</span>
<span id="cb524-16"><a href="layers-of-abstraction.html#cb524-16" tabindex="-1"></a>    <span class="kw">fn</span> <span class="st">&quot;ABC&quot;</span>, <span class="st">&quot;50.000&quot;</span>, <span class="st">&quot;0.800000&quot;</span>, <span class="st">&quot;GTC&quot;</span> <span class="op">-&gt;</span> <span class="fu">{</span><span class="va">:ok</span>, expected_order<span class="fu">}</span> <span class="kw">end</span>   </span>
<span id="cb524-17"><a href="layers-of-abstraction.html#cb524-17" tabindex="-1"></a>  <span class="fu">)</span></span>
<span id="cb524-18"><a href="layers-of-abstraction.html#cb524-18" tabindex="-1"></a></span>
<span id="cb524-19"><a href="layers-of-abstraction.html#cb524-19" tabindex="-1"></a>  <span class="cn">Phoenix</span><span class="op">.</span><span class="cn">PubSub</span></span>
<span id="cb524-20"><a href="layers-of-abstraction.html#cb524-20" tabindex="-1"></a>  <span class="op">|&gt;</span> stub<span class="fu">(</span></span>
<span id="cb524-21"><a href="layers-of-abstraction.html#cb524-21" tabindex="-1"></a>    <span class="va">:broadcast</span>,</span>
<span id="cb524-22"><a href="layers-of-abstraction.html#cb524-22" tabindex="-1"></a>    <span class="kw">fn</span> _pubsub, _topic, _message <span class="op">-&gt;</span> <span class="va">:ok</span> <span class="kw">end</span></span>
<span id="cb524-23"><a href="layers-of-abstraction.html#cb524-23" tabindex="-1"></a>  <span class="fu">)</span></span></code></pre></div>
<p>We can use the <code>expected_order</code> above to assert that the <code>Naive.Strategy.execute/3</code> returned the correct value - the <code>buy_order</code> field should hold the same data as the <code>expected_order</code>. We can add the below assertions at the end of the test:</p>
<div class="sourceCode" id="cb525"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb525-1"><a href="layers-of-abstraction.html#cb525-1" tabindex="-1"></a><span class="co"># /apps/naive/test/naive/strategy_test.exs</span></span>
<span id="cb525-2"><a href="layers-of-abstraction.html#cb525-2" tabindex="-1"></a>    assert <span class="fu">(</span>length new_positions<span class="fu">)</span> <span class="op">==</span> <span class="dv">1</span></span>
<span id="cb525-3"><a href="layers-of-abstraction.html#cb525-3" tabindex="-1"></a></span>
<span id="cb525-4"><a href="layers-of-abstraction.html#cb525-4" tabindex="-1"></a>    %<span class="fu">{</span><span class="va">buy_order:</span> buy_order<span class="fu">}</span> <span class="op">=</span> <span class="cn">List</span><span class="op">.</span>first<span class="fu">(</span>new_positions<span class="fu">)</span></span>
<span id="cb525-5"><a href="layers-of-abstraction.html#cb525-5" tabindex="-1"></a>    assert buy_order <span class="op">==</span> expected_order</span></code></pre></div>
<p>That finishes the test implementation, but before we will be able to use the <code>mimic</code> module, we need to prepare modules so we can stub them inside tests - here are the new contents of the test helper file:</p>
<div class="sourceCode" id="cb526"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb526-1"><a href="layers-of-abstraction.html#cb526-1" tabindex="-1"></a><span class="co"># /apps/naive/test/test_helper.exs</span></span>
<span id="cb526-2"><a href="layers-of-abstraction.html#cb526-2" tabindex="-1"></a><span class="cn">Application</span><span class="op">.</span>ensure_all_started<span class="fu">(</span><span class="va">:mimic</span><span class="fu">)</span></span>
<span id="cb526-3"><a href="layers-of-abstraction.html#cb526-3" tabindex="-1"></a></span>
<span id="cb526-4"><a href="layers-of-abstraction.html#cb526-4" tabindex="-1"></a><span class="cn">Mimic</span><span class="op">.</span>copy<span class="fu">(</span><span class="cn">Binance</span><span class="fu">)</span></span>
<span id="cb526-5"><a href="layers-of-abstraction.html#cb526-5" tabindex="-1"></a><span class="cn">Mimic</span><span class="op">.</span>copy<span class="fu">(</span><span class="cn">Phoenix</span><span class="op">.</span><span class="cn">PubSub</span><span class="fu">)</span></span>
<span id="cb526-6"><a href="layers-of-abstraction.html#cb526-6" tabindex="-1"></a></span>
<span id="cb526-7"><a href="layers-of-abstraction.html#cb526-7" tabindex="-1"></a><span class="cn">ExUnit</span><span class="op">.</span>start<span class="fu">()</span></span></code></pre></div>
<p>We removed all references to the <code>mox</code> module and replaced them with calls to the <code>Mimic.copy/1</code> function.</p>
<div style="page-break-after: always;"></div>
<p>We are now ready to run our new test:</p>
<div class="sourceCode" id="cb527"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb527-1"><a href="layers-of-abstraction.html#cb527-1" tabindex="-1"></a><span class="ex">$</span> mix test.unit</span>
<span id="cb527-2"><a href="layers-of-abstraction.html#cb527-2" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb527-3"><a href="layers-of-abstraction.html#cb527-3" tabindex="-1"></a><span class="ex">21:49:39.737</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span> Position <span class="er">(</span><span class="ex">ABC/1675460979732</span><span class="kw">)</span><span class="bu">:</span> Placing a BUY order @ 0.800000,</span>
<span id="cb527-4"><a href="layers-of-abstraction.html#cb527-4" tabindex="-1"></a><span class="ex">quantity:</span> 50.000</span>
<span id="cb527-5"><a href="layers-of-abstraction.html#cb527-5" tabindex="-1"></a><span class="bu">.</span></span>
<span id="cb527-6"><a href="layers-of-abstraction.html#cb527-6" tabindex="-1"></a><span class="ex">Finished</span> in 0.2 seconds <span class="er">(</span><span class="ex">0.2s</span> async, 0.00s sync<span class="kw">)</span></span>
<span id="cb527-7"><a href="layers-of-abstraction.html#cb527-7" tabindex="-1"></a><span class="ex">2</span> tests, 0 failures, 1 excluded</span></code></pre></div>
<p>As we can see, we successfully mocked the <code>Binance</code> and <code>Phoenix.PubSub</code> modules. We can also see that we are getting log messages that we will deal with next.</p>
</div>
<div id="logging-elephant-in-the-room" class="section level3 hasAnchor" number="21.4.3">
<h3><span class="header-section-number">21.4.3</span> Logging elephant in the room<a href="layers-of-abstraction.html#logging-elephant-in-the-room" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As we moved back to using the <code>Logger</code> module instead of some dummy implementation, we are now back to square one, seeing logs in our tests. We could go on the route of mocking the <code>Logger</code> module using the <code>Mimic</code>, but actually, there’s a better way to deal with logs in the tests.</p>
<p>As ExUnit starts, it allows us to pass options that will modify its behaviour. One of those is <code>capture_log</code>, which, when set to <code>true</code>, will cause ExUnit to hide all log messages - let’s update the test helper script to enable this feature:</p>
<div class="sourceCode" id="cb528"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb528-1"><a href="layers-of-abstraction.html#cb528-1" tabindex="-1"></a><span class="co"># /apps/naive/test/test_helper.exs</span></span>
<span id="cb528-2"><a href="layers-of-abstraction.html#cb528-2" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb528-3"><a href="layers-of-abstraction.html#cb528-3" tabindex="-1"></a><span class="cn">ExUnit</span><span class="op">.</span>start<span class="fu">(</span><span class="va">capture_log:</span> <span class="cn">true</span><span class="fu">)</span></span></code></pre></div>
<p>Let’s rerun our tests to see the difference:</p>
<div class="sourceCode" id="cb529"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb529-1"><a href="layers-of-abstraction.html#cb529-1" tabindex="-1"></a><span class="ex">$</span> mix test.unit</span>
<span id="cb529-2"><a href="layers-of-abstraction.html#cb529-2" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb529-3"><a href="layers-of-abstraction.html#cb529-3" tabindex="-1"></a><span class="bu">.</span></span>
<span id="cb529-4"><a href="layers-of-abstraction.html#cb529-4" tabindex="-1"></a><span class="ex">Finished</span> in 0.2 seconds <span class="er">(</span><span class="ex">0.2s</span> async, 0.00s sync<span class="kw">)</span></span>
<span id="cb529-5"><a href="layers-of-abstraction.html#cb529-5" tabindex="-1"></a><span class="ex">2</span> tests, 0 failures, 1 excluded</span></code></pre></div>
<p>We can see that the ExUnit output is now free of any logs.</p>
<p>But what if we would like to assert the logged message? We were able to do that using the <code>mox</code> package, as we were mocking and asserting log messages’ contents inside those mocks.</p>
<p>ExUnit provides a helper function for that case as well. We will modify our test to capture the log inside it and assert that it logs the correct value (the price of $0.8):</p>
<div class="sourceCode" id="cb530"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb530-1"><a href="layers-of-abstraction.html#cb530-1" tabindex="-1"></a><span class="co"># /apps/naive/test/naive/strategy_test.exs</span></span>
<span id="cb530-2"><a href="layers-of-abstraction.html#cb530-2" tabindex="-1"></a>  <span class="im">import</span> <span class="cn">ExUnit</span><span class="op">.</span><span class="cn">CaptureLog</span> <span class="co"># &lt;= import logging capturing functionality</span></span>
<span id="cb530-3"><a href="layers-of-abstraction.html#cb530-3" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb530-4"><a href="layers-of-abstraction.html#cb530-4" tabindex="-1"></a>  test <span class="st">&quot;Strategy places a buy order&quot;</span> <span class="kw">do</span></span>
<span id="cb530-5"><a href="layers-of-abstraction.html#cb530-5" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb530-6"><a href="layers-of-abstraction.html#cb530-6" tabindex="-1"></a>    <span class="fu">{{</span><span class="va">:ok</span>, new_positions<span class="fu">}</span>, log<span class="fu">}</span> <span class="op">=</span></span>
<span id="cb530-7"><a href="layers-of-abstraction.html#cb530-7" tabindex="-1"></a>      with_log<span class="fu">(</span><span class="kw">fn</span> <span class="op">-&gt;</span></span>
<span id="cb530-8"><a href="layers-of-abstraction.html#cb530-8" tabindex="-1"></a>        <span class="cn">Naive</span><span class="op">.</span><span class="cn">Strategy</span><span class="op">.</span>execute<span class="fu">(</span></span>
<span id="cb530-9"><a href="layers-of-abstraction.html#cb530-9" tabindex="-1"></a>          %<span class="cn">TradeEvent</span><span class="fu">{</span></span>
<span id="cb530-10"><a href="layers-of-abstraction.html#cb530-10" tabindex="-1"></a>            <span class="va">price:</span> <span class="st">&quot;1.00000&quot;</span></span>
<span id="cb530-11"><a href="layers-of-abstraction.html#cb530-11" tabindex="-1"></a>          <span class="fu">}</span>,</span>
<span id="cb530-12"><a href="layers-of-abstraction.html#cb530-12" tabindex="-1"></a>          <span class="ot">[</span></span>
<span id="cb530-13"><a href="layers-of-abstraction.html#cb530-13" tabindex="-1"></a>            <span class="cn">Strategy</span><span class="op">.</span>generate_fresh_position<span class="fu">(</span>settings<span class="fu">)</span></span>
<span id="cb530-14"><a href="layers-of-abstraction.html#cb530-14" tabindex="-1"></a>          <span class="ot">]</span>,</span>
<span id="cb530-15"><a href="layers-of-abstraction.html#cb530-15" tabindex="-1"></a>          settings</span>
<span id="cb530-16"><a href="layers-of-abstraction.html#cb530-16" tabindex="-1"></a>        <span class="fu">)</span></span>
<span id="cb530-17"><a href="layers-of-abstraction.html#cb530-17" tabindex="-1"></a>      <span class="kw">end</span><span class="fu">)</span></span>
<span id="cb530-18"><a href="layers-of-abstraction.html#cb530-18" tabindex="-1"></a></span>
<span id="cb530-19"><a href="layers-of-abstraction.html#cb530-19" tabindex="-1"></a>    assert log <span class="op">=~</span> <span class="st">&quot;0.8&quot;</span></span>
<span id="cb530-20"><a href="layers-of-abstraction.html#cb530-20" tabindex="-1"></a>    <span class="op">...</span></span></code></pre></div>
<p>In the above code, we wrapped our call to the <code>Naive.Strategy.execute/3</code> into an anonymous function that we passed as an argument to the <code>with_log/1</code> function. The <code>with_log/1</code> function returns a tuple containing the result of the passed function and the generated log message(s). We can then assert that the logged message contains the expected value, strengthening our test. We can now rerun our unit test:</p>
<div class="sourceCode" id="cb531"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb531-1"><a href="layers-of-abstraction.html#cb531-1" tabindex="-1"></a><span class="ex">$</span> mix test.unit</span>
<span id="cb531-2"><a href="layers-of-abstraction.html#cb531-2" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb531-3"><a href="layers-of-abstraction.html#cb531-3" tabindex="-1"></a><span class="bu">.</span></span>
<span id="cb531-4"><a href="layers-of-abstraction.html#cb531-4" tabindex="-1"></a><span class="ex">Finished</span> in 0.2 seconds <span class="er">(</span><span class="ex">0.2s</span> async, 0.00s sync<span class="kw">)</span></span>
<span id="cb531-5"><a href="layers-of-abstraction.html#cb531-5" tabindex="-1"></a><span class="ex">2</span> tests, 0 failures, 1 excluded</span></code></pre></div>
<p>It’s worth noting that we were able to capture the log message even with global capture_log enabled(inside the test helper when starting ExUnit). This gives us ultimate flexibility. None of the logs are displayed, although whenever we need, we can always capture logs inside test cases on a test-by-tas basis.</p>
<p>That would wrap up the writing unit tests part. But how will this work with running our code locally(or in “production”) or running integration tests?</p>
</div>
</div>
<div id="swapping-back-to-attributes" class="section level2 hasAnchor" number="21.5">
<h2><span class="header-section-number">21.5</span> Swapping back to attributes<a href="layers-of-abstraction.html#swapping-back-to-attributes" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We need to have a way to swap Binance’s implementation between dev/test/integration and prod environments.</p>
<p>We can’t use the <code>mimic</code> package to swap the implementation as this is a “running” mode, not some tests.</p>
<p>Please note that most of the applications won’t need to change the implementation based on the environment as the 3rd party library/package itself will provide some flags to enable/disable the functionality(like sending emails to newly registered users).</p>
<div style="page-break-after: always;"></div>
<p>Let’s get back to the <code>Naive.Strategy</code> module, where we will bring back the attribute-based <code>@binance_client</code>:</p>
<div class="sourceCode" id="cb532"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb532-1"><a href="layers-of-abstraction.html#cb532-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/strategy.ex</span></span>
<span id="cb532-2"><a href="layers-of-abstraction.html#cb532-2" tabindex="-1"></a>  <span class="ot">@binance_client</span> <span class="cn">Application</span><span class="op">.</span>compile_env<span class="fu">(</span><span class="va">:naive</span>, <span class="va">:binance_client</span><span class="fu">)</span></span>
<span id="cb532-3"><a href="layers-of-abstraction.html#cb532-3" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb532-4"><a href="layers-of-abstraction.html#cb532-4" tabindex="-1"></a>  <span class="ot">@binance_client</span><span class="op">.</span>order_limit_buy<span class="fu">(</span><span class="op">...</span><span class="fu">)</span></span>
<span id="cb532-5"><a href="layers-of-abstraction.html#cb532-5" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb532-6"><a href="layers-of-abstraction.html#cb532-6" tabindex="-1"></a>  <span class="ot">@binance_client</span><span class="op">.</span>order_limit_sell<span class="fu">(</span><span class="op">...</span><span class="fu">)</span></span>
<span id="cb532-7"><a href="layers-of-abstraction.html#cb532-7" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb532-8"><a href="layers-of-abstraction.html#cb532-8" tabindex="-1"></a>  <span class="ot">@binance_client</span><span class="op">.</span>get_order<span class="fu">(</span><span class="op">...</span><span class="fu">)</span></span>
<span id="cb532-9"><a href="layers-of-abstraction.html#cb532-9" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb532-10"><a href="layers-of-abstraction.html#cb532-10" tabindex="-1"></a>  <span class="ot">@binance_client</span><span class="op">.</span>get_order<span class="fu">(</span><span class="op">...</span><span class="fu">)</span></span>
<span id="cb532-11"><a href="layers-of-abstraction.html#cb532-11" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb532-12"><a href="layers-of-abstraction.html#cb532-12" tabindex="-1"></a>  <span class="ot">@binance_client</span><span class="op">.</span>get_exchange_info<span class="fu">(</span><span class="op">...</span><span class="fu">)</span></span></code></pre></div>
<p>We need to update all references to the Binance module’s functions to use the <code>@binance_client</code> module’s attribute.</p>
<p>As we are already modifying the <code>Naive</code> application, we can follow up by removing the <code>@logger</code> and <code>@pubsub_client</code> module’s attributes in the <code>Naive.Trader</code>:</p>
<div class="sourceCode" id="cb533"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb533-1"><a href="layers-of-abstraction.html#cb533-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/trader.ex</span></span>
<span id="cb533-2"><a href="layers-of-abstraction.html#cb533-2" tabindex="-1"></a>  <span class="co"># remove the below attributes</span></span>
<span id="cb533-3"><a href="layers-of-abstraction.html#cb533-3" tabindex="-1"></a>  <span class="ot">@logger</span> <span class="cn">Application</span><span class="op">.</span>compile_env<span class="fu">(</span><span class="va">:core</span>, <span class="va">:logger</span><span class="fu">)</span></span>
<span id="cb533-4"><a href="layers-of-abstraction.html#cb533-4" tabindex="-1"></a>  <span class="ot">@pubsub_client</span> <span class="cn">Application</span><span class="op">.</span>compile_env<span class="fu">(</span><span class="va">:core</span>, <span class="va">:pubsub_client</span><span class="fu">)</span></span>
<span id="cb533-5"><a href="layers-of-abstraction.html#cb533-5" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb533-6"><a href="layers-of-abstraction.html#cb533-6" tabindex="-1"></a>  <span class="co"># change @logger to Logger</span></span>
<span id="cb533-7"><a href="layers-of-abstraction.html#cb533-7" tabindex="-1"></a>  <span class="co"># change @pubsub_client to Phoenix.PubSub</span></span></code></pre></div>
<div id="config-files" class="section level3 hasAnchor" number="21.5.1">
<h3><span class="header-section-number">21.5.1</span> Config files<a href="layers-of-abstraction.html#config-files" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We will now move to config files, where we will re-add the <code>binance_client</code> configuration. As previously we will want the <code>BinanceMock</code> to be used everywhere besides production:</p>
<div class="sourceCode" id="cb534"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb534-1"><a href="layers-of-abstraction.html#cb534-1" tabindex="-1"></a><span class="co"># /config/config.exs</span></span>
<span id="cb534-2"><a href="layers-of-abstraction.html#cb534-2" tabindex="-1"></a>config <span class="va">:streamer</span>,</span>
<span id="cb534-3"><a href="layers-of-abstraction.html#cb534-3" tabindex="-1"></a>  <span class="va">binance_client:</span> <span class="cn">BinanceMock</span> <span class="co"># &lt;= add</span></span>
<span id="cb534-4"><a href="layers-of-abstraction.html#cb534-4" tabindex="-1"></a></span>
<span id="cb534-5"><a href="layers-of-abstraction.html#cb534-5" tabindex="-1"></a>config <span class="va">:naive</span>,</span>
<span id="cb534-6"><a href="layers-of-abstraction.html#cb534-6" tabindex="-1"></a>  <span class="va">binance_client:</span> <span class="cn">BinanceMock</span>,  <span class="co"># &lt;= add</span></span>
<span id="cb534-7"><a href="layers-of-abstraction.html#cb534-7" tabindex="-1"></a>  <span class="va">leader:</span> <span class="cn">Naive</span><span class="op">.</span><span class="cn">Leader</span>,         <span class="co"># &lt;= remove</span></span>
<span id="cb534-8"><a href="layers-of-abstraction.html#cb534-8" tabindex="-1"></a></span>
<span id="cb534-9"><a href="layers-of-abstraction.html#cb534-9" tabindex="-1"></a><span class="co"># /config/prod.exs</span></span>
<span id="cb534-10"><a href="layers-of-abstraction.html#cb534-10" tabindex="-1"></a><span class="co"># stays as it was - pointing to the `Binance` module</span></span>
<span id="cb534-11"><a href="layers-of-abstraction.html#cb534-11" tabindex="-1"></a></span>
<span id="cb534-12"><a href="layers-of-abstraction.html#cb534-12" tabindex="-1"></a><span class="co"># /config/test.exs</span></span>
<span id="cb534-13"><a href="layers-of-abstraction.html#cb534-13" tabindex="-1"></a><span class="co"># remove everything besides the `import`</span></span></code></pre></div>
<p>It’s important to understand that we don’t need to configure the <code>binance_client</code> inside the test configuration. As we now utilise the <code>mimic</code> package, we can drive mocking from the test level.</p>
<p>The knock-on effect of bringing back the environment driven <code>@binance_client</code> is that now we will need to mimic the <code>BinanceMock</code> module instead of <code>Binance</code> for our unit tests. To fix that, we need to update the test helper:</p>
<div class="sourceCode" id="cb535"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb535-1"><a href="layers-of-abstraction.html#cb535-1" tabindex="-1"></a><span class="co"># /apps/naive/test/test_helper.exs</span></span>
<span id="cb535-2"><a href="layers-of-abstraction.html#cb535-2" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb535-3"><a href="layers-of-abstraction.html#cb535-3" tabindex="-1"></a><span class="cn">Mimic</span><span class="op">.</span>copy<span class="fu">(</span><span class="cn">BinanceMock</span><span class="fu">)</span> <span class="co"># &lt;= updated from Binance</span></span></code></pre></div>
<p>and the unit test:</p>
<div class="sourceCode" id="cb536"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb536-1"><a href="layers-of-abstraction.html#cb536-1" tabindex="-1"></a>    <span class="co"># /apps/naive/test/naive/strategy_test.exs</span></span>
<span id="cb536-2"><a href="layers-of-abstraction.html#cb536-2" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb536-3"><a href="layers-of-abstraction.html#cb536-3" tabindex="-1"></a>    <span class="cn">BinanceMock</span> <span class="co"># &lt;= updated from Binance</span></span>
<span id="cb536-4"><a href="layers-of-abstraction.html#cb536-4" tabindex="-1"></a>    <span class="op">|&gt;</span> stub<span class="fu">(</span></span></code></pre></div>
<p>We needed to change the above as now, in the case of dev and integration, we are using the <code>BinanceMock</code>.</p>
<p>After applying the above changes, we can now run the unit tests:</p>
<div class="sourceCode" id="cb537"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb537-1"><a href="layers-of-abstraction.html#cb537-1" tabindex="-1"></a><span class="ex">$</span> mix test.unit</span>
<span id="cb537-2"><a href="layers-of-abstraction.html#cb537-2" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb537-3"><a href="layers-of-abstraction.html#cb537-3" tabindex="-1"></a><span class="bu">.</span></span>
<span id="cb537-4"><a href="layers-of-abstraction.html#cb537-4" tabindex="-1"></a><span class="ex">Finished</span> in 0.2 seconds <span class="er">(</span><span class="ex">0.2s</span> async, 0.00s sync<span class="kw">)</span></span>
<span id="cb537-5"><a href="layers-of-abstraction.html#cb537-5" tabindex="-1"></a><span class="ex">2</span> tests, 0 failures, 1 excluded</span></code></pre></div>
<p>As well as run the integration tests:</p>
<div class="sourceCode" id="cb538"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb538-1"><a href="layers-of-abstraction.html#cb538-1" tabindex="-1"></a><span class="ex">$</span> MIX_ENV=integration mix test.integration</span>
<span id="cb538-2"><a href="layers-of-abstraction.html#cb538-2" tabindex="-1"></a><span class="bu">.</span></span>
<span id="cb538-3"><a href="layers-of-abstraction.html#cb538-3" tabindex="-1"></a><span class="ex">Finished</span> in 7.2 seconds <span class="er">(</span><span class="ex">0.04s</span> async, 7.1s sync<span class="kw">)</span></span>
<span id="cb538-4"><a href="layers-of-abstraction.html#cb538-4" tabindex="-1"></a><span class="ex">2</span> tests, 0 failures, 1 excluded</span></code></pre></div>
<p>And finally, we are able to run the project:</p>
<div class="sourceCode" id="cb539"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb539-1"><a href="layers-of-abstraction.html#cb539-1" tabindex="-1"></a><span class="ex">$</span> iex <span class="at">-S</span> mix</span>
<span id="cb539-2"><a href="layers-of-abstraction.html#cb539-2" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb539-3"><a href="layers-of-abstraction.html#cb539-3" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">1</span><span class="kw">)</span><span class="op">&gt;</span> Streamer.start_streaming<span class="kw">(</span><span class="st">&quot;ETHUSDT&quot;</span><span class="kw">)</span></span>
<span id="cb539-4"><a href="layers-of-abstraction.html#cb539-4" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb539-5"><a href="layers-of-abstraction.html#cb539-5" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">2</span><span class="kw">)</span><span class="op">&gt;</span> Naive.start_trading<span class="kw">(</span><span class="st">&quot;ETHUSDT&quot;</span><span class="kw">)</span></span>
<span id="cb539-6"><a href="layers-of-abstraction.html#cb539-6" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb539-7"><a href="layers-of-abstraction.html#cb539-7" tabindex="-1"></a><span class="ex">22:57:53.834</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span> Position <span class="er">(</span><span class="ex">ETHUSDT/1675724273832</span><span class="kw">)</span><span class="bu">:</span> Placing a BUY order @ 1632.82000000,</span>
<span id="cb539-8"><a href="layers-of-abstraction.html#cb539-8" tabindex="-1"></a><span class="ex">quantity:</span> 0.12240000</span></code></pre></div>
<p>In this chapter, we’ve reiterated the ideas behind the <code>mox</code> package, highlighting its shortcomings, especially the push to create needless abstractions(behaviours). We then dropped our changes to show the alternative approach using the ‘mimic’ package, which was way handier and easier to understand. In the end, we realized that to facilitate using different implementations between dev and production, we will need to keep the <code>@binance_client</code> attribute.</p>
<p>[Note] Please remember to run the <code>mix format</code> to keep things nice and tidy.</p>
<p>The source code for this chapter can be found on <a href="https://github.com/Cinderella-Man/hands-on-elixir-and-otp-cryptocurrency-trading-bot-source-code/tree/chapter_21">GitHub</a></p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="idiomatic-trading-strategy.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/Cinderella-Man/hands-on-elixir-and-otp-cryptocurrency-trading-bot/edit/main/21-layers-of-abstraction.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
