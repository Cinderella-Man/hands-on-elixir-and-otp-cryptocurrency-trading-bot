<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 12 Start, stop, shutdown and autostart trading | Hands-on Elixir &amp; OTP: Cryptocurrency trading bot</title>
  <meta name="description" content="Chapter 12 Start, stop, shutdown and autostart trading | Hands-on Elixir &amp; OTP: Cryptocurrency trading bot" />
  <meta name="generator" content="bookdown 0.32 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 12 Start, stop, shutdown and autostart trading | Hands-on Elixir &amp; OTP: Cryptocurrency trading bot" />
  <meta property="og:type" content="book" />
  
  
  <meta name="github-repo" content="Cinderella-Man/hands-on-elixir-and-otp-cryptocurrency-trading-bot" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 12 Start, stop, shutdown and autostart trading | Hands-on Elixir &amp; OTP: Cryptocurrency trading bot" />
  <meta name="twitter:site" content="@kamilskowron" />
  
  

<meta name="author" content="Kamil Skowron" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="supervise-and-autostart-streaming.html"/>
<link rel="next" href="abstract-duplicated-supervision-code.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-52FKGBX2B8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-52FKGBX2B8');
</script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Hands-on Elixir & OTP: Cryptocurrency trading bot</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#want-to-learn-elixir-otp-by-creating-a-real-world-project"><i class="fa fa-check"></i>Want to learn Elixir &amp; OTP by creating a real-world project?</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#limit-of-liabilitydisclaimer-of-warranty"><i class="fa fa-check"></i>Limit of Liability/Disclaimer of Warranty</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#pdf-epub"><i class="fa fa-check"></i>PDF &amp; EPUB</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#preface-1"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#who-this-book-is-for"><i class="fa fa-check"></i>Who this book is for</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#what-this-book-covers"><i class="fa fa-check"></i>What this book covers</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#contributing-errata-and-source-code"><i class="fa fa-check"></i>Contributing, Errata and Source code</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><i class="fa fa-check"></i><b>1</b> Stream live cryptocurrency prices from the Binance WSS</a>
<ul>
<li class="chapter" data-level="1.1" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html#objectives"><i class="fa fa-check"></i><b>1.1</b> Objectives</a></li>
<li class="chapter" data-level="1.2" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html#create-a-new-umbrella-app"><i class="fa fa-check"></i><b>1.2</b> Create a new umbrella app</a></li>
<li class="chapter" data-level="1.3" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html#create-a-supervised-application-inside-an-umbrella"><i class="fa fa-check"></i><b>1.3</b> Create a supervised application inside an umbrella</a></li>
<li class="chapter" data-level="1.4" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html#connect-to-binances-websocket-stream-using-the-websockex-module"><i class="fa fa-check"></i><b>1.4</b> Connect to Binance’s WebSocket Stream using the WebSockex module</a></li>
<li class="chapter" data-level="1.5" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html#decode-incoming-events-using-the-jason-module"><i class="fa fa-check"></i><b>1.5</b> Decode incoming events using the Jason module</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><i class="fa fa-check"></i><b>2</b> Create a naive trading strategy - a single trader process without supervision</a>
<ul>
<li class="chapter" data-level="2.1" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#objectives-1"><i class="fa fa-check"></i><b>2.1</b> Objectives</a></li>
<li class="chapter" data-level="2.2" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#initializiation"><i class="fa fa-check"></i><b>2.2</b> Initializiation</a></li>
<li class="chapter" data-level="2.3" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#how-trading-strategy-will-work"><i class="fa fa-check"></i><b>2.3</b> How trading strategy will work?</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#implementation-of-the-first-scenario"><i class="fa fa-check"></i><b>2.3.1</b> Implementation of the first scenario</a></li>
<li class="chapter" data-level="2.3.2" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#implementation-of-the-second-scenario"><i class="fa fa-check"></i><b>2.3.2</b> Implementation of the second scenario</a></li>
<li class="chapter" data-level="2.3.3" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#implementation-of-the-third-scenario"><i class="fa fa-check"></i><b>2.3.3</b> Implementation of the third scenario</a></li>
<li class="chapter" data-level="2.3.4" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#implementation-fallback-scenario"><i class="fa fa-check"></i><b>2.3.4</b> Implementation fallback scenario</a></li>
<li class="chapter" data-level="2.3.5" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#updating-the-naive-interface"><i class="fa fa-check"></i><b>2.3.5</b> Updating the Naive interface</a></li>
<li class="chapter" data-level="2.3.6" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#updating-streamer-app"><i class="fa fa-check"></i><b>2.3.6</b> Updating streamer app</a></li>
<li class="chapter" data-level="2.3.7" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#access-details-to-binance"><i class="fa fa-check"></i><b>2.3.7</b> Access details to Binance</a></li>
<li class="chapter" data-level="2.3.8" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#test-run"><i class="fa fa-check"></i><b>2.3.8</b> Test run</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html"><i class="fa fa-check"></i><b>3</b> Introduce PubSub as a communication method</a>
<ul>
<li class="chapter" data-level="3.1" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html#objectives-2"><i class="fa fa-check"></i><b>3.1</b> Objectives</a></li>
<li class="chapter" data-level="3.2" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html#design"><i class="fa fa-check"></i><b>3.2</b> Design</a></li>
<li class="chapter" data-level="3.3" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html#implementation"><i class="fa fa-check"></i><b>3.3</b> Implementation</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html"><i class="fa fa-check"></i><b>4</b> Mock the Binance API</a>
<ul>
<li class="chapter" data-level="4.1" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#objectives-3"><i class="fa fa-check"></i><b>4.1</b> Objectives</a></li>
<li class="chapter" data-level="4.2" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#design-1"><i class="fa fa-check"></i><b>4.2</b> Design</a></li>
<li class="chapter" data-level="4.3" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#create-binancemock-app"><i class="fa fa-check"></i><b>4.3</b> Create “BinanceMock” app</a></li>
<li class="chapter" data-level="4.4" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-getting-exchange-info"><i class="fa fa-check"></i><b>4.4</b> Implement getting exchange info</a></li>
<li class="chapter" data-level="4.5" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-placing-buy-and-sell-orders"><i class="fa fa-check"></i><b>4.5</b> Implement placing buy and sell orders</a></li>
<li class="chapter" data-level="4.6" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-order-retrival"><i class="fa fa-check"></i><b>4.6</b> Implement order retrival</a></li>
<li class="chapter" data-level="4.7" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-callback-for-incoming-trade-events"><i class="fa fa-check"></i><b>4.7</b> Implement callback for incoming trade events</a></li>
<li class="chapter" data-level="4.8" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#upgrade-trader-and-config"><i class="fa fa-check"></i><b>4.8</b> Upgrade trader and config</a></li>
<li class="chapter" data-level="4.9" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#test-the-implementation"><i class="fa fa-check"></i><b>4.9</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html"><i class="fa fa-check"></i><b>5</b> Enable parallel trading on multiple symbols</a>
<ul>
<li class="chapter" data-level="5.1" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#objectives-4"><i class="fa fa-check"></i><b>5.1</b> Objectives</a></li>
<li class="chapter" data-level="5.2" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#introduction---architectural-design"><i class="fa fa-check"></i><b>5.2</b> Introduction - architectural design</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#update-application-supervisor"><i class="fa fa-check"></i><b>5.2.1</b> Update application supervisor</a></li>
<li class="chapter" data-level="5.2.2" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#add-interface-method"><i class="fa fa-check"></i><b>5.2.2</b> Add interface method</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#implement-naive.symbolsupervisor"><i class="fa fa-check"></i><b>5.3</b> Implement <code>Naive.SymbolSupervisor</code></a></li>
<li class="chapter" data-level="5.4" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#implement-naive.leader"><i class="fa fa-check"></i><b>5.4</b> Implement <code>Naive.Leader</code></a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#updating-the-leader-module"><i class="fa fa-check"></i><b>5.4.1</b> Updating the <code>leader</code> module</a></li>
<li class="chapter" data-level="5.4.2" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#updating-the-naive.trader-module"><i class="fa fa-check"></i><b>5.4.2</b> Updating the <code>Naive.Trader</code> module</a></li>
<li class="chapter" data-level="5.4.3" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#finalizing-naive.leader-implementation"><i class="fa fa-check"></i><b>5.4.3</b> Finalizing <code>Naive.Leader</code> implementation</a></li>
<li class="chapter" data-level="5.4.4" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#iex-testing"><i class="fa fa-check"></i><b>5.4.4</b> IEx testing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html"><i class="fa fa-check"></i><b>6</b> Introduce a <code>buy_down_interval</code> to make a single trader more profitable</a>
<ul>
<li class="chapter" data-level="6.1" data-path="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html#objectives-5"><i class="fa fa-check"></i><b>6.1</b> Objectives</a></li>
<li class="chapter" data-level="6.2" data-path="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html#why-we-need-to-buy-below-the-current-price-feature-overview"><i class="fa fa-check"></i><b>6.2</b> Why we need to buy below the current price? Feature overview</a></li>
<li class="chapter" data-level="6.3" data-path="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html#naive.trader-implementation"><i class="fa fa-check"></i><b>6.3</b> <code>Naive.Trader</code> implementation</a></li>
<li class="chapter" data-level="6.4" data-path="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html#naive.leader-implementation"><i class="fa fa-check"></i><b>6.4</b> <code>Naive.Leader</code> implementation</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html#iex-testing-1"><i class="fa fa-check"></i><b>6.4.1</b> IEx testing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html"><i class="fa fa-check"></i><b>7</b> Introduce a trader budget and calculating the quantity</a>
<ul>
<li class="chapter" data-level="7.1" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#objectives-6"><i class="fa fa-check"></i><b>7.1</b> Objectives</a></li>
<li class="chapter" data-level="7.2" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#fetch-step_size"><i class="fa fa-check"></i><b>7.2</b> Fetch <code>step_size</code></a></li>
<li class="chapter" data-level="7.3" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#append-budget-and-step_size-to-the-traders-state-inside-the-leader"><i class="fa fa-check"></i><b>7.3</b> Append <code>budget</code> and <code>step_size</code> to the <code>Trader</code>’s state inside the <code>Leader</code></a></li>
<li class="chapter" data-level="7.4" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#append-budget-and-step_size-to-the-traders-state"><i class="fa fa-check"></i><b>7.4</b> Append <code>budget</code> and <code>step_size</code> to the <code>Trader</code>’s state</a></li>
<li class="chapter" data-level="7.5" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#calculate-quantity"><i class="fa fa-check"></i><b>7.5</b> Calculate quantity</a>
<ul>
<li class="chapter" data-level="7.5.1" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#iex-testing-2"><i class="fa fa-check"></i><b>7.5.1</b> IEx testing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html"><i class="fa fa-check"></i><b>8</b> Add support for multiple transactions per order</a>
<ul>
<li class="chapter" data-level="8.1" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#objectives-7"><i class="fa fa-check"></i><b>8.1</b> Objectives</a></li>
<li class="chapter" data-level="8.2" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#the-issue-with-the-current-implementation"><i class="fa fa-check"></i><b>8.2</b> The issue with the current implementation</a></li>
<li class="chapter" data-level="8.3" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#improve-buy-order-filled-callback"><i class="fa fa-check"></i><b>8.3</b> Improve buy order filled callback</a></li>
<li class="chapter" data-level="8.4" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#implement-buy-order-filled-callback"><i class="fa fa-check"></i><b>8.4</b> Implement buy order “filled” callback</a></li>
<li class="chapter" data-level="8.5" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#improve-sell-order-callback"><i class="fa fa-check"></i><b>8.5</b> Improve sell order callback</a></li>
<li class="chapter" data-level="8.6" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#test-the-implementation-1"><i class="fa fa-check"></i><b>8.6</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html"><i class="fa fa-check"></i><b>9</b> Run multiple traders in parallel</a>
<ul>
<li class="chapter" data-level="9.1" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#objectives-8"><i class="fa fa-check"></i><b>9.1</b> Objectives</a></li>
<li class="chapter" data-level="9.2" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#describe-and-design-the-required-functionality"><i class="fa fa-check"></i><b>9.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="9.3" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#implement-rebuy-inside-naive.trader"><i class="fa fa-check"></i><b>9.3</b> Implement rebuy inside <code>Naive.Trader</code></a></li>
<li class="chapter" data-level="9.4" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#implement-rebuy-in-the-naive.leader"><i class="fa fa-check"></i><b>9.4</b> Implement rebuy in the <code>Naive.Leader</code></a></li>
<li class="chapter" data-level="9.5" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#improve-logs-by-assigning-ids-to-traders"><i class="fa fa-check"></i><b>9.5</b> Improve logs by assigning ids to traders</a></li>
<li class="chapter" data-level="9.6" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#test-the-implementation-2"><i class="fa fa-check"></i><b>9.6</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html"><i class="fa fa-check"></i><b>10</b> Fine-tune trading strategy per symbol</a>
<ul>
<li class="chapter" data-level="10.1" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#objectives-9"><i class="fa fa-check"></i><b>10.1</b> Objectives</a></li>
<li class="chapter" data-level="10.2" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#describe-and-design-the-required-functionality-1"><i class="fa fa-check"></i><b>10.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="10.3" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#add-docker-to-project"><i class="fa fa-check"></i><b>10.3</b> Add docker to project</a></li>
<li class="chapter" data-level="10.4" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#set-up-ecto-inside-the-naive-app"><i class="fa fa-check"></i><b>10.4</b> Set up <code>ecto</code> inside the <code>naive</code> app</a></li>
<li class="chapter" data-level="10.5" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#create-and-migrate-the-db"><i class="fa fa-check"></i><b>10.5</b> Create and migrate the DB</a></li>
<li class="chapter" data-level="10.6" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#seed-symbols-settings"><i class="fa fa-check"></i><b>10.6</b> Seed symbols’ settings</a></li>
<li class="chapter" data-level="10.7" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#update-the-naive.leader-to-fetch-settings"><i class="fa fa-check"></i><b>10.7</b> Update the <code>Naive.Leader</code> to fetch settings</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html"><i class="fa fa-check"></i><b>11</b> Supervise and autostart streaming</a>
<ul>
<li class="chapter" data-level="11.1" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#objectives-10"><i class="fa fa-check"></i><b>11.1</b> Objectives</a></li>
<li class="chapter" data-level="11.2" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#describe-and-design-the-required-functionality-2"><i class="fa fa-check"></i><b>11.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="11.3" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#register-the-streamer.binance-processes-with-names"><i class="fa fa-check"></i><b>11.3</b> Register the <code>Streamer.Binance</code> processes with names</a></li>
<li class="chapter" data-level="11.4" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#set-up-ecto-inside-the-streamer-app"><i class="fa fa-check"></i><b>11.4</b> Set up <code>ecto</code> inside the <code>streamer</code> app</a></li>
<li class="chapter" data-level="11.5" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#create-and-migrate-the-db-1"><i class="fa fa-check"></i><b>11.5</b> Create and migrate the db</a></li>
<li class="chapter" data-level="11.6" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#seed-default-settings"><i class="fa fa-check"></i><b>11.6</b> Seed default settings</a></li>
<li class="chapter" data-level="11.7" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#implement-the-supervision-tree-and-start-streaming-functionality"><i class="fa fa-check"></i><b>11.7</b> Implement the supervision tree and start streaming functionality</a></li>
<li class="chapter" data-level="11.8" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#implement-the-stop-functionality"><i class="fa fa-check"></i><b>11.8</b> Implement the stop functionality</a></li>
<li class="chapter" data-level="11.9" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#implement-the-autostart-streaming-functionality"><i class="fa fa-check"></i><b>11.9</b> Implement the autostart streaming functionality</a></li>
<li class="chapter" data-level="11.10" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#test-the-implementation-3"><i class="fa fa-check"></i><b>11.10</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html"><i class="fa fa-check"></i><b>12</b> Start, stop, shutdown and autostart trading</a>
<ul>
<li class="chapter" data-level="12.1" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#objectives-11"><i class="fa fa-check"></i><b>12.1</b> Objectives</a></li>
<li class="chapter" data-level="12.2" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#describe-and-design-the-required-functionality-3"><i class="fa fa-check"></i><b>12.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="12.3" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#re-implement-the-start-trading-functionality"><i class="fa fa-check"></i><b>12.3</b> (Re-)Implement the start trading functionality</a></li>
<li class="chapter" data-level="12.4" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#implement-the-stop-trading-functionality"><i class="fa fa-check"></i><b>12.4</b> Implement the stop trading functionality</a></li>
<li class="chapter" data-level="12.5" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#implement-the-autostart-trading-functionality"><i class="fa fa-check"></i><b>12.5</b> Implement the autostart trading functionality</a></li>
<li class="chapter" data-level="12.6" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#implement-the-shutdown-trading-functionality"><i class="fa fa-check"></i><b>12.6</b> Implement the shutdown trading functionality</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html"><i class="fa fa-check"></i><b>13</b> Abstract duplicated supervision code</a>
<ul>
<li class="chapter" data-level="13.1" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#objectives-12"><i class="fa fa-check"></i><b>13.1</b> Objectives</a></li>
<li class="chapter" data-level="13.2" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#overview-of-requirements"><i class="fa fa-check"></i><b>13.2</b> Overview of requirements</a></li>
<li class="chapter" data-level="13.3" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#pseudo-generalize-core.servicesupervisor-module"><i class="fa fa-check"></i><b>13.3</b> Pseudo generalize Core.ServiceSupervisor module</a></li>
<li class="chapter" data-level="13.4" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#utilize-pseudo-generalized-code-inside-the-naive-dynamicsymbolsupervisor"><i class="fa fa-check"></i><b>13.4</b> Utilize pseudo generalized code inside the Naive DynamicSymbolSupervisor</a></li>
<li class="chapter" data-level="13.5" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#implement-a-truly-generic-core.servicesupervisor"><i class="fa fa-check"></i><b>13.5</b> Implement a truly generic <code>Core.ServiceSupervisor</code></a>
<ul>
<li class="chapter" data-level="13.5.1" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#first-path-starting-with-the-fetch_symbols_to_start0-function"><i class="fa fa-check"></i><b>13.5.1</b> First path starting with the <code>fetch_symbols_to_start/0</code> function</a></li>
<li class="chapter" data-level="13.5.2" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#second-path-starting-with-the-update_status2"><i class="fa fa-check"></i><b>13.5.2</b> Second path starting with the <code>update_status/2</code></a></li>
<li class="chapter" data-level="13.5.3" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#third-path-starting-with-the-get_pid1-function"><i class="fa fa-check"></i><b>13.5.3</b> Third path starting with the <code>get_pid/1</code> function</a></li>
</ul></li>
<li class="chapter" data-level="13.6" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#remove-boilerplate-using-use-macro"><i class="fa fa-check"></i><b>13.6</b> Remove boilerplate using <code>use</code> macro</a></li>
<li class="chapter" data-level="13.7" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#use-the-core.servicesupervisor-module-inside-the-streamer-application"><i class="fa fa-check"></i><b>13.7</b> Use the <code>Core.ServiceSupervisor</code> module inside the <code>streamer</code> application</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html"><i class="fa fa-check"></i><b>14</b> Store trade events and orders inside the database</a>
<ul>
<li class="chapter" data-level="14.1" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#objectives-13"><i class="fa fa-check"></i><b>14.1</b> Objectives</a></li>
<li class="chapter" data-level="14.2" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#overview-of-requirements-1"><i class="fa fa-check"></i><b>14.2</b> Overview of requirements</a></li>
<li class="chapter" data-level="14.3" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-a-new-data_warehouse-application-in-the-umbrella"><i class="fa fa-check"></i><b>14.3</b> Create a new <code>data_warehouse</code> application in the umbrella</a></li>
<li class="chapter" data-level="14.4" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#connect-to-the-database-using-ecto"><i class="fa fa-check"></i><b>14.4</b> Connect to the database using Ecto</a></li>
<li class="chapter" data-level="14.5" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#store-trade-events-data"><i class="fa fa-check"></i><b>14.5</b> Store trade events’ data</a></li>
<li class="chapter" data-level="14.6" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#store-orders-data"><i class="fa fa-check"></i><b>14.6</b> Store orders’ data</a></li>
<li class="chapter" data-level="14.7" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#implement-supervision"><i class="fa fa-check"></i><b>14.7</b> Implement supervision</a>
<ul>
<li class="chapter" data-level="14.7.1" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-subscriber_settings-table"><i class="fa fa-check"></i><b>14.7.1</b> Create <code>subscriber_settings</code> table</a></li>
<li class="chapter" data-level="14.7.2" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#redesign-supervision-using-registry"><i class="fa fa-check"></i><b>14.7.2</b> Redesign supervision using Registry</a></li>
<li class="chapter" data-level="14.7.3" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-the-datawarehouse.subscriber.dynamicsupervisor-module"><i class="fa fa-check"></i><b>14.7.3</b> Create the <code>DataWarehouse.Subscriber.DynamicSupervisor</code> module</a></li>
<li class="chapter" data-level="14.7.4" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#register-worker-processes-using-via"><i class="fa fa-check"></i><b>14.7.4</b> Register Worker processes using :via</a></li>
<li class="chapter" data-level="14.7.5" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-a-new-supervision-level-for-registry-task-and-the-dynamicsupervisor"><i class="fa fa-check"></i><b>14.7.5</b> Create a new supervision level for Registry, Task and the DynamicSupervisor</a></li>
<li class="chapter" data-level="14.7.6" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#link-the-subscribersupervisor-to-the-application"><i class="fa fa-check"></i><b>14.7.6</b> Link the <code>SubscriberSupervisor</code> to the <code>Application</code></a></li>
<li class="chapter" data-level="14.7.7" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#add-interface"><i class="fa fa-check"></i><b>14.7.7</b> Add interface</a></li>
<li class="chapter" data-level="14.7.8" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#test"><i class="fa fa-check"></i><b>14.7.8</b> Test</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="15" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html"><i class="fa fa-check"></i><b>15</b> Backtest trading strategy</a>
<ul>
<li class="chapter" data-level="15.1" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#objectives-14"><i class="fa fa-check"></i><b>15.1</b> Objectives</a></li>
<li class="chapter" data-level="15.2" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#overview-of-requirements-2"><i class="fa fa-check"></i><b>15.2</b> Overview of requirements</a></li>
<li class="chapter" data-level="15.3" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#implement-the-storing-task"><i class="fa fa-check"></i><b>15.3</b> Implement the storing task</a></li>
<li class="chapter" data-level="15.4" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#test-the-backtesting"><i class="fa fa-check"></i><b>15.4</b> Test the backtesting</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html"><i class="fa fa-check"></i><b>16</b> End-to-end testing</a>
<ul>
<li class="chapter" data-level="16.1" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#objectives-15"><i class="fa fa-check"></i><b>16.1</b> Objectives</a></li>
<li class="chapter" data-level="16.2" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#decide-on-the-tested-functionality"><i class="fa fa-check"></i><b>16.2</b> Decide on the tested functionality</a></li>
<li class="chapter" data-level="16.3" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#implement-basic-test"><i class="fa fa-check"></i><b>16.3</b> Implement basic test</a></li>
<li class="chapter" data-level="16.4" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#introduce-environment-based-config-files"><i class="fa fa-check"></i><b>16.4</b> Introduce environment based config files</a></li>
<li class="chapter" data-level="16.5" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#add-convenience-aliases"><i class="fa fa-check"></i><b>16.5</b> Add convenience aliases</a></li>
<li class="chapter" data-level="16.6" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#cache-initial-seed-data-inside-a-file"><i class="fa fa-check"></i><b>16.6</b> Cache initial seed data inside a file</a></li>
<li class="chapter" data-level="16.7" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#update-seeding-scripts-to-use-the-binancemock"><i class="fa fa-check"></i><b>16.7</b> Update seeding scripts to use the BinanceMock</a></li>
<li class="chapter" data-level="16.8" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#introduce-the-core-application"><i class="fa fa-check"></i><b>16.8</b> Introduce the Core application</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="mox-rocks.html"><a href="mox-rocks.html"><i class="fa fa-check"></i><b>17</b> Mox rocks</a>
<ul>
<li class="chapter" data-level="17.1" data-path="mox-rocks.html"><a href="mox-rocks.html#objectives-16"><i class="fa fa-check"></i><b>17.1</b> Objectives</a></li>
<li class="chapter" data-level="17.2" data-path="mox-rocks.html"><a href="mox-rocks.html#introduction-to-mock-based-tests"><i class="fa fa-check"></i><b>17.2</b> Introduction to mock based tests</a></li>
<li class="chapter" data-level="17.3" data-path="mox-rocks.html"><a href="mox-rocks.html#add-the-mox-package"><i class="fa fa-check"></i><b>17.3</b> Add the <code>mox</code> package</a></li>
<li class="chapter" data-level="17.4" data-path="mox-rocks.html"><a href="mox-rocks.html#investigate-the-naive.trader-module"><i class="fa fa-check"></i><b>17.4</b> Investigate the <code>Naive.Trader</code> module</a>
<ul>
<li class="chapter" data-level="17.4.1" data-path="mox-rocks.html"><a href="mox-rocks.html#mock-the-binance-module"><i class="fa fa-check"></i><b>17.4.1</b> Mock the <code>Binance</code> module</a></li>
<li class="chapter" data-level="17.4.2" data-path="mox-rocks.html"><a href="mox-rocks.html#mock-the-naiveleader-module"><i class="fa fa-check"></i><b>17.4.2</b> Mock the <code>NaiveLeader</code> module</a></li>
<li class="chapter" data-level="17.4.3" data-path="mox-rocks.html"><a href="mox-rocks.html#mock-the-phoenix.pubsub-module"><i class="fa fa-check"></i><b>17.4.3</b> Mock the <code>Phoenix.PubSub</code> module</a></li>
<li class="chapter" data-level="17.4.4" data-path="mox-rocks.html"><a href="mox-rocks.html#mock-the-logger-module"><i class="fa fa-check"></i><b>17.4.4</b> Mock the <code>Logger</code> module</a></li>
</ul></li>
<li class="chapter" data-level="17.5" data-path="mox-rocks.html"><a href="mox-rocks.html#implement-a-test-of-the-naive.trader-module"><i class="fa fa-check"></i><b>17.5</b> Implement a test of the <code>Naive.Trader</code> module</a></li>
<li class="chapter" data-level="17.6" data-path="mox-rocks.html"><a href="mox-rocks.html#define-an-alias-to-run-unit-tests"><i class="fa fa-check"></i><b>17.6</b> Define an alias to run unit tests</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="functional-elixir.html"><a href="functional-elixir.html"><i class="fa fa-check"></i><b>18</b> Functional Elixir</a>
<ul>
<li class="chapter" data-level="18.1" data-path="functional-elixir.html"><a href="functional-elixir.html#objectives-17"><i class="fa fa-check"></i><b>18.1</b> Objectives</a></li>
<li class="chapter" data-level="18.2" data-path="functional-elixir.html"><a href="functional-elixir.html#the-reasoning-behind-the-functional-approach"><i class="fa fa-check"></i><b>18.2</b> The reasoning behind the functional approach</a></li>
<li class="chapter" data-level="18.3" data-path="functional-elixir.html"><a href="functional-elixir.html#simplifying-by-splitting"><i class="fa fa-check"></i><b>18.3</b> Simplifying by splitting</a></li>
<li class="chapter" data-level="18.4" data-path="functional-elixir.html"><a href="functional-elixir.html#abstracting-the-pure-logic"><i class="fa fa-check"></i><b>18.4</b> Abstracting the “pure” logic</a>
<ul>
<li class="chapter" data-level="18.4.1" data-path="functional-elixir.html"><a href="functional-elixir.html#place-a-buy-order-rules"><i class="fa fa-check"></i><b>18.4.1</b> Place a buy order rules</a></li>
<li class="chapter" data-level="18.4.2" data-path="functional-elixir.html"><a href="functional-elixir.html#race-condition-rules"><i class="fa fa-check"></i><b>18.4.2</b> Race condition rules</a></li>
<li class="chapter" data-level="18.4.3" data-path="functional-elixir.html"><a href="functional-elixir.html#place-a-sell-order-rules"><i class="fa fa-check"></i><b>18.4.3</b> Place a sell order rules</a></li>
<li class="chapter" data-level="18.4.4" data-path="functional-elixir.html"><a href="functional-elixir.html#fetch-the-buy-order-rules"><i class="fa fa-check"></i><b>18.4.4</b> Fetch the buy order rules</a></li>
<li class="chapter" data-level="18.4.5" data-path="functional-elixir.html"><a href="functional-elixir.html#terminate-trader-rules"><i class="fa fa-check"></i><b>18.4.5</b> Terminate trader rules</a></li>
<li class="chapter" data-level="18.4.6" data-path="functional-elixir.html"><a href="functional-elixir.html#fetch-the-sell-order-rules"><i class="fa fa-check"></i><b>18.4.6</b> Fetch the sell order rules</a></li>
<li class="chapter" data-level="18.4.7" data-path="functional-elixir.html"><a href="functional-elixir.html#trigger-rebuy-rules"><i class="fa fa-check"></i><b>18.4.7</b> Trigger rebuy rules</a></li>
<li class="chapter" data-level="18.4.8" data-path="functional-elixir.html"><a href="functional-elixir.html#the-final-clause-rules"><i class="fa fa-check"></i><b>18.4.8</b> The final clause rules</a></li>
<li class="chapter" data-level="18.4.9" data-path="functional-elixir.html"><a href="functional-elixir.html#changes-to-the-naive.trader-module"><i class="fa fa-check"></i><b>18.4.9</b> Changes to the <code>Naive.Trader</code> module</a></li>
<li class="chapter" data-level="18.4.10" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---place-buy-order"><i class="fa fa-check"></i><b>18.4.10</b> <code>Naive.Trader</code> - place buy order</a></li>
<li class="chapter" data-level="18.4.11" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---race-condition-clause"><i class="fa fa-check"></i><b>18.4.11</b> <code>Naive.Trader</code> - Race condition clause</a></li>
<li class="chapter" data-level="18.4.12" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---place-a-sell-order"><i class="fa fa-check"></i><b>18.4.12</b> <code>Naive.Trader</code> - Place a sell order</a></li>
<li class="chapter" data-level="18.4.13" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---fetch-the-buy-order"><i class="fa fa-check"></i><b>18.4.13</b> <code>Naive.Trader</code> - Fetch the buy order</a></li>
<li class="chapter" data-level="18.4.14" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---terminate-the-trader"><i class="fa fa-check"></i><b>18.4.14</b> <code>Naive.Trader</code> - Terminate the trader</a></li>
<li class="chapter" data-level="18.4.15" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---fetch-the-sell-order"><i class="fa fa-check"></i><b>18.4.15</b> <code>Naive.Trader</code> - Fetch the sell order</a></li>
<li class="chapter" data-level="18.4.16" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---triggering-rebuy"><i class="fa fa-check"></i><b>18.4.16</b> <code>Naive.Trader</code> - Triggering rebuy</a></li>
<li class="chapter" data-level="18.4.17" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---the-final-ignore-clause"><i class="fa fa-check"></i><b>18.4.17</b> <code>Naive.Trader</code> - The final ignore clause</a></li>
</ul></li>
<li class="chapter" data-level="18.5" data-path="functional-elixir.html"><a href="functional-elixir.html#dealing-with-dirty-code"><i class="fa fa-check"></i><b>18.5</b> Dealing with dirty code</a></li>
<li class="chapter" data-level="18.6" data-path="functional-elixir.html"><a href="functional-elixir.html#making-dirty-code-testable"><i class="fa fa-check"></i><b>18.6</b> Making dirty code testable</a>
<ul>
<li class="chapter" data-level="18.6.1" data-path="functional-elixir.html"><a href="functional-elixir.html#passing-functions-arguments"><i class="fa fa-check"></i><b>18.6.1</b> Passing functions arguments</a></li>
<li class="chapter" data-level="18.6.2" data-path="functional-elixir.html"><a href="functional-elixir.html#passing-grouped-functions-as-a-context"><i class="fa fa-check"></i><b>18.6.2</b> Passing grouped functions as a context</a></li>
<li class="chapter" data-level="18.6.3" data-path="functional-elixir.html"><a href="functional-elixir.html#passing-grouped-modules-as-a-context"><i class="fa fa-check"></i><b>18.6.3</b> Passing grouped modules as a context</a></li>
<li class="chapter" data-level="18.6.4" data-path="functional-elixir.html"><a href="functional-elixir.html#injecting-modules-to-modules-attributes-based-on-the-configuration"><i class="fa fa-check"></i><b>18.6.4</b> Injecting modules to module’s attributes based on the configuration</a></li>
</ul></li>
<li class="chapter" data-level="18.7" data-path="functional-elixir.html"><a href="functional-elixir.html#the-power-with-in"><i class="fa fa-check"></i><b>18.7</b> The power <code>with</code>-in</a>
<ul>
<li class="chapter" data-level="18.7.1" data-path="functional-elixir.html"><a href="functional-elixir.html#idiomatic-error-handling"><i class="fa fa-check"></i><b>18.7.1</b> Idiomatic error handling</a></li>
</ul></li>
<li class="chapter" data-level="18.8" data-path="functional-elixir.html"><a href="functional-elixir.html#do-or-not-to-do"><i class="fa fa-check"></i><b>18.8</b> Do or not to do</a></li>
<li class="chapter" data-level="18.9" data-path="functional-elixir.html"><a href="functional-elixir.html#final-thoughts"><i class="fa fa-check"></i><b>18.9</b> Final thoughts</a></li>
</ul></li>
<li class="chapter" data-level="19" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html"><i class="fa fa-check"></i><b>19</b> Idiomatic OTP</a>
<ul>
<li class="chapter" data-level="19.1" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#objectives-18"><i class="fa fa-check"></i><b>19.1</b> Objectives</a></li>
<li class="chapter" data-level="19.2" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#the-concept"><i class="fa fa-check"></i><b>19.2</b> The concept</a></li>
<li class="chapter" data-level="19.3" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#initial-implementation"><i class="fa fa-check"></i><b>19.3</b> Initial implementation</a>
<ul>
<li class="chapter" data-level="19.3.1" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#maybe-functions"><i class="fa fa-check"></i><b>19.3.1</b> Maybe functions</a></li>
<li class="chapter" data-level="19.3.2" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#testing"><i class="fa fa-check"></i><b>19.3.2</b> Testing</a></li>
<li class="chapter" data-level="19.3.3" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#supervision"><i class="fa fa-check"></i><b>19.3.3</b> Supervision</a></li>
</ul></li>
<li class="chapter" data-level="19.4" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#idiomatic-solution"><i class="fa fa-check"></i><b>19.4</b> Idiomatic solution</a></li>
</ul></li>
<li class="chapter" data-level="20" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html"><i class="fa fa-check"></i><b>20</b> Idiomatic trading strategy</a>
<ul>
<li class="chapter" data-level="20.1" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#objectives-19"><i class="fa fa-check"></i><b>20.1</b> Objectives</a></li>
<li class="chapter" data-level="20.2" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#following-the-ohlc-footsteps"><i class="fa fa-check"></i><b>20.2</b> Following the OHLC footsteps</a></li>
<li class="chapter" data-level="20.3" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#simplifying-the-naive-supervision-tree"><i class="fa fa-check"></i><b>20.3</b> Simplifying the Naive supervision tree</a>
<ul>
<li class="chapter" data-level="20.3.1" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#the-naive.dynamictradersupervisor-module"><i class="fa fa-check"></i><b>20.3.1</b> The <code>Naive.DynamicTraderSupervisor</code> module</a></li>
<li class="chapter" data-level="20.3.2" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#the-naive-module"><i class="fa fa-check"></i><b>20.3.2</b> The <code>Naive</code> module</a></li>
<li class="chapter" data-level="20.3.3" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#the-naive.supervisor-module"><i class="fa fa-check"></i><b>20.3.3</b> The <code>Naive.Supervisor</code> module</a></li>
<li class="chapter" data-level="20.3.4" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#the-naive.trader-module"><i class="fa fa-check"></i><b>20.3.4</b> The <code>Naive.Trader</code> module</a></li>
</ul></li>
<li class="chapter" data-level="20.4" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#supporting-multiple-positions"><i class="fa fa-check"></i><b>20.4</b> Supporting multiple positions</a>
<ul>
<li class="chapter" data-level="20.4.1" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#initialization"><i class="fa fa-check"></i><b>20.4.1</b> Initialization</a></li>
<li class="chapter" data-level="20.4.2" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#parallelising-the-strategy"><i class="fa fa-check"></i><b>20.4.2</b> Parallelising the strategy</a></li>
</ul></li>
<li class="chapter" data-level="20.5" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#retrofitting-the-shutdown-functionality"><i class="fa fa-check"></i><b>20.5</b> Retrofitting the “shutdown” functionality</a>
<ul>
<li class="chapter" data-level="20.5.1" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#handling-updated-settings"><i class="fa fa-check"></i><b>20.5.1</b> Handling updated settings</a></li>
<li class="chapter" data-level="20.5.2" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#updating-the-naive.strategy-to-honour-the-shutdown-state"><i class="fa fa-check"></i><b>20.5.2</b> Updating the <code>Naive.Strategy</code> to honour the “shutdown” state</a></li>
</ul></li>
<li class="chapter" data-level="20.6" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#updating-the-strategy-to-handle-rebuys"><i class="fa fa-check"></i><b>20.6</b> Updating the Strategy to handle rebuys</a></li>
<li class="chapter" data-level="20.7" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#fetching-active-positions"><i class="fa fa-check"></i><b>20.7</b> Fetching active positions</a></li>
<li class="chapter" data-level="20.8" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#tidying-up"><i class="fa fa-check"></i><b>20.8</b> Tidying up</a></li>
<li class="chapter" data-level="20.9" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#final-thoughts-1"><i class="fa fa-check"></i><b>20.9</b> Final thoughts</a></li>
</ul></li>
<li class="chapter" data-level="21" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html"><i class="fa fa-check"></i><b>21</b> Layers of abstraction</a>
<ul>
<li class="chapter" data-level="21.1" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#objectives-20"><i class="fa fa-check"></i><b>21.1</b> Objectives</a></li>
<li class="chapter" data-level="21.2" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#admitting-the-simplification"><i class="fa fa-check"></i><b>21.2</b> Admitting the simplification</a></li>
<li class="chapter" data-level="21.3" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#abstracting-the-exchange"><i class="fa fa-check"></i><b>21.3</b> Abstracting the exchange</a>
<ul>
<li class="chapter" data-level="21.3.1" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#defining-the-core.exchange-behaviour"><i class="fa fa-check"></i><b>21.3.1</b> Defining the <code>Core.Exchange</code> behaviour</a></li>
<li class="chapter" data-level="21.3.2" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#implementation-of-the-core.exchange.binance-module"><i class="fa fa-check"></i><b>21.3.2</b> Implementation of the <code>Core.Exchange.Binance</code> module</a></li>
<li class="chapter" data-level="21.3.3" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#updating-the-binancemock-module-to-implement-the-core.exchange-behaviour"><i class="fa fa-check"></i><b>21.3.3</b> Updating the <code>BinanceMock</code> module to implement the <code>Core.Exchange</code> behaviour</a></li>
<li class="chapter" data-level="21.3.4" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#updating-the-naive.strategy"><i class="fa fa-check"></i><b>21.3.4</b> Updating the <code>Naive.Strategy</code></a></li>
<li class="chapter" data-level="21.3.5" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#updating-seed-scripts"><i class="fa fa-check"></i><b>21.3.5</b> Updating seed scripts</a></li>
<li class="chapter" data-level="21.3.6" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#manual-testing-after-refactoring"><i class="fa fa-check"></i><b>21.3.6</b> Manual testing after refactoring</a></li>
<li class="chapter" data-level="21.3.7" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#storing-the-data"><i class="fa fa-check"></i><b>21.3.7</b> Storing the data</a></li>
<li class="chapter" data-level="21.3.8" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#the-mox-approach-summary"><i class="fa fa-check"></i><b>21.3.8</b> The <code>Mox</code> approach summary</a></li>
</ul></li>
<li class="chapter" data-level="21.4" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#mimicking-the-reality"><i class="fa fa-check"></i><b>21.4</b> Mimicking the reality</a>
<ul>
<li class="chapter" data-level="21.4.1" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#updating-the-naive.strategy-1"><i class="fa fa-check"></i><b>21.4.1</b> Updating the <code>Naive.Strategy</code></a></li>
<li class="chapter" data-level="21.4.2" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#testing-the-naive.strategy"><i class="fa fa-check"></i><b>21.4.2</b> Testing the <code>Naive.Strategy</code></a></li>
<li class="chapter" data-level="21.4.3" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#logging-elephant-in-the-room"><i class="fa fa-check"></i><b>21.4.3</b> Logging elephant in the room</a></li>
</ul></li>
<li class="chapter" data-level="21.5" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#swapping-back-to-attributes"><i class="fa fa-check"></i><b>21.5</b> Swapping back to attributes</a>
<ul>
<li class="chapter" data-level="21.5.1" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#config-files"><i class="fa fa-check"></i><b>21.5.1</b> Config files</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://www.bookdown.org/" target="blank">Created with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Hands-on Elixir &amp; OTP: Cryptocurrency trading bot</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="start-stop-shutdown-and-autostart-trading" class="section level1 hasAnchor" number="12">
<h1><span class="header-section-number">Chapter 12</span> Start, stop, shutdown and autostart trading<a href="start-stop-shutdown-and-autostart-trading.html#start-stop-shutdown-and-autostart-trading" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="objectives-11" class="section level2 hasAnchor" number="12.1">
<h2><span class="header-section-number">12.1</span> Objectives<a href="start-stop-shutdown-and-autostart-trading.html#objectives-11" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>describe and design the required functionality</li>
<li>(re-)implement the start trading functionality</li>
<li>implement the stop trading functionality</li>
<li>implement the autostart trading functionality</li>
<li>implement the shutdown trading functionality</li>
<li>test the implementation</li>
</ul>
</div>
<div id="describe-and-design-the-required-functionality-3" class="section level2 hasAnchor" number="12.2">
<h2><span class="header-section-number">12.2</span> Describe and design the required functionality<a href="start-stop-shutdown-and-autostart-trading.html#describe-and-design-the-required-functionality-3" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In the 10th chapter, we’ve introduced the Postgres database inside the <code>naive</code> application together with the settings per symbol.</p>
<p>In this chapter, we will progress forward to provide additional trading functionality that will be similar to the functionality implemented in the last chapter for the <code>streaming</code> application:</p>
<ul>
<li><strong>stop trading</strong> - as the <code>Naive.SymbolSupervisor</code> processes are registered with names that can be easily reverse engineered, we should be able to utilize the <code>Process.where_is/1</code> function to retrieve the PIDs and instruct the <code>Naive.DynamicSymbolSupervisor</code> to terminate those child processes. Again, we need to put that logic somewhere so we will implement the <code>Naive.DynamicSymbolSupervisor</code> as a full module using the <code>DynamicSupervisor</code> behavior.</li>
<li><strong>start_trading</strong> - as our <code>Naive.DynamicSymbolSupervisor</code> will now be a module we will be able to remove the <code>start_trading/1</code> implementation from the <code>Naive</code> module and reimplement it inside the <code>Naive.DynamicSymbolSupervisor</code> module. It will follow the same pattern of checking for PID, starting the <code>Naive.SymbolSupervisor</code> process and flipping the <code>status</code> flag inside the <code>settings</code> table’s row for that symbol.</li>
<li><strong>shutdown trading</strong> - sometimes abruptly stopping trading won’t be the best solution, it would be better to allow the <code>Naive.Trader</code> processes to finish their ongoing trades. To be able to do that we will need to inform the <code>Naive.Leader</code> process assigned to the symbol that the settings for that symbol have been updated and that should cause the <code>Naive.Leader</code> process to withhold starting new <code>Naive.Trader</code> processes and terminate the whole tree when the last trader will finish.</li>
<li><strong>autostart trading</strong> - this will be a very similar implementation to the one from the last chapter. It will require introducing a new supervisor(we will follow the same naming convention: rename <code>Naive.Application</code>’s registered process name to <code>Naive.Application</code>, create a new supervisor called <code>Naive.Supervisor</code>) and utilize the <code>Task</code> process to execute the autostarting logic.</li>
</ul>
<p><img src="images/chapter_12_02_sup_diagram.png" width="100%" height="50%" style="display: block; margin: auto;" /></p>
</div>
<div id="re-implement-the-start-trading-functionality" class="section level2 hasAnchor" number="12.3">
<h2><span class="header-section-number">12.3</span> (Re-)Implement the start trading functionality<a href="start-stop-shutdown-and-autostart-trading.html#re-implement-the-start-trading-functionality" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>To (re-)implement the <code>start_trading/1</code> functionality we will need to create a new file called<br />
<code>dynamic_symbol_supervisor.ex</code> inside the <code>/apps/naive/lib/naive</code> directory that will use the<br />
<code>DynamicSupervisor</code> behavior. Previously we have been using default <code>DynamicSupervisor</code> implementation(one of the children of the <code>Naive.Application</code> - to be substituted with the below module):</p>
<div class="sourceCode" id="cb185"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb185-1"><a href="start-stop-shutdown-and-autostart-trading.html#cb185-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/dynamic_symbol_supervisor.ex</span></span>
<span id="cb185-2"><a href="start-stop-shutdown-and-autostart-trading.html#cb185-2" tabindex="-1"></a><span class="kw">defmodule</span> <span class="cn">Naive</span><span class="op">.</span><span class="cn">DynamicSymbolSupervisor</span> <span class="kw">do</span> <span class="co"># &lt;= module updated</span></span>
<span id="cb185-3"><a href="start-stop-shutdown-and-autostart-trading.html#cb185-3" tabindex="-1"></a>  <span class="im">use</span> <span class="cn">DynamicSupervisor</span></span>
<span id="cb185-4"><a href="start-stop-shutdown-and-autostart-trading.html#cb185-4" tabindex="-1"></a></span>
<span id="cb185-5"><a href="start-stop-shutdown-and-autostart-trading.html#cb185-5" tabindex="-1"></a>  <span class="im">require</span> <span class="cn">Logger</span> <span class="co"># &lt;= Logger added</span></span>
<span id="cb185-6"><a href="start-stop-shutdown-and-autostart-trading.html#cb185-6" tabindex="-1"></a></span>
<span id="cb185-7"><a href="start-stop-shutdown-and-autostart-trading.html#cb185-7" tabindex="-1"></a>  <span class="im">import</span> <span class="cn">Ecto</span><span class="op">.</span><span class="cn">Query</span>, <span class="va">only:</span> <span class="ot">[</span><span class="va">from:</span> <span class="dv">2</span><span class="ot">]</span> <span class="co"># &lt;= added for querying</span></span>
<span id="cb185-8"><a href="start-stop-shutdown-and-autostart-trading.html#cb185-8" tabindex="-1"></a></span>
<span id="cb185-9"><a href="start-stop-shutdown-and-autostart-trading.html#cb185-9" tabindex="-1"></a>  <span class="im">alias</span> <span class="cn">Naive</span><span class="op">.</span><span class="cn">Repo</span>             <span class="co"># &lt;= added for querying/updating</span></span>
<span id="cb185-10"><a href="start-stop-shutdown-and-autostart-trading.html#cb185-10" tabindex="-1"></a>  <span class="im">alias</span> <span class="cn">Naive</span><span class="op">.</span><span class="cn">Schema</span><span class="op">.</span><span class="cn">Settings</span>  <span class="co"># &lt;= added for querying/updating</span></span>
<span id="cb185-11"><a href="start-stop-shutdown-and-autostart-trading.html#cb185-11" tabindex="-1"></a></span>
<span id="cb185-12"><a href="start-stop-shutdown-and-autostart-trading.html#cb185-12" tabindex="-1"></a>  <span class="kw">def</span> start_link<span class="fu">(</span>init_arg<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb185-13"><a href="start-stop-shutdown-and-autostart-trading.html#cb185-13" tabindex="-1"></a>    <span class="cn">DynamicSupervisor</span><span class="op">.</span>start_link<span class="fu">(</span><span class="cn">__MODULE__</span>, init_arg, <span class="va">name:</span> <span class="cn">__MODULE__</span><span class="fu">)</span></span>
<span id="cb185-14"><a href="start-stop-shutdown-and-autostart-trading.html#cb185-14" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb185-15"><a href="start-stop-shutdown-and-autostart-trading.html#cb185-15" tabindex="-1"></a></span>
<span id="cb185-16"><a href="start-stop-shutdown-and-autostart-trading.html#cb185-16" tabindex="-1"></a>  <span class="kw">def</span> init<span class="fu">(</span>_init_arg<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb185-17"><a href="start-stop-shutdown-and-autostart-trading.html#cb185-17" tabindex="-1"></a>    <span class="cn">DynamicSupervisor</span><span class="op">.</span>init<span class="fu">(</span><span class="va">strategy:</span> <span class="va">:one_for_one</span><span class="fu">)</span></span>
<span id="cb185-18"><a href="start-stop-shutdown-and-autostart-trading.html#cb185-18" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb185-19"><a href="start-stop-shutdown-and-autostart-trading.html#cb185-19" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<p>The above code is a default implementation from the <a href="https://hexdocs.pm/elixir/master/DynamicSupervisor.html#module-module-based-supervisors">DynamicSupervisor docs</a> with some additional imports, require and aliases as we will use them in this chapter.</p>
<p>Our <code>start_trading/1</code> implementation is almost the same as one for the <code>streamer</code> application from the last chapter:</p>
<div class="sourceCode" id="cb186"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb186-1"><a href="start-stop-shutdown-and-autostart-trading.html#cb186-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/dynamic_symbol_supervisor.ex</span></span>
<span id="cb186-2"><a href="start-stop-shutdown-and-autostart-trading.html#cb186-2" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb186-3"><a href="start-stop-shutdown-and-autostart-trading.html#cb186-3" tabindex="-1"></a>  <span class="kw">def</span> start_trading<span class="fu">(</span>symbol<span class="fu">)</span> <span class="kw">when</span> is_binary<span class="fu">(</span>symbol<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb186-4"><a href="start-stop-shutdown-and-autostart-trading.html#cb186-4" tabindex="-1"></a>    symbol <span class="op">=</span> <span class="cn">String</span><span class="op">.</span>upcase<span class="fu">(</span>symbol<span class="fu">)</span></span>
<span id="cb186-5"><a href="start-stop-shutdown-and-autostart-trading.html#cb186-5" tabindex="-1"></a>    </span>
<span id="cb186-6"><a href="start-stop-shutdown-and-autostart-trading.html#cb186-6" tabindex="-1"></a>    <span class="kw">case</span> get_pid<span class="fu">(</span>symbol<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb186-7"><a href="start-stop-shutdown-and-autostart-trading.html#cb186-7" tabindex="-1"></a>      <span class="cn">nil</span> <span class="op">-&gt;</span></span>
<span id="cb186-8"><a href="start-stop-shutdown-and-autostart-trading.html#cb186-8" tabindex="-1"></a>        <span class="cn">Logger</span><span class="op">.</span>info<span class="fu">(</span><span class="st">&quot;Starting trading of </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st">&quot;</span><span class="fu">)</span></span>
<span id="cb186-9"><a href="start-stop-shutdown-and-autostart-trading.html#cb186-9" tabindex="-1"></a>        <span class="fu">{</span><span class="va">:ok</span>, _settings<span class="fu">}</span> <span class="op">=</span> update_trading_status<span class="fu">(</span>symbol, <span class="st">&quot;on&quot;</span><span class="fu">)</span></span>
<span id="cb186-10"><a href="start-stop-shutdown-and-autostart-trading.html#cb186-10" tabindex="-1"></a>        <span class="fu">{</span><span class="va">:ok</span>, _pid<span class="fu">}</span> <span class="op">=</span> start_symbol_supervisor<span class="fu">(</span>symbol<span class="fu">)</span></span>
<span id="cb186-11"><a href="start-stop-shutdown-and-autostart-trading.html#cb186-11" tabindex="-1"></a></span>
<span id="cb186-12"><a href="start-stop-shutdown-and-autostart-trading.html#cb186-12" tabindex="-1"></a>      pid <span class="op">-&gt;</span></span>
<span id="cb186-13"><a href="start-stop-shutdown-and-autostart-trading.html#cb186-13" tabindex="-1"></a>        <span class="cn">Logger</span><span class="op">.</span>warn<span class="fu">(</span><span class="st">&quot;Trading on </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st"> already started&quot;</span><span class="fu">)</span></span>
<span id="cb186-14"><a href="start-stop-shutdown-and-autostart-trading.html#cb186-14" tabindex="-1"></a>        <span class="fu">{</span><span class="va">:ok</span>, _settings<span class="fu">}</span> <span class="op">=</span> update_trading_status<span class="fu">(</span>symbol, <span class="st">&quot;on&quot;</span><span class="fu">)</span></span>
<span id="cb186-15"><a href="start-stop-shutdown-and-autostart-trading.html#cb186-15" tabindex="-1"></a>        <span class="fu">{</span><span class="va">:ok</span>, pid<span class="fu">}</span></span>
<span id="cb186-16"><a href="start-stop-shutdown-and-autostart-trading.html#cb186-16" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb186-17"><a href="start-stop-shutdown-and-autostart-trading.html#cb186-17" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb186-18"><a href="start-stop-shutdown-and-autostart-trading.html#cb186-18" tabindex="-1"></a>  <span class="op">...</span></span></code></pre></div>
<div style="page-break-after: always;"></div>
<p>together with additional helper functions:</p>
<div class="sourceCode" id="cb187"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb187-1"><a href="start-stop-shutdown-and-autostart-trading.html#cb187-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/dynamic_symbol_supervisor.ex</span></span>
<span id="cb187-2"><a href="start-stop-shutdown-and-autostart-trading.html#cb187-2" tabindex="-1"></a>  <span class="kw">defp</span> get_pid<span class="fu">(</span>symbol<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb187-3"><a href="start-stop-shutdown-and-autostart-trading.html#cb187-3" tabindex="-1"></a>    <span class="cn">Process</span><span class="op">.</span>whereis<span class="fu">(</span>:<span class="st">&quot;Elixir.Naive.SymbolSupervisor-</span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st">&quot;</span><span class="fu">)</span></span>
<span id="cb187-4"><a href="start-stop-shutdown-and-autostart-trading.html#cb187-4" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb187-5"><a href="start-stop-shutdown-and-autostart-trading.html#cb187-5" tabindex="-1"></a></span>
<span id="cb187-6"><a href="start-stop-shutdown-and-autostart-trading.html#cb187-6" tabindex="-1"></a>  <span class="kw">defp</span> update_trading_status<span class="fu">(</span>symbol, status<span class="fu">)</span></span>
<span id="cb187-7"><a href="start-stop-shutdown-and-autostart-trading.html#cb187-7" tabindex="-1"></a>       <span class="kw">when</span> is_binary<span class="fu">(</span>symbol<span class="fu">)</span> <span class="kw">and</span> is_binary<span class="fu">(</span>status<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb187-8"><a href="start-stop-shutdown-and-autostart-trading.html#cb187-8" tabindex="-1"></a>    <span class="cn">Repo</span><span class="op">.</span>get_by<span class="fu">(</span><span class="cn">Settings</span>, <span class="va">symbol:</span> symbol<span class="fu">)</span></span>
<span id="cb187-9"><a href="start-stop-shutdown-and-autostart-trading.html#cb187-9" tabindex="-1"></a>    <span class="op">|&gt;</span> <span class="cn">Ecto</span><span class="op">.</span><span class="cn">Changeset</span><span class="op">.</span>change<span class="fu">(</span>%<span class="fu">{</span><span class="va">status:</span> status<span class="fu">})</span></span>
<span id="cb187-10"><a href="start-stop-shutdown-and-autostart-trading.html#cb187-10" tabindex="-1"></a>    <span class="op">|&gt;</span> <span class="cn">Repo</span><span class="op">.</span>update<span class="fu">()</span></span>
<span id="cb187-11"><a href="start-stop-shutdown-and-autostart-trading.html#cb187-11" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb187-12"><a href="start-stop-shutdown-and-autostart-trading.html#cb187-12" tabindex="-1"></a></span>
<span id="cb187-13"><a href="start-stop-shutdown-and-autostart-trading.html#cb187-13" tabindex="-1"></a>  <span class="kw">defp</span> start_symbol_supervisor<span class="fu">(</span>symbol<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb187-14"><a href="start-stop-shutdown-and-autostart-trading.html#cb187-14" tabindex="-1"></a>    <span class="cn">DynamicSupervisor</span><span class="op">.</span>start_child<span class="fu">(</span></span>
<span id="cb187-15"><a href="start-stop-shutdown-and-autostart-trading.html#cb187-15" tabindex="-1"></a>      <span class="cn">Naive</span><span class="op">.</span><span class="cn">DynamicSymbolSupervisor</span>,</span>
<span id="cb187-16"><a href="start-stop-shutdown-and-autostart-trading.html#cb187-16" tabindex="-1"></a>      <span class="fu">{</span><span class="cn">Naive</span><span class="op">.</span><span class="cn">SymbolSupervisor</span>, symbol<span class="fu">}</span></span>
<span id="cb187-17"><a href="start-stop-shutdown-and-autostart-trading.html#cb187-17" tabindex="-1"></a>    <span class="fu">)</span></span>
<span id="cb187-18"><a href="start-stop-shutdown-and-autostart-trading.html#cb187-18" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>Both implementation and helper functions are almost the same as the ones inside the <code>naive</code> application. It could be tempting to abstract some of the logic away but remember that we should treat all applications in our umbrella project as standalone services that should not share any code if possible(we broke that rule for the <code>TradeEvent</code> struct from the <code>streamer</code> app but we could easily just make a lib with that struct that would be shared between two applications). I would shy away from sharing any business logic between applications in the umbrella project.</p>
<p>There are two additional places where we need to make updates to get our <code>start_trading/1</code> to work again:</p>
<ul>
<li>we need to update the <code>children</code> list inside the <code>Naive.Application</code>:</li>
</ul>
<div class="sourceCode" id="cb188"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb188-1"><a href="start-stop-shutdown-and-autostart-trading.html#cb188-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/application.ex</span></span>
<span id="cb188-2"><a href="start-stop-shutdown-and-autostart-trading.html#cb188-2" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb188-3"><a href="start-stop-shutdown-and-autostart-trading.html#cb188-3" tabindex="-1"></a>    children <span class="op">=</span> <span class="ot">[</span></span>
<span id="cb188-4"><a href="start-stop-shutdown-and-autostart-trading.html#cb188-4" tabindex="-1"></a>      <span class="fu">{</span><span class="cn">Naive</span><span class="op">.</span><span class="cn">Repo</span>, <span class="ot">[]</span><span class="fu">}</span>,</span>
<span id="cb188-5"><a href="start-stop-shutdown-and-autostart-trading.html#cb188-5" tabindex="-1"></a>      <span class="fu">{</span><span class="cn">Naive</span><span class="op">.</span><span class="cn">DynamicSymbolSupervisor</span>, <span class="ot">[]</span><span class="fu">}</span> <span class="co"># &lt;= replacement of DynamicSupervisor</span></span>
<span id="cb188-6"><a href="start-stop-shutdown-and-autostart-trading.html#cb188-6" tabindex="-1"></a>    <span class="ot">]</span></span></code></pre></div>
<ul>
<li>we need to replace the <code>start_trading/1</code> implementation inside the <code>Naive</code> module to <code>defdelegate</code> macro(as we don’t have any logic to run there):</li>
</ul>
<div class="sourceCode" id="cb189"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb189-1"><a href="start-stop-shutdown-and-autostart-trading.html#cb189-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive.ex</span></span>
<span id="cb189-2"><a href="start-stop-shutdown-and-autostart-trading.html#cb189-2" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb189-3"><a href="start-stop-shutdown-and-autostart-trading.html#cb189-3" tabindex="-1"></a>  <span class="im">alias</span> <span class="cn">Naive</span><span class="op">.</span><span class="cn">DynamicSymbolSupervisor</span></span>
<span id="cb189-4"><a href="start-stop-shutdown-and-autostart-trading.html#cb189-4" tabindex="-1"></a></span>
<span id="cb189-5"><a href="start-stop-shutdown-and-autostart-trading.html#cb189-5" tabindex="-1"></a>  <span class="kw">defdelegate</span> start_trading<span class="fu">(</span>symbol<span class="fu">)</span>, <span class="va">to:</span> <span class="cn">DynamicSymbolSupervisor</span></span>
<span id="cb189-6"><a href="start-stop-shutdown-and-autostart-trading.html#cb189-6" tabindex="-1"></a><span class="op">...</span></span></code></pre></div>
<p>At this moment we are again able to use the <code>Naive.start_trading/1</code> function to start trading on a symbol (behind the scenes it will use logic from the new <code>Naive.DynamicSymbolSupervisor</code> module).</p>
</div>
<div id="implement-the-stop-trading-functionality" class="section level2 hasAnchor" number="12.4">
<h2><span class="header-section-number">12.4</span> Implement the stop trading functionality<a href="start-stop-shutdown-and-autostart-trading.html#implement-the-stop-trading-functionality" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Stop trading will require a change in two places, first inside the <code>Naive.DynamicSymbolSupervisor</code> where we will place the termination logic:</p>
<div class="sourceCode" id="cb190"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb190-1"><a href="start-stop-shutdown-and-autostart-trading.html#cb190-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/dynamic_symbol_supervisor.ex</span></span>
<span id="cb190-2"><a href="start-stop-shutdown-and-autostart-trading.html#cb190-2" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb190-3"><a href="start-stop-shutdown-and-autostart-trading.html#cb190-3" tabindex="-1"></a>  <span class="kw">def</span> stop_trading<span class="fu">(</span>symbol<span class="fu">)</span> <span class="kw">when</span> is_binary<span class="fu">(</span>symbol<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb190-4"><a href="start-stop-shutdown-and-autostart-trading.html#cb190-4" tabindex="-1"></a>    symbol <span class="op">=</span> <span class="cn">String</span><span class="op">.</span>upcase<span class="fu">(</span>symbol<span class="fu">)</span></span>
<span id="cb190-5"><a href="start-stop-shutdown-and-autostart-trading.html#cb190-5" tabindex="-1"></a></span>
<span id="cb190-6"><a href="start-stop-shutdown-and-autostart-trading.html#cb190-6" tabindex="-1"></a>    <span class="kw">case</span> get_pid<span class="fu">(</span>symbol<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb190-7"><a href="start-stop-shutdown-and-autostart-trading.html#cb190-7" tabindex="-1"></a>      <span class="cn">nil</span> <span class="op">-&gt;</span></span>
<span id="cb190-8"><a href="start-stop-shutdown-and-autostart-trading.html#cb190-8" tabindex="-1"></a>        <span class="cn">Logger</span><span class="op">.</span>warn<span class="fu">(</span><span class="st">&quot;Trading on </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st"> already stopped&quot;</span><span class="fu">)</span></span>
<span id="cb190-9"><a href="start-stop-shutdown-and-autostart-trading.html#cb190-9" tabindex="-1"></a>        <span class="fu">{</span><span class="va">:ok</span>, _settings<span class="fu">}</span> <span class="op">=</span> update_trading_status<span class="fu">(</span>symbol, <span class="st">&quot;off&quot;</span><span class="fu">)</span></span>
<span id="cb190-10"><a href="start-stop-shutdown-and-autostart-trading.html#cb190-10" tabindex="-1"></a></span>
<span id="cb190-11"><a href="start-stop-shutdown-and-autostart-trading.html#cb190-11" tabindex="-1"></a>      pid <span class="op">-&gt;</span></span>
<span id="cb190-12"><a href="start-stop-shutdown-and-autostart-trading.html#cb190-12" tabindex="-1"></a>        <span class="cn">Logger</span><span class="op">.</span>info<span class="fu">(</span><span class="st">&quot;Stopping trading of </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st">&quot;</span><span class="fu">)</span></span>
<span id="cb190-13"><a href="start-stop-shutdown-and-autostart-trading.html#cb190-13" tabindex="-1"></a></span>
<span id="cb190-14"><a href="start-stop-shutdown-and-autostart-trading.html#cb190-14" tabindex="-1"></a>        <span class="va">:ok</span> <span class="op">=</span></span>
<span id="cb190-15"><a href="start-stop-shutdown-and-autostart-trading.html#cb190-15" tabindex="-1"></a>          <span class="cn">DynamicSupervisor</span><span class="op">.</span>terminate_child<span class="fu">(</span></span>
<span id="cb190-16"><a href="start-stop-shutdown-and-autostart-trading.html#cb190-16" tabindex="-1"></a>            <span class="cn">Naive</span><span class="op">.</span><span class="cn">DynamicSymbolSupervisor</span>,</span>
<span id="cb190-17"><a href="start-stop-shutdown-and-autostart-trading.html#cb190-17" tabindex="-1"></a>            pid</span>
<span id="cb190-18"><a href="start-stop-shutdown-and-autostart-trading.html#cb190-18" tabindex="-1"></a>          <span class="fu">)</span></span>
<span id="cb190-19"><a href="start-stop-shutdown-and-autostart-trading.html#cb190-19" tabindex="-1"></a></span>
<span id="cb190-20"><a href="start-stop-shutdown-and-autostart-trading.html#cb190-20" tabindex="-1"></a>        <span class="fu">{</span><span class="va">:ok</span>, _settings<span class="fu">}</span> <span class="op">=</span> update_trading_status<span class="fu">(</span>symbol, <span class="st">&quot;off&quot;</span><span class="fu">)</span></span>
<span id="cb190-21"><a href="start-stop-shutdown-and-autostart-trading.html#cb190-21" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb190-22"><a href="start-stop-shutdown-and-autostart-trading.html#cb190-22" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb190-23"><a href="start-stop-shutdown-and-autostart-trading.html#cb190-23" tabindex="-1"></a>  <span class="op">...</span></span></code></pre></div>
<p>The second change we need to make is to create a forwarding interface using <code>defdelegate</code> inside the <code>Naive</code> module:</p>
<div class="sourceCode" id="cb191"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb191-1"><a href="start-stop-shutdown-and-autostart-trading.html#cb191-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive.ex</span></span>
<span id="cb191-2"><a href="start-stop-shutdown-and-autostart-trading.html#cb191-2" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb191-3"><a href="start-stop-shutdown-and-autostart-trading.html#cb191-3" tabindex="-1"></a>  <span class="kw">defdelegate</span> stop_trading<span class="fu">(</span>symbol<span class="fu">)</span>, <span class="va">to:</span> <span class="cn">DynamicSymbolSupervisor</span></span>
<span id="cb191-4"><a href="start-stop-shutdown-and-autostart-trading.html#cb191-4" tabindex="-1"></a>  <span class="op">...</span></span></code></pre></div>
<p>That pretty much finishes the <code>stop_trading/1</code> functionality. We are now able to start and stop(what was previously not available) trading on a symbol.</p>
</div>
<div id="implement-the-autostart-trading-functionality" class="section level2 hasAnchor" number="12.5">
<h2><span class="header-section-number">12.5</span> Implement the autostart trading functionality<a href="start-stop-shutdown-and-autostart-trading.html#implement-the-autostart-trading-functionality" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>To implement the autostarting we will need to (in a similar fashion as in the last chapter) add a new supervision level that will be dedicated to supervising the <code>Naive.DynamicSymbolSupervisor</code> and the “autostarting” <code>Task</code>.</p>
<p>Let’s create a new file called <code>supervisor.ex</code> inside the <code>/apps/naive/lib/naive</code> directory and (as in the last chapter) we will add the <code>Naive.DynamicSymbolSupervisor</code> and the <code>Task</code> to its children list. We will also update the supervision strategy to <code>:rest_for_one</code>:</p>
<div class="sourceCode" id="cb192"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb192-1"><a href="start-stop-shutdown-and-autostart-trading.html#cb192-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/supervisor.ex</span></span>
<span id="cb192-2"><a href="start-stop-shutdown-and-autostart-trading.html#cb192-2" tabindex="-1"></a><span class="kw">defmodule</span> <span class="cn">Naive</span><span class="op">.</span><span class="cn">Supervisor</span> <span class="kw">do</span></span>
<span id="cb192-3"><a href="start-stop-shutdown-and-autostart-trading.html#cb192-3" tabindex="-1"></a>  <span class="im">use</span> <span class="cn">Supervisor</span></span>
<span id="cb192-4"><a href="start-stop-shutdown-and-autostart-trading.html#cb192-4" tabindex="-1"></a></span>
<span id="cb192-5"><a href="start-stop-shutdown-and-autostart-trading.html#cb192-5" tabindex="-1"></a>  <span class="kw">def</span> start_link<span class="fu">(</span>init_arg<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb192-6"><a href="start-stop-shutdown-and-autostart-trading.html#cb192-6" tabindex="-1"></a>    <span class="cn">Supervisor</span><span class="op">.</span>start_link<span class="fu">(</span><span class="cn">__MODULE__</span>, init_arg, <span class="va">name:</span> <span class="cn">__MODULE__</span><span class="fu">)</span></span>
<span id="cb192-7"><a href="start-stop-shutdown-and-autostart-trading.html#cb192-7" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb192-8"><a href="start-stop-shutdown-and-autostart-trading.html#cb192-8" tabindex="-1"></a></span>
<span id="cb192-9"><a href="start-stop-shutdown-and-autostart-trading.html#cb192-9" tabindex="-1"></a>  <span class="kw">def</span> init<span class="fu">(</span>_init_arg<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb192-10"><a href="start-stop-shutdown-and-autostart-trading.html#cb192-10" tabindex="-1"></a>    children <span class="op">=</span> <span class="ot">[</span></span>
<span id="cb192-11"><a href="start-stop-shutdown-and-autostart-trading.html#cb192-11" tabindex="-1"></a>      <span class="fu">{</span><span class="cn">Naive</span><span class="op">.</span><span class="cn">DynamicSymbolSupervisor</span>, <span class="ot">[]</span><span class="fu">}</span>,                 <span class="co"># &lt;= added</span></span>
<span id="cb192-12"><a href="start-stop-shutdown-and-autostart-trading.html#cb192-12" tabindex="-1"></a>      <span class="fu">{</span><span class="cn">Task</span>,                                               <span class="co"># &lt;= added</span></span>
<span id="cb192-13"><a href="start-stop-shutdown-and-autostart-trading.html#cb192-13" tabindex="-1"></a>       <span class="kw">fn</span> <span class="op">-&gt;</span>                                               <span class="co"># &lt;= added</span></span>
<span id="cb192-14"><a href="start-stop-shutdown-and-autostart-trading.html#cb192-14" tabindex="-1"></a>         <span class="cn">Naive</span><span class="op">.</span><span class="cn">DynamicSymbolSupervisor</span><span class="op">.</span>autostart_trading<span class="fu">()</span> <span class="co"># &lt;= added</span></span>
<span id="cb192-15"><a href="start-stop-shutdown-and-autostart-trading.html#cb192-15" tabindex="-1"></a>       <span class="kw">end</span><span class="fu">}</span>                                                <span class="co"># &lt;= added</span></span>
<span id="cb192-16"><a href="start-stop-shutdown-and-autostart-trading.html#cb192-16" tabindex="-1"></a>    <span class="ot">]</span></span>
<span id="cb192-17"><a href="start-stop-shutdown-and-autostart-trading.html#cb192-17" tabindex="-1"></a></span>
<span id="cb192-18"><a href="start-stop-shutdown-and-autostart-trading.html#cb192-18" tabindex="-1"></a>    <span class="cn">Supervisor</span><span class="op">.</span>init<span class="fu">(</span>children, <span class="va">strategy:</span> <span class="va">:rest_for_one</span><span class="fu">)</span> <span class="co"># &lt;= strategy updated</span></span>
<span id="cb192-19"><a href="start-stop-shutdown-and-autostart-trading.html#cb192-19" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb192-20"><a href="start-stop-shutdown-and-autostart-trading.html#cb192-20" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<p>Now we need to swap the <code>Naive.DynamicSymbolSupervisor</code> to <code>Naive.Supervisor</code> in the <code>children</code> list of the <code>Naive.Application</code>, as well as update the registered process’ name of the <code>Naive.Application</code>:</p>
<div class="sourceCode" id="cb193"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb193-1"><a href="start-stop-shutdown-and-autostart-trading.html#cb193-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/application.ex</span></span>
<span id="cb193-2"><a href="start-stop-shutdown-and-autostart-trading.html#cb193-2" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb193-3"><a href="start-stop-shutdown-and-autostart-trading.html#cb193-3" tabindex="-1"></a>  <span class="kw">def</span> start<span class="fu">(</span>_type, _args<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb193-4"><a href="start-stop-shutdown-and-autostart-trading.html#cb193-4" tabindex="-1"></a>    children <span class="op">=</span> <span class="ot">[</span></span>
<span id="cb193-5"><a href="start-stop-shutdown-and-autostart-trading.html#cb193-5" tabindex="-1"></a>      <span class="fu">{</span><span class="cn">Naive</span><span class="op">.</span><span class="cn">Repo</span>, <span class="ot">[]</span><span class="fu">}</span>,</span>
<span id="cb193-6"><a href="start-stop-shutdown-and-autostart-trading.html#cb193-6" tabindex="-1"></a>      <span class="fu">{</span><span class="cn">Naive</span><span class="op">.</span><span class="cn">Supervisor</span>, <span class="ot">[]</span><span class="fu">}</span> <span class="co"># &lt;= replacement for DynamicSymbolSupervisor</span></span>
<span id="cb193-7"><a href="start-stop-shutdown-and-autostart-trading.html#cb193-7" tabindex="-1"></a>    <span class="ot">]</span></span>
<span id="cb193-8"><a href="start-stop-shutdown-and-autostart-trading.html#cb193-8" tabindex="-1"></a></span>
<span id="cb193-9"><a href="start-stop-shutdown-and-autostart-trading.html#cb193-9" tabindex="-1"></a>    opts <span class="op">=</span> <span class="ot">[</span><span class="va">strategy:</span> <span class="va">:one_for_one</span>, <span class="va">name:</span> <span class="cn">Naive</span><span class="op">.</span><span class="cn">Application</span><span class="ot">]</span> <span class="co"># &lt;= name updated</span></span></code></pre></div>
<div style="page-break-after: always;"></div>
<p>Finally, we need to implement <code>autostart_trading/0</code> inside the <code>Naive.DynamicSymbolSupervisor</code> module as our new <code>Task</code> refers to it:</p>
<div class="sourceCode" id="cb194"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb194-1"><a href="start-stop-shutdown-and-autostart-trading.html#cb194-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/dynamic_symbol_supervisor.ex</span></span>
<span id="cb194-2"><a href="start-stop-shutdown-and-autostart-trading.html#cb194-2" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb194-3"><a href="start-stop-shutdown-and-autostart-trading.html#cb194-3" tabindex="-1"></a>  <span class="co"># add the below function after the `init/1` function</span></span>
<span id="cb194-4"><a href="start-stop-shutdown-and-autostart-trading.html#cb194-4" tabindex="-1"></a>  <span class="kw">def</span> autostart_trading <span class="kw">do</span></span>
<span id="cb194-5"><a href="start-stop-shutdown-and-autostart-trading.html#cb194-5" tabindex="-1"></a>    fetch_symbols_to_trade<span class="fu">()</span></span>
<span id="cb194-6"><a href="start-stop-shutdown-and-autostart-trading.html#cb194-6" tabindex="-1"></a>    <span class="op">|&gt;</span> <span class="cn">Enum</span><span class="op">.</span>map<span class="fu">(</span><span class="op">&amp;</span>start_trading<span class="op">/</span><span class="dv">1</span><span class="fu">)</span></span>
<span id="cb194-7"><a href="start-stop-shutdown-and-autostart-trading.html#cb194-7" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb194-8"><a href="start-stop-shutdown-and-autostart-trading.html#cb194-8" tabindex="-1"></a> </span>
<span id="cb194-9"><a href="start-stop-shutdown-and-autostart-trading.html#cb194-9" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb194-10"><a href="start-stop-shutdown-and-autostart-trading.html#cb194-10" tabindex="-1"></a></span>
<span id="cb194-11"><a href="start-stop-shutdown-and-autostart-trading.html#cb194-11" tabindex="-1"></a>  <span class="co"># and this helper at the end of the module</span></span>
<span id="cb194-12"><a href="start-stop-shutdown-and-autostart-trading.html#cb194-12" tabindex="-1"></a>  <span class="kw">defp</span> fetch_symbols_to_trade <span class="kw">do</span></span>
<span id="cb194-13"><a href="start-stop-shutdown-and-autostart-trading.html#cb194-13" tabindex="-1"></a>    <span class="cn">Repo</span><span class="op">.</span>all<span class="fu">(</span></span>
<span id="cb194-14"><a href="start-stop-shutdown-and-autostart-trading.html#cb194-14" tabindex="-1"></a>      from<span class="fu">(</span>s <span class="kw">in</span> <span class="cn">Settings</span>,</span>
<span id="cb194-15"><a href="start-stop-shutdown-and-autostart-trading.html#cb194-15" tabindex="-1"></a>        <span class="va">where:</span> s<span class="op">.</span>status <span class="op">==</span> <span class="st">&quot;on&quot;</span>,</span>
<span id="cb194-16"><a href="start-stop-shutdown-and-autostart-trading.html#cb194-16" tabindex="-1"></a>        <span class="va">select:</span> s<span class="op">.</span>symbol</span>
<span id="cb194-17"><a href="start-stop-shutdown-and-autostart-trading.html#cb194-17" tabindex="-1"></a>      <span class="fu">)</span></span>
<span id="cb194-18"><a href="start-stop-shutdown-and-autostart-trading.html#cb194-18" tabindex="-1"></a>    <span class="fu">)</span></span>
<span id="cb194-19"><a href="start-stop-shutdown-and-autostart-trading.html#cb194-19" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb194-20"><a href="start-stop-shutdown-and-autostart-trading.html#cb194-20" tabindex="-1"></a>  <span class="op">...</span></span></code></pre></div>
<p>Those are the same (excluding updated function names) as inside the <code>streamer</code> application. We are fetching enabled symbols and starting new <code>Naive.SymbolSupervisor</code> processes for each one.</p>
<p>At this moment we can already see our implementation in action:</p>
<p><img src="images/chapter_12_01_autostarting_sup_tree.png" width="100%" style="display: block; margin: auto;" /></p>
<p>At this moment we are able to test the current implementation inside the IEx:</p>
<div class="sourceCode" id="cb195"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb195-1"><a href="start-stop-shutdown-and-autostart-trading.html#cb195-1" tabindex="-1"></a><span class="ex">$</span> iex <span class="at">-S</span> mix</span>
<span id="cb195-2"><a href="start-stop-shutdown-and-autostart-trading.html#cb195-2" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb195-3"><a href="start-stop-shutdown-and-autostart-trading.html#cb195-3" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">1</span><span class="kw">)</span><span class="op">&gt;</span> Naive.start_trading<span class="kw">(</span><span class="st">&quot;ethusdt&quot;</span><span class="kw">)</span></span>
<span id="cb195-4"><a href="start-stop-shutdown-and-autostart-trading.html#cb195-4" tabindex="-1"></a><span class="ex">21:35:30.207</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span>  Starting trading of ETHUSDT</span>
<span id="cb195-5"><a href="start-stop-shutdown-and-autostart-trading.html#cb195-5" tabindex="-1"></a><span class="ex">21:35:30.261</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span>  Starting new supervision tree to trade on ETHUSDT</span>
<span id="cb195-6"><a href="start-stop-shutdown-and-autostart-trading.html#cb195-6" tabindex="-1"></a><span class="ex">{:ok,</span> <span class="co">#PID&lt;0.372.0&gt;}</span></span>
<span id="cb195-7"><a href="start-stop-shutdown-and-autostart-trading.html#cb195-7" tabindex="-1"></a><span class="ex">21:35:33.344</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span>  Initializing new trader<span class="er">(</span><span class="ex">1612647333342</span><span class="kw">)</span> <span class="cf">for</span> ETHUSDT</span>
<span id="cb195-8"><a href="start-stop-shutdown-and-autostart-trading.html#cb195-8" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">3</span><span class="kw">)</span><span class="op">&gt;</span> Naive.start_trading<span class="kw">(</span><span class="st">&quot;neousdt&quot;</span><span class="kw">)</span>    </span>
<span id="cb195-9"><a href="start-stop-shutdown-and-autostart-trading.html#cb195-9" tabindex="-1"></a><span class="ex">21:35:54.128</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span>  Starting trading of NEOUSDT</span>
<span id="cb195-10"><a href="start-stop-shutdown-and-autostart-trading.html#cb195-10" tabindex="-1"></a><span class="ex">21:35:54.169</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span>  Starting new supervision tree to trade on NEOUSDT</span>
<span id="cb195-11"><a href="start-stop-shutdown-and-autostart-trading.html#cb195-11" tabindex="-1"></a><span class="ex">{:ok,</span> <span class="co">#PID&lt;0.383.0&gt;}</span></span>
<span id="cb195-12"><a href="start-stop-shutdown-and-autostart-trading.html#cb195-12" tabindex="-1"></a><span class="ex">21:35:56.007</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span>  Initializing new trader<span class="er">(</span><span class="ex">1612647356007</span><span class="kw">)</span> <span class="cf">for</span> NEOUSDT</span>
<span id="cb195-13"><a href="start-stop-shutdown-and-autostart-trading.html#cb195-13" tabindex="-1"></a><span class="ex">21:38:07.699</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span>  Stopping trading of NEOUSDT</span>
<span id="cb195-14"><a href="start-stop-shutdown-and-autostart-trading.html#cb195-14" tabindex="-1"></a><span class="ex">{:ok,</span></span>
<span id="cb195-15"><a href="start-stop-shutdown-and-autostart-trading.html#cb195-15" tabindex="-1"></a> <span class="ex">%Naive.Schema.Settings{</span></span>
<span id="cb195-16"><a href="start-stop-shutdown-and-autostart-trading.html#cb195-16" tabindex="-1"></a>     <span class="ex">...</span></span>
<span id="cb195-17"><a href="start-stop-shutdown-and-autostart-trading.html#cb195-17" tabindex="-1"></a> <span class="er">}}</span></span></code></pre></div>
<p>We can now exit the IEx and start a new one:</p>
<div class="sourceCode" id="cb196"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb196-1"><a href="start-stop-shutdown-and-autostart-trading.html#cb196-1" tabindex="-1"></a><span class="ex">$</span> iex <span class="at">-S</span> mix</span>
<span id="cb196-2"><a href="start-stop-shutdown-and-autostart-trading.html#cb196-2" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb196-3"><a href="start-stop-shutdown-and-autostart-trading.html#cb196-3" tabindex="-1"></a><span class="ex">21:39:16.894</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span>  Starting trading of ETHUSDT</span>
<span id="cb196-4"><a href="start-stop-shutdown-and-autostart-trading.html#cb196-4" tabindex="-1"></a><span class="ex">21:39:16.938</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span>  Starting new supervision tree to trade on ETHUSDT</span>
<span id="cb196-5"><a href="start-stop-shutdown-and-autostart-trading.html#cb196-5" tabindex="-1"></a><span class="ex">21:39:18.786</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span>  Initializing new trader<span class="er">(</span><span class="ex">1612647558784</span><span class="kw">)</span> <span class="cf">for</span> ETHUSDT</span>
<span id="cb196-6"><a href="start-stop-shutdown-and-autostart-trading.html#cb196-6" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">1</span><span class="kw">)</span><span class="op">&gt;</span></span></code></pre></div>
<p>The above logs confirm that the <code>naive</code> application autostarts the previously enabled symbols(using the <code>start_trading/1</code> function) as well as <code>stop_trading/1</code> updates the status inside the database (so the symbol isn’t autostarted at the next initialization).</p>
</div>
<div id="implement-the-shutdown-trading-functionality" class="section level2 hasAnchor" number="12.6">
<h2><span class="header-section-number">12.6</span> Implement the shutdown trading functionality<a href="start-stop-shutdown-and-autostart-trading.html#implement-the-shutdown-trading-functionality" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Last but not least, we will move on to the <code>shutdown_trading/1</code> functionality. Let’s start with the simplest part which is delegating the function call to the <code>Naive.DynamicSymbolSupervisor</code> module from the <code>Naive</code> module(interface):</p>
<div class="sourceCode" id="cb197"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb197-1"><a href="start-stop-shutdown-and-autostart-trading.html#cb197-1" tabindex="-1"></a>  <span class="co"># /apps/naive/lib/naive.ex</span></span>
<span id="cb197-2"><a href="start-stop-shutdown-and-autostart-trading.html#cb197-2" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb197-3"><a href="start-stop-shutdown-and-autostart-trading.html#cb197-3" tabindex="-1"></a>  <span class="kw">defdelegate</span> shutdown_trading<span class="fu">(</span>symbol<span class="fu">)</span>, <span class="va">to:</span> <span class="cn">DynamicSymbolSupervisor</span></span>
<span id="cb197-4"><a href="start-stop-shutdown-and-autostart-trading.html#cb197-4" tabindex="-1"></a>  <span class="op">...</span></span></code></pre></div>
<p>Next, we will create a <code>shutdown_trading/1</code> function inside the <code>Naive.DynamicSymbolSupervisor</code> module where we will check is there any trading going on for that symbol(the same as for start/stop), and in case of trading happening we will inform the <code>Naive.Leader</code> process handling that symbol that settings have been updated:</p>
<div class="sourceCode" id="cb198"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb198-1"><a href="start-stop-shutdown-and-autostart-trading.html#cb198-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/dynamic_symbol_supervisor.ex</span></span>
<span id="cb198-2"><a href="start-stop-shutdown-and-autostart-trading.html#cb198-2" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb198-3"><a href="start-stop-shutdown-and-autostart-trading.html#cb198-3" tabindex="-1"></a>  <span class="kw">def</span> shutdown_trading<span class="fu">(</span>symbol<span class="fu">)</span> <span class="kw">when</span> is_binary<span class="fu">(</span>symbol<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb198-4"><a href="start-stop-shutdown-and-autostart-trading.html#cb198-4" tabindex="-1"></a>    symbol <span class="op">=</span> <span class="cn">String</span><span class="op">.</span>upcase<span class="fu">(</span>symbol<span class="fu">)</span></span>
<span id="cb198-5"><a href="start-stop-shutdown-and-autostart-trading.html#cb198-5" tabindex="-1"></a></span>
<span id="cb198-6"><a href="start-stop-shutdown-and-autostart-trading.html#cb198-6" tabindex="-1"></a>    <span class="kw">case</span> get_pid<span class="fu">(</span>symbol<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb198-7"><a href="start-stop-shutdown-and-autostart-trading.html#cb198-7" tabindex="-1"></a>      <span class="cn">nil</span> <span class="op">-&gt;</span></span>
<span id="cb198-8"><a href="start-stop-shutdown-and-autostart-trading.html#cb198-8" tabindex="-1"></a>        <span class="cn">Logger</span><span class="op">.</span>warn<span class="fu">(</span><span class="st">&quot;Trading on </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st"> already stopped&quot;</span><span class="fu">)</span></span>
<span id="cb198-9"><a href="start-stop-shutdown-and-autostart-trading.html#cb198-9" tabindex="-1"></a>        <span class="fu">{</span><span class="va">:ok</span>, _settings<span class="fu">}</span> <span class="op">=</span> update_trading_status<span class="fu">(</span>symbol, <span class="st">&quot;off&quot;</span><span class="fu">)</span></span>
<span id="cb198-10"><a href="start-stop-shutdown-and-autostart-trading.html#cb198-10" tabindex="-1"></a></span>
<span id="cb198-11"><a href="start-stop-shutdown-and-autostart-trading.html#cb198-11" tabindex="-1"></a>      _pid <span class="op">-&gt;</span></span>
<span id="cb198-12"><a href="start-stop-shutdown-and-autostart-trading.html#cb198-12" tabindex="-1"></a>        <span class="cn">Logger</span><span class="op">.</span>info<span class="fu">(</span><span class="st">&quot;Shutdown of trading on </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st"> initialized&quot;</span><span class="fu">)</span></span>
<span id="cb198-13"><a href="start-stop-shutdown-and-autostart-trading.html#cb198-13" tabindex="-1"></a>        <span class="fu">{</span><span class="va">:ok</span>, settings<span class="fu">}</span> <span class="op">=</span> update_trading_status<span class="fu">(</span>symbol, <span class="st">&quot;shutdown&quot;</span><span class="fu">)</span></span>
<span id="cb198-14"><a href="start-stop-shutdown-and-autostart-trading.html#cb198-14" tabindex="-1"></a>        <span class="cn">Naive</span><span class="op">.</span><span class="cn">Leader</span><span class="op">.</span>notify<span class="fu">(</span><span class="va">:settings_updated</span>, settings<span class="fu">)</span></span>
<span id="cb198-15"><a href="start-stop-shutdown-and-autostart-trading.html#cb198-15" tabindex="-1"></a>        <span class="fu">{</span><span class="va">:ok</span>, settings<span class="fu">}</span></span>
<span id="cb198-16"><a href="start-stop-shutdown-and-autostart-trading.html#cb198-16" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb198-17"><a href="start-stop-shutdown-and-autostart-trading.html#cb198-17" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb198-18"><a href="start-stop-shutdown-and-autostart-trading.html#cb198-18" tabindex="-1"></a>  <span class="op">...</span></span></code></pre></div>
<p>The crucial part of the implementation above is the <code>notify(:settings_updated, settings)</code> where we inform the <code>Naive.Leader</code> process that it needs to update trading settings.</p>
<p>Currently, the <code>Naive.Leader</code> module does <em>not</em> support updating the settings after startup - let’s add a new interface function together with a callback function that will handle settings updating:</p>
<div class="sourceCode" id="cb199"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb199-1"><a href="start-stop-shutdown-and-autostart-trading.html#cb199-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/leader.ex</span></span>
<span id="cb199-2"><a href="start-stop-shutdown-and-autostart-trading.html#cb199-2" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb199-3"><a href="start-stop-shutdown-and-autostart-trading.html#cb199-3" tabindex="-1"></a>  <span class="co"># add the below function as the last clause of the `notify` function</span></span>
<span id="cb199-4"><a href="start-stop-shutdown-and-autostart-trading.html#cb199-4" tabindex="-1"></a>  <span class="kw">def</span> notify<span class="fu">(</span><span class="va">:settings_updated</span>, settings<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb199-5"><a href="start-stop-shutdown-and-autostart-trading.html#cb199-5" tabindex="-1"></a>    <span class="cn">GenServer</span><span class="op">.</span>call<span class="fu">(</span></span>
<span id="cb199-6"><a href="start-stop-shutdown-and-autostart-trading.html#cb199-6" tabindex="-1"></a>      :<span class="st">&quot;</span><span class="ot">#{</span><span class="cn">__MODULE__</span><span class="ot">}</span><span class="st">-</span><span class="ot">#{</span>settings<span class="op">.</span>symbol<span class="ot">}</span><span class="st">&quot;</span>,</span>
<span id="cb199-7"><a href="start-stop-shutdown-and-autostart-trading.html#cb199-7" tabindex="-1"></a>      <span class="fu">{</span><span class="va">:update_settings</span>, settings<span class="fu">}</span></span>
<span id="cb199-8"><a href="start-stop-shutdown-and-autostart-trading.html#cb199-8" tabindex="-1"></a>    <span class="fu">)</span></span>
<span id="cb199-9"><a href="start-stop-shutdown-and-autostart-trading.html#cb199-9" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb199-10"><a href="start-stop-shutdown-and-autostart-trading.html#cb199-10" tabindex="-1"></a></span>
<span id="cb199-11"><a href="start-stop-shutdown-and-autostart-trading.html#cb199-11" tabindex="-1"></a>  <span class="co"># add the below handler function as the last clause of `handle_call` function</span></span>
<span id="cb199-12"><a href="start-stop-shutdown-and-autostart-trading.html#cb199-12" tabindex="-1"></a>  <span class="kw">def</span> handle_call<span class="fu">(</span></span>
<span id="cb199-13"><a href="start-stop-shutdown-and-autostart-trading.html#cb199-13" tabindex="-1"></a>        <span class="fu">{</span><span class="va">:update_settings</span>, new_settings<span class="fu">}</span>,</span>
<span id="cb199-14"><a href="start-stop-shutdown-and-autostart-trading.html#cb199-14" tabindex="-1"></a>        _,</span>
<span id="cb199-15"><a href="start-stop-shutdown-and-autostart-trading.html#cb199-15" tabindex="-1"></a>        state</span>
<span id="cb199-16"><a href="start-stop-shutdown-and-autostart-trading.html#cb199-16" tabindex="-1"></a>      <span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb199-17"><a href="start-stop-shutdown-and-autostart-trading.html#cb199-17" tabindex="-1"></a>    <span class="fu">{</span><span class="va">:reply</span>, <span class="va">:ok</span>, %<span class="fu">{</span>state <span class="op">|</span> <span class="va">settings:</span> new_settings<span class="fu">}}</span></span>
<span id="cb199-18"><a href="start-stop-shutdown-and-autostart-trading.html#cb199-18" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>Ok, we have a way to update the settings of the <code>Naive.Leader</code> process “on the go” but what effects should the <code>shutdown</code> state have on the <code>Naive.Leader</code>’s actions?</p>
<p>There are two places that require modification:</p>
<ul>
<li>whenever the <code>Naive.Trader</code> process will finish the trade cycle, <code>Naive.Leader</code> process should <em>not</em> start a new one, as well as check, was that the last trader process and if that was the case it needs to call the <code>Naive.stop_trading/1</code> function with its symbol to terminate whole supervision tree for that symbol</li>
<li>whenever the <code>Naive.Leader</code> process will receive a <code>rebuy</code> notification, it should just ignore it when the symbol is in the <code>shutdown</code> state.</li>
</ul>
<p>Let’s look at the updated implementation of the “end of trade” handler:</p>
<div class="sourceCode" id="cb200"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb200-1"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/leader.ex</span></span>
<span id="cb200-2"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-2" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb200-3"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-3" tabindex="-1"></a>  <span class="kw">def</span> handle_info<span class="fu">(</span></span>
<span id="cb200-4"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-4" tabindex="-1"></a>        <span class="fu">{</span><span class="va">:DOWN</span>, _ref, <span class="va">:process</span>, trader_pid, <span class="va">:normal</span><span class="fu">}</span>,</span>
<span id="cb200-5"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-5" tabindex="-1"></a>        %<span class="fu">{</span><span class="va">traders:</span> traders, <span class="va">symbol:</span> symbol, <span class="va">settings:</span> settings<span class="fu">}</span> <span class="op">=</span> state</span>
<span id="cb200-6"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-6" tabindex="-1"></a>      <span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb200-7"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-7" tabindex="-1"></a>    <span class="cn">Logger</span><span class="op">.</span>info<span class="fu">(</span><span class="st">&quot;</span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st"> trader finished trade - restarting&quot;</span><span class="fu">)</span></span>
<span id="cb200-8"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-8" tabindex="-1"></a></span>
<span id="cb200-9"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-9" tabindex="-1"></a>    <span class="kw">case</span> <span class="cn">Enum</span><span class="op">.</span>find_index<span class="fu">(</span>traders, <span class="op">&amp;</span><span class="fu">(</span><span class="op">&amp;</span><span class="dv">1</span><span class="op">.</span>pid <span class="op">==</span> trader_pid<span class="fu">))</span> <span class="kw">do</span></span>
<span id="cb200-10"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-10" tabindex="-1"></a>      <span class="cn">nil</span> <span class="op">-&gt;</span></span>
<span id="cb200-11"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-11" tabindex="-1"></a>        <span class="cn">Logger</span><span class="op">.</span>warn<span class="fu">(</span></span>
<span id="cb200-12"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-12" tabindex="-1"></a>          <span class="st">&quot;Tried to restart finished </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st"> &quot;</span> <span class="op">&lt;&gt;</span></span>
<span id="cb200-13"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-13" tabindex="-1"></a>            <span class="st">&quot;trader that leader is not aware of&quot;</span></span>
<span id="cb200-14"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-14" tabindex="-1"></a>        <span class="fu">)</span></span>
<span id="cb200-15"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-15" tabindex="-1"></a></span>
<span id="cb200-16"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-16" tabindex="-1"></a>        <span class="cf">if</span> settings<span class="op">.</span>status <span class="op">==</span> <span class="st">&quot;shutdown&quot;</span> <span class="kw">and</span> traders <span class="op">==</span> <span class="ot">[]</span> <span class="kw">do</span> <span class="co"># &lt;= additional check</span></span>
<span id="cb200-17"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-17" tabindex="-1"></a>          <span class="cn">Naive</span><span class="op">.</span>stop_trading<span class="fu">(</span>state<span class="op">.</span>symbol<span class="fu">)</span></span>
<span id="cb200-18"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-18" tabindex="-1"></a>        <span class="kw">end</span></span>
<span id="cb200-19"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-19" tabindex="-1"></a></span>
<span id="cb200-20"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-20" tabindex="-1"></a>        <span class="fu">{</span><span class="va">:noreply</span>, state<span class="fu">}</span></span>
<span id="cb200-21"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-21" tabindex="-1"></a></span>
<span id="cb200-22"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-22" tabindex="-1"></a>      index <span class="op">-&gt;</span></span>
<span id="cb200-23"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-23" tabindex="-1"></a>        new_traders <span class="op">=</span></span>
<span id="cb200-24"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-24" tabindex="-1"></a>          <span class="cf">if</span> settings<span class="op">.</span>status <span class="op">==</span> <span class="st">&quot;shutdown&quot;</span> <span class="kw">do</span> <span class="co"># &lt;= refactored code</span></span>
<span id="cb200-25"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-25" tabindex="-1"></a>            <span class="cn">Logger</span><span class="op">.</span>warn<span class="fu">(</span></span>
<span id="cb200-26"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-26" tabindex="-1"></a>              <span class="st">&quot;The leader won&#39;t start a new trader on </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st"> &quot;</span> <span class="op">&lt;&gt;</span></span>
<span id="cb200-27"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-27" tabindex="-1"></a>                <span class="st">&quot;as symbol is in the &#39;shutdown&#39; state&quot;</span></span>
<span id="cb200-28"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-28" tabindex="-1"></a>            <span class="fu">)</span></span>
<span id="cb200-29"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-29" tabindex="-1"></a>            </span>
<span id="cb200-30"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-30" tabindex="-1"></a>            <span class="cf">if</span> length<span class="fu">(</span>traders<span class="fu">)</span> <span class="op">==</span> <span class="dv">1</span> <span class="kw">do</span></span>
<span id="cb200-31"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-31" tabindex="-1"></a>              <span class="cn">Naive</span><span class="op">.</span>stop_trading<span class="fu">(</span>state<span class="op">.</span>symbol<span class="fu">)</span></span>
<span id="cb200-32"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-32" tabindex="-1"></a>            <span class="kw">end</span></span>
<span id="cb200-33"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-33" tabindex="-1"></a>            </span>
<span id="cb200-34"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-34" tabindex="-1"></a>            <span class="cn">List</span><span class="op">.</span>delete_at<span class="fu">(</span>traders, index<span class="fu">)</span></span>
<span id="cb200-35"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-35" tabindex="-1"></a>          <span class="cf">else</span></span>
<span id="cb200-36"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-36" tabindex="-1"></a>            new_trader_data <span class="op">=</span> start_new_trader<span class="fu">(</span>fresh_trader_state<span class="fu">(</span>settings<span class="fu">))</span></span>
<span id="cb200-37"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-37" tabindex="-1"></a>            <span class="cn">List</span><span class="op">.</span>replace_at<span class="fu">(</span>traders, index, new_trader_data<span class="fu">)</span></span>
<span id="cb200-38"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-38" tabindex="-1"></a>          <span class="kw">end</span></span>
<span id="cb200-39"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-39" tabindex="-1"></a></span>
<span id="cb200-40"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-40" tabindex="-1"></a>        <span class="fu">{</span><span class="va">:noreply</span>, %<span class="fu">{</span>state <span class="op">|</span> <span class="va">traders:</span> new_traders<span class="fu">}}</span></span>
<span id="cb200-41"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-41" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb200-42"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-42" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb200-43"><a href="start-stop-shutdown-and-autostart-trading.html#cb200-43" tabindex="-1"></a>  <span class="op">...</span></span></code></pre></div>
<p>As visible in the above code, whenever the <code>Naive.Trader</code> process will finish the trade cycle, the <code>Naive.Leader</code> process will check can it find a record of that trader in its state (no changes here). We will modify the callback so the leader process will check the <code>settings.status</code>. In the <code>shutdown</code> status it checks wheater it was the last trader in the <code>traders</code> list, to terminate the whole tree at that time(using the <code>Naive.stop_trading/1</code> function).</p>
<p>The second callback that we need to modify is the <code>rebuy</code> triggered:</p>
<div class="sourceCode" id="cb201"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb201-1"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/leader.ex</span></span>
<span id="cb201-2"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-2" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb201-3"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-3" tabindex="-1"></a>  <span class="kw">def</span> handle_call<span class="fu">(</span></span>
<span id="cb201-4"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-4" tabindex="-1"></a>        <span class="fu">{</span><span class="va">:rebuy_triggered</span>, new_trader_state<span class="fu">}</span>,</span>
<span id="cb201-5"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-5" tabindex="-1"></a>        <span class="fu">{</span>trader_pid, _<span class="fu">}</span>,</span>
<span id="cb201-6"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-6" tabindex="-1"></a>        %<span class="fu">{</span><span class="va">traders:</span> traders, <span class="va">symbol:</span> symbol, <span class="va">settings:</span> settings<span class="fu">}</span> <span class="op">=</span> state</span>
<span id="cb201-7"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-7" tabindex="-1"></a>      <span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb201-8"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-8" tabindex="-1"></a>    <span class="kw">case</span> <span class="cn">Enum</span><span class="op">.</span>find_index<span class="fu">(</span>traders, <span class="op">&amp;</span><span class="fu">(</span><span class="op">&amp;</span><span class="dv">1</span><span class="op">.</span>pid <span class="op">==</span> trader_pid<span class="fu">))</span> <span class="kw">do</span></span>
<span id="cb201-9"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-9" tabindex="-1"></a>      <span class="cn">nil</span> <span class="op">-&gt;</span></span>
<span id="cb201-10"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-10" tabindex="-1"></a>        <span class="cn">Logger</span><span class="op">.</span>warn<span class="fu">(</span><span class="st">&quot;Rebuy triggered by trader that leader is not aware of&quot;</span><span class="fu">)</span></span>
<span id="cb201-11"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-11" tabindex="-1"></a>        <span class="fu">{</span><span class="va">:reply</span>, <span class="va">:ok</span>, state<span class="fu">}</span></span>
<span id="cb201-12"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-12" tabindex="-1"></a></span>
<span id="cb201-13"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-13" tabindex="-1"></a>      index <span class="op">-&gt;</span></span>
<span id="cb201-14"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-14" tabindex="-1"></a>        old_trader_data <span class="op">=</span> <span class="cn">Enum</span><span class="op">.</span>at<span class="fu">(</span>traders, index<span class="fu">)</span></span>
<span id="cb201-15"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-15" tabindex="-1"></a>        new_trader_data <span class="op">=</span> %<span class="fu">{</span>old_trader_data <span class="op">|</span> <span class="va">:state</span> <span class="op">=&gt;</span> new_trader_state<span class="fu">}</span></span>
<span id="cb201-16"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-16" tabindex="-1"></a>        updated_traders <span class="op">=</span> <span class="cn">List</span><span class="op">.</span>replace_at<span class="fu">(</span>traders, index, new_trader_data<span class="fu">)</span></span>
<span id="cb201-17"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-17" tabindex="-1"></a></span>
<span id="cb201-18"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-18" tabindex="-1"></a>        updated_traders <span class="op">=</span></span>
<span id="cb201-19"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-19" tabindex="-1"></a>          <span class="cf">if</span> settings<span class="op">.</span>chunks <span class="op">==</span> length<span class="fu">(</span>traders<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb201-20"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-20" tabindex="-1"></a>            <span class="cn">Logger</span><span class="op">.</span>info<span class="fu">(</span><span class="st">&quot;All traders already started for </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st">&quot;</span><span class="fu">)</span></span>
<span id="cb201-21"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-21" tabindex="-1"></a>            updated_traders</span>
<span id="cb201-22"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-22" tabindex="-1"></a>          <span class="cf">else</span></span>
<span id="cb201-23"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-23" tabindex="-1"></a>            <span class="cf">if</span> settings<span class="op">.</span>status <span class="op">==</span> <span class="st">&quot;shutdown&quot;</span> <span class="kw">do</span></span>
<span id="cb201-24"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-24" tabindex="-1"></a>              <span class="cn">Logger</span><span class="op">.</span>warn<span class="fu">(</span></span>
<span id="cb201-25"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-25" tabindex="-1"></a>                <span class="st">&quot;The leader won&#39;t start a new trader on </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st"> &quot;</span> <span class="op">&lt;&gt;</span></span>
<span id="cb201-26"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-26" tabindex="-1"></a>                  <span class="st">&quot;as symbol is in the &#39;shutdown&#39; state&quot;</span></span>
<span id="cb201-27"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-27" tabindex="-1"></a>              <span class="fu">)</span></span>
<span id="cb201-28"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-28" tabindex="-1"></a></span>
<span id="cb201-29"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-29" tabindex="-1"></a>              updated_traders</span>
<span id="cb201-30"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-30" tabindex="-1"></a>            <span class="cf">else</span></span>
<span id="cb201-31"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-31" tabindex="-1"></a>              <span class="cn">Logger</span><span class="op">.</span>info<span class="fu">(</span><span class="st">&quot;Starting new trader for </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st">&quot;</span><span class="fu">)</span></span>
<span id="cb201-32"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-32" tabindex="-1"></a>              <span class="ot">[</span>start_new_trader<span class="fu">(</span>fresh_trader_state<span class="fu">(</span>settings<span class="fu">))</span> <span class="op">|</span> updated_traders<span class="ot">]</span></span>
<span id="cb201-33"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-33" tabindex="-1"></a>            <span class="kw">end</span></span>
<span id="cb201-34"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-34" tabindex="-1"></a>          <span class="kw">end</span></span>
<span id="cb201-35"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-35" tabindex="-1"></a></span>
<span id="cb201-36"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-36" tabindex="-1"></a>        <span class="fu">{</span><span class="va">:reply</span>, <span class="va">:ok</span>, %<span class="fu">{</span>state <span class="op">|</span> <span class="va">:traders</span> <span class="op">=&gt;</span> updated_traders<span class="fu">}}</span></span>
<span id="cb201-37"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-37" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb201-38"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-38" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb201-39"><a href="start-stop-shutdown-and-autostart-trading.html#cb201-39" tabindex="-1"></a>  <span class="op">...</span></span></code></pre></div>
<p>In the above <code>rebuy_triggered</code> handler function we added branching on the <code>settings.status</code> and we simply ignore the rebuy notification when the symbol is in the <code>shutdown</code> status.</p>
<p>The final change will be to create a new migration that will update the <code>TradingStatusEnum</code> to have a <code>shutdown</code> option:</p>
<div class="sourceCode" id="cb202"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb202-1"><a href="start-stop-shutdown-and-autostart-trading.html#cb202-1" tabindex="-1"></a><span class="ex">$</span> cd apps/naive </span>
<span id="cb202-2"><a href="start-stop-shutdown-and-autostart-trading.html#cb202-2" tabindex="-1"></a><span class="ex">$</span> mix ecto.gen.migration update_trading_status</span>
<span id="cb202-3"><a href="start-stop-shutdown-and-autostart-trading.html#cb202-3" tabindex="-1"></a><span class="ex">*</span> creating priv/repo/migrations/20210205232303_update_trading_status.exs</span></code></pre></div>
<p>Inside the generated migration file we need to excute a raw SQL command:</p>
<div class="sourceCode" id="cb203"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb203-1"><a href="start-stop-shutdown-and-autostart-trading.html#cb203-1" tabindex="-1"></a><span class="co"># /apps/naive/priv/repo/migrations/20210205232303_update_trading_status.exs</span></span>
<span id="cb203-2"><a href="start-stop-shutdown-and-autostart-trading.html#cb203-2" tabindex="-1"></a><span class="kw">defmodule</span> <span class="cn">Naive</span><span class="op">.</span><span class="cn">Repo</span><span class="op">.</span><span class="cn">Migrations</span><span class="op">.</span><span class="cn">UpdateTradingStatus</span> <span class="kw">do</span></span>
<span id="cb203-3"><a href="start-stop-shutdown-and-autostart-trading.html#cb203-3" tabindex="-1"></a>  <span class="im">use</span> <span class="cn">Ecto</span><span class="op">.</span><span class="cn">Migration</span></span>
<span id="cb203-4"><a href="start-stop-shutdown-and-autostart-trading.html#cb203-4" tabindex="-1"></a></span>
<span id="cb203-5"><a href="start-stop-shutdown-and-autostart-trading.html#cb203-5" tabindex="-1"></a>  <span class="ot">@disable_ddl_transaction</span> <span class="cn">true</span></span>
<span id="cb203-6"><a href="start-stop-shutdown-and-autostart-trading.html#cb203-6" tabindex="-1"></a></span>
<span id="cb203-7"><a href="start-stop-shutdown-and-autostart-trading.html#cb203-7" tabindex="-1"></a>  <span class="kw">def</span> change <span class="kw">do</span></span>
<span id="cb203-8"><a href="start-stop-shutdown-and-autostart-trading.html#cb203-8" tabindex="-1"></a>    <span class="cn">Ecto</span><span class="op">.</span><span class="cn">Migration</span><span class="op">.</span>execute <span class="st">&quot;ALTER TYPE trading_status ADD VALUE IF NOT EXISTS &#39;shutdown&#39;&quot;</span></span>
<span id="cb203-9"><a href="start-stop-shutdown-and-autostart-trading.html#cb203-9" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb203-10"><a href="start-stop-shutdown-and-autostart-trading.html#cb203-10" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<p>We need to apply the same change to the <code>Naive.Schema.TradingStatusEnum</code>:</p>
<div class="sourceCode" id="cb204"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb204-1"><a href="start-stop-shutdown-and-autostart-trading.html#cb204-1" tabindex="-1"></a><span class="co"># /apps/naive/lib/naive/schema/trading_status_enum.ex</span></span>
<span id="cb204-2"><a href="start-stop-shutdown-and-autostart-trading.html#cb204-2" tabindex="-1"></a><span class="im">import</span> <span class="cn">EctoEnum</span></span>
<span id="cb204-3"><a href="start-stop-shutdown-and-autostart-trading.html#cb204-3" tabindex="-1"></a></span>
<span id="cb204-4"><a href="start-stop-shutdown-and-autostart-trading.html#cb204-4" tabindex="-1"></a>defenum<span class="fu">(</span><span class="cn">Naive</span><span class="op">.</span><span class="cn">Schema</span><span class="op">.</span><span class="cn">TradingStatusEnum</span>, <span class="va">:trading_status</span>, <span class="ot">[</span><span class="va">:on</span>, <span class="va">:off</span>, <span class="va">:shutdown</span><span class="ot">]</span><span class="fu">)</span></span></code></pre></div>
<p>Don’t forget to run <code>mix ecto.migrate</code> to run the new migration.</p>
<p>We can now test the <code>shutdown_trading/1</code> functionality inside the IEx:</p>
<div class="sourceCode" id="cb205"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb205-1"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-1" tabindex="-1"></a><span class="ex">$</span> iex <span class="at">-S</span> mix</span>
<span id="cb205-2"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-2" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb205-3"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-3" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">1</span><span class="kw">)</span><span class="op">&gt;</span> Streamer.start_streaming<span class="kw">(</span><span class="st">&quot;ethusdt&quot;</span><span class="kw">)</span></span>
<span id="cb205-4"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-4" tabindex="-1"></a><span class="ex">21:46:26.651</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span>  Starting streaming on ETHUSDT</span>
<span id="cb205-5"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-5" tabindex="-1"></a><span class="ex">{:ok,</span> <span class="co">#PID&lt;0.372.0&gt;}</span></span>
<span id="cb205-6"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-6" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">2</span><span class="kw">)</span><span class="op">&gt;</span> Naive.start_trading<span class="kw">(</span><span class="st">&quot;ethusdt&quot;</span><span class="kw">)</span>     </span>
<span id="cb205-7"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-7" tabindex="-1"></a><span class="ex">21:46:42.830</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span>  Starting trading of ETHUSDT</span>
<span id="cb205-8"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-8" tabindex="-1"></a><span class="ex">21:46:42.867</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span>  Starting new supervision tree to trade on ETHUSDT</span>
<span id="cb205-9"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-9" tabindex="-1"></a><span class="ex">{:ok,</span> <span class="co">#PID&lt;0.379.0&gt;}</span></span>
<span id="cb205-10"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-10" tabindex="-1"></a><span class="ex">21:46:44.816</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span>  Initializing new trader<span class="er">(</span><span class="ex">1612648004814</span><span class="kw">)</span> <span class="cf">for</span> ETHUSDT</span>
<span id="cb205-11"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-11" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb205-12"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-12" tabindex="-1"></a><span class="ex">21:47:52.448</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span>  Rebuy triggered for ETHUSDT by the trader<span class="er">(</span><span class="ex">1612648004814</span><span class="kw">)</span></span>
<span id="cb205-13"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-13" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb205-14"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-14" tabindex="-1"></a><span class="ex">21:49:58.900</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span>  Rebuy triggered for ETHUSDT by the trader<span class="er">(</span><span class="ex">1612648089409</span><span class="kw">)</span></span>
<span id="cb205-15"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-15" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb205-16"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-16" tabindex="-1"></a><span class="ex">21:50:58.927</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span>  Rebuy triggered for ETHUSDT by the trader<span class="er">(</span><span class="ex">1612648198900</span><span class="kw">)</span></span>
<span id="cb205-17"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-17" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb205-18"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-18" tabindex="-1"></a><span class="ex">21:53:27.202</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span>  Rebuy triggered for ETHUSDT by the trader<span class="er">(</span><span class="ex">1612648326215</span><span class="kw">)</span></span>
<span id="cb205-19"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-19" tabindex="-1"></a><span class="ex">21:53:27.250</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span>  Rebuy triggered for ETHUSDT by the trader<span class="er">(</span><span class="ex">1612648325512</span><span class="kw">)</span></span>
<span id="cb205-20"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-20" tabindex="-1"></a><span class="ex">21:53:27.250</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span>  All traders already started for ETHUSDT</span>
<span id="cb205-21"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-21" tabindex="-1"></a></span>
<span id="cb205-22"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-22" tabindex="-1"></a><span class="co"># at this moment we have 5 `Naive.Trader` processes trading in parallel</span></span>
<span id="cb205-23"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-23" tabindex="-1"></a></span>
<span id="cb205-24"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-24" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">4</span><span class="kw">)</span><span class="op">&gt;</span> Naive.shutdown_trading<span class="kw">(</span><span class="st">&quot;ethusdt&quot;</span><span class="kw">)</span></span>
<span id="cb205-25"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-25" tabindex="-1"></a><span class="ex">21:55:01.556</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span>  Shutdown of trading on ETHUSDT initialized</span>
<span id="cb205-26"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-26" tabindex="-1"></a><span class="ex">{:ok,</span></span>
<span id="cb205-27"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-27" tabindex="-1"></a> <span class="ex">%Naive.Schema.Settings{</span></span>
<span id="cb205-28"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-28" tabindex="-1"></a>     <span class="ex">...</span></span>
<span id="cb205-29"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-29" tabindex="-1"></a> <span class="er">}}</span></span>
<span id="cb205-30"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-30" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb205-31"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-31" tabindex="-1"></a><span class="ex">22:06:58.855</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span>  Trader<span class="er">(</span><span class="ex">1612648407202</span><span class="kw">)</span> <span class="ex">finished</span> trade cycle for ETHUSDT</span>
<span id="cb205-32"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-32" tabindex="-1"></a><span class="ex">22:06:58.855</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span>  ETHUSDT trader finished trade <span class="at">-</span> restarting</span>
<span id="cb205-33"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-33" tabindex="-1"></a><span class="ex">22:06:58.855</span> <span class="pp">[</span><span class="ss">warn</span><span class="pp">]</span>  The leader won<span class="st">&#39;t start a new trader on ETHUSDTas symbol is in</span></span>
<span id="cb205-34"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-34" tabindex="-1"></a><span class="st">shutdown state</span></span>
<span id="cb205-35"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-35" tabindex="-1"></a><span class="st">22:07:50.768 [info]  Trader(1612648325512) finished trade cycle for ETHUSDT</span></span>
<span id="cb205-36"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-36" tabindex="-1"></a><span class="st">22:07:50.768 [info]  ETHUSDT trader finished trade - restarting</span></span>
<span id="cb205-37"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-37" tabindex="-1"></a><span class="st">22:07:50.768 [warn]  The leader won&#39;</span>t start a new trader on ETHUSDTas symbol is in</span>
<span id="cb205-38"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-38" tabindex="-1"></a><span class="ex">shutdown</span> state</span>
<span id="cb205-39"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-39" tabindex="-1"></a><span class="ex">22:07:50.857</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span>  Trader<span class="er">(</span><span class="ex">1612648326215</span><span class="kw">)</span> <span class="ex">finished</span> trade cycle for ETHUSDT</span>
<span id="cb205-40"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-40" tabindex="-1"></a><span class="ex">22:07:50.857</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span>  ETHUSDT trader finished trade <span class="at">-</span> restarting</span>
<span id="cb205-41"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-41" tabindex="-1"></a><span class="ex">22:07:50.857</span> <span class="pp">[</span><span class="ss">warn</span><span class="pp">]</span>  The leader won<span class="st">&#39;t start a new trader on ETHUSDTas symbol is in</span></span>
<span id="cb205-42"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-42" tabindex="-1"></a><span class="st">shutdown state</span></span>
<span id="cb205-43"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-43" tabindex="-1"></a><span class="st">22:07:51.079 [info]  Trader(1612648089409) finished trade cycle for ETHUSDT</span></span>
<span id="cb205-44"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-44" tabindex="-1"></a><span class="st">22:07:51.079 [info]  ETHUSDT trader finished trade - restarting</span></span>
<span id="cb205-45"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-45" tabindex="-1"></a><span class="st">22:07:51.079 [warn]  The leader won&#39;</span>t start a new trader on ETHUSDTas symbol is in</span>
<span id="cb205-46"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-46" tabindex="-1"></a><span class="ex">shutdown</span> state</span>
<span id="cb205-47"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-47" tabindex="-1"></a><span class="ex">22:08:05.401</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span>  Trader<span class="er">(</span><span class="ex">1612648004814</span><span class="kw">)</span> <span class="ex">finished</span> trade cycle for ETHUSDT</span>
<span id="cb205-48"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-48" tabindex="-1"></a><span class="ex">22:08:05.401</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span>  ETHUSDT trader finished trade <span class="at">-</span> restarting</span>
<span id="cb205-49"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-49" tabindex="-1"></a><span class="ex">22:08:05.401</span> <span class="pp">[</span><span class="ss">warn</span><span class="pp">]</span>  The leader won<span class="st">&#39;t start a new trader on ETHUSDTas symbol is in</span></span>
<span id="cb205-50"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-50" tabindex="-1"></a><span class="st">shutdown state</span></span>
<span id="cb205-51"><a href="start-stop-shutdown-and-autostart-trading.html#cb205-51" tabindex="-1"></a><span class="st">22:08:05.401 [info]  Stopping trading of ETHUSDT</span></span></code></pre></div>
<p>As we can see from the logs above, our <code>naive</code> strategy grown from 1 to 5 <code>Naive.Trader</code> processes running in parallel, then we called the <code>shutdown_trading/1</code> function. In the <code>shutdown</code> status, the <code>Naive.Leader</code> process ignored <code>rebuy</code> notifications and wasn’t starting any new <code>Naive.Trader</code> processes as the old ones were finishing. At the moment when the last <code>Naive.Trader</code> process finished the trade cycle, the <code>Naive.Leader</code> called <code>stop_trading/1</code> on “it’s” symbol, terminating the whole supervision tree for that symbol.</p>
<p>[Note] Please remember to run the <code>mix format</code> to keep things nice and tidy.</p>
<p>Source code for this chapter can be found at <a href="https://github.com/Cinderella-Man/hands-on-elixir-and-otp-cryptocurrency-trading-bot-source-code/tree/chapter_12">Github</a></p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="supervise-and-autostart-streaming.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="abstract-duplicated-supervision-code.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/Cinderella-Man/hands-on-elixir-and-otp-cryptocurrency-trading-bot/edit/main/12-start-stop-and-autostart-trading.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
