<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 17 Mox rocks | Hands-on Elixir &amp; OTP: Cryptocurrency trading bot</title>
  <meta name="description" content="Chapter 17 Mox rocks | Hands-on Elixir &amp; OTP: Cryptocurrency trading bot" />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 17 Mox rocks | Hands-on Elixir &amp; OTP: Cryptocurrency trading bot" />
  <meta property="og:type" content="book" />
  
  
  
  <meta name="github-repo" content="Cinderella-Man/hands-on-elixir-and-otp-cryptocurrency-trading-bot" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 17 Mox rocks | Hands-on Elixir &amp; OTP: Cryptocurrency trading bot" />
  <meta name="twitter:site" content="@kamilskowron" />
  
  

<meta name="author" content="Kamil Skowron" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="end-to-end-testing.html"/>
<link rel="next" href="functional-elixir.html"/>
<script src="libs/header-attrs-2.8/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-52FKGBX2B8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-52FKGBX2B8');
</script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Hands-on Elixir & OTP: Cryptocurrency trading bot</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#want-to-learn-elixir-otp-by-creating-a-real-world-project"><i class="fa fa-check"></i>Want to learn Elixir &amp; OTP by creating a real-world project?</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#limit-of-liabilitydisclaimer-of-warranty"><i class="fa fa-check"></i>Limit of Liability/Disclaimer of Warranty</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#pdf-epub"><i class="fa fa-check"></i>PDF &amp; EPUB</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#preface-1"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#who-this-book-is-for"><i class="fa fa-check"></i>Who this book is for</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#what-this-book-covers"><i class="fa fa-check"></i>What this book covers</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#contributing-errata-and-source-code"><i class="fa fa-check"></i>Contributing, Errata and Source code</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><i class="fa fa-check"></i><b>1</b> Stream live cryptocurrency prices from the Binance WSS</a>
<ul>
<li class="chapter" data-level="1.1" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html#objectives"><i class="fa fa-check"></i><b>1.1</b> Objectives</a></li>
<li class="chapter" data-level="1.2" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html#create-a-new-umbrella-app"><i class="fa fa-check"></i><b>1.2</b> Create a new umbrella app</a></li>
<li class="chapter" data-level="1.3" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html#create-a-supervised-application-inside-an-umbrella"><i class="fa fa-check"></i><b>1.3</b> Create a supervised application inside an umbrella</a></li>
<li class="chapter" data-level="1.4" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html#connect-to-binances-websocket-stream-using-the-websockex-module"><i class="fa fa-check"></i><b>1.4</b> Connect to Binance’s WebSocket Stream using the WebSockex module</a></li>
<li class="chapter" data-level="1.5" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html#decode-incoming-events-using-the-jason-module"><i class="fa fa-check"></i><b>1.5</b> Decode incoming events using the Jason module</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><i class="fa fa-check"></i><b>2</b> Create a naive trading strategy - a single trader process without supervision</a>
<ul>
<li class="chapter" data-level="2.1" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#objectives-1"><i class="fa fa-check"></i><b>2.1</b> Objectives</a></li>
<li class="chapter" data-level="2.2" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#initializiation"><i class="fa fa-check"></i><b>2.2</b> Initializiation</a></li>
<li class="chapter" data-level="2.3" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#how-trading-strategy-will-work"><i class="fa fa-check"></i><b>2.3</b> How trading strategy will work?</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#implementation-of-the-first-scenario"><i class="fa fa-check"></i><b>2.3.1</b> Implementation of the first scenario</a></li>
<li class="chapter" data-level="2.3.2" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#implementation-of-the-second-scenario"><i class="fa fa-check"></i><b>2.3.2</b> Implementation of the second scenario</a></li>
<li class="chapter" data-level="2.3.3" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#implementation-of-the-third-scenario"><i class="fa fa-check"></i><b>2.3.3</b> Implementation of the third scenario</a></li>
<li class="chapter" data-level="2.3.4" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#implementation-fallback-scenario"><i class="fa fa-check"></i><b>2.3.4</b> Implementation fallback scenario</a></li>
<li class="chapter" data-level="2.3.5" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#updating-the-naive-interface"><i class="fa fa-check"></i><b>2.3.5</b> Updating the Naive interface</a></li>
<li class="chapter" data-level="2.3.6" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#updating-streamer-app"><i class="fa fa-check"></i><b>2.3.6</b> Updating streamer app</a></li>
<li class="chapter" data-level="2.3.7" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#access-details-to-binance"><i class="fa fa-check"></i><b>2.3.7</b> Access details to Binance</a></li>
<li class="chapter" data-level="2.3.8" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#test-run"><i class="fa fa-check"></i><b>2.3.8</b> Test run</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html"><i class="fa fa-check"></i><b>3</b> Introduce PubSub as a communication method</a>
<ul>
<li class="chapter" data-level="3.1" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html#objectives-2"><i class="fa fa-check"></i><b>3.1</b> Objectives</a></li>
<li class="chapter" data-level="3.2" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html#design"><i class="fa fa-check"></i><b>3.2</b> Design</a></li>
<li class="chapter" data-level="3.3" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html#implementation"><i class="fa fa-check"></i><b>3.3</b> Implementation</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html"><i class="fa fa-check"></i><b>4</b> Mock the Binance API</a>
<ul>
<li class="chapter" data-level="4.1" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#objectives-3"><i class="fa fa-check"></i><b>4.1</b> Objectives</a></li>
<li class="chapter" data-level="4.2" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#design-1"><i class="fa fa-check"></i><b>4.2</b> Design</a></li>
<li class="chapter" data-level="4.3" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#create-binancemock-app"><i class="fa fa-check"></i><b>4.3</b> Create “BinanceMock” app</a></li>
<li class="chapter" data-level="4.4" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-getting-exchange-info"><i class="fa fa-check"></i><b>4.4</b> Implement getting exchange info</a></li>
<li class="chapter" data-level="4.5" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-placing-buy-and-sell-orders"><i class="fa fa-check"></i><b>4.5</b> Implement placing buy and sell orders</a></li>
<li class="chapter" data-level="4.6" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-order-retrival"><i class="fa fa-check"></i><b>4.6</b> Implement order retrival</a></li>
<li class="chapter" data-level="4.7" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-callback-for-incoming-trade-events"><i class="fa fa-check"></i><b>4.7</b> Implement callback for incoming trade events</a></li>
<li class="chapter" data-level="4.8" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#upgrade-trader-and-config"><i class="fa fa-check"></i><b>4.8</b> Upgrade trader and config</a></li>
<li class="chapter" data-level="4.9" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#test-the-implementation"><i class="fa fa-check"></i><b>4.9</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html"><i class="fa fa-check"></i><b>5</b> Enable parallel trading on multiple symbols</a>
<ul>
<li class="chapter" data-level="5.1" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#objectives-4"><i class="fa fa-check"></i><b>5.1</b> Objectives</a></li>
<li class="chapter" data-level="5.2" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#introduction---architectural-design"><i class="fa fa-check"></i><b>5.2</b> Introduction - architectural design</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#update-application-supervisor"><i class="fa fa-check"></i><b>5.2.1</b> Update application supervisor</a></li>
<li class="chapter" data-level="5.2.2" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#add-interface-method"><i class="fa fa-check"></i><b>5.2.2</b> Add interface method</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#implement-naive.symbolsupervisor"><i class="fa fa-check"></i><b>5.3</b> Implement <code>Naive.SymbolSupervisor</code></a></li>
<li class="chapter" data-level="5.4" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#implement-naive.leader"><i class="fa fa-check"></i><b>5.4</b> Implement <code>Naive.Leader</code></a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#updating-the-leader-module"><i class="fa fa-check"></i><b>5.4.1</b> Updating the <code>leader</code> module</a></li>
<li class="chapter" data-level="5.4.2" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#updating-the-naive.trader-module"><i class="fa fa-check"></i><b>5.4.2</b> Updating the <code>Naive.Trader</code> module</a></li>
<li class="chapter" data-level="5.4.3" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#finalizing-naive.leader-implementation"><i class="fa fa-check"></i><b>5.4.3</b> Finalizing <code>Naive.Leader</code> implementation</a></li>
<li class="chapter" data-level="5.4.4" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#iex-testing"><i class="fa fa-check"></i><b>5.4.4</b> IEx testing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><i class="fa fa-check"></i><b>6</b> Introduce a <code>buy_down_interval</code> to make a single trader more profitable</a>
<ul>
<li class="chapter" data-level="6.1" data-path="introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html#objectives-5"><i class="fa fa-check"></i><b>6.1</b> Objectives</a></li>
<li class="chapter" data-level="6.2" data-path="introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html#why-we-need-to-buy-below-the-current-price-feature-overview"><i class="fa fa-check"></i><b>6.2</b> Why we need to buy below the current price? Feature overview</a></li>
<li class="chapter" data-level="6.3" data-path="introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html#naive.trader-implementation"><i class="fa fa-check"></i><b>6.3</b> <code>Naive.Trader</code> implementation</a></li>
<li class="chapter" data-level="6.4" data-path="introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html#naive.leader-implementation"><i class="fa fa-check"></i><b>6.4</b> <code>Naive.Leader</code> implementation</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html#iex-testing-1"><i class="fa fa-check"></i><b>6.4.1</b> IEx testing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html"><i class="fa fa-check"></i><b>7</b> Introduce a trader budget and calculating the quantity</a>
<ul>
<li class="chapter" data-level="7.1" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#objectives-6"><i class="fa fa-check"></i><b>7.1</b> Objectives</a></li>
<li class="chapter" data-level="7.2" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#fetch-step_size"><i class="fa fa-check"></i><b>7.2</b> Fetch <code>step_size</code></a></li>
<li class="chapter" data-level="7.3" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#append-budget-and-step_size-to-the-traders-state-inside-the-leader"><i class="fa fa-check"></i><b>7.3</b> Append <code>budget</code> and <code>step_size</code> to the <code>Trader</code>’s state inside the <code>Leader</code></a></li>
<li class="chapter" data-level="7.4" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#append-budget-and-step_size-to-the-traders-state"><i class="fa fa-check"></i><b>7.4</b> Append <code>budget</code> and <code>step_size</code> to the <code>Trader</code>’s state</a></li>
<li class="chapter" data-level="7.5" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#calculate-quantity"><i class="fa fa-check"></i><b>7.5</b> Calculate quantity</a>
<ul>
<li class="chapter" data-level="7.5.1" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#iex-testing-2"><i class="fa fa-check"></i><b>7.5.1</b> IEx testing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html"><i class="fa fa-check"></i><b>8</b> Add support for multiple transactions per order</a>
<ul>
<li class="chapter" data-level="8.1" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#objectives-7"><i class="fa fa-check"></i><b>8.1</b> Objectives</a></li>
<li class="chapter" data-level="8.2" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#the-issue-with-the-current-implementation"><i class="fa fa-check"></i><b>8.2</b> The issue with the current implementation</a></li>
<li class="chapter" data-level="8.3" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#improve-buy-order-filled-callback"><i class="fa fa-check"></i><b>8.3</b> Improve buy order filled callback</a></li>
<li class="chapter" data-level="8.4" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#implement-buy-order-filled-callback"><i class="fa fa-check"></i><b>8.4</b> Implement buy order “filled” callback</a></li>
<li class="chapter" data-level="8.5" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#improve-sell-order-callback"><i class="fa fa-check"></i><b>8.5</b> Improve sell order callback</a></li>
<li class="chapter" data-level="8.6" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#test-the-implementation-1"><i class="fa fa-check"></i><b>8.6</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html"><i class="fa fa-check"></i><b>9</b> Run multiple traders in parallel</a>
<ul>
<li class="chapter" data-level="9.1" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#objectives-8"><i class="fa fa-check"></i><b>9.1</b> Objectives</a></li>
<li class="chapter" data-level="9.2" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#describe-and-design-the-required-functionality"><i class="fa fa-check"></i><b>9.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="9.3" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#implement-rebuy-inside-naive.trader"><i class="fa fa-check"></i><b>9.3</b> Implement rebuy inside <code>Naive.Trader</code></a></li>
<li class="chapter" data-level="9.4" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#implement-rebuy-in-the-naive.leader"><i class="fa fa-check"></i><b>9.4</b> Implement rebuy in the <code>Naive.Leader</code></a></li>
<li class="chapter" data-level="9.5" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#improve-logs-by-assigning-ids-to-traders"><i class="fa fa-check"></i><b>9.5</b> Improve logs by assigning ids to traders</a></li>
<li class="chapter" data-level="9.6" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#test-the-implementation-2"><i class="fa fa-check"></i><b>9.6</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html"><i class="fa fa-check"></i><b>10</b> Fine-tune trading strategy per symbol</a>
<ul>
<li class="chapter" data-level="10.1" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#objectives-9"><i class="fa fa-check"></i><b>10.1</b> Objectives</a></li>
<li class="chapter" data-level="10.2" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#describe-and-design-the-required-functionality-1"><i class="fa fa-check"></i><b>10.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="10.3" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#add-docker-to-project"><i class="fa fa-check"></i><b>10.3</b> Add docker to project</a></li>
<li class="chapter" data-level="10.4" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#set-up-ecto-inside-the-naive-app"><i class="fa fa-check"></i><b>10.4</b> Set up <code>ecto</code> inside the <code>naive</code> app</a></li>
<li class="chapter" data-level="10.5" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#create-and-migrate-the-db"><i class="fa fa-check"></i><b>10.5</b> Create and migrate the DB</a></li>
<li class="chapter" data-level="10.6" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#seed-symbols-settings"><i class="fa fa-check"></i><b>10.6</b> Seed symbols’ settings</a></li>
<li class="chapter" data-level="10.7" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#update-the-naive.leader-to-fetch-settings"><i class="fa fa-check"></i><b>10.7</b> Update the <code>Naive.Leader</code> to fetch settings</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html"><i class="fa fa-check"></i><b>11</b> Supervise and autostart streaming</a>
<ul>
<li class="chapter" data-level="11.1" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#objectives-10"><i class="fa fa-check"></i><b>11.1</b> Objectives</a></li>
<li class="chapter" data-level="11.2" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#describe-and-design-the-required-functionality-2"><i class="fa fa-check"></i><b>11.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="11.3" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#register-the-streamer.binance-processes-with-names"><i class="fa fa-check"></i><b>11.3</b> Register the <code>Streamer.Binance</code> processes with names</a></li>
<li class="chapter" data-level="11.4" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#set-up-ecto-inside-the-streamer-app"><i class="fa fa-check"></i><b>11.4</b> Set up <code>ecto</code> inside the <code>streamer</code> app</a></li>
<li class="chapter" data-level="11.5" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#create-and-migrate-the-db-1"><i class="fa fa-check"></i><b>11.5</b> Create and migrate the db</a></li>
<li class="chapter" data-level="11.6" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#seed-default-settings"><i class="fa fa-check"></i><b>11.6</b> Seed default settings</a></li>
<li class="chapter" data-level="11.7" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#implement-the-supervision-tree-and-start-streaming-functionality"><i class="fa fa-check"></i><b>11.7</b> Implement the supervision tree and start streaming functionality</a></li>
<li class="chapter" data-level="11.8" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#implement-the-stop-functionality"><i class="fa fa-check"></i><b>11.8</b> Implement the stop functionality</a></li>
<li class="chapter" data-level="11.9" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#implement-the-autostart-streaming-functionality"><i class="fa fa-check"></i><b>11.9</b> Implement the autostart streaming functionality</a></li>
<li class="chapter" data-level="11.10" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#test-the-implementation-3"><i class="fa fa-check"></i><b>11.10</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html"><i class="fa fa-check"></i><b>12</b> Start, stop, shutdown and autostart trading</a>
<ul>
<li class="chapter" data-level="12.1" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#objectives-11"><i class="fa fa-check"></i><b>12.1</b> Objectives</a></li>
<li class="chapter" data-level="12.2" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#describe-and-design-the-required-functionality-3"><i class="fa fa-check"></i><b>12.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="12.3" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#re-implement-the-start-trading-functionality"><i class="fa fa-check"></i><b>12.3</b> (Re-)Implement the start trading functionality</a></li>
<li class="chapter" data-level="12.4" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#implement-the-stop-trading-functionality"><i class="fa fa-check"></i><b>12.4</b> Implement the stop trading functionality</a></li>
<li class="chapter" data-level="12.5" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#implement-the-autostart-trading-functionality"><i class="fa fa-check"></i><b>12.5</b> Implement the autostart trading functionality</a></li>
<li class="chapter" data-level="12.6" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#implement-the-shutdown-trading-functionality"><i class="fa fa-check"></i><b>12.6</b> Implement the shutdown trading functionality</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html"><i class="fa fa-check"></i><b>13</b> Abstract duplicated supervision code</a>
<ul>
<li class="chapter" data-level="13.1" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#objectives-12"><i class="fa fa-check"></i><b>13.1</b> Objectives</a></li>
<li class="chapter" data-level="13.2" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#overview-of-requirements"><i class="fa fa-check"></i><b>13.2</b> Overview of requirements</a></li>
<li class="chapter" data-level="13.3" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#pseudo-generalize-core.servicesupervisor-module"><i class="fa fa-check"></i><b>13.3</b> Pseudo generalize Core.ServiceSupervisor module</a></li>
<li class="chapter" data-level="13.4" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#utilize-pseudo-generalized-code-inside-the-naive-dynamicsymbolsupervisor"><i class="fa fa-check"></i><b>13.4</b> Utilize pseudo generalized code inside the Naive DynamicSymbolSupervisor</a></li>
<li class="chapter" data-level="13.5" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#implement-a-truly-generic-core.servicesupervisor"><i class="fa fa-check"></i><b>13.5</b> Implement a truly generic <code>Core.ServiceSupervisor</code></a>
<ul>
<li class="chapter" data-level="13.5.1" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#first-path-starting-with-the-fetch_symbols_to_start0-function"><i class="fa fa-check"></i><b>13.5.1</b> First path starting with the <code>fetch_symbols_to_start/0</code> function</a></li>
<li class="chapter" data-level="13.5.2" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#second-path-starting-with-the-update_status2"><i class="fa fa-check"></i><b>13.5.2</b> Second path starting with the <code>update_status/2</code></a></li>
<li class="chapter" data-level="13.5.3" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#third-path-starting-with-the-get_pid1-function"><i class="fa fa-check"></i><b>13.5.3</b> Third path starting with the <code>get_pid/1</code> function</a></li>
</ul></li>
<li class="chapter" data-level="13.6" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#remove-boilerplate-using-use-macro"><i class="fa fa-check"></i><b>13.6</b> Remove boilerplate using <code>use</code> macro</a></li>
<li class="chapter" data-level="13.7" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#use-the-core.servicesupervisor-module-inside-the-streamer-application"><i class="fa fa-check"></i><b>13.7</b> Use the <code>Core.ServiceSupervisor</code> module inside the <code>streamer</code> application</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html"><i class="fa fa-check"></i><b>14</b> Store trade events and orders inside the database</a>
<ul>
<li class="chapter" data-level="14.1" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#objectives-13"><i class="fa fa-check"></i><b>14.1</b> Objectives</a></li>
<li class="chapter" data-level="14.2" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#overview-of-requirements-1"><i class="fa fa-check"></i><b>14.2</b> Overview of requirements</a></li>
<li class="chapter" data-level="14.3" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-a-new-data_warehouse-application-in-the-umbrella"><i class="fa fa-check"></i><b>14.3</b> Create a new <code>data_warehouse</code> application in the umbrella</a></li>
<li class="chapter" data-level="14.4" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#connect-to-the-database-using-ecto"><i class="fa fa-check"></i><b>14.4</b> Connect to the database using Ecto</a></li>
<li class="chapter" data-level="14.5" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#store-trade-events-data"><i class="fa fa-check"></i><b>14.5</b> Store trade events’ data</a></li>
<li class="chapter" data-level="14.6" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#store-orders-data"><i class="fa fa-check"></i><b>14.6</b> Store orders’ data</a></li>
<li class="chapter" data-level="14.7" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#implement-supervision"><i class="fa fa-check"></i><b>14.7</b> Implement supervision</a>
<ul>
<li class="chapter" data-level="14.7.1" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-subscriber_settings-table"><i class="fa fa-check"></i><b>14.7.1</b> Create <code>subscriber_settings</code> table</a></li>
<li class="chapter" data-level="14.7.2" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#redesign-supervision-using-registry"><i class="fa fa-check"></i><b>14.7.2</b> Redesign supervision using Registry</a></li>
<li class="chapter" data-level="14.7.3" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-the-datawarehouse.subscriber.dynamicsupervisor-module"><i class="fa fa-check"></i><b>14.7.3</b> Create the <code>DataWarehouse.Subscriber.DynamicSupervisor</code> module</a></li>
<li class="chapter" data-level="14.7.4" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#register-worker-processes-using-via"><i class="fa fa-check"></i><b>14.7.4</b> Register Worker processes using :via</a></li>
<li class="chapter" data-level="14.7.5" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-a-new-supervision-level-for-registry-task-and-the-dynamicsupervisor"><i class="fa fa-check"></i><b>14.7.5</b> Create a new supervision level for Registry, Task and the DynamicSupervisor</a></li>
<li class="chapter" data-level="14.7.6" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#link-the-subscribersupervisor-to-the-application"><i class="fa fa-check"></i><b>14.7.6</b> Link the <code>SubscriberSupervisor</code> to the <code>Application</code></a></li>
<li class="chapter" data-level="14.7.7" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#add-interface"><i class="fa fa-check"></i><b>14.7.7</b> Add interface</a></li>
<li class="chapter" data-level="14.7.8" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#test"><i class="fa fa-check"></i><b>14.7.8</b> Test</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="15" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html"><i class="fa fa-check"></i><b>15</b> Backtest trading strategy</a>
<ul>
<li class="chapter" data-level="15.1" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#objectives-14"><i class="fa fa-check"></i><b>15.1</b> Objectives</a></li>
<li class="chapter" data-level="15.2" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#overview-of-requirements-2"><i class="fa fa-check"></i><b>15.2</b> Overview of requirements</a></li>
<li class="chapter" data-level="15.3" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#implement-the-storing-task"><i class="fa fa-check"></i><b>15.3</b> Implement the storing task</a></li>
<li class="chapter" data-level="15.4" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#test-the-backtesting"><i class="fa fa-check"></i><b>15.4</b> Test the backtesting</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html"><i class="fa fa-check"></i><b>16</b> End-to-end testing</a>
<ul>
<li class="chapter" data-level="16.1" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#objectives-15"><i class="fa fa-check"></i><b>16.1</b> Objectives</a></li>
<li class="chapter" data-level="16.2" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#decide-on-the-tested-functionality"><i class="fa fa-check"></i><b>16.2</b> Decide on the tested functionality</a></li>
<li class="chapter" data-level="16.3" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#implement-basic-test"><i class="fa fa-check"></i><b>16.3</b> Implement basic test</a></li>
<li class="chapter" data-level="16.4" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#introduce-environment-based-config-files"><i class="fa fa-check"></i><b>16.4</b> Introduce environment based config files</a></li>
<li class="chapter" data-level="16.5" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#add-convenience-aliases"><i class="fa fa-check"></i><b>16.5</b> Add convenience aliases</a></li>
<li class="chapter" data-level="16.6" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#cache-initial-seed-data-inside-a-file"><i class="fa fa-check"></i><b>16.6</b> Cache initial seed data inside a file</a></li>
<li class="chapter" data-level="16.7" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#update-seeding-scripts-to-use-the-binancemock"><i class="fa fa-check"></i><b>16.7</b> Update seeding scripts to use the BinanceMock</a></li>
<li class="chapter" data-level="16.8" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#introduce-the-core-application"><i class="fa fa-check"></i><b>16.8</b> Introduce the Core application</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="mox-rocks.html"><a href="mox-rocks.html"><i class="fa fa-check"></i><b>17</b> Mox rocks</a>
<ul>
<li class="chapter" data-level="17.1" data-path="mox-rocks.html"><a href="mox-rocks.html#objectives-16"><i class="fa fa-check"></i><b>17.1</b> Objectives</a></li>
<li class="chapter" data-level="17.2" data-path="mox-rocks.html"><a href="mox-rocks.html#introduction-to-mock-based-tests"><i class="fa fa-check"></i><b>17.2</b> Introduction to mock based tests</a></li>
<li class="chapter" data-level="17.3" data-path="mox-rocks.html"><a href="mox-rocks.html#add-the-mox-package"><i class="fa fa-check"></i><b>17.3</b> Add the <code>mox</code> package</a></li>
<li class="chapter" data-level="17.4" data-path="mox-rocks.html"><a href="mox-rocks.html#investigate-the-naive.trader-module"><i class="fa fa-check"></i><b>17.4</b> Investigate the <code>Naive.Trader</code> module</a>
<ul>
<li class="chapter" data-level="17.4.1" data-path="mox-rocks.html"><a href="mox-rocks.html#mock-the-binance-module"><i class="fa fa-check"></i><b>17.4.1</b> Mock the <code>Binance</code> module</a></li>
<li class="chapter" data-level="17.4.2" data-path="mox-rocks.html"><a href="mox-rocks.html#mock-the-naiveleader-module"><i class="fa fa-check"></i><b>17.4.2</b> Mock the <code>NaiveLeader</code> module</a></li>
<li class="chapter" data-level="17.4.3" data-path="mox-rocks.html"><a href="mox-rocks.html#mock-the-phoenix.pubsub-module"><i class="fa fa-check"></i><b>17.4.3</b> Mock the <code>Phoenix.PubSub</code> module</a></li>
<li class="chapter" data-level="17.4.4" data-path="mox-rocks.html"><a href="mox-rocks.html#mock-the-logger-module"><i class="fa fa-check"></i><b>17.4.4</b> Mock the <code>Logger</code> module</a></li>
</ul></li>
<li class="chapter" data-level="17.5" data-path="mox-rocks.html"><a href="mox-rocks.html#implement-a-test-of-the-naive.trader-module"><i class="fa fa-check"></i><b>17.5</b> Implement a test of the <code>Naive.Trader</code> module</a></li>
<li class="chapter" data-level="17.6" data-path="mox-rocks.html"><a href="mox-rocks.html#define-an-alias-to-run-unit-tests"><i class="fa fa-check"></i><b>17.6</b> Define an alias to run unit tests</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="functional-elixir.html"><a href="functional-elixir.html"><i class="fa fa-check"></i><b>18</b> Functional Elixir</a>
<ul>
<li class="chapter" data-level="18.1" data-path="functional-elixir.html"><a href="functional-elixir.html#objectives-17"><i class="fa fa-check"></i><b>18.1</b> Objectives</a></li>
<li class="chapter" data-level="18.2" data-path="functional-elixir.html"><a href="functional-elixir.html#the-reasoning-behind-the-functional-approach"><i class="fa fa-check"></i><b>18.2</b> The reasoning behind the functional approach</a></li>
<li class="chapter" data-level="18.3" data-path="functional-elixir.html"><a href="functional-elixir.html#simplifying-by-splitting"><i class="fa fa-check"></i><b>18.3</b> Simplifying by splitting</a></li>
<li class="chapter" data-level="18.4" data-path="functional-elixir.html"><a href="functional-elixir.html#abstracting-the-pure-logic"><i class="fa fa-check"></i><b>18.4</b> Abstracting the “pure” logic</a>
<ul>
<li class="chapter" data-level="18.4.1" data-path="functional-elixir.html"><a href="functional-elixir.html#place-a-buy-order-rules"><i class="fa fa-check"></i><b>18.4.1</b> Place a buy order rules</a></li>
<li class="chapter" data-level="18.4.2" data-path="functional-elixir.html"><a href="functional-elixir.html#race-condition-rules"><i class="fa fa-check"></i><b>18.4.2</b> Race condition rules</a></li>
<li class="chapter" data-level="18.4.3" data-path="functional-elixir.html"><a href="functional-elixir.html#place-a-sell-order-rules"><i class="fa fa-check"></i><b>18.4.3</b> Place a sell order rules</a></li>
<li class="chapter" data-level="18.4.4" data-path="functional-elixir.html"><a href="functional-elixir.html#fetch-the-buy-order-rules"><i class="fa fa-check"></i><b>18.4.4</b> Fetch the buy order rules</a></li>
<li class="chapter" data-level="18.4.5" data-path="functional-elixir.html"><a href="functional-elixir.html#terminate-trader-rules"><i class="fa fa-check"></i><b>18.4.5</b> Terminate trader rules</a></li>
<li class="chapter" data-level="18.4.6" data-path="functional-elixir.html"><a href="functional-elixir.html#fetch-the-sell-order-rules"><i class="fa fa-check"></i><b>18.4.6</b> Fetch the sell order rules</a></li>
<li class="chapter" data-level="18.4.7" data-path="functional-elixir.html"><a href="functional-elixir.html#trigger-rebuy-rules"><i class="fa fa-check"></i><b>18.4.7</b> Trigger rebuy rules</a></li>
<li class="chapter" data-level="18.4.8" data-path="functional-elixir.html"><a href="functional-elixir.html#the-final-clause-rules"><i class="fa fa-check"></i><b>18.4.8</b> The final clause rules</a></li>
<li class="chapter" data-level="18.4.9" data-path="functional-elixir.html"><a href="functional-elixir.html#changes-to-the-naive.trader-module"><i class="fa fa-check"></i><b>18.4.9</b> Changes to the <code>Naive.Trader</code> module</a></li>
<li class="chapter" data-level="18.4.10" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---place-buy-order"><i class="fa fa-check"></i><b>18.4.10</b> <code>Naive.Trader</code> - place buy order</a></li>
<li class="chapter" data-level="18.4.11" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---race-condition-clause"><i class="fa fa-check"></i><b>18.4.11</b> <code>Naive.Trader</code> - Race condition clause</a></li>
<li class="chapter" data-level="18.4.12" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---place-a-sell-order"><i class="fa fa-check"></i><b>18.4.12</b> <code>Naive.Trader</code> - Place a sell order</a></li>
<li class="chapter" data-level="18.4.13" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---fetch-the-buy-order"><i class="fa fa-check"></i><b>18.4.13</b> <code>Naive.Trader</code> - Fetch the buy order</a></li>
<li class="chapter" data-level="18.4.14" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---terminate-the-trader"><i class="fa fa-check"></i><b>18.4.14</b> <code>Naive.Trader</code> - Terminate the trader</a></li>
<li class="chapter" data-level="18.4.15" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---fetch-the-sell-order"><i class="fa fa-check"></i><b>18.4.15</b> <code>Naive.Trader</code> - Fetch the sell order</a></li>
<li class="chapter" data-level="18.4.16" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---triggering-rebuy"><i class="fa fa-check"></i><b>18.4.16</b> <code>Naive.Trader</code> - Triggering rebuy</a></li>
<li class="chapter" data-level="18.4.17" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---the-final-ignore-clause"><i class="fa fa-check"></i><b>18.4.17</b> <code>Naive.Trader</code> - The final ignore clause</a></li>
</ul></li>
<li class="chapter" data-level="18.5" data-path="functional-elixir.html"><a href="functional-elixir.html#dealing-with-dirty-code"><i class="fa fa-check"></i><b>18.5</b> Dealing with dirty code</a></li>
<li class="chapter" data-level="18.6" data-path="functional-elixir.html"><a href="functional-elixir.html#making-dirty-code-testable"><i class="fa fa-check"></i><b>18.6</b> Making dirty code testable</a>
<ul>
<li class="chapter" data-level="18.6.1" data-path="functional-elixir.html"><a href="functional-elixir.html#passing-functions-arguments"><i class="fa fa-check"></i><b>18.6.1</b> Passing functions arguments</a></li>
<li class="chapter" data-level="18.6.2" data-path="functional-elixir.html"><a href="functional-elixir.html#passing-grouped-functions-as-a-context"><i class="fa fa-check"></i><b>18.6.2</b> Passing grouped functions as a context</a></li>
<li class="chapter" data-level="18.6.3" data-path="functional-elixir.html"><a href="functional-elixir.html#passing-grouped-modules-as-a-context"><i class="fa fa-check"></i><b>18.6.3</b> Passing grouped modules as a context</a></li>
<li class="chapter" data-level="18.6.4" data-path="functional-elixir.html"><a href="functional-elixir.html#injecting-modules-to-modules-attributes-based-on-the-configuration"><i class="fa fa-check"></i><b>18.6.4</b> Injecting modules to module’s attributes based on the configuration</a></li>
</ul></li>
<li class="chapter" data-level="18.7" data-path="functional-elixir.html"><a href="functional-elixir.html#the-power-with-in"><i class="fa fa-check"></i><b>18.7</b> The power with-in</a>
<ul>
<li class="chapter" data-level="18.7.1" data-path="functional-elixir.html"><a href="functional-elixir.html#idiomatic-error-handling"><i class="fa fa-check"></i><b>18.7.1</b> Idiomatic error handling</a></li>
</ul></li>
<li class="chapter" data-level="18.8" data-path="functional-elixir.html"><a href="functional-elixir.html#do-or-not-to-do"><i class="fa fa-check"></i><b>18.8</b> Do or not to do</a></li>
<li class="chapter" data-level="18.9" data-path="functional-elixir.html"><a href="functional-elixir.html#final-thoughts"><i class="fa fa-check"></i><b>18.9</b> Final thoughts</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://www.bookdown.org/" target="blank">Created with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Hands-on Elixir &amp; OTP: Cryptocurrency trading bot</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<div class="quick-option">

  <!-- Start Form Toolbar -->
  <div class="form-toolbar">
      <div class="inner">
          <a class="trigger-option" href="#">
              <img src="https://image.flaticon.com/icons/png/512/833/833472.png" width="40px" />
          </a>
      </div>
  </div>
  <!-- End Form Toolbar -->

  <!-- Start Quick Form -->
  <div class="form-option-wrapper">
      <div class="form-panel-header">

          <img class="donate_img" src="https://cdn.pixabay.com/photo/2016/11/19/11/11/hands-1838658_960_720.jpg" width="80%" style=""/>

          <h4>Before closing this side panel, please consider supporting the project by purchasing a PDF/EPUB version</h4>

          <a class="notify-btn" href="https://gumroad.com/l/cSGdY"><b>Gumroad</b></a>
          <br/><br/>
          <h4>Follow me on:</h4>
          <a href="https://twitter.com/kamilskowron" class="fa fa-twitter"></a>
          <a href="https://www.linkedin.com/in/kamilskowron/" class="fa fa-linkedin"></a>
          <a href="https://github.com/Cinderella-Man" class="fa fa-github"></a>
      </div>
  </div>
  <!-- End Quick Link -->

</div>

<script>
  $(".trigger-option").on("click", function (e) {
      e.preventDefault(),
          (function () {
              $formOption.toggleClass("open");
          })();
  });

  var $html = $("html"),
    $formOption = $(".quick-option");

  if (window.location == "https://www.elixircryptobot.com/" || window.location.href.indexOf("index.html") > 0) {
    $formOption.toggleClass("open");
  }
</script>
<div id="mox-rocks" class="section level1" number="17">
<h1><span class="header-section-number">Chapter 17</span> Mox rocks</h1>
<div id="objectives-16" class="section level2" number="17.1">
<h2><span class="header-section-number">17.1</span> Objectives</h2>
<ul>
<li>introduction to mock based tests</li>
<li>add the Mox package</li>
<li>investigate the <code>Naive.Trader</code> module
<ul>
<li>mock the <code>Binance</code> module</li>
<li>mock the <code>NaiveLeader</code> module</li>
<li>mock the <code>Phoenix.PubSub</code> module</li>
<li>mock the <code>Logger</code> module</li>
</ul></li>
<li>implement a test of the <code>Naive.Trader</code> module</li>
<li>define an alias to run unit tests</li>
</ul>
</div>
<div id="introduction-to-mock-based-tests" class="section level2" number="17.2">
<h2><span class="header-section-number">17.2</span> Introduction to mock based tests</h2>
<p>In the previous chapter, we’ve implemented the end-to-end test. It required a lot of prep work as well as we were able to see the downsides of this type of test clearly:</p>
<ul>
<li>we will be unable to run more than one end-to-end test in parallel as they rely on the database’s state</li>
<li>we need to set up the database before every test run</li>
<li>we need to start processes in the correct order with the suitable parameters</li>
<li>we need to wait a (guessed) hardcoded amount of time that it will take to finish the trading(this is extremely bad as it will cause randomly failing tests as people will make the time shorter to speed up tests)</li>
<li>we wouldn’t be able to quickly pinpoint which part error originated from as the test spans over a vast amount of the system</li>
<li>logging was polluting our test output</li>
</ul>
<div style="page-break-after: always;"></div>
<p>How could we fix the above issues?</p>
<p>The most common way is to limit the scope of the test. Instead of testing the whole trading flow, we could focus on testing a single <code>Naive.Trader</code> process.</p>
<p>Focusing on a single trader process would remove the requirement for starting multiple processes before testing, but it would also bring its own challenges.</p>
<p>Let’s look at a concrete example:</p>
<p>When the <code>Naive.Trader</code> process starts, it subscribes to the <code>TRADE_EVENTS:#{symbol}</code> PubSub topic. It also broadcasts updates of the orders it placed to the <code>ORDERS:#{symbol}</code> PubSub topic.</p>
<p>How could we break the link between the <code>Naive.Trader</code> and the PubSub(or any other module it depends on)?</p>
<p>We could utilize the trick that we used for the <code>Binance</code> module. We could create a module that provides the same functions as the <code>PubSub</code> module.</p>
<p>We know that the trader process calls <code>Phoenix.PubSub.subscribe/2</code> and <code>Phoenix.PubSub.broadcast/3</code> functions. We could implement a module that contains the same functions:</p>
<div class="sourceCode" id="cb346"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb346-1"><a href="mox-rocks.html#cb346-1" aria-hidden="true" tabindex="-1"></a><span class="kw">defmodule</span> <span class="cn">Test</span><span class="op">.</span><span class="cn">PubSub</span> <span class="kw">do</span></span>
<span id="cb346-2"><a href="mox-rocks.html#cb346-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> subscribe(_, _), <span class="kw">do</span>: <span class="va">:ok</span></span>
<span id="cb346-3"><a href="mox-rocks.html#cb346-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> broadcast(_, _, _), <span class="kw">do</span>: <span class="va">:ok</span></span>
<span id="cb346-4"><a href="mox-rocks.html#cb346-4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<p>The above module would satisfy the PubSub’s functionality required by the <code>Naive.Trader</code> module, but this solution comes with a couple of drawbacks:</p>
<ul>
<li>it doesn’t the passed values. It just ignores them, which is a missed opportunity to confirm that the PubSub module was called with the expected values.</li>
<li>we can’t define a custom implemention specific to test. This is possible by extending the implemention with test related returns(hack!)</li>
</ul>
<p>Using the <code>mox</code> module would fix both of the problems mentioned above. With the <code>mox</code> module we can define add-hoc function implemention per test:</p>
<div class="sourceCode" id="cb347"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb347-1"><a href="mox-rocks.html#cb347-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># inside test file</span></span>
<span id="cb347-2"><a href="mox-rocks.html#cb347-2" aria-hidden="true" tabindex="-1"></a>    test <span class="op">...</span></span>
<span id="cb347-3"><a href="mox-rocks.html#cb347-3" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Test</span><span class="op">.</span><span class="cn">PubSubMock</span></span>
<span id="cb347-4"><a href="mox-rocks.html#cb347-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">|&gt;</span> expect(<span class="va">:subscribe</span>, <span class="kw">fn</span> (_module, <span class="st">&quot;TRADE_EVENTS:XRPUSDT&quot;</span>) <span class="op">-&gt;</span> <span class="va">:ok</span> <span class="kw">end</span>)</span>
<span id="cb347-5"><a href="mox-rocks.html#cb347-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">|&gt;</span> expect(<span class="va">:broadcast</span>, <span class="kw">fn</span> (_module, <span class="st">&quot;ORDERS:XRPUSDT&quot;</span>, _order) <span class="op">-&gt;</span> <span class="va">:ok</span> <span class="kw">end</span>)</span></code></pre></div>
<div style="page-break-after: always;"></div>
<p>There are multiple benefits to using the <code>mox</code> module instead of handcrafting the implementation:</p>
<ul>
<li>it allows defining functions that will pattern match values specific to each test(as in the case of the “usual” pattern matching, they will break when called with unexpected values)</li>
<li>it allows defining implementations of the mocked functions based on incoming(test specific) values</li>
<li>it can validate that all defined mocked functions have been called by the test</li>
<li>it comes with its own tests, so we don’t need to test it as it would need with our custom handcrafted mimicking module implementation</li>
</ul>
<p>But there’s a catch* ;)</p>
<p>For the <code>mox</code> to know what sort of functions the module provides, it needs to know its <code>behaviour</code>.</p>
<p>In Elixir, to define a behaviour of the module, we need to add the <code>@callback</code> attributes to it:</p>
<div class="sourceCode" id="cb348"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb348-1"><a href="mox-rocks.html#cb348-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defmodule</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">Test</span><span class="op">.</span><span class="cn">PubSub</span> <span class="kw">do</span></span>
<span id="cb348-2"><a href="mox-rocks.html#cb348-2" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@type</span> t :: atom</span>
<span id="cb348-3"><a href="mox-rocks.html#cb348-3" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@type</span> topic :: binary</span>
<span id="cb348-4"><a href="mox-rocks.html#cb348-4" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@type</span> message :: term</span>
<span id="cb348-5"><a href="mox-rocks.html#cb348-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb348-6"><a href="mox-rocks.html#cb348-6" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@callback</span> subscribe(t, topic) :: <span class="va">:ok</span> <span class="op">|</span> {<span class="va">:error</span>, term}</span>
<span id="cb348-7"><a href="mox-rocks.html#cb348-7" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@callback</span> broadcast(t, topic, message) :: <span class="va">:ok</span> <span class="op">|</span> {<span class="va">:error</span>, term}</span>
<span id="cb348-8"><a href="mox-rocks.html#cb348-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>A <code>behaviour</code> can be defined in a separate module if we are working with 3rd party module that doesn’t provide it(like in the case of the <code>Phoenix.PubSub</code> module).</p>
<p>Note: The additional benefit of using the <code>behaviours</code> is that we could tell Elixir that our module <em>implements</em> the behaviour by adding the <code>@behaviour</code> attribute:</p>
<div class="sourceCode" id="cb349"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb349-1"><a href="mox-rocks.html#cb349-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="cn">MyPubSub</span> <span class="kw">do</span></span>
<span id="cb349-2"><a href="mox-rocks.html#cb349-2" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@behaviour</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">Test</span><span class="op">.</span><span class="cn">PubSub</span></span>
<span id="cb349-3"><a href="mox-rocks.html#cb349-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span></code></pre></div>
<p>Using the above will cause Elixir to validate at compile time that the <code>MyPubSub</code> module implements all functions defined inside the <code>Core.Test.PubSub</code> module(otherwise it will raise compilation error).</p>
<p>Let’s get back to the main topic. We figured out that we could mock all of the modules that the <code>Naive.Trader</code> depends on using the <code>mox</code> module.</p>
<p>But, how would we tell the <code>Naive.Trader</code> to use the mocked modules instead of the “real” ones when we run tests?</p>
<p>We could make all modules that the <code>Naive.Trader</code> depends on be dynamically injected from the configuration(based on the environment).</p>
<p>Another requirement to make <code>mox</code> work is to define the mocks upfront using the <code>Mox.defmock/2</code> function. It will dynamically define a new module that will be limited by the passed behaviour(we will only be able to mock[inside tests] functions defined as a part of that behaviour).</p>
<div style="page-break-after: always;"></div>
<p>To sum up, there are a few steps to get the <code>mox</code> running:</p>
<ul>
<li>implement behaviours that we would like to mock(as most of the packages[like <code>Phoenix.PubSub</code>] are not coming with those)</li>
<li>define mock modules using the <code>Mox.defmock</code> function</li>
<li>modify the application’s configuration to use the mocked module(s)</li>
<li>specify mocked module’s expectation inside the test</li>
</ul>
<p>Let’s move to the implementation.</p>
</div>
<div id="add-the-mox-package" class="section level2" number="17.3">
<h2><span class="header-section-number">17.3</span> Add the <code>mox</code> package</h2>
<p>First let’s add the <code>mox</code> package to the <code>naive</code> application’s dependencies:</p>
<div class="sourceCode" id="cb350"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb350-1"><a href="mox-rocks.html#cb350-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/naive/mix.exs</span></span>
<span id="cb350-2"><a href="mox-rocks.html#cb350-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb350-3"><a href="mox-rocks.html#cb350-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defp</span> deps <span class="kw">do</span></span>
<span id="cb350-4"><a href="mox-rocks.html#cb350-4" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb350-5"><a href="mox-rocks.html#cb350-5" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span></span>
<span id="cb350-6"><a href="mox-rocks.html#cb350-6" aria-hidden="true" tabindex="-1"></a>      {<span class="va">:mox</span>, <span class="st">&quot;~&gt; 1.0&quot;</span>, <span class="va">only:</span> [<span class="va">:test</span>, <span class="va">:integration</span>]},</span>
<span id="cb350-7"><a href="mox-rocks.html#cb350-7" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span></span></code></pre></div>
<p>We can now run <code>mix deps.get</code> to fetch the <code>mox</code> package.</p>
<p>[Note] As we will add the <code>mox</code>’s mocking code into the <code>test_helper.exs</code> file, we need to
make <code>mox</code> available in all test environments(both <code>test</code> and <code>integration</code>).</p>
</div>
<div id="investigate-the-naive.trader-module" class="section level2" number="17.4">
<h2><span class="header-section-number">17.4</span> Investigate the <code>Naive.Trader</code> module</h2>
<p>Let’s investigate the <code>Naive.Trader</code> module(<code>/apps/naive/lib/naive/trader.ex</code>). We are looking for all calls to other modules - we can see:</p>
<ul>
<li><code>Logger.info/2</code></li>
<li><code>Phoenix.PubSub.subscribe/2</code></li>
<li><code>@binance_client.order_limit_buy/4</code></li>
<li><code>Naive.Leader.notify/2</code></li>
<li><code>@binance_client.get_order/3</code></li>
<li><code>@binance_client.order_limit_sell/4</code></li>
<li><code>Phoenix.PubSub.broadcast/3</code></li>
</ul>
<p>So the <code>Naive.Trader</code> relies on four modules:</p>
<ul>
<li><code>Logger</code></li>
<li><code>Phoenix.PubSub</code></li>
<li><code>Naive.Leader</code></li>
<li><code>@binance_client</code>(either <code>Binance</code> or <code>BinanceMock</code>)</li>
</ul>
<p>We will need to work through them one by one.</p>
<div id="mock-the-binance-module" class="section level3" number="17.4.1">
<h3><span class="header-section-number">17.4.1</span> Mock the <code>Binance</code> module</h3>
<p>Let’s start with the binance client, as it’s already a dynamic value based on the configuration.</p>
<p>Neither the <code>Binance</code> nor the <code>BinanceMock</code>(our dummy implementation) module doesn’t provide a behaviour - let’s fix that by defining the <code>@callback</code> attributes at the top of the <code>BinanceMock</code> module before the structs:</p>
<div class="sourceCode" id="cb351"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb351-1"><a href="mox-rocks.html#cb351-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/binance_mock/lib/binance_mock.ex</span></span>
<span id="cb351-2"><a href="mox-rocks.html#cb351-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb351-3"><a href="mox-rocks.html#cb351-3" aria-hidden="true" tabindex="-1"></a>  <span class="im">alias</span> <span class="cn">Binance</span><span class="op">.</span><span class="cn">Order</span></span>
<span id="cb351-4"><a href="mox-rocks.html#cb351-4" aria-hidden="true" tabindex="-1"></a>  <span class="im">alias</span> <span class="cn">Binance</span><span class="op">.</span><span class="cn">OrderResponse</span></span>
<span id="cb351-5"><a href="mox-rocks.html#cb351-5" aria-hidden="true" tabindex="-1"></a>  <span class="im">alias</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">Struct</span><span class="op">.</span><span class="cn">TradeEvent</span></span>
<span id="cb351-6"><a href="mox-rocks.html#cb351-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb351-7"><a href="mox-rocks.html#cb351-7" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@type</span> symbol :: binary</span>
<span id="cb351-8"><a href="mox-rocks.html#cb351-8" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@type</span> quantity :: binary</span>
<span id="cb351-9"><a href="mox-rocks.html#cb351-9" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@type</span> price :: binary</span>
<span id="cb351-10"><a href="mox-rocks.html#cb351-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@type</span> time_in_force :: binary</span>
<span id="cb351-11"><a href="mox-rocks.html#cb351-11" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@type</span> timestamp :: non_neg_integer</span>
<span id="cb351-12"><a href="mox-rocks.html#cb351-12" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@type</span> order_id :: non_neg_integer</span>
<span id="cb351-13"><a href="mox-rocks.html#cb351-13" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@type</span> orig_client_order_id :: binary</span>
<span id="cb351-14"><a href="mox-rocks.html#cb351-14" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@type</span> recv_window :: binary</span>
<span id="cb351-15"><a href="mox-rocks.html#cb351-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb351-16"><a href="mox-rocks.html#cb351-16" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@callback</span> order_limit_buy(</span>
<span id="cb351-17"><a href="mox-rocks.html#cb351-17" aria-hidden="true" tabindex="-1"></a>              symbol,</span>
<span id="cb351-18"><a href="mox-rocks.html#cb351-18" aria-hidden="true" tabindex="-1"></a>              quantity,</span>
<span id="cb351-19"><a href="mox-rocks.html#cb351-19" aria-hidden="true" tabindex="-1"></a>              price,</span>
<span id="cb351-20"><a href="mox-rocks.html#cb351-20" aria-hidden="true" tabindex="-1"></a>              time_in_force</span>
<span id="cb351-21"><a href="mox-rocks.html#cb351-21" aria-hidden="true" tabindex="-1"></a>            ) :: {<span class="va">:ok</span>, %<span class="cn">OrderResponse</span>{}} <span class="op">|</span> {<span class="va">:error</span>, term}</span>
<span id="cb351-22"><a href="mox-rocks.html#cb351-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb351-23"><a href="mox-rocks.html#cb351-23" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@callback</span> order_limit_sell(</span>
<span id="cb351-24"><a href="mox-rocks.html#cb351-24" aria-hidden="true" tabindex="-1"></a>              symbol,</span>
<span id="cb351-25"><a href="mox-rocks.html#cb351-25" aria-hidden="true" tabindex="-1"></a>              quantity,</span>
<span id="cb351-26"><a href="mox-rocks.html#cb351-26" aria-hidden="true" tabindex="-1"></a>              price,</span>
<span id="cb351-27"><a href="mox-rocks.html#cb351-27" aria-hidden="true" tabindex="-1"></a>              time_in_force</span>
<span id="cb351-28"><a href="mox-rocks.html#cb351-28" aria-hidden="true" tabindex="-1"></a>            ) :: {<span class="va">:ok</span>, %<span class="cn">OrderResponse</span>{}} <span class="op">|</span> {<span class="va">:error</span>, term}</span>
<span id="cb351-29"><a href="mox-rocks.html#cb351-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb351-30"><a href="mox-rocks.html#cb351-30" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@callback</span> get_order(</span>
<span id="cb351-31"><a href="mox-rocks.html#cb351-31" aria-hidden="true" tabindex="-1"></a>              symbol,</span>
<span id="cb351-32"><a href="mox-rocks.html#cb351-32" aria-hidden="true" tabindex="-1"></a>              timestamp,</span>
<span id="cb351-33"><a href="mox-rocks.html#cb351-33" aria-hidden="true" tabindex="-1"></a>              order_id,</span>
<span id="cb351-34"><a href="mox-rocks.html#cb351-34" aria-hidden="true" tabindex="-1"></a>              orig_client_order_id <span class="op">|</span> <span class="cn">nil</span>,</span>
<span id="cb351-35"><a href="mox-rocks.html#cb351-35" aria-hidden="true" tabindex="-1"></a>              recv_window <span class="op">|</span> <span class="cn">nil</span></span>
<span id="cb351-36"><a href="mox-rocks.html#cb351-36" aria-hidden="true" tabindex="-1"></a>            ) :: {<span class="va">:ok</span>, %<span class="cn">Order</span>{}} <span class="op">|</span> {<span class="va">:error</span>, term}</span></code></pre></div>
<p>In the above code, we added three <code>@callback</code> attributes that define the binance client behaviour. For clarity, we defined a distinct type for each of the arguments.</p>
<p>As we now have a binance client behaviour defined, we can use it to define a mock using the <code>Mox.defmock/2</code> function inside the <code>test_helper.exs</code> file of the <code>naive</code> application:</p>
<div class="sourceCode" id="cb352"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb352-1"><a href="mox-rocks.html#cb352-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/naive/test/test_helper.exs</span></span>
<span id="cb352-2"><a href="mox-rocks.html#cb352-2" aria-hidden="true" tabindex="-1"></a><span class="cn">ExUnit</span><span class="op">.</span>start()</span>
<span id="cb352-3"><a href="mox-rocks.html#cb352-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb352-4"><a href="mox-rocks.html#cb352-4" aria-hidden="true" tabindex="-1"></a><span class="cn">Application</span><span class="op">.</span>ensure_all_started(<span class="va">:mox</span>) <span class="co">#1</span></span>
<span id="cb352-5"><a href="mox-rocks.html#cb352-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb352-6"><a href="mox-rocks.html#cb352-6" aria-hidden="true" tabindex="-1"></a><span class="cn">Mox</span><span class="op">.</span>defmock(<span class="cn">Test</span><span class="op">.</span><span class="cn">BinanceMock</span>, <span class="kw">for</span>: <span class="cn">BinanceMock</span>) <span class="co">#2</span></span></code></pre></div>
<p>First(#1), we need to ensure that the <code>mox</code> application has been started. Then(#2), we can tell the <code>mox</code> package to define the <code>Test.BinanceMock</code> module based on the <code>BinanceMock</code> behaviour.</p>
<p>As we defined the binance client behaviour and mock, we can update our configuration to use them. We want to keep using the <code>BinanceMock</code> module in the development environment, but for the <code>test</code> environment, we would like to set the mocked module generated by the <code>mox</code> package:</p>
<div class="sourceCode" id="cb353"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb353-1"><a href="mox-rocks.html#cb353-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /config/test.exs</span></span>
<span id="cb353-2"><a href="mox-rocks.html#cb353-2" aria-hidden="true" tabindex="-1"></a>config <span class="va">:naive</span>,</span>
<span id="cb353-3"><a href="mox-rocks.html#cb353-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">binance_client:</span> <span class="cn">Test</span><span class="op">.</span><span class="cn">BinanceMock</span></span></code></pre></div>
</div>
<div id="mock-the-naiveleader-module" class="section level3" number="17.4.2">
<h3><span class="header-section-number">17.4.2</span> Mock the <code>NaiveLeader</code> module</h3>
<p>We can now move back to the <code>Naive.Trader</code> module to update all the hardcoded references to the <code>Naive.Leader</code> module with a dynamic attribute called <code>@leader</code> and add this attribute at the top of the module:</p>
<div class="sourceCode" id="cb354"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb354-1"><a href="mox-rocks.html#cb354-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/naive/lib/trader.ex</span></span>
<span id="cb354-2"><a href="mox-rocks.html#cb354-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb354-3"><a href="mox-rocks.html#cb354-3" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@leader</span> <span class="cn">Application</span><span class="op">.</span>get_env(<span class="va">:naive</span>, <span class="va">:leader</span>)</span>
<span id="cb354-4"><a href="mox-rocks.html#cb354-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb354-5"><a href="mox-rocks.html#cb354-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@leader</span><span class="op">.</span>notify(<span class="va">:trader_state_updated</span>, new_state)</span>
<span id="cb354-6"><a href="mox-rocks.html#cb354-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb354-7"><a href="mox-rocks.html#cb354-7" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@leader</span><span class="op">.</span>notify(<span class="va">:trader_state_updated</span>, new_state)</span>
<span id="cb354-8"><a href="mox-rocks.html#cb354-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb354-9"><a href="mox-rocks.html#cb354-9" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@leader</span><span class="op">.</span>notify(<span class="va">:rebuy_triggered</span>, new_state)</span>
<span id="cb354-10"><a href="mox-rocks.html#cb354-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span></code></pre></div>
<p>As it was in case of the <code>BinanceMock</code>(our dummy implementation) module, the <code>Naive.Leader</code> module doesn’t provide a behaviour - let’s fix that by defining the <code>@callback</code> attributes at the top of the module:</p>
<div class="sourceCode" id="cb355"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb355-1"><a href="mox-rocks.html#cb355-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/naive/lib/leader.ex</span></span>
<span id="cb355-2"><a href="mox-rocks.html#cb355-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb355-3"><a href="mox-rocks.html#cb355-3" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@type</span> event_type :: atom</span>
<span id="cb355-4"><a href="mox-rocks.html#cb355-4" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@callback</span> notify(event_type, %<span class="cn">Trader</span><span class="op">.</span><span class="cn">State</span>{}) :: <span class="va">:ok</span></span></code></pre></div>
<p>In the above code, we added a single <code>@callback</code> attribute that defines the naive leader behaviour. For clarity, we defined a distinct type for the <code>event_type</code> arguments.</p>
<p>As we now have a naive leader behaviour defined, we can use it to define a mock using the <code>Mox.defmock/2</code> function inside the <code>test_helper.exs</code> file of the <code>naive</code> application:</p>
<div class="sourceCode" id="cb356"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb356-1"><a href="mox-rocks.html#cb356-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/naive/test/test_helper.exs</span></span>
<span id="cb356-2"><a href="mox-rocks.html#cb356-2" aria-hidden="true" tabindex="-1"></a><span class="cn">Mox</span><span class="op">.</span>defmock(<span class="cn">Test</span><span class="op">.</span><span class="cn">Naive</span><span class="op">.</span><span class="cn">LeaderMock</span>, <span class="kw">for</span>: <span class="cn">Naive</span><span class="op">.</span><span class="cn">Leader</span>)</span></code></pre></div>
<p>In the above code, we’ve told the <code>mox</code> package to define the <code>Test.Naive.LeaderMock</code> module based on the <code>Naive.Leader</code> behaviour.</p>
<p>We are moving on to the configuration. As the <code>Naive.Leader</code> wasn’t part of the configuration, we need to add it to the default config and test config file.</p>
<p>First, let’s add the <code>:leader</code> key inside the <code>config :naive</code> in the default <code>/config/config.exs</code> configuration file:</p>
<div class="sourceCode" id="cb357"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb357-1"><a href="mox-rocks.html#cb357-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /config/config.exs</span></span>
<span id="cb357-2"><a href="mox-rocks.html#cb357-2" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb357-3"><a href="mox-rocks.html#cb357-3" aria-hidden="true" tabindex="-1"></a>config <span class="va">:naive</span>,</span>
<span id="cb357-4"><a href="mox-rocks.html#cb357-4" aria-hidden="true" tabindex="-1"></a> <span class="va">binance_client:</span> <span class="cn">BinanceMock</span>,</span>
<span id="cb357-5"><a href="mox-rocks.html#cb357-5" aria-hidden="true" tabindex="-1"></a> <span class="va">leader:</span> <span class="cn">Naive</span><span class="op">.</span><span class="cn">Leader</span>,        <span class="co"># &lt;= added</span></span>
<span id="cb357-6"><a href="mox-rocks.html#cb357-6" aria-hidden="true" tabindex="-1"></a> <span class="op">...</span></span></code></pre></div>
<p>and then we need to apply the same update to the <code>/config/test.exs</code> configuration file(it will point to the module generated by the <code>mox</code> package - <code>Test.Naive.LeaderMock</code>):</p>
<div class="sourceCode" id="cb358"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb358-1"><a href="mox-rocks.html#cb358-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /config/test.exs</span></span>
<span id="cb358-2"><a href="mox-rocks.html#cb358-2" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb358-3"><a href="mox-rocks.html#cb358-3" aria-hidden="true" tabindex="-1"></a>config <span class="va">:naive</span>,</span>
<span id="cb358-4"><a href="mox-rocks.html#cb358-4" aria-hidden="true" tabindex="-1"></a><span class="va">binance_client:</span> <span class="cn">Test</span><span class="op">.</span><span class="cn">BinanceMock</span>,</span>
<span id="cb358-5"><a href="mox-rocks.html#cb358-5" aria-hidden="true" tabindex="-1"></a><span class="va">leader:</span> <span class="cn">Test</span><span class="op">.</span><span class="cn">Naive</span><span class="op">.</span><span class="cn">LeaderMock</span>     <span class="co"># &lt;= added</span></span>
<span id="cb358-6"><a href="mox-rocks.html#cb358-6" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span></code></pre></div>
<div style="page-break-after: always;"></div>
</div>
<div id="mock-the-phoenix.pubsub-module" class="section level3" number="17.4.3">
<h3><span class="header-section-number">17.4.3</span> Mock the <code>Phoenix.PubSub</code> module</h3>
<p>Mocking the <code>Phoenix.PubSub</code> dependency inside the <code>Naive.Trader</code> module will look very similar to the last two mocked modules.</p>
<p>Inside the <code>Naive.Trader</code> module we need to update all the references to the <code>Phoenix.PubSub</code> to an <code>@pubsub_client</code> attribute with value dependent on the configuration:</p>
<div class="sourceCode" id="cb359"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb359-1"><a href="mox-rocks.html#cb359-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/naive/lib/trader.ex</span></span>
<span id="cb359-2"><a href="mox-rocks.html#cb359-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb359-3"><a href="mox-rocks.html#cb359-3" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@pubsub_client</span> <span class="cn">Application</span><span class="op">.</span>get_env(<span class="va">:core</span>, <span class="va">:pubsub_client</span>)</span>
<span id="cb359-4"><a href="mox-rocks.html#cb359-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb359-5"><a href="mox-rocks.html#cb359-5" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@pubsub_client</span><span class="op">.</span>subscribe(</span>
<span id="cb359-6"><a href="mox-rocks.html#cb359-6" aria-hidden="true" tabindex="-1"></a>      <span class="cn">Core</span><span class="op">.</span><span class="cn">PubSub</span>,</span>
<span id="cb359-7"><a href="mox-rocks.html#cb359-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;TRADE_EVENTS:</span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st">&quot;</span></span>
<span id="cb359-8"><a href="mox-rocks.html#cb359-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb359-9"><a href="mox-rocks.html#cb359-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb359-10"><a href="mox-rocks.html#cb359-10" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@pubsub_client</span><span class="op">.</span>broadcast(</span>
<span id="cb359-11"><a href="mox-rocks.html#cb359-11" aria-hidden="true" tabindex="-1"></a>      <span class="cn">Core</span><span class="op">.</span><span class="cn">PubSub</span>,</span>
<span id="cb359-12"><a href="mox-rocks.html#cb359-12" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;ORDERS:</span><span class="ot">#{</span>order<span class="op">.</span>symbol<span class="ot">}</span><span class="st">&quot;</span>,</span>
<span id="cb359-13"><a href="mox-rocks.html#cb359-13" aria-hidden="true" tabindex="-1"></a>      order</span>
<span id="cb359-14"><a href="mox-rocks.html#cb359-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb359-15"><a href="mox-rocks.html#cb359-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span></code></pre></div>
<p>The <code>Phoenix.PubSub</code> module doesn’t provide a behaviour. As we can’t modify its source, we need to create a new module to define the PubSub behaviour. Let’s create a new file called <code>test.ex</code> inside the <code>/apps/core/lib/core</code> directory with the following behaviour definition:</p>
<div class="sourceCode" id="cb360"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb360-1"><a href="mox-rocks.html#cb360-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/core/lib/core/test.ex</span></span>
<span id="cb360-2"><a href="mox-rocks.html#cb360-2" aria-hidden="true" tabindex="-1"></a><span class="kw">defmodule</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">Test</span> <span class="kw">do</span></span>
<span id="cb360-3"><a href="mox-rocks.html#cb360-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defmodule</span> <span class="cn">PubSub</span> <span class="kw">do</span></span>
<span id="cb360-4"><a href="mox-rocks.html#cb360-4" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@type</span> t :: atom</span>
<span id="cb360-5"><a href="mox-rocks.html#cb360-5" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@type</span> topic :: binary</span>
<span id="cb360-6"><a href="mox-rocks.html#cb360-6" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@type</span> message :: term</span>
<span id="cb360-7"><a href="mox-rocks.html#cb360-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb360-8"><a href="mox-rocks.html#cb360-8" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@callback</span> subscribe(t, topic) :: <span class="va">:ok</span> <span class="op">|</span> {<span class="va">:error</span>, term}</span>
<span id="cb360-9"><a href="mox-rocks.html#cb360-9" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@callback</span> broadcast(t, topic, message) :: <span class="va">:ok</span> <span class="op">|</span> {<span class="va">:error</span>, term}</span>
<span id="cb360-10"><a href="mox-rocks.html#cb360-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb360-11"><a href="mox-rocks.html#cb360-11" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<p>As previously, we defined a couple of callbacks and additional types for each of their arguments.</p>
<div style="page-break-after: always;"></div>
<p>Next, we will use the above behaviour to define a mock using the <code>Mox.defmock/2</code> function inside the <code>test_helper.exs</code> file of the <code>naive</code> application:</p>
<div class="sourceCode" id="cb361"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb361-1"><a href="mox-rocks.html#cb361-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/naive/test/test_helper.exs</span></span>
<span id="cb361-2"><a href="mox-rocks.html#cb361-2" aria-hidden="true" tabindex="-1"></a><span class="cn">Mox</span><span class="op">.</span>defmock(<span class="cn">Test</span><span class="op">.</span><span class="cn">PubSubMock</span>, <span class="kw">for</span>: <span class="cn">Core</span><span class="op">.</span><span class="cn">Test</span><span class="op">.</span><span class="cn">PubSub</span>)</span></code></pre></div>
<p>In the above code, we’ve told the <code>mox</code> package to define the <code>Test.PubSubMock</code> module based on the <code>Core.Test.PubSub</code> behaviour.</p>
<p>The final step will be to append the <code>:core, :pubsub_client</code> configuration to the <code>/config/config.exs</code> file:</p>
<div class="sourceCode" id="cb362"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb362-1"><a href="mox-rocks.html#cb362-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /config/config.exs</span></span>
<span id="cb362-2"><a href="mox-rocks.html#cb362-2" aria-hidden="true" tabindex="-1"></a>config <span class="va">:core</span>,                  <span class="co"># &lt;= added</span></span>
<span id="cb362-3"><a href="mox-rocks.html#cb362-3" aria-hidden="true" tabindex="-1"></a> <span class="va">pubsub_client:</span> <span class="cn">Phoenix</span><span class="op">.</span><span class="cn">PubSub</span> <span class="co"># &lt;= added</span></span></code></pre></div>
<p>and the test <code>/config/test.exs</code> configuration file:</p>
<div class="sourceCode" id="cb363"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb363-1"><a href="mox-rocks.html#cb363-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /config/test.exs</span></span>
<span id="cb363-2"><a href="mox-rocks.html#cb363-2" aria-hidden="true" tabindex="-1"></a>config <span class="va">:core</span>,                  <span class="co"># &lt;= added</span></span>
<span id="cb363-3"><a href="mox-rocks.html#cb363-3" aria-hidden="true" tabindex="-1"></a><span class="va">pubsub_client:</span> <span class="cn">Test</span><span class="op">.</span><span class="cn">PubSubMock</span> <span class="co"># &lt;= added</span></span></code></pre></div>
</div>
<div id="mock-the-logger-module" class="section level3" number="17.4.4">
<h3><span class="header-section-number">17.4.4</span> Mock the <code>Logger</code> module</h3>
<p>Before we dive in, we should ask ourselves why we would mock the <code>Logger</code> module?</p>
<p>We could raise the logging level to <code>error</code> and be done with it. Yes, that would fix all debug/info/warning logs, but we would also miss an opportunity to confirm a few details (depends on what’s necessary for our use case):</p>
<ul>
<li>you can ensure that the log was called when the tested function was run</li>
<li>you can pattern match the logging level</li>
<li>you can check the message. This could be useful if you don’t want to put sensitive information like banking details etc. inside log messages</li>
</ul>
<p>Mocking the <code>Logger</code> dependency inside the <code>Naive.Trader</code> module will follow the same steps as the previous updates.</p>
<p>Inside the <code>Naive.Trader</code> module we need to update all the references to the <code>Logger</code> to an <code>@logger</code> attribute with value dependent on the configuration:</p>
<div class="sourceCode" id="cb364"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb364-1"><a href="mox-rocks.html#cb364-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/naive/lib/trader.ex</span></span>
<span id="cb364-2"><a href="mox-rocks.html#cb364-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb364-3"><a href="mox-rocks.html#cb364-3" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@logger</span> <span class="cn">Application</span><span class="op">.</span>get_env(<span class="va">:core</span>, <span class="va">:logger</span>)</span>
<span id="cb364-4"><a href="mox-rocks.html#cb364-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb364-5"><a href="mox-rocks.html#cb364-5" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@logger</span><span class="op">.</span>info(<span class="st">&quot;Initializing new trader(</span><span class="ot">#{</span>id<span class="ot">}</span><span class="st">) for </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st">&quot;</span>)</span>
<span id="cb364-6"><a href="mox-rocks.html#cb364-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb364-7"><a href="mox-rocks.html#cb364-7" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@logger</span><span class="op">.</span>info(</span>
<span id="cb364-8"><a href="mox-rocks.html#cb364-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;The trader(</span><span class="ot">#{</span>id<span class="ot">}</span><span class="st">) is placing a BUY order &quot;</span> <span class="op">&lt;&gt;</span></span>
<span id="cb364-9"><a href="mox-rocks.html#cb364-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;for </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st"> @ </span><span class="ot">#{</span>price<span class="ot">}</span><span class="st">, quantity: </span><span class="ot">#{</span>quantity<span class="ot">}</span><span class="st">&quot;</span></span>
<span id="cb364-10"><a href="mox-rocks.html#cb364-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb364-11"><a href="mox-rocks.html#cb364-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb364-12"><a href="mox-rocks.html#cb364-12" aria-hidden="true" tabindex="-1"></a>        <span class="ot">@logger</span><span class="op">.</span>info(</span>
<span id="cb364-13"><a href="mox-rocks.html#cb364-13" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;The trader(</span><span class="ot">#{</span>id<span class="ot">}</span><span class="st">) is placing a SELL order for &quot;</span> <span class="op">&lt;&gt;</span></span>
<span id="cb364-14"><a href="mox-rocks.html#cb364-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;</span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st"> @ </span><span class="ot">#{</span>sell_price<span class="ot">}</span><span class="st">, quantity: </span><span class="ot">#{</span>quantity<span class="ot">}</span><span class="st">.&quot;</span></span>
<span id="cb364-15"><a href="mox-rocks.html#cb364-15" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb364-16"><a href="mox-rocks.html#cb364-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb364-17"><a href="mox-rocks.html#cb364-17" aria-hidden="true" tabindex="-1"></a>        <span class="ot">@logger</span><span class="op">.</span>info(<span class="st">&quot;Trader&#39;s(</span><span class="ot">#{</span>id<span class="ot">}</span><span class="st"> </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st"> buy order got partially filled&quot;</span>)</span>
<span id="cb364-18"><a href="mox-rocks.html#cb364-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb364-19"><a href="mox-rocks.html#cb364-19" aria-hidden="true" tabindex="-1"></a>      <span class="ot">@logger</span><span class="op">.</span>info(<span class="st">&quot;Trader(</span><span class="ot">#{</span>id<span class="ot">}</span><span class="st">) finished trade cycle for </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st">&quot;</span>)</span>
<span id="cb364-20"><a href="mox-rocks.html#cb364-20" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb364-21"><a href="mox-rocks.html#cb364-21" aria-hidden="true" tabindex="-1"></a>      <span class="ot">@logger</span><span class="op">.</span>info(<span class="st">&quot;Trader&#39;s(</span><span class="ot">#{</span>id<span class="ot">}</span><span class="st"> </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st"> SELL order got partially filled&quot;</span>)</span>
<span id="cb364-22"><a href="mox-rocks.html#cb364-22" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb364-23"><a href="mox-rocks.html#cb364-23" aria-hidden="true" tabindex="-1"></a>      <span class="ot">@logger</span><span class="op">.</span>info(<span class="st">&quot;Rebuy triggered for </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st"> by the trader(</span><span class="ot">#{</span>id<span class="ot">}</span><span class="st">)&quot;</span>)</span>
<span id="cb364-24"><a href="mox-rocks.html#cb364-24" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span></code></pre></div>
<p>The <code>Logger</code> module doesn’t provide a behaviour. As we can’t modify its source, we need to create a new module to define the Logger behaviour. Let’s place it inside the <code>Core.Test</code> namespace in the <code>/apps/core/lib/core/test.ex</code> file side by side with the PubSub behaviour with the following definition:</p>
<div class="sourceCode" id="cb365"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb365-1"><a href="mox-rocks.html#cb365-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/core/lib/core/test.ex</span></span>
<span id="cb365-2"><a href="mox-rocks.html#cb365-2" aria-hidden="true" tabindex="-1"></a><span class="kw">defmodule</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">Test</span> <span class="kw">do</span></span>
<span id="cb365-3"><a href="mox-rocks.html#cb365-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb365-4"><a href="mox-rocks.html#cb365-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defmodule</span> <span class="cn">Logger</span> <span class="kw">do</span></span>
<span id="cb365-5"><a href="mox-rocks.html#cb365-5" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@type</span> message :: binary</span>
<span id="cb365-6"><a href="mox-rocks.html#cb365-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb365-7"><a href="mox-rocks.html#cb365-7" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@callback</span> info(message) :: <span class="va">:ok</span></span>
<span id="cb365-8"><a href="mox-rocks.html#cb365-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb365-9"><a href="mox-rocks.html#cb365-9" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<p>As previously, we defined a callback and additional type for the <code>message</code> argument.</p>
<p>Next, we will use the above behaviour to define a mock using the <code>Mox.defmock/2</code> function inside the <code>test_helper.exs</code> file of the <code>naive</code> application:</p>
<div class="sourceCode" id="cb366"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb366-1"><a href="mox-rocks.html#cb366-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/naive/test/test_helper.exs</span></span>
<span id="cb366-2"><a href="mox-rocks.html#cb366-2" aria-hidden="true" tabindex="-1"></a><span class="cn">Mox</span><span class="op">.</span>defmock(<span class="cn">Test</span><span class="op">.</span><span class="cn">LoggerMock</span>, <span class="kw">for</span>: <span class="cn">Core</span><span class="op">.</span><span class="cn">Test</span><span class="op">.</span><span class="cn">Logger</span>)</span></code></pre></div>
<p>In the above code, we’ve told the <code>mox</code> package to define the <code>Test.LoggerMock</code> module based on the <code>Core.Test.Logger</code> behaviour.</p>
<div style="page-break-after: always;"></div>
<p>The final step will be to append the <code>:core, :logger</code> configuration to the <code>/config/config.exs</code> file:</p>
<div class="sourceCode" id="cb367"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb367-1"><a href="mox-rocks.html#cb367-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /config/config.exs</span></span>
<span id="cb367-2"><a href="mox-rocks.html#cb367-2" aria-hidden="true" tabindex="-1"></a>config <span class="va">:core</span>,                                   </span>
<span id="cb367-3"><a href="mox-rocks.html#cb367-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">logger:</span> <span class="cn">Logger</span>,                <span class="co"># &lt;= added</span></span>
<span id="cb367-4"><a href="mox-rocks.html#cb367-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">pubsub_client:</span> <span class="cn">Phoenix</span><span class="op">.</span><span class="cn">PubSub</span></span></code></pre></div>
<p>and the test <code>/config/test.exs</code> configuration file:</p>
<div class="sourceCode" id="cb368"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb368-1"><a href="mox-rocks.html#cb368-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /config/test.exs</span></span>
<span id="cb368-2"><a href="mox-rocks.html#cb368-2" aria-hidden="true" tabindex="-1"></a>config <span class="va">:core</span>,                                   </span>
<span id="cb368-3"><a href="mox-rocks.html#cb368-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">logger:</span> <span class="cn">Test</span><span class="op">.</span><span class="cn">LoggerMock</span>,        <span class="co"># &lt;= added</span></span>
<span id="cb368-4"><a href="mox-rocks.html#cb368-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">pubsub_client:</span> <span class="cn">Test</span><span class="op">.</span><span class="cn">PubSubMock</span></span></code></pre></div>
<p>This finishes the updates to the <code>Naive.Trader</code> module. We made all dependencies based on the configuration values. We can now progress to writing the test.</p>
</div>
</div>
<div id="implement-a-test-of-the-naive.trader-module" class="section level2" number="17.5">
<h2><span class="header-section-number">17.5</span> Implement a test of the <code>Naive.Trader</code> module</h2>
<p>Finally, we can implement the unit test for the <code>Naive.Trader</code> module.</p>
<p>We will create a folder called <code>naive</code> inside the <code>/apps/naive/test</code> directory and a new file called <code>trader_test.exs</code> inside it.</p>
<p>Let’s start with an empty skeleton of the test tagged as <code>unit</code>:</p>
<div class="sourceCode" id="cb369"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb369-1"><a href="mox-rocks.html#cb369-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/naive/test/naive/trader_test.exs</span></span>
<span id="cb369-2"><a href="mox-rocks.html#cb369-2" aria-hidden="true" tabindex="-1"></a><span class="kw">defmodule</span> <span class="cn">Naive</span><span class="op">.</span><span class="cn">TraderTest</span> <span class="kw">do</span></span>
<span id="cb369-3"><a href="mox-rocks.html#cb369-3" aria-hidden="true" tabindex="-1"></a>  <span class="im">use</span> <span class="cn">ExUnit</span><span class="op">.</span><span class="cn">Case</span></span>
<span id="cb369-4"><a href="mox-rocks.html#cb369-4" aria-hidden="true" tabindex="-1"></a>  doctest <span class="cn">Naive</span><span class="op">.</span><span class="cn">Trader</span></span>
<span id="cb369-5"><a href="mox-rocks.html#cb369-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb369-6"><a href="mox-rocks.html#cb369-6" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@tag</span> <span class="va">:unit</span></span>
<span id="cb369-7"><a href="mox-rocks.html#cb369-7" aria-hidden="true" tabindex="-1"></a>  test <span class="st">&quot;Placing buy order test&quot;</span> <span class="kw">do</span></span>
<span id="cb369-8"><a href="mox-rocks.html#cb369-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb369-9"><a href="mox-rocks.html#cb369-9" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<p>Let’s add the <code>mox</code> related code above the <code>@tag :unit</code> line:</p>
<div class="sourceCode" id="cb370"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb370-1"><a href="mox-rocks.html#cb370-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/naive/test/naive/trader_test.exs</span></span>
<span id="cb370-2"><a href="mox-rocks.html#cb370-2" aria-hidden="true" tabindex="-1"></a>  <span class="im">import</span> <span class="cn">Mox</span>                   <span class="co"># &lt;= 1 </span></span>
<span id="cb370-3"><a href="mox-rocks.html#cb370-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb370-4"><a href="mox-rocks.html#cb370-4" aria-hidden="true" tabindex="-1"></a>  setup <span class="va">:set_mox_from_context</span>  <span class="co"># &lt;= 2</span></span>
<span id="cb370-5"><a href="mox-rocks.html#cb370-5" aria-hidden="true" tabindex="-1"></a>  setup <span class="va">:verify_on_exit!</span>       <span class="co"># &lt;= 3</span></span></code></pre></div>
<div style="page-break-after: always;"></div>
<p>In the above code, we are:</p>
<ul>
<li>importing the <code>mox</code> module so we will be able to use functions like <code>expect/3</code></li>
<li>allowing any process to consume mocks defined by the test. This is crucial as tests are run as separate processes that would normally be the only ones allowed to use mocks that they define. Inside our test, we will start a new <code>Naive.Trader</code> process that needs to be able to access mocks defined in the test - hence this update</li>
<li>telling <code>mox</code> to verify that all the mocks defined in the tests have been called from within those tests. Otherwise, it will flag such cases as test errors</li>
</ul>
<p>Inside our test, we need to define implementation for all the functions that the <code>Naive.Trader</code> relies on:</p>
<div class="sourceCode" id="cb371"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb371-1"><a href="mox-rocks.html#cb371-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/naive/test/naive/trader_test.exs</span></span>
<span id="cb371-2"><a href="mox-rocks.html#cb371-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb371-3"><a href="mox-rocks.html#cb371-3" aria-hidden="true" tabindex="-1"></a>  test <span class="st">&quot;Placing buy order test&quot;</span> <span class="kw">do</span></span>
<span id="cb371-4"><a href="mox-rocks.html#cb371-4" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Test</span><span class="op">.</span><span class="cn">PubSubMock</span></span>
<span id="cb371-5"><a href="mox-rocks.html#cb371-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">|&gt;</span> expect(<span class="va">:subscribe</span>, <span class="kw">fn</span> _module, <span class="st">&quot;TRADE_EVENTS:XRPUSDT&quot;</span> <span class="op">-&gt;</span> <span class="va">:ok</span> <span class="kw">end</span>) <span class="co"># &lt;= 1</span></span>
<span id="cb371-6"><a href="mox-rocks.html#cb371-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">|&gt;</span> expect(<span class="va">:broadcast</span>, <span class="kw">fn</span> _module, <span class="st">&quot;ORDERS:XRPUSDT&quot;</span>, _order <span class="op">-&gt;</span> <span class="va">:ok</span> <span class="kw">end</span>)</span>
<span id="cb371-7"><a href="mox-rocks.html#cb371-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb371-8"><a href="mox-rocks.html#cb371-8" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Test</span><span class="op">.</span><span class="cn">BinanceMock</span></span>
<span id="cb371-9"><a href="mox-rocks.html#cb371-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">|&gt;</span> expect(<span class="va">:order_limit_buy</span>, <span class="kw">fn</span> <span class="st">&quot;XRPUSDT&quot;</span>, <span class="st">&quot;464.360&quot;</span>, <span class="st">&quot;0.4307&quot;</span>, <span class="st">&quot;GTC&quot;</span> <span class="op">-&gt;</span> <span class="co"># &lt;= 2</span></span>
<span id="cb371-10"><a href="mox-rocks.html#cb371-10" aria-hidden="true" tabindex="-1"></a>      {<span class="va">:ok</span>,</span>
<span id="cb371-11"><a href="mox-rocks.html#cb371-11" aria-hidden="true" tabindex="-1"></a>       <span class="cn">BinanceMock</span><span class="op">.</span>generate_fake_order(</span>
<span id="cb371-12"><a href="mox-rocks.html#cb371-12" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;XRPUSDT&quot;</span>,</span>
<span id="cb371-13"><a href="mox-rocks.html#cb371-13" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;464.360&quot;</span>,</span>
<span id="cb371-14"><a href="mox-rocks.html#cb371-14" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;0.4307&quot;</span>,</span>
<span id="cb371-15"><a href="mox-rocks.html#cb371-15" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;BUY&quot;</span></span>
<span id="cb371-16"><a href="mox-rocks.html#cb371-16" aria-hidden="true" tabindex="-1"></a>       )</span>
<span id="cb371-17"><a href="mox-rocks.html#cb371-17" aria-hidden="true" tabindex="-1"></a>       <span class="op">|&gt;</span> <span class="cn">BinanceMock</span><span class="op">.</span>convert_order_to_order_response()}</span>
<span id="cb371-18"><a href="mox-rocks.html#cb371-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span>)</span>
<span id="cb371-19"><a href="mox-rocks.html#cb371-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb371-20"><a href="mox-rocks.html#cb371-20" aria-hidden="true" tabindex="-1"></a>    test_pid <span class="op">=</span> self() <span class="co"># &lt;= 3</span></span>
<span id="cb371-21"><a href="mox-rocks.html#cb371-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb371-22"><a href="mox-rocks.html#cb371-22" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Test</span><span class="op">.</span><span class="cn">Naive</span><span class="op">.</span><span class="cn">LeaderMock</span></span>
<span id="cb371-23"><a href="mox-rocks.html#cb371-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">|&gt;</span> expect(<span class="va">:notify</span>, <span class="kw">fn</span> <span class="va">:trader_state_updated</span>, %<span class="cn">Naive</span><span class="op">.</span><span class="cn">Trader</span><span class="op">.</span><span class="cn">State</span>{} <span class="op">-&gt;</span></span>
<span id="cb371-24"><a href="mox-rocks.html#cb371-24" aria-hidden="true" tabindex="-1"></a>      send(test_pid, <span class="va">:ok</span>) <span class="co"># &lt;= 3</span></span>
<span id="cb371-25"><a href="mox-rocks.html#cb371-25" aria-hidden="true" tabindex="-1"></a>      <span class="va">:ok</span></span>
<span id="cb371-26"><a href="mox-rocks.html#cb371-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span>)</span>
<span id="cb371-27"><a href="mox-rocks.html#cb371-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb371-28"><a href="mox-rocks.html#cb371-28" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Test</span><span class="op">.</span><span class="cn">LoggerMock</span></span>
<span id="cb371-29"><a href="mox-rocks.html#cb371-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">|&gt;</span> expect(<span class="va">:info</span>, <span class="dv">2</span>, <span class="kw">fn</span> _message <span class="op">-&gt;</span> <span class="va">:ok</span> <span class="kw">end</span>) <span class="co"># &lt;= 4</span></span>
<span id="cb371-30"><a href="mox-rocks.html#cb371-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span></code></pre></div>
<p>It’s important to note that we defined the mocked function with expected values in the above code. We expect our test to subscribe to a specific topic and broadcast to the other(#1). We are also expecting that process will place an order at the exact values that we calculated upfront. This way, our mock becomes an integral part of the test, asserting that the correct values will be passed to other parts of the system(dependencies of the <code>Naive.Trader</code> module).</p>
<p>Another “trick”(#3) that we can use in our mocks is to leverage the fact that we can send a message to the test process from within the mocked function. We will leverage this idea to know precisely when the trader process finished its work as the <code>notify/1</code> is the last function call inside the process’ callback(<code>handle_info/2</code> inside the <code>Naive.Trader</code> module). We will assert that we should receive the message, and the test will be waiting for it before exiting(the default timeout is 100ms) instead of using hardcoded <code>sleep</code> to “hack” it to work.</p>
<p>The final part(#4) tells the <code>mox</code> package that <code>Logger.info/1</code> will be called twice inside the test. The <code>mox</code> will verify the number of calls to the mocked function and error if it doesn’t much the expected amount.</p>
<p>The second part of the test is preparing the initial state for the <code>Naive.Trader</code> process, generating trade event and sending it to the process:</p>
<div class="sourceCode" id="cb372"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb372-1"><a href="mox-rocks.html#cb372-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/naive/test/naive/trader_test.exs</span></span>
<span id="cb372-2"><a href="mox-rocks.html#cb372-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb372-3"><a href="mox-rocks.html#cb372-3" aria-hidden="true" tabindex="-1"></a>  test <span class="st">&quot;Placing buy order test&quot;</span> <span class="kw">do</span></span>
<span id="cb372-4"><a href="mox-rocks.html#cb372-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb372-5"><a href="mox-rocks.html#cb372-5" aria-hidden="true" tabindex="-1"></a>    trader_state <span class="op">=</span> dummy_trader_state()</span>
<span id="cb372-6"><a href="mox-rocks.html#cb372-6" aria-hidden="true" tabindex="-1"></a>    trade_event <span class="op">=</span> generate_event(<span class="dv">1</span>, <span class="st">&quot;0.43183010&quot;</span>, <span class="st">&quot;213.10000000&quot;</span>)</span>
<span id="cb372-7"><a href="mox-rocks.html#cb372-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb372-8"><a href="mox-rocks.html#cb372-8" aria-hidden="true" tabindex="-1"></a>    {<span class="va">:ok</span>, trader_pid} <span class="op">=</span> <span class="cn">Naive</span><span class="op">.</span><span class="cn">Trader</span><span class="op">.</span>start_link(trader_state)</span>
<span id="cb372-9"><a href="mox-rocks.html#cb372-9" aria-hidden="true" tabindex="-1"></a>    send(trader_pid, trade_event)</span>
<span id="cb372-10"><a href="mox-rocks.html#cb372-10" aria-hidden="true" tabindex="-1"></a>    assert_receive <span class="va">:ok</span></span>
<span id="cb372-11"><a href="mox-rocks.html#cb372-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>As described above, the <code>assert_receive/1</code> function will cause the test to wait for the message for 100ms before quitting.</p>
<p>Here are the helper functions that we used to generate the initial trader state and trade event:</p>
<div class="sourceCode" id="cb373"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb373-1"><a href="mox-rocks.html#cb373-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/naive/test/naive/trader_test.exs</span></span>
<span id="cb373-2"><a href="mox-rocks.html#cb373-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb373-3"><a href="mox-rocks.html#cb373-3" aria-hidden="true" tabindex="-1"></a>  test <span class="st">&quot;Placing buy order test&quot;</span> <span class="kw">do</span></span>
<span id="cb373-4"><a href="mox-rocks.html#cb373-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb373-5"><a href="mox-rocks.html#cb373-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb373-6"><a href="mox-rocks.html#cb373-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb373-7"><a href="mox-rocks.html#cb373-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defp</span> dummy_trader_state() <span class="kw">do</span></span>
<span id="cb373-8"><a href="mox-rocks.html#cb373-8" aria-hidden="true" tabindex="-1"></a>    %<span class="cn">Naive</span><span class="op">.</span><span class="cn">Trader</span><span class="op">.</span><span class="cn">State</span>{</span>
<span id="cb373-9"><a href="mox-rocks.html#cb373-9" aria-hidden="true" tabindex="-1"></a>      <span class="va">id:</span> <span class="dv">100_000_000</span>,</span>
<span id="cb373-10"><a href="mox-rocks.html#cb373-10" aria-hidden="true" tabindex="-1"></a>      <span class="va">symbol:</span> <span class="st">&quot;XRPUSDT&quot;</span>,</span>
<span id="cb373-11"><a href="mox-rocks.html#cb373-11" aria-hidden="true" tabindex="-1"></a>      <span class="va">budget:</span> <span class="st">&quot;200&quot;</span>,</span>
<span id="cb373-12"><a href="mox-rocks.html#cb373-12" aria-hidden="true" tabindex="-1"></a>      <span class="va">buy_order:</span> <span class="cn">nil</span>,</span>
<span id="cb373-13"><a href="mox-rocks.html#cb373-13" aria-hidden="true" tabindex="-1"></a>      <span class="va">sell_order:</span> <span class="cn">nil</span>,</span>
<span id="cb373-14"><a href="mox-rocks.html#cb373-14" aria-hidden="true" tabindex="-1"></a>      <span class="va">buy_down_interval:</span> <span class="cn">Decimal</span><span class="op">.</span>new(<span class="st">&quot;0.0025&quot;</span>),</span>
<span id="cb373-15"><a href="mox-rocks.html#cb373-15" aria-hidden="true" tabindex="-1"></a>      <span class="va">profit_interval:</span> <span class="cn">Decimal</span><span class="op">.</span>new(<span class="st">&quot;0.001&quot;</span>),</span>
<span id="cb373-16"><a href="mox-rocks.html#cb373-16" aria-hidden="true" tabindex="-1"></a>      <span class="va">rebuy_interval:</span> <span class="cn">Decimal</span><span class="op">.</span>new(<span class="st">&quot;0.006&quot;</span>),</span>
<span id="cb373-17"><a href="mox-rocks.html#cb373-17" aria-hidden="true" tabindex="-1"></a>      <span class="va">rebuy_notified:</span> <span class="cn">false</span>,</span>
<span id="cb373-18"><a href="mox-rocks.html#cb373-18" aria-hidden="true" tabindex="-1"></a>      <span class="va">tick_size:</span> <span class="st">&quot;0.0001&quot;</span>,</span>
<span id="cb373-19"><a href="mox-rocks.html#cb373-19" aria-hidden="true" tabindex="-1"></a>      <span class="va">step_size:</span> <span class="st">&quot;0.001&quot;</span></span>
<span id="cb373-20"><a href="mox-rocks.html#cb373-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb373-21"><a href="mox-rocks.html#cb373-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb373-22"><a href="mox-rocks.html#cb373-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb373-23"><a href="mox-rocks.html#cb373-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defp</span> generate_event(id, price, quantity) <span class="kw">do</span></span>
<span id="cb373-24"><a href="mox-rocks.html#cb373-24" aria-hidden="true" tabindex="-1"></a>    %<span class="cn">Core</span><span class="op">.</span><span class="cn">Struct</span><span class="op">.</span><span class="cn">TradeEvent</span>{</span>
<span id="cb373-25"><a href="mox-rocks.html#cb373-25" aria-hidden="true" tabindex="-1"></a>      <span class="va">event_type:</span> <span class="st">&quot;trade&quot;</span>,</span>
<span id="cb373-26"><a href="mox-rocks.html#cb373-26" aria-hidden="true" tabindex="-1"></a>      <span class="va">event_time:</span> <span class="dv">1_000</span> <span class="op">+</span> id <span class="op">*</span> <span class="dv">10</span>,</span>
<span id="cb373-27"><a href="mox-rocks.html#cb373-27" aria-hidden="true" tabindex="-1"></a>      <span class="va">symbol:</span> <span class="st">&quot;XRPUSDT&quot;</span>,</span>
<span id="cb373-28"><a href="mox-rocks.html#cb373-28" aria-hidden="true" tabindex="-1"></a>      <span class="va">trade_id:</span> <span class="dv">2_000</span> <span class="op">+</span> id <span class="op">*</span> <span class="dv">10</span>,</span>
<span id="cb373-29"><a href="mox-rocks.html#cb373-29" aria-hidden="true" tabindex="-1"></a>      <span class="va">price:</span> price,</span>
<span id="cb373-30"><a href="mox-rocks.html#cb373-30" aria-hidden="true" tabindex="-1"></a>      <span class="va">quantity:</span> quantity,</span>
<span id="cb373-31"><a href="mox-rocks.html#cb373-31" aria-hidden="true" tabindex="-1"></a>      <span class="va">buyer_order_id:</span> <span class="dv">3_000</span> <span class="op">+</span> id <span class="op">*</span> <span class="dv">10</span>,</span>
<span id="cb373-32"><a href="mox-rocks.html#cb373-32" aria-hidden="true" tabindex="-1"></a>      <span class="va">seller_order_id:</span> <span class="dv">4_000</span> <span class="op">+</span> id <span class="op">*</span> <span class="dv">10</span>,</span>
<span id="cb373-33"><a href="mox-rocks.html#cb373-33" aria-hidden="true" tabindex="-1"></a>      <span class="va">trade_time:</span> <span class="dv">5_000</span> <span class="op">+</span> id <span class="op">*</span> <span class="dv">10</span>,</span>
<span id="cb373-34"><a href="mox-rocks.html#cb373-34" aria-hidden="true" tabindex="-1"></a>      <span class="va">buyer_market_maker:</span> <span class="cn">false</span></span>
<span id="cb373-35"><a href="mox-rocks.html#cb373-35" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb373-36"><a href="mox-rocks.html#cb373-36" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>The above code finishes the implementation of the test, but inside it, we used functions from the <code>BinanceMock</code> module that are private. We need to update the module by making the <code>generate_fake_order/4</code> and<br />
<code>convert_order_to_order_response/1</code> function public(and moving them up in the module, so they are next to other public functions):</p>
<div class="sourceCode" id="cb374"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb374-1"><a href="mox-rocks.html#cb374-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/binance_mock/lib/binance_mock.ex</span></span>
<span id="cb374-2"><a href="mox-rocks.html#cb374-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb374-3"><a href="mox-rocks.html#cb374-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> get_order(symbol, time, order_id) <span class="kw">do</span></span>
<span id="cb374-4"><a href="mox-rocks.html#cb374-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb374-5"><a href="mox-rocks.html#cb374-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb374-6"><a href="mox-rocks.html#cb374-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb374-7"><a href="mox-rocks.html#cb374-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> generate_fake_order(symbol, quantity, price, side) <span class="co"># &lt;= updated to public</span></span>
<span id="cb374-8"><a href="mox-rocks.html#cb374-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb374-9"><a href="mox-rocks.html#cb374-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb374-10"><a href="mox-rocks.html#cb374-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb374-11"><a href="mox-rocks.html#cb374-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> convert_order_to_order_response(%<span class="cn">Binance</span><span class="op">.</span><span class="cn">Order</span>{} <span class="op">=</span> order) <span class="kw">do</span> <span class="co"># &lt;= updated to public</span></span>
<span id="cb374-12"><a href="mox-rocks.html#cb374-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb374-13"><a href="mox-rocks.html#cb374-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb374-14"><a href="mox-rocks.html#cb374-14" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span></code></pre></div>
<p>We updated both of the methods to public and moved them up after the <code>get_order/3</code> function.</p>
</div>
<div id="define-an-alias-to-run-unit-tests" class="section level2" number="17.6">
<h2><span class="header-section-number">17.6</span> Define an alias to run unit tests</h2>
<p>Our unit test should be run without running the whole application, so we need to run them with the <code>--no-start</code> argument. We should also select unit tests by tag(<code>--only unit</code>). Let’s create an alias that will hide those details:</p>
<div class="sourceCode" id="cb375"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb375-1"><a href="mox-rocks.html#cb375-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /mix.exs</span></span>
<span id="cb375-2"><a href="mox-rocks.html#cb375-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defp</span> aliases <span class="kw">do</span></span>
<span id="cb375-3"><a href="mox-rocks.html#cb375-3" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb375-4"><a href="mox-rocks.html#cb375-4" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span></span>
<span id="cb375-5"><a href="mox-rocks.html#cb375-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;test.unit&quot;</span>: [</span>
<span id="cb375-6"><a href="mox-rocks.html#cb375-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;test --only unit --no-start&quot;</span></span>
<span id="cb375-7"><a href="mox-rocks.html#cb375-7" aria-hidden="true" tabindex="-1"></a>      ]</span>
<span id="cb375-8"><a href="mox-rocks.html#cb375-8" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb375-9"><a href="mox-rocks.html#cb375-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>We can now run our test using a terminal:</p>
<div class="sourceCode" id="cb376"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb376-1"><a href="mox-rocks.html#cb376-1" aria-hidden="true" tabindex="-1"></a><span class="va">MIX_ENV=</span>test <span class="ex">mix</span> test.unit</span></code></pre></div>
<p>We should see the following error:</p>
<div class="sourceCode" id="cb377"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb377-1"><a href="mox-rocks.html#cb377-1" aria-hidden="true" tabindex="-1"></a><span class="ex">21:22:03.811</span> [error] GenServer <span class="co">#PID&lt;0.641.0&gt; terminating</span></span>
<span id="cb377-2"><a href="mox-rocks.html#cb377-2" aria-hidden="true" tabindex="-1"></a><span class="ex">**</span> <span class="er">(</span><span class="ex">stop</span><span class="kw">)</span> <span class="ex">exited</span> in: GenServer.call<span class="er">(</span><span class="ex">BinanceMock,</span> :generate_id, 5000<span class="kw">)</span></span>
<span id="cb377-3"><a href="mox-rocks.html#cb377-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">**</span> <span class="er">(</span><span class="ex">EXIT</span><span class="kw">)</span> <span class="ex">no</span> process: the process is not alive or there<span class="st">&#39;s no process currently</span></span>
<span id="cb377-4"><a href="mox-rocks.html#cb377-4" aria-hidden="true" tabindex="-1"></a><span class="st">       associated with the given name, possibly because its application isn&#39;</span>t started</span></code></pre></div>
<p>One of the <code>BinanceMock</code> module’s functions is sending a message to generate a unique id to the process that doesn’t exist(as we are running our tests without starting the supervision tree[the <code>--no-start</code> argument]).</p>
<p>There are two ways to handle this issue:</p>
<ul>
<li>inside the <code>/apps/naive/test/test_helper.exs</code> file we could ensure that the <code>BinanceMock</code> is up and running by adding <code>Application.ensure_all_started(:binance_mock)</code> function call - this is a hack</li>
<li>we could refactor the <code>BinanceMock.generate_fake_order/4</code> to accept <code>order_id</code> as an argument instead of sending the message internally - this should be a much better solution. Let’s give it a shot.</li>
</ul>
<p>First, let’s update the <code>BinanceMock</code> module:</p>
<div class="sourceCode" id="cb378"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb378-1"><a href="mox-rocks.html#cb378-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/binance_mock/lib/binance_mock.ex</span></span>
<span id="cb378-2"><a href="mox-rocks.html#cb378-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> generate_fake_order(order_id, symbol, quantity, price, side) <span class="co"># &lt;= order_id added</span></span>
<span id="cb378-3"><a href="mox-rocks.html#cb378-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb378-4"><a href="mox-rocks.html#cb378-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># remove the call to GenServer from the body</span></span>
<span id="cb378-5"><a href="mox-rocks.html#cb378-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb378-6"><a href="mox-rocks.html#cb378-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb378-7"><a href="mox-rocks.html#cb378-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb378-8"><a href="mox-rocks.html#cb378-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defp</span> order_limit(symbol, quantity, price, side) <span class="kw">do</span></span>
<span id="cb378-9"><a href="mox-rocks.html#cb378-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb378-10"><a href="mox-rocks.html#cb378-10" aria-hidden="true" tabindex="-1"></a>      generate_fake_order(</span>
<span id="cb378-11"><a href="mox-rocks.html#cb378-11" aria-hidden="true" tabindex="-1"></a>        <span class="cn">GenServer</span><span class="op">.</span>call(<span class="cn">__MODULE__</span>, <span class="va">:generate_id</span>), <span class="co"># &lt;= order_id generation added</span></span>
<span id="cb378-12"><a href="mox-rocks.html#cb378-12" aria-hidden="true" tabindex="-1"></a>        symbol,</span>
<span id="cb378-13"><a href="mox-rocks.html#cb378-13" aria-hidden="true" tabindex="-1"></a>        quantity,</span>
<span id="cb378-14"><a href="mox-rocks.html#cb378-14" aria-hidden="true" tabindex="-1"></a>        price,</span>
<span id="cb378-15"><a href="mox-rocks.html#cb378-15" aria-hidden="true" tabindex="-1"></a>        side</span>
<span id="cb378-16"><a href="mox-rocks.html#cb378-16" aria-hidden="true" tabindex="-1"></a>      )</span></code></pre></div>
<p>Now we need to update our test to pass some dummy order id from the mocked function:</p>
<div class="sourceCode" id="cb379"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb379-1"><a href="mox-rocks.html#cb379-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/naive/test/naive/trader_test.exs</span></span>
<span id="cb379-2"><a href="mox-rocks.html#cb379-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb379-3"><a href="mox-rocks.html#cb379-3" aria-hidden="true" tabindex="-1"></a>  test <span class="st">&quot;Placing buy order test&quot;</span> <span class="kw">do</span></span>
<span id="cb379-4"><a href="mox-rocks.html#cb379-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb379-5"><a href="mox-rocks.html#cb379-5" aria-hidden="true" tabindex="-1"></a>      {<span class="va">:ok</span>, <span class="cn">BinanceMock</span><span class="op">.</span>generate_fake_order(</span>
<span id="cb379-6"><a href="mox-rocks.html#cb379-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;12345&quot;</span>,                        <span class="co"># &lt;= order_id added</span></span>
<span id="cb379-7"><a href="mox-rocks.html#cb379-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;XRPUSDT&quot;</span>,</span>
<span id="cb379-8"><a href="mox-rocks.html#cb379-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;464.360&quot;</span>,</span>
<span id="cb379-9"><a href="mox-rocks.html#cb379-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;0.4307&quot;</span>,</span>
<span id="cb379-10"><a href="mox-rocks.html#cb379-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;BUY&quot;</span></span>
<span id="cb379-11"><a href="mox-rocks.html#cb379-11" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb379-12"><a href="mox-rocks.html#cb379-12" aria-hidden="true" tabindex="-1"></a>   <span class="op">...</span></span>
<span id="cb379-13"><a href="mox-rocks.html#cb379-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>We can now rerun our test:</p>
<div class="sourceCode" id="cb380"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb380-1"><a href="mox-rocks.html#cb380-1" aria-hidden="true" tabindex="-1"></a><span class="va">MIX_ENV=</span>test <span class="ex">mix</span> test.unit</span>
<span id="cb380-2"><a href="mox-rocks.html#cb380-2" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb380-3"><a href="mox-rocks.html#cb380-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Finished</span> in 0.1 seconds <span class="er">(</span><span class="ex">0.00s</span> async, 0.1s sync<span class="kw">)</span></span>
<span id="cb380-4"><a href="mox-rocks.html#cb380-4" aria-hidden="true" tabindex="-1"></a><span class="ex">2</span> tests, 0 failures, 1 excluded</span></code></pre></div>
<p>Congrats! We just successfully tested placing an order without any dependencies. To avoid explicitly passing the <code>MIX_ENV=test</code> environment variable, we will add the preferred environment for our alias inside the <code>mix.exs</code> file:</p>
<div class="sourceCode" id="cb381"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb381-1"><a href="mox-rocks.html#cb381-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /mix.exs</span></span>
<span id="cb381-2"><a href="mox-rocks.html#cb381-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> project <span class="kw">do</span></span>
<span id="cb381-3"><a href="mox-rocks.html#cb381-3" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb381-4"><a href="mox-rocks.html#cb381-4" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span></span>
<span id="cb381-5"><a href="mox-rocks.html#cb381-5" aria-hidden="true" tabindex="-1"></a>      <span class="va">preferred_cli_env:</span> [</span>
<span id="cb381-6"><a href="mox-rocks.html#cb381-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;test.unit&quot;</span>: <span class="va">:test</span></span>
<span id="cb381-7"><a href="mox-rocks.html#cb381-7" aria-hidden="true" tabindex="-1"></a>      ]</span>
<span id="cb381-8"><a href="mox-rocks.html#cb381-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>Now we can run our tests by:</p>
<div class="sourceCode" id="cb382"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb382-1"><a href="mox-rocks.html#cb382-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mix</span> test.unit</span>
<span id="cb382-2"><a href="mox-rocks.html#cb382-2" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb382-3"><a href="mox-rocks.html#cb382-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Finished</span> in 0.06 seconds <span class="er">(</span><span class="ex">0.00s</span> async, 0.06s sync<span class="kw">)</span></span>
<span id="cb382-4"><a href="mox-rocks.html#cb382-4" aria-hidden="true" tabindex="-1"></a><span class="ex">2</span> tests, 0 failures, 1 excluded</span></code></pre></div>
<p>That’s all for this chapter - to sum up, the main advantages from the <code>mox</code> based tests:</p>
<ul>
<li>we were able to test a standalone process/module ignoring all of its dependencies</li>
<li>we were able to confirm that dependent functions were called and expected values were passed to them</li>
<li>we were able to create a feedback loop where mock was sending a message back to the test, because of which, we didn’t need to use <code>sleep</code>, and that resulted in a massive speed gains</li>
</ul>
<p>[Note] Please remember to run the <code>mix format</code> to keep things nice and tidy.</p>
<p>Source code for this chapter can be found at <a href="https://github.com/Cinderella-Man/hands-on-elixir-and-otp-cryptocurrency-trading-bot-source-code/tree/chapter_17">Github</a></p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="end-to-end-testing.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="functional-elixir.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/Cinderella-Man/hands-on-elixir-and-otp-cryptocurrency-trading-bot/edit/main/17-mox-rocks.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
