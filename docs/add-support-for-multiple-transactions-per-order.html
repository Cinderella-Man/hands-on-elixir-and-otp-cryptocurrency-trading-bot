<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 8 Add support for multiple transactions per order | Create a cryptocurrency trading bot in Elixir</title>
  <meta name="description" content="Chapter 8 Add support for multiple transactions per order | Create a cryptocurrency trading bot in Elixir" />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 8 Add support for multiple transactions per order | Create a cryptocurrency trading bot in Elixir" />
  <meta property="og:type" content="book" />
  
  <meta property="og:image" content="images/cover.png" />
  
  <meta name="github-repo" content="frathon/create-a-cryptocurrency-trading-bot-in-elixir" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 8 Add support for multiple transactions per order | Create a cryptocurrency trading bot in Elixir" />
  
  
  <meta name="twitter:image" content="images/cover.png" />

<meta name="author" content="Kamil Skowron" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="introduce-a-trader-budget-and-calculating-the-quantity.html"/>
<link rel="next" href="run-multiple-traders-in-parallel.html"/>
<script src="libs/header-attrs-2.7/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-52FKGBX2B8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-52FKGBX2B8');
</script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Create a cryptocurrency trading bot in Elixir</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome üëã</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#limit-of-liabilitydisclaimer-of-warranty"><i class="fa fa-check"></i>Limit of Liability/Disclaimer of Warranty</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#contributing-errata"><i class="fa fa-check"></i>Contributing / Errata</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#backers"><i class="fa fa-check"></i>Backers</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#preface"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#who-this-book-is-for"><i class="fa fa-check"></i>Who this book is for</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#what-this-book-covers"><i class="fa fa-check"></i>What this book covers</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#source-code"><i class="fa fa-check"></i>Source code</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="stream-live-crypto-prices-from-binance-wss.html"><a href="stream-live-crypto-prices-from-binance-wss.html"><i class="fa fa-check"></i><b>1</b> Stream live crypto prices from Binance WSS</a>
<ul>
<li class="chapter" data-level="1.1" data-path="stream-live-crypto-prices-from-binance-wss.html"><a href="stream-live-crypto-prices-from-binance-wss.html#objectives"><i class="fa fa-check"></i><b>1.1</b> Objectives</a></li>
<li class="chapter" data-level="1.2" data-path="stream-live-crypto-prices-from-binance-wss.html"><a href="stream-live-crypto-prices-from-binance-wss.html#create-an-umbrella-app"><i class="fa fa-check"></i><b>1.2</b> Create an umbrella app</a></li>
<li class="chapter" data-level="1.3" data-path="stream-live-crypto-prices-from-binance-wss.html"><a href="stream-live-crypto-prices-from-binance-wss.html#create-a-supervised-application-inside-an-umbrella"><i class="fa fa-check"></i><b>1.3</b> Create a supervised application inside an umbrella</a></li>
<li class="chapter" data-level="1.4" data-path="stream-live-crypto-prices-from-binance-wss.html"><a href="stream-live-crypto-prices-from-binance-wss.html#connect-to-binances-websocket-stream-using-the-websockex-module"><i class="fa fa-check"></i><b>1.4</b> Connect to Binance‚Äôs WebSocket Stream using the WebSockex module</a></li>
<li class="chapter" data-level="1.5" data-path="stream-live-crypto-prices-from-binance-wss.html"><a href="stream-live-crypto-prices-from-binance-wss.html#decode-incoming-events-using-the-jason-module"><i class="fa fa-check"></i><b>1.5</b> Decode incoming events using the Jason module</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><i class="fa fa-check"></i><b>2</b> Create a naive trading strategy - a single trader process without supervision</a>
<ul>
<li class="chapter" data-level="2.1" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#objectives-1"><i class="fa fa-check"></i><b>2.1</b> Objectives</a></li>
<li class="chapter" data-level="2.2" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#initializiation"><i class="fa fa-check"></i><b>2.2</b> Initializiation</a></li>
<li class="chapter" data-level="2.3" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#how-trading-strategy-will-work"><i class="fa fa-check"></i><b>2.3</b> How trading strategy will work?</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#implementation-of-the-first-scenario"><i class="fa fa-check"></i><b>2.3.1</b> Implementation of the first scenario</a></li>
<li class="chapter" data-level="2.3.2" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#implementation-of-the-second-scenario"><i class="fa fa-check"></i><b>2.3.2</b> Implementation of the second scenario</a></li>
<li class="chapter" data-level="2.3.3" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#implementation-of-the-third-scenario"><i class="fa fa-check"></i><b>2.3.3</b> Implementation of the third scenario</a></li>
<li class="chapter" data-level="2.3.4" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#implementation-fallback-scenario"><i class="fa fa-check"></i><b>2.3.4</b> Implementation fallback scenario</a></li>
<li class="chapter" data-level="2.3.5" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#updating-the-naive-interface"><i class="fa fa-check"></i><b>2.3.5</b> Updating the Naive interface</a></li>
<li class="chapter" data-level="2.3.6" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#updating-streamer-app"><i class="fa fa-check"></i><b>2.3.6</b> Updating streamer app</a></li>
<li class="chapter" data-level="2.3.7" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#access-details-to-binance"><i class="fa fa-check"></i><b>2.3.7</b> Access details to Binance</a></li>
<li class="chapter" data-level="2.3.8" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#test-run"><i class="fa fa-check"></i><b>2.3.8</b> Test run</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html"><i class="fa fa-check"></i><b>3</b> Introduce PubSub as a communication method</a>
<ul>
<li class="chapter" data-level="3.1" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html#objectives-2"><i class="fa fa-check"></i><b>3.1</b> Objectives</a></li>
<li class="chapter" data-level="3.2" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html#design"><i class="fa fa-check"></i><b>3.2</b> Design</a></li>
<li class="chapter" data-level="3.3" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html#implementation"><i class="fa fa-check"></i><b>3.3</b> Implementation</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html"><i class="fa fa-check"></i><b>4</b> Mock the Binance API</a>
<ul>
<li class="chapter" data-level="4.1" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#objectives-3"><i class="fa fa-check"></i><b>4.1</b> Objectives</a></li>
<li class="chapter" data-level="4.2" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#design-1"><i class="fa fa-check"></i><b>4.2</b> Design</a></li>
<li class="chapter" data-level="4.3" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#create-binancemock-app"><i class="fa fa-check"></i><b>4.3</b> Create ‚ÄúBinanceMock‚Äù app</a></li>
<li class="chapter" data-level="4.4" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-getting-exchange-info"><i class="fa fa-check"></i><b>4.4</b> Implement getting exchange info</a></li>
<li class="chapter" data-level="4.5" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-placing-buy-and-sell-orders"><i class="fa fa-check"></i><b>4.5</b> Implement placing buy and sell orders</a></li>
<li class="chapter" data-level="4.6" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-order-retrival"><i class="fa fa-check"></i><b>4.6</b> Implement order retrival</a></li>
<li class="chapter" data-level="4.7" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-callback-for-incoming-trade-events"><i class="fa fa-check"></i><b>4.7</b> Implement callback for incoming trade events</a></li>
<li class="chapter" data-level="4.8" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#upgrade-trader-and-config"><i class="fa fa-check"></i><b>4.8</b> Upgrade trader and config</a></li>
<li class="chapter" data-level="4.9" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#test-the-implementation"><i class="fa fa-check"></i><b>4.9</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html"><i class="fa fa-check"></i><b>5</b> Enable parallel trading on multiple symbols</a>
<ul>
<li class="chapter" data-level="5.1" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#objectives-4"><i class="fa fa-check"></i><b>5.1</b> Objectives</a></li>
<li class="chapter" data-level="5.2" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#introduction---architectural-design"><i class="fa fa-check"></i><b>5.2</b> Introduction - architectural design</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#update-application-supervisor"><i class="fa fa-check"></i><b>5.2.1</b> Update application supervisor</a></li>
<li class="chapter" data-level="5.2.2" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#add-interface-method"><i class="fa fa-check"></i><b>5.2.2</b> Add interface method</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#implement-naive.symbolsupervisor"><i class="fa fa-check"></i><b>5.3</b> Implement <code>Naive.SymbolSupervisor</code></a></li>
<li class="chapter" data-level="5.4" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#implement-naive.leader"><i class="fa fa-check"></i><b>5.4</b> Implement <code>Naive.Leader</code></a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#updating-the-leader-module"><i class="fa fa-check"></i><b>5.4.1</b> Updating the <code>leader</code> module</a></li>
<li class="chapter" data-level="5.4.2" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#updating-the-naive.trader-module"><i class="fa fa-check"></i><b>5.4.2</b> Updating the <code>Naive.Trader</code> module</a></li>
<li class="chapter" data-level="5.4.3" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#finalizing-naive.leader-implementation"><i class="fa fa-check"></i><b>5.4.3</b> Finalizing <code>Naive.Leader</code> implementation</a></li>
<li class="chapter" data-level="5.4.4" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#iex-testing"><i class="fa fa-check"></i><b>5.4.4</b> IEx testing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><a href="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><i class="fa fa-check"></i><b>6</b> # Chapter 6 - Introduce a <code>buy_down_interval</code> to make a single trader more profitable</a>
<ul>
<li class="chapter" data-level="6.1" data-path="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><a href="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html#objectives-5"><i class="fa fa-check"></i><b>6.1</b> Objectives</a></li>
<li class="chapter" data-level="6.2" data-path="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><a href="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html#why-we-need-to-buy-below-the-current-price-feature-overview"><i class="fa fa-check"></i><b>6.2</b> Why we need to buy below the current price? Feature overview</a></li>
<li class="chapter" data-level="6.3" data-path="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><a href="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html#naive.trader-implementation"><i class="fa fa-check"></i><b>6.3</b> <code>Naive.Trader</code> implementation</a></li>
<li class="chapter" data-level="6.4" data-path="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><a href="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html#naive.leader-implementation"><i class="fa fa-check"></i><b>6.4</b> <code>Naive.Leader</code> implementation</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><a href="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html#iex-testing-1"><i class="fa fa-check"></i><b>6.4.1</b> IEx testing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html"><i class="fa fa-check"></i><b>7</b> Introduce a trader budget and calculating the quantity</a>
<ul>
<li class="chapter" data-level="7.1" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#objectives-6"><i class="fa fa-check"></i><b>7.1</b> Objectives</a></li>
<li class="chapter" data-level="7.2" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#fetch-step_size"><i class="fa fa-check"></i><b>7.2</b> Fetch <code>step_size</code></a></li>
<li class="chapter" data-level="7.3" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#append-budget-and-step_size-to-the-traders-state-inside-the-leader"><i class="fa fa-check"></i><b>7.3</b> Append <code>budget</code> and <code>step_size</code> to the <code>Trader</code>‚Äôs state inside the <code>Leader</code></a></li>
<li class="chapter" data-level="7.4" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#append-budget-and-step_size-to-the-traders-state"><i class="fa fa-check"></i><b>7.4</b> Append <code>budget</code> and <code>step_size</code> to the <code>Trader</code>‚Äôs state</a></li>
<li class="chapter" data-level="7.5" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#calculate-quantity"><i class="fa fa-check"></i><b>7.5</b> Calculate quantity</a>
<ul>
<li class="chapter" data-level="7.5.1" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#iex-testing-2"><i class="fa fa-check"></i><b>7.5.1</b> IEx testing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html"><i class="fa fa-check"></i><b>8</b> Add support for multiple transactions per order</a>
<ul>
<li class="chapter" data-level="8.1" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#objectives-7"><i class="fa fa-check"></i><b>8.1</b> Objectives</a></li>
<li class="chapter" data-level="8.2" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#issue-with-the-current-implementation"><i class="fa fa-check"></i><b>8.2</b> Issue with the current implementation</a></li>
<li class="chapter" data-level="8.3" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#improve-buy-order-filled-callback"><i class="fa fa-check"></i><b>8.3</b> Improve buy order filled callback</a></li>
<li class="chapter" data-level="8.4" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#implement-buy-order-filled-callback"><i class="fa fa-check"></i><b>8.4</b> Implement buy order ‚Äúfilled‚Äù callback</a></li>
<li class="chapter" data-level="8.5" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#improve-sell-order-callback"><i class="fa fa-check"></i><b>8.5</b> Improve sell order callback</a></li>
<li class="chapter" data-level="8.6" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#test-the-implementation-1"><i class="fa fa-check"></i><b>8.6</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html"><i class="fa fa-check"></i><b>9</b> Run multiple traders in parallel</a>
<ul>
<li class="chapter" data-level="9.1" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#objectives-8"><i class="fa fa-check"></i><b>9.1</b> Objectives</a></li>
<li class="chapter" data-level="9.2" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#describe-and-design-the-required-functionality"><i class="fa fa-check"></i><b>9.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="9.3" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#implement-rebuy-inside-naive.trader"><i class="fa fa-check"></i><b>9.3</b> Implement rebuy inside <code>Naive.Trader</code></a></li>
<li class="chapter" data-level="9.4" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#implement-rebuy-in-the-naive.leader"><i class="fa fa-check"></i><b>9.4</b> Implement rebuy in the <code>Naive.Leader</code></a></li>
<li class="chapter" data-level="9.5" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#improve-logs-by-assigning-ids-to-traders"><i class="fa fa-check"></i><b>9.5</b> Improve logs by assigning ids to traders</a></li>
<li class="chapter" data-level="9.6" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#test-the-implementation-2"><i class="fa fa-check"></i><b>9.6</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html"><i class="fa fa-check"></i><b>10</b> Fine-tune trading strategy per symbol</a>
<ul>
<li class="chapter" data-level="10.1" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#objectives-9"><i class="fa fa-check"></i><b>10.1</b> Objectives</a></li>
<li class="chapter" data-level="10.2" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#describe-and-design-the-required-functionality-1"><i class="fa fa-check"></i><b>10.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="10.3" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#add-docker-to-project"><i class="fa fa-check"></i><b>10.3</b> Add docker to project</a></li>
<li class="chapter" data-level="10.4" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#set-up-ecto-inside-the-naive-app"><i class="fa fa-check"></i><b>10.4</b> Set up <code>ecto</code> inside the <code>naive</code> app</a></li>
<li class="chapter" data-level="10.5" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#create-and-migrate-the-db"><i class="fa fa-check"></i><b>10.5</b> Create and migrate the DB</a></li>
<li class="chapter" data-level="10.6" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#seed-symbols-settings"><i class="fa fa-check"></i><b>10.6</b> Seed symbols‚Äô settings</a></li>
<li class="chapter" data-level="10.7" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#update-the-naive.leader-to-fetch-settings"><i class="fa fa-check"></i><b>10.7</b> Update the <code>Naive.Leader</code> to fetch settings</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html"><i class="fa fa-check"></i><b>11</b> Supervise and autostart streaming</a>
<ul>
<li class="chapter" data-level="11.1" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#objectives-10"><i class="fa fa-check"></i><b>11.1</b> Objectives</a></li>
<li class="chapter" data-level="11.2" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#describe-and-design-the-required-functionality-2"><i class="fa fa-check"></i><b>11.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="11.3" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#register-the-streamer.binance-processes-with-names"><i class="fa fa-check"></i><b>11.3</b> Register the <code>Streamer.Binance</code> processes with names</a></li>
<li class="chapter" data-level="11.4" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#set-up-ecto-inside-the-streamer-app"><i class="fa fa-check"></i><b>11.4</b> Set up <code>ecto</code> inside the <code>streamer</code> app</a></li>
<li class="chapter" data-level="11.5" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#create-and-migrate-the-db-1"><i class="fa fa-check"></i><b>11.5</b> Create and migrate the db</a></li>
<li class="chapter" data-level="11.6" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#seed-default-settings"><i class="fa fa-check"></i><b>11.6</b> Seed default settings</a></li>
<li class="chapter" data-level="11.7" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#implement-the-supervision-tree-and-start-streaming-functionality"><i class="fa fa-check"></i><b>11.7</b> Implement the supervision tree and start streaming functionality</a></li>
<li class="chapter" data-level="11.8" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#implement-the-stop-functionality"><i class="fa fa-check"></i><b>11.8</b> Implement the stop functionality</a></li>
<li class="chapter" data-level="11.9" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#implement-the-autostart-streaming-functionality"><i class="fa fa-check"></i><b>11.9</b> Implement the autostart streaming functionality</a></li>
<li class="chapter" data-level="11.10" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#test-the-implementation-3"><i class="fa fa-check"></i><b>11.10</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html"><i class="fa fa-check"></i><b>12</b> Start, stop, shutdown and autostart trading</a>
<ul>
<li class="chapter" data-level="12.1" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#objectives-11"><i class="fa fa-check"></i><b>12.1</b> Objectives</a></li>
<li class="chapter" data-level="12.2" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#describe-and-design-the-required-functionality-3"><i class="fa fa-check"></i><b>12.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="12.3" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#re-implement-the-start-trading-functionality"><i class="fa fa-check"></i><b>12.3</b> (Re-)Implement the start trading functionality</a></li>
<li class="chapter" data-level="12.4" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#implement-the-stop-trading-functionality"><i class="fa fa-check"></i><b>12.4</b> Implement the stop trading functionality</a></li>
<li class="chapter" data-level="12.5" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#implement-the-autostart-trading-functionality"><i class="fa fa-check"></i><b>12.5</b> Implement the autostart trading functionality</a></li>
<li class="chapter" data-level="12.6" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#implement-the-shutdown-trading-functionality"><i class="fa fa-check"></i><b>12.6</b> Implement the shutdown trading functionality</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html"><i class="fa fa-check"></i><b>13</b> Abstract duplicated supervision code</a>
<ul>
<li class="chapter" data-level="13.1" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#objectives-12"><i class="fa fa-check"></i><b>13.1</b> Objectives</a></li>
<li class="chapter" data-level="13.2" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#overview-of-requirements"><i class="fa fa-check"></i><b>13.2</b> Overview of requirements</a></li>
<li class="chapter" data-level="13.3" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#pseudo-generalize-core.servicesupervisor-module"><i class="fa fa-check"></i><b>13.3</b> Pseudo generalize Core.ServiceSupervisor module</a></li>
<li class="chapter" data-level="13.4" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#utilize-pseudo-generalized-code-inside-the-naive.dynamicsymbolsupervisor"><i class="fa fa-check"></i><b>13.4</b> Utilize pseudo generalized code inside the <code>Naive.DynamicSymbolSupervisor</code></a></li>
<li class="chapter" data-level="13.5" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#implement-a-truly-generic-core.servicesupervisor"><i class="fa fa-check"></i><b>13.5</b> Implement a truly generic <code>Core.ServiceSupervisor</code></a>
<ul>
<li class="chapter" data-level="13.5.1" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#first-path-starting-with-the-fetch_symbols_to_start0-function"><i class="fa fa-check"></i><b>13.5.1</b> First path starting with the <code>fetch_symbols_to_start/0</code> function</a></li>
<li class="chapter" data-level="13.5.2" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#second-path-starting-with-the-update_status2"><i class="fa fa-check"></i><b>13.5.2</b> Second path starting with the <code>update_status/2</code></a></li>
<li class="chapter" data-level="13.5.3" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#third-path-starting-with-the-get_pid1-function"><i class="fa fa-check"></i><b>13.5.3</b> Third path starting with the <code>get_pid/1</code> function</a></li>
</ul></li>
<li class="chapter" data-level="13.6" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#remove-boilerplate-using-use-macro"><i class="fa fa-check"></i><b>13.6</b> Remove boilerplate using <code>use</code> macro</a></li>
<li class="chapter" data-level="13.7" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#use-the-core.servicesupervisor-module-inside-the-streamer-application"><i class="fa fa-check"></i><b>13.7</b> Use the <code>Core.ServiceSupervisor</code> module inside the <code>streamer</code> application</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html"><i class="fa fa-check"></i><b>14</b> Store trade events and orders inside the database</a>
<ul>
<li class="chapter" data-level="14.1" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#objectives-13"><i class="fa fa-check"></i><b>14.1</b> Objectives</a></li>
<li class="chapter" data-level="14.2" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#overview-of-requirements-1"><i class="fa fa-check"></i><b>14.2</b> Overview of requirements</a></li>
<li class="chapter" data-level="14.3" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-a-new-data_warehouse-application-in-the-umbrella"><i class="fa fa-check"></i><b>14.3</b> Create a new <code>data_warehouse</code> application in the umbrella</a></li>
<li class="chapter" data-level="14.4" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#connect-to-the-database-using-ecto"><i class="fa fa-check"></i><b>14.4</b> Connect to the database using Ecto</a></li>
<li class="chapter" data-level="14.5" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#store-trade-events-data"><i class="fa fa-check"></i><b>14.5</b> Store trade events‚Äô data</a></li>
<li class="chapter" data-level="14.6" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#store-orders-data"><i class="fa fa-check"></i><b>14.6</b> Store orders‚Äô data</a></li>
<li class="chapter" data-level="14.7" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#implement-supervision"><i class="fa fa-check"></i><b>14.7</b> Implement supervision</a>
<ul>
<li class="chapter" data-level="14.7.1" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-subscriber_settings-table"><i class="fa fa-check"></i><b>14.7.1</b> Create <code>subscriber_settings</code> table</a></li>
<li class="chapter" data-level="14.7.2" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#redesign-supervision-using-registry"><i class="fa fa-check"></i><b>14.7.2</b> Redesign supervision using Registry</a></li>
<li class="chapter" data-level="14.7.3" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-the-datawarehouse.subscriber.dynamicsupervisor-module"><i class="fa fa-check"></i><b>14.7.3</b> Create the <code>DataWarehouse.Subscriber.DynamicSupervisor</code> module</a></li>
<li class="chapter" data-level="14.7.4" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#register-worker-processes-using-via"><i class="fa fa-check"></i><b>14.7.4</b> Register Worker processes using :via</a></li>
<li class="chapter" data-level="14.7.5" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-a-new-supervision-level-for-registry-task-and-the-dynamicsupervisor"><i class="fa fa-check"></i><b>14.7.5</b> Create a new supervision level for Registry, Task and the DynamicSupervisor</a></li>
<li class="chapter" data-level="14.7.6" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#link-the-subscribersupervisor-to-the-application"><i class="fa fa-check"></i><b>14.7.6</b> Link the <code>SubscriberSupervisor</code> to the <code>Application</code></a></li>
<li class="chapter" data-level="14.7.7" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#add-interface"><i class="fa fa-check"></i><b>14.7.7</b> Add interface</a></li>
<li class="chapter" data-level="14.7.8" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#test"><i class="fa fa-check"></i><b>14.7.8</b> Test</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="15" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html"><i class="fa fa-check"></i><b>15</b> Backtest trading strategy</a>
<ul>
<li class="chapter" data-level="15.1" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#objectives-14"><i class="fa fa-check"></i><b>15.1</b> Objectives</a></li>
<li class="chapter" data-level="15.2" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#overview-of-requirements-2"><i class="fa fa-check"></i><b>15.2</b> Overview of requirements</a></li>
<li class="chapter" data-level="15.3" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#implement-the-storing-task"><i class="fa fa-check"></i><b>15.3</b> Implement the storing task</a></li>
<li class="chapter" data-level="15.4" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#test-the-backtesting"><i class="fa fa-check"></i><b>15.4</b> Test the backtesting</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://www.bookdown.org/" target="blank">Created with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Create a cryptocurrency trading bot in Elixir</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="add-support-for-multiple-transactions-per-order" class="section level1" number="8">
<h1><span class="header-section-number">Chapter 8</span> Add support for multiple transactions per order</h1>
<div id="objectives-7" class="section level2" number="8.1">
<h2><span class="header-section-number">8.1</span> Objectives</h2>
<ul>
<li>describe issue with current implementation</li>
<li>improve buy order filled callback</li>
<li>implement buy order ‚Äúfilled‚Äù callback</li>
<li>improve sell order callback</li>
</ul>
</div>
<div id="issue-with-the-current-implementation" class="section level2" number="8.2">
<h2><span class="header-section-number">8.2</span> Issue with the current implementation</h2>
<p>Currently, <code>Naive.Trader</code> process is placing a buy order and it‚Äôs assuming that it will be filled by a <em>single</em> opposite sell order(we are pattern matching on quantity to confirm that):</p>
<center>
<img src="images/chapter_08_01_single_transaction.png">
</center>
<p><br/></p>
<p>Here we can see our buy order for 1000 units(on the left) and other trader‚Äôs sell order(on the right) for 1000 units. This(order fully filled in single transaction) is a case most of the time but it‚Äôs not ALWAYS the case.</p>
<p>Sometimes our order will be filled by two or more transactions:</p>
<center>
<img src="images/chapter_08_02_multiple_transactions_per_order.png">
</center>
<p><br/></p>
<p>The easiest and the safest way to check has this event filled our order fully is to fetch our order again from Binance at the moment when trade event filling our order arrives.</p>
<p>Problem with this approach is that sometimes we will run into a race condition:</p>
<center>
<img src="images/chapter_08_03_race_condition_timeline.png">
</center>
<p><br/></p>
<p>From the left, first, we are sending a buy order for quantity 1000 to the Binance. It hangs for a while until it gets filled by 2 transactions that happened very quickly. Quickly enough for us to receive both messages almost in the same moment.</p>
<p>When our bot will handle the first one it will fetch our the buy order which is already filled. It will cause the trader to place a sell order but then the there‚Äôs another trade event waiting in the message box. It will be handled by another callback that will again fetch order and place another sell order to be placed and that‚Äôs obviously not correct.</p>
<p>What we need to do is to update the status of the buy order after the first fetch(if it‚Äôs filled) so when second trade event arrives we will ignore it(this will require additional callback).</p>
<p>The same issue will appear when placing sell order and dealing multiple simultaneous transaction.</p>
</div>
<div id="improve-buy-order-filled-callback" class="section level2" number="8.3">
<h2><span class="header-section-number">8.3</span> Improve buy order filled callback</h2>
<p>First, we need to modify the callback which monitors incoming trade events for ones filling it‚Äôs buy order and then places sell order. We need to remove pattern matching assuming that a single trade event will fill our buy order - we need to drop quantity check as well as add</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb105-1"><a href="add-support-for-multiple-transactions-per-order.html#cb105-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/naive/lib/naive/trader.ex</span></span>
<span id="cb105-2"><a href="add-support-for-multiple-transactions-per-order.html#cb105-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> handle_info(</span>
<span id="cb105-3"><a href="add-support-for-multiple-transactions-per-order.html#cb105-3" aria-hidden="true" tabindex="-1"></a>        %<span class="cn">TradeEvent</span>{</span>
<span id="cb105-4"><a href="add-support-for-multiple-transactions-per-order.html#cb105-4" aria-hidden="true" tabindex="-1"></a>          <span class="va">buyer_order_id:</span> order_id <span class="co"># &lt;= quantity got removed from here</span></span>
<span id="cb105-5"><a href="add-support-for-multiple-transactions-per-order.html#cb105-5" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb105-6"><a href="add-support-for-multiple-transactions-per-order.html#cb105-6" aria-hidden="true" tabindex="-1"></a>        %<span class="cn">State</span>{</span>
<span id="cb105-7"><a href="add-support-for-multiple-transactions-per-order.html#cb105-7" aria-hidden="true" tabindex="-1"></a>          <span class="va">symbol:</span> symbol,</span>
<span id="cb105-8"><a href="add-support-for-multiple-transactions-per-order.html#cb105-8" aria-hidden="true" tabindex="-1"></a>          <span class="va">buy_order:</span></span>
<span id="cb105-9"><a href="add-support-for-multiple-transactions-per-order.html#cb105-9" aria-hidden="true" tabindex="-1"></a>            %<span class="cn">Binance</span><span class="op">.</span><span class="cn">OrderResponse</span>{</span>
<span id="cb105-10"><a href="add-support-for-multiple-transactions-per-order.html#cb105-10" aria-hidden="true" tabindex="-1"></a>              <span class="va">price:</span> buy_price,</span>
<span id="cb105-11"><a href="add-support-for-multiple-transactions-per-order.html#cb105-11" aria-hidden="true" tabindex="-1"></a>              <span class="va">order_id:</span> order_id,</span>
<span id="cb105-12"><a href="add-support-for-multiple-transactions-per-order.html#cb105-12" aria-hidden="true" tabindex="-1"></a>              <span class="va">orig_qty:</span> quantity,</span>
<span id="cb105-13"><a href="add-support-for-multiple-transactions-per-order.html#cb105-13" aria-hidden="true" tabindex="-1"></a>              <span class="va">transact_time:</span> timestamp <span class="co"># &lt;= timestamp added to query order</span></span>
<span id="cb105-14"><a href="add-support-for-multiple-transactions-per-order.html#cb105-14" aria-hidden="true" tabindex="-1"></a>            } <span class="op">=</span> buy_order, <span class="co"># &lt;= buy order to update it</span></span>
<span id="cb105-15"><a href="add-support-for-multiple-transactions-per-order.html#cb105-15" aria-hidden="true" tabindex="-1"></a>          <span class="va">profit_interval:</span> profit_interval,</span>
<span id="cb105-16"><a href="add-support-for-multiple-transactions-per-order.html#cb105-16" aria-hidden="true" tabindex="-1"></a>          <span class="va">tick_size:</span> tick_size</span>
<span id="cb105-17"><a href="add-support-for-multiple-transactions-per-order.html#cb105-17" aria-hidden="true" tabindex="-1"></a>        } <span class="op">=</span> state</span>
<span id="cb105-18"><a href="add-support-for-multiple-transactions-per-order.html#cb105-18" aria-hidden="true" tabindex="-1"></a>      ) <span class="kw">do</span></span></code></pre></div>
<p>Now we can fetch our buy order to check is it already filled. We will get the <code>Binance.Order</code> struct instead of the <code>Binance.OrderResponse</code> that we normally deal with. At this moment we will simply update our <code>Binance.OrderResponse</code> struct from state:</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb106-1"><a href="add-support-for-multiple-transactions-per-order.html#cb106-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/naive/lib/naive/trader.ex</span></span>
<span id="cb106-2"><a href="add-support-for-multiple-transactions-per-order.html#cb106-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># inside the same callback</span></span>
<span id="cb106-3"><a href="add-support-for-multiple-transactions-per-order.html#cb106-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> handle_info(</span>
<span id="cb106-4"><a href="add-support-for-multiple-transactions-per-order.html#cb106-4" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span></span>
<span id="cb106-5"><a href="add-support-for-multiple-transactions-per-order.html#cb106-5" aria-hidden="true" tabindex="-1"></a>      ) <span class="kw">do</span></span>
<span id="cb106-6"><a href="add-support-for-multiple-transactions-per-order.html#cb106-6" aria-hidden="true" tabindex="-1"></a>    {<span class="va">:ok</span>, %<span class="cn">Binance</span><span class="op">.</span><span class="cn">Order</span>{} <span class="op">=</span> current_buy_order} <span class="op">=</span></span>
<span id="cb106-7"><a href="add-support-for-multiple-transactions-per-order.html#cb106-7" aria-hidden="true" tabindex="-1"></a>      <span class="ot">@binance_client</span><span class="op">.</span>get_order(</span>
<span id="cb106-8"><a href="add-support-for-multiple-transactions-per-order.html#cb106-8" aria-hidden="true" tabindex="-1"></a>        symbol,</span>
<span id="cb106-9"><a href="add-support-for-multiple-transactions-per-order.html#cb106-9" aria-hidden="true" tabindex="-1"></a>        timestamp,</span>
<span id="cb106-10"><a href="add-support-for-multiple-transactions-per-order.html#cb106-10" aria-hidden="true" tabindex="-1"></a>        order_id</span>
<span id="cb106-11"><a href="add-support-for-multiple-transactions-per-order.html#cb106-11" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb106-12"><a href="add-support-for-multiple-transactions-per-order.html#cb106-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-13"><a href="add-support-for-multiple-transactions-per-order.html#cb106-13" aria-hidden="true" tabindex="-1"></a>    buy_order <span class="op">=</span> %{buy_order <span class="op">|</span> <span class="va">status:</span> current_buy_order<span class="op">.</span>status}</span>
<span id="cb106-14"><a href="add-support-for-multiple-transactions-per-order.html#cb106-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span></code></pre></div>
<p>The rest of the logic inside this callback will depend on the <code>status</code> of the buy order. If our buy order is ‚Äúfilled‚Äù we would like to follow the existing logic but also update <code>buy_order</code> field inside the state of the trader process. On the other hand if our order is not yet filled the only thing to do is to update <code>buy_order</code> field inside the state of the Trader process. Here‚Äôs and updated body below above changes(few variables got renamed for clarity as we are now fetch the order):</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb107-1"><a href="add-support-for-multiple-transactions-per-order.html#cb107-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/naive/lib/naive/trader.ex</span></span>
<span id="cb107-2"><a href="add-support-for-multiple-transactions-per-order.html#cb107-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># inside the same callback</span></span>
<span id="cb107-3"><a href="add-support-for-multiple-transactions-per-order.html#cb107-3" aria-hidden="true" tabindex="-1"></a>  buy_order <span class="op">=</span> <span class="op">....</span></span>
<span id="cb107-4"><a href="add-support-for-multiple-transactions-per-order.html#cb107-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-5"><a href="add-support-for-multiple-transactions-per-order.html#cb107-5" aria-hidden="true" tabindex="-1"></a>    {<span class="va">:ok</span>, new_state} <span class="op">=</span></span>
<span id="cb107-6"><a href="add-support-for-multiple-transactions-per-order.html#cb107-6" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> buy_order<span class="op">.</span>status <span class="op">==</span> <span class="st">&quot;FILLED&quot;</span> <span class="kw">do</span></span>
<span id="cb107-7"><a href="add-support-for-multiple-transactions-per-order.html#cb107-7" aria-hidden="true" tabindex="-1"></a>        sell_price <span class="op">=</span> calculate_sell_price(buy_price, profit_interval, tick_size)</span>
<span id="cb107-8"><a href="add-support-for-multiple-transactions-per-order.html#cb107-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-9"><a href="add-support-for-multiple-transactions-per-order.html#cb107-9" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Logger</span><span class="op">.</span>info(</span>
<span id="cb107-10"><a href="add-support-for-multiple-transactions-per-order.html#cb107-10" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;Buy order filled, placing SELL order for &quot;</span> <span class="op">&lt;&gt;</span></span>
<span id="cb107-11"><a href="add-support-for-multiple-transactions-per-order.html#cb107-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;</span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st"> @ </span><span class="ot">#{</span>sell_price<span class="ot">}</span><span class="st">, quantity: </span><span class="ot">#{</span>quantity<span class="ot">}</span><span class="st">&quot;</span></span>
<span id="cb107-12"><a href="add-support-for-multiple-transactions-per-order.html#cb107-12" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb107-13"><a href="add-support-for-multiple-transactions-per-order.html#cb107-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-14"><a href="add-support-for-multiple-transactions-per-order.html#cb107-14" aria-hidden="true" tabindex="-1"></a>        {<span class="va">:ok</span>, %<span class="cn">Binance</span><span class="op">.</span><span class="cn">OrderResponse</span>{} <span class="op">=</span> order} <span class="op">=</span></span>
<span id="cb107-15"><a href="add-support-for-multiple-transactions-per-order.html#cb107-15" aria-hidden="true" tabindex="-1"></a>          <span class="ot">@binance_client</span><span class="op">.</span>order_limit_sell(symbol, quantity, sell_price, <span class="st">&quot;GTC&quot;</span>)</span>
<span id="cb107-16"><a href="add-support-for-multiple-transactions-per-order.html#cb107-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-17"><a href="add-support-for-multiple-transactions-per-order.html#cb107-17" aria-hidden="true" tabindex="-1"></a>        {<span class="va">:ok</span>, %{state <span class="op">|</span> <span class="va">buy_order:</span> buy_order, <span class="va">sell_order:</span> order}}</span>
<span id="cb107-18"><a href="add-support-for-multiple-transactions-per-order.html#cb107-18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span></span>
<span id="cb107-19"><a href="add-support-for-multiple-transactions-per-order.html#cb107-19" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Logger</span><span class="op">.</span>info(<span class="st">&quot;Buy order partially filled&quot;</span>)</span>
<span id="cb107-20"><a href="add-support-for-multiple-transactions-per-order.html#cb107-20" aria-hidden="true" tabindex="-1"></a>        {<span class="va">:ok</span>, %{state <span class="op">|</span> <span class="va">buy_order:</span> buy_order}}</span>
<span id="cb107-21"><a href="add-support-for-multiple-transactions-per-order.html#cb107-21" aria-hidden="true" tabindex="-1"></a>      <span class="kw">end</span></span>
<span id="cb107-22"><a href="add-support-for-multiple-transactions-per-order.html#cb107-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-23"><a href="add-support-for-multiple-transactions-per-order.html#cb107-23" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Naive</span><span class="op">.</span><span class="cn">Leader</span><span class="op">.</span>notify(<span class="va">:trader_state_updated</span>, new_state)</span>
<span id="cb107-24"><a href="add-support-for-multiple-transactions-per-order.html#cb107-24" aria-hidden="true" tabindex="-1"></a>    {<span class="va">:noreply</span>, new_state}</span>
<span id="cb107-25"><a href="add-support-for-multiple-transactions-per-order.html#cb107-25" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>As we are branching our logic and both paths are updating the state, we will return it together with an <code>:ok</code> atom to be able to pattern match it and assign as a new state.</p>
</div>
<div id="implement-buy-order-filled-callback" class="section level2" number="8.4">
<h2><span class="header-section-number">8.4</span> Implement buy order ‚Äúfilled‚Äù callback</h2>
<p>Above callback covers the case where we will get multiple transactions filling our buy order. We aren‚Äôt yet convering for the race condition described at the begining of this chapter. When another trade event matching <code>buyer_order_id</code> would arrive, above callback would be used and another sell order would be placed. To avoid that we need to add a new callback <em>ABOVE</em> the one that we just edited that will match <code>buyer_order_id</code> together with ‚Äúfilled‚Äù <code>status</code> and it will simply ignore that trade event as we know that sell event needed to be placed by previous trade event:</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb108-1"><a href="add-support-for-multiple-transactions-per-order.html#cb108-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/naive/lib/naive/trader.ex</span></span>
<span id="cb108-2"><a href="add-support-for-multiple-transactions-per-order.html#cb108-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># place this callback ABOVE callback from previous section</span></span>
<span id="cb108-3"><a href="add-support-for-multiple-transactions-per-order.html#cb108-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> handle_info(</span>
<span id="cb108-4"><a href="add-support-for-multiple-transactions-per-order.html#cb108-4" aria-hidden="true" tabindex="-1"></a>        %<span class="cn">Streamer</span><span class="op">.</span><span class="cn">Binance</span><span class="op">.</span><span class="cn">TradeEvent</span>{</span>
<span id="cb108-5"><a href="add-support-for-multiple-transactions-per-order.html#cb108-5" aria-hidden="true" tabindex="-1"></a>          <span class="va">buyer_order_id:</span> order_id</span>
<span id="cb108-6"><a href="add-support-for-multiple-transactions-per-order.html#cb108-6" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb108-7"><a href="add-support-for-multiple-transactions-per-order.html#cb108-7" aria-hidden="true" tabindex="-1"></a>        %<span class="cn">State</span>{</span>
<span id="cb108-8"><a href="add-support-for-multiple-transactions-per-order.html#cb108-8" aria-hidden="true" tabindex="-1"></a>          <span class="va">buy_order:</span> %<span class="cn">Binance</span><span class="op">.</span><span class="cn">OrderResponse</span>{</span>
<span id="cb108-9"><a href="add-support-for-multiple-transactions-per-order.html#cb108-9" aria-hidden="true" tabindex="-1"></a>            <span class="va">order_id:</span> order_id, <span class="co"># &lt;= confirms that it&#39;s event for buy order</span></span>
<span id="cb108-10"><a href="add-support-for-multiple-transactions-per-order.html#cb108-10" aria-hidden="true" tabindex="-1"></a>            <span class="va">status:</span> <span class="st">&quot;FILLED&quot;</span> <span class="co"># &lt;= confirms buy order filled</span></span>
<span id="cb108-11"><a href="add-support-for-multiple-transactions-per-order.html#cb108-11" aria-hidden="true" tabindex="-1"></a>          },</span>
<span id="cb108-12"><a href="add-support-for-multiple-transactions-per-order.html#cb108-12" aria-hidden="true" tabindex="-1"></a>          <span class="va">sell_order:</span> %<span class="cn">Binance</span><span class="op">.</span><span class="cn">OrderResponse</span>{} <span class="co"># &lt;= confirms sell order placed</span></span>
<span id="cb108-13"><a href="add-support-for-multiple-transactions-per-order.html#cb108-13" aria-hidden="true" tabindex="-1"></a>        } <span class="op">=</span> state</span>
<span id="cb108-14"><a href="add-support-for-multiple-transactions-per-order.html#cb108-14" aria-hidden="true" tabindex="-1"></a>      ) <span class="kw">do</span></span>
<span id="cb108-15"><a href="add-support-for-multiple-transactions-per-order.html#cb108-15" aria-hidden="true" tabindex="-1"></a>    {<span class="va">:noreply</span>, state}</span>
<span id="cb108-16"><a href="add-support-for-multiple-transactions-per-order.html#cb108-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
</div>
<div id="improve-sell-order-callback" class="section level2" number="8.5">
<h2><span class="header-section-number">8.5</span> Improve sell order callback</h2>
<p>Let‚Äôs move on to the callback where the trader receives trade event matching sell order‚Äôs id (about line 135 inside the <code>Naive.Trader</code> module).</p>
<p>We need to modify the header of our callback in the following ways:
- drop the both pattern matches on <code>quantity</code> as we already know that trade event could partially fill our order (#1)
- get <code>symbol</code> out of state (#2)
- get <code>transact_time</code> out of the <code>sell_order</code> (used to fetch <code>get_order</code>) (#3)
- assign <code>sell_order</code> to a variable (#4)</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb109-1"><a href="add-support-for-multiple-transactions-per-order.html#cb109-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/naive/lib/naive/trader.ex</span></span>
<span id="cb109-2"><a href="add-support-for-multiple-transactions-per-order.html#cb109-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> handle_info(</span>
<span id="cb109-3"><a href="add-support-for-multiple-transactions-per-order.html#cb109-3" aria-hidden="true" tabindex="-1"></a>        %<span class="cn">TradeEvent</span>{</span>
<span id="cb109-4"><a href="add-support-for-multiple-transactions-per-order.html#cb109-4" aria-hidden="true" tabindex="-1"></a>          <span class="va">seller_order_id:</span> order_id <span class="co"># `quantity` check removed below (#1)</span></span>
<span id="cb109-5"><a href="add-support-for-multiple-transactions-per-order.html#cb109-5" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb109-6"><a href="add-support-for-multiple-transactions-per-order.html#cb109-6" aria-hidden="true" tabindex="-1"></a>        %<span class="cn">State</span>{</span>
<span id="cb109-7"><a href="add-support-for-multiple-transactions-per-order.html#cb109-7" aria-hidden="true" tabindex="-1"></a>          <span class="va">symbol:</span> symbol, (<span class="co">#2)</span></span>
<span id="cb109-8"><a href="add-support-for-multiple-transactions-per-order.html#cb109-8" aria-hidden="true" tabindex="-1"></a>          <span class="va">sell_order:</span></span>
<span id="cb109-9"><a href="add-support-for-multiple-transactions-per-order.html#cb109-9" aria-hidden="true" tabindex="-1"></a>            %<span class="cn">Binance</span><span class="op">.</span><span class="cn">OrderResponse</span>{</span>
<span id="cb109-10"><a href="add-support-for-multiple-transactions-per-order.html#cb109-10" aria-hidden="true" tabindex="-1"></a>              <span class="va">order_id:</span> order_id,</span>
<span id="cb109-11"><a href="add-support-for-multiple-transactions-per-order.html#cb109-11" aria-hidden="true" tabindex="-1"></a>              <span class="va">transact_time:</span> timestamp <span class="co"># `transact_time` to `get_order` (#3)</span></span>
<span id="cb109-12"><a href="add-support-for-multiple-transactions-per-order.html#cb109-12" aria-hidden="true" tabindex="-1"></a>            } <span class="op">=</span> sell_order <span class="co"># to update order (#4)</span></span>
<span id="cb109-13"><a href="add-support-for-multiple-transactions-per-order.html#cb109-13" aria-hidden="true" tabindex="-1"></a>        } <span class="op">=</span> state</span>
<span id="cb109-14"><a href="add-support-for-multiple-transactions-per-order.html#cb109-14" aria-hidden="true" tabindex="-1"></a>      ) <span class="kw">do</span></span></code></pre></div>
<p>Moving lower to the body of the function, we need to:
- fetch current state of our sell order
- update <code>status</code> of our <code>sell_order</code> from Trader‚Äôs state
- branch out the logic based on <code>status</code> of the <code>sell_order</code>:
* log and return the <code>:stop</code> atom to stop the GenServer
or
* update the state with new <code>sell_order</code> and continue</p>
<p>Here‚Äôs the full body of our callback:</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb110-1"><a href="add-support-for-multiple-transactions-per-order.html#cb110-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># /apps/naive/lib/naive/trader.ex</span></span>
<span id="cb110-2"><a href="add-support-for-multiple-transactions-per-order.html#cb110-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># inside the callabck</span></span>
<span id="cb110-3"><a href="add-support-for-multiple-transactions-per-order.html#cb110-3" aria-hidden="true" tabindex="-1"></a>    {<span class="va">:ok</span>, %<span class="cn">Binance</span><span class="op">.</span><span class="cn">Order</span>{} <span class="op">=</span> current_sell_order} <span class="op">=</span></span>
<span id="cb110-4"><a href="add-support-for-multiple-transactions-per-order.html#cb110-4" aria-hidden="true" tabindex="-1"></a>      <span class="ot">@binance_client</span><span class="op">.</span>get_order(</span>
<span id="cb110-5"><a href="add-support-for-multiple-transactions-per-order.html#cb110-5" aria-hidden="true" tabindex="-1"></a>        symbol,</span>
<span id="cb110-6"><a href="add-support-for-multiple-transactions-per-order.html#cb110-6" aria-hidden="true" tabindex="-1"></a>        timestamp,</span>
<span id="cb110-7"><a href="add-support-for-multiple-transactions-per-order.html#cb110-7" aria-hidden="true" tabindex="-1"></a>        order_id</span>
<span id="cb110-8"><a href="add-support-for-multiple-transactions-per-order.html#cb110-8" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb110-9"><a href="add-support-for-multiple-transactions-per-order.html#cb110-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-10"><a href="add-support-for-multiple-transactions-per-order.html#cb110-10" aria-hidden="true" tabindex="-1"></a>    sell_order <span class="op">=</span> %{sell_order <span class="op">|</span> <span class="va">status:</span> current_sell_order<span class="op">.</span>status}</span>
<span id="cb110-11"><a href="add-support-for-multiple-transactions-per-order.html#cb110-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-12"><a href="add-support-for-multiple-transactions-per-order.html#cb110-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> sell_order<span class="op">.</span>status <span class="op">==</span> <span class="st">&quot;FILLED&quot;</span> <span class="kw">do</span></span>
<span id="cb110-13"><a href="add-support-for-multiple-transactions-per-order.html#cb110-13" aria-hidden="true" tabindex="-1"></a>      <span class="cn">Logger</span><span class="op">.</span>info(<span class="st">&quot;Trade finished, trader will now exit&quot;</span>)</span>
<span id="cb110-14"><a href="add-support-for-multiple-transactions-per-order.html#cb110-14" aria-hidden="true" tabindex="-1"></a>      {<span class="va">:stop</span>, <span class="va">:normal</span>, state}</span>
<span id="cb110-15"><a href="add-support-for-multiple-transactions-per-order.html#cb110-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb110-16"><a href="add-support-for-multiple-transactions-per-order.html#cb110-16" aria-hidden="true" tabindex="-1"></a>      <span class="cn">Logger</span><span class="op">.</span>info(<span class="st">&quot;Sell order partially filled&quot;</span>)</span>
<span id="cb110-17"><a href="add-support-for-multiple-transactions-per-order.html#cb110-17" aria-hidden="true" tabindex="-1"></a>      new_state <span class="op">=</span> %{state <span class="op">|</span> <span class="va">sell_order:</span> sell_order}</span>
<span id="cb110-18"><a href="add-support-for-multiple-transactions-per-order.html#cb110-18" aria-hidden="true" tabindex="-1"></a>      {<span class="va">:noreply</span>, new_state}</span>
<span id="cb110-19"><a href="add-support-for-multiple-transactions-per-order.html#cb110-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span></code></pre></div>
</div>
<div id="test-the-implementation-1" class="section level2" number="8.6">
<h2><span class="header-section-number">8.6</span> Test the implementation</h2>
<p>Testing this feature is a bit tricky as it requires trading on real Binance exachnge(as our BinanceMock always fills order with a single transaction) as well as race condition to happen :) Not that easy but even without race condition we should still test that code works as expected wiht BinanceMock:</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb111-1"><a href="add-support-for-multiple-transactions-per-order.html#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> iex <span class="at">-S</span> mix</span>
<span id="cb111-2"><a href="add-support-for-multiple-transactions-per-order.html#cb111-2" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb111-3"><a href="add-support-for-multiple-transactions-per-order.html#cb111-3" aria-hidden="true" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">1</span><span class="kw">)</span><span class="op">&gt;</span> Naive.start_trading<span class="kw">(</span><span class="st">&quot;XRPUSDT&quot;</span><span class="kw">)</span></span>
<span id="cb111-4"><a href="add-support-for-multiple-transactions-per-order.html#cb111-4" aria-hidden="true" tabindex="-1"></a><span class="ex">23:27:35.977</span> [info]  Starting new supervision tree to trade on XRPUSDT</span>
<span id="cb111-5"><a href="add-support-for-multiple-transactions-per-order.html#cb111-5" aria-hidden="true" tabindex="-1"></a><span class="ex">{:ok,</span> <span class="co">#PID&lt;0.331.0&gt;}</span></span>
<span id="cb111-6"><a href="add-support-for-multiple-transactions-per-order.html#cb111-6" aria-hidden="true" tabindex="-1"></a><span class="ex">23:27:39.073</span> [info]  Initializing new trader for XRPUSDT</span>
<span id="cb111-7"><a href="add-support-for-multiple-transactions-per-order.html#cb111-7" aria-hidden="true" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">2</span><span class="kw">)</span><span class="op">&gt;</span> Streamer.start_streaming<span class="kw">(</span><span class="st">&quot;XRPUSDT&quot;</span><span class="kw">)</span></span>
<span id="cb111-8"><a href="add-support-for-multiple-transactions-per-order.html#cb111-8" aria-hidden="true" tabindex="-1"></a><span class="ex">{:ok,</span> <span class="co">#PID&lt;0.345.0&gt;}</span></span>
<span id="cb111-9"><a href="add-support-for-multiple-transactions-per-order.html#cb111-9" aria-hidden="true" tabindex="-1"></a><span class="ex">23:31:57.044</span> [info]  Initializing new trader for XRPUSDT</span>
<span id="cb111-10"><a href="add-support-for-multiple-transactions-per-order.html#cb111-10" aria-hidden="true" tabindex="-1"></a><span class="ex">23:31:57.888</span> [info]  Placing BUY order for XRPUSDT @ 0.28031, quantity: 71.3</span>
<span id="cb111-11"><a href="add-support-for-multiple-transactions-per-order.html#cb111-11" aria-hidden="true" tabindex="-1"></a><span class="ex">23:32:01.023</span> [info]  Buy order filled, placing SELL order for XRPUSDT @ 0.28053, quantity: 71.30000000</span>
<span id="cb111-12"><a href="add-support-for-multiple-transactions-per-order.html#cb111-12" aria-hidden="true" tabindex="-1"></a><span class="ex">23:33:08.865</span> [info]  Trade finished, trader will now exit</span>
<span id="cb111-13"><a href="add-support-for-multiple-transactions-per-order.html#cb111-13" aria-hidden="true" tabindex="-1"></a><span class="ex">23:33:08.865</span> [info]  XRPUSDT Trader finished <span class="at">-</span> restarting</span></code></pre></div>
<p>[Note] Please remember to run <code>mix format</code> to keep things nice and tidy.</p>
<p>Source code for this chapter can be found at <a href="https://github.com/frathon/create-a-cryptocurrency-trading-bot-in-elixir-source-code/tree/chapter_08">Github</a></p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="introduce-a-trader-budget-and-calculating-the-quantity.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="run-multiple-traders-in-parallel.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/frathon/create-a-cryptocurrency-trading-bot-in-elixir/edit/main/08-support-multiple-transactions-per-order.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["create-a-cryptocurrency-trading-bot-in-elixir.pdf", "create-a-cryptocurrency-trading-bot-in-elixir.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
