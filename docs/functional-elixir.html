<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 18 Functional Elixir | Hands-on Elixir &amp; OTP: Cryptocurrency trading bot</title>
  <meta name="description" content="Chapter 18 Functional Elixir | Hands-on Elixir &amp; OTP: Cryptocurrency trading bot" />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 18 Functional Elixir | Hands-on Elixir &amp; OTP: Cryptocurrency trading bot" />
  <meta property="og:type" content="book" />
  
  
  
  <meta name="github-repo" content="Cinderella-Man/hands-on-elixir-and-otp-cryptocurrency-trading-bot" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 18 Functional Elixir | Hands-on Elixir &amp; OTP: Cryptocurrency trading bot" />
  <meta name="twitter:site" content="@kamilskowron" />
  
  

<meta name="author" content="Kamil Skowron" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="mox-rocks.html"/>
<link rel="next" href="idiomatic-otp.html"/>
<script src="libs/header-attrs-2.8/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-52FKGBX2B8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-52FKGBX2B8');
</script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Hands-on Elixir & OTP: Cryptocurrency trading bot</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#want-to-learn-elixir-otp-by-creating-a-real-world-project"><i class="fa fa-check"></i>Want to learn Elixir &amp; OTP by creating a real-world project?</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#limit-of-liabilitydisclaimer-of-warranty"><i class="fa fa-check"></i>Limit of Liability/Disclaimer of Warranty</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#pdf-epub"><i class="fa fa-check"></i>PDF &amp; EPUB</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#preface-1"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#who-this-book-is-for"><i class="fa fa-check"></i>Who this book is for</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#what-this-book-covers"><i class="fa fa-check"></i>What this book covers</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#contributing-errata-and-source-code"><i class="fa fa-check"></i>Contributing, Errata and Source code</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><i class="fa fa-check"></i><b>1</b> Stream live cryptocurrency prices from the Binance WSS</a>
<ul>
<li class="chapter" data-level="1.1" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html#objectives"><i class="fa fa-check"></i><b>1.1</b> Objectives</a></li>
<li class="chapter" data-level="1.2" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html#create-a-new-umbrella-app"><i class="fa fa-check"></i><b>1.2</b> Create a new umbrella app</a></li>
<li class="chapter" data-level="1.3" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html#create-a-supervised-application-inside-an-umbrella"><i class="fa fa-check"></i><b>1.3</b> Create a supervised application inside an umbrella</a></li>
<li class="chapter" data-level="1.4" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html#connect-to-binances-websocket-stream-using-the-websockex-module"><i class="fa fa-check"></i><b>1.4</b> Connect to Binance’s WebSocket Stream using the WebSockex module</a></li>
<li class="chapter" data-level="1.5" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html#decode-incoming-events-using-the-jason-module"><i class="fa fa-check"></i><b>1.5</b> Decode incoming events using the Jason module</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><i class="fa fa-check"></i><b>2</b> Create a naive trading strategy - a single trader process without supervision</a>
<ul>
<li class="chapter" data-level="2.1" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#objectives-1"><i class="fa fa-check"></i><b>2.1</b> Objectives</a></li>
<li class="chapter" data-level="2.2" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#initializiation"><i class="fa fa-check"></i><b>2.2</b> Initializiation</a></li>
<li class="chapter" data-level="2.3" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#how-trading-strategy-will-work"><i class="fa fa-check"></i><b>2.3</b> How trading strategy will work?</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#implementation-of-the-first-scenario"><i class="fa fa-check"></i><b>2.3.1</b> Implementation of the first scenario</a></li>
<li class="chapter" data-level="2.3.2" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#implementation-of-the-second-scenario"><i class="fa fa-check"></i><b>2.3.2</b> Implementation of the second scenario</a></li>
<li class="chapter" data-level="2.3.3" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#implementation-of-the-third-scenario"><i class="fa fa-check"></i><b>2.3.3</b> Implementation of the third scenario</a></li>
<li class="chapter" data-level="2.3.4" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#implementation-fallback-scenario"><i class="fa fa-check"></i><b>2.3.4</b> Implementation fallback scenario</a></li>
<li class="chapter" data-level="2.3.5" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#updating-the-naive-interface"><i class="fa fa-check"></i><b>2.3.5</b> Updating the Naive interface</a></li>
<li class="chapter" data-level="2.3.6" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#updating-streamer-app"><i class="fa fa-check"></i><b>2.3.6</b> Updating streamer app</a></li>
<li class="chapter" data-level="2.3.7" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#access-details-to-binance"><i class="fa fa-check"></i><b>2.3.7</b> Access details to Binance</a></li>
<li class="chapter" data-level="2.3.8" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#test-run"><i class="fa fa-check"></i><b>2.3.8</b> Test run</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html"><i class="fa fa-check"></i><b>3</b> Introduce PubSub as a communication method</a>
<ul>
<li class="chapter" data-level="3.1" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html#objectives-2"><i class="fa fa-check"></i><b>3.1</b> Objectives</a></li>
<li class="chapter" data-level="3.2" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html#design"><i class="fa fa-check"></i><b>3.2</b> Design</a></li>
<li class="chapter" data-level="3.3" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html#implementation"><i class="fa fa-check"></i><b>3.3</b> Implementation</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html"><i class="fa fa-check"></i><b>4</b> Mock the Binance API</a>
<ul>
<li class="chapter" data-level="4.1" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#objectives-3"><i class="fa fa-check"></i><b>4.1</b> Objectives</a></li>
<li class="chapter" data-level="4.2" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#design-1"><i class="fa fa-check"></i><b>4.2</b> Design</a></li>
<li class="chapter" data-level="4.3" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#create-binancemock-app"><i class="fa fa-check"></i><b>4.3</b> Create “BinanceMock” app</a></li>
<li class="chapter" data-level="4.4" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-getting-exchange-info"><i class="fa fa-check"></i><b>4.4</b> Implement getting exchange info</a></li>
<li class="chapter" data-level="4.5" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-placing-buy-and-sell-orders"><i class="fa fa-check"></i><b>4.5</b> Implement placing buy and sell orders</a></li>
<li class="chapter" data-level="4.6" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-order-retrival"><i class="fa fa-check"></i><b>4.6</b> Implement order retrival</a></li>
<li class="chapter" data-level="4.7" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-callback-for-incoming-trade-events"><i class="fa fa-check"></i><b>4.7</b> Implement callback for incoming trade events</a></li>
<li class="chapter" data-level="4.8" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#upgrade-trader-and-config"><i class="fa fa-check"></i><b>4.8</b> Upgrade trader and config</a></li>
<li class="chapter" data-level="4.9" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#test-the-implementation"><i class="fa fa-check"></i><b>4.9</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html"><i class="fa fa-check"></i><b>5</b> Enable parallel trading on multiple symbols</a>
<ul>
<li class="chapter" data-level="5.1" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#objectives-4"><i class="fa fa-check"></i><b>5.1</b> Objectives</a></li>
<li class="chapter" data-level="5.2" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#introduction---architectural-design"><i class="fa fa-check"></i><b>5.2</b> Introduction - architectural design</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#update-application-supervisor"><i class="fa fa-check"></i><b>5.2.1</b> Update application supervisor</a></li>
<li class="chapter" data-level="5.2.2" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#add-interface-method"><i class="fa fa-check"></i><b>5.2.2</b> Add interface method</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#implement-naive.symbolsupervisor"><i class="fa fa-check"></i><b>5.3</b> Implement <code>Naive.SymbolSupervisor</code></a></li>
<li class="chapter" data-level="5.4" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#implement-naive.leader"><i class="fa fa-check"></i><b>5.4</b> Implement <code>Naive.Leader</code></a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#updating-the-leader-module"><i class="fa fa-check"></i><b>5.4.1</b> Updating the <code>leader</code> module</a></li>
<li class="chapter" data-level="5.4.2" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#updating-the-naive.trader-module"><i class="fa fa-check"></i><b>5.4.2</b> Updating the <code>Naive.Trader</code> module</a></li>
<li class="chapter" data-level="5.4.3" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#finalizing-naive.leader-implementation"><i class="fa fa-check"></i><b>5.4.3</b> Finalizing <code>Naive.Leader</code> implementation</a></li>
<li class="chapter" data-level="5.4.4" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#iex-testing"><i class="fa fa-check"></i><b>5.4.4</b> IEx testing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><i class="fa fa-check"></i><b>6</b> Introduce a <code>buy_down_interval</code> to make a single trader more profitable</a>
<ul>
<li class="chapter" data-level="6.1" data-path="introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html#objectives-5"><i class="fa fa-check"></i><b>6.1</b> Objectives</a></li>
<li class="chapter" data-level="6.2" data-path="introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html#why-we-need-to-buy-below-the-current-price-feature-overview"><i class="fa fa-check"></i><b>6.2</b> Why we need to buy below the current price? Feature overview</a></li>
<li class="chapter" data-level="6.3" data-path="introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html#naive.trader-implementation"><i class="fa fa-check"></i><b>6.3</b> <code>Naive.Trader</code> implementation</a></li>
<li class="chapter" data-level="6.4" data-path="introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html#naive.leader-implementation"><i class="fa fa-check"></i><b>6.4</b> <code>Naive.Leader</code> implementation</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html#iex-testing-1"><i class="fa fa-check"></i><b>6.4.1</b> IEx testing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html"><i class="fa fa-check"></i><b>7</b> Introduce a trader budget and calculating the quantity</a>
<ul>
<li class="chapter" data-level="7.1" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#objectives-6"><i class="fa fa-check"></i><b>7.1</b> Objectives</a></li>
<li class="chapter" data-level="7.2" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#fetch-step_size"><i class="fa fa-check"></i><b>7.2</b> Fetch <code>step_size</code></a></li>
<li class="chapter" data-level="7.3" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#append-budget-and-step_size-to-the-traders-state-inside-the-leader"><i class="fa fa-check"></i><b>7.3</b> Append <code>budget</code> and <code>step_size</code> to the <code>Trader</code>’s state inside the <code>Leader</code></a></li>
<li class="chapter" data-level="7.4" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#append-budget-and-step_size-to-the-traders-state"><i class="fa fa-check"></i><b>7.4</b> Append <code>budget</code> and <code>step_size</code> to the <code>Trader</code>’s state</a></li>
<li class="chapter" data-level="7.5" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#calculate-quantity"><i class="fa fa-check"></i><b>7.5</b> Calculate quantity</a>
<ul>
<li class="chapter" data-level="7.5.1" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#iex-testing-2"><i class="fa fa-check"></i><b>7.5.1</b> IEx testing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html"><i class="fa fa-check"></i><b>8</b> Add support for multiple transactions per order</a>
<ul>
<li class="chapter" data-level="8.1" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#objectives-7"><i class="fa fa-check"></i><b>8.1</b> Objectives</a></li>
<li class="chapter" data-level="8.2" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#the-issue-with-the-current-implementation"><i class="fa fa-check"></i><b>8.2</b> The issue with the current implementation</a></li>
<li class="chapter" data-level="8.3" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#improve-buy-order-filled-callback"><i class="fa fa-check"></i><b>8.3</b> Improve buy order filled callback</a></li>
<li class="chapter" data-level="8.4" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#implement-buy-order-filled-callback"><i class="fa fa-check"></i><b>8.4</b> Implement buy order “filled” callback</a></li>
<li class="chapter" data-level="8.5" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#improve-sell-order-callback"><i class="fa fa-check"></i><b>8.5</b> Improve sell order callback</a></li>
<li class="chapter" data-level="8.6" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#test-the-implementation-1"><i class="fa fa-check"></i><b>8.6</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html"><i class="fa fa-check"></i><b>9</b> Run multiple traders in parallel</a>
<ul>
<li class="chapter" data-level="9.1" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#objectives-8"><i class="fa fa-check"></i><b>9.1</b> Objectives</a></li>
<li class="chapter" data-level="9.2" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#describe-and-design-the-required-functionality"><i class="fa fa-check"></i><b>9.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="9.3" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#implement-rebuy-inside-naive.trader"><i class="fa fa-check"></i><b>9.3</b> Implement rebuy inside <code>Naive.Trader</code></a></li>
<li class="chapter" data-level="9.4" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#implement-rebuy-in-the-naive.leader"><i class="fa fa-check"></i><b>9.4</b> Implement rebuy in the <code>Naive.Leader</code></a></li>
<li class="chapter" data-level="9.5" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#improve-logs-by-assigning-ids-to-traders"><i class="fa fa-check"></i><b>9.5</b> Improve logs by assigning ids to traders</a></li>
<li class="chapter" data-level="9.6" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#test-the-implementation-2"><i class="fa fa-check"></i><b>9.6</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html"><i class="fa fa-check"></i><b>10</b> Fine-tune trading strategy per symbol</a>
<ul>
<li class="chapter" data-level="10.1" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#objectives-9"><i class="fa fa-check"></i><b>10.1</b> Objectives</a></li>
<li class="chapter" data-level="10.2" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#describe-and-design-the-required-functionality-1"><i class="fa fa-check"></i><b>10.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="10.3" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#add-docker-to-project"><i class="fa fa-check"></i><b>10.3</b> Add docker to project</a></li>
<li class="chapter" data-level="10.4" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#set-up-ecto-inside-the-naive-app"><i class="fa fa-check"></i><b>10.4</b> Set up <code>ecto</code> inside the <code>naive</code> app</a></li>
<li class="chapter" data-level="10.5" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#create-and-migrate-the-db"><i class="fa fa-check"></i><b>10.5</b> Create and migrate the DB</a></li>
<li class="chapter" data-level="10.6" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#seed-symbols-settings"><i class="fa fa-check"></i><b>10.6</b> Seed symbols’ settings</a></li>
<li class="chapter" data-level="10.7" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#update-the-naive.leader-to-fetch-settings"><i class="fa fa-check"></i><b>10.7</b> Update the <code>Naive.Leader</code> to fetch settings</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html"><i class="fa fa-check"></i><b>11</b> Supervise and autostart streaming</a>
<ul>
<li class="chapter" data-level="11.1" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#objectives-10"><i class="fa fa-check"></i><b>11.1</b> Objectives</a></li>
<li class="chapter" data-level="11.2" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#describe-and-design-the-required-functionality-2"><i class="fa fa-check"></i><b>11.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="11.3" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#register-the-streamer.binance-processes-with-names"><i class="fa fa-check"></i><b>11.3</b> Register the <code>Streamer.Binance</code> processes with names</a></li>
<li class="chapter" data-level="11.4" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#set-up-ecto-inside-the-streamer-app"><i class="fa fa-check"></i><b>11.4</b> Set up <code>ecto</code> inside the <code>streamer</code> app</a></li>
<li class="chapter" data-level="11.5" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#create-and-migrate-the-db-1"><i class="fa fa-check"></i><b>11.5</b> Create and migrate the db</a></li>
<li class="chapter" data-level="11.6" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#seed-default-settings"><i class="fa fa-check"></i><b>11.6</b> Seed default settings</a></li>
<li class="chapter" data-level="11.7" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#implement-the-supervision-tree-and-start-streaming-functionality"><i class="fa fa-check"></i><b>11.7</b> Implement the supervision tree and start streaming functionality</a></li>
<li class="chapter" data-level="11.8" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#implement-the-stop-functionality"><i class="fa fa-check"></i><b>11.8</b> Implement the stop functionality</a></li>
<li class="chapter" data-level="11.9" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#implement-the-autostart-streaming-functionality"><i class="fa fa-check"></i><b>11.9</b> Implement the autostart streaming functionality</a></li>
<li class="chapter" data-level="11.10" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#test-the-implementation-3"><i class="fa fa-check"></i><b>11.10</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html"><i class="fa fa-check"></i><b>12</b> Start, stop, shutdown and autostart trading</a>
<ul>
<li class="chapter" data-level="12.1" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#objectives-11"><i class="fa fa-check"></i><b>12.1</b> Objectives</a></li>
<li class="chapter" data-level="12.2" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#describe-and-design-the-required-functionality-3"><i class="fa fa-check"></i><b>12.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="12.3" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#re-implement-the-start-trading-functionality"><i class="fa fa-check"></i><b>12.3</b> (Re-)Implement the start trading functionality</a></li>
<li class="chapter" data-level="12.4" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#implement-the-stop-trading-functionality"><i class="fa fa-check"></i><b>12.4</b> Implement the stop trading functionality</a></li>
<li class="chapter" data-level="12.5" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#implement-the-autostart-trading-functionality"><i class="fa fa-check"></i><b>12.5</b> Implement the autostart trading functionality</a></li>
<li class="chapter" data-level="12.6" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#implement-the-shutdown-trading-functionality"><i class="fa fa-check"></i><b>12.6</b> Implement the shutdown trading functionality</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html"><i class="fa fa-check"></i><b>13</b> Abstract duplicated supervision code</a>
<ul>
<li class="chapter" data-level="13.1" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#objectives-12"><i class="fa fa-check"></i><b>13.1</b> Objectives</a></li>
<li class="chapter" data-level="13.2" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#overview-of-requirements"><i class="fa fa-check"></i><b>13.2</b> Overview of requirements</a></li>
<li class="chapter" data-level="13.3" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#pseudo-generalize-core.servicesupervisor-module"><i class="fa fa-check"></i><b>13.3</b> Pseudo generalize Core.ServiceSupervisor module</a></li>
<li class="chapter" data-level="13.4" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#utilize-pseudo-generalized-code-inside-the-naive-dynamicsymbolsupervisor"><i class="fa fa-check"></i><b>13.4</b> Utilize pseudo generalized code inside the Naive DynamicSymbolSupervisor</a></li>
<li class="chapter" data-level="13.5" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#implement-a-truly-generic-core.servicesupervisor"><i class="fa fa-check"></i><b>13.5</b> Implement a truly generic <code>Core.ServiceSupervisor</code></a>
<ul>
<li class="chapter" data-level="13.5.1" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#first-path-starting-with-the-fetch_symbols_to_start0-function"><i class="fa fa-check"></i><b>13.5.1</b> First path starting with the <code>fetch_symbols_to_start/0</code> function</a></li>
<li class="chapter" data-level="13.5.2" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#second-path-starting-with-the-update_status2"><i class="fa fa-check"></i><b>13.5.2</b> Second path starting with the <code>update_status/2</code></a></li>
<li class="chapter" data-level="13.5.3" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#third-path-starting-with-the-get_pid1-function"><i class="fa fa-check"></i><b>13.5.3</b> Third path starting with the <code>get_pid/1</code> function</a></li>
</ul></li>
<li class="chapter" data-level="13.6" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#remove-boilerplate-using-use-macro"><i class="fa fa-check"></i><b>13.6</b> Remove boilerplate using <code>use</code> macro</a></li>
<li class="chapter" data-level="13.7" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#use-the-core.servicesupervisor-module-inside-the-streamer-application"><i class="fa fa-check"></i><b>13.7</b> Use the <code>Core.ServiceSupervisor</code> module inside the <code>streamer</code> application</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html"><i class="fa fa-check"></i><b>14</b> Store trade events and orders inside the database</a>
<ul>
<li class="chapter" data-level="14.1" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#objectives-13"><i class="fa fa-check"></i><b>14.1</b> Objectives</a></li>
<li class="chapter" data-level="14.2" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#overview-of-requirements-1"><i class="fa fa-check"></i><b>14.2</b> Overview of requirements</a></li>
<li class="chapter" data-level="14.3" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-a-new-data_warehouse-application-in-the-umbrella"><i class="fa fa-check"></i><b>14.3</b> Create a new <code>data_warehouse</code> application in the umbrella</a></li>
<li class="chapter" data-level="14.4" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#connect-to-the-database-using-ecto"><i class="fa fa-check"></i><b>14.4</b> Connect to the database using Ecto</a></li>
<li class="chapter" data-level="14.5" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#store-trade-events-data"><i class="fa fa-check"></i><b>14.5</b> Store trade events’ data</a></li>
<li class="chapter" data-level="14.6" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#store-orders-data"><i class="fa fa-check"></i><b>14.6</b> Store orders’ data</a></li>
<li class="chapter" data-level="14.7" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#implement-supervision"><i class="fa fa-check"></i><b>14.7</b> Implement supervision</a>
<ul>
<li class="chapter" data-level="14.7.1" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-subscriber_settings-table"><i class="fa fa-check"></i><b>14.7.1</b> Create <code>subscriber_settings</code> table</a></li>
<li class="chapter" data-level="14.7.2" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#redesign-supervision-using-registry"><i class="fa fa-check"></i><b>14.7.2</b> Redesign supervision using Registry</a></li>
<li class="chapter" data-level="14.7.3" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-the-datawarehouse.subscriber.dynamicsupervisor-module"><i class="fa fa-check"></i><b>14.7.3</b> Create the <code>DataWarehouse.Subscriber.DynamicSupervisor</code> module</a></li>
<li class="chapter" data-level="14.7.4" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#register-worker-processes-using-via"><i class="fa fa-check"></i><b>14.7.4</b> Register Worker processes using :via</a></li>
<li class="chapter" data-level="14.7.5" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-a-new-supervision-level-for-registry-task-and-the-dynamicsupervisor"><i class="fa fa-check"></i><b>14.7.5</b> Create a new supervision level for Registry, Task and the DynamicSupervisor</a></li>
<li class="chapter" data-level="14.7.6" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#link-the-subscribersupervisor-to-the-application"><i class="fa fa-check"></i><b>14.7.6</b> Link the <code>SubscriberSupervisor</code> to the <code>Application</code></a></li>
<li class="chapter" data-level="14.7.7" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#add-interface"><i class="fa fa-check"></i><b>14.7.7</b> Add interface</a></li>
<li class="chapter" data-level="14.7.8" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#test"><i class="fa fa-check"></i><b>14.7.8</b> Test</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="15" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html"><i class="fa fa-check"></i><b>15</b> Backtest trading strategy</a>
<ul>
<li class="chapter" data-level="15.1" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#objectives-14"><i class="fa fa-check"></i><b>15.1</b> Objectives</a></li>
<li class="chapter" data-level="15.2" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#overview-of-requirements-2"><i class="fa fa-check"></i><b>15.2</b> Overview of requirements</a></li>
<li class="chapter" data-level="15.3" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#implement-the-storing-task"><i class="fa fa-check"></i><b>15.3</b> Implement the storing task</a></li>
<li class="chapter" data-level="15.4" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#test-the-backtesting"><i class="fa fa-check"></i><b>15.4</b> Test the backtesting</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html"><i class="fa fa-check"></i><b>16</b> End-to-end testing</a>
<ul>
<li class="chapter" data-level="16.1" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#objectives-15"><i class="fa fa-check"></i><b>16.1</b> Objectives</a></li>
<li class="chapter" data-level="16.2" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#decide-on-the-tested-functionality"><i class="fa fa-check"></i><b>16.2</b> Decide on the tested functionality</a></li>
<li class="chapter" data-level="16.3" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#implement-basic-test"><i class="fa fa-check"></i><b>16.3</b> Implement basic test</a></li>
<li class="chapter" data-level="16.4" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#introduce-environment-based-config-files"><i class="fa fa-check"></i><b>16.4</b> Introduce environment based config files</a></li>
<li class="chapter" data-level="16.5" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#add-convenience-aliases"><i class="fa fa-check"></i><b>16.5</b> Add convenience aliases</a></li>
<li class="chapter" data-level="16.6" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#cache-initial-seed-data-inside-a-file"><i class="fa fa-check"></i><b>16.6</b> Cache initial seed data inside a file</a></li>
<li class="chapter" data-level="16.7" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#update-seeding-scripts-to-use-the-binancemock"><i class="fa fa-check"></i><b>16.7</b> Update seeding scripts to use the BinanceMock</a></li>
<li class="chapter" data-level="16.8" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#introduce-the-core-application"><i class="fa fa-check"></i><b>16.8</b> Introduce the Core application</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="mox-rocks.html"><a href="mox-rocks.html"><i class="fa fa-check"></i><b>17</b> Mox rocks</a>
<ul>
<li class="chapter" data-level="17.1" data-path="mox-rocks.html"><a href="mox-rocks.html#objectives-16"><i class="fa fa-check"></i><b>17.1</b> Objectives</a></li>
<li class="chapter" data-level="17.2" data-path="mox-rocks.html"><a href="mox-rocks.html#introduction-to-mock-based-tests"><i class="fa fa-check"></i><b>17.2</b> Introduction to mock based tests</a></li>
<li class="chapter" data-level="17.3" data-path="mox-rocks.html"><a href="mox-rocks.html#add-the-mox-package"><i class="fa fa-check"></i><b>17.3</b> Add the <code>mox</code> package</a></li>
<li class="chapter" data-level="17.4" data-path="mox-rocks.html"><a href="mox-rocks.html#investigate-the-naive.trader-module"><i class="fa fa-check"></i><b>17.4</b> Investigate the <code>Naive.Trader</code> module</a>
<ul>
<li class="chapter" data-level="17.4.1" data-path="mox-rocks.html"><a href="mox-rocks.html#mock-the-binance-module"><i class="fa fa-check"></i><b>17.4.1</b> Mock the <code>Binance</code> module</a></li>
<li class="chapter" data-level="17.4.2" data-path="mox-rocks.html"><a href="mox-rocks.html#mock-the-naiveleader-module"><i class="fa fa-check"></i><b>17.4.2</b> Mock the <code>NaiveLeader</code> module</a></li>
<li class="chapter" data-level="17.4.3" data-path="mox-rocks.html"><a href="mox-rocks.html#mock-the-phoenix.pubsub-module"><i class="fa fa-check"></i><b>17.4.3</b> Mock the <code>Phoenix.PubSub</code> module</a></li>
<li class="chapter" data-level="17.4.4" data-path="mox-rocks.html"><a href="mox-rocks.html#mock-the-logger-module"><i class="fa fa-check"></i><b>17.4.4</b> Mock the <code>Logger</code> module</a></li>
</ul></li>
<li class="chapter" data-level="17.5" data-path="mox-rocks.html"><a href="mox-rocks.html#implement-a-test-of-the-naive.trader-module"><i class="fa fa-check"></i><b>17.5</b> Implement a test of the <code>Naive.Trader</code> module</a></li>
<li class="chapter" data-level="17.6" data-path="mox-rocks.html"><a href="mox-rocks.html#define-an-alias-to-run-unit-tests"><i class="fa fa-check"></i><b>17.6</b> Define an alias to run unit tests</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="functional-elixir.html"><a href="functional-elixir.html"><i class="fa fa-check"></i><b>18</b> Functional Elixir</a>
<ul>
<li class="chapter" data-level="18.1" data-path="functional-elixir.html"><a href="functional-elixir.html#objectives-17"><i class="fa fa-check"></i><b>18.1</b> Objectives</a></li>
<li class="chapter" data-level="18.2" data-path="functional-elixir.html"><a href="functional-elixir.html#the-reasoning-behind-the-functional-approach"><i class="fa fa-check"></i><b>18.2</b> The reasoning behind the functional approach</a></li>
<li class="chapter" data-level="18.3" data-path="functional-elixir.html"><a href="functional-elixir.html#simplifying-by-splitting"><i class="fa fa-check"></i><b>18.3</b> Simplifying by splitting</a></li>
<li class="chapter" data-level="18.4" data-path="functional-elixir.html"><a href="functional-elixir.html#abstracting-the-pure-logic"><i class="fa fa-check"></i><b>18.4</b> Abstracting the “pure” logic</a>
<ul>
<li class="chapter" data-level="18.4.1" data-path="functional-elixir.html"><a href="functional-elixir.html#place-a-buy-order-rules"><i class="fa fa-check"></i><b>18.4.1</b> Place a buy order rules</a></li>
<li class="chapter" data-level="18.4.2" data-path="functional-elixir.html"><a href="functional-elixir.html#race-condition-rules"><i class="fa fa-check"></i><b>18.4.2</b> Race condition rules</a></li>
<li class="chapter" data-level="18.4.3" data-path="functional-elixir.html"><a href="functional-elixir.html#place-a-sell-order-rules"><i class="fa fa-check"></i><b>18.4.3</b> Place a sell order rules</a></li>
<li class="chapter" data-level="18.4.4" data-path="functional-elixir.html"><a href="functional-elixir.html#fetch-the-buy-order-rules"><i class="fa fa-check"></i><b>18.4.4</b> Fetch the buy order rules</a></li>
<li class="chapter" data-level="18.4.5" data-path="functional-elixir.html"><a href="functional-elixir.html#terminate-trader-rules"><i class="fa fa-check"></i><b>18.4.5</b> Terminate trader rules</a></li>
<li class="chapter" data-level="18.4.6" data-path="functional-elixir.html"><a href="functional-elixir.html#fetch-the-sell-order-rules"><i class="fa fa-check"></i><b>18.4.6</b> Fetch the sell order rules</a></li>
<li class="chapter" data-level="18.4.7" data-path="functional-elixir.html"><a href="functional-elixir.html#trigger-rebuy-rules"><i class="fa fa-check"></i><b>18.4.7</b> Trigger rebuy rules</a></li>
<li class="chapter" data-level="18.4.8" data-path="functional-elixir.html"><a href="functional-elixir.html#the-final-clause-rules"><i class="fa fa-check"></i><b>18.4.8</b> The final clause rules</a></li>
<li class="chapter" data-level="18.4.9" data-path="functional-elixir.html"><a href="functional-elixir.html#changes-to-the-naive.trader-module"><i class="fa fa-check"></i><b>18.4.9</b> Changes to the <code>Naive.Trader</code> module</a></li>
<li class="chapter" data-level="18.4.10" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---place-buy-order"><i class="fa fa-check"></i><b>18.4.10</b> <code>Naive.Trader</code> - place buy order</a></li>
<li class="chapter" data-level="18.4.11" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---race-condition-clause"><i class="fa fa-check"></i><b>18.4.11</b> <code>Naive.Trader</code> - Race condition clause</a></li>
<li class="chapter" data-level="18.4.12" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---place-a-sell-order"><i class="fa fa-check"></i><b>18.4.12</b> <code>Naive.Trader</code> - Place a sell order</a></li>
<li class="chapter" data-level="18.4.13" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---fetch-the-buy-order"><i class="fa fa-check"></i><b>18.4.13</b> <code>Naive.Trader</code> - Fetch the buy order</a></li>
<li class="chapter" data-level="18.4.14" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---terminate-the-trader"><i class="fa fa-check"></i><b>18.4.14</b> <code>Naive.Trader</code> - Terminate the trader</a></li>
<li class="chapter" data-level="18.4.15" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---fetch-the-sell-order"><i class="fa fa-check"></i><b>18.4.15</b> <code>Naive.Trader</code> - Fetch the sell order</a></li>
<li class="chapter" data-level="18.4.16" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---triggering-rebuy"><i class="fa fa-check"></i><b>18.4.16</b> <code>Naive.Trader</code> - Triggering rebuy</a></li>
<li class="chapter" data-level="18.4.17" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---the-final-ignore-clause"><i class="fa fa-check"></i><b>18.4.17</b> <code>Naive.Trader</code> - The final ignore clause</a></li>
</ul></li>
<li class="chapter" data-level="18.5" data-path="functional-elixir.html"><a href="functional-elixir.html#dealing-with-dirty-code"><i class="fa fa-check"></i><b>18.5</b> Dealing with dirty code</a></li>
<li class="chapter" data-level="18.6" data-path="functional-elixir.html"><a href="functional-elixir.html#making-dirty-code-testable"><i class="fa fa-check"></i><b>18.6</b> Making dirty code testable</a>
<ul>
<li class="chapter" data-level="18.6.1" data-path="functional-elixir.html"><a href="functional-elixir.html#passing-functions-arguments"><i class="fa fa-check"></i><b>18.6.1</b> Passing functions arguments</a></li>
<li class="chapter" data-level="18.6.2" data-path="functional-elixir.html"><a href="functional-elixir.html#passing-grouped-functions-as-a-context"><i class="fa fa-check"></i><b>18.6.2</b> Passing grouped functions as a context</a></li>
<li class="chapter" data-level="18.6.3" data-path="functional-elixir.html"><a href="functional-elixir.html#passing-grouped-modules-as-a-context"><i class="fa fa-check"></i><b>18.6.3</b> Passing grouped modules as a context</a></li>
<li class="chapter" data-level="18.6.4" data-path="functional-elixir.html"><a href="functional-elixir.html#injecting-modules-to-modules-attributes-based-on-the-configuration"><i class="fa fa-check"></i><b>18.6.4</b> Injecting modules to module’s attributes based on the configuration</a></li>
</ul></li>
<li class="chapter" data-level="18.7" data-path="functional-elixir.html"><a href="functional-elixir.html#the-power-with-in"><i class="fa fa-check"></i><b>18.7</b> The power <code>with</code>-in</a>
<ul>
<li class="chapter" data-level="18.7.1" data-path="functional-elixir.html"><a href="functional-elixir.html#idiomatic-error-handling"><i class="fa fa-check"></i><b>18.7.1</b> Idiomatic error handling</a></li>
</ul></li>
<li class="chapter" data-level="18.8" data-path="functional-elixir.html"><a href="functional-elixir.html#do-or-not-to-do"><i class="fa fa-check"></i><b>18.8</b> Do or not to do</a></li>
<li class="chapter" data-level="18.9" data-path="functional-elixir.html"><a href="functional-elixir.html#final-thoughts"><i class="fa fa-check"></i><b>18.9</b> Final thoughts</a></li>
</ul></li>
<li class="chapter" data-level="19" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html"><i class="fa fa-check"></i><b>19</b> Idiomatic OTP</a>
<ul>
<li class="chapter" data-level="19.1" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#objectives-18"><i class="fa fa-check"></i><b>19.1</b> Objectives</a></li>
<li class="chapter" data-level="19.2" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#the-concept"><i class="fa fa-check"></i><b>19.2</b> The concept</a></li>
<li class="chapter" data-level="19.3" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#initial-implementation"><i class="fa fa-check"></i><b>19.3</b> Initial implementation</a>
<ul>
<li class="chapter" data-level="19.3.1" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#maybe-functions"><i class="fa fa-check"></i><b>19.3.1</b> Maybe functions</a></li>
<li class="chapter" data-level="19.3.2" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#testing"><i class="fa fa-check"></i><b>19.3.2</b> Testing</a></li>
<li class="chapter" data-level="19.3.3" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#supervision"><i class="fa fa-check"></i><b>19.3.3</b> Supervision</a></li>
</ul></li>
<li class="chapter" data-level="19.4" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#idiomatic-solution"><i class="fa fa-check"></i><b>19.4</b> Idiomatic solution</a></li>
</ul></li>
<li class="chapter" data-level="20" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html"><i class="fa fa-check"></i><b>20</b> Idiomatic trading strategy</a>
<ul>
<li class="chapter" data-level="20.1" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#objectives-19"><i class="fa fa-check"></i><b>20.1</b> Objectives</a></li>
<li class="chapter" data-level="20.2" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#following-the-ohlc-footsteps"><i class="fa fa-check"></i><b>20.2</b> Following the OHLC footsteps</a></li>
<li class="chapter" data-level="20.3" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#simplifying-the-naive-supervision-tree"><i class="fa fa-check"></i><b>20.3</b> Simplifying the Naive supervision tree</a>
<ul>
<li class="chapter" data-level="20.3.1" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#the-naive.dynamictradersupervisor-module"><i class="fa fa-check"></i><b>20.3.1</b> The <code>Naive.DynamicTraderSupervisor</code> module</a></li>
<li class="chapter" data-level="20.3.2" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#the-naive-module"><i class="fa fa-check"></i><b>20.3.2</b> The <code>Naive</code> module</a></li>
<li class="chapter" data-level="20.3.3" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#the-naive.supervisor-module"><i class="fa fa-check"></i><b>20.3.3</b> The <code>Naive.Supervisor</code> module</a></li>
<li class="chapter" data-level="20.3.4" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#the-naive.trader-module"><i class="fa fa-check"></i><b>20.3.4</b> The <code>Naive.Trader</code> module</a></li>
</ul></li>
<li class="chapter" data-level="20.4" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#supporting-multiple-positions"><i class="fa fa-check"></i><b>20.4</b> Supporting multiple positions</a>
<ul>
<li class="chapter" data-level="20.4.1" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#initialization"><i class="fa fa-check"></i><b>20.4.1</b> Initialization</a></li>
<li class="chapter" data-level="20.4.2" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#parallelising-the-strategy"><i class="fa fa-check"></i><b>20.4.2</b> Parallelising the strategy</a></li>
</ul></li>
<li class="chapter" data-level="20.5" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#retrofitting-the-shutdown-functionality"><i class="fa fa-check"></i><b>20.5</b> Retrofitting the “shutdown” functionality</a>
<ul>
<li class="chapter" data-level="20.5.1" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#handling-updated-settings"><i class="fa fa-check"></i><b>20.5.1</b> Handling updated settings</a></li>
<li class="chapter" data-level="20.5.2" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#updating-the-naive.strategy-to-honour-the-shutdown-state"><i class="fa fa-check"></i><b>20.5.2</b> Updating the <code>Naive.Strategy</code> to honour the “shutdown” state</a></li>
</ul></li>
<li class="chapter" data-level="20.6" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#updating-the-strategy-to-handle-rebuys"><i class="fa fa-check"></i><b>20.6</b> Updating the Strategy to handle rebuys</a></li>
<li class="chapter" data-level="20.7" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#fetching-active-positions"><i class="fa fa-check"></i><b>20.7</b> Fetching active positions</a></li>
<li class="chapter" data-level="20.8" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#tidying-up"><i class="fa fa-check"></i><b>20.8</b> Tidying up</a></li>
<li class="chapter" data-level="20.9" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#final-thoughts-1"><i class="fa fa-check"></i><b>20.9</b> Final thoughts</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://www.bookdown.org/" target="blank">Created with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Hands-on Elixir &amp; OTP: Cryptocurrency trading bot</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="functional-elixir" class="section level1" number="18">
<h1><span class="header-section-number">Chapter 18</span> Functional Elixir</h1>
<div id="objectives-17" class="section level2" number="18.1">
<h2><span class="header-section-number">18.1</span> Objectives</h2>
<ul>
<li>the reasoning behind the functional approach</li>
<li>simplifying by splitting</li>
<li>abstracting the “pure” logic</li>
<li>dealing with dirty code</li>
<li>making dirty code testable</li>
<li>the power <code>with</code>-in</li>
<li>do or not to do</li>
<li>final thoughts</li>
</ul>
</div>
<div id="the-reasoning-behind-the-functional-approach" class="section level2" number="18.2">
<h2><span class="header-section-number">18.2</span> The reasoning behind the functional approach</h2>
<p>Across the last 17 chapters, we focused on learning OTP by building a trading system. On the way, we omitted (for a very good reason - a clear focus on OTP) the conversation about functional programming.</p>
<p>But wait, what? We are already using concepts like higher-order functions - isn’t that enough?</p>
<p>We indeed use some functional patterns, but we never dug deeper into what Elixir developers <strong>should</strong> know(and apply) and, most importantly, <strong>why</strong>.</p>
<p>In a nutshell, the selling point of functional programming is that applying it will make your code easier to reason about and test. Tests dramatically improve software quality. The easier they are to write, there’s less excuse not to write them - as simple as that.</p>
<p>We will start from the basics and look into different ways of implementing functional concepts, considering Elixir’s strengths and weaknesses.</p>
</div>
<div id="simplifying-by-splitting" class="section level2" number="18.3">
<h2><span class="header-section-number">18.3</span> Simplifying by splitting</h2>
<p>Note: This section could appear to be a bit “random”, but I added it to aid continuity of refactoring steps(refactoring those callbacks later would cause a fair amount of complexity).</p>
<p>Let’s look at our strategy inside the <code>Naive.Trader</code> module. In this section, we will focus on its (<code>handle_info/2</code>) callback function.</p>
<p>We are looking for clauses that do more than “one thing” to split them into multiple clauses:</p>
<ul>
<li>The first callback places a buy order - it has a single responsibility and is easy to follow.</li>
<li>The second callback takes care of race conditions - the same story, easy to understand.</li>
<li>The third callback is the one we will focus on. It branches using the <code>if</code> statement, and we could describe it as “fetch and maybe place a sell order” function. The “and” in the description clearly indicates that it’s really two functions glued together. We will split it into “fetch buy order” and “place a sell order” functions(below code replaces the 3rd <code>handle_info/2</code> callback):</li>
</ul>
<pre><code># /apps/naive/lib/naive/trader.ex
  def handle_info(
        %TradeEvent{},
        %State{
          id: id,
          symbol: symbol,
          buy_order: %Binance.OrderResponse{
            price: buy_price,
            orig_qty: quantity,
            status: &quot;FILLED&quot;
          },
          sell_order: nil,
          profit_interval: profit_interval,
          tick_size: tick_size
        } = state
      ) do
    sell_price = calculate_sell_price(buy_price, profit_interval, tick_size)

    @logger.info(
      &quot;The trader(#{id}) is placing a SELL order for &quot; &lt;&gt;
        &quot;#{symbol} @ #{sell_price}, quantity: #{quantity}.&quot;
    )

    {:ok, %Binance.OrderResponse{} = order} =
      @binance_client.order_limit_sell(symbol, quantity, sell_price, &quot;GTC&quot;)

    :ok = broadcast_order(order)

    new_state = %{state | sell_order: order}
    @leader.notify(:trader_state_updated, new_state)
    {:noreply, new_state}
  end

  def handle_info(
        %TradeEvent{
          buyer_order_id: order_id
        },
        %State{
          id: id,
          symbol: symbol,
          buy_order:
            %Binance.OrderResponse{
              order_id: order_id,
              transact_time: timestamp
            } = buy_order
        } = state
      ) do
    @logger.info(&quot;Trader&#39;s(#{id} #{symbol} buy order got partially filled&quot;)

    {:ok, %Binance.Order{} = current_buy_order} =
      @binance_client.get_order(
        symbol,
        timestamp,
        order_id
      )

    :ok = broadcast_order(current_buy_order)

    buy_order = %{buy_order | status: current_buy_order.status}

    new_state = %{state | buy_order: buy_order}
    @leader.notify(:trader_state_updated, new_state)
    {:noreply, new_state}
  end</code></pre>
<p>The first function takes care of placing a sell order. The second one fetches the buy order.</p>
<ul>
<li>We can now move to the next clause, similar to the last one we could describe as “fetch the sell order and maybe terminate the trader”. We will split it into two callbacks: “fetch the sell order” and “terminate trader”.</li>
</ul>
<div style="page-break-after: always;"></div>
<p>The code below replaces the 5th <code>handle_info/2</code> callback:</p>
<pre><code># /apps/naive/lib/naive/trader.ex
  def handle_info(
        %TradeEvent{},
        %State{
          id: id,
          symbol: symbol,
          sell_order: %Binance.OrderResponse{
            status: &quot;FILLED&quot;
          }
        } = state
      ) do
    @logger.info(&quot;Trader(#{id}) finished trade cycle for #{symbol}&quot;)
    {:stop, :normal, state}
  end

  def handle_info(
        %TradeEvent{
          seller_order_id: order_id
        },
        %State{
          id: id,
          symbol: symbol,
          sell_order:
            %Binance.OrderResponse{
              order_id: order_id,
              transact_time: timestamp
            } = sell_order
        } = state
      ) do
    @logger.info(&quot;Trader&#39;s(#{id} #{symbol} SELL order got partially filled&quot;)

    {:ok, %Binance.Order{} = current_sell_order} =
      @binance_client.get_order(
        symbol,
        timestamp,
        order_id
      )

    :ok = broadcast_order(current_sell_order)

    sell_order = %{sell_order | status: current_sell_order.status}

    new_state = %{state | sell_order: sell_order}
    @leader.notify(:trader_state_updated, new_state)
    {:noreply, new_state}
  end</code></pre>
<p>The first function takes care of terminating the trader. The second function is fetching the sell order.</p>
<p>That finishes our first refactoring round, but I need to admit that our change has impacted the behaviour of our strategy. Each time a buy or sell order gets filled, we will fetch that order from Binance, but we <strong>won’t</strong> immediately place a sell order nor terminate as it was happening before. Instead, only when another event arrives will the trader place a sell order or terminate.</p>
<p>Changes like this require approval from the business in a work situation, but it’s a good showcase of the situation where we can propose a solution that will simplify the code(the benefits will become evident in the following sections).</p>
<p>We can confirm that we have broken our tests by running our integration testsuite:</p>
<div class="sourceCode" id="cb385"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb385-1"><a href="functional-elixir.html#cb385-1" aria-hidden="true" tabindex="-1"></a><span class="va">MIX_ENV=</span>integration <span class="ex">mix</span> test.integration</span>
<span id="cb385-2"><a href="functional-elixir.html#cb385-2" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb385-3"><a href="functional-elixir.html#cb385-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">1</span><span class="er">)</span> <span class="bu">test</span> Naive trader full trade<span class="er">(</span><span class="ex">buy</span> + sell<span class="kw">)</span> <span class="bu">test</span> <span class="er">(</span><span class="ex">NaiveTest</span><span class="kw">)</span></span>
<span id="cb385-4"><a href="functional-elixir.html#cb385-4" aria-hidden="true" tabindex="-1"></a>     <span class="ex">apps/naive/test/naive_test.exs:12</span></span>
<span id="cb385-5"><a href="functional-elixir.html#cb385-5" aria-hidden="true" tabindex="-1"></a>     <span class="ex">**</span> <span class="er">(</span><span class="ex">MatchError</span><span class="kw">)</span> <span class="ex">no</span> match of right hand side value: [[<span class="st">&quot;0.43070000&quot;</span>, <span class="st">&quot;BUY&quot;</span>, <span class="st">&quot;FILLED&quot;</span>]...</span>
<span id="cb385-6"><a href="functional-elixir.html#cb385-6" aria-hidden="true" tabindex="-1"></a>     <span class="ex">code:</span> [buy_1, sell_1, buy_2] = DataWarehouse.Repo.all<span class="er">(</span><span class="ex">query</span><span class="kw">)</span></span>
<span id="cb385-7"><a href="functional-elixir.html#cb385-7" aria-hidden="true" tabindex="-1"></a>     <span class="ex">stacktrace:</span></span>
<span id="cb385-8"><a href="functional-elixir.html#cb385-8" aria-hidden="true" tabindex="-1"></a>       <span class="ex">test/naive_test.exs:83:</span> <span class="er">(</span><span class="bu">test</span><span class="kw">)</span></span></code></pre></div>
<p>(Subject to acceptance by the business) we will fix the integration test in the following way:</p>
<pre><code># /apps/naive/test/naive_test.exs
  test &quot;Naive trader full trade(buy + sell) test&quot; do
    ...
    # Step 4 - Broadcast 10 events # &lt;= updated comment
    [
       ...
      generate_event(8, &quot;0.43205&quot;, &quot;345.14235000&quot;),
      # this one should trigger buy order for a new trader process
      generate_event(9, &quot;0.43205&quot;, &quot;345.14235000&quot;), # &lt;= added line
      generate_event(10, &quot;0.43210&quot;, &quot;3201.86480000&quot;) # &lt;= updated id
    ]</code></pre>
<p>We added an event at the same price(as the sell order’s price) that will trigger placing a buy order by the new trader and make our test green again.</p>
<div style="page-break-after: always;"></div>
</div>
<div id="abstracting-the-pure-logic" class="section level2" number="18.4">
<h2><span class="header-section-number">18.4</span> Abstracting the “pure” logic</h2>
<p>In our adventure to make our code more functional, we should strive to separate(as much as possible) pure business logic from side effects and boilerplate.</p>
<p>The <code>Naive.Trader</code> module is a GenServer that receives trade events via messages. Based on them and the current state, using pattern-matching, it decides what action should be performed(place a buy order, fetch a buy order, place a sell order, fetch sell order, terminate trader, trigger rebuy or ignore event).</p>
<p>Each of the pattern-matches inside the callback functions’ headers is a <strong>strategy</strong> specific business logic that got mixed with the fact that it’s executed by a GenServer that receives messages.</p>
<p>We will create a new file called <code>strategy.exs</code> inside the <code>apps/naive/lib/naive/</code> directory, where we will <strong>copy</strong> all of the <code>handle_info/2</code> callback functions from the <code>Naive.Trader</code> module:</p>
<pre><code># /apps/naive/lib/naive/strategy.ex
defmodule Naive.Strategy do

  def handle_info(...) do
    ... # &lt;= place a buy order logic
  end

  def handle_info(...) do
    ... # &lt;= race condition fix logic
  end

  def handle_info(...) do
    ... # &lt;= place a sell order logic
  end

  def handle_info(...) do
    ... # &lt;= fetch the buy order logic
  end

  def handle_info(...) do
    ... # &lt;= terminate trader logic
  end

  def handle_info(...) do
    ... # &lt;= fetch the sell order logic
  end

  def handle_info(...) do
    ... # &lt;= trigger rebuy order logic
  end

  def handle_info(...) do
    ... # &lt;= ignore trade event logic
  end</code></pre>
<p>First, we will rename all of the <code>handle_info/2</code> functions inside the <code>Naive.Strategy</code> module to <code>generate_decision/2</code>. Next, we will go through them one by one, leaving the pure parts and limiting them to returning the decision.</p>
<div id="place-a-buy-order-rules" class="section level3" number="18.4.1">
<h3><span class="header-section-number">18.4.1</span> Place a buy order rules</h3>
<p>The first function decides should the trader place a buy order. We can see that price and quantity calculations are pure functions based on the incoming data. We will remove everything below those two as it’s causing side effects.</p>
<p>As now we are dealing with a function generating a decision, we will return a tuple with data that, together with state, will be used to place a buy order.</p>
<p>After removing some of the pattern-matching that we used to retrieve data(no longer needed), our first function should look like this:</p>
<pre><code># /apps/naive/lib/naive/strategy.ex
# the first clause
  def generate_decision(
        %TradeEvent{price: price},
        %State{
          budget: budget,
          buy_order: nil,
          buy_down_interval: buy_down_interval,
          tick_size: tick_size,
          step_size: step_size
        }
      ) do
    price = calculate_buy_price(price, buy_down_interval, tick_size)

    quantity = calculate_quantity(budget, price, step_size)

    {:place_buy_order, price, quantity}
  end</code></pre>
<div style="page-break-after: always;"></div>
</div>
<div id="race-condition-rules" class="section level3" number="18.4.2">
<h3><span class="header-section-number">18.4.2</span> Race condition rules</h3>
<p>The second function deals with the race condition when multiple transactions fill the buy order. The original callback ignores those trade events, so the <code>generate_decision/2</code> function should return the same “decision”:</p>
<pre><code># /apps/naive/lib/naive/strategy.ex
# the second clause
  def generate_decision(
        %TradeEvent{
          buyer_order_id: order_id
        },
        %State{
          buy_order: %Binance.OrderResponse{
            order_id: order_id,
            status: &quot;FILLED&quot;
          },
          sell_order: %Binance.OrderResponse{}
        }
      ) do
    :skip
  end</code></pre>
</div>
<div id="place-a-sell-order-rules" class="section level3" number="18.4.3">
<h3><span class="header-section-number">18.4.3</span> Place a sell order rules</h3>
<p>We will follow the same logic for the 3rd clause of the <code>generate_decision/2</code> function. We will leave only the sell price calculation as it’s pure and return a tuple together with the decision:</p>
<pre><code># /apps/naive/lib/naive/strategy.ex
# the third clause
  def generate_decision(
        %TradeEvent{},
        %State{
          buy_order: %Binance.OrderResponse{
            status: &quot;FILLED&quot;,
            price: buy_price
          },
          sell_order: nil,
          profit_interval: profit_interval,
          tick_size: tick_size
        }
      ) do
    sell_price = calculate_sell_price(buy_price, profit_interval, tick_size)
    {:place_sell_order, sell_price}
  end</code></pre>
</div>
<div id="fetch-the-buy-order-rules" class="section level3" number="18.4.4">
<h3><span class="header-section-number">18.4.4</span> Fetch the buy order rules</h3>
<p>For the 4th clause, we will return only an atom as there’s no pure logic besides the pattern-match in the header itself:</p>
<pre><code># /apps/naive/lib/naive/strategy.ex
# the fourth clause
  def generate_decision(
        %TradeEvent{
          buyer_order_id: order_id
        },
        %State{
          buy_order: %Binance.OrderResponse{
            order_id: order_id
          }
        }
      ) do
    :fetch_buy_order
  end</code></pre>
</div>
<div id="terminate-trader-rules" class="section level3" number="18.4.5">
<h3><span class="header-section-number">18.4.5</span> Terminate trader rules</h3>
<p>For the 5th clause, we will indicate that trader needs to terminate:</p>
<pre><code># /apps/naive/lib/naive/strategy.ex
# the fifth clause
  def generate_decision(
        %TradeEvent{},
        %State{
          sell_order: %Binance.OrderResponse{
            status: &quot;FILLED&quot;
          }
        }
      ) do
    :exit
  end</code></pre>
</div>
<div id="fetch-the-sell-order-rules" class="section level3" number="18.4.6">
<h3><span class="header-section-number">18.4.6</span> Fetch the sell order rules</h3>
<p>For the 6th clause, we will indicate that trader needs to fetch the sell order:</p>
<pre><code># /apps/naive/lib/naive/strategy.ex
# the sixth clause
  def generate_decision(
        %TradeEvent{
          seller_order_id: order_id
        },
        %State{
          sell_order: %Binance.OrderResponse{
            order_id: order_id
          }
        }
      ) do
    :fetch_sell_order
  end</code></pre>
</div>
<div id="trigger-rebuy-rules" class="section level3" number="18.4.7">
<h3><span class="header-section-number">18.4.7</span> Trigger rebuy rules</h3>
<p>Inside the 7th clause, we are dealing with triggering the rebuy. Here, we can decide whether rebuy should be triggered and get rid of conditional logic inside further steps. We couldn’t refactor this function by splitting it (as we’ve done in the first section) as we need to call the <code>trigger_rebuy?/3</code> function to check should rebuy be triggered. The functions that we refactored in the first section of this chapter were splittable as they relied on pattern-matching in the function headers where calling local functions is not allowed):</p>
<pre><code># /apps/naive/lib/naive/strategy.ex
# the seventh clause
  def generate_decision(
        %TradeEvent{
          price: current_price
        },
        %State{
          buy_order: %Binance.OrderResponse{
            price: buy_price
          },
          rebuy_interval: rebuy_interval,
          rebuy_notified: false
        }
      ) do
    if trigger_rebuy?(buy_price, current_price, rebuy_interval) do
      :rebuy
    else
      :skip
    end
  end</code></pre>
<div style="page-break-after: always;"></div>
</div>
<div id="the-final-clause-rules" class="section level3" number="18.4.8">
<h3><span class="header-section-number">18.4.8</span> The final clause rules</h3>
<p>The final (8th) clause will just ignore the trade event as it’s of no interest:</p>
<pre><code># /apps/naive/lib/naive/strategy.ex
# the final(8th) clause
  def generate_decision(%TradeEvent{}, %State{}) do
    :skip
  end</code></pre>
<p>This finishes the changes to the <code>generate_decision/2</code> clauses. We extracted a fair amount of logic into an easily testable pure function. We now need to use it inside the <code>Naive.Trader</code> module.</p>
</div>
<div id="changes-to-the-naive.trader-module" class="section level3" number="18.4.9">
<h3><span class="header-section-number">18.4.9</span> Changes to the <code>Naive.Trader</code> module</h3>
<p>We will start by moving all of the calculation functions to the <code>Naive.Strategy</code> module as we are using them from the <code>generate_decision/2</code> function. Those will be:</p>
<ul>
<li><code>calculate_sell_price/3</code></li>
<li><code>calculate_buy_price/3</code></li>
<li><code>calculate_quantity/3</code></li>
<li><code>trigger_rebuy?/3</code></li>
</ul>
<p>They can now be changed to public functions as they are pure and fit the “interface” of the <code>Naive.Strategy</code> module(it feels ok[and it’s safe as they are pure] to “expose” them to be called from other modules).</p>
<p>We need to remember about moving the <code>Decimal</code> alias into the <code>Naive.Strategy</code> module together with a copy of the <code>TradeEvent</code> struct alias and add the alias for the <code>Naive.Trader.State</code> struct:</p>
<pre><code># /apps/naive/lib/naive/strategy.ex
  alias Decimal, as: D
  alias Core.Struct.TradeEvent
  alias Naive.Trader.State</code></pre>
<p>The next step will be to rename all the <code>handle_info/2</code> callback functions inside the <code>Naive.Trader</code> module to <code>execute_decision/2</code>, which we will get back to in a moment.</p>
<p>First, we need to add a single <code>handle_info/2</code> callback under the <code>init/1</code> function that will pattern match only the fact that the received message contains the <code>TradeEvent</code> struct and the state is the correct <code>State</code> struct:</p>
<pre><code># /apps/naive/lib/naive/trader.ex
# add after the `init/1` function
  def handle_info(%TradeEvent{} = trade_event, %State{} = state) do
    Naive.Strategy.generate_decision(trade_event, state)
    |&gt; execute_decision(state)
  end</code></pre>
<p>So, the <code>Naive.Strategy</code> module will decide what the trader server should do based on its pure business logic. That decision will be passed forward with the state to the <code>execute_decision/2</code> function (at this moment, it’s just the old <code>handle_info/2</code> function renamed, but we will update it next).</p>
</div>
<div id="naive.trader---place-buy-order" class="section level3" number="18.4.10">
<h3><span class="header-section-number">18.4.10</span> <code>Naive.Trader</code> - place buy order</h3>
<p>We will update the <code>execute_decision/2</code> function to take a decision + state and execute the correct action based on pattern-match of the decision. Starting with the 1st clause, we need to pattern match a tuple:</p>
<pre><code># /apps/naive/lib/naive/trader.ex
# the first execute clause
  def execute_decision(
         {:place_buy_order, price, quantity},
         %State{
           id: id,
           symbol: symbol
         } = state
       ) do
    @logger.info(
      &quot;The trader(#{id}) is placing a BUY order &quot; &lt;&gt;
        &quot;for #{symbol} @ #{price}, quantity: #{quantity}&quot;
    )

    {:ok, %Binance.OrderResponse{} = order} =
      @binance_client.order_limit_buy(symbol, quantity, price, &quot;GTC&quot;)

    :ok = broadcast_order(order)

    new_state = %{state | buy_order: order}
    @leader.notify(:trader_state_updated, new_state)
    {:noreply, new_state}
  end</code></pre>
<p>The amount of pattern matching will be much smaller as part of the original callback has been moved inside the <code>Naive.Strategy</code>’s logic(to calculate the price and quantity).</p>
</div>
<div id="naive.trader---race-condition-clause" class="section level3" number="18.4.11">
<h3><span class="header-section-number">18.4.11</span> <code>Naive.Trader</code> - Race condition clause</h3>
<p>As we are using the <code>:skip</code> “decision” for both the race condition events and the “non interesting” events, we can safely remove this clause as we will implement skipping as the last clause.</p>
</div>
<div id="naive.trader---place-a-sell-order" class="section level3" number="18.4.12">
<h3><span class="header-section-number">18.4.12</span> <code>Naive.Trader</code> - Place a sell order</h3>
<p>In case of placing a sell order, we will pattern match on a tuple containing the <code>:place_sell_order</code> atom and slim down on pattern matching:</p>
<pre><code># /apps/naive/lib/naive/trader.ex
  def execute_decision(
         {:place_sell_order, sell_price},
         %State{
           id: id,
           symbol: symbol,
           buy_order: %Binance.OrderResponse{
             orig_qty: quantity
           }
         } = state
       ) do
    @logger.info(
      &quot;The trader(#{id}) is placing a SELL order for &quot; &lt;&gt;
        &quot;#{symbol} @ #{sell_price}, quantity: #{quantity}.&quot;
    )

    {:ok, %Binance.OrderResponse{} = order} =
      @binance_client.order_limit_sell(symbol, quantity, sell_price, &quot;GTC&quot;)

    :ok = broadcast_order(order)

    new_state = %{state | sell_order: order}
    @leader.notify(:trader_state_updated, new_state)
    {:noreply, new_state}
  end</code></pre>
</div>
<div id="naive.trader---fetch-the-buy-order" class="section level3" number="18.4.13">
<h3><span class="header-section-number">18.4.13</span> <code>Naive.Trader</code> - Fetch the buy order</h3>
<p>In case of fetching the buy order, we will pattern match on a <code>:fetch_buy_order</code> atom and slim down on pattern matching:</p>
<pre><code># /apps/naive/lib/naive/trader.ex
  def execute_decision(
         :fetch_buy_order,
         %State{
           id: id,
           symbol: symbol,
           buy_order:
             %Binance.OrderResponse{
               order_id: order_id,
               transact_time: timestamp
             } = buy_order
         } = state
       ) do
    @logger.info(&quot;Trader&#39;s(#{id} #{symbol} buy order got partially filled&quot;)

    {:ok, %Binance.Order{} = current_buy_order} =
      @binance_client.get_order(
        symbol,
        timestamp,
        order_id
      )

    :ok = broadcast_order(current_buy_order)

    buy_order = %{buy_order | status: current_buy_order.status}

    new_state = %{state | buy_order: buy_order}
    @leader.notify(:trader_state_updated, new_state)
    {:noreply, new_state}
  end</code></pre>
</div>
<div id="naive.trader---terminate-the-trader" class="section level3" number="18.4.14">
<h3><span class="header-section-number">18.4.14</span> <code>Naive.Trader</code> - Terminate the trader</h3>
<p>In case of terminating the trader, we will pattern match on a <code>:exit</code> atom and slim down on pattern matching:</p>
<pre><code># /apps/naive/lib/naive/trader.ex
  def execute_decision(
         :exit,
         %State{
           id: id,
           symbol: symbol
         } = state
       ) do
    @logger.info(&quot;Trader(#{id}) finished trade cycle for #{symbol}&quot;)
    {:stop, :normal, state}
  end</code></pre>
<div style="page-break-after: always;"></div>
</div>
<div id="naive.trader---fetch-the-sell-order" class="section level3" number="18.4.15">
<h3><span class="header-section-number">18.4.15</span> <code>Naive.Trader</code> - Fetch the sell order</h3>
<p>In case of fetching the sell order, we will pattern match on a <code>:fetch_sell_order</code> atom and slim down on pattern matching:</p>
<pre><code># /apps/naive/lib/naive/trader.ex
  def execute_decision(
         :fetch_sell_order,
         %State{
           id: id,
           symbol: symbol,
           sell_order:
             %Binance.OrderResponse{
               order_id: order_id,
               transact_time: timestamp
             } = sell_order
         } = state
       ) do
    @logger.info(&quot;Trader&#39;s(#{id} #{symbol} SELL order got partially filled&quot;)

    {:ok, %Binance.Order{} = current_sell_order} =
      @binance_client.get_order(
        symbol,
        timestamp,
        order_id
      )

    :ok = broadcast_order(current_sell_order)

    sell_order = %{sell_order | status: current_sell_order.status}

    new_state = %{state | sell_order: sell_order}
    @leader.notify(:trader_state_updated, new_state)
    {:noreply, new_state}
  end</code></pre>
</div>
<div id="naive.trader---triggering-rebuy" class="section level3" number="18.4.16">
<h3><span class="header-section-number">18.4.16</span> <code>Naive.Trader</code> - Triggering rebuy</h3>
<p>In case of triggering the rebuy procedure, we will pattern match on a <code>:rebuy</code> atom, slim down on pattern matching and simplify the function a fair bit(no branching required anymore - yay!):</p>
<pre><code># /apps/naive/lib/naive/trader.ex
  def execute_decision(
         :rebuy,
         %State{
           id: id,
           symbol: symbol
         } = state
       ) do
    @logger.info(&quot;Rebuy triggered for #{symbol} by the trader(#{id})&quot;)
    new_state = %{state | rebuy_notified: true}
    @leader.notify(:rebuy_triggered, new_state)
    {:noreply, new_state}
  end</code></pre>
</div>
<div id="naive.trader---the-final-ignore-clause" class="section level3" number="18.4.17">
<h3><span class="header-section-number">18.4.17</span> <code>Naive.Trader</code> - The final ignore clause</h3>
<p>The final ignore clause will <code>:skip</code> all events:</p>
<pre><code># /apps/naive/lib/naive/trader.ex
  def execute_decision(:skip, state) do
    {:noreply, state}
  end</code></pre>
<p>The ignore clause finishes our current refactoring round, which showcased that sometimes abstracting pattern matching into a separate function is a valid strategy to increase the amount of pure code.</p>
<p>Note: The fact that we could abstract the logic from pattern matches is quite a unique situation to our application. I would not advise abstracting GenServer pattern matching into a separate module if dealing with different structs/actions(in our case, all our pattern matches were “making a trading decision”, it’s a single “action”, that’s why we abstracted them).</p>
</div>
</div>
<div id="dealing-with-dirty-code" class="section level2" number="18.5">
<h2><span class="header-section-number">18.5</span> Dealing with dirty code</h2>
<p>In the last section, we’ve split the <code>handle_info/2</code> clauses into the <code>generate_decision/2</code> and <code>execute_decision/2</code> functions. That’s excellent progress, but we still have the strategy logic inside the <code>Naive.Trader</code> module.</p>
<p>Let’s move the <code>execute_decision/2</code> function(together with all the code that it depends on, like the <code>broadcast_order/1</code> and <code>convert_to_order/1</code> functions as well as a copy of the <code>require Logger</code>) from the <code>Naive.Trader</code> module to the <code>Naive.Strategy</code> module.</p>
<p>As the <code>generate_decision/2</code> function is causing side effects, we don’t want it to be called directly from the outside of the module, so we will need to make it private.</p>
<p>Changing the <code>execute_decision/2</code> function(now inside the <code>Naive.Strategy</code> module) to private will cause a problem with the <code>handle_info/2</code> callback function inside the <code>Naive.Trader</code> module as it relies on the <code>execute_decision/2</code> function to be public. The fact that our strategy makes a decision and then executes code based on it is an implementation detail that we shouldn’t share with the <code>Naive.Trader</code> module. That’s why we will move the <strong>body</strong> of the <code>handle_info/2</code> callback function into a new function called <code>execute/2</code> inside the <code>Naive.Strategy</code> module:</p>
<pre><code># /apps/naive/lib/naive/strategy.ex
  def execute(%TradeEvent{} = trade_event, %State{} = state) do
    generate_decision(trade_event, state)
    |&gt; execute_decision(state)
  end</code></pre>
<p>Before updating the <code>Naive.Trader</code> module to use the <code>execute/2</code> function, we need to address another issue that moving the <code>execute_decision/2</code> caused. At this moment, all of the clauses return GenServer specific tuples. What we really need to return to the trader is an atom indicating should it continue or terminate together with the updated state:</p>
<pre><code># /apps/naive/lib/naive/strategy.ex
# last lines inside the `execute_decision/2` clauses
{:ok, new_state} # &lt;= previously {:noreply, new_state} (5 times)
{:ok, state} # &lt;= previously {:noreply, state} (once)
:exit # &lt;= previously {:stop, :normal, state} + remove `state` pattern match (once)</code></pre>
<p>We can now update the <code>handle_info/2</code> callback function to call the new “interface” of the <code>Naive.Strategy</code> module that we just created and act accordingly to the result:</p>
<pre><code># /apps/naive/lib/naive/trader.ex
  def handle_info(%TradeEvent{} = trade_event, %State{} = state) do
    case Naive.Strategy.execute(trade_event, state) do
      {:ok, new_state} -&gt; {:noreply, new_state}
      :exit -&gt; {:stop, :normal, state}
    end
  end</code></pre>
<p>At this moment, we could just copy/move module attributes from the <code>Naive.Trader</code> module to the <code>Naive.Strategy</code> module and our code would start to work again. Still, before we will do that, we will use this opportunity to look into how to make our dirty code testable.</p>
</div>
<div id="making-dirty-code-testable" class="section level2" number="18.6">
<h2><span class="header-section-number">18.6</span> Making dirty code testable</h2>
<p>Making dirty code testable is very closely linked to injecting dependencies. In the testing environment, we would like to use dummy implementations instead of executing the side-effect-causing code to simplify the tests. We will look into the different ways that we can pass side-effect-causing “code” into impure functions.</p>
<div id="passing-functions-arguments" class="section level3" number="18.6.1">
<h3><span class="header-section-number">18.6.1</span> Passing functions arguments</h3>
<p>Functions are first-class citizens in Elixir, which means that we can pass them as arguments to functions. This way, we can pass side-effect causing functions into our <code>Naive.Strategy</code> module.</p>
<p>Let’s look at how this would look in practice. We need to look into the <code>execute_decision/2</code> function, as it’s where the place side effects happen. Looking at the 1st clause(responsible for placing a buy order), we can see that it’s calling the <code>Logger.info/1</code>, <code>Binance.order_limit_buy/4</code>, <code>PubSub.broadcast/3</code>(via the <code>broadcast_order/1</code> function) and <code>Leader.notify/2</code> functions. To make our code easily testable, we would need to be able to pass dummy implementations for all of those.</p>
<p>As we aren’t calling the <code>execute_decision/2</code> directly, we need to pass all of the above functions as arguments to the <code>execute/2</code> function, which will pass them onward to the <code>execute_decision/2</code>.</p>
<p>We can see that even with default values pointing to the “real” implementation, that’s still <strong>a lot</strong> of noise to make testing easier. It will negatively impact the maintenance of the code - here’s an example of what this would look like(don’t bother typing it):</p>
<pre><code># /apps/naive/lib/naive/strategy.ex
# injecting dummy implementation, fallback to real implementation
def execute(
  %TradeEvent{} = trade_event,
  %State{} = state,
  logger_info \\ &amp;Logger.info/1, # &lt;= function injected
  order_limit_buy \\ &amp;Binance.order_limit_buy/4, # &lt;= function injected
  pubsub_broadcast \\ &amp;PubSub.broadcast/3, # &lt;= function injected
  notify_leader \\ &amp;Leader.notify/2 # &lt;= function injected
) do
  ...</code></pre>
<p>There are already four functions, and we only took care of side-effects causing functions from the first <code>execute_decision/2</code> clause. We can easily see how this very quickly becomes just unmanageable as there would be 10+ “injected” arguments going from the <code>execute/2</code> to <code>execute_decision/2</code>, and only some of them would be used in each clause.</p>
<p>Additional downsides:</p>
<ul>
<li>when passing a function as an argument, we need to specify the arity, so when we would like to use more than one arity, we need to pass the function <strong>multiple times with different arities</strong>. An example could be passing <code>Logger.info/1</code> and <code>Logger.info/2</code></li>
<li>we need to give a name to every passed function, sometimes multiple arities (again, how should variables for <code>Logger.info/1</code> and <code>Logger.info/2</code> be called? <code>logger_info_2</code>?)</li>
<li>share amount of arguments negatively impacts code readability</li>
</ul>
<p>We can see that passing functions as arguments is just a bad idea in case of making our code testable. It will have the opposite effect, decreasing readability making our code difficult to maintain and follow.</p>
<p>Important note: Passing functions as arguments is not always bad! A good example could be when different actions need to be performed based on runtime data.</p>
<div style="page-break-after: always;"></div>
</div>
<div id="passing-grouped-functions-as-a-context" class="section level3" number="18.6.2">
<h3><span class="header-section-number">18.6.2</span> Passing grouped functions as a context</h3>
<p>The natural next step would be to put all of those functions into some structure like Map or Keyword list. Whichever we would choose, we will end up with the same problems of naming keys(this time inside the map/keyword list), multiple functions because of different arity but also default values inside each clause of the <code>execute_decision/2</code> function:</p>
<pre><code># /apps/naive/lib/naive/strategy.ex
  defp execute_decision(
        {:place_buy_order, price, quantity},
        %State{
          id: id,
          symbol: symbol
        } = state,
        %{} = context # &lt;= context added
      ) do
    # vvv fetch from context vvv
    logger_info = Map.get(context, :logger_info, &amp;Logger.info/1)
    order_limit_buy = Map.get(context, :order_limit_buy, &amp;Binance.order_limit_buy/4)
    leader_notify = Map.get(context, :leader_notify, &amp;Leader.notify/2)</code></pre>
<p>Again this looks like a bad idea. It’s probably marginally better than just sending functions one by one, but not much.</p>
</div>
<div id="passing-grouped-modules-as-a-context" class="section level3" number="18.6.3">
<h3><span class="header-section-number">18.6.3</span> Passing grouped modules as a context</h3>
<p>The significant advantage of passing modules as arguments instead of functions is that we no longer have a problem with naming keys or caring about different functions’ arities. There will also be substantially fewer modules used in comparison to functions.</p>
<p>Sadly we still need to use the <code>Map</code> function to get the modules out of <code>"context"</code>:</p>
<pre><code># /apps/naive/lib/naive/strategy.ex
  defp execute_decision(
        {:place_buy_order, price, quantity},
        %State{
          id: id,
          symbol: symbol
        } = state,
        %{} = context # &lt;= context added
      ) do
    logger = Map.get(context, :logger, &amp;Logger) # &lt;= fetch from context
    binance = Map.get(context, :binance, Binance) # &lt;= fetch from context
    leader = Map.get(context, :leader, &amp;Leader) # &lt;= fetch from context</code></pre>
<p>This is much better, but we will still need to do a fair amount of additional work to get the modules out. Also, our code will be full of the “default” modules(as <strong>each</strong> of the clauses retrieving them from the context will need to specify defaults).</p>
</div>
<div id="injecting-modules-to-modules-attributes-based-on-the-configuration" class="section level3" number="18.6.4">
<h3><span class="header-section-number">18.6.4</span> Injecting modules to module’s attributes based on the configuration</h3>
<p>And we finally got there - we have come a full circle. This is the approach that we previously used inside the <code>Naive.Trader</code> module(you can go ahead and add them to the <code>Naive.Strategy</code> module):</p>
<pre><code># /apps/naive/lib/naive/strategy.ex
defmodule Naive.Strategy do
  ...

  @binance_client Application.compile_env(:naive, :binance_client)
  @leader Application.compile_env(:naive, :leader)
  @logger Application.compile_env(:core, :logger)
  @pubsub_client Application.compile_env(:core, :pubsub_client)</code></pre>
<p>We looked into different ways to inject dependencies to understand their downsides.</p>
<p>Sometimes, injecting values(like modules) as module attributes can feel like a “global state”, “singleton”, or similar antipattern. We need to understand that each programming language provides different ways to solve common programming problems. Dependency injection is one of those common concerns that every language needs to solve, and Elixir solves it by using compile-time modules’ attributes.</p>
<p>As long as you are using module attributes to be able to inject compile-time dependencies to test your code, there’s just <strong>no better way</strong> to do it in Elixir, and now we know why(based on the issues with the alternative approaches).</p>
<p>Together with the module attributes, our code should be now fully functional.</p>
</div>
</div>
<div id="the-power-with-in" class="section level2" number="18.7">
<h2><span class="header-section-number">18.7</span> The power <code>with</code>-in</h2>
<p>In the last section, we looked into different ways to inject modules’ dependencies to avoid side-effects causing functions inside the tests. Besides side-effect causing functions, in functional programming, error handling is also done in a specific manner.</p>
<p>Many languages introduced concepts like <code>Either</code>, which is a struct that can be either <code>Left</code>(error result) or <code>Right</code>(success result). Those quite nicely fit to the standard Elixir results like <code>{:error, reason}</code> and <code>{:ok, result}</code>. Further, those languages provide multiple functions to work with the <code>Either</code>, like <code>map</code>.</p>
<pre><code>safeDivide(2, 0) # &lt;= returns Left(&quot;Dividing error&quot;)
|&gt; then(Either.map(&amp;(&amp;1 * 2))) # &lt;= still Left(&quot;Dividing error&quot;)

safeDivide(2, 1) # &lt;= returns Right(2)
|&gt; then(Either.map(&amp;(&amp;1 * 2))) # &lt;= returns Right(4)</code></pre>
<p>The above code will use hypothetical <code>Left('Dividing error')</code> or <code>Right(result)</code>. The <code>Either.map/2</code> is a special <code>map</code> function that runs the passed function if it’s <code>Right</code> or completely ignores it when it’s <code>Left</code> - it could be visualized as:</p>
<pre><code>def map(%Either.Left{} = left, _fun), do: left
def map(%Either.Right{result: v}, fun), do: %Either.Right{result: fun.(v)}</code></pre>
<p>This is nice and great, but what if the function inside the <code>Either.map/2</code> returns another <code>Either</code>? Like:</p>
<pre><code>safeDivide(2, 1) # &lt;= returns Right(2)
|&gt; then(Either.map(&amp;(safeDivide(&amp;1, 1)))) # &lt;= now Right(Right(2))!?</code></pre>
<p>Now we need to understand those abstractions to be able to decide should we <code>map</code> or <code>flatMap</code>(that’s the function that will not wrap the function result into the <code>Right</code>):</p>
<pre><code>safeDivide(2, 1) # &lt;= returns Right(2)
|&gt; then(Either.flatMap(&amp;(safeDivide(&amp;1, 1)))) &lt;= still Right(2)</code></pre>
<p>And that is just the beginning of the complexities that those abstractions bring.</p>
<p>Furthermore, let’s say that inside the first <code>Either.map/2</code> callback, we will have some variable(s) that we would like to use later on. We are now deep inside closures world like the following:</p>
<pre><code>safeDivide(2, 1) # &lt;= returns Right(2)
|&gt; then(Either.flatMap(fn res -&gt;
    # x = some data generated here
    safeDivide(2, 1)
    |&gt; then(Either.map(&amp;(&amp;1 * 2)))
    |&gt; then(Either.map(&amp;(&amp;1 * x))) # &lt;= a clause to have access to x
  end))</code></pre>
<p>The above example is obviously simplified and silly but should give us a gist of what sort of complexity we will very soon get involved in. And, again, we just scratched the surface - there are so many more functions that the <code>Either</code> provides. Besides, writing code in this fashion in Elixir would cause a lot of friction in the team as it’s difficult to find any advantages of using it.</p>
<div id="idiomatic-error-handling" class="section level3" number="18.7.1">
<h3><span class="header-section-number">18.7.1</span> Idiomatic error handling</h3>
<p>To achieve the same results, Elixir provides the <code>with</code> statement:</p>
<pre><code>  with {:ok, divide_result} &lt;- safeDiv(2,1),
       {:ok, divide_result_2} &lt;- safeDivide(2, 1)
  do
    divide_result_2 * 2 * divide_result
  else
    err -&gt; err
  end</code></pre>
<p>The above code provides <strong>the same</strong> functionality as the one before with <code>Either</code>. We can clearly understand it <strong>without</strong> any knowledge about how <code>Either</code> works, <code>mapping</code>, <code>flatMapping</code> etc. It’s just standard Elixir.</p>
<p>Again, as in the case of modules’ attributes. Elixir provides a pragmatic way of dealing with errors - just return a tuple with an <code>:error</code> atom. It also provides utility functions like <code>with</code> to deal with errors in an idiomatic way. There’s <strong>no reason</strong> to introduce concepts like <code>Either</code> as language has built-in concepts/patterns taking care of error situations.</p>
</div>
</div>
<div id="do-or-not-to-do" class="section level2" number="18.8">
<h2><span class="header-section-number">18.8</span> Do or not to do</h2>
<p>In the last section, we discussed wrapping the results in the <code>Either</code> structs to be able to map, flatMap on them regardless of the function result. What if we could apply the same principle to avoid executing any code(side effects) at all?</p>
<p>That’s the basic idea behind all the category theory related abstractions like the infamous IO Monad.</p>
<p>I won’t go into a vast amount of details. Still, we can think about it as every time we are calling a <em>special</em> <code>map</code> or <code>flatMap</code>, instead of executing anything, it would just wrap whatever was passed to it inside another function and return it like:</p>
<pre><code>  def map(acc, function) do
    fn -&gt;
      case acc.() do
        {:ok, data} -&gt; {:ok, function.(data)}
        {:error, error} -&gt; {:error, error}
      end
    end
  end</code></pre>
<p>In a nutshell, what we would end up with is a function containing a function containing a function… At this moment, I find it very difficult to find any practical reason why somebody would want to do something like this in a dynamically typed language.</p>
<p>In statically typed languages, there’s an argument that instead of a function of function etc., we could have a typed object which would indicate what actions can be performed on that future result. This is very often praised as a compile-time guarantee of side effectfull code.</p>
<p>In the Elixir, without strong typing and with a massive impact on how the code is written and how easy it is to understand, there’s just <strong>no practical</strong> reason to use those concepts beyond toy programs. The resulting function would be an untestable blob without introspection support from the BEAM VM.</p>
<div style="page-break-after: always;"></div>
</div>
<div id="final-thoughts" class="section level2" number="18.9">
<h2><span class="header-section-number">18.9</span> Final thoughts</h2>
<p>Every programming language needs to provide tools to handle common concerns like error handling or dependency injection.</p>
<p>Elixir provides excellent tools to handle both of those concerns using the <code>with</code> statement and modules’ attributes.</p>
<p>Without a type system, there’s no practical reason why anybody would introduce category theory-based abstractions like Monads. The resulting code will be complicated to deal with, and as in the case of many other <strong>functional</strong> programming languages like Ocaml or Clojure, the pragmatic way is to execute side effects.</p>
<p><strong>It’s the developers’ responsibility to design code in a way that maximizes the amount of pure code and push side effects to “the edge”.</strong> The typical pattern would be to “prepare” (group all logic before side effects) or to “post process” the results of multiple side effects (group pure logic after side effects).</p>
<p>That’s all in regards to functional programming in Elixir. In the next chapter, we will look into what the idiomatic Elixir code looks like.</p>
<p>[Note] Please remember to run the <code>mix format</code> to keep things nice and tidy.</p>
<p>Source code for this chapter can be found at <a href="https://github.com/Cinderella-Man/hands-on-elixir-and-otp-cryptocurrency-trading-bot-source-code/tree/chapter_18">Github</a></p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="mox-rocks.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="idiomatic-otp.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/Cinderella-Man/hands-on-elixir-and-otp-cryptocurrency-trading-bot/edit/main/18-functional-elixir.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
