<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 19 Idiomatic OTP | Hands-on Elixir &amp; OTP: Cryptocurrency trading bot</title>
  <meta name="description" content="Chapter 19 Idiomatic OTP | Hands-on Elixir &amp; OTP: Cryptocurrency trading bot" />
  <meta name="generator" content="bookdown 0.32 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 19 Idiomatic OTP | Hands-on Elixir &amp; OTP: Cryptocurrency trading bot" />
  <meta property="og:type" content="book" />
  
  
  <meta name="github-repo" content="Cinderella-Man/hands-on-elixir-and-otp-cryptocurrency-trading-bot" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 19 Idiomatic OTP | Hands-on Elixir &amp; OTP: Cryptocurrency trading bot" />
  <meta name="twitter:site" content="@kamilskowron" />
  
  

<meta name="author" content="Kamil Skowron" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="functional-elixir.html"/>
<link rel="next" href="idiomatic-trading-strategy.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-52FKGBX2B8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-52FKGBX2B8');
</script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Hands-on Elixir & OTP: Cryptocurrency trading bot</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#want-to-learn-elixir-otp-by-creating-a-real-world-project"><i class="fa fa-check"></i>Want to learn Elixir &amp; OTP by creating a real-world project?</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#limit-of-liabilitydisclaimer-of-warranty"><i class="fa fa-check"></i>Limit of Liability/Disclaimer of Warranty</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#pdf-epub"><i class="fa fa-check"></i>PDF &amp; EPUB</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#preface-1"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#who-this-book-is-for"><i class="fa fa-check"></i>Who this book is for</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#what-this-book-covers"><i class="fa fa-check"></i>What this book covers</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#contributing-errata-and-source-code"><i class="fa fa-check"></i>Contributing, Errata and Source code</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><i class="fa fa-check"></i><b>1</b> Stream live cryptocurrency prices from the Binance WSS</a>
<ul>
<li class="chapter" data-level="1.1" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html#objectives"><i class="fa fa-check"></i><b>1.1</b> Objectives</a></li>
<li class="chapter" data-level="1.2" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html#create-a-new-umbrella-app"><i class="fa fa-check"></i><b>1.2</b> Create a new umbrella app</a></li>
<li class="chapter" data-level="1.3" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html#create-a-supervised-application-inside-an-umbrella"><i class="fa fa-check"></i><b>1.3</b> Create a supervised application inside an umbrella</a></li>
<li class="chapter" data-level="1.4" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html#connect-to-binances-websocket-stream-using-the-websockex-module"><i class="fa fa-check"></i><b>1.4</b> Connect to Binance’s WebSocket Stream using the WebSockex module</a></li>
<li class="chapter" data-level="1.5" data-path="stream-live-cryptocurrency-prices-from-the-binance-wss.html"><a href="stream-live-cryptocurrency-prices-from-the-binance-wss.html#decode-incoming-events-using-the-jason-module"><i class="fa fa-check"></i><b>1.5</b> Decode incoming events using the Jason module</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><i class="fa fa-check"></i><b>2</b> Create a naive trading strategy - a single trader process without supervision</a>
<ul>
<li class="chapter" data-level="2.1" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#objectives-1"><i class="fa fa-check"></i><b>2.1</b> Objectives</a></li>
<li class="chapter" data-level="2.2" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#initialisation"><i class="fa fa-check"></i><b>2.2</b> Initialisation</a></li>
<li class="chapter" data-level="2.3" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#how-trading-strategy-will-work"><i class="fa fa-check"></i><b>2.3</b> How trading strategy will work?</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#implementation-of-the-first-scenario"><i class="fa fa-check"></i><b>2.3.1</b> Implementation of the first scenario</a></li>
<li class="chapter" data-level="2.3.2" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#implementation-of-the-second-scenario"><i class="fa fa-check"></i><b>2.3.2</b> Implementation of the second scenario</a></li>
<li class="chapter" data-level="2.3.3" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#implementation-of-the-third-scenario"><i class="fa fa-check"></i><b>2.3.3</b> Implementation of the third scenario</a></li>
<li class="chapter" data-level="2.3.4" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#implementation-fallback-scenario"><i class="fa fa-check"></i><b>2.3.4</b> Implementation fallback scenario</a></li>
<li class="chapter" data-level="2.3.5" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#updating-the-naive-interface"><i class="fa fa-check"></i><b>2.3.5</b> Updating the Naive interface</a></li>
<li class="chapter" data-level="2.3.6" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#updating-streamer-app"><i class="fa fa-check"></i><b>2.3.6</b> Updating streamer app</a></li>
<li class="chapter" data-level="2.3.7" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#access-details-to-binance"><i class="fa fa-check"></i><b>2.3.7</b> Access details to Binance</a></li>
<li class="chapter" data-level="2.3.8" data-path="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy---a-single-trader-process-without-supervision.html#test-run"><i class="fa fa-check"></i><b>2.3.8</b> Test run</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html"><i class="fa fa-check"></i><b>3</b> Introduce PubSub as a communication method</a>
<ul>
<li class="chapter" data-level="3.1" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html#objectives-2"><i class="fa fa-check"></i><b>3.1</b> Objectives</a></li>
<li class="chapter" data-level="3.2" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html#design"><i class="fa fa-check"></i><b>3.2</b> Design</a></li>
<li class="chapter" data-level="3.3" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html#implementation"><i class="fa fa-check"></i><b>3.3</b> Implementation</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html"><i class="fa fa-check"></i><b>4</b> Mock the Binance API</a>
<ul>
<li class="chapter" data-level="4.1" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#objectives-3"><i class="fa fa-check"></i><b>4.1</b> Objectives</a></li>
<li class="chapter" data-level="4.2" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#design-1"><i class="fa fa-check"></i><b>4.2</b> Design</a></li>
<li class="chapter" data-level="4.3" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#create-binancemock-app"><i class="fa fa-check"></i><b>4.3</b> Create “BinanceMock” app</a></li>
<li class="chapter" data-level="4.4" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-getting-exchange-info"><i class="fa fa-check"></i><b>4.4</b> Implement getting exchange info</a></li>
<li class="chapter" data-level="4.5" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-placing-buy-and-sell-orders"><i class="fa fa-check"></i><b>4.5</b> Implement placing buy and sell orders</a></li>
<li class="chapter" data-level="4.6" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-order-retrival"><i class="fa fa-check"></i><b>4.6</b> Implement order retrival</a></li>
<li class="chapter" data-level="4.7" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-callback-for-incoming-trade-events"><i class="fa fa-check"></i><b>4.7</b> Implement callback for incoming trade events</a></li>
<li class="chapter" data-level="4.8" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#upgrade-trader-and-config"><i class="fa fa-check"></i><b>4.8</b> Upgrade trader and config</a></li>
<li class="chapter" data-level="4.9" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#test-the-implementation"><i class="fa fa-check"></i><b>4.9</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html"><i class="fa fa-check"></i><b>5</b> Enable parallel trading on multiple symbols</a>
<ul>
<li class="chapter" data-level="5.1" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#objectives-4"><i class="fa fa-check"></i><b>5.1</b> Objectives</a></li>
<li class="chapter" data-level="5.2" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#introduction---architectural-design"><i class="fa fa-check"></i><b>5.2</b> Introduction - architectural design</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#update-application-supervisor"><i class="fa fa-check"></i><b>5.2.1</b> Update application supervisor</a></li>
<li class="chapter" data-level="5.2.2" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#add-interface-method"><i class="fa fa-check"></i><b>5.2.2</b> Add interface method</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#implement-naive.symbolsupervisor"><i class="fa fa-check"></i><b>5.3</b> Implement <code>Naive.SymbolSupervisor</code></a></li>
<li class="chapter" data-level="5.4" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#implement-naive.leader"><i class="fa fa-check"></i><b>5.4</b> Implement <code>Naive.Leader</code></a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#updating-the-leader-module"><i class="fa fa-check"></i><b>5.4.1</b> Updating the <code>leader</code> module</a></li>
<li class="chapter" data-level="5.4.2" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#updating-the-naive.trader-module"><i class="fa fa-check"></i><b>5.4.2</b> Updating the <code>Naive.Trader</code> module</a></li>
<li class="chapter" data-level="5.4.3" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#finalizing-naive.leader-implementation"><i class="fa fa-check"></i><b>5.4.3</b> Finalizing <code>Naive.Leader</code> implementation</a></li>
<li class="chapter" data-level="5.4.4" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#iex-testing"><i class="fa fa-check"></i><b>5.4.4</b> IEx testing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html"><i class="fa fa-check"></i><b>6</b> Introduce a <code>buy_down_interval</code> to make a single trader more profitable</a>
<ul>
<li class="chapter" data-level="6.1" data-path="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html#objectives-5"><i class="fa fa-check"></i><b>6.1</b> Objectives</a></li>
<li class="chapter" data-level="6.2" data-path="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html#why-we-need-to-buy-below-the-current-price-feature-overview"><i class="fa fa-check"></i><b>6.2</b> Why we need to buy below the current price? Feature overview</a></li>
<li class="chapter" data-level="6.3" data-path="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html#naive.trader-implementation"><i class="fa fa-check"></i><b>6.3</b> <code>Naive.Trader</code> implementation</a></li>
<li class="chapter" data-level="6.4" data-path="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html#naive.leader-implementation"><i class="fa fa-check"></i><b>6.4</b> <code>Naive.Leader</code> implementation</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html"><a href="introduce-a-buy_down_interval-to-make-a-single-trader-more-profitable.html#iex-testing-1"><i class="fa fa-check"></i><b>6.4.1</b> IEx testing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html"><i class="fa fa-check"></i><b>7</b> Introduce a trader budget and calculating the quantity</a>
<ul>
<li class="chapter" data-level="7.1" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#objectives-6"><i class="fa fa-check"></i><b>7.1</b> Objectives</a></li>
<li class="chapter" data-level="7.2" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#fetch-step_size"><i class="fa fa-check"></i><b>7.2</b> Fetch <code>step_size</code></a></li>
<li class="chapter" data-level="7.3" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#append-budget-and-step_size-to-the-traders-state-inside-the-leader"><i class="fa fa-check"></i><b>7.3</b> Append <code>budget</code> and <code>step_size</code> to the <code>Trader</code>’s state inside the <code>Leader</code></a></li>
<li class="chapter" data-level="7.4" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#append-budget-and-step_size-to-the-traders-state"><i class="fa fa-check"></i><b>7.4</b> Append <code>budget</code> and <code>step_size</code> to the <code>Trader</code>’s state</a></li>
<li class="chapter" data-level="7.5" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#calculate-quantity"><i class="fa fa-check"></i><b>7.5</b> Calculate quantity</a>
<ul>
<li class="chapter" data-level="7.5.1" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#iex-testing-2"><i class="fa fa-check"></i><b>7.5.1</b> IEx testing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html"><i class="fa fa-check"></i><b>8</b> Add support for multiple transactions per order</a>
<ul>
<li class="chapter" data-level="8.1" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#objectives-7"><i class="fa fa-check"></i><b>8.1</b> Objectives</a></li>
<li class="chapter" data-level="8.2" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#the-issue-with-the-current-implementation"><i class="fa fa-check"></i><b>8.2</b> The issue with the current implementation</a></li>
<li class="chapter" data-level="8.3" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#improve-buy-order-filled-callback"><i class="fa fa-check"></i><b>8.3</b> Improve buy order filled callback</a></li>
<li class="chapter" data-level="8.4" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#implement-buy-order-filled-callback"><i class="fa fa-check"></i><b>8.4</b> Implement buy order “filled” callback</a></li>
<li class="chapter" data-level="8.5" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#improve-sell-order-callback"><i class="fa fa-check"></i><b>8.5</b> Improve sell order callback</a></li>
<li class="chapter" data-level="8.6" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#test-the-implementation-1"><i class="fa fa-check"></i><b>8.6</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html"><i class="fa fa-check"></i><b>9</b> Run multiple traders in parallel</a>
<ul>
<li class="chapter" data-level="9.1" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#objectives-8"><i class="fa fa-check"></i><b>9.1</b> Objectives</a></li>
<li class="chapter" data-level="9.2" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#describe-and-design-the-required-functionality"><i class="fa fa-check"></i><b>9.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="9.3" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#implement-rebuy-inside-naive.trader"><i class="fa fa-check"></i><b>9.3</b> Implement rebuy inside <code>Naive.Trader</code></a></li>
<li class="chapter" data-level="9.4" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#implement-rebuy-in-the-naive.leader"><i class="fa fa-check"></i><b>9.4</b> Implement rebuy in the <code>Naive.Leader</code></a></li>
<li class="chapter" data-level="9.5" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#improve-logs-by-assigning-ids-to-traders"><i class="fa fa-check"></i><b>9.5</b> Improve logs by assigning ids to traders</a></li>
<li class="chapter" data-level="9.6" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#test-the-implementation-2"><i class="fa fa-check"></i><b>9.6</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html"><i class="fa fa-check"></i><b>10</b> Fine-tune trading strategy per symbol</a>
<ul>
<li class="chapter" data-level="10.1" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#objectives-9"><i class="fa fa-check"></i><b>10.1</b> Objectives</a></li>
<li class="chapter" data-level="10.2" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#describe-and-design-the-required-functionality-1"><i class="fa fa-check"></i><b>10.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="10.3" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#add-docker-to-project"><i class="fa fa-check"></i><b>10.3</b> Add docker to project</a></li>
<li class="chapter" data-level="10.4" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#set-up-ecto-inside-the-naive-app"><i class="fa fa-check"></i><b>10.4</b> Set up <code>ecto</code> inside the <code>naive</code> app</a></li>
<li class="chapter" data-level="10.5" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#create-and-migrate-the-db"><i class="fa fa-check"></i><b>10.5</b> Create and migrate the DB</a></li>
<li class="chapter" data-level="10.6" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#seed-symbols-settings"><i class="fa fa-check"></i><b>10.6</b> Seed symbols’ settings</a></li>
<li class="chapter" data-level="10.7" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#update-the-naive.leader-to-fetch-settings"><i class="fa fa-check"></i><b>10.7</b> Update the <code>Naive.Leader</code> to fetch settings</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html"><i class="fa fa-check"></i><b>11</b> Supervise and autostart streaming</a>
<ul>
<li class="chapter" data-level="11.1" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#objectives-10"><i class="fa fa-check"></i><b>11.1</b> Objectives</a></li>
<li class="chapter" data-level="11.2" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#describe-and-design-the-required-functionality-2"><i class="fa fa-check"></i><b>11.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="11.3" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#register-the-streamer.binance-processes-with-names"><i class="fa fa-check"></i><b>11.3</b> Register the <code>Streamer.Binance</code> processes with names</a></li>
<li class="chapter" data-level="11.4" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#set-up-ecto-inside-the-streamer-app"><i class="fa fa-check"></i><b>11.4</b> Set up <code>ecto</code> inside the <code>streamer</code> app</a></li>
<li class="chapter" data-level="11.5" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#create-and-migrate-the-db-1"><i class="fa fa-check"></i><b>11.5</b> Create and migrate the db</a></li>
<li class="chapter" data-level="11.6" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#seed-default-settings"><i class="fa fa-check"></i><b>11.6</b> Seed default settings</a></li>
<li class="chapter" data-level="11.7" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#implement-the-supervision-tree-and-start-streaming-functionality"><i class="fa fa-check"></i><b>11.7</b> Implement the supervision tree and start streaming functionality</a></li>
<li class="chapter" data-level="11.8" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#implement-the-stop-functionality"><i class="fa fa-check"></i><b>11.8</b> Implement the stop functionality</a></li>
<li class="chapter" data-level="11.9" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#implement-the-autostart-streaming-functionality"><i class="fa fa-check"></i><b>11.9</b> Implement the autostart streaming functionality</a></li>
<li class="chapter" data-level="11.10" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#test-the-implementation-3"><i class="fa fa-check"></i><b>11.10</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html"><i class="fa fa-check"></i><b>12</b> Start, stop, shutdown and autostart trading</a>
<ul>
<li class="chapter" data-level="12.1" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#objectives-11"><i class="fa fa-check"></i><b>12.1</b> Objectives</a></li>
<li class="chapter" data-level="12.2" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#describe-and-design-the-required-functionality-3"><i class="fa fa-check"></i><b>12.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="12.3" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#re-implement-the-start-trading-functionality"><i class="fa fa-check"></i><b>12.3</b> (Re-)Implement the start trading functionality</a></li>
<li class="chapter" data-level="12.4" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#implement-the-stop-trading-functionality"><i class="fa fa-check"></i><b>12.4</b> Implement the stop trading functionality</a></li>
<li class="chapter" data-level="12.5" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#implement-the-autostart-trading-functionality"><i class="fa fa-check"></i><b>12.5</b> Implement the autostart trading functionality</a></li>
<li class="chapter" data-level="12.6" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#implement-the-shutdown-trading-functionality"><i class="fa fa-check"></i><b>12.6</b> Implement the shutdown trading functionality</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html"><i class="fa fa-check"></i><b>13</b> Abstract duplicated supervision code</a>
<ul>
<li class="chapter" data-level="13.1" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#objectives-12"><i class="fa fa-check"></i><b>13.1</b> Objectives</a></li>
<li class="chapter" data-level="13.2" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#overview-of-requirements"><i class="fa fa-check"></i><b>13.2</b> Overview of requirements</a></li>
<li class="chapter" data-level="13.3" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#pseudo-generalize-core.servicesupervisor-module"><i class="fa fa-check"></i><b>13.3</b> Pseudo generalize Core.ServiceSupervisor module</a></li>
<li class="chapter" data-level="13.4" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#utilize-pseudo-generalized-code-inside-the-naive-dynamicsymbolsupervisor"><i class="fa fa-check"></i><b>13.4</b> Utilize pseudo generalized code inside the Naive DynamicSymbolSupervisor</a></li>
<li class="chapter" data-level="13.5" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#implement-a-truly-generic-core.servicesupervisor"><i class="fa fa-check"></i><b>13.5</b> Implement a truly generic <code>Core.ServiceSupervisor</code></a>
<ul>
<li class="chapter" data-level="13.5.1" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#first-path-starting-with-the-fetch_symbols_to_start0-function"><i class="fa fa-check"></i><b>13.5.1</b> First path starting with the <code>fetch_symbols_to_start/0</code> function</a></li>
<li class="chapter" data-level="13.5.2" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#second-path-starting-with-the-update_status2"><i class="fa fa-check"></i><b>13.5.2</b> Second path starting with the <code>update_status/2</code></a></li>
<li class="chapter" data-level="13.5.3" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#third-path-starting-with-the-get_pid1-function"><i class="fa fa-check"></i><b>13.5.3</b> Third path starting with the <code>get_pid/1</code> function</a></li>
</ul></li>
<li class="chapter" data-level="13.6" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#remove-boilerplate-using-use-macro"><i class="fa fa-check"></i><b>13.6</b> Remove boilerplate using <code>use</code> macro</a></li>
<li class="chapter" data-level="13.7" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#use-the-core.servicesupervisor-module-inside-the-streamer-application"><i class="fa fa-check"></i><b>13.7</b> Use the <code>Core.ServiceSupervisor</code> module inside the <code>streamer</code> application</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html"><i class="fa fa-check"></i><b>14</b> Store trade events and orders inside the database</a>
<ul>
<li class="chapter" data-level="14.1" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#objectives-13"><i class="fa fa-check"></i><b>14.1</b> Objectives</a></li>
<li class="chapter" data-level="14.2" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#overview-of-requirements-1"><i class="fa fa-check"></i><b>14.2</b> Overview of requirements</a></li>
<li class="chapter" data-level="14.3" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-a-new-data_warehouse-application-in-the-umbrella"><i class="fa fa-check"></i><b>14.3</b> Create a new <code>data_warehouse</code> application in the umbrella</a></li>
<li class="chapter" data-level="14.4" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#connect-to-the-database-using-ecto"><i class="fa fa-check"></i><b>14.4</b> Connect to the database using Ecto</a></li>
<li class="chapter" data-level="14.5" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#store-trade-events-data"><i class="fa fa-check"></i><b>14.5</b> Store trade events’ data</a></li>
<li class="chapter" data-level="14.6" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#store-orders-data"><i class="fa fa-check"></i><b>14.6</b> Store orders’ data</a></li>
<li class="chapter" data-level="14.7" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#implement-supervision"><i class="fa fa-check"></i><b>14.7</b> Implement supervision</a>
<ul>
<li class="chapter" data-level="14.7.1" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-subscriber_settings-table"><i class="fa fa-check"></i><b>14.7.1</b> Create <code>subscriber_settings</code> table</a></li>
<li class="chapter" data-level="14.7.2" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#redesign-supervision-using-registry"><i class="fa fa-check"></i><b>14.7.2</b> Redesign supervision using Registry</a></li>
<li class="chapter" data-level="14.7.3" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-the-datawarehouse.subscriber.dynamicsupervisor-module"><i class="fa fa-check"></i><b>14.7.3</b> Create the <code>DataWarehouse.Subscriber.DynamicSupervisor</code> module</a></li>
<li class="chapter" data-level="14.7.4" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#register-worker-processes-using-via"><i class="fa fa-check"></i><b>14.7.4</b> Register Worker processes using :via</a></li>
<li class="chapter" data-level="14.7.5" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-a-new-supervision-level-for-registry-task-and-the-dynamicsupervisor"><i class="fa fa-check"></i><b>14.7.5</b> Create a new supervision level for Registry, Task and the DynamicSupervisor</a></li>
<li class="chapter" data-level="14.7.6" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#link-the-subscribersupervisor-to-the-application"><i class="fa fa-check"></i><b>14.7.6</b> Link the <code>SubscriberSupervisor</code> to the <code>Application</code></a></li>
<li class="chapter" data-level="14.7.7" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#add-interface"><i class="fa fa-check"></i><b>14.7.7</b> Add interface</a></li>
<li class="chapter" data-level="14.7.8" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#test"><i class="fa fa-check"></i><b>14.7.8</b> Test</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="15" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html"><i class="fa fa-check"></i><b>15</b> Backtest trading strategy</a>
<ul>
<li class="chapter" data-level="15.1" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#objectives-14"><i class="fa fa-check"></i><b>15.1</b> Objectives</a></li>
<li class="chapter" data-level="15.2" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#overview-of-requirements-2"><i class="fa fa-check"></i><b>15.2</b> Overview of requirements</a></li>
<li class="chapter" data-level="15.3" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#implement-the-storing-task"><i class="fa fa-check"></i><b>15.3</b> Implement the storing task</a></li>
<li class="chapter" data-level="15.4" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#test-the-backtesting"><i class="fa fa-check"></i><b>15.4</b> Test the backtesting</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html"><i class="fa fa-check"></i><b>16</b> End-to-end testing</a>
<ul>
<li class="chapter" data-level="16.1" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#objectives-15"><i class="fa fa-check"></i><b>16.1</b> Objectives</a></li>
<li class="chapter" data-level="16.2" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#decide-on-the-tested-functionality"><i class="fa fa-check"></i><b>16.2</b> Decide on the tested functionality</a></li>
<li class="chapter" data-level="16.3" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#implement-basic-test"><i class="fa fa-check"></i><b>16.3</b> Implement basic test</a></li>
<li class="chapter" data-level="16.4" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#introduce-environment-based-config-files"><i class="fa fa-check"></i><b>16.4</b> Introduce environment based config files</a></li>
<li class="chapter" data-level="16.5" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#add-convenience-aliases"><i class="fa fa-check"></i><b>16.5</b> Add convenience aliases</a></li>
<li class="chapter" data-level="16.6" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#cache-initial-seed-data-inside-a-file"><i class="fa fa-check"></i><b>16.6</b> Cache initial seed data inside a file</a></li>
<li class="chapter" data-level="16.7" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#update-seeding-scripts-to-use-the-binancemock"><i class="fa fa-check"></i><b>16.7</b> Update seeding scripts to use the BinanceMock</a></li>
<li class="chapter" data-level="16.8" data-path="end-to-end-testing.html"><a href="end-to-end-testing.html#introduce-the-core-application"><i class="fa fa-check"></i><b>16.8</b> Introduce the Core application</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="mox-rocks.html"><a href="mox-rocks.html"><i class="fa fa-check"></i><b>17</b> Mox rocks</a>
<ul>
<li class="chapter" data-level="17.1" data-path="mox-rocks.html"><a href="mox-rocks.html#objectives-16"><i class="fa fa-check"></i><b>17.1</b> Objectives</a></li>
<li class="chapter" data-level="17.2" data-path="mox-rocks.html"><a href="mox-rocks.html#introduction-to-mock-based-tests"><i class="fa fa-check"></i><b>17.2</b> Introduction to mock based tests</a></li>
<li class="chapter" data-level="17.3" data-path="mox-rocks.html"><a href="mox-rocks.html#add-the-mox-package"><i class="fa fa-check"></i><b>17.3</b> Add the <code>mox</code> package</a></li>
<li class="chapter" data-level="17.4" data-path="mox-rocks.html"><a href="mox-rocks.html#investigate-the-naive.trader-module"><i class="fa fa-check"></i><b>17.4</b> Investigate the <code>Naive.Trader</code> module</a>
<ul>
<li class="chapter" data-level="17.4.1" data-path="mox-rocks.html"><a href="mox-rocks.html#mock-the-binance-module"><i class="fa fa-check"></i><b>17.4.1</b> Mock the <code>Binance</code> module</a></li>
<li class="chapter" data-level="17.4.2" data-path="mox-rocks.html"><a href="mox-rocks.html#mock-the-naiveleader-module"><i class="fa fa-check"></i><b>17.4.2</b> Mock the <code>NaiveLeader</code> module</a></li>
<li class="chapter" data-level="17.4.3" data-path="mox-rocks.html"><a href="mox-rocks.html#mock-the-phoenix.pubsub-module"><i class="fa fa-check"></i><b>17.4.3</b> Mock the <code>Phoenix.PubSub</code> module</a></li>
<li class="chapter" data-level="17.4.4" data-path="mox-rocks.html"><a href="mox-rocks.html#mock-the-logger-module"><i class="fa fa-check"></i><b>17.4.4</b> Mock the <code>Logger</code> module</a></li>
</ul></li>
<li class="chapter" data-level="17.5" data-path="mox-rocks.html"><a href="mox-rocks.html#implement-a-test-of-the-naive.trader-module"><i class="fa fa-check"></i><b>17.5</b> Implement a test of the <code>Naive.Trader</code> module</a></li>
<li class="chapter" data-level="17.6" data-path="mox-rocks.html"><a href="mox-rocks.html#define-an-alias-to-run-unit-tests"><i class="fa fa-check"></i><b>17.6</b> Define an alias to run unit tests</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="functional-elixir.html"><a href="functional-elixir.html"><i class="fa fa-check"></i><b>18</b> Functional Elixir</a>
<ul>
<li class="chapter" data-level="18.1" data-path="functional-elixir.html"><a href="functional-elixir.html#objectives-17"><i class="fa fa-check"></i><b>18.1</b> Objectives</a></li>
<li class="chapter" data-level="18.2" data-path="functional-elixir.html"><a href="functional-elixir.html#the-reasoning-behind-the-functional-approach"><i class="fa fa-check"></i><b>18.2</b> The reasoning behind the functional approach</a></li>
<li class="chapter" data-level="18.3" data-path="functional-elixir.html"><a href="functional-elixir.html#simplifying-by-splitting"><i class="fa fa-check"></i><b>18.3</b> Simplifying by splitting</a></li>
<li class="chapter" data-level="18.4" data-path="functional-elixir.html"><a href="functional-elixir.html#abstracting-the-pure-logic"><i class="fa fa-check"></i><b>18.4</b> Abstracting the “pure” logic</a>
<ul>
<li class="chapter" data-level="18.4.1" data-path="functional-elixir.html"><a href="functional-elixir.html#place-a-buy-order-rules"><i class="fa fa-check"></i><b>18.4.1</b> Place a buy order rules</a></li>
<li class="chapter" data-level="18.4.2" data-path="functional-elixir.html"><a href="functional-elixir.html#race-condition-rules"><i class="fa fa-check"></i><b>18.4.2</b> Race condition rules</a></li>
<li class="chapter" data-level="18.4.3" data-path="functional-elixir.html"><a href="functional-elixir.html#place-a-sell-order-rules"><i class="fa fa-check"></i><b>18.4.3</b> Place a sell order rules</a></li>
<li class="chapter" data-level="18.4.4" data-path="functional-elixir.html"><a href="functional-elixir.html#fetch-the-buy-order-rules"><i class="fa fa-check"></i><b>18.4.4</b> Fetch the buy order rules</a></li>
<li class="chapter" data-level="18.4.5" data-path="functional-elixir.html"><a href="functional-elixir.html#terminate-trader-rules"><i class="fa fa-check"></i><b>18.4.5</b> Terminate trader rules</a></li>
<li class="chapter" data-level="18.4.6" data-path="functional-elixir.html"><a href="functional-elixir.html#fetch-the-sell-order-rules"><i class="fa fa-check"></i><b>18.4.6</b> Fetch the sell order rules</a></li>
<li class="chapter" data-level="18.4.7" data-path="functional-elixir.html"><a href="functional-elixir.html#trigger-rebuy-rules"><i class="fa fa-check"></i><b>18.4.7</b> Trigger rebuy rules</a></li>
<li class="chapter" data-level="18.4.8" data-path="functional-elixir.html"><a href="functional-elixir.html#the-final-clause-rules"><i class="fa fa-check"></i><b>18.4.8</b> The final clause rules</a></li>
<li class="chapter" data-level="18.4.9" data-path="functional-elixir.html"><a href="functional-elixir.html#changes-to-the-naive.trader-module"><i class="fa fa-check"></i><b>18.4.9</b> Changes to the <code>Naive.Trader</code> module</a></li>
<li class="chapter" data-level="18.4.10" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---place-buy-order"><i class="fa fa-check"></i><b>18.4.10</b> <code>Naive.Trader</code> - place buy order</a></li>
<li class="chapter" data-level="18.4.11" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---race-condition-clause"><i class="fa fa-check"></i><b>18.4.11</b> <code>Naive.Trader</code> - Race condition clause</a></li>
<li class="chapter" data-level="18.4.12" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---place-a-sell-order"><i class="fa fa-check"></i><b>18.4.12</b> <code>Naive.Trader</code> - Place a sell order</a></li>
<li class="chapter" data-level="18.4.13" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---fetch-the-buy-order"><i class="fa fa-check"></i><b>18.4.13</b> <code>Naive.Trader</code> - Fetch the buy order</a></li>
<li class="chapter" data-level="18.4.14" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---terminate-the-trader"><i class="fa fa-check"></i><b>18.4.14</b> <code>Naive.Trader</code> - Terminate the trader</a></li>
<li class="chapter" data-level="18.4.15" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---fetch-the-sell-order"><i class="fa fa-check"></i><b>18.4.15</b> <code>Naive.Trader</code> - Fetch the sell order</a></li>
<li class="chapter" data-level="18.4.16" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---triggering-rebuy"><i class="fa fa-check"></i><b>18.4.16</b> <code>Naive.Trader</code> - Triggering rebuy</a></li>
<li class="chapter" data-level="18.4.17" data-path="functional-elixir.html"><a href="functional-elixir.html#naive.trader---the-final-ignore-clause"><i class="fa fa-check"></i><b>18.4.17</b> <code>Naive.Trader</code> - The final ignore clause</a></li>
</ul></li>
<li class="chapter" data-level="18.5" data-path="functional-elixir.html"><a href="functional-elixir.html#dealing-with-dirty-code"><i class="fa fa-check"></i><b>18.5</b> Dealing with dirty code</a></li>
<li class="chapter" data-level="18.6" data-path="functional-elixir.html"><a href="functional-elixir.html#making-dirty-code-testable"><i class="fa fa-check"></i><b>18.6</b> Making dirty code testable</a>
<ul>
<li class="chapter" data-level="18.6.1" data-path="functional-elixir.html"><a href="functional-elixir.html#passing-functions-arguments"><i class="fa fa-check"></i><b>18.6.1</b> Passing functions arguments</a></li>
<li class="chapter" data-level="18.6.2" data-path="functional-elixir.html"><a href="functional-elixir.html#passing-grouped-functions-as-a-context"><i class="fa fa-check"></i><b>18.6.2</b> Passing grouped functions as a context</a></li>
<li class="chapter" data-level="18.6.3" data-path="functional-elixir.html"><a href="functional-elixir.html#passing-grouped-modules-as-a-context"><i class="fa fa-check"></i><b>18.6.3</b> Passing grouped modules as a context</a></li>
<li class="chapter" data-level="18.6.4" data-path="functional-elixir.html"><a href="functional-elixir.html#injecting-modules-to-modules-attributes-based-on-the-configuration"><i class="fa fa-check"></i><b>18.6.4</b> Injecting modules to module’s attributes based on the configuration</a></li>
</ul></li>
<li class="chapter" data-level="18.7" data-path="functional-elixir.html"><a href="functional-elixir.html#the-power-with-in"><i class="fa fa-check"></i><b>18.7</b> The power <code>with</code>-in</a>
<ul>
<li class="chapter" data-level="18.7.1" data-path="functional-elixir.html"><a href="functional-elixir.html#idiomatic-error-handling"><i class="fa fa-check"></i><b>18.7.1</b> Idiomatic error handling</a></li>
</ul></li>
<li class="chapter" data-level="18.8" data-path="functional-elixir.html"><a href="functional-elixir.html#do-or-not-to-do"><i class="fa fa-check"></i><b>18.8</b> Do or not to do</a></li>
<li class="chapter" data-level="18.9" data-path="functional-elixir.html"><a href="functional-elixir.html#final-thoughts"><i class="fa fa-check"></i><b>18.9</b> Final thoughts</a></li>
</ul></li>
<li class="chapter" data-level="19" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html"><i class="fa fa-check"></i><b>19</b> Idiomatic OTP</a>
<ul>
<li class="chapter" data-level="19.1" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#objectives-18"><i class="fa fa-check"></i><b>19.1</b> Objectives</a></li>
<li class="chapter" data-level="19.2" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#the-concept"><i class="fa fa-check"></i><b>19.2</b> The concept</a></li>
<li class="chapter" data-level="19.3" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#initial-implementation"><i class="fa fa-check"></i><b>19.3</b> Initial implementation</a>
<ul>
<li class="chapter" data-level="19.3.1" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#maybe-functions"><i class="fa fa-check"></i><b>19.3.1</b> Maybe functions</a></li>
<li class="chapter" data-level="19.3.2" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#testing"><i class="fa fa-check"></i><b>19.3.2</b> Testing</a></li>
<li class="chapter" data-level="19.3.3" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#supervision"><i class="fa fa-check"></i><b>19.3.3</b> Supervision</a></li>
</ul></li>
<li class="chapter" data-level="19.4" data-path="idiomatic-otp.html"><a href="idiomatic-otp.html#idiomatic-solution"><i class="fa fa-check"></i><b>19.4</b> Idiomatic solution</a></li>
</ul></li>
<li class="chapter" data-level="20" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html"><i class="fa fa-check"></i><b>20</b> Idiomatic trading strategy</a>
<ul>
<li class="chapter" data-level="20.1" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#objectives-19"><i class="fa fa-check"></i><b>20.1</b> Objectives</a></li>
<li class="chapter" data-level="20.2" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#following-the-ohlc-footsteps"><i class="fa fa-check"></i><b>20.2</b> Following the OHLC footsteps</a></li>
<li class="chapter" data-level="20.3" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#simplifying-the-naive-supervision-tree"><i class="fa fa-check"></i><b>20.3</b> Simplifying the Naive supervision tree</a>
<ul>
<li class="chapter" data-level="20.3.1" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#the-naive.dynamictradersupervisor-module"><i class="fa fa-check"></i><b>20.3.1</b> The <code>Naive.DynamicTraderSupervisor</code> module</a></li>
<li class="chapter" data-level="20.3.2" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#the-naive-module"><i class="fa fa-check"></i><b>20.3.2</b> The <code>Naive</code> module</a></li>
<li class="chapter" data-level="20.3.3" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#the-naive.supervisor-module"><i class="fa fa-check"></i><b>20.3.3</b> The <code>Naive.Supervisor</code> module</a></li>
<li class="chapter" data-level="20.3.4" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#the-naive.trader-module"><i class="fa fa-check"></i><b>20.3.4</b> The <code>Naive.Trader</code> module</a></li>
</ul></li>
<li class="chapter" data-level="20.4" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#supporting-multiple-positions"><i class="fa fa-check"></i><b>20.4</b> Supporting multiple positions</a>
<ul>
<li class="chapter" data-level="20.4.1" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#initialization"><i class="fa fa-check"></i><b>20.4.1</b> Initialization</a></li>
<li class="chapter" data-level="20.4.2" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#parallelising-the-strategy"><i class="fa fa-check"></i><b>20.4.2</b> Parallelising the strategy</a></li>
</ul></li>
<li class="chapter" data-level="20.5" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#retrofitting-the-shutdown-functionality"><i class="fa fa-check"></i><b>20.5</b> Retrofitting the “shutdown” functionality</a>
<ul>
<li class="chapter" data-level="20.5.1" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#handling-updated-settings"><i class="fa fa-check"></i><b>20.5.1</b> Handling updated settings</a></li>
<li class="chapter" data-level="20.5.2" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#updating-the-naive.strategy-to-honour-the-shutdown-state"><i class="fa fa-check"></i><b>20.5.2</b> Updating the <code>Naive.Strategy</code> to honour the “shutdown” state</a></li>
</ul></li>
<li class="chapter" data-level="20.6" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#updating-the-strategy-to-handle-rebuys"><i class="fa fa-check"></i><b>20.6</b> Updating the Strategy to handle rebuys</a></li>
<li class="chapter" data-level="20.7" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#fetching-active-positions"><i class="fa fa-check"></i><b>20.7</b> Fetching active positions</a></li>
<li class="chapter" data-level="20.8" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#tidying-up"><i class="fa fa-check"></i><b>20.8</b> Tidying up</a></li>
<li class="chapter" data-level="20.9" data-path="idiomatic-trading-strategy.html"><a href="idiomatic-trading-strategy.html#final-thoughts-1"><i class="fa fa-check"></i><b>20.9</b> Final thoughts</a></li>
</ul></li>
<li class="chapter" data-level="21" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html"><i class="fa fa-check"></i><b>21</b> Layers of abstraction</a>
<ul>
<li class="chapter" data-level="21.1" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#objectives-20"><i class="fa fa-check"></i><b>21.1</b> Objectives</a></li>
<li class="chapter" data-level="21.2" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#admitting-the-simplification"><i class="fa fa-check"></i><b>21.2</b> Admitting the simplification</a></li>
<li class="chapter" data-level="21.3" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#abstracting-the-exchange"><i class="fa fa-check"></i><b>21.3</b> Abstracting the exchange</a>
<ul>
<li class="chapter" data-level="21.3.1" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#defining-the-core.exchange-behaviour"><i class="fa fa-check"></i><b>21.3.1</b> Defining the <code>Core.Exchange</code> behaviour</a></li>
<li class="chapter" data-level="21.3.2" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#implementation-of-the-core.exchange.binance-module"><i class="fa fa-check"></i><b>21.3.2</b> Implementation of the <code>Core.Exchange.Binance</code> module</a></li>
<li class="chapter" data-level="21.3.3" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#updating-the-binancemock-module-to-implement-the-core.exchange-behaviour"><i class="fa fa-check"></i><b>21.3.3</b> Updating the <code>BinanceMock</code> module to implement the <code>Core.Exchange</code> behaviour</a></li>
<li class="chapter" data-level="21.3.4" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#updating-the-naive.strategy"><i class="fa fa-check"></i><b>21.3.4</b> Updating the <code>Naive.Strategy</code></a></li>
<li class="chapter" data-level="21.3.5" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#updating-the-seed-scripts"><i class="fa fa-check"></i><b>21.3.5</b> Updating the seed scripts</a></li>
<li class="chapter" data-level="21.3.6" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#manual-testing-after-the-refactoring"><i class="fa fa-check"></i><b>21.3.6</b> Manual testing after the refactoring</a></li>
<li class="chapter" data-level="21.3.7" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#storing-the-data"><i class="fa fa-check"></i><b>21.3.7</b> Storing the data</a></li>
<li class="chapter" data-level="21.3.8" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#the-mox-approach-summary"><i class="fa fa-check"></i><b>21.3.8</b> The <code>Mox</code> approach summary</a></li>
</ul></li>
<li class="chapter" data-level="21.4" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#mimicking-the-reality"><i class="fa fa-check"></i><b>21.4</b> Mimicking the reality</a>
<ul>
<li class="chapter" data-level="21.4.1" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#updating-the-naive.strategy-1"><i class="fa fa-check"></i><b>21.4.1</b> Updating the <code>Naive.Strategy</code></a></li>
<li class="chapter" data-level="21.4.2" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#testing-the-naive.strategy"><i class="fa fa-check"></i><b>21.4.2</b> Testing the <code>Naive.Strategy</code></a></li>
<li class="chapter" data-level="21.4.3" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#logging-elephant-in-the-room"><i class="fa fa-check"></i><b>21.4.3</b> Logging elephant in the room</a></li>
</ul></li>
<li class="chapter" data-level="21.5" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#swapping-back-to-attributes"><i class="fa fa-check"></i><b>21.5</b> Swapping back to attributes</a>
<ul>
<li class="chapter" data-level="21.5.1" data-path="layers-of-abstraction.html"><a href="layers-of-abstraction.html#config-files"><i class="fa fa-check"></i><b>21.5.1</b> Config files</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://www.bookdown.org/" target="blank">Created with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Hands-on Elixir &amp; OTP: Cryptocurrency trading bot</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="idiomatic-otp" class="section level1 hasAnchor" number="19">
<h1><span class="header-section-number">Chapter 19</span> Idiomatic OTP<a href="idiomatic-otp.html#idiomatic-otp" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="objectives-18" class="section level2 hasAnchor" number="19.1">
<h2><span class="header-section-number">19.1</span> Objectives<a href="idiomatic-otp.html#objectives-18" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>the concept</li>
<li>initial implementation</li>
<li>idiomatic solution</li>
</ul>
</div>
<div id="the-concept" class="section level2 hasAnchor" number="19.2">
<h2><span class="header-section-number">19.2</span> The concept<a href="idiomatic-otp.html#the-concept" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In this chapter, we will look into building an OHLC(open-high-low-close) indicator. We will discuss different potential implementations, which will give us an excellent example to understand the idiomatic usage of the OTP framework.</p>
<p>The OHLC indicator consists of four prices that could be used to draw a candle on the chart:</p>
<p><img src="images/chapter_19_01_ohlc_candle.jpg" width="100%" style="display: block; margin: auto;" /></p>
<p>The OHLC indicators get created by collecting the first price (the “open” price), lowest price(the “low” price), highest price(the “high” price) and the last price(the “close” price) within a specific timeframe like 1 minute. Our code will need to be able to generate those for multiple timeframes at once - 1m, 5m, 15m, 1h, 4h and 24h.</p>
</div>
<div id="initial-implementation" class="section level2 hasAnchor" number="19.3">
<h2><span class="header-section-number">19.3</span> Initial implementation<a href="idiomatic-otp.html#initial-implementation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>What we could do is to have multiple GenServer processes subscribed to the trade events topic in the PubSub where each one would update their own OHLC numbers:</p>
<p><img src="images/chapter_19_02_multi_workers.jpg" width="100%" style="display: block; margin: auto;" /></p>
<p>Let’s start by creating a new application inside our umbrella called “indicators”(run below inside terminal):</p>
<div class="sourceCode" id="cb419"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb419-1"><a href="idiomatic-otp.html#cb419-1" tabindex="-1"></a><span class="ex">$</span> cd apps </span>
<span id="cb419-2"><a href="idiomatic-otp.html#cb419-2" tabindex="-1"></a><span class="ex">$</span> mix new indicator <span class="at">--sup</span></span></code></pre></div>
<p>We can now create a new directory called “ohlc” inside the “/apps/indicator/lib/indicator” directory, where we will create the GenServer “worker.ex” file:</p>
<div class="sourceCode" id="cb420"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb420-1"><a href="idiomatic-otp.html#cb420-1" tabindex="-1"></a><span class="co"># /apps/indicator/lib/indicator/ohlc/worker.ex</span></span>
<span id="cb420-2"><a href="idiomatic-otp.html#cb420-2" tabindex="-1"></a><span class="kw">defmodule</span> <span class="cn">Indicator</span><span class="op">.</span><span class="cn">Ohlc</span><span class="op">.</span><span class="cn">Worker</span> <span class="kw">do</span></span>
<span id="cb420-3"><a href="idiomatic-otp.html#cb420-3" tabindex="-1"></a>  <span class="im">use</span> <span class="cn">GenServer</span></span>
<span id="cb420-4"><a href="idiomatic-otp.html#cb420-4" tabindex="-1"></a></span>
<span id="cb420-5"><a href="idiomatic-otp.html#cb420-5" tabindex="-1"></a>  <span class="kw">def</span> start_link<span class="fu">({</span>symbol, duration<span class="fu">})</span> <span class="kw">do</span></span>
<span id="cb420-6"><a href="idiomatic-otp.html#cb420-6" tabindex="-1"></a>    <span class="cn">GenServer</span><span class="op">.</span>start_link<span class="fu">(</span><span class="cn">__MODULE__</span>, <span class="fu">{</span>symbol, duration<span class="fu">})</span></span>
<span id="cb420-7"><a href="idiomatic-otp.html#cb420-7" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb420-8"><a href="idiomatic-otp.html#cb420-8" tabindex="-1"></a></span>
<span id="cb420-9"><a href="idiomatic-otp.html#cb420-9" tabindex="-1"></a>  <span class="kw">def</span> init<span class="fu">({</span>symbol, duration<span class="fu">})</span> <span class="kw">do</span></span>
<span id="cb420-10"><a href="idiomatic-otp.html#cb420-10" tabindex="-1"></a>    <span class="fu">{</span><span class="va">:ok</span>, <span class="fu">{</span>symbol, duration<span class="fu">}}</span></span>
<span id="cb420-11"><a href="idiomatic-otp.html#cb420-11" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb420-12"><a href="idiomatic-otp.html#cb420-12" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<div style="page-break-after: always;"></div>
<p>As each worker will need to subscribe to the PubSub’s <code>"TRADE_EVENTS:#{symbol}"</code> topic, we can update the <code>init/1</code> function to do that:</p>
<div class="sourceCode" id="cb421"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb421-1"><a href="idiomatic-otp.html#cb421-1" tabindex="-1"></a><span class="co"># /apps/indicator/lib/indicator/ohlc/worker.ex</span></span>
<span id="cb421-2"><a href="idiomatic-otp.html#cb421-2" tabindex="-1"></a></span>
<span id="cb421-3"><a href="idiomatic-otp.html#cb421-3" tabindex="-1"></a>  <span class="co"># add those at the top of the worker module</span></span>
<span id="cb421-4"><a href="idiomatic-otp.html#cb421-4" tabindex="-1"></a>  <span class="im">require</span> <span class="cn">Logger</span></span>
<span id="cb421-5"><a href="idiomatic-otp.html#cb421-5" tabindex="-1"></a></span>
<span id="cb421-6"><a href="idiomatic-otp.html#cb421-6" tabindex="-1"></a>  <span class="ot">@logger</span> <span class="cn">Application</span><span class="op">.</span>compile_env<span class="fu">(</span><span class="va">:core</span>, <span class="va">:logger</span><span class="fu">)</span></span>
<span id="cb421-7"><a href="idiomatic-otp.html#cb421-7" tabindex="-1"></a>  <span class="ot">@pubsub_client</span> <span class="cn">Application</span><span class="op">.</span>compile_env<span class="fu">(</span><span class="va">:core</span>, <span class="va">:pubsub_client</span><span class="fu">)</span></span>
<span id="cb421-8"><a href="idiomatic-otp.html#cb421-8" tabindex="-1"></a></span>
<span id="cb421-9"><a href="idiomatic-otp.html#cb421-9" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb421-10"><a href="idiomatic-otp.html#cb421-10" tabindex="-1"></a></span>
<span id="cb421-11"><a href="idiomatic-otp.html#cb421-11" tabindex="-1"></a>  <span class="co"># updated `init/1` function</span></span>
<span id="cb421-12"><a href="idiomatic-otp.html#cb421-12" tabindex="-1"></a>  <span class="kw">def</span> init<span class="fu">({</span>symbol, duration<span class="fu">})</span> <span class="kw">do</span></span>
<span id="cb421-13"><a href="idiomatic-otp.html#cb421-13" tabindex="-1"></a>    symbol <span class="op">=</span> <span class="cn">String</span><span class="op">.</span>upcase<span class="fu">(</span>symbol<span class="fu">)</span></span>
<span id="cb421-14"><a href="idiomatic-otp.html#cb421-14" tabindex="-1"></a></span>
<span id="cb421-15"><a href="idiomatic-otp.html#cb421-15" tabindex="-1"></a>    <span class="ot">@logger</span><span class="op">.</span>info<span class="fu">(</span><span class="st">&quot;Initializing a new OHLC worker(</span><span class="ot">#{</span>duration<span class="ot">}</span><span class="st"> minutes) for </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st">&quot;</span><span class="fu">)</span></span>
<span id="cb421-16"><a href="idiomatic-otp.html#cb421-16" tabindex="-1"></a></span>
<span id="cb421-17"><a href="idiomatic-otp.html#cb421-17" tabindex="-1"></a>    <span class="ot">@pubsub_client</span><span class="op">.</span>subscribe<span class="fu">(</span></span>
<span id="cb421-18"><a href="idiomatic-otp.html#cb421-18" tabindex="-1"></a>      <span class="cn">Core</span><span class="op">.</span><span class="cn">PubSub</span>,</span>
<span id="cb421-19"><a href="idiomatic-otp.html#cb421-19" tabindex="-1"></a>      <span class="st">&quot;TRADE_EVENTS:</span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st">&quot;</span></span>
<span id="cb421-20"><a href="idiomatic-otp.html#cb421-20" tabindex="-1"></a>    <span class="fu">)</span></span>
<span id="cb421-21"><a href="idiomatic-otp.html#cb421-21" tabindex="-1"></a></span>
<span id="cb421-22"><a href="idiomatic-otp.html#cb421-22" tabindex="-1"></a>    <span class="fu">{</span><span class="va">:ok</span>, <span class="fu">{</span>symbol, duration<span class="fu">}}</span></span>
<span id="cb421-23"><a href="idiomatic-otp.html#cb421-23" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>Following the pattern established by the <code>Naive.Trader</code>, we use the module’s attributes(with values based on the configuration) instead of hardcoded module names.</p>
<p>As we subscribed to the PubSub, we need to provide a callback that will handle the incoming trade events:</p>
<div class="sourceCode" id="cb422"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb422-1"><a href="idiomatic-otp.html#cb422-1" tabindex="-1"></a><span class="co"># /apps/indicator/lib/indicator/ohlc/worker.ex</span></span>
<span id="cb422-2"><a href="idiomatic-otp.html#cb422-2" tabindex="-1"></a>  <span class="co"># add this at the top</span></span>
<span id="cb422-3"><a href="idiomatic-otp.html#cb422-3" tabindex="-1"></a>  <span class="im">alias</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">Struct</span><span class="op">.</span><span class="cn">TradeEvent</span></span>
<span id="cb422-4"><a href="idiomatic-otp.html#cb422-4" tabindex="-1"></a></span>
<span id="cb422-5"><a href="idiomatic-otp.html#cb422-5" tabindex="-1"></a>  <span class="kw">def</span> handle_info<span class="fu">(</span>%<span class="cn">TradeEvent</span><span class="fu">{}</span> <span class="op">=</span> trade_event, ohlc<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb422-6"><a href="idiomatic-otp.html#cb422-6" tabindex="-1"></a>    <span class="fu">{</span><span class="va">:noreply</span>, <span class="cn">Indicator</span><span class="op">.</span><span class="cn">Ohlc</span><span class="op">.</span>process<span class="fu">(</span>ohlc, trade_event<span class="fu">)}</span></span>
<span id="cb422-7"><a href="idiomatic-otp.html#cb422-7" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<div style="page-break-after: always;"></div>
<p>To avoid mixing our business logic with the GenServer boilerplate(as discussed in the last chapter), we will place it in a new module. First, we need to create a new file <code>/apps/indicator/lib/indicator/ohlc.ex</code> and the <code>Indicator.Ohlc</code> module inside it:</p>
<div class="sourceCode" id="cb423"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb423-1"><a href="idiomatic-otp.html#cb423-1" tabindex="-1"></a><span class="co"># /apps/indicator/lib/indicator/ohlc.ex</span></span>
<span id="cb423-2"><a href="idiomatic-otp.html#cb423-2" tabindex="-1"></a><span class="kw">defmodule</span> <span class="cn">Indicator</span><span class="op">.</span><span class="cn">Ohlc</span> <span class="kw">do</span></span>
<span id="cb423-3"><a href="idiomatic-otp.html#cb423-3" tabindex="-1"></a></span>
<span id="cb423-4"><a href="idiomatic-otp.html#cb423-4" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<p>The <code>Indicator.Ohlc</code> module will define a struct that the <code>Indicator.Ohlc.Worker</code> will use as a state:</p>
<div class="sourceCode" id="cb424"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb424-1"><a href="idiomatic-otp.html#cb424-1" tabindex="-1"></a><span class="co"># /apps/indicator/lib/indicator/ohlc.ex</span></span>
<span id="cb424-2"><a href="idiomatic-otp.html#cb424-2" tabindex="-1"></a>  <span class="ot">@enforce_keys</span> <span class="ot">[</span></span>
<span id="cb424-3"><a href="idiomatic-otp.html#cb424-3" tabindex="-1"></a>    <span class="va">:symbol</span>,</span>
<span id="cb424-4"><a href="idiomatic-otp.html#cb424-4" tabindex="-1"></a>    <span class="va">:start_time</span>,</span>
<span id="cb424-5"><a href="idiomatic-otp.html#cb424-5" tabindex="-1"></a>    <span class="va">:duration</span></span>
<span id="cb424-6"><a href="idiomatic-otp.html#cb424-6" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb424-7"><a href="idiomatic-otp.html#cb424-7" tabindex="-1"></a>  <span class="kw">defstruct</span> <span class="ot">[</span></span>
<span id="cb424-8"><a href="idiomatic-otp.html#cb424-8" tabindex="-1"></a>    <span class="va">:symbol</span>,</span>
<span id="cb424-9"><a href="idiomatic-otp.html#cb424-9" tabindex="-1"></a>    <span class="va">:start_time</span>,</span>
<span id="cb424-10"><a href="idiomatic-otp.html#cb424-10" tabindex="-1"></a>    <span class="va">:duration</span>,</span>
<span id="cb424-11"><a href="idiomatic-otp.html#cb424-11" tabindex="-1"></a>    <span class="va">:open</span>,</span>
<span id="cb424-12"><a href="idiomatic-otp.html#cb424-12" tabindex="-1"></a>    <span class="va">:high</span>,</span>
<span id="cb424-13"><a href="idiomatic-otp.html#cb424-13" tabindex="-1"></a>    <span class="va">:low</span>,</span>
<span id="cb424-14"><a href="idiomatic-otp.html#cb424-14" tabindex="-1"></a>    <span class="va">:close</span></span>
<span id="cb424-15"><a href="idiomatic-otp.html#cb424-15" tabindex="-1"></a>  <span class="ot">]</span></span></code></pre></div>
<p>Most of the above are self-descriptive, besides the <code>start_time</code>(a Unix timestamp) and the <code>duration</code>(the timeframe in minutes).</p>
<p>We can now progress to the implementation of the <code>process/2</code> function, but instead of focusing on it, we will start from the “deepest”/“bottom” function that it will rely on and work our way up. As we discussed in the last chapter, we will try to maximize the amount of pure code.</p>
<p>We can imagine that the bottom function will be involved in merging of the trade event’s data with the current OHLC data. Two things can happen, either:</p>
<ul>
<li>trade event’s <code>trade_time</code> is <strong>within</strong> the current OHLC timeframe. Trade event’s price will get merged to the current OHLC</li>
<li>trade event’s <code>trade_time</code> is <strong>outside</strong> the current OHLC timeframe. The current(now old) OHLC will be returned together with a new OHLC based on the trade event’s price</li>
</ul>
<div style="page-break-after: always;"></div>
<p>Here’s the implementation:</p>
<div class="sourceCode" id="cb425"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb425-1"><a href="idiomatic-otp.html#cb425-1" tabindex="-1"></a><span class="co"># /apps/indicator/lib/indicator/ohlc.ex</span></span>
<span id="cb425-2"><a href="idiomatic-otp.html#cb425-2" tabindex="-1"></a>  <span class="kw">def</span> merge_price<span class="fu">(</span>%<span class="cn">__MODULE__</span><span class="fu">{}</span> <span class="op">=</span> ohlc, price, trade_time<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb425-3"><a href="idiomatic-otp.html#cb425-3" tabindex="-1"></a>    <span class="cf">if</span> within_current_timeframe<span class="fu">(</span>ohlc<span class="op">.</span>start_time, ohlc<span class="op">.</span>duration, trade_time<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb425-4"><a href="idiomatic-otp.html#cb425-4" tabindex="-1"></a>      <span class="fu">{</span><span class="cn">nil</span>, %<span class="fu">{</span>ohlc <span class="op">|</span> <span class="va">low:</span> min<span class="fu">(</span>ohlc<span class="op">.</span>low, price<span class="fu">)</span>, <span class="va">high:</span> max<span class="fu">(</span>ohlc<span class="op">.</span>high, price<span class="fu">)</span>, <span class="va">close:</span> price<span class="fu">}}</span></span>
<span id="cb425-5"><a href="idiomatic-otp.html#cb425-5" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb425-6"><a href="idiomatic-otp.html#cb425-6" tabindex="-1"></a>      <span class="fu">{</span>ohlc, generate_ohlc<span class="fu">(</span>ohlc<span class="op">.</span>symbol, ohlc<span class="op">.</span>duration, price, trade_time<span class="fu">)}</span></span>
<span id="cb425-7"><a href="idiomatic-otp.html#cb425-7" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb425-8"><a href="idiomatic-otp.html#cb425-8" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>together with the <code>within_current_timeframe/3</code> and <code>generate_ohlc/3</code> function:</p>
<div class="sourceCode" id="cb426"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb426-1"><a href="idiomatic-otp.html#cb426-1" tabindex="-1"></a><span class="co"># /apps/indicator/lib/indicator/ohlc.ex</span></span>
<span id="cb426-2"><a href="idiomatic-otp.html#cb426-2" tabindex="-1"></a>  <span class="kw">def</span> within_current_timeframe<span class="fu">(</span>start_time, duration, trade_time<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb426-3"><a href="idiomatic-otp.html#cb426-3" tabindex="-1"></a>    end_time <span class="op">=</span> start_time <span class="op">+</span> duration <span class="op">*</span> <span class="dv">60</span></span>
<span id="cb426-4"><a href="idiomatic-otp.html#cb426-4" tabindex="-1"></a>    trade_time <span class="op">=</span> div<span class="fu">(</span>trade_time, <span class="dv">1000</span><span class="fu">)</span></span>
<span id="cb426-5"><a href="idiomatic-otp.html#cb426-5" tabindex="-1"></a></span>
<span id="cb426-6"><a href="idiomatic-otp.html#cb426-6" tabindex="-1"></a>    start_time <span class="op">&lt;=</span> trade_time <span class="op">&amp;&amp;</span> trade_time <span class="op">&lt;</span> end_time</span>
<span id="cb426-7"><a href="idiomatic-otp.html#cb426-7" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb426-8"><a href="idiomatic-otp.html#cb426-8" tabindex="-1"></a>  </span>
<span id="cb426-9"><a href="idiomatic-otp.html#cb426-9" tabindex="-1"></a>  <span class="kw">def</span> generate_ohlc<span class="fu">(</span>symbol, duration, price, trade_time<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb426-10"><a href="idiomatic-otp.html#cb426-10" tabindex="-1"></a>    start_time <span class="op">=</span> div<span class="fu">(</span>div<span class="fu">(</span>div<span class="fu">(</span>trade_time, <span class="dv">1000</span><span class="fu">)</span>, <span class="dv">60</span><span class="fu">)</span>, duration<span class="fu">)</span> <span class="op">*</span> duration <span class="op">*</span> <span class="dv">60</span></span>
<span id="cb426-11"><a href="idiomatic-otp.html#cb426-11" tabindex="-1"></a></span>
<span id="cb426-12"><a href="idiomatic-otp.html#cb426-12" tabindex="-1"></a>    %<span class="cn">__MODULE__</span><span class="fu">{</span></span>
<span id="cb426-13"><a href="idiomatic-otp.html#cb426-13" tabindex="-1"></a>      <span class="va">symbol:</span> symbol,</span>
<span id="cb426-14"><a href="idiomatic-otp.html#cb426-14" tabindex="-1"></a>      <span class="va">start_time:</span> start_time,</span>
<span id="cb426-15"><a href="idiomatic-otp.html#cb426-15" tabindex="-1"></a>      <span class="va">duration:</span> duration,</span>
<span id="cb426-16"><a href="idiomatic-otp.html#cb426-16" tabindex="-1"></a>      <span class="va">open:</span> price,</span>
<span id="cb426-17"><a href="idiomatic-otp.html#cb426-17" tabindex="-1"></a>      <span class="va">high:</span> price,</span>
<span id="cb426-18"><a href="idiomatic-otp.html#cb426-18" tabindex="-1"></a>      <span class="va">low:</span> price,</span>
<span id="cb426-19"><a href="idiomatic-otp.html#cb426-19" tabindex="-1"></a>      <span class="va">close:</span> price</span>
<span id="cb426-20"><a href="idiomatic-otp.html#cb426-20" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb426-21"><a href="idiomatic-otp.html#cb426-21" tabindex="-1"></a>  <span class="kw">end</span>  </span></code></pre></div>
<p>Moving up the call chain, besides merging the trade event’s data into OHLC data, we need to deal with the initial state of the worker(the <code>{symbol, duration}</code> tuple). Let’s add a <code>process/2</code> function with two clauses handling each of those cases:</p>
<div class="sourceCode" id="cb427"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb427-1"><a href="idiomatic-otp.html#cb427-1" tabindex="-1"></a><span class="co"># /apps/indicator/lib/indicator/ohlc.ex</span></span>
<span id="cb427-2"><a href="idiomatic-otp.html#cb427-2" tabindex="-1"></a>  <span class="co"># add the below line at the top of the module</span></span>
<span id="cb427-3"><a href="idiomatic-otp.html#cb427-3" tabindex="-1"></a>  <span class="im">alias</span> <span class="cn">Core</span><span class="op">.</span><span class="cn">Struct</span><span class="op">.</span><span class="cn">TradeEvent</span></span>
<span id="cb427-4"><a href="idiomatic-otp.html#cb427-4" tabindex="-1"></a></span>
<span id="cb427-5"><a href="idiomatic-otp.html#cb427-5" tabindex="-1"></a>  <span class="kw">def</span> process<span class="fu">(</span>%<span class="cn">__MODULE__</span><span class="fu">{}</span> <span class="op">=</span> ohlc, %<span class="cn">TradeEvent</span><span class="fu">{}</span> <span class="op">=</span> trade_event<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb427-6"><a href="idiomatic-otp.html#cb427-6" tabindex="-1"></a>    <span class="fu">{</span>old_ohlc, new_ohlc<span class="fu">}</span> <span class="op">=</span> merge_price<span class="fu">(</span>ohlc, trade_event<span class="op">.</span>price, trade_event<span class="op">.</span>trade_time<span class="fu">)</span></span>
<span id="cb427-7"><a href="idiomatic-otp.html#cb427-7" tabindex="-1"></a>    maybe_broadcast<span class="fu">(</span>old_ohlc<span class="fu">)</span></span>
<span id="cb427-8"><a href="idiomatic-otp.html#cb427-8" tabindex="-1"></a>    new_ohlc</span>
<span id="cb427-9"><a href="idiomatic-otp.html#cb427-9" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb427-10"><a href="idiomatic-otp.html#cb427-10" tabindex="-1"></a></span>
<span id="cb427-11"><a href="idiomatic-otp.html#cb427-11" tabindex="-1"></a>  <span class="kw">def</span> process<span class="fu">({</span>symbol, duration<span class="fu">}</span>, %<span class="cn">TradeEvent</span><span class="fu">{}</span> <span class="op">=</span> trade_event<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb427-12"><a href="idiomatic-otp.html#cb427-12" tabindex="-1"></a>    generate_ohlc<span class="fu">(</span>symbol, duration, trade_event<span class="op">.</span>price, trade_event<span class="op">.</span>trade_time<span class="fu">)</span></span>
<span id="cb427-13"><a href="idiomatic-otp.html#cb427-13" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>The second clause takes care of the initial state of the OHLC worker(happens upon receiving the first trade event - once in the lifetime of the worker process).</p>
<p>The first clause handles all the other trade events.</p>
<p>This order of clauses could appear weird, but it makes a lot of sense as Elixir will try pattern match clauses from the top, and in our case, the first(top) clause will be used for almost all of the calls.</p>
<div id="maybe-functions" class="section level3 hasAnchor" number="19.3.1">
<h3><span class="header-section-number">19.3.1</span> Maybe functions<a href="idiomatic-otp.html#maybe-functions" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Let’s get back to the first clause of the <code>process/2</code> function as it uses another Elixir/Erlang pattern that we didn’t discuss before - the <code>maybe_do_x</code> functions.</p>
<p>In case of the incoming trade event’s <code>trade_time</code> <strong>outside</strong> of the current OHLC’s timeframe, we would like to <strong>broadcast</strong> the current OHLC and return a new OHLC(based on the trade event’s data). Otherwise(trade event’s <code>trade_time</code> <strong>within</strong> the current OHLC), the trade event’s <code>price</code> is merged into the current OHLC, and it’s <strong>not</strong> broadcasted.</p>
<p>This sounds very similar to the if-else, but it’s most of the time achieved using the pattern matching:</p>
<div class="sourceCode" id="cb428"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb428-1"><a href="idiomatic-otp.html#cb428-1" tabindex="-1"></a><span class="co"># /apps/indicator/lib/indicator/ohlc.ex</span></span>
<span id="cb428-2"><a href="idiomatic-otp.html#cb428-2" tabindex="-1"></a> <span class="co"># add below lines at the top of the module</span></span>
<span id="cb428-3"><a href="idiomatic-otp.html#cb428-3" tabindex="-1"></a> <span class="im">require</span> <span class="cn">Logger</span></span>
<span id="cb428-4"><a href="idiomatic-otp.html#cb428-4" tabindex="-1"></a></span>
<span id="cb428-5"><a href="idiomatic-otp.html#cb428-5" tabindex="-1"></a> <span class="ot">@pubsub_client</span> <span class="cn">Application</span><span class="op">.</span>compile_env<span class="fu">(</span><span class="va">:core</span>, <span class="va">:pubsub_client</span><span class="fu">)</span></span>
<span id="cb428-6"><a href="idiomatic-otp.html#cb428-6" tabindex="-1"></a></span>
<span id="cb428-7"><a href="idiomatic-otp.html#cb428-7" tabindex="-1"></a>  <span class="kw">defp</span> maybe_broadcast<span class="fu">(</span><span class="cn">nil</span><span class="fu">)</span>, <span class="va">do:</span> <span class="va">:ok</span></span>
<span id="cb428-8"><a href="idiomatic-otp.html#cb428-8" tabindex="-1"></a></span>
<span id="cb428-9"><a href="idiomatic-otp.html#cb428-9" tabindex="-1"></a>  <span class="kw">defp</span> maybe_broadcast<span class="fu">(</span>%<span class="cn">__MODULE__</span><span class="fu">{}</span> <span class="op">=</span> ohlc<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb428-10"><a href="idiomatic-otp.html#cb428-10" tabindex="-1"></a>    <span class="cn">Logger</span><span class="op">.</span>debug<span class="fu">(</span><span class="st">&quot;Broadcasting OHLC: </span><span class="ot">#{</span>inspect<span class="fu">(</span>ohlc<span class="fu">)</span><span class="ot">}</span><span class="st">&quot;</span><span class="fu">)</span></span>
<span id="cb428-11"><a href="idiomatic-otp.html#cb428-11" tabindex="-1"></a></span>
<span id="cb428-12"><a href="idiomatic-otp.html#cb428-12" tabindex="-1"></a>    <span class="ot">@pubsub_client</span><span class="op">.</span>broadcast<span class="fu">(</span></span>
<span id="cb428-13"><a href="idiomatic-otp.html#cb428-13" tabindex="-1"></a>      <span class="cn">Core</span><span class="op">.</span><span class="cn">PubSub</span>,</span>
<span id="cb428-14"><a href="idiomatic-otp.html#cb428-14" tabindex="-1"></a>      <span class="st">&quot;OHLC:</span><span class="ot">#{</span>ohlc<span class="op">.</span>symbol<span class="ot">}</span><span class="st">&quot;</span>,</span>
<span id="cb428-15"><a href="idiomatic-otp.html#cb428-15" tabindex="-1"></a>      ohlc</span>
<span id="cb428-16"><a href="idiomatic-otp.html#cb428-16" tabindex="-1"></a>    <span class="fu">)</span></span>
<span id="cb428-17"><a href="idiomatic-otp.html#cb428-17" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>By using a separate function, we avoided branching using if-else inside the <code>process/2</code> function. The idea is not necessarily to avoid if statements but to keep the code at the consistent level of abstraction, so it’s easier to understand. Inside the <code>process/2</code> function, we can understand what’s going on just by reading the function names inside - there’s no “logic”.</p>
<p>Sometimes people advise that “code should be like well written prose” and <code>maybe_do_x</code> functions are one of the ways to achieve this “nirvana” state.</p>
</div>
<div id="testing" class="section level3 hasAnchor" number="19.3.2">
<h3><span class="header-section-number">19.3.2</span> Testing<a href="idiomatic-otp.html#testing" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>At this moment, our code should compile, and we should already be able to test it. First, let’s change the logging level to <code>debug</code> inside <code>config/config.exs</code> to see what OHLC structs got broadcasted:</p>
<div class="sourceCode" id="cb429"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb429-1"><a href="idiomatic-otp.html#cb429-1" tabindex="-1"></a><span class="co"># /config/config.exs</span></span>
<span id="cb429-2"><a href="idiomatic-otp.html#cb429-2" tabindex="-1"></a>config <span class="va">:logger</span>,</span>
<span id="cb429-3"><a href="idiomatic-otp.html#cb429-3" tabindex="-1"></a>  <span class="va">level:</span> <span class="va">:debug</span> <span class="co"># &lt;= updated</span></span></code></pre></div>
<p>We can now progress with testing:</p>
<div class="sourceCode" id="cb430"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb430-1"><a href="idiomatic-otp.html#cb430-1" tabindex="-1"></a><span class="ex">$</span> iex <span class="at">-S</span> mix</span>
<span id="cb430-2"><a href="idiomatic-otp.html#cb430-2" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">1</span><span class="kw">)</span><span class="op">&gt;</span> Streamer.start_streaming<span class="kw">(</span><span class="st">&quot;XRPUSDT&quot;</span><span class="kw">)</span></span>
<span id="cb430-3"><a href="idiomatic-otp.html#cb430-3" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb430-4"><a href="idiomatic-otp.html#cb430-4" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">2</span><span class="kw">)</span><span class="op">&gt;</span> Indicator.Ohlc.Worker.start_link<span class="kw">(</span><span class="ex">{</span><span class="st">&quot;XRPUSDT&quot;</span><span class="ex">,</span> 1}<span class="kw">)</span></span>
<span id="cb430-5"><a href="idiomatic-otp.html#cb430-5" tabindex="-1"></a><span class="ex">{:ok,</span> <span class="co">#PID&lt;0.447.0&gt;}</span></span>
<span id="cb430-6"><a href="idiomatic-otp.html#cb430-6" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb430-7"><a href="idiomatic-otp.html#cb430-7" tabindex="-1"></a><span class="ex">22:45:00.335</span> <span class="pp">[</span><span class="ss">debug</span><span class="pp">]</span> Broadcasting OHLC: %Indicator.Ohlc{close: <span class="st">&quot;0.63880000&quot;</span>, duration: 1,</span>
<span id="cb430-8"><a href="idiomatic-otp.html#cb430-8" tabindex="-1"></a><span class="ex">high:</span> <span class="st">&quot;0.63890000&quot;</span>, low: <span class="st">&quot;0.63840000&quot;</span>, open: <span class="st">&quot;0.63860000&quot;</span>, start_time: 1644014640,</span>
<span id="cb430-9"><a href="idiomatic-otp.html#cb430-9" tabindex="-1"></a><span class="ex">symbol:</span> <span class="st">&quot;XRPUSDT&quot;</span>}</span></code></pre></div>
<p>The above test confirms that we can manually start a single OHLC worker that will aggregate data over a single minute timeframe.</p>
</div>
<div id="supervision" class="section level3 hasAnchor" number="19.3.3">
<h3><span class="header-section-number">19.3.3</span> Supervision<a href="idiomatic-otp.html#supervision" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>To supervise multiple <code>Indicators.Worker</code>s we will use the <code>DynamicSupervisor</code>.
We need to update the Indicators application’s supervision tree to start a dynamic supervisor:</p>
<div class="sourceCode" id="cb431"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb431-1"><a href="idiomatic-otp.html#cb431-1" tabindex="-1"></a><span class="co"># /apps/indicator/lib/indicator/application.ex</span></span>
<span id="cb431-2"><a href="idiomatic-otp.html#cb431-2" tabindex="-1"></a>    children <span class="op">=</span> <span class="ot">[</span></span>
<span id="cb431-3"><a href="idiomatic-otp.html#cb431-3" tabindex="-1"></a>      <span class="fu">{</span><span class="cn">DynamicSupervisor</span>, <span class="va">strategy:</span> <span class="va">:one_for_one</span>, <span class="va">name:</span> <span class="cn">Indicator</span><span class="op">.</span><span class="cn">DynamicSupervisor</span><span class="fu">}</span></span>
<span id="cb431-4"><a href="idiomatic-otp.html#cb431-4" tabindex="-1"></a>    <span class="ot">]</span></span></code></pre></div>
<div style="page-break-after: always;"></div>
<p>We can now add <code>aggregate_ohlcs/1</code> function that will start all workers:</p>
<div class="sourceCode" id="cb432"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb432-1"><a href="idiomatic-otp.html#cb432-1" tabindex="-1"></a><span class="co"># /apps/indicator/lib/indicator.ex</span></span>
<span id="cb432-2"><a href="idiomatic-otp.html#cb432-2" tabindex="-1"></a>  <span class="kw">def</span> aggregate_ohlcs<span class="fu">(</span>symbol<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb432-3"><a href="idiomatic-otp.html#cb432-3" tabindex="-1"></a>    <span class="ot">[</span><span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">15</span>, <span class="dv">60</span>, <span class="dv">4</span> <span class="op">*</span> <span class="dv">60</span>, <span class="dv">24</span> <span class="op">*</span> <span class="dv">60</span><span class="ot">]</span></span>
<span id="cb432-4"><a href="idiomatic-otp.html#cb432-4" tabindex="-1"></a>    <span class="op">|&gt;</span> <span class="cn">Enum</span><span class="op">.</span>each<span class="fu">(</span></span>
<span id="cb432-5"><a href="idiomatic-otp.html#cb432-5" tabindex="-1"></a>      <span class="op">&amp;</span><span class="cn">DynamicSupervisor</span><span class="op">.</span>start_child<span class="fu">(</span></span>
<span id="cb432-6"><a href="idiomatic-otp.html#cb432-6" tabindex="-1"></a>        <span class="cn">Indicator</span><span class="op">.</span><span class="cn">DynamicSupervisor</span>,</span>
<span id="cb432-7"><a href="idiomatic-otp.html#cb432-7" tabindex="-1"></a>        <span class="fu">{</span><span class="cn">Indicator</span><span class="op">.</span><span class="cn">Ohlc</span><span class="op">.</span><span class="cn">Worker</span>, <span class="fu">{</span>symbol, <span class="op">&amp;</span><span class="dv">1</span><span class="fu">}}</span></span>
<span id="cb432-8"><a href="idiomatic-otp.html#cb432-8" tabindex="-1"></a>      <span class="fu">)</span></span>
<span id="cb432-9"><a href="idiomatic-otp.html#cb432-9" tabindex="-1"></a>    <span class="fu">)</span></span>
<span id="cb432-10"><a href="idiomatic-otp.html#cb432-10" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>We can now start multiple OHLC workers just by running a single function:</p>
<div class="sourceCode" id="cb433"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb433-1"><a href="idiomatic-otp.html#cb433-1" tabindex="-1"></a><span class="ex">$</span> iex <span class="at">-S</span> mix</span>
<span id="cb433-2"><a href="idiomatic-otp.html#cb433-2" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">1</span><span class="kw">)</span><span class="op">&gt;</span> Streamer.start_streaming<span class="kw">(</span><span class="st">&quot;XRPUSDT&quot;</span><span class="kw">)</span></span>
<span id="cb433-3"><a href="idiomatic-otp.html#cb433-3" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb433-4"><a href="idiomatic-otp.html#cb433-4" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">2</span><span class="kw">)</span><span class="op">&gt;</span> Indicator.aggregate_ohlcs<span class="kw">(</span><span class="st">&quot;XRPUSDT&quot;</span><span class="kw">)</span></span>
<span id="cb433-5"><a href="idiomatic-otp.html#cb433-5" tabindex="-1"></a><span class="ex">{:ok,</span> <span class="co">#PID&lt;0.447.0&gt;}</span></span></code></pre></div>
<p>The above calls will start six OHLC worker processes supervised under the <code>Indicator.DynamicSupervisor</code> process.</p>
<p>We could continue with this exercise, add a Registry to be able to stop the indicators and a database to be able to autostart them. Those improvements would get the “indicators” application in line with the other applications, but that’s not the goal of this chapter.</p>
</div>
</div>
<div id="idiomatic-solution" class="section level2 hasAnchor" number="19.4">
<h2><span class="header-section-number">19.4</span> Idiomatic solution<a href="idiomatic-otp.html#idiomatic-solution" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>What we will focus on is the <strong>usage</strong> of processes(in our case the GenServers) in our solution. We’ve split our logic between multiple processes, each aggregating a single timeframe. All of those processes work in the same way. They subscribe to the PubSub topic, merge the incoming data into OHLC structs, and potentially broadcast them. The only difference is the timeframe that they use for merging data.</p>
<p>The solution feels very clean, but also we are using multiple processes to aggregate data for each symbol. In a situation like this, we should always ask ourselves:</p>
<ul>
<li>do we need that many processes?</li>
<li>are we using them to achieve parallelism? Is it required?</li>
<li>could we reorganize our code to use fewer processes?</li>
</ul>
<p>The main idea is to keep our code as simple as possible and only use processes when it’s absolutely required.</p>
<div style="page-break-after: always;"></div>
<p>Instead of a single worker being responsible for aggregation within a single timeframe, we could restructure our code to make it responsible for all timeframes of the symbol.</p>
<p>This improvement would:</p>
<ul>
<li>make our merging code a little bit complex(it would merge multiple timeframes at once)</li>
<li>decrease the amount of PubSub subscribers by six (instead of six processes per symbol, we would have just one)</li>
<li>potentially decrease the amount of broadcasted messages (we could group OHLC structs into a single message)</li>
<li>allow a single worker single worker to decide what to do with all current OHLCs in case of errors, <strong>without</strong> need for any additional symbol supervision level(like <code>one_for_all</code>)</li>
<li>make it <strong>impossible</strong> to aggregate nor broadcast OHLCS of the same symbol in <strong>parallel</strong></li>
</ul>
<p>We can see that the solution based on processes could get really complex really quickly(multiple processes per symbol, growing supervision tree, multiple subscriptions, multiple messages etc).</p>
<p>Just to be clear - processes <strong>do</strong> have their place, they are a really powerful tool, but as with every tool, the responsibility lies on us developers to use them wisely - they <strong>must not</strong> be used for code organization.</p>
<p>Enough theory - let’s look into how we could update our <code>Indicator.Ohlc</code> module to be able to deal with multiple timeframes at once.</p>
<p>Initially, we could be tempted to update the <code>process/2</code> function:</p>
<div class="sourceCode" id="cb434"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb434-1"><a href="idiomatic-otp.html#cb434-1" tabindex="-1"></a><span class="co"># /apps/indicator/lib/indicator.ex</span></span>
<span id="cb434-2"><a href="idiomatic-otp.html#cb434-2" tabindex="-1"></a>  <span class="kw">def</span> process<span class="fu">(</span><span class="ot">[</span>_ <span class="op">|</span> _<span class="ot">]</span> <span class="op">=</span> ohlcs, %<span class="cn">TradeEvent</span><span class="fu">{}</span> <span class="op">=</span> trade_event<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb434-3"><a href="idiomatic-otp.html#cb434-3" tabindex="-1"></a>    results <span class="op">=</span></span>
<span id="cb434-4"><a href="idiomatic-otp.html#cb434-4" tabindex="-1"></a>      ohlcs</span>
<span id="cb434-5"><a href="idiomatic-otp.html#cb434-5" tabindex="-1"></a>      <span class="op">|&gt;</span> <span class="cn">Enum</span><span class="op">.</span>map<span class="fu">(</span><span class="op">&amp;</span>merge_price<span class="fu">(</span><span class="op">&amp;</span><span class="dv">1</span>, trade_event<span class="op">.</span>price, trade_event<span class="op">.</span>trade_time<span class="fu">))</span></span>
<span id="cb434-6"><a href="idiomatic-otp.html#cb434-6" tabindex="-1"></a></span>
<span id="cb434-7"><a href="idiomatic-otp.html#cb434-7" tabindex="-1"></a>    results <span class="op">|&gt;</span> <span class="cn">Enum</span><span class="op">.</span>map<span class="fu">(</span><span class="op">&amp;</span>maybe_broadcast<span class="fu">(</span>elem<span class="fu">(</span><span class="op">&amp;</span><span class="dv">1</span>, <span class="dv">0</span><span class="fu">)))</span></span>
<span id="cb434-8"><a href="idiomatic-otp.html#cb434-8" tabindex="-1"></a>    results <span class="op">|&gt;</span> <span class="cn">Enum</span><span class="op">.</span>map<span class="fu">(</span><span class="op">&amp;</span>elem<span class="fu">(</span><span class="op">&amp;</span><span class="dv">1</span>, <span class="dv">1</span><span class="fu">))</span></span>
<span id="cb434-9"><a href="idiomatic-otp.html#cb434-9" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb434-10"><a href="idiomatic-otp.html#cb434-10" tabindex="-1"></a></span>
<span id="cb434-11"><a href="idiomatic-otp.html#cb434-11" tabindex="-1"></a>  <span class="kw">def</span> process<span class="fu">(</span>symbol, %<span class="cn">TradeEvent</span><span class="fu">{}</span> <span class="op">=</span> trade_event<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb434-12"><a href="idiomatic-otp.html#cb434-12" tabindex="-1"></a>    <span class="ot">[</span><span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">15</span>, <span class="dv">60</span>, <span class="dv">4</span> <span class="op">*</span> <span class="dv">60</span>, <span class="dv">24</span> <span class="op">*</span> <span class="dv">60</span><span class="ot">]</span></span>
<span id="cb434-13"><a href="idiomatic-otp.html#cb434-13" tabindex="-1"></a>    <span class="op">|&gt;</span> <span class="cn">Enum</span><span class="op">.</span>map<span class="fu">(</span></span>
<span id="cb434-14"><a href="idiomatic-otp.html#cb434-14" tabindex="-1"></a>      <span class="op">&amp;</span>generate_ohlc<span class="fu">(</span></span>
<span id="cb434-15"><a href="idiomatic-otp.html#cb434-15" tabindex="-1"></a>        symbol,</span>
<span id="cb434-16"><a href="idiomatic-otp.html#cb434-16" tabindex="-1"></a>        <span class="op">&amp;</span><span class="dv">1</span>,</span>
<span id="cb434-17"><a href="idiomatic-otp.html#cb434-17" tabindex="-1"></a>        trade_event<span class="op">.</span>price,</span>
<span id="cb434-18"><a href="idiomatic-otp.html#cb434-18" tabindex="-1"></a>        trade_event<span class="op">.</span>trade_time</span>
<span id="cb434-19"><a href="idiomatic-otp.html#cb434-19" tabindex="-1"></a>      <span class="fu">)</span></span>
<span id="cb434-20"><a href="idiomatic-otp.html#cb434-20" tabindex="-1"></a>    <span class="fu">)</span></span>
<span id="cb434-21"><a href="idiomatic-otp.html#cb434-21" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>We added some logic to both clauses. At this moment, it maybe doesn’t look that bad, but it’s a great place to mix even more logic with dirty code. This is a great example where we should stop and rethink how we could maximize the amount of pure code.</p>
<p>Instead of expanding the <code>process/2</code> function, we could built on top of the <code>merge_price/3</code> and <code>generate_ohlc/4</code> functions, which deal with a single OHLC data. We could add plural versions of those functions that will understand that we now deal with multiple OHLC structs:</p>
<div class="sourceCode" id="cb435"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb435-1"><a href="idiomatic-otp.html#cb435-1" tabindex="-1"></a><span class="co"># /apps/indicator/lib/indicator.ex</span></span>
<span id="cb435-2"><a href="idiomatic-otp.html#cb435-2" tabindex="-1"></a>  <span class="kw">def</span> merge_prices<span class="fu">(</span>ohlcs, price, trade_time<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb435-3"><a href="idiomatic-otp.html#cb435-3" tabindex="-1"></a>    results <span class="op">=</span></span>
<span id="cb435-4"><a href="idiomatic-otp.html#cb435-4" tabindex="-1"></a>      ohlcs</span>
<span id="cb435-5"><a href="idiomatic-otp.html#cb435-5" tabindex="-1"></a>      <span class="op">|&gt;</span> <span class="cn">Enum</span><span class="op">.</span>map<span class="fu">(</span><span class="op">&amp;</span>merge_price<span class="fu">(</span><span class="op">&amp;</span><span class="dv">1</span>, price, trade_time<span class="fu">))</span></span>
<span id="cb435-6"><a href="idiomatic-otp.html#cb435-6" tabindex="-1"></a></span>
<span id="cb435-7"><a href="idiomatic-otp.html#cb435-7" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb435-8"><a href="idiomatic-otp.html#cb435-8" tabindex="-1"></a>      results <span class="op">|&gt;</span> <span class="cn">Enum</span><span class="op">.</span>map<span class="fu">(</span><span class="op">&amp;</span>elem<span class="fu">(</span><span class="op">&amp;</span><span class="dv">1</span>, <span class="dv">0</span><span class="fu">))</span> <span class="op">|&gt;</span> <span class="cn">Enum</span><span class="op">.</span>filter<span class="fu">(</span><span class="op">&amp;</span> <span class="op">&amp;</span><span class="dv">1</span><span class="fu">)</span>,</span>
<span id="cb435-9"><a href="idiomatic-otp.html#cb435-9" tabindex="-1"></a>      results <span class="op">|&gt;</span> <span class="cn">Enum</span><span class="op">.</span>map<span class="fu">(</span><span class="op">&amp;</span>elem<span class="fu">(</span><span class="op">&amp;</span><span class="dv">1</span>, <span class="dv">1</span><span class="fu">))</span></span>
<span id="cb435-10"><a href="idiomatic-otp.html#cb435-10" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb435-11"><a href="idiomatic-otp.html#cb435-11" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb435-12"><a href="idiomatic-otp.html#cb435-12" tabindex="-1"></a></span>
<span id="cb435-13"><a href="idiomatic-otp.html#cb435-13" tabindex="-1"></a>  <span class="kw">def</span> generate_ohlcs<span class="fu">(</span>symbol, price, trade_time<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb435-14"><a href="idiomatic-otp.html#cb435-14" tabindex="-1"></a>    <span class="ot">[</span><span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">15</span>, <span class="dv">60</span>, <span class="dv">4</span> <span class="op">*</span> <span class="dv">60</span>, <span class="dv">24</span> <span class="op">*</span> <span class="dv">60</span><span class="ot">]</span></span>
<span id="cb435-15"><a href="idiomatic-otp.html#cb435-15" tabindex="-1"></a>    <span class="op">|&gt;</span> <span class="cn">Enum</span><span class="op">.</span>map<span class="fu">(</span></span>
<span id="cb435-16"><a href="idiomatic-otp.html#cb435-16" tabindex="-1"></a>      <span class="op">&amp;</span>generate_ohlc<span class="fu">(</span></span>
<span id="cb435-17"><a href="idiomatic-otp.html#cb435-17" tabindex="-1"></a>        symbol,</span>
<span id="cb435-18"><a href="idiomatic-otp.html#cb435-18" tabindex="-1"></a>        <span class="op">&amp;</span><span class="dv">1</span>,</span>
<span id="cb435-19"><a href="idiomatic-otp.html#cb435-19" tabindex="-1"></a>        price,</span>
<span id="cb435-20"><a href="idiomatic-otp.html#cb435-20" tabindex="-1"></a>        trade_time</span>
<span id="cb435-21"><a href="idiomatic-otp.html#cb435-21" tabindex="-1"></a>      <span class="fu">)</span></span>
<span id="cb435-22"><a href="idiomatic-otp.html#cb435-22" tabindex="-1"></a>    <span class="fu">)</span></span>
<span id="cb435-23"><a href="idiomatic-otp.html#cb435-23" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>Now the <code>process/2</code> function got back to its almost original shape:</p>
<div class="sourceCode" id="cb436"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb436-1"><a href="idiomatic-otp.html#cb436-1" tabindex="-1"></a>  <span class="kw">def</span> process<span class="fu">(</span><span class="ot">[</span>_ <span class="op">|</span> _<span class="ot">]</span> <span class="op">=</span> ohlcs, %<span class="cn">TradeEvent</span><span class="fu">{}</span> <span class="op">=</span> trade_event<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb436-2"><a href="idiomatic-otp.html#cb436-2" tabindex="-1"></a>    <span class="fu">{</span>old_ohlcs, new_ohlcs<span class="fu">}</span> <span class="op">=</span> merge_prices<span class="fu">(</span>ohlcs, trade_event<span class="op">.</span>price, trade_event<span class="op">.</span>trade_time<span class="fu">)</span></span>
<span id="cb436-3"><a href="idiomatic-otp.html#cb436-3" tabindex="-1"></a></span>
<span id="cb436-4"><a href="idiomatic-otp.html#cb436-4" tabindex="-1"></a>    old_ohlcs <span class="op">|&gt;</span> <span class="cn">Enum</span><span class="op">.</span>each<span class="fu">(</span><span class="op">&amp;</span>maybe_broadcast<span class="op">/</span><span class="dv">1</span><span class="fu">)</span></span>
<span id="cb436-5"><a href="idiomatic-otp.html#cb436-5" tabindex="-1"></a>    new_ohlcs</span>
<span id="cb436-6"><a href="idiomatic-otp.html#cb436-6" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb436-7"><a href="idiomatic-otp.html#cb436-7" tabindex="-1"></a></span>
<span id="cb436-8"><a href="idiomatic-otp.html#cb436-8" tabindex="-1"></a>  <span class="kw">def</span> process<span class="fu">(</span>symbol, %<span class="cn">TradeEvent</span><span class="fu">{}</span> <span class="op">=</span> trade_event<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb436-9"><a href="idiomatic-otp.html#cb436-9" tabindex="-1"></a>    generate_ohlcs<span class="fu">(</span>symbol, trade_event<span class="op">.</span>price, trade_event<span class="op">.</span>trade_time<span class="fu">)</span></span>
<span id="cb436-10"><a href="idiomatic-otp.html#cb436-10" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>By introducing the <code>merge_prices/3</code> and <code>generate_ohlcs/3</code> functions, we were able to keep the dirty part of our code small(it grew only to accommodate multiple broadcasts). The new functions are pure and can be easily tested.</p>
<p>As we modified the interface of the <code>process/2</code> function (by removing the <code>duration</code>), we need to update the <code>Indicator.Ohlc.Worker</code> module to be blissfully not aware that we have different durations:</p>
<div class="sourceCode" id="cb437"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb437-1"><a href="idiomatic-otp.html#cb437-1" tabindex="-1"></a><span class="co"># /apps/indicator/lib/indicator/ohlc/worker.ex</span></span>
<span id="cb437-2"><a href="idiomatic-otp.html#cb437-2" tabindex="-1"></a>  <span class="kw">def</span> start_link<span class="fu">(</span>symbol<span class="fu">)</span> <span class="kw">do</span> <span class="co"># &lt;= duration removed</span></span>
<span id="cb437-3"><a href="idiomatic-otp.html#cb437-3" tabindex="-1"></a>    <span class="cn">GenServer</span><span class="op">.</span>start_link<span class="fu">(</span><span class="cn">__MODULE__</span>, symbol<span class="fu">)</span>  <span class="co"># &lt;= duration removed</span></span>
<span id="cb437-4"><a href="idiomatic-otp.html#cb437-4" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb437-5"><a href="idiomatic-otp.html#cb437-5" tabindex="-1"></a></span>
<span id="cb437-6"><a href="idiomatic-otp.html#cb437-6" tabindex="-1"></a>  <span class="kw">def</span> init<span class="fu">(</span>symbol<span class="fu">)</span> <span class="kw">do</span>  <span class="co"># &lt;= duration removed</span></span>
<span id="cb437-7"><a href="idiomatic-otp.html#cb437-7" tabindex="-1"></a>    symbol <span class="op">=</span> <span class="cn">String</span><span class="op">.</span>upcase<span class="fu">(</span>symbol<span class="fu">)</span></span>
<span id="cb437-8"><a href="idiomatic-otp.html#cb437-8" tabindex="-1"></a></span>
<span id="cb437-9"><a href="idiomatic-otp.html#cb437-9" tabindex="-1"></a>    <span class="ot">@logger</span><span class="op">.</span>debug<span class="fu">(</span><span class="st">&quot;Initializing new a OHLC worker for </span><span class="ot">#{</span>symbol<span class="ot">}</span><span class="st">&quot;</span><span class="fu">)</span> <span class="co"># &lt;= duration skipped</span></span>
<span id="cb437-10"><a href="idiomatic-otp.html#cb437-10" tabindex="-1"></a></span>
<span id="cb437-11"><a href="idiomatic-otp.html#cb437-11" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb437-12"><a href="idiomatic-otp.html#cb437-12" tabindex="-1"></a></span>
<span id="cb437-13"><a href="idiomatic-otp.html#cb437-13" tabindex="-1"></a>    <span class="fu">{</span><span class="va">:ok</span>, symbol<span class="fu">}</span>  <span class="co"># &lt;= duration removed</span></span>
<span id="cb437-14"><a href="idiomatic-otp.html#cb437-14" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>The final update will be to simplify the <code>Indicator.aggregate_ohlcs/1</code> function just to start a single OHLC worker:</p>
<div class="sourceCode" id="cb438"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb438-1"><a href="idiomatic-otp.html#cb438-1" tabindex="-1"></a><span class="co"># /apps/indicator/lib/indicator.ex</span></span>
<span id="cb438-2"><a href="idiomatic-otp.html#cb438-2" tabindex="-1"></a>  <span class="kw">def</span> aggregate_ohlcs<span class="fu">(</span>symbol<span class="fu">)</span> <span class="kw">do</span></span>
<span id="cb438-3"><a href="idiomatic-otp.html#cb438-3" tabindex="-1"></a>    <span class="cn">DynamicSupervisor</span><span class="op">.</span>start_child<span class="fu">(</span></span>
<span id="cb438-4"><a href="idiomatic-otp.html#cb438-4" tabindex="-1"></a>      <span class="cn">Indicator</span><span class="op">.</span><span class="cn">DynamicSupervisor</span>,</span>
<span id="cb438-5"><a href="idiomatic-otp.html#cb438-5" tabindex="-1"></a>      <span class="fu">{</span><span class="cn">Indicator</span><span class="op">.</span><span class="cn">Ohlc</span><span class="op">.</span><span class="cn">Worker</span>, symbol<span class="fu">}</span></span>
<span id="cb438-6"><a href="idiomatic-otp.html#cb438-6" tabindex="-1"></a>    <span class="fu">)</span></span>
<span id="cb438-7"><a href="idiomatic-otp.html#cb438-7" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>We can now test our implementation by running the following once again:</p>
<div class="sourceCode" id="cb439"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb439-1"><a href="idiomatic-otp.html#cb439-1" tabindex="-1"></a><span class="ex">$</span> iex <span class="at">-S</span> mix</span>
<span id="cb439-2"><a href="idiomatic-otp.html#cb439-2" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">1</span><span class="kw">)</span><span class="op">&gt;</span> Streamer.start_streaming<span class="kw">(</span><span class="st">&quot;XRPUSDT&quot;</span><span class="kw">)</span></span>
<span id="cb439-3"><a href="idiomatic-otp.html#cb439-3" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb439-4"><a href="idiomatic-otp.html#cb439-4" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">2</span><span class="kw">)</span><span class="op">&gt;</span> Indicator.Ohlc.Worker.start_link<span class="kw">(</span><span class="st">&quot;XRPUSDT&quot;</span><span class="kw">)</span></span>
<span id="cb439-5"><a href="idiomatic-otp.html#cb439-5" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb439-6"><a href="idiomatic-otp.html#cb439-6" tabindex="-1"></a><span class="ex">23:23:00.416</span> <span class="pp">[</span><span class="ss">info</span><span class="pp">]</span>  Broadcasting OHLC: %Indicator.Ohlc{close: <span class="st">&quot;0.68230000&quot;</span>, duration: 1,</span>
<span id="cb439-7"><a href="idiomatic-otp.html#cb439-7" tabindex="-1"></a><span class="ex">high:</span> <span class="st">&quot;0.68330000&quot;</span>, low: <span class="st">&quot;0.68130000&quot;</span>, open: <span class="st">&quot;0.68160000&quot;</span>, start_time: 1644189720,</span>
<span id="cb439-8"><a href="idiomatic-otp.html#cb439-8" tabindex="-1"></a><span class="ex">symbol:</span> <span class="st">&quot;XRPUSDT&quot;</span>}</span></code></pre></div>
<p>The logged message(s) confirms that our OHLC aggregator logic works as expected using a single process.</p>
<p>In the case of the OHLC aggregator, we’ve seen that there are some trade-off between running multiple processes(simpler code) vs single process(more complex merging) - it could be unclear what’s the benefit of limiting the usage of processes(especially that they are “almost free”).</p>
<p>I totally understand. Please treat this chapter as an introduction to the idiomatic Elixir. In the next chapter, we will apply this concept when refactoring the Naive trading strategy to see its practical benefits.</p>
<p>[Note] Please remember to run the <code>mix format</code> to keep things nice and tidy.</p>
<p>The source code for this chapter can be found on <a href="https://github.com/Cinderella-Man/hands-on-elixir-and-otp-cryptocurrency-trading-bot-source-code/tree/chapter_19">GitHub</a></p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="functional-elixir.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="idiomatic-trading-strategy.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/Cinderella-Man/hands-on-elixir-and-otp-cryptocurrency-trading-bot/edit/main/19-idiomatic-elixir.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
