<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 14 Store trade events and orders inside the database | Create a cryptocurrency trading bot in Elixir</title>
  <meta name="description" content="Chapter 14 Store trade events and orders inside the database | Create a cryptocurrency trading bot in Elixir" />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 14 Store trade events and orders inside the database | Create a cryptocurrency trading bot in Elixir" />
  <meta property="og:type" content="book" />
  
  <meta property="og:image" content="images/cover.png" />
  
  <meta name="github-repo" content="frathon/create-a-cryptocurrency-trading-bot-in-elixir" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 14 Store trade events and orders inside the database | Create a cryptocurrency trading bot in Elixir" />
  
  
  <meta name="twitter:image" content="images/cover.png" />

<meta name="author" content="Kamil Skowron" />


<meta name="date" content="2021-04-21" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="abstract-duplicated-supervision-code.html"/>
<link rel="next" href="backtest-trading-strategy.html"/>
<script src="libs/header-attrs-2.7/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-52FKGBX2B8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-52FKGBX2B8');
</script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Create a cryptocurrency trading bot in Elixir</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome üëã</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#limit-of-liabilitydisclaimer-of-warranty"><i class="fa fa-check"></i>Limit of Liability/Disclaimer of Warranty</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#contributing-errata"><i class="fa fa-check"></i>Contributing / Errata</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#preface"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#who-this-book-is-for"><i class="fa fa-check"></i>Who this book is for</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#what-this-book-covers"><i class="fa fa-check"></i>What this book covers</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#source-code"><i class="fa fa-check"></i>Source code</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="stream-live-crypto-prices-from-binance-wss.html"><a href="stream-live-crypto-prices-from-binance-wss.html"><i class="fa fa-check"></i><b>1</b> Stream live crypto prices from Binance WSS</a>
<ul>
<li class="chapter" data-level="1.1" data-path="stream-live-crypto-prices-from-binance-wss.html"><a href="stream-live-crypto-prices-from-binance-wss.html#objectives"><i class="fa fa-check"></i><b>1.1</b> Objectives</a></li>
<li class="chapter" data-level="1.2" data-path="stream-live-crypto-prices-from-binance-wss.html"><a href="stream-live-crypto-prices-from-binance-wss.html#create-an-umbrella-app"><i class="fa fa-check"></i><b>1.2</b> Create an umbrella app</a></li>
<li class="chapter" data-level="1.3" data-path="stream-live-crypto-prices-from-binance-wss.html"><a href="stream-live-crypto-prices-from-binance-wss.html#create-a-supervised-application-inside-an-umbrella"><i class="fa fa-check"></i><b>1.3</b> Create a supervised application inside an umbrella</a></li>
<li class="chapter" data-level="1.4" data-path="stream-live-crypto-prices-from-binance-wss.html"><a href="stream-live-crypto-prices-from-binance-wss.html#connect-to-binances-websocket-stream-using-the-websockex-module"><i class="fa fa-check"></i><b>1.4</b> Connect to Binance‚Äôs WebSocket Stream using the WebSockex module</a></li>
<li class="chapter" data-level="1.5" data-path="stream-live-crypto-prices-from-binance-wss.html"><a href="stream-live-crypto-prices-from-binance-wss.html#decode-incoming-events-using-the-jason-module"><i class="fa fa-check"></i><b>1.5</b> Decode incoming events using the Jason module</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><i class="fa fa-check"></i><b>2</b> Create a naive trading strategy - a single trader process without supervision</a>
<ul>
<li class="chapter" data-level="2.1" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#objectives-1"><i class="fa fa-check"></i><b>2.1</b> Objectives</a></li>
<li class="chapter" data-level="2.2" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#initializiation"><i class="fa fa-check"></i><b>2.2</b> Initializiation</a></li>
<li class="chapter" data-level="2.3" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#how-trading-strategy-will-work"><i class="fa fa-check"></i><b>2.3</b> How trading strategy will work?</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#implementation-of-the-first-scenario"><i class="fa fa-check"></i><b>2.3.1</b> Implementation of the first scenario</a></li>
<li class="chapter" data-level="2.3.2" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#implementation-of-the-second-scenario"><i class="fa fa-check"></i><b>2.3.2</b> Implementation of the second scenario</a></li>
<li class="chapter" data-level="2.3.3" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#implementation-of-the-third-scenario"><i class="fa fa-check"></i><b>2.3.3</b> Implementation of the third scenario</a></li>
<li class="chapter" data-level="2.3.4" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#implementation-fallback-scenario"><i class="fa fa-check"></i><b>2.3.4</b> Implementation fallback scenario</a></li>
<li class="chapter" data-level="2.3.5" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#updating-the-naive-interface"><i class="fa fa-check"></i><b>2.3.5</b> Updating the Naive interface</a></li>
<li class="chapter" data-level="2.3.6" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#updating-streamer-app"><i class="fa fa-check"></i><b>2.3.6</b> Updating streamer app</a></li>
<li class="chapter" data-level="2.3.7" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#access-details-to-binance"><i class="fa fa-check"></i><b>2.3.7</b> Access details to Binance</a></li>
<li class="chapter" data-level="2.3.8" data-path="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html"><a href="create-a-naive-trading-strategy-a-single-trader-process-without-supervision.html#test-run"><i class="fa fa-check"></i><b>2.3.8</b> Test run</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html"><i class="fa fa-check"></i><b>3</b> Introduce PubSub as a communication method</a>
<ul>
<li class="chapter" data-level="3.1" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html#objectives-2"><i class="fa fa-check"></i><b>3.1</b> Objectives</a></li>
<li class="chapter" data-level="3.2" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html#design"><i class="fa fa-check"></i><b>3.2</b> Design</a></li>
<li class="chapter" data-level="3.3" data-path="introduce-pubsub-as-a-communication-method.html"><a href="introduce-pubsub-as-a-communication-method.html#implementation"><i class="fa fa-check"></i><b>3.3</b> Implementation</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html"><i class="fa fa-check"></i><b>4</b> Mock the Binance API</a>
<ul>
<li class="chapter" data-level="4.1" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#objectives-3"><i class="fa fa-check"></i><b>4.1</b> Objectives</a></li>
<li class="chapter" data-level="4.2" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#design-1"><i class="fa fa-check"></i><b>4.2</b> Design</a></li>
<li class="chapter" data-level="4.3" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#create-binancemock-app"><i class="fa fa-check"></i><b>4.3</b> Create ‚ÄúBinanceMock‚Äù app</a></li>
<li class="chapter" data-level="4.4" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-getting-exchange-info"><i class="fa fa-check"></i><b>4.4</b> Implement getting exchange info</a></li>
<li class="chapter" data-level="4.5" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-placing-buy-and-sell-orders"><i class="fa fa-check"></i><b>4.5</b> Implement placing buy and sell orders</a></li>
<li class="chapter" data-level="4.6" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-order-retrival"><i class="fa fa-check"></i><b>4.6</b> Implement order retrival</a></li>
<li class="chapter" data-level="4.7" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#implement-callback-for-incoming-trade-events"><i class="fa fa-check"></i><b>4.7</b> Implement callback for incoming trade events</a></li>
<li class="chapter" data-level="4.8" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#upgrade-trader-and-config"><i class="fa fa-check"></i><b>4.8</b> Upgrade trader and config</a></li>
<li class="chapter" data-level="4.9" data-path="mock-the-binance-api.html"><a href="mock-the-binance-api.html#test-the-implementation"><i class="fa fa-check"></i><b>4.9</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html"><i class="fa fa-check"></i><b>5</b> Enable parallel trading on multiple symbols</a>
<ul>
<li class="chapter" data-level="5.1" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#objectives-4"><i class="fa fa-check"></i><b>5.1</b> Objectives</a></li>
<li class="chapter" data-level="5.2" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#introduction---architectural-design"><i class="fa fa-check"></i><b>5.2</b> Introduction - architectural design</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#update-application-supervisor"><i class="fa fa-check"></i><b>5.2.1</b> Update application supervisor</a></li>
<li class="chapter" data-level="5.2.2" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#add-interface-method"><i class="fa fa-check"></i><b>5.2.2</b> Add interface method</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#implement-naive.symbolsupervisor"><i class="fa fa-check"></i><b>5.3</b> Implement <code>Naive.SymbolSupervisor</code></a></li>
<li class="chapter" data-level="5.4" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#implement-naive.leader"><i class="fa fa-check"></i><b>5.4</b> Implement <code>Naive.Leader</code></a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#updating-the-leader-module"><i class="fa fa-check"></i><b>5.4.1</b> Updating the <code>leader</code> module</a></li>
<li class="chapter" data-level="5.4.2" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#updating-the-naive.trader-module"><i class="fa fa-check"></i><b>5.4.2</b> Updating the <code>Naive.Trader</code> module</a></li>
<li class="chapter" data-level="5.4.3" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#finalizing-naive.leader-implementation"><i class="fa fa-check"></i><b>5.4.3</b> Finalizing <code>Naive.Leader</code> implementation</a></li>
<li class="chapter" data-level="5.4.4" data-path="enable-parallel-trading-on-multiple-symbols.html"><a href="enable-parallel-trading-on-multiple-symbols.html#iex-testing"><i class="fa fa-check"></i><b>5.4.4</b> IEx testing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><a href="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><i class="fa fa-check"></i><b>6</b> # Chapter 6 - Introduce a <code>buy_down_interval</code> to make a single trader more profitable</a>
<ul>
<li class="chapter" data-level="6.1" data-path="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><a href="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html#objectives-5"><i class="fa fa-check"></i><b>6.1</b> Objectives</a></li>
<li class="chapter" data-level="6.2" data-path="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><a href="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html#why-we-need-to-buy-below-the-current-price-feature-overview"><i class="fa fa-check"></i><b>6.2</b> Why we need to buy below the current price? Feature overview</a></li>
<li class="chapter" data-level="6.3" data-path="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><a href="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html#naive.trader-implementation"><i class="fa fa-check"></i><b>6.3</b> <code>Naive.Trader</code> implementation</a></li>
<li class="chapter" data-level="6.4" data-path="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><a href="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html#naive.leader-implementation"><i class="fa fa-check"></i><b>6.4</b> <code>Naive.Leader</code> implementation</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html"><a href="chapter-6-introduce-a-buy-down-interval-to-make-a-single-trader-more-profitable.html#iex-testing-1"><i class="fa fa-check"></i><b>6.4.1</b> IEx testing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html"><i class="fa fa-check"></i><b>7</b> Introduce a trader budget and calculating the quantity</a>
<ul>
<li class="chapter" data-level="7.1" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#objectives-6"><i class="fa fa-check"></i><b>7.1</b> Objectives</a></li>
<li class="chapter" data-level="7.2" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#fetch-step_size"><i class="fa fa-check"></i><b>7.2</b> Fetch <code>step_size</code></a></li>
<li class="chapter" data-level="7.3" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#append-budget-and-step_size-to-the-traders-state-inside-the-leader"><i class="fa fa-check"></i><b>7.3</b> Append <code>budget</code> and <code>step_size</code> to the <code>Trader</code>‚Äôs state inside the <code>Leader</code></a></li>
<li class="chapter" data-level="7.4" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#append-budget-and-step_size-to-the-traders-state"><i class="fa fa-check"></i><b>7.4</b> Append <code>budget</code> and <code>step_size</code> to the <code>Trader</code>‚Äôs state</a></li>
<li class="chapter" data-level="7.5" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#calculate-quantity"><i class="fa fa-check"></i><b>7.5</b> Calculate quantity</a>
<ul>
<li class="chapter" data-level="7.5.1" data-path="introduce-a-trader-budget-and-calculating-the-quantity.html"><a href="introduce-a-trader-budget-and-calculating-the-quantity.html#iex-testing-2"><i class="fa fa-check"></i><b>7.5.1</b> IEx testing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html"><i class="fa fa-check"></i><b>8</b> Add support for multiple transactions per order</a>
<ul>
<li class="chapter" data-level="8.1" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#objectives-7"><i class="fa fa-check"></i><b>8.1</b> Objectives</a></li>
<li class="chapter" data-level="8.2" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#issue-with-the-current-implementation"><i class="fa fa-check"></i><b>8.2</b> Issue with the current implementation</a></li>
<li class="chapter" data-level="8.3" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#improve-buy-order-filled-callback"><i class="fa fa-check"></i><b>8.3</b> Improve buy order filled callback</a></li>
<li class="chapter" data-level="8.4" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#implement-buy-order-filled-callback"><i class="fa fa-check"></i><b>8.4</b> Implement buy order ‚Äúfilled‚Äù callback</a></li>
<li class="chapter" data-level="8.5" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#improve-sell-order-callback"><i class="fa fa-check"></i><b>8.5</b> Improve sell order callback</a></li>
<li class="chapter" data-level="8.6" data-path="add-support-for-multiple-transactions-per-order.html"><a href="add-support-for-multiple-transactions-per-order.html#test-the-implementation-1"><i class="fa fa-check"></i><b>8.6</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html"><i class="fa fa-check"></i><b>9</b> Run multiple traders in parallel</a>
<ul>
<li class="chapter" data-level="9.1" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#objectives-8"><i class="fa fa-check"></i><b>9.1</b> Objectives</a></li>
<li class="chapter" data-level="9.2" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#describe-and-design-the-required-functionality"><i class="fa fa-check"></i><b>9.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="9.3" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#implement-rebuy-inside-naive.trader"><i class="fa fa-check"></i><b>9.3</b> Implement rebuy inside <code>Naive.Trader</code></a></li>
<li class="chapter" data-level="9.4" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#implement-rebuy-in-the-naive.leader"><i class="fa fa-check"></i><b>9.4</b> Implement rebuy in the <code>Naive.Leader</code></a></li>
<li class="chapter" data-level="9.5" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#improve-logs-by-assigning-ids-to-traders"><i class="fa fa-check"></i><b>9.5</b> Improve logs by assigning ids to traders</a></li>
<li class="chapter" data-level="9.6" data-path="run-multiple-traders-in-parallel.html"><a href="run-multiple-traders-in-parallel.html#test-the-implementation-2"><i class="fa fa-check"></i><b>9.6</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html"><i class="fa fa-check"></i><b>10</b> Fine-tune trading strategy per symbol</a>
<ul>
<li class="chapter" data-level="10.1" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#objectives-9"><i class="fa fa-check"></i><b>10.1</b> Objectives</a></li>
<li class="chapter" data-level="10.2" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#describe-and-design-the-required-functionality-1"><i class="fa fa-check"></i><b>10.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="10.3" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#add-docker-to-project"><i class="fa fa-check"></i><b>10.3</b> Add docker to project</a></li>
<li class="chapter" data-level="10.4" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#set-up-ecto-inside-the-naive-app"><i class="fa fa-check"></i><b>10.4</b> Set up <code>ecto</code> inside the <code>naive</code> app</a></li>
<li class="chapter" data-level="10.5" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#create-and-migrate-the-db"><i class="fa fa-check"></i><b>10.5</b> Create and migrate the DB</a></li>
<li class="chapter" data-level="10.6" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#seed-symbols-settings"><i class="fa fa-check"></i><b>10.6</b> Seed symbols‚Äô settings</a></li>
<li class="chapter" data-level="10.7" data-path="fine-tune-trading-strategy-per-symbol.html"><a href="fine-tune-trading-strategy-per-symbol.html#update-the-naive.leader-to-fetch-settings"><i class="fa fa-check"></i><b>10.7</b> Update the <code>Naive.Leader</code> to fetch settings</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html"><i class="fa fa-check"></i><b>11</b> Supervise and autostart streaming</a>
<ul>
<li class="chapter" data-level="11.1" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#objectives-10"><i class="fa fa-check"></i><b>11.1</b> Objectives</a></li>
<li class="chapter" data-level="11.2" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#describe-and-design-the-required-functionality-2"><i class="fa fa-check"></i><b>11.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="11.3" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#register-the-streamer.binance-processes-with-names"><i class="fa fa-check"></i><b>11.3</b> Register the <code>Streamer.Binance</code> processes with names</a></li>
<li class="chapter" data-level="11.4" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#set-up-ecto-inside-the-streamer-app"><i class="fa fa-check"></i><b>11.4</b> Set up <code>ecto</code> inside the <code>streamer</code> app</a></li>
<li class="chapter" data-level="11.5" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#create-and-migrate-the-db-1"><i class="fa fa-check"></i><b>11.5</b> Create and migrate the db</a></li>
<li class="chapter" data-level="11.6" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#seed-default-settings"><i class="fa fa-check"></i><b>11.6</b> Seed default settings</a></li>
<li class="chapter" data-level="11.7" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#implement-the-supervision-tree-and-start-streaming-functionality"><i class="fa fa-check"></i><b>11.7</b> Implement the supervision tree and start streaming functionality</a></li>
<li class="chapter" data-level="11.8" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#implement-the-stop-functionality"><i class="fa fa-check"></i><b>11.8</b> Implement the stop functionality</a></li>
<li class="chapter" data-level="11.9" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#implement-the-autostart-streaming-functionality"><i class="fa fa-check"></i><b>11.9</b> Implement the autostart streaming functionality</a></li>
<li class="chapter" data-level="11.10" data-path="supervise-and-autostart-streaming.html"><a href="supervise-and-autostart-streaming.html#test-the-implementation-3"><i class="fa fa-check"></i><b>11.10</b> Test the implementation</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html"><i class="fa fa-check"></i><b>12</b> Start, stop, shutdown and autostart trading</a>
<ul>
<li class="chapter" data-level="12.1" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#objectives-11"><i class="fa fa-check"></i><b>12.1</b> Objectives</a></li>
<li class="chapter" data-level="12.2" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#describe-and-design-the-required-functionality-3"><i class="fa fa-check"></i><b>12.2</b> Describe and design the required functionality</a></li>
<li class="chapter" data-level="12.3" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#re-implement-the-start-trading-functionality"><i class="fa fa-check"></i><b>12.3</b> (Re-)Implement the start trading functionality</a></li>
<li class="chapter" data-level="12.4" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#implement-the-stop-trading-functionality"><i class="fa fa-check"></i><b>12.4</b> Implement the stop trading functionality</a></li>
<li class="chapter" data-level="12.5" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#implement-the-autostart-trading-functionality"><i class="fa fa-check"></i><b>12.5</b> Implement the autostart trading functionality</a></li>
<li class="chapter" data-level="12.6" data-path="start-stop-shutdown-and-autostart-trading.html"><a href="start-stop-shutdown-and-autostart-trading.html#implement-the-shutdown-trading-functionality"><i class="fa fa-check"></i><b>12.6</b> Implement the shutdown trading functionality</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html"><i class="fa fa-check"></i><b>13</b> Abstract duplicated supervision code</a>
<ul>
<li class="chapter" data-level="13.1" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#objectives-12"><i class="fa fa-check"></i><b>13.1</b> Objectives</a></li>
<li class="chapter" data-level="13.2" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#overview-of-requirements"><i class="fa fa-check"></i><b>13.2</b> Overview of requirements</a></li>
<li class="chapter" data-level="13.3" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#pseudo-generalize-core.servicesupervisor-module"><i class="fa fa-check"></i><b>13.3</b> Pseudo generalize Core.ServiceSupervisor module</a></li>
<li class="chapter" data-level="13.4" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#utilize-pseudo-generalized-code-inside-the-naive.dynamicsymbolsupervisor"><i class="fa fa-check"></i><b>13.4</b> Utilize pseudo generalized code inside the <code>Naive.DynamicSymbolSupervisor</code></a></li>
<li class="chapter" data-level="13.5" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#implement-a-truly-generic-core.servicesupervisor"><i class="fa fa-check"></i><b>13.5</b> Implement a truly generic <code>Core.ServiceSupervisor</code></a>
<ul>
<li class="chapter" data-level="13.5.1" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#first-path-starting-with-the-fetch_symbols_to_start0-function"><i class="fa fa-check"></i><b>13.5.1</b> First path starting with the <code>fetch_symbols_to_start/0</code> function</a></li>
<li class="chapter" data-level="13.5.2" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#second-path-starting-with-the-update_status2"><i class="fa fa-check"></i><b>13.5.2</b> Second path starting with the <code>update_status/2</code></a></li>
<li class="chapter" data-level="13.5.3" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#third-path-starting-with-the-get_pid1-function"><i class="fa fa-check"></i><b>13.5.3</b> Third path starting with the <code>get_pid/1</code> function</a></li>
</ul></li>
<li class="chapter" data-level="13.6" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#remove-boilerplate-using-use-macro"><i class="fa fa-check"></i><b>13.6</b> Remove boilerplate using <code>use</code> macro</a></li>
<li class="chapter" data-level="13.7" data-path="abstract-duplicated-supervision-code.html"><a href="abstract-duplicated-supervision-code.html#use-the-core.servicesupervisor-module-inside-the-streamer-application"><i class="fa fa-check"></i><b>13.7</b> Use the <code>Core.ServiceSupervisor</code> module inside the <code>streamer</code> application</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html"><i class="fa fa-check"></i><b>14</b> Store trade events and orders inside the database</a>
<ul>
<li class="chapter" data-level="14.1" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#objectives-13"><i class="fa fa-check"></i><b>14.1</b> Objectives</a></li>
<li class="chapter" data-level="14.2" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#overview-of-requirements-1"><i class="fa fa-check"></i><b>14.2</b> Overview of requirements</a></li>
<li class="chapter" data-level="14.3" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-a-new-data_warehouse-application-in-the-umbrella"><i class="fa fa-check"></i><b>14.3</b> Create a new <code>data_warehouse</code> application in the umbrella</a></li>
<li class="chapter" data-level="14.4" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#connect-to-the-database-using-ecto"><i class="fa fa-check"></i><b>14.4</b> Connect to the database using Ecto</a></li>
<li class="chapter" data-level="14.5" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#store-trade-events-data"><i class="fa fa-check"></i><b>14.5</b> Store trade events‚Äô data</a></li>
<li class="chapter" data-level="14.6" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#store-orders-data"><i class="fa fa-check"></i><b>14.6</b> Store orders‚Äô data</a></li>
<li class="chapter" data-level="14.7" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#implement-supervision"><i class="fa fa-check"></i><b>14.7</b> Implement supervision</a>
<ul>
<li class="chapter" data-level="14.7.1" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-subscriber_settings-table"><i class="fa fa-check"></i><b>14.7.1</b> Create <code>subscriber_settings</code> table</a></li>
<li class="chapter" data-level="14.7.2" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#redesign-supervision-using-registry"><i class="fa fa-check"></i><b>14.7.2</b> Redesign supervision using Registry</a></li>
<li class="chapter" data-level="14.7.3" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-the-datawarehouse.subscriber.dynamicsupervisor-module"><i class="fa fa-check"></i><b>14.7.3</b> Create the <code>DataWarehouse.Subscriber.DynamicSupervisor</code> module</a></li>
<li class="chapter" data-level="14.7.4" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#register-worker-processes-using-via"><i class="fa fa-check"></i><b>14.7.4</b> Register Worker processes using :via</a></li>
<li class="chapter" data-level="14.7.5" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#create-a-new-supervision-level-for-registry-task-and-the-dynamicsupervisor"><i class="fa fa-check"></i><b>14.7.5</b> Create a new supervision level for Registry, Task and the DynamicSupervisor</a></li>
<li class="chapter" data-level="14.7.6" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#link-the-subscribersupervisor-to-the-application"><i class="fa fa-check"></i><b>14.7.6</b> Link the <code>SubscriberSupervisor</code> to the <code>Application</code></a></li>
<li class="chapter" data-level="14.7.7" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#add-interface"><i class="fa fa-check"></i><b>14.7.7</b> Add interface</a></li>
<li class="chapter" data-level="14.7.8" data-path="store-trade-events-and-orders-inside-the-database.html"><a href="store-trade-events-and-orders-inside-the-database.html#test"><i class="fa fa-check"></i><b>14.7.8</b> Test</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="15" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html"><i class="fa fa-check"></i><b>15</b> Backtest trading strategy</a>
<ul>
<li class="chapter" data-level="15.1" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#objectives-14"><i class="fa fa-check"></i><b>15.1</b> Objectives</a></li>
<li class="chapter" data-level="15.2" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#overview-of-requirements-2"><i class="fa fa-check"></i><b>15.2</b> Overview of requirements</a></li>
<li class="chapter" data-level="15.3" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#implement-the-storing-task"><i class="fa fa-check"></i><b>15.3</b> Implement the storing task</a></li>
<li class="chapter" data-level="15.4" data-path="backtest-trading-strategy.html"><a href="backtest-trading-strategy.html#test-the-backtesting"><i class="fa fa-check"></i><b>15.4</b> Test the backtesting</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://www.bookdown.org/" target="blank">Created with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Create a cryptocurrency trading bot in Elixir</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="store-trade-events-and-orders-inside-the-database" class="section level1" number="14">
<h1><span class="header-section-number">Chapter 14</span> Store trade events and orders inside the database</h1>
<div id="objectives-13" class="section level2" number="14.1">
<h2><span class="header-section-number">14.1</span> Objectives</h2>
<ul>
<li>overview of requirements</li>
<li>create a new <code>data_warehouse</code> application in the umbrella</li>
<li>connect to the database using Ecto</li>
<li>store trade events‚Äô data</li>
<li>store orders‚Äô data</li>
<li>implement supervision</li>
</ul>
</div>
<div id="overview-of-requirements-1" class="section level2" number="14.2">
<h2><span class="header-section-number">14.2</span> Overview of requirements</h2>
<p>In the next chapter, we will move on to testing our strategy against historical data(aka backtesting - I will explain that process in the next chapter). What we need to have in place before we will be able to do that is both trade events and orders stored in the database.</p>
<p>Starting with the trade events. The <code>streamer</code> application could store trade events from Binance inside its database but how would that work if we would like to introduce another source of non-streamed trade events(ie. flat files, HTTP polling). It would be better if the <code>Streamer.Binance</code> process would keep on streaming those trade events as it is and we would create a new application that would subscribe to the existing <code>TRADE_EVENTS:#{symbol}</code> topic and store them to the database.</p>
<p>A similar idea applies to the orders‚Äô data. At this moment the <code>naive</code> application uses the Binance module to place orders. We could store them inside the <code>naive</code> application‚Äôs database but how would that work if we would like to introduce another trading strategy. Holding data in separate databases for each strategy would cause further complications in future reporting, auditing, etc.</p>
<p>To store trade events‚Äô and orders‚Äô data we will create a new application called <code>data_warehouse</code> inside our umbrella project. It will subscribe to a <code>TRADE_EVENTS:#{symbol}</code> stream as well as <code>ORDERS:#{symbol}</code> stream, convert broadcasted data to its own representations(structs), and store it inside the database.</p>
<p>Trade events are already broadcasted to the PubSub topic, orders on the other hand aren‚Äôt. We will need to modify the <code>Naive.Trader</code> module to broadcast the new and updated orders to the <code>ORDERS:#{symbol}</code> topic.</p>
<p>After implementing the basic worker that will store the incoming data(trade events and orders) inside the database, we will look into adding a supervision tree utilizing <a href="https://hexdocs.pm/elixir/master/Registry.html">Elixir Registry</a>. It will allow us to skip registering every worker with a unique atom and will offer an easy lookup to fetch pids instead.</p>
</div>
<div id="create-a-new-data_warehouse-application-in-the-umbrella" class="section level2" number="14.3">
<h2><span class="header-section-number">14.3</span> Create a new <code>data_warehouse</code> application in the umbrella</h2>
<p>Let‚Äôs start by creating a new application called <code>data_warehouse</code> inside our umbrella:</p>
<div class="sourceCode" id="cb252"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb252-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb252-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cd apps</span>
<span id="cb252-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb252-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> mix new data_warehouse <span class="at">--sup</span></span>
<span id="cb252-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb252-3" aria-hidden="true" tabindex="-1"></a><span class="ex">*</span> creating README.md</span>
<span id="cb252-4"><a href="store-trade-events-and-orders-inside-the-database.html#cb252-4" aria-hidden="true" tabindex="-1"></a><span class="ex">*</span> creating .formatter.exs</span>
<span id="cb252-5"><a href="store-trade-events-and-orders-inside-the-database.html#cb252-5" aria-hidden="true" tabindex="-1"></a><span class="ex">*</span> creating .gitignore</span>
<span id="cb252-6"><a href="store-trade-events-and-orders-inside-the-database.html#cb252-6" aria-hidden="true" tabindex="-1"></a><span class="ex">*</span> creating mix.exs</span>
<span id="cb252-7"><a href="store-trade-events-and-orders-inside-the-database.html#cb252-7" aria-hidden="true" tabindex="-1"></a><span class="ex">*</span> creating lib</span>
<span id="cb252-8"><a href="store-trade-events-and-orders-inside-the-database.html#cb252-8" aria-hidden="true" tabindex="-1"></a><span class="ex">*</span> creating lib/data_warehouse.ex</span>
<span id="cb252-9"><a href="store-trade-events-and-orders-inside-the-database.html#cb252-9" aria-hidden="true" tabindex="-1"></a><span class="ex">*</span> creating lib/data_warehouse/application.ex</span>
<span id="cb252-10"><a href="store-trade-events-and-orders-inside-the-database.html#cb252-10" aria-hidden="true" tabindex="-1"></a><span class="ex">*</span> creating test</span>
<span id="cb252-11"><a href="store-trade-events-and-orders-inside-the-database.html#cb252-11" aria-hidden="true" tabindex="-1"></a><span class="ex">*</span> creating test/test_helper.exs</span>
<span id="cb252-12"><a href="store-trade-events-and-orders-inside-the-database.html#cb252-12" aria-hidden="true" tabindex="-1"></a><span class="ex">*</span> creating test/data_warehouse_test.exs</span>
<span id="cb252-13"><a href="store-trade-events-and-orders-inside-the-database.html#cb252-13" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span></code></pre></div>
</div>
<div id="connect-to-the-database-using-ecto" class="section level2" number="14.4">
<h2><span class="header-section-number">14.4</span> Connect to the database using Ecto</h2>
<p>We can now follow similar steps as previously and add required dependencies (like the <code>ecto</code>) to its <code>deps</code> by modifying its <code>mix.exs</code> file:</p>
<div class="sourceCode" id="cb253"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb253-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb253-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/data_warehouse/mix.exs</span></span>
<span id="cb253-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb253-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb253-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb253-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defp</span> deps <span class="kw">do</span></span>
<span id="cb253-4"><a href="store-trade-events-and-orders-inside-the-database.html#cb253-4" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb253-5"><a href="store-trade-events-and-orders-inside-the-database.html#cb253-5" aria-hidden="true" tabindex="-1"></a>      {<span class="va">:ecto_sql</span>, <span class="st">&quot;~&gt; 3.0&quot;</span>},</span>
<span id="cb253-6"><a href="store-trade-events-and-orders-inside-the-database.html#cb253-6" aria-hidden="true" tabindex="-1"></a>      {<span class="va">:ecto_enum</span>, <span class="st">&quot;~&gt; 1.4&quot;</span>},</span>
<span id="cb253-7"><a href="store-trade-events-and-orders-inside-the-database.html#cb253-7" aria-hidden="true" tabindex="-1"></a>      {<span class="va">:phoenix_pubsub</span>, <span class="st">&quot;~&gt; 2.0&quot;</span>},</span>
<span id="cb253-8"><a href="store-trade-events-and-orders-inside-the-database.html#cb253-8" aria-hidden="true" tabindex="-1"></a>      {<span class="va">:postgrex</span>, <span class="st">&quot;&gt;= 0.0.0&quot;</span>},</span>
<span id="cb253-9"><a href="store-trade-events-and-orders-inside-the-database.html#cb253-9" aria-hidden="true" tabindex="-1"></a>      {<span class="va">:streamer</span>, <span class="va">in_umbrella:</span> <span class="cn">true</span>}</span>
<span id="cb253-10"><a href="store-trade-events-and-orders-inside-the-database.html#cb253-10" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb253-11"><a href="store-trade-events-and-orders-inside-the-database.html#cb253-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb253-12"><a href="store-trade-events-and-orders-inside-the-database.html#cb253-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span></code></pre></div>
<p>Additionally, we added the <code>phoenix_pubsub</code> module to be able to subscribe to the PubSub topic and the <code>streamer</code> application to be able to use its <code>Streamer.Binance.TradeEvent</code> struct.</p>
<p>We can now jump back to the terminal to install added dependencies and generate a new <code>Ecto.Repo</code> module:</p>
<div class="sourceCode" id="cb254"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb254-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb254-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> mix deps.get</span>
<span id="cb254-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb254-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">...</span></span>
<span id="cb254-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb254-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cd apps/data_warehouse </span>
<span id="cb254-4"><a href="store-trade-events-and-orders-inside-the-database.html#cb254-4" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> mix ecto.gen.repo <span class="at">-r</span> DataWarehouse.Repo</span>
<span id="cb254-5"><a href="store-trade-events-and-orders-inside-the-database.html#cb254-5" aria-hidden="true" tabindex="-1"></a><span class="ex">*</span> creating lib/data_warehouse</span>
<span id="cb254-6"><a href="store-trade-events-and-orders-inside-the-database.html#cb254-6" aria-hidden="true" tabindex="-1"></a><span class="ex">*</span> creating lib/data_warehouse/repo.ex</span>
<span id="cb254-7"><a href="store-trade-events-and-orders-inside-the-database.html#cb254-7" aria-hidden="true" tabindex="-1"></a><span class="ex">*</span> updating ../../config/config.exs</span></code></pre></div>
<p>Before we will be able to create migrations that will create our tables we need to update the generated configuration inside the <code>config/config.exs</code> file:</p>
<div class="sourceCode" id="cb255"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb255-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb255-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /config/config.exs</span></span>
<span id="cb255-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb255-2" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb255-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb255-3" aria-hidden="true" tabindex="-1"></a>config <span class="va">:data_warehouse</span>,            <span class="co"># &lt;= added line</span></span>
<span id="cb255-4"><a href="store-trade-events-and-orders-inside-the-database.html#cb255-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">ecto_repos:</span> [<span class="cn">DataWarehouse</span><span class="op">.</span><span class="cn">Repo</span>] <span class="co"># &lt;= added line</span></span>
<span id="cb255-5"><a href="store-trade-events-and-orders-inside-the-database.html#cb255-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-6"><a href="store-trade-events-and-orders-inside-the-database.html#cb255-6" aria-hidden="true" tabindex="-1"></a>config <span class="va">:data_warehouse</span>, <span class="cn">DataWarehouse</span><span class="op">.</span><span class="cn">Repo</span>,</span>
<span id="cb255-7"><a href="store-trade-events-and-orders-inside-the-database.html#cb255-7" aria-hidden="true" tabindex="-1"></a>  <span class="va">database:</span> <span class="st">&quot;data_warehouse&quot;</span>, <span class="co"># &lt;= updated line</span></span>
<span id="cb255-8"><a href="store-trade-events-and-orders-inside-the-database.html#cb255-8" aria-hidden="true" tabindex="-1"></a>  <span class="va">username:</span> <span class="st">&quot;postgres&quot;</span>,       <span class="co"># &lt;= updated line</span></span>
<span id="cb255-9"><a href="store-trade-events-and-orders-inside-the-database.html#cb255-9" aria-hidden="true" tabindex="-1"></a>  <span class="va">password:</span> <span class="st">&quot;postgres&quot;</span>,       <span class="co"># &lt;= updated line</span></span>
<span id="cb255-10"><a href="store-trade-events-and-orders-inside-the-database.html#cb255-10" aria-hidden="true" tabindex="-1"></a>  <span class="va">hostname:</span> <span class="st">&quot;localhost&quot;</span></span>
<span id="cb255-11"><a href="store-trade-events-and-orders-inside-the-database.html#cb255-11" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span></code></pre></div>
<p>and add the <code>DataWarehouse.Repo</code> module to the children list of the <code>DataWarehouse.Application</code>‚Äôs process:</p>
<div class="sourceCode" id="cb256"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb256-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb256-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># /apps/data_warehouse/lib/data_warehouse/application.ex</span></span>
<span id="cb256-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb256-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb256-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb256-3" aria-hidden="true" tabindex="-1"></a>    children <span class="op">=</span> [</span>
<span id="cb256-4"><a href="store-trade-events-and-orders-inside-the-database.html#cb256-4" aria-hidden="true" tabindex="-1"></a>      {<span class="cn">DataWarehouse</span><span class="op">.</span><span class="cn">Repo</span>, []}</span>
<span id="cb256-5"><a href="store-trade-events-and-orders-inside-the-database.html#cb256-5" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb256-6"><a href="store-trade-events-and-orders-inside-the-database.html#cb256-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span></code></pre></div>
<p>The last step will be to create a database by running <code>mix ecto.create -r DataWarehouse.Repo</code> command.</p>
<p>This ends up the setup of the <code>Ecto</code> - we can now move on to the implementation of storing the orders and the trade events.</p>
</div>
<div id="store-trade-events-data" class="section level2" number="14.5">
<h2><span class="header-section-number">14.5</span> Store trade events‚Äô data</h2>
<p>The first step to store trade events inside the database will be to create a table that will hold our data. We will start by creating the migration:</p>
<div class="sourceCode" id="cb257"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb257-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb257-1" aria-hidden="true" tabindex="-1"></a>$ cd apps<span class="op">/</span>data_warehouse</span>
<span id="cb257-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb257-2" aria-hidden="true" tabindex="-1"></a>$ mix ecto<span class="op">.</span>gen<span class="op">.</span>migration create_trade_events</span>
<span id="cb257-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb257-3" aria-hidden="true" tabindex="-1"></a><span class="op">*</span> creating priv<span class="op">/</span>repo<span class="op">/</span>migrations</span>
<span id="cb257-4"><a href="store-trade-events-and-orders-inside-the-database.html#cb257-4" aria-hidden="true" tabindex="-1"></a><span class="op">*</span> creating priv<span class="op">/</span>repo<span class="op">/</span>migrations<span class="op">/</span><span class="dv">2</span>0210222224514_create_trade_events<span class="op">.</span>exs</span></code></pre></div>
<p>The <code>Streamer.Binance.TradeEvent</code> struct will serve as a list of columns for our new <code>trade_events</code> table. Here‚Äôs the full implementation of our migration:</p>
<div class="sourceCode" id="cb258"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb258-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb258-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/data_warehouse/priv/repo/migrations/20210222224514_create_trade_events.exs</span></span>
<span id="cb258-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb258-2" aria-hidden="true" tabindex="-1"></a><span class="kw">defmodule</span> <span class="cn">DataWarehouse</span><span class="op">.</span><span class="cn">Repo</span><span class="op">.</span><span class="cn">Migrations</span><span class="op">.</span><span class="cn">CreateTradeEvents</span> <span class="kw">do</span></span>
<span id="cb258-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb258-3" aria-hidden="true" tabindex="-1"></a>  <span class="im">use</span> <span class="cn">Ecto</span><span class="op">.</span><span class="cn">Migration</span></span>
<span id="cb258-4"><a href="store-trade-events-and-orders-inside-the-database.html#cb258-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb258-5"><a href="store-trade-events-and-orders-inside-the-database.html#cb258-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> change <span class="kw">do</span></span>
<span id="cb258-6"><a href="store-trade-events-and-orders-inside-the-database.html#cb258-6" aria-hidden="true" tabindex="-1"></a>    create table(<span class="va">:trade_events</span>, <span class="va">primary_key:</span> <span class="cn">false</span>) <span class="kw">do</span></span>
<span id="cb258-7"><a href="store-trade-events-and-orders-inside-the-database.html#cb258-7" aria-hidden="true" tabindex="-1"></a>      add(<span class="va">:id</span>, <span class="va">:uuid</span>, <span class="va">primary_key:</span> <span class="cn">true</span>)</span>
<span id="cb258-8"><a href="store-trade-events-and-orders-inside-the-database.html#cb258-8" aria-hidden="true" tabindex="-1"></a>      add(<span class="va">:event_type</span>, <span class="va">:text</span>)</span>
<span id="cb258-9"><a href="store-trade-events-and-orders-inside-the-database.html#cb258-9" aria-hidden="true" tabindex="-1"></a>      add(<span class="va">:event_time</span>, <span class="va">:bigint</span>)</span>
<span id="cb258-10"><a href="store-trade-events-and-orders-inside-the-database.html#cb258-10" aria-hidden="true" tabindex="-1"></a>      add(<span class="va">:symbol</span>, <span class="va">:text</span>)</span>
<span id="cb258-11"><a href="store-trade-events-and-orders-inside-the-database.html#cb258-11" aria-hidden="true" tabindex="-1"></a>      add(<span class="va">:trade_id</span>, <span class="va">:integer</span>)</span>
<span id="cb258-12"><a href="store-trade-events-and-orders-inside-the-database.html#cb258-12" aria-hidden="true" tabindex="-1"></a>      add(<span class="va">:price</span>, <span class="va">:text</span>)</span>
<span id="cb258-13"><a href="store-trade-events-and-orders-inside-the-database.html#cb258-13" aria-hidden="true" tabindex="-1"></a>      add(<span class="va">:quantity</span>, <span class="va">:text</span>)</span>
<span id="cb258-14"><a href="store-trade-events-and-orders-inside-the-database.html#cb258-14" aria-hidden="true" tabindex="-1"></a>      add(<span class="va">:buyer_order_id</span>, <span class="va">:bigint</span>)</span>
<span id="cb258-15"><a href="store-trade-events-and-orders-inside-the-database.html#cb258-15" aria-hidden="true" tabindex="-1"></a>      add(<span class="va">:seller_order_id</span>, <span class="va">:bigint</span>)</span>
<span id="cb258-16"><a href="store-trade-events-and-orders-inside-the-database.html#cb258-16" aria-hidden="true" tabindex="-1"></a>      add(<span class="va">:trade_time</span>, <span class="va">:bigint</span>)</span>
<span id="cb258-17"><a href="store-trade-events-and-orders-inside-the-database.html#cb258-17" aria-hidden="true" tabindex="-1"></a>      add(<span class="va">:buyer_market_maker</span>, <span class="va">:bool</span>)</span>
<span id="cb258-18"><a href="store-trade-events-and-orders-inside-the-database.html#cb258-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb258-19"><a href="store-trade-events-and-orders-inside-the-database.html#cb258-19" aria-hidden="true" tabindex="-1"></a>      timestamps()</span>
<span id="cb258-20"><a href="store-trade-events-and-orders-inside-the-database.html#cb258-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb258-21"><a href="store-trade-events-and-orders-inside-the-database.html#cb258-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb258-22"><a href="store-trade-events-and-orders-inside-the-database.html#cb258-22" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<p>We added the additional <code>id</code> field to easily identify each trade event and our timestamps for monitoring.</p>
<p>Let‚Äôs run the migration so it will create a new <code>trade_events</code> table for us:</p>
<div class="sourceCode" id="cb259"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb259-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb259-1" aria-hidden="true" tabindex="-1"></a>$ mix ecto<span class="op">.</span>migrate</span></code></pre></div>
<p>The next step will be to create a new directory called <code>schema</code> inside the <code>apps/data_warehouse/lib/data_warehouse</code> directory. Inside it, we need to create a new schema file called <code>trade_event.ex</code>. We can copy across the same columns from the migration straight to schema:</p>
<div class="sourceCode" id="cb260"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb260-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb260-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/data_warehouse/lib/data_warehouse/schema/trade_event.ex</span></span>
<span id="cb260-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb260-2" aria-hidden="true" tabindex="-1"></a><span class="kw">defmodule</span> <span class="cn">DataWarehouse</span><span class="op">.</span><span class="cn">Schema</span><span class="op">.</span><span class="cn">TradeEvent</span> <span class="kw">do</span></span>
<span id="cb260-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb260-3" aria-hidden="true" tabindex="-1"></a>  <span class="im">use</span> <span class="cn">Ecto</span><span class="op">.</span><span class="cn">Schema</span></span>
<span id="cb260-4"><a href="store-trade-events-and-orders-inside-the-database.html#cb260-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-5"><a href="store-trade-events-and-orders-inside-the-database.html#cb260-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@primary_key</span> {<span class="va">:id</span>, <span class="va">:binary_id</span>, <span class="va">autogenerate:</span> <span class="cn">true</span>}</span>
<span id="cb260-6"><a href="store-trade-events-and-orders-inside-the-database.html#cb260-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-7"><a href="store-trade-events-and-orders-inside-the-database.html#cb260-7" aria-hidden="true" tabindex="-1"></a>  schema <span class="st">&quot;trade_events&quot;</span> <span class="kw">do</span></span>
<span id="cb260-8"><a href="store-trade-events-and-orders-inside-the-database.html#cb260-8" aria-hidden="true" tabindex="-1"></a>    field(<span class="va">:event_type</span>, <span class="va">:string</span>)</span>
<span id="cb260-9"><a href="store-trade-events-and-orders-inside-the-database.html#cb260-9" aria-hidden="true" tabindex="-1"></a>    field(<span class="va">:event_time</span>, <span class="va">:integer</span>)</span>
<span id="cb260-10"><a href="store-trade-events-and-orders-inside-the-database.html#cb260-10" aria-hidden="true" tabindex="-1"></a>    field(<span class="va">:symbol</span>, <span class="va">:string</span>)</span>
<span id="cb260-11"><a href="store-trade-events-and-orders-inside-the-database.html#cb260-11" aria-hidden="true" tabindex="-1"></a>    field(<span class="va">:trade_id</span>, <span class="va">:integer</span>)</span>
<span id="cb260-12"><a href="store-trade-events-and-orders-inside-the-database.html#cb260-12" aria-hidden="true" tabindex="-1"></a>    field(<span class="va">:price</span>, <span class="va">:string</span>)</span>
<span id="cb260-13"><a href="store-trade-events-and-orders-inside-the-database.html#cb260-13" aria-hidden="true" tabindex="-1"></a>    field(<span class="va">:quantity</span>, <span class="va">:string</span>)</span>
<span id="cb260-14"><a href="store-trade-events-and-orders-inside-the-database.html#cb260-14" aria-hidden="true" tabindex="-1"></a>    field(<span class="va">:buyer_order_id</span>, <span class="va">:integer</span>)</span>
<span id="cb260-15"><a href="store-trade-events-and-orders-inside-the-database.html#cb260-15" aria-hidden="true" tabindex="-1"></a>    field(<span class="va">:seller_order_id</span>, <span class="va">:integer</span>)</span>
<span id="cb260-16"><a href="store-trade-events-and-orders-inside-the-database.html#cb260-16" aria-hidden="true" tabindex="-1"></a>    field(<span class="va">:trade_time</span>, <span class="va">:integer</span>)</span>
<span id="cb260-17"><a href="store-trade-events-and-orders-inside-the-database.html#cb260-17" aria-hidden="true" tabindex="-1"></a>    field(<span class="va">:buyer_market_maker</span>, <span class="va">:boolean</span>)</span>
<span id="cb260-18"><a href="store-trade-events-and-orders-inside-the-database.html#cb260-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-19"><a href="store-trade-events-and-orders-inside-the-database.html#cb260-19" aria-hidden="true" tabindex="-1"></a>    timestamps()</span>
<span id="cb260-20"><a href="store-trade-events-and-orders-inside-the-database.html#cb260-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb260-21"><a href="store-trade-events-and-orders-inside-the-database.html#cb260-21" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<p>At this moment we should be able to execute crud(create, read[select], update, delete) operations over the table using the above struct.</p>
<p>Currently, we can already store the trade events‚Äô data inside the database so we can move on to collecting it. Trade events are getting broadcasted by the <code>Streamer.Binance</code> process here:</p>
<div class="sourceCode" id="cb261"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb261-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb261-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># /apps/streamer/lib/streamer/binance.ex</span></span>
<span id="cb261-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb261-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb261-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb261-3" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Phoenix</span><span class="op">.</span><span class="cn">PubSub</span><span class="op">.</span>broadcast(</span>
<span id="cb261-4"><a href="store-trade-events-and-orders-inside-the-database.html#cb261-4" aria-hidden="true" tabindex="-1"></a>      <span class="cn">Streamer</span><span class="op">.</span><span class="cn">PubSub</span>,</span>
<span id="cb261-5"><a href="store-trade-events-and-orders-inside-the-database.html#cb261-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;TRADE_EVENTS:</span><span class="ot">#{</span>trade_event<span class="op">.</span>symbol<span class="ot">}</span><span class="st">&quot;</span>,</span>
<span id="cb261-6"><a href="store-trade-events-and-orders-inside-the-database.html#cb261-6" aria-hidden="true" tabindex="-1"></a>      trade_event</span>
<span id="cb261-7"><a href="store-trade-events-and-orders-inside-the-database.html#cb261-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb261-8"><a href="store-trade-events-and-orders-inside-the-database.html#cb261-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span></code></pre></div>
<p>We will implement a <code>subscriber</code> process that will be given a PubSub topic and it will store incoming data inside the database.</p>
<p>Let‚Äôs start by creating a new folder called <code>subscriber</code> inside the <code>apps/data_warehouse/lib/data_warehouse</code> directory together with a new file called <code>worker.ex</code> inside it:</p>
<div class="sourceCode" id="cb262"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb262-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb262-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/data_warehouse/lib/data_warehouse/subscriber/worker.ex</span></span>
<span id="cb262-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb262-2" aria-hidden="true" tabindex="-1"></a><span class="kw">defmodule</span> <span class="cn">DataWarehouse</span><span class="op">.</span><span class="cn">Subscriber</span><span class="op">.</span><span class="cn">Worker</span> <span class="kw">do</span></span>
<span id="cb262-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb262-3" aria-hidden="true" tabindex="-1"></a>  <span class="im">use</span> <span class="cn">GenServer</span></span>
<span id="cb262-4"><a href="store-trade-events-and-orders-inside-the-database.html#cb262-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-5"><a href="store-trade-events-and-orders-inside-the-database.html#cb262-5" aria-hidden="true" tabindex="-1"></a>  <span class="im">require</span> <span class="cn">Logger</span></span>
<span id="cb262-6"><a href="store-trade-events-and-orders-inside-the-database.html#cb262-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-7"><a href="store-trade-events-and-orders-inside-the-database.html#cb262-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defmodule</span> <span class="cn">State</span> <span class="kw">do</span></span>
<span id="cb262-8"><a href="store-trade-events-and-orders-inside-the-database.html#cb262-8" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@enforce_keys</span> [<span class="va">:topic</span>]</span>
<span id="cb262-9"><a href="store-trade-events-and-orders-inside-the-database.html#cb262-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">defstruct</span> [<span class="va">:topic</span>]</span>
<span id="cb262-10"><a href="store-trade-events-and-orders-inside-the-database.html#cb262-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb262-11"><a href="store-trade-events-and-orders-inside-the-database.html#cb262-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-12"><a href="store-trade-events-and-orders-inside-the-database.html#cb262-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> start_link(topic) <span class="kw">do</span></span>
<span id="cb262-13"><a href="store-trade-events-and-orders-inside-the-database.html#cb262-13" aria-hidden="true" tabindex="-1"></a>    <span class="cn">GenServer</span><span class="op">.</span>start_link(</span>
<span id="cb262-14"><a href="store-trade-events-and-orders-inside-the-database.html#cb262-14" aria-hidden="true" tabindex="-1"></a>      <span class="cn">__MODULE__</span>,</span>
<span id="cb262-15"><a href="store-trade-events-and-orders-inside-the-database.html#cb262-15" aria-hidden="true" tabindex="-1"></a>      topic,</span>
<span id="cb262-16"><a href="store-trade-events-and-orders-inside-the-database.html#cb262-16" aria-hidden="true" tabindex="-1"></a>      <span class="va">name:</span> :<span class="st">&quot;</span><span class="ot">#{</span><span class="cn">__MODULE__</span><span class="ot">}</span><span class="st">-</span><span class="ot">#{</span>topic<span class="ot">}</span><span class="st">&quot;</span></span>
<span id="cb262-17"><a href="store-trade-events-and-orders-inside-the-database.html#cb262-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb262-18"><a href="store-trade-events-and-orders-inside-the-database.html#cb262-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb262-19"><a href="store-trade-events-and-orders-inside-the-database.html#cb262-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-20"><a href="store-trade-events-and-orders-inside-the-database.html#cb262-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> init(topic) <span class="kw">do</span></span>
<span id="cb262-21"><a href="store-trade-events-and-orders-inside-the-database.html#cb262-21" aria-hidden="true" tabindex="-1"></a>    {<span class="va">:ok</span>,</span>
<span id="cb262-22"><a href="store-trade-events-and-orders-inside-the-database.html#cb262-22" aria-hidden="true" tabindex="-1"></a>     %<span class="cn">State</span>{</span>
<span id="cb262-23"><a href="store-trade-events-and-orders-inside-the-database.html#cb262-23" aria-hidden="true" tabindex="-1"></a>       <span class="va">topic:</span> topic</span>
<span id="cb262-24"><a href="store-trade-events-and-orders-inside-the-database.html#cb262-24" aria-hidden="true" tabindex="-1"></a>     }}</span>
<span id="cb262-25"><a href="store-trade-events-and-orders-inside-the-database.html#cb262-25" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb262-26"><a href="store-trade-events-and-orders-inside-the-database.html#cb262-26" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<p>At this moment it‚Äôs just a box standard implementation of the <code>GenServer</code> with a state struct containing a single key(<code>:topic</code>). We need to update the <code>init/1</code> function to subscribe to the PubSub topic:</p>
<div class="sourceCode" id="cb263"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb263-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb263-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/data_warehouse/lib/data_warehouse/subscriber/worker.ex</span></span>
<span id="cb263-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb263-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> init(topic) <span class="kw">do</span></span>
<span id="cb263-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb263-3" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Logger</span><span class="op">.</span>info(<span class="st">&quot;DataWarehouse worker is subscribing to </span><span class="ot">#{</span>topic<span class="ot">}</span><span class="st">&quot;</span>)</span>
<span id="cb263-4"><a href="store-trade-events-and-orders-inside-the-database.html#cb263-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-5"><a href="store-trade-events-and-orders-inside-the-database.html#cb263-5" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Phoenix</span><span class="op">.</span><span class="cn">PubSub</span><span class="op">.</span>subscribe(</span>
<span id="cb263-6"><a href="store-trade-events-and-orders-inside-the-database.html#cb263-6" aria-hidden="true" tabindex="-1"></a>      <span class="cn">Streamer</span><span class="op">.</span><span class="cn">PubSub</span>,</span>
<span id="cb263-7"><a href="store-trade-events-and-orders-inside-the-database.html#cb263-7" aria-hidden="true" tabindex="-1"></a>      topic</span>
<span id="cb263-8"><a href="store-trade-events-and-orders-inside-the-database.html#cb263-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb263-9"><a href="store-trade-events-and-orders-inside-the-database.html#cb263-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span></code></pre></div>
<p>Next, we need to add a handler for received messages:</p>
<div class="sourceCode" id="cb264"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb264-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb264-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/data_warehouse/lib/data_warehouse/subscriber/worker.ex</span></span>
<span id="cb264-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb264-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> handle_info(%<span class="cn">Streamer</span><span class="op">.</span><span class="cn">Binance</span><span class="op">.</span><span class="cn">TradeEvent</span>{} <span class="op">=</span> trade_event, state) <span class="kw">do</span></span>
<span id="cb264-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb264-3" aria-hidden="true" tabindex="-1"></a>    opts <span class="op">=</span></span>
<span id="cb264-4"><a href="store-trade-events-and-orders-inside-the-database.html#cb264-4" aria-hidden="true" tabindex="-1"></a>      trade_event</span>
<span id="cb264-5"><a href="store-trade-events-and-orders-inside-the-database.html#cb264-5" aria-hidden="true" tabindex="-1"></a>      <span class="op">|&gt;</span> <span class="cn">Map</span><span class="op">.</span>from_struct()</span>
<span id="cb264-6"><a href="store-trade-events-and-orders-inside-the-database.html#cb264-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb264-7"><a href="store-trade-events-and-orders-inside-the-database.html#cb264-7" aria-hidden="true" tabindex="-1"></a>    struct!(<span class="cn">DataWarehouse</span><span class="op">.</span><span class="cn">Schema</span><span class="op">.</span><span class="cn">TradeEvent</span>, opts)</span>
<span id="cb264-8"><a href="store-trade-events-and-orders-inside-the-database.html#cb264-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">|&gt;</span> <span class="cn">DataWarehouse</span><span class="op">.</span><span class="cn">Repo</span><span class="op">.</span>insert()</span>
<span id="cb264-9"><a href="store-trade-events-and-orders-inside-the-database.html#cb264-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb264-10"><a href="store-trade-events-and-orders-inside-the-database.html#cb264-10" aria-hidden="true" tabindex="-1"></a>    {<span class="va">:noreply</span>, state}</span>
<span id="cb264-11"><a href="store-trade-events-and-orders-inside-the-database.html#cb264-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>As we did in the case of the <code>Naive.Trader</code>, all incoming messages trigger a <code>handle_info/2</code> callback with contents of the message and the current state of the subscriber worker. We just convert that incoming trade event to a map and then that map to the <code>TradeEvent</code> struct that gets inserted into the database.</p>
<p>This finishes storing of trade events implementation which we can test by in the interactive shell by running:</p>
<div class="sourceCode" id="cb265"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb265-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb265-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> iex <span class="at">-S</span> mix</span>
<span id="cb265-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb265-2" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb265-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb265-3" aria-hidden="true" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">1</span><span class="kw">)</span><span class="op">&gt;</span> Streamer.start_streaming<span class="kw">(</span><span class="st">&quot;XRPUSDT&quot;</span><span class="kw">)</span></span>
<span id="cb265-4"><a href="store-trade-events-and-orders-inside-the-database.html#cb265-4" aria-hidden="true" tabindex="-1"></a><span class="ex">00:48:30.147</span> [info]  Starting Elixir.Streamer.Binance worker for XRPUSDT</span>
<span id="cb265-5"><a href="store-trade-events-and-orders-inside-the-database.html#cb265-5" aria-hidden="true" tabindex="-1"></a><span class="ex">{:ok,</span> <span class="co">#PID&lt;0.395.0&gt;}</span></span>
<span id="cb265-6"><a href="store-trade-events-and-orders-inside-the-database.html#cb265-6" aria-hidden="true" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">2</span><span class="kw">)</span><span class="op">&gt;</span> DataWarehouse.Subscriber.Worker.start_link<span class="kw">(</span><span class="st">&quot;TRADE_EVENTS:XRPUSDT&quot;</span><span class="kw">)</span></span>
<span id="cb265-7"><a href="store-trade-events-and-orders-inside-the-database.html#cb265-7" aria-hidden="true" tabindex="-1"></a><span class="ex">00:49:48.204</span> [info]  DataWarehouse worker is subscribing to TRADE_EVENTS:XRPUSDT</span>
<span id="cb265-8"><a href="store-trade-events-and-orders-inside-the-database.html#cb265-8" aria-hidden="true" tabindex="-1"></a><span class="ex">{:ok,</span> <span class="co">#PID&lt;0.405.0&gt;}</span></span></code></pre></div>
<p>After a couple of minutes we can check the database using <code>psql</code>:</p>
<div class="sourceCode" id="cb266"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb266-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb266-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> psql <span class="at">-Upostgres</span> <span class="at">-h127.0.0.1</span></span>
<span id="cb266-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb266-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Password</span> for user postgres:</span>
<span id="cb266-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb266-3" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb266-4"><a href="store-trade-events-and-orders-inside-the-database.html#cb266-4" aria-hidden="true" tabindex="-1"></a><span class="va">postgres=</span># <span class="ex">\c</span> data_warehouse<span class="kw">;</span></span>
<span id="cb266-5"><a href="store-trade-events-and-orders-inside-the-database.html#cb266-5" aria-hidden="true" tabindex="-1"></a><span class="ex">You</span> are now connected to database <span class="st">&quot;data_warehouse&quot;</span> as user <span class="st">&quot;postgres&quot;</span>.</span>
<span id="cb266-6"><a href="store-trade-events-and-orders-inside-the-database.html#cb266-6" aria-hidden="true" tabindex="-1"></a><span class="va">data_warehouse=</span># <span class="ex">\x</span></span>
<span id="cb266-7"><a href="store-trade-events-and-orders-inside-the-database.html#cb266-7" aria-hidden="true" tabindex="-1"></a><span class="ex">Expanded</span> display is on.</span>
<span id="cb266-8"><a href="store-trade-events-and-orders-inside-the-database.html#cb266-8" aria-hidden="true" tabindex="-1"></a><span class="va">data_warehouse=</span># <span class="ex">SELECT</span> <span class="pp">*</span> FROM trade_events<span class="kw">;</span></span>
<span id="cb266-9"><a href="store-trade-events-and-orders-inside-the-database.html#cb266-9" aria-hidden="true" tabindex="-1"></a><span class="ex">-[</span> RECORD 1 ]------+-------------------------------------</span>
<span id="cb266-10"><a href="store-trade-events-and-orders-inside-the-database.html#cb266-10" aria-hidden="true" tabindex="-1"></a><span class="fu">id</span>                 <span class="kw">|</span> <span class="ex">f6eae686-946a-4e34-9c33-c7034c2cad5d</span></span>
<span id="cb266-11"><a href="store-trade-events-and-orders-inside-the-database.html#cb266-11" aria-hidden="true" tabindex="-1"></a><span class="ex">event_type</span>         <span class="kw">|</span> <span class="ex">trade</span></span>
<span id="cb266-12"><a href="store-trade-events-and-orders-inside-the-database.html#cb266-12" aria-hidden="true" tabindex="-1"></a><span class="ex">event_time</span>         <span class="kw">|</span> <span class="ex">1614041388236</span></span>
<span id="cb266-13"><a href="store-trade-events-and-orders-inside-the-database.html#cb266-13" aria-hidden="true" tabindex="-1"></a><span class="ex">symbol</span>             <span class="kw">|</span> <span class="ex">XRPUSDT</span></span>
<span id="cb266-14"><a href="store-trade-events-and-orders-inside-the-database.html#cb266-14" aria-hidden="true" tabindex="-1"></a><span class="ex">trade_id</span>           <span class="kw">|</span> <span class="ex">152765072</span></span>
<span id="cb266-15"><a href="store-trade-events-and-orders-inside-the-database.html#cb266-15" aria-hidden="true" tabindex="-1"></a><span class="ex">price</span>              <span class="kw">|</span> <span class="ex">0.56554000</span></span>
<span id="cb266-16"><a href="store-trade-events-and-orders-inside-the-database.html#cb266-16" aria-hidden="true" tabindex="-1"></a><span class="ex">quantity</span>           <span class="kw">|</span> <span class="ex">1199.10000000</span></span>
<span id="cb266-17"><a href="store-trade-events-and-orders-inside-the-database.html#cb266-17" aria-hidden="true" tabindex="-1"></a><span class="ex">buyer_order_id</span>     <span class="kw">|</span> <span class="ex">1762454848</span></span>
<span id="cb266-18"><a href="store-trade-events-and-orders-inside-the-database.html#cb266-18" aria-hidden="true" tabindex="-1"></a><span class="ex">seller_order_id</span>    <span class="kw">|</span> <span class="ex">1762454775</span></span>
<span id="cb266-19"><a href="store-trade-events-and-orders-inside-the-database.html#cb266-19" aria-hidden="true" tabindex="-1"></a><span class="ex">trade_time</span>         <span class="kw">|</span> <span class="ex">1614041388235</span></span>
<span id="cb266-20"><a href="store-trade-events-and-orders-inside-the-database.html#cb266-20" aria-hidden="true" tabindex="-1"></a><span class="ex">buyer_market_maker</span> <span class="kw">|</span> <span class="ex">f</span></span>
<span id="cb266-21"><a href="store-trade-events-and-orders-inside-the-database.html#cb266-21" aria-hidden="true" tabindex="-1"></a><span class="ex">inserted_at</span>        <span class="kw">|</span> <span class="ex">2021-02-23</span> 00:49:48</span>
<span id="cb266-22"><a href="store-trade-events-and-orders-inside-the-database.html#cb266-22" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span></code></pre></div>
<p>As we can see in the above output, trade events are now getting stored inside the database.</p>
</div>
<div id="store-orders-data" class="section level2" number="14.6">
<h2><span class="header-section-number">14.6</span> Store orders‚Äô data</h2>
<p>In the same fashion as with trade events‚Äô data above, to store orders data we will create an <code>orders</code> table inside a new migration:</p>
<div class="sourceCode" id="cb267"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb267-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb267-1" aria-hidden="true" tabindex="-1"></a>$ cd apps<span class="op">/</span>data_warehouse</span>
<span id="cb267-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb267-2" aria-hidden="true" tabindex="-1"></a>$ mix ecto<span class="op">.</span>gen<span class="op">.</span>migration create_orders</span>
<span id="cb267-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb267-3" aria-hidden="true" tabindex="-1"></a><span class="op">*</span> creating priv<span class="op">/</span>repo<span class="op">/</span>migrations<span class="op">/</span><span class="dv">2</span>0210222224522_create_orders<span class="op">.</span>exs</span></code></pre></div>
<p>The list of columns for this table will be a copy of <a href="https://github.com/dvcrn/binance.ex/blob/master/lib/binance/order.ex"><code>Binance.Order</code></a> struct returned from the Binance exchange:</p>
<div class="sourceCode" id="cb268"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb268-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb268-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/data_warehouse/priv/repo/migrations/20210222224522_create_orders.exs</span></span>
<span id="cb268-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb268-2" aria-hidden="true" tabindex="-1"></a><span class="kw">defmodule</span> <span class="cn">DataWarehouse</span><span class="op">.</span><span class="cn">Repo</span><span class="op">.</span><span class="cn">Migrations</span><span class="op">.</span><span class="cn">CreateOrders</span> <span class="kw">do</span></span>
<span id="cb268-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb268-3" aria-hidden="true" tabindex="-1"></a>  <span class="im">use</span> <span class="cn">Ecto</span><span class="op">.</span><span class="cn">Migration</span></span>
<span id="cb268-4"><a href="store-trade-events-and-orders-inside-the-database.html#cb268-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb268-5"><a href="store-trade-events-and-orders-inside-the-database.html#cb268-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> change <span class="kw">do</span></span>
<span id="cb268-6"><a href="store-trade-events-and-orders-inside-the-database.html#cb268-6" aria-hidden="true" tabindex="-1"></a>    create table(<span class="va">:orders</span>, <span class="va">primary_key:</span> <span class="cn">false</span>) <span class="kw">do</span></span>
<span id="cb268-7"><a href="store-trade-events-and-orders-inside-the-database.html#cb268-7" aria-hidden="true" tabindex="-1"></a>      add(<span class="va">:order_id</span>, <span class="va">:bigint</span>, <span class="va">primary_key:</span> <span class="cn">true</span>)</span>
<span id="cb268-8"><a href="store-trade-events-and-orders-inside-the-database.html#cb268-8" aria-hidden="true" tabindex="-1"></a>      add(<span class="va">:client_order_id</span>, <span class="va">:text</span>)</span>
<span id="cb268-9"><a href="store-trade-events-and-orders-inside-the-database.html#cb268-9" aria-hidden="true" tabindex="-1"></a>      add(<span class="va">:symbol</span>, <span class="va">:text</span>)</span>
<span id="cb268-10"><a href="store-trade-events-and-orders-inside-the-database.html#cb268-10" aria-hidden="true" tabindex="-1"></a>      add(<span class="va">:price</span>, <span class="va">:text</span>)</span>
<span id="cb268-11"><a href="store-trade-events-and-orders-inside-the-database.html#cb268-11" aria-hidden="true" tabindex="-1"></a>      add(<span class="va">:original_quantity</span>, <span class="va">:text</span>)</span>
<span id="cb268-12"><a href="store-trade-events-and-orders-inside-the-database.html#cb268-12" aria-hidden="true" tabindex="-1"></a>      add(<span class="va">:executed_quantity</span>, <span class="va">:text</span>)</span>
<span id="cb268-13"><a href="store-trade-events-and-orders-inside-the-database.html#cb268-13" aria-hidden="true" tabindex="-1"></a>      add(<span class="va">:cummulative_quote_quantity</span>, <span class="va">:text</span>)</span>
<span id="cb268-14"><a href="store-trade-events-and-orders-inside-the-database.html#cb268-14" aria-hidden="true" tabindex="-1"></a>      add(<span class="va">:status</span>, <span class="va">:text</span>)</span>
<span id="cb268-15"><a href="store-trade-events-and-orders-inside-the-database.html#cb268-15" aria-hidden="true" tabindex="-1"></a>      add(<span class="va">:time_in_force</span>, <span class="va">:text</span>)</span>
<span id="cb268-16"><a href="store-trade-events-and-orders-inside-the-database.html#cb268-16" aria-hidden="true" tabindex="-1"></a>      add(<span class="va">:type</span>, <span class="va">:text</span>)</span>
<span id="cb268-17"><a href="store-trade-events-and-orders-inside-the-database.html#cb268-17" aria-hidden="true" tabindex="-1"></a>      add(<span class="va">:side</span>, <span class="va">:text</span>)</span>
<span id="cb268-18"><a href="store-trade-events-and-orders-inside-the-database.html#cb268-18" aria-hidden="true" tabindex="-1"></a>      add(<span class="va">:stop_price</span>, <span class="va">:text</span>)</span>
<span id="cb268-19"><a href="store-trade-events-and-orders-inside-the-database.html#cb268-19" aria-hidden="true" tabindex="-1"></a>      add(<span class="va">:iceberg_quantity</span>, <span class="va">:text</span>)</span>
<span id="cb268-20"><a href="store-trade-events-and-orders-inside-the-database.html#cb268-20" aria-hidden="true" tabindex="-1"></a>      add(<span class="va">:time</span>, <span class="va">:bigint</span>)</span>
<span id="cb268-21"><a href="store-trade-events-and-orders-inside-the-database.html#cb268-21" aria-hidden="true" tabindex="-1"></a>      add(<span class="va">:update_time</span>, <span class="va">:bigint</span>)</span>
<span id="cb268-22"><a href="store-trade-events-and-orders-inside-the-database.html#cb268-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb268-23"><a href="store-trade-events-and-orders-inside-the-database.html#cb268-23" aria-hidden="true" tabindex="-1"></a>      timestamps()</span>
<span id="cb268-24"><a href="store-trade-events-and-orders-inside-the-database.html#cb268-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb268-25"><a href="store-trade-events-and-orders-inside-the-database.html#cb268-25" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb268-26"><a href="store-trade-events-and-orders-inside-the-database.html#cb268-26" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<p>We updated all of the shortened names like <code>orig_qty</code> to full names like <code>original_quantity</code>.</p>
<p>Let‚Äôs run the migration so it will create a new <code>orders</code> table for us:</p>
<div class="sourceCode" id="cb269"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb269-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb269-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> mix ecto.migrate</span></code></pre></div>
<p>We can copy the above fields list to create a schema module. First, let‚Äôs create a new file called <code>order.ex</code> inside the <code>apps/data_warehouse/lib/data_warehouse/schema</code> directory:</p>
<div class="sourceCode" id="cb270"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb270-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb270-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/data_warehouse/lib/data_warehouse/schema/order.ex</span></span>
<span id="cb270-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb270-2" aria-hidden="true" tabindex="-1"></a><span class="kw">defmodule</span> <span class="cn">DataWarehouse</span><span class="op">.</span><span class="cn">Schema</span><span class="op">.</span><span class="cn">Order</span> <span class="kw">do</span></span>
<span id="cb270-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb270-3" aria-hidden="true" tabindex="-1"></a>  <span class="im">use</span> <span class="cn">Ecto</span><span class="op">.</span><span class="cn">Schema</span></span>
<span id="cb270-4"><a href="store-trade-events-and-orders-inside-the-database.html#cb270-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-5"><a href="store-trade-events-and-orders-inside-the-database.html#cb270-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@primary_key</span> {<span class="va">:order_id</span>, <span class="va">:integer</span>, <span class="va">autogenerate:</span> <span class="cn">false</span>}</span>
<span id="cb270-6"><a href="store-trade-events-and-orders-inside-the-database.html#cb270-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-7"><a href="store-trade-events-and-orders-inside-the-database.html#cb270-7" aria-hidden="true" tabindex="-1"></a>  schema <span class="st">&quot;orders&quot;</span> <span class="kw">do</span></span>
<span id="cb270-8"><a href="store-trade-events-and-orders-inside-the-database.html#cb270-8" aria-hidden="true" tabindex="-1"></a>    field(<span class="va">:client_order_id</span>, <span class="va">:string</span>)</span>
<span id="cb270-9"><a href="store-trade-events-and-orders-inside-the-database.html#cb270-9" aria-hidden="true" tabindex="-1"></a>    field(<span class="va">:symbol</span>, <span class="va">:string</span>)</span>
<span id="cb270-10"><a href="store-trade-events-and-orders-inside-the-database.html#cb270-10" aria-hidden="true" tabindex="-1"></a>    field(<span class="va">:price</span>, <span class="va">:string</span>)</span>
<span id="cb270-11"><a href="store-trade-events-and-orders-inside-the-database.html#cb270-11" aria-hidden="true" tabindex="-1"></a>    field(<span class="va">:original_quantity</span>, <span class="va">:string</span>)</span>
<span id="cb270-12"><a href="store-trade-events-and-orders-inside-the-database.html#cb270-12" aria-hidden="true" tabindex="-1"></a>    field(<span class="va">:executed_quantity</span>, <span class="va">:string</span>)</span>
<span id="cb270-13"><a href="store-trade-events-and-orders-inside-the-database.html#cb270-13" aria-hidden="true" tabindex="-1"></a>    field(<span class="va">:cummulative_quote_quantity</span>, <span class="va">:string</span>)</span>
<span id="cb270-14"><a href="store-trade-events-and-orders-inside-the-database.html#cb270-14" aria-hidden="true" tabindex="-1"></a>    field(<span class="va">:status</span>, <span class="va">:string</span>)</span>
<span id="cb270-15"><a href="store-trade-events-and-orders-inside-the-database.html#cb270-15" aria-hidden="true" tabindex="-1"></a>    field(<span class="va">:time_in_force</span>, <span class="va">:string</span>)</span>
<span id="cb270-16"><a href="store-trade-events-and-orders-inside-the-database.html#cb270-16" aria-hidden="true" tabindex="-1"></a>    field(<span class="va">:type</span>, <span class="va">:string</span>)</span>
<span id="cb270-17"><a href="store-trade-events-and-orders-inside-the-database.html#cb270-17" aria-hidden="true" tabindex="-1"></a>    field(<span class="va">:side</span>, <span class="va">:string</span>)</span>
<span id="cb270-18"><a href="store-trade-events-and-orders-inside-the-database.html#cb270-18" aria-hidden="true" tabindex="-1"></a>    field(<span class="va">:stop_price</span>, <span class="va">:string</span>)</span>
<span id="cb270-19"><a href="store-trade-events-and-orders-inside-the-database.html#cb270-19" aria-hidden="true" tabindex="-1"></a>    field(<span class="va">:iceberg_quantity</span>, <span class="va">:string</span>)</span>
<span id="cb270-20"><a href="store-trade-events-and-orders-inside-the-database.html#cb270-20" aria-hidden="true" tabindex="-1"></a>    field(<span class="va">:time</span>, <span class="va">:integer</span>)</span>
<span id="cb270-21"><a href="store-trade-events-and-orders-inside-the-database.html#cb270-21" aria-hidden="true" tabindex="-1"></a>    field(<span class="va">:update_time</span>, <span class="va">:integer</span>)</span>
<span id="cb270-22"><a href="store-trade-events-and-orders-inside-the-database.html#cb270-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-23"><a href="store-trade-events-and-orders-inside-the-database.html#cb270-23" aria-hidden="true" tabindex="-1"></a>    timestamps()</span>
<span id="cb270-24"><a href="store-trade-events-and-orders-inside-the-database.html#cb270-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb270-25"><a href="store-trade-events-and-orders-inside-the-database.html#cb270-25" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<p>We can now add a handler to our <code>DataWarehouse.Subscriber.Worker</code> that will convert the <code>Binance.Order</code> struct to <code>DataWarehouse.Schema.Order</code> and store data inside the database:</p>
<div class="sourceCode" id="cb271"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb271-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb271-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/data_warehouse/lib/data_warehouse/subscriber/worker.ex</span></span>
<span id="cb271-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb271-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> handle_info(%<span class="cn">Binance</span><span class="op">.</span><span class="cn">Order</span>{} <span class="op">=</span> order, state) <span class="kw">do</span></span>
<span id="cb271-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb271-3" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span></span>
<span id="cb271-4"><a href="store-trade-events-and-orders-inside-the-database.html#cb271-4" aria-hidden="true" tabindex="-1"></a>      order</span>
<span id="cb271-5"><a href="store-trade-events-and-orders-inside-the-database.html#cb271-5" aria-hidden="true" tabindex="-1"></a>      <span class="op">|&gt;</span> <span class="cn">Map</span><span class="op">.</span>from_struct()</span>
<span id="cb271-6"><a href="store-trade-events-and-orders-inside-the-database.html#cb271-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb271-7"><a href="store-trade-events-and-orders-inside-the-database.html#cb271-7" aria-hidden="true" tabindex="-1"></a>    struct(<span class="cn">DataWarehouse</span><span class="op">.</span><span class="cn">Schema</span><span class="op">.</span><span class="cn">Order</span>, data)</span>
<span id="cb271-8"><a href="store-trade-events-and-orders-inside-the-database.html#cb271-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">|&gt;</span> <span class="cn">Map</span><span class="op">.</span>merge(%{</span>
<span id="cb271-9"><a href="store-trade-events-and-orders-inside-the-database.html#cb271-9" aria-hidden="true" tabindex="-1"></a>      <span class="va">original_quantity:</span> order<span class="op">.</span>orig_qty,</span>
<span id="cb271-10"><a href="store-trade-events-and-orders-inside-the-database.html#cb271-10" aria-hidden="true" tabindex="-1"></a>      <span class="va">executed_quantity:</span> order<span class="op">.</span>executed_qty,</span>
<span id="cb271-11"><a href="store-trade-events-and-orders-inside-the-database.html#cb271-11" aria-hidden="true" tabindex="-1"></a>      <span class="va">cummulative_quote_quantity:</span> order<span class="op">.</span>cummulative_quote_qty,</span>
<span id="cb271-12"><a href="store-trade-events-and-orders-inside-the-database.html#cb271-12" aria-hidden="true" tabindex="-1"></a>      <span class="va">iceberg_quantity:</span> order<span class="op">.</span>iceberg_qty</span>
<span id="cb271-13"><a href="store-trade-events-and-orders-inside-the-database.html#cb271-13" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb271-14"><a href="store-trade-events-and-orders-inside-the-database.html#cb271-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">|&gt;</span> <span class="cn">DataWarehouse</span><span class="op">.</span><span class="cn">Repo</span><span class="op">.</span>insert(</span>
<span id="cb271-15"><a href="store-trade-events-and-orders-inside-the-database.html#cb271-15" aria-hidden="true" tabindex="-1"></a>      <span class="va">on_conflict:</span> <span class="va">:replace_all</span>,</span>
<span id="cb271-16"><a href="store-trade-events-and-orders-inside-the-database.html#cb271-16" aria-hidden="true" tabindex="-1"></a>      <span class="va">conflict_target:</span> <span class="va">:order_id</span></span>
<span id="cb271-17"><a href="store-trade-events-and-orders-inside-the-database.html#cb271-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb271-18"><a href="store-trade-events-and-orders-inside-the-database.html#cb271-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb271-19"><a href="store-trade-events-and-orders-inside-the-database.html#cb271-19" aria-hidden="true" tabindex="-1"></a>    {<span class="va">:noreply</span>, state}</span>
<span id="cb271-20"><a href="store-trade-events-and-orders-inside-the-database.html#cb271-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb271-21"><a href="store-trade-events-and-orders-inside-the-database.html#cb271-21" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span></code></pre></div>
<p>In the above code, we are copying the matching fields using the <code>struct/2</code> function but all other fields that aren‚Äôt 1 to 1 between two structs won‚Äôt be copied, so we need to merge them in the second step(using the <code>Map.merge/2</code> function). We are also using the <code>on_conflict: :replace_all</code> option to make the <code>insert/2</code> function act as it would be <code>upsert/2</code>(to avoid writing separate logic for inserting and updating the orders).</p>
<p>Having all of this in place we will now be able to store broadcasted orders‚Äô data in the database but there‚Äôs nothing actually broadcasting them.</p>
<p>We need to modify the <code>Naive.Trader</code> module to broadcast the <code>Binance.Order</code> whenever it places buy/sell orders or fetches them again:</p>
<div class="sourceCode" id="cb272"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb272-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># /apps/naive/lib/naive/trader.ex</span></span>
<span id="cb272-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb272-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># inside placing initial buy order callback</span></span>
<span id="cb272-4"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-4" aria-hidden="true" tabindex="-1"></a>    {<span class="va">:ok</span>, %<span class="cn">Binance</span><span class="op">.</span><span class="cn">OrderResponse</span>{} <span class="op">=</span> order} <span class="op">=</span></span>
<span id="cb272-5"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-5" aria-hidden="true" tabindex="-1"></a>      <span class="ot">@binance_client</span><span class="op">.</span>order_limit_buy(symbol, quantity, price, <span class="st">&quot;GTC&quot;</span>)</span>
<span id="cb272-6"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-7"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">:ok</span> <span class="op">=</span> broadcast_order(order)</span>
<span id="cb272-8"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb272-9"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-10"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># inside buy order (partially) filled callback</span></span>
<span id="cb272-11"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-11" aria-hidden="true" tabindex="-1"></a>    {<span class="va">:ok</span>, %<span class="cn">Binance</span><span class="op">.</span><span class="cn">Order</span>{} <span class="op">=</span> current_buy_order} <span class="op">=</span></span>
<span id="cb272-12"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-12" aria-hidden="true" tabindex="-1"></a>      <span class="ot">@binance_client</span><span class="op">.</span>get_order(</span>
<span id="cb272-13"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-13" aria-hidden="true" tabindex="-1"></a>        symbol,</span>
<span id="cb272-14"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-14" aria-hidden="true" tabindex="-1"></a>        timestamp,</span>
<span id="cb272-15"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-15" aria-hidden="true" tabindex="-1"></a>        order_id</span>
<span id="cb272-16"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-16" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb272-17"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-18"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-18" aria-hidden="true" tabindex="-1"></a>    <span class="va">:ok</span> <span class="op">=</span> broadcast_order(current_buy_order)</span>
<span id="cb272-19"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb272-20"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-21"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># inside the same callback in case of buy order filled</span></span>
<span id="cb272-22"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-22" aria-hidden="true" tabindex="-1"></a>        {<span class="va">:ok</span>, %<span class="cn">Binance</span><span class="op">.</span><span class="cn">OrderResponse</span>{} <span class="op">=</span> order} <span class="op">=</span></span>
<span id="cb272-23"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-23" aria-hidden="true" tabindex="-1"></a>          <span class="ot">@binance_client</span><span class="op">.</span>order_limit_sell(symbol, quantity, sell_price, <span class="st">&quot;GTC&quot;</span>)</span>
<span id="cb272-24"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-24" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb272-25"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">:ok</span> <span class="op">=</span> broadcast_order(order)</span>
<span id="cb272-26"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb272-27"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-28"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># inside sell order (partially) filled callback</span></span>
<span id="cb272-29"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-29" aria-hidden="true" tabindex="-1"></a>    {<span class="va">:ok</span>, %<span class="cn">Binance</span><span class="op">.</span><span class="cn">Order</span>{} <span class="op">=</span> current_sell_order} <span class="op">=</span></span>
<span id="cb272-30"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-30" aria-hidden="true" tabindex="-1"></a>      <span class="ot">@binance_client</span><span class="op">.</span>get_order(</span>
<span id="cb272-31"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-31" aria-hidden="true" tabindex="-1"></a>        symbol,</span>
<span id="cb272-32"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-32" aria-hidden="true" tabindex="-1"></a>        timestamp,</span>
<span id="cb272-33"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-33" aria-hidden="true" tabindex="-1"></a>        order_id</span>
<span id="cb272-34"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-34" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb272-35"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb272-36"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-36" aria-hidden="true" tabindex="-1"></a>    <span class="va">:ok</span> <span class="op">=</span> broadcast_order(current_sell_order)</span>
<span id="cb272-37"><a href="store-trade-events-and-orders-inside-the-database.html#cb272-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span></code></pre></div>
<p>Above 4 places send both the <code>Binance.OrderResponse</code> and the <code>Binance.Order</code> structs - our <code>broadcast_order/1</code> function needs to be able to handle them both. Add the following at the bottom of the <code>Naive.Trader</code> module:</p>
<div class="sourceCode" id="cb273"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb273-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb273-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/naive/lib/naive/trader.ex</span></span>
<span id="cb273-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb273-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defp</span> broadcast_order(%<span class="cn">Binance</span><span class="op">.</span><span class="cn">OrderResponse</span>{} <span class="op">=</span> response) <span class="kw">do</span></span>
<span id="cb273-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb273-3" aria-hidden="true" tabindex="-1"></a>    response</span>
<span id="cb273-4"><a href="store-trade-events-and-orders-inside-the-database.html#cb273-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">|&gt;</span> convert_to_order()</span>
<span id="cb273-5"><a href="store-trade-events-and-orders-inside-the-database.html#cb273-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">|&gt;</span> broadcast_order()</span>
<span id="cb273-6"><a href="store-trade-events-and-orders-inside-the-database.html#cb273-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb273-7"><a href="store-trade-events-and-orders-inside-the-database.html#cb273-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-8"><a href="store-trade-events-and-orders-inside-the-database.html#cb273-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defp</span> broadcast_order(%<span class="cn">Binance</span><span class="op">.</span><span class="cn">Order</span>{} <span class="op">=</span> order) <span class="kw">do</span></span>
<span id="cb273-9"><a href="store-trade-events-and-orders-inside-the-database.html#cb273-9" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Phoenix</span><span class="op">.</span><span class="cn">PubSub</span><span class="op">.</span>broadcast(</span>
<span id="cb273-10"><a href="store-trade-events-and-orders-inside-the-database.html#cb273-10" aria-hidden="true" tabindex="-1"></a>      <span class="cn">Streamer</span><span class="op">.</span><span class="cn">PubSub</span>,</span>
<span id="cb273-11"><a href="store-trade-events-and-orders-inside-the-database.html#cb273-11" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;ORDERS:</span><span class="ot">#{</span>order<span class="op">.</span>symbol<span class="ot">}</span><span class="st">&quot;</span>,</span>
<span id="cb273-12"><a href="store-trade-events-and-orders-inside-the-database.html#cb273-12" aria-hidden="true" tabindex="-1"></a>      order</span>
<span id="cb273-13"><a href="store-trade-events-and-orders-inside-the-database.html#cb273-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb273-14"><a href="store-trade-events-and-orders-inside-the-database.html#cb273-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb273-15"><a href="store-trade-events-and-orders-inside-the-database.html#cb273-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-16"><a href="store-trade-events-and-orders-inside-the-database.html#cb273-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defp</span> convert_to_order(%<span class="cn">Binance</span><span class="op">.</span><span class="cn">OrderResponse</span>{} <span class="op">=</span> response) <span class="kw">do</span></span>
<span id="cb273-17"><a href="store-trade-events-and-orders-inside-the-database.html#cb273-17" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span></span>
<span id="cb273-18"><a href="store-trade-events-and-orders-inside-the-database.html#cb273-18" aria-hidden="true" tabindex="-1"></a>      response</span>
<span id="cb273-19"><a href="store-trade-events-and-orders-inside-the-database.html#cb273-19" aria-hidden="true" tabindex="-1"></a>      <span class="op">|&gt;</span> <span class="cn">Map</span><span class="op">.</span>from_struct()</span>
<span id="cb273-20"><a href="store-trade-events-and-orders-inside-the-database.html#cb273-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-21"><a href="store-trade-events-and-orders-inside-the-database.html#cb273-21" aria-hidden="true" tabindex="-1"></a>    struct(<span class="cn">Binance</span><span class="op">.</span><span class="cn">Order</span>, data)</span>
<span id="cb273-22"><a href="store-trade-events-and-orders-inside-the-database.html#cb273-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">|&gt;</span> <span class="cn">Map</span><span class="op">.</span>merge(%{</span>
<span id="cb273-23"><a href="store-trade-events-and-orders-inside-the-database.html#cb273-23" aria-hidden="true" tabindex="-1"></a>      <span class="va">cummulative_quote_qty:</span> <span class="st">&quot;0.00000000&quot;</span>,</span>
<span id="cb273-24"><a href="store-trade-events-and-orders-inside-the-database.html#cb273-24" aria-hidden="true" tabindex="-1"></a>      <span class="va">stop_price:</span> <span class="st">&quot;0.00000000&quot;</span>,</span>
<span id="cb273-25"><a href="store-trade-events-and-orders-inside-the-database.html#cb273-25" aria-hidden="true" tabindex="-1"></a>      <span class="va">iceberg_qty:</span> <span class="st">&quot;0.00000000&quot;</span>,</span>
<span id="cb273-26"><a href="store-trade-events-and-orders-inside-the-database.html#cb273-26" aria-hidden="true" tabindex="-1"></a>      <span class="va">is_working:</span> <span class="cn">true</span></span>
<span id="cb273-27"><a href="store-trade-events-and-orders-inside-the-database.html#cb273-27" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb273-28"><a href="store-trade-events-and-orders-inside-the-database.html#cb273-28" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>As <code>DataWarehouse.Subscriber.Worker</code> process expects only the <code>Binance.Order</code> structs to be broadcasted, we first check is it the <code>Binance.OrderResponse</code> struct and convert the passed value to the <code>Binance.Order</code> struct (if that‚Äôs the case) and only then broadcast it to the PubSub topic.</p>
<p>The converting logic as previously uses the <code>struct/2</code> function but it also merges in default values that are missing from the much smaller <code>Binance.OrderResponse</code> struct(with comparison to the <code>Binance.Order</code>).</p>
<p>At this moment we will be able to store orders inside the database and we can check that by running:</p>
<div class="sourceCode" id="cb274"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb274-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb274-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> iex <span class="at">-S</span> mix</span>
<span id="cb274-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb274-2" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb274-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb274-3" aria-hidden="true" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">1</span><span class="kw">)</span><span class="op">&gt;</span> DataWarehouse.Subscriber.Worker.start_link<span class="kw">(</span><span class="st">&quot;ORDERS:NEOUSDT&quot;</span><span class="kw">)</span></span>
<span id="cb274-4"><a href="store-trade-events-and-orders-inside-the-database.html#cb274-4" aria-hidden="true" tabindex="-1"></a><span class="ex">22:37:43.043</span> [info]  DataWarehouse worker is subscribing to ORDERS:XRPUSDT</span>
<span id="cb274-5"><a href="store-trade-events-and-orders-inside-the-database.html#cb274-5" aria-hidden="true" tabindex="-1"></a><span class="ex">{:ok,</span> <span class="co">#PID&lt;0.400.0&gt;}</span></span>
<span id="cb274-6"><a href="store-trade-events-and-orders-inside-the-database.html#cb274-6" aria-hidden="true" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">2</span><span class="kw">)</span><span class="op">&gt;</span> Naive.start_trading<span class="kw">(</span><span class="st">&quot;NEOUSDT&quot;</span><span class="kw">)</span>                                        <span class="ex">22:38:39.741</span> [info]  Starting Elixir.Naive.SymbolSupervisor worker for NEOUSDT</span>
<span id="cb274-7"><a href="store-trade-events-and-orders-inside-the-database.html#cb274-7" aria-hidden="true" tabindex="-1"></a><span class="ex">22:38:39.832</span> [info]  Starting new supervision tree to trade on NEOUSDT</span>
<span id="cb274-8"><a href="store-trade-events-and-orders-inside-the-database.html#cb274-8" aria-hidden="true" tabindex="-1"></a><span class="ex">{:ok,</span> <span class="co">#PID&lt;0.402.0&gt;}</span></span>
<span id="cb274-9"><a href="store-trade-events-and-orders-inside-the-database.html#cb274-9" aria-hidden="true" tabindex="-1"></a><span class="ex">22:38:41.654</span> [info]  Initializing new trader<span class="er">(</span><span class="ex">1614119921653</span><span class="kw">)</span> <span class="cf">for</span> NEOUSDT</span>
<span id="cb274-10"><a href="store-trade-events-and-orders-inside-the-database.html#cb274-10" aria-hidden="true" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">3</span><span class="kw">)</span><span class="op">&gt;</span> Streamer.start_streaming<span class="kw">(</span><span class="st">&quot;NEOUSDT&quot;</span><span class="kw">)</span>                                   <span class="ex">22:39:23.786</span> [info]  Starting Elixir.Streamer.Binance worker for NEOUSDT</span>
<span id="cb274-11"><a href="store-trade-events-and-orders-inside-the-database.html#cb274-11" aria-hidden="true" tabindex="-1"></a><span class="ex">{:ok,</span> <span class="co">#PID&lt;0.412.0&gt;}</span></span>
<span id="cb274-12"><a href="store-trade-events-and-orders-inside-the-database.html#cb274-12" aria-hidden="true" tabindex="-1"></a><span class="ex">22:39:27.187</span> [info]  The trader<span class="er">(</span><span class="ex">1614119921653</span><span class="kw">)</span> <span class="ex">is</span> placing a BUY order for NEOUSDT @ 37.549, quantity: 5.326</span>
<span id="cb274-13"><a href="store-trade-events-and-orders-inside-the-database.html#cb274-13" aria-hidden="true" tabindex="-1"></a><span class="ex">22:39:27.449</span> [info]  The trader<span class="er">(</span><span class="ex">1614119921653</span><span class="kw">)</span> <span class="ex">is</span> placing a SELL order for NEOUSDT @ 37.578, quantity: 5.326.</span></code></pre></div>
<p>At this moment inside the DataWarehouse‚Äôs database we should see orders:</p>
<div class="sourceCode" id="cb275"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb275-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> psql <span class="at">-Upostgres</span> <span class="at">-h127.0.0.1</span></span>
<span id="cb275-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Password</span> for user postgres: </span>
<span id="cb275-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-3" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb275-4"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-4" aria-hidden="true" tabindex="-1"></a><span class="va">postgres=</span># <span class="ex">\c</span> data_warehouse<span class="kw">;</span></span>
<span id="cb275-5"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-5" aria-hidden="true" tabindex="-1"></a><span class="ex">You</span> are now connected to database <span class="st">&quot;data_warehouse&quot;</span> as user <span class="st">&quot;postgres&quot;</span>.</span>
<span id="cb275-6"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-6" aria-hidden="true" tabindex="-1"></a><span class="va">data_warehouse=</span># <span class="ex">\x</span></span>
<span id="cb275-7"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-7" aria-hidden="true" tabindex="-1"></a><span class="ex">Expanded</span> display is on.</span>
<span id="cb275-8"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-8" aria-hidden="true" tabindex="-1"></a><span class="va">data_warehouse=</span># <span class="ex">SELECT</span> <span class="pp">*</span> FROM orders<span class="kw">;</span></span>
<span id="cb275-9"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-9" aria-hidden="true" tabindex="-1"></a><span class="ex">-[</span> RECORD 1 ]--------------+---------------------------------</span>
<span id="cb275-10"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-10" aria-hidden="true" tabindex="-1"></a><span class="ex">order_id</span>                   <span class="kw">|</span> <span class="ex">1</span></span>
<span id="cb275-11"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-11" aria-hidden="true" tabindex="-1"></a><span class="ex">client_order_id</span>            <span class="kw">|</span> <span class="ex">C81E728D9D4C2F636F067F89CC14862C</span></span>
<span id="cb275-12"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-12" aria-hidden="true" tabindex="-1"></a><span class="ex">symbol</span>                     <span class="kw">|</span> <span class="ex">NEOUSDT</span></span>
<span id="cb275-13"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-13" aria-hidden="true" tabindex="-1"></a><span class="ex">price</span>                      <span class="kw">|</span> <span class="ex">38.16</span></span>
<span id="cb275-14"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-14" aria-hidden="true" tabindex="-1"></a><span class="ex">original_quantity</span>          <span class="kw">|</span> <span class="ex">5.241</span></span>
<span id="cb275-15"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-15" aria-hidden="true" tabindex="-1"></a><span class="ex">executed_quantity</span>          <span class="kw">|</span> <span class="ex">0.00000000</span></span>
<span id="cb275-16"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-16" aria-hidden="true" tabindex="-1"></a><span class="ex">cummulative_quote_quantity</span> <span class="kw">|</span> <span class="ex">0.00000000</span></span>
<span id="cb275-17"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-17" aria-hidden="true" tabindex="-1"></a><span class="ex">status</span>                     <span class="kw">|</span> <span class="ex">FILLED</span></span>
<span id="cb275-18"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-18" aria-hidden="true" tabindex="-1"></a><span class="ex">time_in_force</span>              <span class="kw">|</span> <span class="ex">GTC</span></span>
<span id="cb275-19"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-19" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>                       <span class="kw">|</span> <span class="ex">LIMIT</span></span>
<span id="cb275-20"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-20" aria-hidden="true" tabindex="-1"></a><span class="ex">side</span>                       <span class="kw">|</span> <span class="ex">BUY</span></span>
<span id="cb275-21"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-21" aria-hidden="true" tabindex="-1"></a><span class="ex">stop_price</span>                 <span class="kw">|</span> <span class="ex">0.00000000</span></span>
<span id="cb275-22"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-22" aria-hidden="true" tabindex="-1"></a><span class="ex">iceberg_quantity</span>           <span class="kw">|</span> <span class="ex">0.00000000</span></span>
<span id="cb275-23"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-23" aria-hidden="true" tabindex="-1"></a><span class="bu">time</span>                       <span class="kw">|</span> <span class="ex">1614120906320</span></span>
<span id="cb275-24"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-24" aria-hidden="true" tabindex="-1"></a><span class="ex">update_time</span>                <span class="kw">|</span> <span class="ex">1614120906320</span></span>
<span id="cb275-25"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-25" aria-hidden="true" tabindex="-1"></a><span class="ex">inserted_at</span>                <span class="kw">|</span> <span class="ex">2021-02-23</span> 22:55:10</span>
<span id="cb275-26"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-26" aria-hidden="true" tabindex="-1"></a><span class="ex">updated_at</span>                 <span class="kw">|</span> <span class="ex">2021-02-23</span> 22:55:10</span>
<span id="cb275-27"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-27" aria-hidden="true" tabindex="-1"></a><span class="ex">-[</span> RECORD 2 ]--------------+---------------------------------</span>
<span id="cb275-28"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-28" aria-hidden="true" tabindex="-1"></a><span class="ex">order_id</span>                   <span class="kw">|</span> <span class="ex">2</span></span>
<span id="cb275-29"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-29" aria-hidden="true" tabindex="-1"></a><span class="ex">client_order_id</span>            <span class="kw">|</span> <span class="ex">ECCBC87E4B5CE2FE28308FD9F2A7BAF3</span></span>
<span id="cb275-30"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-30" aria-hidden="true" tabindex="-1"></a><span class="ex">symbol</span>                     <span class="kw">|</span> <span class="ex">NEOUSDT</span></span>
<span id="cb275-31"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-31" aria-hidden="true" tabindex="-1"></a><span class="ex">price</span>                      <span class="kw">|</span> <span class="ex">38.19</span></span>
<span id="cb275-32"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-32" aria-hidden="true" tabindex="-1"></a><span class="ex">original_quantity</span>          <span class="kw">|</span> <span class="ex">5.241</span></span>
<span id="cb275-33"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-33" aria-hidden="true" tabindex="-1"></a><span class="ex">executed_quantity</span>          <span class="kw">|</span> <span class="ex">0.00000000</span></span>
<span id="cb275-34"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-34" aria-hidden="true" tabindex="-1"></a><span class="ex">cummulative_quote_quantity</span> <span class="kw">|</span> <span class="ex">0.00000000</span></span>
<span id="cb275-35"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-35" aria-hidden="true" tabindex="-1"></a><span class="ex">status</span>                     <span class="kw">|</span> <span class="ex">NEW</span></span>
<span id="cb275-36"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-36" aria-hidden="true" tabindex="-1"></a><span class="ex">time_in_force</span>              <span class="kw">|</span> <span class="ex">GTC</span></span>
<span id="cb275-37"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-37" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>                       <span class="kw">|</span> <span class="ex">LIMIT</span></span>
<span id="cb275-38"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-38" aria-hidden="true" tabindex="-1"></a><span class="ex">side</span>                       <span class="kw">|</span> <span class="ex">SELL</span></span>
<span id="cb275-39"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-39" aria-hidden="true" tabindex="-1"></a><span class="ex">stop_price</span>                 <span class="kw">|</span> <span class="ex">0.00000000</span></span>
<span id="cb275-40"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-40" aria-hidden="true" tabindex="-1"></a><span class="ex">iceberg_quantity</span>           <span class="kw">|</span> <span class="ex">0.00000000</span></span>
<span id="cb275-41"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-41" aria-hidden="true" tabindex="-1"></a><span class="bu">time</span>                       <span class="kw">|</span> </span>
<span id="cb275-42"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-42" aria-hidden="true" tabindex="-1"></a><span class="ex">update_time</span>                <span class="kw">|</span> </span>
<span id="cb275-43"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-43" aria-hidden="true" tabindex="-1"></a><span class="ex">inserted_at</span>                <span class="kw">|</span> <span class="ex">2021-02-23</span> 22:55:10</span>
<span id="cb275-44"><a href="store-trade-events-and-orders-inside-the-database.html#cb275-44" aria-hidden="true" tabindex="-1"></a><span class="ex">updated_at</span>                 <span class="kw">|</span> <span class="ex">2021-02-23</span> 22:55:10</span></code></pre></div>
<p>The first record above got inserted and updated as its state is ‚ÄúFILLED‚Äù, the second one wasn‚Äôt updated yet as it‚Äôs still in ‚ÄúNEW‚Äù state - that confirms that the upsert trick works.</p>
<p>That finishes the implementation of storing orders inside the database.</p>
</div>
<div id="implement-supervision" class="section level2" number="14.7">
<h2><span class="header-section-number">14.7</span> Implement supervision</h2>
<p>Currently, we have a <code>DataWarehouse.Subscriber.Worker</code> process that will take care of storing data into the database, but sadly if anything will go wrong inside our worker and it will crash there‚Äôs no supervision in place to restart it.</p>
<p>The supervision tree for the <code>data_warehouse</code> application will be similar to ones from the <code>naive</code> and <code>streamer</code> apps but different enough to <em>not</em> use the <code>Core.ServiceSupervisor</code> abstraction.</p>
<p>For example, it doesn‚Äôt use the <code>symbol</code> column, it works based on the <code>topic</code> column. This would require changes to the <code>Core.ServiceSupervisor</code>‚Äôs functions like <code>update_status/4</code> or <code>fetch_symbols_to_start/2</code>, we could update them to accept column name but that would need to be passed through other functions. We can see that this is probably not the best approach and the further we will get the more complex it will become. The second issue would be that we are registering all processes with names and that can be problematic as the list of processes will start to grow(as we can imagine in the case of the <code>data_warehouse</code> application).</p>
<p>The better approach would be to mix the <a href="https://hexdocs.pm/elixir/master/DynamicSupervisor.html">DynamicSupervisor</a> together with <a href="https://hexdocs.pm/elixir/master/Registry.html">Registry</a>.</p>
<p>The <code>DynamicSupervisor</code> will supervise the <code>Subscriber.Worker</code>s and instead of keeping track of them by registering them using atoms we will start them <code>:via</code> Elixir <code>Registry</code>.</p>
<p>We will add all functionality that we implemented for <code>naive</code> and <code>streamer</code> applications. We will provide the functions to start and stop storing data on passed PubSub topics as well as store those topics inside the database so storing will be autostarted.</p>
<div id="create-subscriber_settings-table" class="section level3" number="14.7.1">
<h3><span class="header-section-number">14.7.1</span> Create <code>subscriber_settings</code> table</h3>
<p>To provide autostarting function we need to create a new migration that will create the <code>subscriber_settings</code> table:</p>
<div class="sourceCode" id="cb276"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb276-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb276-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cd apps/data_warehouse</span>
<span id="cb276-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb276-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> mix ecto.gen.migration create_subscriber_settings</span>
<span id="cb276-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb276-3" aria-hidden="true" tabindex="-1"></a><span class="ex">*</span> creating priv/repo/migrations/20210227230123_create_subscriber_settings.exs</span></code></pre></div>
<p>At this moment we can copy the code to create the <code>settings</code> table(enum and index as well) from the <code>streamer</code> application and tweak it to fit the <code>data_warehouse</code> application. So the first important change (beside updating namespaces from <code>Streamer</code> to <code>DataWarehouse</code>) will be to make a note that we have a setting per topic - not per symbol as for the <code>naive</code> and <code>streamer</code> applications:</p>
<div class="sourceCode" id="cb277"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb277-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb277-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/data_warehouse/priv/repo/migrations/20210227230123_create_subscriber_settings.exs</span></span>
<span id="cb277-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb277-2" aria-hidden="true" tabindex="-1"></a><span class="kw">defmodule</span> <span class="cn">DataWarehouse</span><span class="op">.</span><span class="cn">Repo</span><span class="op">.</span><span class="cn">Migrations</span><span class="op">.</span><span class="cn">CreateSubscriberSettings</span> <span class="kw">do</span></span>
<span id="cb277-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb277-3" aria-hidden="true" tabindex="-1"></a>  <span class="im">use</span> <span class="cn">Ecto</span><span class="op">.</span><span class="cn">Migration</span></span>
<span id="cb277-4"><a href="store-trade-events-and-orders-inside-the-database.html#cb277-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb277-5"><a href="store-trade-events-and-orders-inside-the-database.html#cb277-5" aria-hidden="true" tabindex="-1"></a>  <span class="im">alias</span> <span class="cn">DataWarehouse</span><span class="op">.</span><span class="cn">Schema</span><span class="op">.</span><span class="cn">SubscriberStatusEnum</span></span>
<span id="cb277-6"><a href="store-trade-events-and-orders-inside-the-database.html#cb277-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb277-7"><a href="store-trade-events-and-orders-inside-the-database.html#cb277-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> change <span class="kw">do</span></span>
<span id="cb277-8"><a href="store-trade-events-and-orders-inside-the-database.html#cb277-8" aria-hidden="true" tabindex="-1"></a>    <span class="cn">SubscriberStatusEnum</span><span class="op">.</span>create_type()</span>
<span id="cb277-9"><a href="store-trade-events-and-orders-inside-the-database.html#cb277-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb277-10"><a href="store-trade-events-and-orders-inside-the-database.html#cb277-10" aria-hidden="true" tabindex="-1"></a>    create table(<span class="va">:subscriber_settings</span>, <span class="va">primary_key:</span> <span class="cn">false</span>) <span class="kw">do</span></span>
<span id="cb277-11"><a href="store-trade-events-and-orders-inside-the-database.html#cb277-11" aria-hidden="true" tabindex="-1"></a>      add(<span class="va">:id</span>, <span class="va">:uuid</span>, <span class="va">primary_key:</span> <span class="cn">true</span>)</span>
<span id="cb277-12"><a href="store-trade-events-and-orders-inside-the-database.html#cb277-12" aria-hidden="true" tabindex="-1"></a>      add(<span class="va">:topic</span>, <span class="va">:text</span>, <span class="va">null:</span> <span class="cn">false</span>)</span>
<span id="cb277-13"><a href="store-trade-events-and-orders-inside-the-database.html#cb277-13" aria-hidden="true" tabindex="-1"></a>      add(<span class="va">:status</span>, <span class="cn">SubscriberStatusEnum</span><span class="op">.</span>type(), <span class="va">default:</span> <span class="st">&quot;off&quot;</span>, <span class="va">null:</span> <span class="cn">false</span>)</span>
<span id="cb277-14"><a href="store-trade-events-and-orders-inside-the-database.html#cb277-14" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb277-15"><a href="store-trade-events-and-orders-inside-the-database.html#cb277-15" aria-hidden="true" tabindex="-1"></a>      timestamps()</span>
<span id="cb277-16"><a href="store-trade-events-and-orders-inside-the-database.html#cb277-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb277-17"><a href="store-trade-events-and-orders-inside-the-database.html#cb277-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb277-18"><a href="store-trade-events-and-orders-inside-the-database.html#cb277-18" aria-hidden="true" tabindex="-1"></a>    create(unique_index(<span class="va">:subscriber_settings</span>, [<span class="va">:topic</span>]))</span>
<span id="cb277-19"><a href="store-trade-events-and-orders-inside-the-database.html#cb277-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb277-20"><a href="store-trade-events-and-orders-inside-the-database.html#cb277-20" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<p>Both schema and enum will be almost identical to the ones from the <code>streamer</code> application - we can simply copy those files and apply basic tweaks like updating the namespace:</p>
<div class="sourceCode" id="cb278"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb278-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb278-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cp apps/streamer/lib/streamer/schema/settings.ex apps/data_warehouse/lib/data_warehouse/schema/subscriber_settings.ex</span>
<span id="cb278-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb278-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cp apps/streamer/lib/streamer/schema/streaming_status_enum.ex apps/data_warehouse/lib/data_warehouse/schema/subscriber_status_enum.ex</span></code></pre></div>
<p>Remember about updating the <code>symbol</code> column to <code>topic</code> as well as table name inside the <code>DataWarehouse.Schema.SubscriberSettings</code>:</p>
<div class="sourceCode" id="cb279"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb279-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb279-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/data_warehouse/lib/data_warehouse/schema/subscriber_settings.ex</span></span>
<span id="cb279-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb279-2" aria-hidden="true" tabindex="-1"></a><span class="kw">defmodule</span> <span class="cn">DataWarehouse</span><span class="op">.</span><span class="cn">Schema</span><span class="op">.</span><span class="cn">SubscriberSettings</span> <span class="kw">do</span></span>
<span id="cb279-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb279-3" aria-hidden="true" tabindex="-1"></a>  <span class="im">use</span> <span class="cn">Ecto</span><span class="op">.</span><span class="cn">Schema</span></span>
<span id="cb279-4"><a href="store-trade-events-and-orders-inside-the-database.html#cb279-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-5"><a href="store-trade-events-and-orders-inside-the-database.html#cb279-5" aria-hidden="true" tabindex="-1"></a>  <span class="im">alias</span> <span class="cn">DataWarehouse</span><span class="op">.</span><span class="cn">Schema</span><span class="op">.</span><span class="cn">SubscriberStatusEnum</span></span>
<span id="cb279-6"><a href="store-trade-events-and-orders-inside-the-database.html#cb279-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-7"><a href="store-trade-events-and-orders-inside-the-database.html#cb279-7" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@primary_key</span> {<span class="va">:id</span>, <span class="va">:binary_id</span>, <span class="va">autogenerate:</span> <span class="cn">true</span>}</span>
<span id="cb279-8"><a href="store-trade-events-and-orders-inside-the-database.html#cb279-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-9"><a href="store-trade-events-and-orders-inside-the-database.html#cb279-9" aria-hidden="true" tabindex="-1"></a>  schema <span class="st">&quot;subscriber_settings&quot;</span> <span class="kw">do</span></span>
<span id="cb279-10"><a href="store-trade-events-and-orders-inside-the-database.html#cb279-10" aria-hidden="true" tabindex="-1"></a>    field(<span class="va">:topic</span>, <span class="va">:string</span>)</span>
<span id="cb279-11"><a href="store-trade-events-and-orders-inside-the-database.html#cb279-11" aria-hidden="true" tabindex="-1"></a>    field(<span class="va">:status</span>, <span class="cn">SubscriberStatusEnum</span>)</span>
<span id="cb279-12"><a href="store-trade-events-and-orders-inside-the-database.html#cb279-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-13"><a href="store-trade-events-and-orders-inside-the-database.html#cb279-13" aria-hidden="true" tabindex="-1"></a>    timestamps()</span>
<span id="cb279-14"><a href="store-trade-events-and-orders-inside-the-database.html#cb279-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb279-15"><a href="store-trade-events-and-orders-inside-the-database.html#cb279-15" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<p>Inside <code>apps/data_warehouse/lib/data_warehouse/schema/subscriber_status_enum.ex</code> we need to swap references of <code>Streamer</code> to <code>DataWarehouse</code> and references of <code>StreamingStatusEnum</code> to <code>SubscriberStatusEnum</code>:</p>
<div class="sourceCode" id="cb280"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb280-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb280-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/data_warehouse/lib/data_warehouse/schema/subscriber_status_enum.ex</span></span>
<span id="cb280-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb280-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="cn">EctoEnum</span></span>
<span id="cb280-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb280-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb280-4"><a href="store-trade-events-and-orders-inside-the-database.html#cb280-4" aria-hidden="true" tabindex="-1"></a>defenum(<span class="cn">DataWarehouse</span><span class="op">.</span><span class="cn">Schema</span><span class="op">.</span><span class="cn">SubscriberStatusEnum</span>, <span class="va">:subscriber_status</span>, [<span class="va">:on</span>, <span class="va">:off</span>])</span></code></pre></div>
<p>Don‚Äôt forget to run the migration:</p>
<div class="sourceCode" id="cb281"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb281-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb281-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> mix ecto.migrate</span></code></pre></div>
<p>At this moment we have all pieces in place to execute queries on our new table. In this place, we can think about the seeding script. For the <code>data_warehouse</code> specifically, we won‚Äôt need to provide that script as we don‚Äôt know in advance what topic names we will use. Instead of seeding settings in advance, our code will ‚Äúupsert‚Äù(using <code>insert</code> function) settings when <code>start_storing/1</code> or <code>stop_storing/1</code> are called.</p>
</div>
<div id="redesign-supervision-using-registry" class="section level3" number="14.7.2">
<h3><span class="header-section-number">14.7.2</span> Redesign supervision using Registry</h3>
<p>We can now focus on drafting a supervision tree for the <code>data_warehouse</code> application. At this moment we have only the <code>DataWarehouse.Subscriber.Worker</code> and the <code>DataWarehouse.Application</code> modules.</p>
<p>As it was with the case of <code>naive</code> and <code>streamer</code> applications, we will need an additional level of supervision to cater for ‚Äúautostarting‚Äù <code>Task</code> as well as, in the case of the <code>data_warehouse</code> application the <code>Registry</code>.</p>
<p>The full supervision tree will look as follows:</p>
<div class="figure">
<img src="images/chapter_14_01_sup_diagram.png" alt="" />
<p class="caption">Supervision tree with Registry</p>
</div>
<p>Everything looks very similar to the supervision tree that we created in the <code>streamer</code> and the <code>naive</code> applications but there‚Äôs an additional <code>Registry</code> that is supervised by the <code>SubscriberSupervisior</code> process.</p>
<p>The idea is that inside the <code>Worker</code> module‚Äôs <code>start_link/1</code> we will register worker processes using <a href="https://hexdocs.pm/elixir/master/GenServer.html#module-name-registration">:via</a> tuple. Internally, GenServer will utilize <code>Registry</code>‚Äôs functions like <code>register_name/2</code> to add process to the registry under the <code>topic</code> string. This way we will be able to retrieve pids assigned to topics using those topic strings instead of registering each worker process with an atom name.</p>
<p>Just as previously the <code>DynamicSupervisor</code> will be in charge of the supervising the <code>Worker</code> processes and it won‚Äôt be even aware that we are using the <code>Registry</code> to keep track of <code>topic =&gt; pid</code> association.</p>
</div>
<div id="create-the-datawarehouse.subscriber.dynamicsupervisor-module" class="section level3" number="14.7.3">
<h3><span class="header-section-number">14.7.3</span> Create the <code>DataWarehouse.Subscriber.DynamicSupervisor</code> module</h3>
<p>Let‚Äôs start by creating a new file called <code>dynamic_supervisor.ex</code> inside the <code>apps/data_warehouse/lib/data_warehouse/subscriber</code> directory and put default dynamic supervisor implementation inside:</p>
<div class="sourceCode" id="cb282"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb282-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb282-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/data_warehouse/lib/data_warehouse/subscriber/dynamic_supervisor.ex</span></span>
<span id="cb282-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb282-2" aria-hidden="true" tabindex="-1"></a><span class="kw">defmodule</span> <span class="cn">DataWarehouse</span><span class="op">.</span><span class="cn">Subscriber</span><span class="op">.</span><span class="cn">DynamicSupervisor</span> <span class="kw">do</span></span>
<span id="cb282-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb282-3" aria-hidden="true" tabindex="-1"></a>  <span class="im">use</span> <span class="cn">DynamicSupervisor</span></span>
<span id="cb282-4"><a href="store-trade-events-and-orders-inside-the-database.html#cb282-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb282-5"><a href="store-trade-events-and-orders-inside-the-database.html#cb282-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> start_link(_arg) <span class="kw">do</span></span>
<span id="cb282-6"><a href="store-trade-events-and-orders-inside-the-database.html#cb282-6" aria-hidden="true" tabindex="-1"></a>    <span class="cn">DynamicSupervisor</span><span class="op">.</span>start_link(<span class="cn">__MODULE__</span>, [], <span class="va">name:</span> <span class="cn">__MODULE__</span>)</span>
<span id="cb282-7"><a href="store-trade-events-and-orders-inside-the-database.html#cb282-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb282-8"><a href="store-trade-events-and-orders-inside-the-database.html#cb282-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb282-9"><a href="store-trade-events-and-orders-inside-the-database.html#cb282-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> init(_arg) <span class="kw">do</span></span>
<span id="cb282-10"><a href="store-trade-events-and-orders-inside-the-database.html#cb282-10" aria-hidden="true" tabindex="-1"></a>    <span class="cn">DynamicSupervisor</span><span class="op">.</span>init(<span class="va">strategy:</span> <span class="va">:one_for_one</span>)</span>
<span id="cb282-11"><a href="store-trade-events-and-orders-inside-the-database.html#cb282-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb282-12"><a href="store-trade-events-and-orders-inside-the-database.html#cb282-12" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<p>As we will put all our logic related to autostarting, starting and stopping inside this module we can already add aliases, import and require:</p>
<div class="sourceCode" id="cb283"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb283-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb283-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/data_warehouse/lib/data_warehouse/subscriber/dynamic_supervisor.ex</span></span>
<span id="cb283-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb283-2" aria-hidden="true" tabindex="-1"></a>  <span class="im">require</span> <span class="cn">Logger</span></span>
<span id="cb283-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb283-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-4"><a href="store-trade-events-and-orders-inside-the-database.html#cb283-4" aria-hidden="true" tabindex="-1"></a>  <span class="im">alias</span> <span class="cn">DataWarehouse</span><span class="op">.</span><span class="cn">Repo</span></span>
<span id="cb283-5"><a href="store-trade-events-and-orders-inside-the-database.html#cb283-5" aria-hidden="true" tabindex="-1"></a>  <span class="im">alias</span> <span class="cn">DataWarehouse</span><span class="op">.</span><span class="cn">Schema</span><span class="op">.</span><span class="cn">SubscriberSettings</span></span>
<span id="cb283-6"><a href="store-trade-events-and-orders-inside-the-database.html#cb283-6" aria-hidden="true" tabindex="-1"></a>  <span class="im">alias</span> <span class="cn">DataWarehouse</span><span class="op">.</span><span class="cn">Subscriber</span><span class="op">.</span><span class="cn">Worker</span></span>
<span id="cb283-7"><a href="store-trade-events-and-orders-inside-the-database.html#cb283-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-8"><a href="store-trade-events-and-orders-inside-the-database.html#cb283-8" aria-hidden="true" tabindex="-1"></a>  <span class="im">import</span> <span class="cn">Ecto</span><span class="op">.</span><span class="cn">Query</span>, <span class="va">only:</span> [<span class="va">from:</span> <span class="dv">2</span>]</span>
<span id="cb283-9"><a href="store-trade-events-and-orders-inside-the-database.html#cb283-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-10"><a href="store-trade-events-and-orders-inside-the-database.html#cb283-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@registry</span> <span class="va">:subscriber_workers</span></span></code></pre></div>
<p>Additionally, we added the <code>@registry</code> module attribute that we will use to retrieve pid for the specific topic.</p>
<p>We can move on to implementing <code>autostart_workers/0</code> which will look very similar to the ones that we implemented in the <code>streamer</code> and the <code>naive</code> applications:</p>
<div class="sourceCode" id="cb284"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb284-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb284-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/data_warehouse/lib/data_warehouse/subscriber/dynamic_supervisor.ex</span></span>
<span id="cb284-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb284-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb284-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb284-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> autostart_workers() <span class="kw">do</span></span>
<span id="cb284-4"><a href="store-trade-events-and-orders-inside-the-database.html#cb284-4" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Repo</span><span class="op">.</span>all(</span>
<span id="cb284-5"><a href="store-trade-events-and-orders-inside-the-database.html#cb284-5" aria-hidden="true" tabindex="-1"></a>      from(s <span class="kw">in</span> <span class="cn">SubscriberSettings</span>,</span>
<span id="cb284-6"><a href="store-trade-events-and-orders-inside-the-database.html#cb284-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">where:</span> s<span class="op">.</span>status <span class="op">==</span> <span class="st">&quot;on&quot;</span>,</span>
<span id="cb284-7"><a href="store-trade-events-and-orders-inside-the-database.html#cb284-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">select:</span> s<span class="op">.</span>topic</span>
<span id="cb284-8"><a href="store-trade-events-and-orders-inside-the-database.html#cb284-8" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb284-9"><a href="store-trade-events-and-orders-inside-the-database.html#cb284-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb284-10"><a href="store-trade-events-and-orders-inside-the-database.html#cb284-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">|&gt;</span> <span class="cn">Enum</span><span class="op">.</span>map(<span class="op">&amp;</span>start_child<span class="op">/</span><span class="dv">1</span>)</span>
<span id="cb284-11"><a href="store-trade-events-and-orders-inside-the-database.html#cb284-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb284-12"><a href="store-trade-events-and-orders-inside-the-database.html#cb284-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb284-13"><a href="store-trade-events-and-orders-inside-the-database.html#cb284-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defp</span> start_child(args) <span class="kw">do</span></span>
<span id="cb284-14"><a href="store-trade-events-and-orders-inside-the-database.html#cb284-14" aria-hidden="true" tabindex="-1"></a>    <span class="cn">DynamicSupervisor</span><span class="op">.</span>start_child(</span>
<span id="cb284-15"><a href="store-trade-events-and-orders-inside-the-database.html#cb284-15" aria-hidden="true" tabindex="-1"></a>      <span class="cn">__MODULE__</span>,</span>
<span id="cb284-16"><a href="store-trade-events-and-orders-inside-the-database.html#cb284-16" aria-hidden="true" tabindex="-1"></a>      {<span class="cn">Worker</span>, args}</span>
<span id="cb284-17"><a href="store-trade-events-and-orders-inside-the-database.html#cb284-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb284-18"><a href="store-trade-events-and-orders-inside-the-database.html#cb284-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>We can see that we are querying the database for list of <code>topic</code>s(not symbols) and we are calling <code>start_child/2</code> for each results.</p>
<p>The <code>start_worker/1</code> is where the <code>Registry</code> will shine as we won‚Äôt need to check is there already a process running for that topic - we can leave that check to the <code>Registry</code>. If there‚Äôs process already running for that topic it will just return a tuple starting with <code>:error</code> atom:</p>
<div class="sourceCode" id="cb285"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb285-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb285-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/data_warehouse/lib/data_warehouse/subscriber/dynamic_supervisor.ex</span></span>
<span id="cb285-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb285-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb285-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb285-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> start_worker(topic) <span class="kw">do</span></span>
<span id="cb285-4"><a href="store-trade-events-and-orders-inside-the-database.html#cb285-4" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Logger</span><span class="op">.</span>info(<span class="st">&quot;Starting storing data from </span><span class="ot">#{</span>topic<span class="ot">}</span><span class="st"> topic&quot;</span>)</span>
<span id="cb285-5"><a href="store-trade-events-and-orders-inside-the-database.html#cb285-5" aria-hidden="true" tabindex="-1"></a>    update_status(topic, <span class="st">&quot;on&quot;</span>)</span>
<span id="cb285-6"><a href="store-trade-events-and-orders-inside-the-database.html#cb285-6" aria-hidden="true" tabindex="-1"></a>    start_child(topic)</span>
<span id="cb285-7"><a href="store-trade-events-and-orders-inside-the-database.html#cb285-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb285-8"><a href="store-trade-events-and-orders-inside-the-database.html#cb285-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb285-9"><a href="store-trade-events-and-orders-inside-the-database.html#cb285-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defp</span> update_status(topic, status)</span>
<span id="cb285-10"><a href="store-trade-events-and-orders-inside-the-database.html#cb285-10" aria-hidden="true" tabindex="-1"></a>       <span class="kw">when</span> is_binary(topic) <span class="kw">and</span> is_binary(status) <span class="kw">do</span></span>
<span id="cb285-11"><a href="store-trade-events-and-orders-inside-the-database.html#cb285-11" aria-hidden="true" tabindex="-1"></a>    %<span class="cn">SubscriberSettings</span>{</span>
<span id="cb285-12"><a href="store-trade-events-and-orders-inside-the-database.html#cb285-12" aria-hidden="true" tabindex="-1"></a>      <span class="va">topic:</span> topic,</span>
<span id="cb285-13"><a href="store-trade-events-and-orders-inside-the-database.html#cb285-13" aria-hidden="true" tabindex="-1"></a>      <span class="va">status:</span> status</span>
<span id="cb285-14"><a href="store-trade-events-and-orders-inside-the-database.html#cb285-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb285-15"><a href="store-trade-events-and-orders-inside-the-database.html#cb285-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">|&gt;</span> <span class="cn">Repo</span><span class="op">.</span>insert(</span>
<span id="cb285-16"><a href="store-trade-events-and-orders-inside-the-database.html#cb285-16" aria-hidden="true" tabindex="-1"></a>      <span class="va">on_conflict:</span> <span class="va">:replace_all</span>,</span>
<span id="cb285-17"><a href="store-trade-events-and-orders-inside-the-database.html#cb285-17" aria-hidden="true" tabindex="-1"></a>      <span class="va">conflict_target:</span> <span class="va">:topic</span></span>
<span id="cb285-18"><a href="store-trade-events-and-orders-inside-the-database.html#cb285-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb285-19"><a href="store-trade-events-and-orders-inside-the-database.html#cb285-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>As we are not seeding the database with the default settings we will use the <code>insert/2</code> function with options(as previously) to make it work as it would be an ‚Äúupsert‚Äù function.</p>
<p>Last function in this module will be <code>stop_worker/1</code> which uses private <code>stop_child/1</code> function. The <code>stop_child/1</code> function shows how to retrieve <code>pid</code> of the process assigned to the passed <code>topic</code>:</p>
<div class="sourceCode" id="cb286"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb286-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb286-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/data_warehouse/lib/data_warehouse/subscriber/dynamic_supervisor.ex</span></span>
<span id="cb286-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb286-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb286-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb286-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> stop_worker(topic) <span class="kw">do</span></span>
<span id="cb286-4"><a href="store-trade-events-and-orders-inside-the-database.html#cb286-4" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Logger</span><span class="op">.</span>info(<span class="st">&quot;Stopping storing data from </span><span class="ot">#{</span>topic<span class="ot">}</span><span class="st"> topic&quot;</span>)</span>
<span id="cb286-5"><a href="store-trade-events-and-orders-inside-the-database.html#cb286-5" aria-hidden="true" tabindex="-1"></a>    update_status(topic, <span class="st">&quot;off&quot;</span>)</span>
<span id="cb286-6"><a href="store-trade-events-and-orders-inside-the-database.html#cb286-6" aria-hidden="true" tabindex="-1"></a>    stop_child(topic)</span>
<span id="cb286-7"><a href="store-trade-events-and-orders-inside-the-database.html#cb286-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb286-8"><a href="store-trade-events-and-orders-inside-the-database.html#cb286-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb286-9"><a href="store-trade-events-and-orders-inside-the-database.html#cb286-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defp</span> stop_child(args) <span class="kw">do</span></span>
<span id="cb286-10"><a href="store-trade-events-and-orders-inside-the-database.html#cb286-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">case</span> <span class="cn">Registry</span><span class="op">.</span>lookup(<span class="ot">@registry</span>, args) <span class="kw">do</span></span>
<span id="cb286-11"><a href="store-trade-events-and-orders-inside-the-database.html#cb286-11" aria-hidden="true" tabindex="-1"></a>      [{pid, _}] <span class="op">-&gt;</span> <span class="cn">DynamicSupervisor</span><span class="op">.</span>terminate_child(<span class="cn">__MODULE__</span>, pid)</span>
<span id="cb286-12"><a href="store-trade-events-and-orders-inside-the-database.html#cb286-12" aria-hidden="true" tabindex="-1"></a>      _ <span class="op">-&gt;</span> <span class="cn">Logger</span><span class="op">.</span>warn(<span class="st">&quot;Unable to locate process assigned to </span><span class="ot">#{</span>inspect(args)<span class="ot">}</span><span class="st">&quot;</span>)</span>
<span id="cb286-13"><a href="store-trade-events-and-orders-inside-the-database.html#cb286-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb286-14"><a href="store-trade-events-and-orders-inside-the-database.html#cb286-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>That is a full implementation of the <code>DataWarehouse.Subscriber.DynamicSupervisor</code> module and it‚Äôs almost as slim as one from the last chapter where we leveraged macros to achieve that lightness. Using the <code>Registry</code> is the preferred way to manage a list of identifiable processes. We won‚Äôt run into an issue of overusing the atoms(as they are not garbage collected, we could hit that limit sooner or later).</p>
</div>
<div id="register-worker-processes-using-via" class="section level3" number="14.7.4">
<h3><span class="header-section-number">14.7.4</span> Register Worker processes using :via</h3>
<p>The above <code>DynamicSupervisor</code> module assumes that Workers are registered inside the <code>Registry</code> - to make this happen we will need to update the <code>start_link/1</code> function of the <code>DataWarehouse.Subscriber.Worker</code> module:</p>
<div class="sourceCode" id="cb287"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb287-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb287-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/data_warehouse/lib/data_warehouse/subscriber/worker.ex</span></span>
<span id="cb287-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb287-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb287-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb287-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> start_link(topic) <span class="kw">do</span></span>
<span id="cb287-4"><a href="store-trade-events-and-orders-inside-the-database.html#cb287-4" aria-hidden="true" tabindex="-1"></a>    <span class="cn">GenServer</span><span class="op">.</span>start_link(</span>
<span id="cb287-5"><a href="store-trade-events-and-orders-inside-the-database.html#cb287-5" aria-hidden="true" tabindex="-1"></a>      <span class="cn">__MODULE__</span>,</span>
<span id="cb287-6"><a href="store-trade-events-and-orders-inside-the-database.html#cb287-6" aria-hidden="true" tabindex="-1"></a>      topic,</span>
<span id="cb287-7"><a href="store-trade-events-and-orders-inside-the-database.html#cb287-7" aria-hidden="true" tabindex="-1"></a>      <span class="va">name:</span> via_tuple(topic)</span>
<span id="cb287-8"><a href="store-trade-events-and-orders-inside-the-database.html#cb287-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb287-9"><a href="store-trade-events-and-orders-inside-the-database.html#cb287-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb287-10"><a href="store-trade-events-and-orders-inside-the-database.html#cb287-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb287-11"><a href="store-trade-events-and-orders-inside-the-database.html#cb287-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defp</span> via_tuple(topic) <span class="kw">do</span></span>
<span id="cb287-12"><a href="store-trade-events-and-orders-inside-the-database.html#cb287-12" aria-hidden="true" tabindex="-1"></a>    {<span class="va">:via</span>, <span class="cn">Registry</span>, {<span class="va">:subscriber_workers</span>, topic}}</span>
<span id="cb287-13"><a href="store-trade-events-and-orders-inside-the-database.html#cb287-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb287-14"><a href="store-trade-events-and-orders-inside-the-database.html#cb287-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span>    </span></code></pre></div>
<p>Passing the <code>:name</code> option to the <code>GenServer</code>‚Äôs <code>start_link/3</code> function we instruct it to utilize the <code>Registry</code> module to register processes under topic names.</p>
</div>
<div id="create-a-new-supervision-level-for-registry-task-and-the-dynamicsupervisor" class="section level3" number="14.7.5">
<h3><span class="header-section-number">14.7.5</span> Create a new supervision level for Registry, Task and the DynamicSupervisor</h3>
<p>We have the lowest level modules - the <code>Worker</code> and the <code>DynamicSupervisor</code> implemented - time to add a new <code>Supervisor</code> that will start the <code>Registry</code>, the <code>DynamicSupervisor</code> and the autostart storing <code>Task</code>. First create a new file called <code>subscriber_supervisor.ex</code> inside the <code>apps/data_warehouse/lib/data_warehouse</code> directory:</p>
<div class="sourceCode" id="cb288"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb288-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb288-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /apps/data_warehouse/lib/data_warehouse/subscriber_supervisor.ex</span></span>
<span id="cb288-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb288-2" aria-hidden="true" tabindex="-1"></a><span class="kw">defmodule</span> <span class="cn">DataWarehouse</span><span class="op">.</span><span class="cn">SubscriberSupervisor</span> <span class="kw">do</span></span>
<span id="cb288-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb288-3" aria-hidden="true" tabindex="-1"></a>  <span class="im">use</span> <span class="cn">Supervisor</span></span>
<span id="cb288-4"><a href="store-trade-events-and-orders-inside-the-database.html#cb288-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-5"><a href="store-trade-events-and-orders-inside-the-database.html#cb288-5" aria-hidden="true" tabindex="-1"></a>  <span class="im">alias</span> <span class="cn">DataWarehouse</span><span class="op">.</span><span class="cn">Subscriber</span><span class="op">.</span><span class="cn">DynamicSupervisor</span></span>
<span id="cb288-6"><a href="store-trade-events-and-orders-inside-the-database.html#cb288-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-7"><a href="store-trade-events-and-orders-inside-the-database.html#cb288-7" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@registry</span> <span class="va">:subscriber_workers</span></span>
<span id="cb288-8"><a href="store-trade-events-and-orders-inside-the-database.html#cb288-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-9"><a href="store-trade-events-and-orders-inside-the-database.html#cb288-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> start_link(_args) <span class="kw">do</span></span>
<span id="cb288-10"><a href="store-trade-events-and-orders-inside-the-database.html#cb288-10" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Supervisor</span><span class="op">.</span>start_link(<span class="cn">__MODULE__</span>, [], <span class="va">name:</span> <span class="cn">__MODULE__</span>)</span>
<span id="cb288-11"><a href="store-trade-events-and-orders-inside-the-database.html#cb288-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb288-12"><a href="store-trade-events-and-orders-inside-the-database.html#cb288-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-13"><a href="store-trade-events-and-orders-inside-the-database.html#cb288-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> init(_args) <span class="kw">do</span></span>
<span id="cb288-14"><a href="store-trade-events-and-orders-inside-the-database.html#cb288-14" aria-hidden="true" tabindex="-1"></a>    children <span class="op">=</span> [</span>
<span id="cb288-15"><a href="store-trade-events-and-orders-inside-the-database.html#cb288-15" aria-hidden="true" tabindex="-1"></a>      {<span class="cn">Registry</span>, [<span class="va">keys:</span> <span class="va">:unique</span>, <span class="va">name:</span> <span class="ot">@registry</span>]},</span>
<span id="cb288-16"><a href="store-trade-events-and-orders-inside-the-database.html#cb288-16" aria-hidden="true" tabindex="-1"></a>      {<span class="cn">DynamicSupervisor</span>, []},</span>
<span id="cb288-17"><a href="store-trade-events-and-orders-inside-the-database.html#cb288-17" aria-hidden="true" tabindex="-1"></a>      {<span class="cn">Task</span>,</span>
<span id="cb288-18"><a href="store-trade-events-and-orders-inside-the-database.html#cb288-18" aria-hidden="true" tabindex="-1"></a>       <span class="kw">fn</span> <span class="op">-&gt;</span></span>
<span id="cb288-19"><a href="store-trade-events-and-orders-inside-the-database.html#cb288-19" aria-hidden="true" tabindex="-1"></a>         <span class="cn">DynamicSupervisor</span><span class="op">.</span>autostart_workers()</span>
<span id="cb288-20"><a href="store-trade-events-and-orders-inside-the-database.html#cb288-20" aria-hidden="true" tabindex="-1"></a>       <span class="kw">end</span>}</span>
<span id="cb288-21"><a href="store-trade-events-and-orders-inside-the-database.html#cb288-21" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb288-22"><a href="store-trade-events-and-orders-inside-the-database.html#cb288-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-23"><a href="store-trade-events-and-orders-inside-the-database.html#cb288-23" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Supervisor</span><span class="op">.</span>init(children, <span class="va">strategy:</span> <span class="va">:rest_for_one</span>)</span>
<span id="cb288-24"><a href="store-trade-events-and-orders-inside-the-database.html#cb288-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb288-25"><a href="store-trade-events-and-orders-inside-the-database.html#cb288-25" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<p>Important part here will be to match the <code>Registry</code> name to the one defined inside the <code>DynamicSupervisor</code> and the <code>Worker</code> modules.</p>
</div>
<div id="link-the-subscribersupervisor-to-the-application" class="section level3" number="14.7.6">
<h3><span class="header-section-number">14.7.6</span> Link the <code>SubscriberSupervisor</code> to the <code>Application</code></h3>
<p>We need to update the <code>DataWarehouse.Application</code> module to start our new <code>DataWarehouse.SubscriberSupervisor</code> process as well as register itself under name matching to its module(just for consistency with other applications):</p>
<div class="sourceCode" id="cb289"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb289-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb289-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/data_warehouse/lib/data_warehouse/application.ex</span></span>
<span id="cb289-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb289-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb289-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb289-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> start(_type, _args) <span class="kw">do</span></span>
<span id="cb289-4"><a href="store-trade-events-and-orders-inside-the-database.html#cb289-4" aria-hidden="true" tabindex="-1"></a>    children <span class="op">=</span> [</span>
<span id="cb289-5"><a href="store-trade-events-and-orders-inside-the-database.html#cb289-5" aria-hidden="true" tabindex="-1"></a>      {<span class="cn">DataWarehouse</span><span class="op">.</span><span class="cn">Repo</span>, []},</span>
<span id="cb289-6"><a href="store-trade-events-and-orders-inside-the-database.html#cb289-6" aria-hidden="true" tabindex="-1"></a>      {<span class="cn">DataWarehouse</span><span class="op">.</span><span class="cn">SubscriberSupervisor</span>, []} <span class="co"># &lt;= new module added</span></span>
<span id="cb289-7"><a href="store-trade-events-and-orders-inside-the-database.html#cb289-7" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb289-8"><a href="store-trade-events-and-orders-inside-the-database.html#cb289-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb289-9"><a href="store-trade-events-and-orders-inside-the-database.html#cb289-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># See https://hexdocs.pm/elixir/Supervisor.html</span></span>
<span id="cb289-10"><a href="store-trade-events-and-orders-inside-the-database.html#cb289-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># for other strategies and supported options</span></span>
<span id="cb289-11"><a href="store-trade-events-and-orders-inside-the-database.html#cb289-11" aria-hidden="true" tabindex="-1"></a>    opts <span class="op">=</span> [<span class="va">strategy:</span> <span class="va">:one_for_one</span>, <span class="va">name:</span> <span class="cn">__MODULE__</span>] <span class="co"># &lt;= name updated</span></span>
<span id="cb289-12"><a href="store-trade-events-and-orders-inside-the-database.html#cb289-12" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Supervisor</span><span class="op">.</span>start_link(children, opts)</span>
<span id="cb289-13"><a href="store-trade-events-and-orders-inside-the-database.html#cb289-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb289-14"><a href="store-trade-events-and-orders-inside-the-database.html#cb289-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span></code></pre></div>
</div>
<div id="add-interface" class="section level3" number="14.7.7">
<h3><span class="header-section-number">14.7.7</span> Add interface</h3>
<p>The final step will be to add an interface to the <code>DataWarehouse</code> application to start and stop storing:</p>
<div class="sourceCode" id="cb290"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb290-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb290-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># /apps/data_warehouse/lib/data_warehouse.ex</span></span>
<span id="cb290-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb290-2" aria-hidden="true" tabindex="-1"></a>  <span class="im">alias</span> <span class="cn">DataWarehouse</span><span class="op">.</span><span class="cn">Subscriber</span><span class="op">.</span><span class="cn">DynamicSupervisor</span></span>
<span id="cb290-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb290-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-4"><a href="store-trade-events-and-orders-inside-the-database.html#cb290-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> start_storing(stream, symbol) <span class="kw">do</span></span>
<span id="cb290-5"><a href="store-trade-events-and-orders-inside-the-database.html#cb290-5" aria-hidden="true" tabindex="-1"></a>    to_topic(stream, symbol)</span>
<span id="cb290-6"><a href="store-trade-events-and-orders-inside-the-database.html#cb290-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">|&gt;</span> <span class="cn">DynamicSupervisor</span><span class="op">.</span>start_worker()</span>
<span id="cb290-7"><a href="store-trade-events-and-orders-inside-the-database.html#cb290-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb290-8"><a href="store-trade-events-and-orders-inside-the-database.html#cb290-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-9"><a href="store-trade-events-and-orders-inside-the-database.html#cb290-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> stop_storing(stream, symbol) <span class="kw">do</span></span>
<span id="cb290-10"><a href="store-trade-events-and-orders-inside-the-database.html#cb290-10" aria-hidden="true" tabindex="-1"></a>    to_topic(stream, symbol)</span>
<span id="cb290-11"><a href="store-trade-events-and-orders-inside-the-database.html#cb290-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">|&gt;</span> <span class="cn">DynamicSupervisor</span><span class="op">.</span>stop_worker()</span>
<span id="cb290-12"><a href="store-trade-events-and-orders-inside-the-database.html#cb290-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb290-13"><a href="store-trade-events-and-orders-inside-the-database.html#cb290-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-14"><a href="store-trade-events-and-orders-inside-the-database.html#cb290-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defp</span> to_topic(stream, symbol) <span class="kw">do</span></span>
<span id="cb290-15"><a href="store-trade-events-and-orders-inside-the-database.html#cb290-15" aria-hidden="true" tabindex="-1"></a>    [stream, symbol]</span>
<span id="cb290-16"><a href="store-trade-events-and-orders-inside-the-database.html#cb290-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">|&gt;</span> <span class="cn">Enum</span><span class="op">.</span>map(<span class="op">&amp;</span><span class="cn">String</span><span class="op">.</span>upcase<span class="op">/</span><span class="dv">1</span>)</span>
<span id="cb290-17"><a href="store-trade-events-and-orders-inside-the-database.html#cb290-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">|&gt;</span> <span class="cn">Enum</span><span class="op">.</span>join(<span class="st">&quot;:&quot;</span>)</span>
<span id="cb290-18"><a href="store-trade-events-and-orders-inside-the-database.html#cb290-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span></code></pre></div>
<p>Inside the above functions, we are just doing a couple of sanity checks on the case of the passed arguments assuming that both topics and stream are uppercase.</p>
</div>
<div id="test" class="section level3" number="14.7.8">
<h3><span class="header-section-number">14.7.8</span> Test</h3>
<p>The interface above was the last step in our implementation, we can now test that all works as expected:</p>
<div class="sourceCode" id="cb291"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb291-1"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> iex <span class="at">-S</span> mix</span>
<span id="cb291-2"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-2" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb291-3"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-3" aria-hidden="true" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">1</span><span class="kw">)</span><span class="op">&gt;</span> DataWarehouse.start_storing<span class="kw">(</span><span class="st">&quot;TRADE_EVENTS&quot;</span><span class="ex">,</span> <span class="st">&quot;NEOUSDT&quot;</span><span class="kw">)</span></span>
<span id="cb291-4"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-4" aria-hidden="true" tabindex="-1"></a><span class="ex">19:34:00.740</span> [info]  Starting storing data from TRADE_EVENTS:NEOUSDT topic</span>
<span id="cb291-5"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-5" aria-hidden="true" tabindex="-1"></a><span class="ex">19:34:00.847</span> [info]  DataWarehouse worker is subscribing to TRADE_EVENTS:NEOUSDT</span>
<span id="cb291-6"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-6" aria-hidden="true" tabindex="-1"></a><span class="ex">{:ok,</span> <span class="co">#PID&lt;0.429.0&gt;}</span></span>
<span id="cb291-7"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-7" aria-hidden="true" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">2</span><span class="kw">)</span><span class="op">&gt;</span> DataWarehouse.start_storing<span class="kw">(</span><span class="st">&quot;TRADE_EVENTS&quot;</span><span class="ex">,</span> <span class="st">&quot;NEOUSDT&quot;</span><span class="kw">)</span></span>
<span id="cb291-8"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-8" aria-hidden="true" tabindex="-1"></a><span class="ex">19:34:04.753</span> [info]  Starting storing data from TRADE_EVENTS:NEOUSDT topic</span>
<span id="cb291-9"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-9" aria-hidden="true" tabindex="-1"></a><span class="ex">{:error,</span> {:already_started, <span class="co">#PID&lt;0.459.0&gt;}}</span></span>
<span id="cb291-10"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-10" aria-hidden="true" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">3</span><span class="kw">)</span><span class="op">&gt;</span> DataWarehouse.start_storing<span class="kw">(</span><span class="st">&quot;ORDERS&quot;</span><span class="ex">,</span> <span class="st">&quot;NEOUSDT&quot;</span><span class="kw">)</span></span>
<span id="cb291-11"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-11" aria-hidden="true" tabindex="-1"></a><span class="ex">19:34:09.386</span> [info]  Starting storing data from ORDERS:NEOUSDT topic</span>
<span id="cb291-12"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-12" aria-hidden="true" tabindex="-1"></a><span class="ex">19:34:09.403</span> [info]  DataWarehouse worker is subscribing to ORDERS:NEOUSDT</span>
<span id="cb291-13"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-13" aria-hidden="true" tabindex="-1"></a><span class="ex">{:ok,</span> <span class="co">#PID&lt;0.431.0&gt;}</span></span>
<span id="cb291-14"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-14" aria-hidden="true" tabindex="-1"></a><span class="ex">BREAK:</span> <span class="er">(</span><span class="ex">a</span><span class="kw">)</span><span class="ex">bort</span> <span class="er">(</span><span class="ex">A</span><span class="kw">)</span><span class="ex">bort</span> with dump <span class="er">(</span><span class="ex">c</span><span class="kw">)</span><span class="ex">ontinue</span> <span class="er">(</span><span class="ex">p</span><span class="kw">)</span><span class="ex">roc</span> info <span class="er">(</span><span class="ex">i</span><span class="kw">)</span><span class="ex">nfo</span></span>
<span id="cb291-15"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-15" aria-hidden="true" tabindex="-1"></a>       <span class="kw">(</span><span class="ex">l</span><span class="kw">)</span><span class="ex">oaded</span> <span class="er">(</span><span class="ex">v</span><span class="kw">)</span><span class="ex">ersion</span> <span class="er">(</span><span class="ex">k</span><span class="kw">)</span><span class="ex">ill</span> <span class="er">(</span><span class="ex">D</span><span class="kw">)</span><span class="ex">b-tables</span> <span class="er">(</span><span class="ex">d</span><span class="kw">)</span><span class="ex">istribution</span></span>
<span id="cb291-16"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-16" aria-hidden="true" tabindex="-1"></a><span class="ex">^C%</span></span>
<span id="cb291-17"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-17" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> iex <span class="at">-S</span> mix</span>
<span id="cb291-18"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-18" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb291-19"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-19" aria-hidden="true" tabindex="-1"></a><span class="ex">19:35:30.058</span> [info]  DataWarehouse worker is subscribing to TRADE_EVENTS:NEOUSDT</span>
<span id="cb291-20"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-20" aria-hidden="true" tabindex="-1"></a><span class="ex">19:35:30.062</span> [info]  DataWarehouse worker is subscribing to ORDERS:NEOUSDT</span>
<span id="cb291-21"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-21" aria-hidden="true" tabindex="-1"></a><span class="co"># autostart works ^^^</span></span>
<span id="cb291-22"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-22" aria-hidden="true" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">1</span><span class="kw">)</span><span class="op">&gt;</span> Naive.start_trading<span class="kw">(</span><span class="st">&quot;NEOUSDT&quot;</span><span class="kw">)</span></span>
<span id="cb291-23"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-23" aria-hidden="true" tabindex="-1"></a><span class="ex">19:36:45.316</span> [info]  Starting Elixir.Naive.SymbolSupervisor worker for NEOUSDT</span>
<span id="cb291-24"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-24" aria-hidden="true" tabindex="-1"></a><span class="ex">19:36:45.417</span> [info]  Starting new supervision tree to trade on NEOUSDT</span>
<span id="cb291-25"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-25" aria-hidden="true" tabindex="-1"></a><span class="ex">{:ok,</span> <span class="co">#PID&lt;0.419.0&gt;}</span></span>
<span id="cb291-26"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-26" aria-hidden="true" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">3</span><span class="kw">)</span><span class="op">&gt;</span> </span>
<span id="cb291-27"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-27" aria-hidden="true" tabindex="-1"></a><span class="ex">19:36:47.484</span> [info]  Initializing new trader<span class="er">(</span><span class="ex">1615221407466</span><span class="kw">)</span> <span class="cf">for</span> NEOUSDT</span>
<span id="cb291-28"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-28" aria-hidden="true" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">2</span><span class="kw">)</span><span class="op">&gt;</span> Streamer.start_streaming<span class="kw">(</span><span class="st">&quot;NEOUSDT&quot;</span><span class="kw">)</span></span>
<span id="cb291-29"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-29" aria-hidden="true" tabindex="-1"></a><span class="ex">16:37:39.660</span> [info]  Starting Elixir.Streamer.Binance worker for NEOUSDT</span>
<span id="cb291-30"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-30" aria-hidden="true" tabindex="-1"></a><span class="ex">{:ok,</span> <span class="co">#PID&lt;0.428.0&gt;}</span></span>
<span id="cb291-31"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-31" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb291-32"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-32" aria-hidden="true" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">3</span><span class="kw">)</span><span class="op">&gt;</span> DataWarehouse.stop_storing<span class="kw">(</span><span class="st">&quot;trade_events&quot;</span><span class="ex">,</span> <span class="st">&quot;NEOUSDT&quot;</span><span class="kw">)</span></span>
<span id="cb291-33"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-33" aria-hidden="true" tabindex="-1"></a><span class="ex">19:39:26.398</span> [info]  Stopping storing data from trade_events:NEOUSDT topic</span>
<span id="cb291-34"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-34" aria-hidden="true" tabindex="-1"></a><span class="ex">:ok</span></span>
<span id="cb291-35"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-35" aria-hidden="true" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">4</span><span class="kw">)</span><span class="op">&gt;</span> DataWarehouse.stop_storing<span class="kw">(</span><span class="st">&quot;trade_events&quot;</span><span class="ex">,</span> <span class="st">&quot;NEOUSDT&quot;</span><span class="kw">)</span></span>
<span id="cb291-36"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-36" aria-hidden="true" tabindex="-1"></a><span class="ex">19:39:28.151</span> [info]  Stopping storing data from trade_events:NEOUSDT topic</span>
<span id="cb291-37"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-37" aria-hidden="true" tabindex="-1"></a><span class="ex">19:39:28.160</span> [warn]  Unable to locate process assigned to <span class="st">&quot;trade_events:NEOUSDT&quot;</span></span>
<span id="cb291-38"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-38" aria-hidden="true" tabindex="-1"></a><span class="ex">:ok</span></span>
<span id="cb291-39"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-39" aria-hidden="true" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">5</span><span class="kw">)</span><span class="op">&gt;</span> [{pid, <span class="ex">nil}]</span> = Registry.lookup<span class="er">(</span><span class="ex">:subscriber_workers,</span> <span class="st">&quot;ORDERS:NEOUSDT&quot;</span><span class="kw">)</span></span>
<span id="cb291-40"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-40" aria-hidden="true" tabindex="-1"></a><span class="ex">[{#PID</span><span class="op">&lt;</span>0.417.0<span class="op">&gt;</span>, nil}]</span>
<span id="cb291-41"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-41" aria-hidden="true" tabindex="-1"></a><span class="ex">iex</span><span class="er">(</span><span class="ex">6</span><span class="kw">)</span><span class="op">&gt;</span> Process.exit<span class="kw">(</span><span class="ex">pid,</span> :crash<span class="kw">)</span></span>
<span id="cb291-42"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-42" aria-hidden="true" tabindex="-1"></a><span class="fu">true</span></span>
<span id="cb291-43"><a href="store-trade-events-and-orders-inside-the-database.html#cb291-43" aria-hidden="true" tabindex="-1"></a><span class="ex">16:43:40.812</span> [info]  DataWarehouse worker is subscribing to ORDERS:NEOUSDT</span></code></pre></div>
<p>As we can see even this simple implementation handles starting, autostarting and stopping. It also gracefully handles starting workers when one is already running as well as stopping when there none running.</p>
<p>As a challenge, you could update the <code>naive</code> and the <code>streamer</code> application to use <code>Registry</code> and remove <code>Core.ServiceSupervisor</code> module as it was superseded by the above solution.</p>
<p>[Note] Please remember to run <code>mix format</code> to keep things nice and tidy.</p>
<p>Source code for this chapter can be found at <a href="https://github.com/frathon/create-a-cryptocurrency-trading-bot-in-elixir-source-code/tree/chapter_14">Github</a></p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="abstract-duplicated-supervision-code.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="backtest-trading-strategy.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/frathon/create-a-cryptocurrency-trading-bot-in-elixir/edit/main/14-store-trade-events-and-orders.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["create-a-cryptocurrency-trading-bot-in-elixir.pdf", "create-a-cryptocurrency-trading-bot-in-elixir.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
